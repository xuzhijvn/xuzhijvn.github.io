[{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‚è€ƒ é«˜å¯ç”¨å®ç°KeepAlivedåŸç†ç®€ä»‹\rkeepalivedï¼šç®€ä»‹ã€nginx+keepalivedé›†ç¾¤ã€nginx+keepalivedåŒä¸»æ¶æ„\r","date":"2021-08-29","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/nginx/%E5%9F%BA%E4%BA%8Ekeepalived%E5%AE%9E%E7%8E%B0nginx%E9%AB%98%E5%8F%AF%E7%94%A8/","series":["Manual"],"tags":["nginx"],"title":"åŸºäºkeepalivedå®ç°nginxé«˜å¯ç”¨"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"Nginx å®ç°è´Ÿè½½å‡è¡¡çš„åˆ†é…ç­–ç•¥æœ‰å¾ˆå¤šï¼ŒNginx çš„ upstream ç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š\n è½®è¯¢ï¼ˆé»˜è®¤ï¼‰ï¼šæ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨ down æ‰ï¼Œèƒ½è‡ªåŠ¨å‰”é™¤ã€‚ weightï¼šæŒ‡å®šè½®è¯¢å‡ ç‡ï¼Œweight å’Œè®¿é—®æ¯”ç‡æˆæ­£æ¯”ï¼Œç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µã€‚ ip_hashï¼šæ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—® ip çš„ hash ç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³ session çš„é—®é¢˜ã€‚ fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰ï¼šæŒ‰åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚ url_hashï¼ˆç¬¬ä¸‰æ–¹ï¼‰ï¼šæŒ‰è®¿é—® url çš„ hash ç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œä½¿æ¯ä¸ª url å®šå‘åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œåç«¯æœåŠ¡å™¨ä¸ºç¼“å­˜æ—¶æ¯”è¾ƒæœ‰æ•ˆã€‚  å‚è€ƒ LVSã€Nginxã€HAProxyã€keepalive çš„å·¥ä½œåŸç†\r","date":"2021-08-29","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/nginx/nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/","series":["Manual"],"tags":["nginx"],"title":"Nginxè´Ÿè½½å‡è¡¡"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‚è€ƒ å­—èŠ‚ç å¢å¼ºï¼šåŸç†ä¸å®æˆ˜\r","date":"2021-08-29","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E5%AD%97%E8%8A%82%E7%A0%81%E5%AE%9E%E6%88%98/","series":["Manual"],"tags":["Java"],"title":"å­—èŠ‚ç å®æˆ˜"},{"categories":["å…¶ä»–"],"content":"æ‰§è¡Œ git submodule update --init --recursive çš„æ—¶å€™æŠ¥é”™ï¼š\nfatal: remote error: upload-pack: not our ref fc7223ca00124e8f5b5b354457379071e2fd091b Fetched in submodule path \u0026#39;themes/hugo-theme-bootstrap\u0026#39;, but it did not contain fc7223ca00124e8f5b5b354457379071e2fd091b. Direct fetching of that commit failed. è§£å†³ï¼š\ncd {submodule path} git reset --hard origin/master cd - git clean -n git add {submodule path} git commit git submodule update --init --recursive å‚è€ƒ git - ä¸ºä»€ä¹ˆgitå­æ¨¡å—æ›´æ–°ä¼šå›  \u0026ldquo;fatal: remote error: upload-pack: not our ref\u0026quot;è€Œå¤±è´¥ï¼Ÿ\r","date":"2021-08-28","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/git-submodule-update-init-recursive/","series":["Manual"],"tags":["Other"],"title":"git submodule update --init --recursive"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.1.1 ä»€ä¹ˆæ˜¯äº‘åŸç”Ÿï¼Ÿ\r äº‘åŸç”Ÿæ˜¯ä¸€ç§æ„å»ºå’Œè¿è¡Œåº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œæ˜¯ä¸€å¥—æŠ€æœ¯ä½“ç³»å’Œæ–¹æ³•è®ºã€‚äº‘åŸç”Ÿï¼ˆCloudNativeï¼‰æ˜¯ä¸€ä¸ªç»„åˆè¯ï¼ŒCloud+Nativeã€‚Cloudè¡¨ç¤ºåº”ç”¨ç¨‹åºä½äºäº‘ä¸­ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„æ•°æ®ä¸­å¿ƒï¼›Nativeè¡¨ç¤ºåº”ç”¨ç¨‹åºä»è®¾è®¡ä¹‹åˆå³è€ƒè™‘åˆ°äº‘çš„ç¯å¢ƒï¼ŒåŸç”Ÿä¸ºäº‘è€Œè®¾è®¡ï¼Œåœ¨äº‘ä¸Šä»¥æœ€ä½³å§¿åŠ¿è¿è¡Œï¼Œå……åˆ†åˆ©ç”¨å’Œå‘æŒ¥äº‘å¹³å°çš„å¼¹æ€§+åˆ†å¸ƒå¼ä¼˜åŠ¿ã€‚\n ä»€ä¹ˆæ˜¯äº‘åŸç”Ÿæ¶æ„ï¼Ÿ é‡‡ç”¨å¼€æºå †æ ˆï¼ˆK8S+Dockerï¼‰è¿›è¡Œå®¹å™¨åŒ–ï¼ŒåŸºäºå¾®æœåŠ¡æ¶æ„æé«˜çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå€ŸåŠ©æ•æ·æ–¹æ³•ã€DevOpsæ”¯æŒæŒç»­è¿­ä»£å’Œè¿ç»´è‡ªåŠ¨åŒ–ï¼Œåˆ©ç”¨äº‘å¹³å°è®¾æ–½å®ç°å¼¹æ€§ä¼¸ç¼©ã€åŠ¨æ€è°ƒåº¦ã€ä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡ã€‚\nä»€ä¹ˆæ˜¯äº‘åŸç”Ÿåº”ç”¨ï¼Ÿ åœ¨æ¶æ„è®¾è®¡ã€å¼€å‘æ–¹å¼ã€éƒ¨ç½²ç»´æŠ¤ç­‰å„ä¸ªé˜¶æ®µå’Œæ–¹é¢éƒ½åŸºäºäº‘çš„ç‰¹ç‚¹å»ºè®¾çš„åº”ç”¨ã€‚\n 1.1.2 ä»€ä¹ˆæ˜¯å®¹å™¨ç¼–æ’ï¼Ÿ\r å®¹å™¨ç¼–æ’æ˜¯æŒ‡è‡ªåŠ¨åŒ–å®¹å™¨çš„éƒ¨ç½²ã€ç®¡ç†ã€æ‰©å±•å’Œè”ç½‘ã€‚\n k8så‘¨è¾¹ï¼š\n k3s\r: è½»é‡åŒ–k8s k9s\r: kubectlå‘½ä»¤çš„å°è£… KubeOperator : å›½äº§k8så‘è¡Œç‰ˆ Kubesphere : k8sä¼ä¸šçº§åˆ«å¢å¼ºï¼ˆå¤šäº‘ã€å¤šé›†ç¾¤ï¼‰ kubeedge : è¾¹ç¼˜è®¡ç®— Kubeless : é¢å‘serverlessçš„k8s   1.1.3 ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ 1.1.4 k8s/istioä¸äº‘åŸç”Ÿçš„å…³ç³»ï¼Ÿ ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.1-%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.1 ä¸€äº›æ¦‚å¿µ"},{"categories":["äº‘åŸç”Ÿ"],"content":"Kubernetesæä¾›äº†ä¸€ä¸ªå¯å¼¹æ€§è¿è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¡†æ¶ã€‚Kubernetes ä¼šæ»¡è¶³æ‚¨çš„æ‰©å±•è¦æ±‚ã€æ•…éšœè½¬ç§»ã€éƒ¨ç½²æ¨¡å¼ç­‰ã€‚å…·ä½“å¦‚ä¸‹ï¼š\n Service discovery and load balancingï¼ŒæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼Œé€šè¿‡DNSå®ç°å†…éƒ¨è§£æï¼Œserviceå®ç°è´Ÿè½½å‡è¡¡ Storage orchestrationï¼Œå­˜å‚¨ç¼–æ’ï¼Œé€šè¿‡plunginçš„å½¢å¼æ”¯æŒå¤šç§å­˜å‚¨ï¼Œå¦‚æœ¬åœ°ï¼Œnfsï¼Œcephï¼Œå…¬æœ‰äº‘å¿«å­˜å‚¨ç­‰ Automated rollouts and rollbacksï¼Œè‡ªåŠ¨å‘å¸ƒä¸å›æ»šï¼Œé€šè¿‡åŒ¹é…å½“å‰çŠ¶æ€ä¸ç›®æ ‡çŠ¶æ€ä¸€è‡´ï¼Œæ›´æ–°å¤±è´¥æ—¶å¯å›æ»š Automatic bin packingï¼Œè‡ªåŠ¨èµ„æºè°ƒåº¦ï¼Œå¯ä»¥è®¾ç½®podè°ƒåº¦çš„æ‰€éœ€ï¼ˆrequestsï¼‰èµ„æºå’Œé™åˆ¶èµ„æºï¼ˆlimitsï¼‰ Self-healingï¼Œå†…ç½®çš„å¥åº·æ£€æŸ¥ç­–ç•¥ï¼Œè‡ªåŠ¨å‘ç°å’Œå¤„ç†é›†ç¾¤å†…çš„å¼‚å¸¸ï¼Œæ›´æ¢ï¼Œéœ€é‡å¯çš„podèŠ‚ç‚¹ Secret and configuration managementï¼Œå¯†é’¥å’Œé…ç½®ç®¡ç†ï¼Œå¯¹äºæ•æ„Ÿä¿¡æ¯å¦‚å¯†ç ï¼Œè´¦å·çš„é‚£ä¸ªé€šè¿‡secretå­˜å‚¨ï¼Œåº”ç”¨çš„é…ç½®æ–‡ä»¶é€šè¿‡configmapå­˜å‚¨ï¼Œé¿å…å°†é…ç½®æ–‡ä»¶å›ºå®šåœ¨é•œåƒä¸­ï¼Œå¢åŠ å®¹å™¨ç¼–æ’çš„çµæ´»æ€§ Batch executionï¼Œæ‰¹å¤„ç†æ‰§è¡Œï¼Œé€šè¿‡jobå’Œcronjobæä¾›å•æ¬¡æ‰¹å¤„ç†ä»»åŠ¡å’Œå¾ªç¯è®¡åˆ’ä»»åŠ¡åŠŸèƒ½çš„å®ç° Horizontal scalingï¼Œæ¨ªå‘æ‰©å±•åŠŸèƒ½ï¼ŒåŒ…å«æœ‰HPAå’ŒASï¼Œå³åº”ç”¨çš„åŸºäºCPUåˆ©ç”¨ç‡çš„å¼¹æ€§ä¼¸ç¼©å’ŒåŸºäºå¹³å°çº§çš„å¼¹æ€§ä¼¸ç¼©ï¼Œå¦‚è‡ªåŠ¨å¢åŠ nodeå’Œåˆ é™¤nodesèŠ‚ç‚¹ã€‚   ä½¿ç”¨kubectl autoscaleå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ª HPA å¯¹è±¡ï¼š\n$ kubectl autoscale deployment wordpress --namespace kube-example --cpu-percent=20 --min=3 --max=6 horizontalpodautoscaler.autoscaling/hpa-demo autoscaled $ kubectl get hpa -n kube-example NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE wordpress Deployment/wordpress \u0026lt;unknown\u0026gt;/20% 3 6 0 13s æ­¤å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªå…³è”èµ„æº wordpress çš„ HPAï¼Œæœ€å°çš„ Pod å‰¯æœ¬æ•°ä¸º3ï¼Œæœ€å¤§ä¸º6ã€‚HPA ä¼šæ ¹æ®è®¾å®šçš„ cpu ä½¿ç”¨ç‡ï¼ˆ20%ï¼‰åŠ¨æ€çš„å¢åŠ æˆ–è€…å‡å°‘ Pod æ•°é‡ã€‚\n ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.1k8s%E5%8A%9F%E8%83%BD/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.1 k8såŠŸèƒ½"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.2.1 k8såŸºæœ¬æ¦‚å¿µ 1âƒ£ï¸ Container Containerï¼ˆå®¹å™¨ï¼‰æ˜¯ä¸€ç§ä¾¿æºå¼ã€è½»é‡çº§çš„æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚å®ƒä½¿ç”¨ namespace éš”ç¦»ä¸åŒçš„è½¯ä»¶è¿è¡Œç¯å¢ƒï¼Œå¹¶é€šè¿‡é•œåƒè‡ªåŒ…å«è½¯ä»¶çš„è¿è¡Œç¯å¢ƒï¼Œä»è€Œä½¿å¾—å®¹å™¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œã€‚\n2âƒ£ï¸ Pod\r Kubernetes ä½¿ç”¨ Pod æ¥ç®¡ç†å®¹å™¨ï¼Œæ¯ä¸ª Pod å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†å…³è”çš„å®¹å™¨ã€‚\nPod æ˜¯ä¸€ç»„ç´§å¯†å…³è”çš„å®¹å™¨é›†åˆï¼Œå®ƒä»¬å…±äº« PIDï¼ˆåŒä¸€ä¸ªPodä¸­åº”ç”¨å¯ä»¥çœ‹åˆ°å…¶å®ƒè¿›ç¨‹ï¼‰ã€IPCï¼ˆåŒä¸€ä¸ªPodä¸­çš„åº”ç”¨å¯ä»¥é€šè¿‡VPCæˆ–è€…POSIXè¿›è¡Œé€šä¿¡ï¼‰ã€Network ï¼ˆåŒä¸€ä¸ªPodçš„ä¸­çš„åº”ç”¨å¯¹ç›¸åŒçš„IPåœ°å€å’Œç«¯å£æœ‰æƒé™ï¼‰å’Œ UTS namespaceï¼ˆåŒä¸€ä¸ªPodä¸­çš„åº”ç”¨å…±äº«ä¸€ä¸ªä¸»æœºåç§°ï¼‰ï¼Œæ˜¯ Kubernetes è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚Pod å†…çš„å¤šä¸ªå®¹å™¨å…±äº«ç½‘ç»œå’Œæ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡è¿›ç¨‹é—´é€šä¿¡å’Œæ–‡ä»¶å…±äº«è¿™ç§ç®€å•é«˜æ•ˆçš„æ–¹å¼ç»„åˆå®ŒæˆæœåŠ¡ã€‚\nåœ¨ Kubernetes ä¸­ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½ä½¿ç”¨ manifestï¼ˆyaml æˆ– jsonï¼‰æ¥å®šä¹‰ï¼Œæ¯”å¦‚ä¸€ä¸ªç®€å•çš„ nginx æœåŠ¡å¯ä»¥å®šä¹‰ä¸º nginx.yamlï¼Œå®ƒåŒ…å«ä¸€ä¸ªé•œåƒä¸º nginx çš„å®¹å™¨ï¼š\napiVersion: v1 kind: Pod metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 3âƒ£ï¸ Node Node æ˜¯ Pod çœŸæ­£è¿è¡Œçš„ä¸»æœºï¼Œå¯ä»¥æ˜¯ç‰©ç†æœºï¼Œä¹Ÿå¯ä»¥æ˜¯è™šæ‹Ÿæœºã€‚ä¸ºäº†ç®¡ç† Podï¼Œæ¯ä¸ª Node èŠ‚ç‚¹ä¸Šè‡³å°‘è¦è¿è¡Œ container runtimeï¼ˆæ¯”å¦‚ docker æˆ–è€… rktï¼‰ã€kubelet å’Œ kube-proxy æœåŠ¡ã€‚\n4âƒ£ï¸ Namespace Namespace æ˜¯å¯¹ä¸€ç»„èµ„æºå’Œå¯¹è±¡çš„æŠ½è±¡é›†åˆï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥å°†ç³»ç»Ÿå†…éƒ¨çš„å¯¹è±¡åˆ’åˆ†ä¸ºä¸åŒçš„é¡¹ç›®ç»„æˆ–ç”¨æˆ·ç»„ã€‚å¸¸è§çš„ pods, services, replication controllers å’Œ deployments ç­‰éƒ½æ˜¯å±äºæŸä¸€ä¸ª namespace çš„ï¼ˆé»˜è®¤æ˜¯ defaultï¼‰ï¼Œè€Œ node, persistentVolumes ç­‰åˆ™ä¸å±äºä»»ä½• namespaceã€‚\næŸ¥çœ‹å“ªäº› Kubernetes èµ„æºåœ¨åå­—ç©ºé—´ä¸­ï¼Œå“ªäº›ä¸åœ¨åå­—ç©ºé—´ä¸­ï¼š\n# ä½äºåå­—ç©ºé—´ä¸­çš„èµ„æº kubectl api-resources --namespaced=true # ä¸åœ¨åå­—ç©ºé—´ä¸­çš„èµ„æº kubectl api-resources --namespaced=false 5âƒ£ï¸ Service Service æ˜¯åº”ç”¨æœåŠ¡çš„æŠ½è±¡ï¼Œé€šè¿‡ labels ä¸ºåº”ç”¨æä¾›è´Ÿè½½å‡è¡¡å’ŒæœåŠ¡å‘ç°ã€‚åŒ¹é… labels çš„ Pod IP å’Œç«¯å£åˆ—è¡¨ç»„æˆ endpointsï¼Œç”± kube-proxy è´Ÿè´£å°†æœåŠ¡ IP è´Ÿè½½å‡è¡¡åˆ°è¿™äº› endpoints ä¸Šã€‚\næ¯ä¸ª Service éƒ½ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ª cluster IPï¼ˆä»…åœ¨é›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„è™šæ‹Ÿåœ°å€ï¼‰å’Œ DNS åï¼Œå…¶ä»–å®¹å™¨å¯ä»¥é€šè¿‡è¯¥åœ°å€æˆ– DNS æ¥è®¿é—®æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åç«¯å®¹å™¨çš„è¿è¡Œã€‚\napiVersion: v1 kind: Service metadata: name: nginx spec: ports: - port: 8078 # the port that this service should serve on name: http # the container on each pod to connect to, can be a name # (e.g. \u0026#39;www\u0026#39;) or a number (e.g. 80) targetPort: 80 protocol: TCP selector: app: nginx 6âƒ£ï¸ Label Label æ˜¯è¯†åˆ« Kubernetes å¯¹è±¡çš„æ ‡ç­¾ï¼Œä»¥ key/value çš„æ–¹å¼é™„åŠ åˆ°å¯¹è±¡ä¸Šï¼ˆkey æœ€é•¿ä¸èƒ½è¶…è¿‡ 63 å­—èŠ‚ï¼Œvalue å¯ä»¥ä¸ºç©ºï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸è¶…è¿‡ 253 å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼‰ã€‚\nLabel ä¸æä¾›å”¯ä¸€æ€§ï¼Œå¹¶ä¸”å®é™…ä¸Šç»å¸¸æ˜¯å¾ˆå¤šå¯¹è±¡ï¼ˆå¦‚ Podsï¼‰éƒ½ä½¿ç”¨ç›¸åŒçš„ label æ¥æ ‡å¿—å…·ä½“çš„åº”ç”¨ã€‚\nLabel å®šä¹‰å¥½åå…¶ä»–å¯¹è±¡å¯ä»¥ä½¿ç”¨ Label Selector æ¥é€‰æ‹©ä¸€ç»„ç›¸åŒ label çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ ReplicaSet å’Œ Service ç”¨ label æ¥é€‰æ‹©ä¸€ç»„ Podï¼‰ã€‚Label Selector æ”¯æŒä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š\n ç­‰å¼ï¼Œå¦‚ app=nginx å’Œ env!=production é›†åˆï¼Œå¦‚ env in (production, qa) å¤šä¸ª labelï¼ˆå®ƒä»¬ä¹‹é—´æ˜¯ AND å…³ç³»ï¼‰ï¼Œå¦‚ app=nginx,env=test  7âƒ£ï¸ Annotations Annotations æ˜¯ key/value å½¢å¼é™„åŠ äºå¯¹è±¡çš„æ³¨è§£ã€‚ä¸åŒäº Labels ç”¨äºæ ‡å¿—å’Œé€‰æ‹©å¯¹è±¡ï¼ŒAnnotations åˆ™æ˜¯ç”¨æ¥è®°å½•ä¸€äº›é™„åŠ ä¿¡æ¯ï¼Œç”¨æ¥è¾…åŠ©åº”ç”¨éƒ¨ç½²ã€å®‰å…¨ç­–ç•¥ä»¥åŠè°ƒåº¦ç­–ç•¥ç­‰ã€‚æ¯”å¦‚ deployment ä½¿ç”¨ annotations æ¥è®°å½• rolling update çš„çŠ¶æ€ã€‚\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: gray-release annotations: # è¯·æ±‚å¤´ä¸­æ»¡è¶³æ­£åˆ™åŒ¹é…foo=barçš„è¯·æ±‚æ‰ä¼šè¢«è·¯ç”±åˆ°æ–°ç‰ˆæœ¬æœåŠ¡new-nginxä¸­ nginx.ingress.kubernetes.io/service-match: | new-nginx: header(\u0026#34;foo\u0026#34;, /^bar$/) # åœ¨æ»¡è¶³ä¸Šè¿°åŒ¹é…è§„åˆ™çš„åŸºç¡€ä¸Šä»…å…è®¸50%çš„æµé‡ä¼šè¢«è·¯ç”±åˆ°æ–°ç‰ˆæœ¬æœåŠ¡new-nginxä¸­ nginx.ingress.kubernetes.io/service-weight: | new-nginx: 50, old-nginx: 50 spec: rules: - host: www.example.com http: paths: # è€ç‰ˆæœ¬æœåŠ¡ - path: / backend: serviceName: old-nginx servicePort: 80 # æ–°ç‰ˆæœ¬æœåŠ¡ - path: / backend: serviceName: new-nginx servicePort: 80 å‚è€ƒé“¾æ¥\nhttps://feisky.gitbooks.io/kubernetes/content/introduction/concepts.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.2k8s%E5%9F%BA%E7%A1%80%E6%89%AB%E7%9B%B2/1.2.2.1k8s%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.2.1 k8såŸºæœ¬æ¦‚å¿µ"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.2.2 åè¯è§£é‡Š Cluster\nCluster æ˜¯è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œèµ„æºçš„é›†åˆï¼ŒKubernetes åˆ©ç”¨è¿™äº›èµ„æºè¿è¡Œå„ç§åŸºäºå®¹å™¨çš„åº”ç”¨ã€‚\nMaster\nMaster æ˜¯ Cluster çš„å¤§è„‘ï¼Œå®ƒçš„ä¸»è¦èŒè´£æ˜¯è°ƒåº¦ï¼Œå³å†³å®šå°†åº”ç”¨æ”¾åœ¨å“ªé‡Œè¿è¡Œã€‚Master è¿è¡Œ Linux æ“ä½œç³»ç»Ÿï¼Œå¯ä»¥æ˜¯ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºã€‚ä¸ºäº†å®ç°é«˜å¯ç”¨ï¼Œå¯ä»¥è¿è¡Œå¤šä¸ª Masterã€‚\nNode\nNode çš„èŒè´£æ˜¯è¿è¡Œå®¹å™¨åº”ç”¨ã€‚Node ç”± Master ç®¡ç†ï¼ŒNode è´Ÿè´£ç›‘æ§å¹¶æ±‡æŠ¥å®¹å™¨çš„çŠ¶æ€ï¼Œå¹¶æ ¹æ® Master çš„è¦æ±‚ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚Node è¿è¡Œåœ¨ Linux æ“ä½œç³»ç»Ÿï¼Œå¯ä»¥æ˜¯ç‰©ç†æœºæˆ–è€…æ˜¯è™šæ‹Ÿæœºã€‚\nPod\nPod æ˜¯ Kubernetes çš„æœ€å°å·¥ä½œå•å…ƒã€‚æ¯ä¸ª Pod åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚Pod ä¸­çš„å®¹å™¨ä¼šä½œä¸ºä¸€ä¸ªæ•´ä½“è¢« Master è°ƒåº¦åˆ°ä¸€ä¸ª Node ä¸Šè¿è¡Œï¼Œä¸€ä¸ªPodé‡Œçš„æ‰€æœ‰å®¹å™¨å…±ç”¨ä¸€ä¸ªnamespaces\nController\nç®¡ç†Podçš„å·¥å…·ï¼Œkubernetesé€šè¿‡å®ƒæ¥ç®¡ç†é›†ç¾¤ä¸­çš„Pod\nDeployment\nDeployment æ˜¯æœ€å¸¸ç”¨çš„ Controllerï¼Œæ¯”å¦‚å‰é¢åœ¨çº¿æ•™ç¨‹ä¸­å°±æ˜¯é€šè¿‡åˆ›å»º Deployment æ¥éƒ¨ç½²åº”ç”¨çš„ã€‚Deployment å¯ä»¥ç®¡ç† Pod çš„å¤šä¸ªå‰¯æœ¬ï¼Œå¹¶ç¡®ä¿ Pod æŒ‰ç…§æœŸæœ›çš„çŠ¶æ€è¿è¡Œã€‚\nReplicaSet\nReplicaSet å®ç°äº† Pod çš„å¤šå‰¯æœ¬ç®¡ç†ã€‚ä½¿ç”¨ Deployment æ—¶ä¼šè‡ªåŠ¨åˆ›å»º ReplicaSetï¼Œä¹Ÿå°±æ˜¯è¯´ Deployment æ˜¯é€šè¿‡ ReplicaSet æ¥ç®¡ç† Pod çš„å¤šä¸ªå‰¯æœ¬ï¼Œæˆ‘ä»¬é€šå¸¸ä¸éœ€è¦ç›´æ¥ä½¿ç”¨ ReplicaSetã€‚\nDaemonSet\nDaemonSet ç”¨äºæ¯ä¸ª Node æœ€å¤šåªè¿è¡Œä¸€ä¸ª Pod å‰¯æœ¬çš„åœºæ™¯ã€‚æ­£å¦‚å…¶åç§°æ‰€æ­ç¤ºçš„ï¼ŒDaemonSet é€šå¸¸ç”¨äºè¿è¡Œ daemonã€‚\nStatefuleSet\nStatefuleSet èƒ½å¤Ÿä¿è¯ Pod çš„æ¯ä¸ªå‰¯æœ¬åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­åç§°æ˜¯ä¸å˜çš„ã€‚è€Œå…¶ä»– Controller ä¸æä¾›è¿™ä¸ªåŠŸèƒ½ï¼Œå½“æŸä¸ª Pod å‘ç”Ÿæ•…éšœéœ€è¦åˆ é™¤å¹¶é‡æ–°å¯åŠ¨æ—¶ï¼ŒPod çš„åç§°ä¼šå‘ç”Ÿå˜åŒ–ã€‚åŒæ—¶ StatefuleSet ä¼šä¿è¯å‰¯æœ¬æŒ‰ç…§å›ºå®šçš„é¡ºåºå¯åŠ¨ã€æ›´æ–°æˆ–è€…åˆ é™¤ã€‚\nJob\nJob ç”¨äºè¿è¡Œç»“æŸå°±åˆ é™¤çš„åº”ç”¨ã€‚è€Œå…¶ä»– Controller ä¸­çš„ Pod é€šå¸¸æ˜¯é•¿æœŸæŒç»­è¿è¡Œã€‚\nService\nKubernetes Service å®šä¹‰äº†å¤–ç•Œè®¿é—®ä¸€ç»„ç‰¹å®š Pod çš„æ–¹å¼ã€‚Service æœ‰è‡ªå·±çš„ IP å’Œç«¯å£ï¼Œå¹¶æŠŠè¿™ä¸ªIPå’Œåç«¯çš„Podæ‰€è·‘çš„æœåŠ¡çš„å…³è”èµ·æ¥ã€‚Service ä¸º Pod æä¾›äº†è´Ÿè½½å‡è¡¡ã€‚\nNamespace \nNamespace å¯ä»¥å°†ä¸€ä¸ªç‰©ç†çš„ Cluster é€»è¾‘ä¸Šåˆ’åˆ†æˆå¤šä¸ªè™šæ‹Ÿ Clusterï¼Œæ¯ä¸ª Cluster å°±æ˜¯ä¸€ä¸ª Namespaceã€‚ä¸åŒ Namespace é‡Œçš„èµ„æºæ˜¯å®Œå…¨éš”ç¦»çš„ã€‚Kubernetes é»˜è®¤åˆ›å»ºäº†ä¸¤ä¸ª Namespaceï¼Œdefaultå’Œkube-system\nå‚è€ƒé“¾æ¥\nhttps://feisky.gitbooks.io/kubernetes/content/introduction/concepts.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.2k8s%E5%9F%BA%E7%A1%80%E6%89%AB%E7%9B%B2/1.2.2.2%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.2.2 åè¯è§£é‡Š"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.3 k8sæ¶æ„ Kubernetes ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆ:\n etcd ä¿å­˜äº†æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼Œå°±æ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼› apiserver æä¾›äº†èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œå¹¶æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€API æ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶ï¼› controller manager è´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰ï¼› scheduler è´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°† Pod è°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šï¼› kubelet è´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£ Volumeï¼ˆCSIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†ï¼› Container runtime è´Ÿè´£é•œåƒç®¡ç†ä»¥åŠ Pod å’Œå®¹å™¨çš„çœŸæ­£è¿è¡Œï¼ˆCRIï¼‰ï¼› kube-proxy è´Ÿè´£ä¸º Service æä¾› cluster å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼›  å½“ç„¶äº†é™¤äº†ä¸Šé¢çš„è¿™äº›æ ¸å¿ƒç»„ä»¶ï¼Œè¿˜æœ‰ä¸€äº›æ¨èçš„æ’ä»¶ï¼š\n kube-dns è´Ÿè´£ä¸ºæ•´ä¸ªé›†ç¾¤æä¾› DNS æœåŠ¡ Ingress Controller ä¸ºæœåŠ¡æä¾›å¤–ç½‘å…¥å£ Heapster æä¾›èµ„æºç›‘æ§ Dashboard æä¾› GUI  ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.3k8s%E6%9E%B6%E6%9E%84/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.3 k8sæ¶æ„"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.4 äº‘å‚å•†é›†æˆk8s é˜¿é‡Œäº‘ ACK è…¾è®¯äº‘ TKE åä¸ºäº‘ CCE AWS EKS Google GKE Azure AKS DigitalOcean k8s Oracle OKE\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.4%E4%BA%91%E5%8E%82%E5%95%86%E9%9B%86%E6%88%90k8s/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.4 äº‘å‚å•†é›†æˆk8s"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.5 k8sæ¥å£ \rå‡ ç§æ¥å£è§£é‡Šï¼š\n  CRIï¼ˆContainer Runtime Interfaceï¼‰ã€‚å®¹å™¨è¿è¡Œæ—¶æ¥å£ã€‚Kubernetesé¡¹ç›®å¹¶ä¸å…³å¿ƒä½ éƒ¨ç½²çš„æ˜¯ä»€ä¹ˆå®¹å™¨è¿è¡Œæ—¶ã€ä½¿ç”¨çš„ä»€ä¹ˆæŠ€æœ¯å®ç°ï¼Œåªè¦ä½ çš„è¿™ä¸ªå®¹å™¨è¿è¡Œæ—¶èƒ½å¤Ÿè¿è¡Œæ ‡å‡†çš„å®¹å™¨é•œåƒï¼Œå®ƒå°±å¯ä»¥é€šè¿‡å®ç°CRIæ¥å…¥åˆ°Kubernetesé¡¹ç›®å½“ä¸­ã€‚Kubernetesæ˜¯é€šè¿‡kubeletè·ŸCRIè¿›è¡Œé€šä¿¡ã€‚\n  OCIï¼ˆOpen Container Initiativeï¼‰\rï¼šå…·ä½“çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œæ¯”å¦‚Dockeré¡¹ç›®ï¼Œåˆ™ä¸€èˆ¬é€šè¿‡OCIè¿™ä¸ªå®¹å™¨è¿è¡Œæ—¶è§„èŒƒåŒåº•å±‚çš„Linuxæ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œå³ï¼šæŠŠCRIè¯·æ±‚ç¿»è¯‘æˆå¯¹Linuxæ“ä½œç³»ç»Ÿçš„è°ƒç”¨ï¼ˆæ“ä½œLinux Namespaceå’ŒCgroupsç­‰ï¼‰ã€‚\n CRIæ˜¯k8så¯¹å¤–æš´éœ²çš„æŠ½è±¡å®¹å™¨æ¥å£ï¼ŒOCIæ˜¯å¼€å‘å®¹å™¨å€¡è®®ï¼Œæœ€ç»ˆCRIæ¥å£ä¼šè°ƒç”¨ç¬¦åˆOCIçš„ç³»ç»Ÿå†…æ ¸æ¥å£\nå®¹å™¨ç”Ÿæ€ä¸‰å±‚æŠ½è±¡:\n Orchestration API -\u0026gt; Container API -\u0026gt; Kernel API\n  Orchestration API: kubernetes APIæ ‡å‡†å°±æ˜¯è¿™å±‚çš„æ ‡å‡†,æ— å¯éè®® Container API: æ ‡å‡†å°±æ˜¯CRI Kernel API: æ ‡å‡†å°±æ˜¯OCI     CNIï¼ˆContainer Networking Interfaceï¼‰ï¼šè°ƒç”¨ç½‘ç»œæ’ä»¶åšç½‘ç»œé€šä¿¡ã€‚\n  CSIï¼ˆContainer Storage Interfaceï¼‰ï¼šè°ƒç”¨å­˜å‚¨æ’ä»¶é…ç½®æŒä¹…åŒ–å­˜å‚¨ã€‚\n  kubeletè¿˜é€šè¿‡gRPCåè®®åŒä¸€ä¸ªå«ä½œDevice Pluginçš„æ’ä»¶è¿›è¡Œäº¤äº’ã€‚\n   ä»¥ä¸Šå‡ ç§æ¥å£éƒ½æ˜¯kubeletæ‰€è¦æ”¯æŒçš„åŠŸèƒ½ï¼Œæ‰€ä»¥è®¡ç®—èŠ‚ç‚¹ä¸Šæœ€æ ¸å¿ƒçš„ç»„ä»¶å°±æ˜¯kubeletã€‚\n ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.5k8s%E6%8E%A5%E5%8F%A3/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.5 k8sæ¥å£"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.6 k8sç»„ä»¶ Masterï¼ˆæ§åˆ¶å¹³é¢ï¼‰ç»„ä»¶ 1âƒ£ï¸ kube-apiserver\r  æä¾›é›†ç¾¤ç®¡ç†çš„ REST API\ræ¥å£ï¼ŒåŒ…æ‹¬è®¤è¯æˆæƒã€æ•°æ®æ ¡éªŒä»¥åŠé›†ç¾¤çŠ¶æ€å˜æ›´ç­‰ æä¾›å…¶ä»–æ¨¡å—ä¹‹é—´çš„æ•°æ®äº¤äº’å’Œé€šä¿¡çš„æ¢çº½ï¼ˆå…¶ä»–æ¨¡å—é€šè¿‡ API Server æŸ¥è¯¢æˆ–ä¿®æ”¹æ•°æ®ï¼Œåªæœ‰ API Server æ‰ç›´æ¥æ“ä½œ etcdï¼‰  2âƒ£ï¸ etcd\r etcd æ˜¯ CoreOS åŸºäº Raft å¼€å‘çš„åˆ†å¸ƒå¼ key-value å­˜å‚¨ï¼Œå¯ç”¨äºæœåŠ¡å‘ç°ã€å…±äº«é…ç½®ä»¥åŠä¸€è‡´æ€§ä¿éšœï¼ˆå¦‚æ•°æ®åº“é€‰ä¸»ã€åˆ†å¸ƒå¼é”ç­‰ï¼‰ã€‚\nä¸»è¦åŠŸèƒ½ğŸ”§åŒ…æ‹¬ï¼š\n åŸºæœ¬çš„ key-value å­˜å‚¨ ç›‘å¬æœºåˆ¶ key çš„è¿‡æœŸåŠç»­çº¦æœºåˆ¶ï¼Œç”¨äºç›‘æ§å’ŒæœåŠ¡å‘ç° åŸå­ CAS å’Œ CADï¼Œç”¨äºåˆ†å¸ƒå¼é”å’Œ leader é€‰ä¸¾  Etcdï¼ŒZookeeperï¼ŒConsul æ¯”è¾ƒ ğŸ†šï¼š\n Etcd å’Œ Zookeeper æä¾›çš„èƒ½åŠ›éå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯é€šç”¨çš„ä¸€è‡´æ€§å…ƒä¿¡æ¯å­˜å‚¨ï¼Œéƒ½æä¾› watch æœºåˆ¶ç”¨äºå˜æ›´é€šçŸ¥å’Œåˆ†å‘ï¼Œä¹Ÿéƒ½è¢«åˆ†å¸ƒå¼ç³»ç»Ÿç”¨æ¥ä½œä¸ºå…±äº«ä¿¡æ¯å­˜å‚¨ï¼Œåœ¨è½¯ä»¶ç”Ÿæ€ä¸­æ‰€å¤„çš„ä½ç½®ä¹Ÿå‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥äº’ç›¸æ›¿ä»£çš„ã€‚äºŒè€…é™¤äº†å®ç°ç»†èŠ‚ï¼Œè¯­è¨€ï¼Œä¸€è‡´æ€§åè®®ä¸Šçš„åŒºåˆ«ï¼Œæœ€å¤§çš„åŒºåˆ«åœ¨å‘¨è¾¹ç”Ÿæ€åœˆã€‚Zookeeper æ˜¯ apache ä¸‹çš„ï¼Œç”¨ java å†™çš„ï¼Œæä¾› rpc æ¥å£ï¼Œæœ€æ—©ä» hadoop é¡¹ç›®ä¸­å­µåŒ–å‡ºæ¥ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¾—åˆ°å¹¿æ³›ä½¿ç”¨ï¼ˆhadoop, solr, kafka, mesos ç­‰ï¼‰ã€‚Etcd æ˜¯ coreos å…¬å¸æ——ä¸‹çš„å¼€æºäº§å“ï¼Œæ¯”è¾ƒæ–°ï¼Œä»¥å…¶ç®€å•å¥½ç”¨çš„ rest æ¥å£ä»¥åŠæ´»è·ƒçš„ç¤¾åŒºä¿˜è·äº†ä¸€æ‰¹ç”¨æˆ·ï¼Œåœ¨æ–°çš„ä¸€äº›é›†ç¾¤ä¸­å¾—åˆ°ä½¿ç”¨ï¼ˆæ¯”å¦‚ kubernetesï¼‰ã€‚è™½ç„¶ v3 ä¸ºäº†æ€§èƒ½ä¹Ÿæ”¹æˆäºŒè¿›åˆ¶ rpc æ¥å£äº†ï¼Œä½†å…¶æ˜“ç”¨æ€§ä¸Šæ¯” Zookeeper è¿˜æ˜¯å¥½ä¸€äº›ã€‚ è€Œ Consul çš„ç›®æ ‡åˆ™æ›´ä¸ºå…·ä½“ä¸€äº›ï¼ŒEtcd å’Œ Zookeeper æä¾›çš„æ˜¯åˆ†å¸ƒå¼ä¸€è‡´æ€§å­˜å‚¨èƒ½åŠ›ï¼Œå…·ä½“çš„ä¸šåŠ¡åœºæ™¯éœ€è¦ç”¨æˆ·è‡ªå·±å®ç°ï¼Œæ¯”å¦‚æœåŠ¡å‘ç°ï¼Œæ¯”å¦‚é…ç½®å˜æ›´ã€‚è€Œ Consul åˆ™ä»¥æœåŠ¡å‘ç°å’Œé…ç½®å˜æ›´ä¸ºä¸»è¦ç›®æ ‡ï¼ŒåŒæ—¶é™„å¸¦äº† kv å­˜å‚¨ã€‚  3âƒ£ï¸ kube-scheduler\r kube-scheduler è´Ÿè´£åˆ†é…è°ƒåº¦ Pod åˆ°é›†ç¾¤å†…çš„èŠ‚ç‚¹ä¸Šï¼Œå®ƒç›‘å¬ kube-apiserverï¼ŒæŸ¥è¯¢è¿˜æœªåˆ†é… Node çš„ Podï¼Œç„¶åæ ¹æ®è°ƒåº¦ç­–ç•¥ä¸ºè¿™äº› Pod åˆ†é…èŠ‚ç‚¹ï¼ˆæ›´æ–° Pod çš„ NodeName å­—æ®µï¼‰ã€‚\nè°ƒåº¦å™¨éœ€è¦å……åˆ†è€ƒè™‘ğŸ¤”è¯¸å¤šçš„å› ç´ ï¼š\n å…¬å¹³è°ƒåº¦ èµ„æºé«˜æ•ˆåˆ©ç”¨ QoS affinity å’Œ anti-affinity æ•°æ®æœ¬åœ°åŒ–ï¼ˆdata localityï¼‰ å†…éƒ¨è´Ÿè½½å¹²æ‰°ï¼ˆinter-workload interferenceï¼‰ deadlines  4âƒ£ï¸ kube-controller-manager\r kube-controller-manager ç”±ä¸€ç³»åˆ—çš„æ§åˆ¶å™¨ç»„æˆï¼Œè¿™äº›æ§åˆ¶å™¨å¯ä»¥åˆ’åˆ†ä¸ºä¸‰ç»„\n  å¿…é¡»å¯åŠ¨çš„æ§åˆ¶å™¨\n EndpointController: å¡«å……ç«¯ç‚¹(Endpoints)å¯¹è±¡(å³åŠ å…¥ Service ä¸ Pod) ReplicationController PodGCController ResourceQuotaController NamespaceController ServiceAccountController: ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œ GarbageCollectorController DaemonSetController JobControllerï¼šç›‘æµ‹ä»£è¡¨ä¸€æ¬¡æ€§ä»»åŠ¡çš„ Job å¯¹è±¡ï¼Œç„¶ååˆ›å»º Pods æ¥è¿è¡Œè¿™äº›ä»»åŠ¡ç›´è‡³å®Œæˆ DeploymentController ReplicaSetController HPAController DisruptionController StatefulSetController CronJobController CSRSigningController CSRApprovingController TTLController    é»˜è®¤å¯åŠ¨çš„å¯é€‰æ§åˆ¶å™¨ï¼Œå¯é€šè¿‡é€‰é¡¹è®¾ç½®æ˜¯å¦å¼€å¯\n TokenController: ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»º API è®¿é—®ä»¤ç‰Œ NodeController: è´Ÿè´£åœ¨èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶è¿›è¡Œé€šçŸ¥å’Œå“åº” ServiceController RouteController PVBinderController AttachDetachController    é»˜è®¤ç¦æ­¢çš„å¯é€‰æ§åˆ¶å™¨ï¼Œå¯é€šè¿‡é€‰é¡¹è®¾ç½®æ˜¯å¦å¼€å¯\n BootstrapSignerController TokenCleanerController    5âƒ£ï¸ cloud-controller-manager\r cloud-controller-manager åœ¨ Kubernetes å¯ç”¨ Cloud Provider çš„æ—¶å€™æ‰éœ€è¦ï¼Œç”¨æ¥é…åˆäº‘æœåŠ¡æä¾›å•†çš„æ§åˆ¶ï¼Œä¹ŸåŒ…æ‹¬ä¸€ç³»åˆ—çš„æ§åˆ¶å™¨\n CloudNodeController: ç”¨äºåœ¨èŠ‚ç‚¹ç»ˆæ­¢å“åº”åæ£€æŸ¥äº‘æä¾›å•†ä»¥ç¡®å®šèŠ‚ç‚¹æ˜¯å¦å·²è¢«åˆ é™¤ RouteController: ç”¨äºåœ¨åº•å±‚äº‘åŸºç¡€æ¶æ„ä¸­è®¾ç½®è·¯ç”± ServiceController: ç”¨äºåˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤äº‘æä¾›å•†è´Ÿè½½å‡è¡¡å™¨  Node ç»„ä»¶ 1âƒ£ï¸ Kubelet\r æ¯ä¸ªNodeèŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œä¸€ä¸ª Kubelet æœåŠ¡è¿›ç¨‹ï¼Œé»˜è®¤ç›‘å¬ 10250 ç«¯å£ï¼Œæ¥æ”¶å¹¶æ‰§è¡Œ Master å‘æ¥çš„æŒ‡ä»¤ï¼Œç®¡ç† Pod åŠ Pod ä¸­çš„å®¹å™¨ã€‚æ¯ä¸ª Kubelet è¿›ç¨‹ä¼šåœ¨ API Server ä¸Šæ³¨å†Œæ‰€åœ¨NodeèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå®šæœŸå‘ Master èŠ‚ç‚¹æ±‡æŠ¥è¯¥èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶é€šè¿‡ cAdvisor ç›‘æ§èŠ‚ç‚¹å’Œå®¹å™¨çš„èµ„æºã€‚ç®¡ç†èŠ‚ç‚¹ ç®¡ç†POD ç®¡ç†å®¹å™¨ ç›‘æ§èŠ‚ç‚¹å’Œå®¹å™¨\n2âƒ£ï¸ kube-proxy\r æ¯å°æœºå™¨ä¸Šéƒ½è¿è¡Œä¸€ä¸ª kube-proxy æœåŠ¡ï¼Œå®ƒç›‘å¬ API server ä¸­ service å’Œ endpoint çš„å˜åŒ–æƒ…å†µï¼Œå¹¶é€šè¿‡ userspaceã€iptablesã€ipvs æˆ– winuserspace ç­‰ proxier æ¥ä¸ºæœåŠ¡é…ç½®è´Ÿè½½å‡è¡¡ï¼ˆä»…æ”¯æŒ TCP å’Œ UDPï¼‰ã€‚\nkube-proxy å¯ä»¥ç›´æ¥è¿è¡Œåœ¨ç‰©ç†æœºä¸Šï¼Œä¹Ÿå¯ä»¥ä»¥ static pod æˆ–è€… daemonset çš„æ–¹å¼è¿è¡Œã€‚\n é™æ€ Pod é™¤äº† DaemonSetï¼Œè¿˜å¯ä»¥ä½¿ç”¨é™æ€ Pod æ¥åœ¨æ¯å°æœºå™¨ä¸Šè¿è¡ŒæŒ‡å®šçš„ Podï¼Œè¿™éœ€è¦ kubelet åœ¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®š manifest ç›®å½•ï¼š\nkubelet --pod-manifest-path=/etc/kubernetes/manifests ç„¶åå°†æ‰€éœ€è¦çš„ Pod å®šä¹‰æ–‡ä»¶æ”¾åˆ°æŒ‡å®šçš„ manifest ç›®å½•ä¸­ã€‚\næ³¨æ„ï¼šé™æ€ Pod ä¸èƒ½é€šè¿‡ API Server æ¥åˆ é™¤ï¼Œä½†å¯ä»¥é€šè¿‡åˆ é™¤ manifest æ–‡ä»¶æ¥è‡ªåŠ¨åˆ é™¤å¯¹åº”çš„ Podã€‚\n 3âƒ£ï¸ å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰\r å®¹å™¨è¿è¡Œç¯å¢ƒæ˜¯è´Ÿè´£è¿è¡Œå®¹å™¨çš„è½¯ä»¶ã€‚\nKubernetes æ”¯æŒå¤šä¸ªå®¹å™¨è¿è¡Œç¯å¢ƒ: Docker\rã€ containerd\rã€CRI-O\rä»¥åŠä»»ä½•å®ç° Kubernetes CRI (å®¹å™¨è¿è¡Œç¯å¢ƒæ¥å£)\rã€‚\næ’ä»¶ï¼ˆAddonsï¼‰ 1âƒ£ï¸ DNS\r DNS æ˜¯ Kubernetes çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œé€šè¿‡ kube-dns æˆ– CoreDNS ä½œä¸ºé›†ç¾¤çš„å¿…å¤‡æ‰©å±•æ¥æä¾›å‘½åæœåŠ¡ã€‚\nä» v1.11 å¼€å§‹å¯ä»¥ä½¿ç”¨ CoreDNS\ræ¥æä¾›å‘½åæœåŠ¡ï¼Œå¹¶ä» v1.13 å¼€å§‹æˆä¸ºé»˜è®¤ DNS æœåŠ¡ã€‚CoreDNS çš„ç‰¹ç‚¹æ˜¯æ•ˆç‡æ›´é«˜ï¼Œèµ„æºå ç”¨ç‡æ›´å°ï¼Œæ¨èä½¿ç”¨ CoreDNS æ›¿ä»£ kube-dns ä¸ºé›†ç¾¤æä¾› DNS æœåŠ¡ã€‚\n2âƒ£ï¸ Dashboard\r 3âƒ£ï¸ å®¹å™¨èµ„æºç›‘æ§\r ç›‘æ§ç³»ç»Ÿç”¨äºé‡‡é›†nodeå’Œpodçš„ç›‘æ§æ•°æ®\n metric-server æ ¸å¿ƒæŒ‡æ ‡ç›‘æ§ prometheus è‡ªå®šä¹‰æŒ‡æ ‡ç›‘æ§ï¼Œæä¾›ä¸°å¯ŒåŠŸèƒ½ heapster+influxdb+grafana æ—§æ ¸å¿ƒæŒ‡æ ‡ç›‘æ§æ–¹æ¡ˆï¼Œç°å·²åºŸå¼ƒ  4âƒ£ï¸ é›†ç¾¤å±‚é¢æ—¥å¿—\r æ—¥å¿—é‡‡é›†ç³»ç»Ÿï¼Œç”¨äºæ”¶é›†å®¹å™¨çš„ä¸šåŠ¡æ•°æ®,å®ç°æ—¥å¿—çš„é‡‡é›†ï¼Œå­˜å‚¨å’Œå±•ç¤ºï¼Œç”±EFKå®ç°\n Fluentd æ—¥å¿—é‡‡é›† ElasticSearch æ—¥å¿—å­˜å‚¨+æ£€ç´¢ Kiabana æ•°æ®å±•ç¤º  å‚è€ƒé“¾æ¥\nhttps://feisky.gitbooks.io/kubernetes/content/components/components.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.6k8s%E7%BB%84%E4%BB%B6/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.6 k8sç»„ä»¶"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.7 k8sç»„ä»¶é—´é€šä¿¡ Kubernetes å¤šç»„ä»¶ä¹‹é—´çš„é€šä¿¡åŸç†ï¼š\n apiserver è´Ÿè´£ etcd å­˜å‚¨çš„æ‰€æœ‰æ“ä½œï¼Œä¸”åªæœ‰ apiserver æ‰ç›´æ¥æ“ä½œ etcd é›†ç¾¤ apiserver å¯¹å†…ï¼ˆé›†ç¾¤ä¸­çš„å…¶ä»–ç»„ä»¶ï¼‰å’Œå¯¹å¤–ï¼ˆç”¨æˆ·ï¼‰æä¾›ç»Ÿä¸€çš„ REST APIï¼Œå…¶ä»–ç»„ä»¶å‡é€šè¿‡ apiserver è¿›è¡Œé€šä¿¡  controller managerã€schedulerã€kube-proxy å’Œ kubelet ç­‰å‡é€šè¿‡ apiserver watch API ç›‘æµ‹èµ„æºå˜åŒ–æƒ…å†µï¼Œå¹¶å¯¹èµ„æºä½œç›¸åº”çš„æ“ä½œ æ‰€æœ‰éœ€è¦æ›´æ–°èµ„æºçŠ¶æ€çš„æ“ä½œå‡é€šè¿‡ apiserver çš„ REST API è¿›è¡Œ   apiserver ä¹Ÿä¼šç›´æ¥è°ƒç”¨ kubelet APIï¼ˆå¦‚ logs, exec, attach ç­‰ï¼‰ï¼Œé»˜è®¤ä¸æ ¡éªŒ kubelet è¯ä¹¦ï¼Œä½†å¯ä»¥é€šè¿‡ --kubelet-certificate-authority å¼€å¯ï¼ˆè€Œ GKE é€šè¿‡ SSH éš§é“ä¿æŠ¤å®ƒä»¬ä¹‹é—´çš„é€šä¿¡ï¼‰  æ¯”å¦‚æœ€å…¸å‹çš„åˆ›å»º Pod çš„æµç¨‹ï¼š\n  é€šè¿‡ CLI æˆ–è€… UI æäº¤ Pod éƒ¨ç½²è¯·æ±‚ç»™ Kubernetes API Server\n  API Server ä¼šæŠŠè¿™ä¸ªä¿¡æ¯å†™å…¥åˆ°å®ƒçš„å­˜å‚¨ç³»ç»Ÿ etcd\n  Scheduler ä¼šé€šè¿‡ API Server çš„ watch æˆ–è€…å«åš notification æœºåˆ¶å¾—åˆ°è¿™ä¸ªä¿¡æ¯ï¼šæœ‰ä¸€ä¸ª Pod éœ€è¦è¢«è°ƒåº¦\n è°ƒåº¦å†³ç­– å‘ API Server report è¯´ï¼šâ€œOKï¼è¿™ä¸ª Pod éœ€è¦è¢«è°ƒåº¦åˆ°æŸä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚â€    API Server æ¥æ”¶åˆ°è¿™æ¬¡æ“ä½œä¹‹åï¼Œä¼šæŠŠè¿™æ¬¡çš„ç»“æœå†æ¬¡å†™åˆ° etcd ä¸­\n  ç›¸åº”èŠ‚ç‚¹çš„ kubelet ä¼šwatchåˆ°ä¸€ä¸ªéœ€è¦å¯åŠ¨çš„Pod\n kubeletè°ƒCRIé…ç½®å®¹å™¨çš„è¿è¡Œç¯å¢ƒã€è°ƒCNIé…ç½®ç½‘ç»œã€è°ƒCSIæ¥å£é…ç½®å­˜å‚¨ ä¸Šä¼ çŠ¶æ€ä¿¡æ¯ç»™API Server    API Server è®°å½•Podéƒ¨ç½²çŠ¶æ€åˆ°etcd\n  å‚è€ƒé“¾æ¥\nhttps://www.qikqiak.com/k8s-book/docs/15.%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%BB%84%E4%BB%B6.html\rhttps://www.wumingx.com/k8s/kubernetes-introduction.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.7k8s%E7%BB%84%E4%BB%B6%E9%97%B4%E9%80%9A%E4%BF%A1/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.7 k8sç»„ä»¶é—´é€šä¿¡"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.8.1 PV/PVC/StorageClass åè¯è§£é‡Šï¼šPV/PVC/StorageClass\r æœ¬æ–‡è¾ƒè€ï¼Œå»ºè®®æŸ¥çœ‹æ–°æ–‡æ¡£ï¼šhttp://docs.kubernetes.org.cn/429.html ä»‹ç» PersistentVolumeï¼ˆPVï¼‰æ˜¯é›†ç¾¤ä¸­å·²ç”±ç®¡ç†å‘˜é…ç½®çš„ä¸€æ®µç½‘ç»œå­˜å‚¨ã€‚ é›†ç¾¤ä¸­çš„èµ„æºå°±åƒä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªé›†ç¾¤èµ„æºã€‚ PVæ˜¯è¯¸å¦‚å·ä¹‹ç±»çš„å·æ’ä»¶ï¼Œä½†æ˜¯å…·æœ‰ç‹¬ç«‹äºä½¿ç”¨PVçš„ä»»ä½•å•ä¸ªpodçš„ç”Ÿå‘½å‘¨æœŸã€‚ è¯¥APIå¯¹è±¡æ•è·å­˜å‚¨çš„å®ç°ç»†èŠ‚ï¼Œå³NFSï¼ŒiSCSIæˆ–äº‘æä¾›å•†ç‰¹å®šçš„å­˜å‚¨ç³»ç»Ÿã€‚\nPersistentVolumeClaimï¼ˆPVCï¼‰æ˜¯ç”¨æˆ·å­˜å‚¨çš„è¯·æ±‚ã€‚ å®ƒç±»ä¼¼äºpodã€‚Podæ¶ˆè€—èŠ‚ç‚¹èµ„æºï¼ŒPVCæ¶ˆè€—å­˜å‚¨èµ„æºã€‚ podå¯ä»¥è¯·æ±‚ç‰¹å®šçº§åˆ«çš„èµ„æºï¼ˆCPUå’Œå†…å­˜ï¼‰ã€‚ æƒé™è¦æ±‚å¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼ã€‚\nè™½ç„¶PersistentVolumeClaimså…è®¸ç”¨æˆ·ä½¿ç”¨æŠ½è±¡å­˜å‚¨èµ„æºï¼Œä½†æ˜¯å¸¸è§çš„æ˜¯ï¼Œç”¨æˆ·éœ€è¦å…·æœ‰ä¸åŒå±æ€§ï¼ˆå¦‚æ€§èƒ½ï¼‰çš„PersistentVolumesï¼Œç”¨äºä¸åŒçš„é—®é¢˜ã€‚ ç¾¤é›†ç®¡ç†å‘˜éœ€è¦èƒ½å¤Ÿæä¾›å¤šç§ä¸åŒäºPersistentVolumesçš„PersistentVolumesï¼Œè€Œä¸ä»…ä»…æ˜¯å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼Œè€Œä¸ä¼šä½¿ç”¨æˆ·äº†è§£è¿™äº›å·çš„å®ç°ç»†èŠ‚ã€‚ å¯¹äºè¿™äº›éœ€æ±‚ï¼Œå­˜åœ¨StorageClassèµ„æºã€‚\nStorageClassä¸ºç®¡ç†å‘˜æä¾›äº†ä¸€ç§æè¿°ä»–ä»¬æä¾›çš„å­˜å‚¨çš„â€œç±»â€çš„æ–¹æ³•ã€‚ ä¸åŒçš„ç±»å¯èƒ½æ˜ å°„åˆ°æœåŠ¡è´¨é‡çº§åˆ«ï¼Œæˆ–å¤‡ä»½ç­–ç•¥ï¼Œæˆ–è€…ç”±ç¾¤é›†ç®¡ç†å‘˜ç¡®å®šçš„ä»»æ„ç­–ç•¥ã€‚ Kubernetesæœ¬èº«å¯¹äºä»€ä¹ˆç±»åˆ«ä»£è¡¨æ˜¯ä¸è¨€è€Œå–»çš„ã€‚ è¿™ä¸ªæ¦‚å¿µæœ‰æ—¶åœ¨å…¶ä»–å­˜å‚¨ç³»ç»Ÿä¸­ç§°ä¸ºâ€œé…ç½®æ–‡ä»¶â€\nä¾‹å­ https://kubernetes.io/docs/user-guide/persistent-volumes/walkthrough/\rLifecycle of a volume and claim PVæ˜¯é›†ç¾¤ä¸­çš„èµ„æºã€‚ PVCæ˜¯å¯¹è¿™äº›èµ„æºçš„è¯·æ±‚ï¼Œä¹Ÿæ˜¯å¯¹èµ„æºçš„ç´¢èµ”æ£€æŸ¥ã€‚ PVå’ŒPVCä¹‹é—´çš„ç›¸äº’ä½œç”¨éµå¾ªè¿™ä¸ªç”Ÿå‘½å‘¨æœŸ:\nProvisioning â€”â€”-\u0026gt; Binding â€”â€”â€“\u0026gt;Usingâ€”â€”\u0026gt;Releasingâ€”â€”\u0026gt;Recycling\nProvisioning è¿™é‡Œæœ‰ä¸¤ç§PVçš„æä¾›æ–¹å¼:é™æ€æˆ–è€…åŠ¨æ€\nStatic\ré›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºå¤šä¸ªPVã€‚ å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ å®ƒä»¬å­˜åœ¨äºKubernetes APIä¸­ï¼Œå¯ç”¨äºæ¶ˆè´¹ã€‚\rDynamic\rå½“ç®¡ç†å‘˜åˆ›å»ºçš„é™æ€PVéƒ½ä¸åŒ¹é…ç”¨æˆ·çš„PersistentVolumeClaimæ—¶ï¼Œé›†ç¾¤å¯èƒ½ä¼šå°è¯•ä¸ºPVCåŠ¨æ€é…ç½®å·ã€‚ æ­¤é…ç½®åŸºäºStorageClassesï¼šPVCå¿…é¡»è¯·æ±‚ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç®¡ç†å‘˜å¿…é¡»å·²åˆ›å»ºå¹¶é…ç½®è¯¥ç±»æ‰èƒ½è¿›è¡ŒåŠ¨æ€é…ç½®ã€‚ è¦æ±‚è¯¥ç±»çš„å£°æ˜æœ‰æ•ˆåœ°ä¸ºè‡ªå·±ç¦ç”¨åŠ¨æ€é…ç½®\rBinding åœ¨åŠ¨æ€é…ç½®çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·åˆ›å»ºæˆ–å·²ç»åˆ›å»ºäº†å…·æœ‰ç‰¹å®šæ•°é‡çš„å­˜å‚¨è¯·æ±‚å’Œç‰¹å®šè®¿é—®æ¨¡å¼çš„PersistentVolumeClaimã€‚ ä¸»æœºä¸­çš„æ§åˆ¶å›è·¯ç›‘è§†æ–°çš„PVCï¼Œæ‰¾åˆ°åŒ¹é…çš„PVï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼Œå¹¶å°†å®ƒä»¬ç»‘å®šåœ¨ä¸€èµ·ã€‚ å¦‚æœä¸ºæ–°çš„PVCåŠ¨æ€é…ç½®PVï¼Œåˆ™å¾ªç¯å°†å§‹ç»ˆå°†è¯¥PVç»‘å®šåˆ°PVCã€‚ å¦åˆ™ï¼Œç”¨æˆ·æ€»æ˜¯è‡³å°‘å¾—åˆ°ä»–ä»¬è¦æ±‚çš„å†…å®¹ï¼Œä½†æ˜¯å·å¯èƒ½è¶…å‡ºäº†è¦æ±‚ã€‚ ä¸€æ—¦ç»‘å®šï¼ŒPersistentVolumeClaimç»‘å®šæ˜¯æ’ä»–çš„ï¼Œä¸ç®¡ç”¨äºç»‘å®šå®ƒä»¬çš„æ¨¡å¼ã€‚\nå¦‚æœåŒ¹é…çš„å·ä¸å­˜åœ¨ï¼ŒPVCå°†ä¿æŒæ— é™æœŸã€‚ éšç€åŒ¹é…å·å˜å¾—å¯ç”¨ï¼ŒPVCå°†è¢«ç»‘å®šã€‚ ä¾‹å¦‚ï¼Œæä¾›è®¸å¤š50Gi PVçš„é›†ç¾¤å°†ä¸åŒ¹é…è¦æ±‚100Giçš„PVCã€‚ å½“é›†ç¾¤ä¸­æ·»åŠ 100Gi PVæ—¶ï¼Œå¯ä»¥ç»‘å®šPVCã€‚\nUsing Podä½¿ç”¨PVCä½œä¸ºå·ã€‚ é›†ç¾¤æ£€æŸ¥å£°æ˜ä»¥æ‰¾åˆ°ç»‘å®šçš„å·å¹¶æŒ‚è½½è¯¥å·çš„å·ã€‚ å¯¹äºæ”¯æŒå¤šç§è®¿é—®æ¨¡å¼çš„å·ï¼Œç”¨æˆ·åœ¨å°†å…¶å£°æ˜ç”¨ä½œpodä¸­çš„å·æ—¶æŒ‡å®šæ‰€éœ€çš„æ¨¡å¼ã€‚\nä¸€æ—¦ç”¨æˆ·æœ‰å£°æ˜å¹¶ä¸”è¯¥å£°æ˜è¢«ç»‘å®šï¼Œç»‘å®šçš„PVå±äºç”¨æˆ·ï¼Œåªè¦ä»–ä»¬éœ€è¦å®ƒã€‚ ç”¨æˆ·é€šè¿‡åœ¨å…¶Podçš„å·å—ä¸­åŒ…å«persistentVolumeClaimæ¥å®‰æ’Podså¹¶è®¿é—®å…¶å£°æ˜çš„PVã€‚\nReleasing å½“ç”¨æˆ·å®Œæˆå·æ—¶ï¼Œä»–ä»¬å¯ä»¥ä»å…è®¸èµ„æºå›æ”¶çš„APIä¸­åˆ é™¤PVCå¯¹è±¡ã€‚ å½“å£°æ˜è¢«åˆ é™¤æ—¶ï¼Œå·è¢«è®¤ä¸ºæ˜¯â€œé‡Šæ”¾çš„â€ï¼Œä½†æ˜¯å®ƒè¿˜ä¸èƒ½ç”¨äºå¦ä¸€ä¸ªå£°æ˜ã€‚ ä»¥å‰çš„ç´¢èµ”äººçš„æ•°æ®ä»ç„¶ä¿ç•™åœ¨å¿…é¡»æ ¹æ®æ”¿ç­–å¤„ç†çš„å·ä¸Š.\nReclaiming PersistentVolumeçš„å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤åœ¨é‡Šæ”¾å…¶å£°æ˜åï¼Œè¯¥å·åº”è¯¥å¦‚ä½•å¤„ç†ã€‚ ç›®å‰ï¼Œå·å¯ä»¥æ˜¯ä¿ç•™ï¼Œå›æ”¶æˆ–åˆ é™¤ã€‚ ä¿ç•™å¯ä»¥æ‰‹åŠ¨å›æ”¶èµ„æºã€‚ å¯¹äºé‚£äº›æ”¯æŒå®ƒçš„å·æ’ä»¶ï¼Œåˆ é™¤å°†ä»Kubernetesä¸­åˆ é™¤PersistentVolumeå¯¹è±¡ï¼Œä»¥åŠåˆ é™¤å¤–éƒ¨åŸºç¡€æ¶æ„ï¼ˆå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–Cinderå·ï¼‰ä¸­å…³è”çš„å­˜å‚¨èµ„äº§ã€‚ åŠ¨æ€é…ç½®çš„å·å§‹ç»ˆè¢«åˆ é™¤\nRecycling å¦‚æœå—é€‚å½“çš„å·æ’ä»¶æ”¯æŒï¼Œå›æ”¶å°†å¯¹å·æ‰§è¡ŒåŸºæœ¬çš„æ“¦é™¤ï¼ˆrm -rf / thevolume / *ï¼‰ï¼Œå¹¶ä½¿å…¶å†æ¬¡å¯ç”¨äºæ–°çš„å£°æ˜ã€‚ ä½†æ˜¯ï¼Œç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨Kubernetesæ§åˆ¶å™¨ç®¡ç†å™¨å‘½ä»¤è¡Œå‚æ•°æ¥é…ç½®è‡ªå®šä¹‰çš„å›æ”¶ç«™podæ¨¡æ¿ï¼Œå¦‚è¿™é‡Œæ‰€è¿°ã€‚ å®šåˆ¶å›æ”¶ç«™æ¨¡æ¿å¿…é¡»åŒ…å«å·è§„èŒƒï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š\napiVersion: v1\rkind: Pod\rmetadata:\rname: pv-recycler-\rnamespace: default\rspec:\rrestartPolicy: Never\rvolumes:\r- name: vol\rhostPath:\rpath: /any/path/it/will/be/replaced\rcontainers:\r- name: pv-recycler\rimage: \u0026quot;gcr.io/google_containers/busybox\u0026quot;\rcommand: [\u0026quot;/bin/sh\u0026quot;, \u0026quot;-c\u0026quot;, \u0026quot;test -e /scrub \u0026amp;\u0026amp; rm -rf /scrub/..?* /scrub/.[!.]* /scrub/* \u0026amp;\u0026amp; test -z \\\u0026quot;$(ls -A /scrub)\\\u0026quot; || exit 1\u0026quot;]\rvolumeMounts:\r- name: vol\rmountPath: /scrub\rTypes of Persistent Volumes PVå½“å‰æ”¯æŒçš„ç±»å‹\nGCEPersistentDisk AWSElasticBlockStore AzureFile AzureDisk FC (Fibre Channel) FlexVolume Flocker NFS iSCSI RBD (Ceph Block Device) CephFS Cinder (OpenStack block storage) Glusterfs VsphereVolume Quobyte Volumes HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster) VMware Photon Portworx Volumes ScaleIO Volumes Persistent Volumes æ¯ä¸ªPVåŒ…å«äº†Specå’ŒStaus, åœ¨PVçš„å®šä¹‰ä¸­æŒ‡å®šè¯¥å†…å®¹\n apiVersion: v1\rkind: PersistentVolume\rmetadata:\rname: pv0003\rspec:\rcapacity:\rstorage: 5Gi\raccessModes:\r- ReadWriteOnce\rpersistentVolumeReclaimPolicy: Recycle\rstorageClassName: slow\rnfs:\rpath: /tmp\rserver: 172.17.0.2\rCapacity é€šå¸¸ï¼ŒPVå°†å…·æœ‰ç‰¹å®šçš„å­˜å‚¨å®¹é‡ã€‚ è¿™æ˜¯ä½¿ç”¨PVçš„å®¹é‡å±æ€§è®¾ç½®çš„ã€‚ çœ‹åˆ°åº“ä¼¯çº³æ–¯èµ„æºæ¨¡å‹ï¼Œä»¥äº†è§£å®¹é‡é¢„æœŸçš„å•ä½ã€‚\nç›®å‰ï¼Œå­˜å‚¨å¤§å°æ˜¯å”¯ä¸€å¯ä»¥è®¾ç½®æˆ–è¯·æ±‚çš„èµ„æºã€‚ æœªæ¥çš„å±æ€§å¯èƒ½åŒ…æ‹¬IOPSï¼Œååé‡ç­‰\nAccess Modes PersistentVolumeå¯ä»¥ä»¥èµ„æºæä¾›è€…æ”¯æŒçš„ä»»ä½•æ–¹å¼å®‰è£…åœ¨ä¸»æœºä¸Šã€‚ å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œæä¾›å•†å°†å…·æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œæ¯ä¸ªPVçš„è®¿é—®æ¨¡å¼éƒ½è¢«è®¾ç½®ä¸ºè¯¥ç‰¹å®šå·æ”¯æŒçš„ç‰¹å®šæ¨¡å¼ã€‚ ä¾‹å¦‚ï¼ŒNFSå¯ä»¥æ”¯æŒå¤šä¸ªè¯»/å†™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯ç‰¹å®šçš„NFS PVå¯èƒ½ä¼šä»¥åªè¯»æ–¹å¼åœ¨æœåŠ¡å™¨ä¸Šå¯¼å‡ºã€‚ æ¯ä¸ªPVéƒ½æœ‰è‡ªå·±çš„ä¸€ç»„è®¿é—®æ¨¡å¼æ¥æè¿°å…·ä½“çš„PVåŠŸèƒ½ã€‚ è®¿é—®æ¨¡å¼: ReadWriteOnce â€“ the volume can be mounted as read-write by a single node (å•nodeçš„è¯»å†™) ReadOnlyMany â€“ the volume can be mounted read-only by many nodes (å¤šnodeçš„åªè¯») ReadWriteMany â€“ the volume can be mounted as read-write by many nodes (å¤šnodeçš„è¯»å†™) Notice:å•ä¸ªPVæŒ‚è½½çš„æ—¶å€™åªæ”¯æŒä¸€ç§è®¿é—®æ¨¡å¼ PVæä¾›æ’ä»¶æ”¯æŒçš„access modeå‚è€ƒkuberneteså®˜æ–¹æ–‡æ¡£\nClass PVå¯ä»¥æœ‰ä¸€ä¸ªç±»ï¼Œé€šè¿‡å°†storageClassNameå±æ€§è®¾ç½®ä¸ºStorageClassçš„åç§°æ¥æŒ‡å®šã€‚ ç‰¹å®šç±»çš„PVåªèƒ½ç»‘å®šåˆ°è¯·æ±‚è¯¥ç±»çš„PVCã€‚ æ²¡æœ‰storageClassNameçš„PVæ²¡æœ‰ç±»ï¼Œåªèƒ½ç»‘å®šåˆ°ä¸éœ€è¦ç‰¹å®šç±»çš„PVCã€‚ åœ¨è¿‡å»ï¼Œä½¿ç”¨äº†æ³¨é‡Švolume.beta.kubernetes.io/storage-classè€Œä¸æ˜¯storageClassNameå±æ€§ã€‚ è¯¥æ³¨é‡Šä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†å°†æ¥Kubernetesç‰ˆæœ¬å°†ä¸å†é€‚ç”¨ã€‚\nReclaim Policy ç›®å‰çš„å›æ”¶æ”¿ç­–æ˜¯ï¼š\nRetain â€“ manual reclamation Recycle â€“ basic scrub (â€œrm -rf /thevolume/*â€) Delete â€“ associated storage asset such as AWS EBS, GCE PD, Azure Disk, or OpenStack Cinder volume is deleted ç›®å‰ï¼Œåªæœ‰NFSå’ŒHostPathæ”¯æŒå›æ”¶ã€‚ AWS EBSï¼ŒGCE PDï¼ŒAzure Diskå’ŒCinderå·æ”¯æŒåˆ é™¤\nPhase å·å°†å¤„äºä»¥ä¸‹é˜¶æ®µä¹‹ä¸€ï¼š\nAvailable â€“ a free resource that is not yet bound to a claim Bound â€“ the volume is bound to a claim Released â€“ the claim has been deleted, but the resource is not yet reclaimed by the cluster Failed â€“ the volume has failed its automatic reclamation Mount Options Kubernetesç®¡ç†å‘˜å¯ä»¥æŒ‡å®šåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸ŠæŒ‚è½½ä¸€ä¸ªæŒä¹…å·æ—¶çš„å…¶ä»–å®‰è£…é€‰é¡¹ã€‚ æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨æŒä¹…å·ä¸Šçš„æ³¨é‡Švolume.beta.kubernetes.io/mount-optionsæ¥æŒ‡å®šå®‰è£…é€‰é¡¹ã€‚\napiVersion: \u0026quot;v1\u0026quot;\rkind: \u0026quot;PersistentVolume\u0026quot;\rmetadata:\rname: gce-disk-1\rannotations:\rvolume.beta.kubernetes.io/mount-options: \u0026quot;discard\u0026quot;\rspec:\rcapacity:\rstorage: \u0026quot;10Gi\u0026quot;\raccessModes:\r- \u0026quot;ReadWriteOnce\u0026quot;\rgcePersistentDisk:\rfsType: \u0026quot;ext4\u0026quot;\rpdName: \u0026quot;gce-disk-1\rå®‰è£…é€‰é¡¹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨å°†å·å®‰è£…åˆ°ç£ç›˜æ—¶å°†è¢«ç´¯ç§¯åœ°è¿æ¥å’Œä½¿ç”¨ã€‚\nè¯·æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰Persistentå·ç±»å‹éƒ½æ”¯æŒå®‰è£…é€‰é¡¹ã€‚ åœ¨Kubernetes 1.6ç‰ˆä¸­ï¼Œä»¥ä¸‹å·ç±»å‹æ”¯æŒå®‰è£…é€‰é¡¹ã€‚\nGCEPersistentDisk AWSElasticBlockStore AzureFile AzureDisk NFS iSCSI RBD (Ceph Block Device) CephFS Cinder (OpenStack block storage) Glusterfs VsphereVolume Quobyte Volumes VMware Photon PersistentVolumeClaims æ¯ä¸ªPVCåŒ…å«specå’Œstatus\nkind: PersistentVolumeClaim\rapiVersion: v1\rmetadata:\rname: myclaim\rspec:\raccessModes:\r- ReadWriteOnce\rresources:\rrequests:\rstorage: 8Gi\rstorageClassName: slow\rselector:\rmatchLabels:\rrelease: \u0026quot;stable\u0026quot;\rmatchExpressions:\r- {key: environment, operator: In, values: [dev]}\rAccess Modes å½“è¯·æ±‚å…·æœ‰ç‰¹å®šè®¿é—®æ¨¡å¼çš„å­˜å‚¨æ—¶ï¼Œå£°æ˜ä½¿ç”¨ä¸å·ç›¸åŒçš„çº¦å®š\nResources å£°æ˜ï¼ˆå¦‚podï¼‰å¯ä»¥è¯·æ±‚ç‰¹å®šæ•°é‡çš„èµ„æºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ±‚ç”¨äºå­˜å‚¨ã€‚ ç›¸åŒçš„èµ„æºæ¨¡å‹é€‚ç”¨äºå·å’Œå£°æ˜\nSelector å£°æ˜å¯ä»¥æŒ‡å®šæ ‡ç­¾é€‰æ‹©å™¨ä»¥è¿›ä¸€æ­¥è¿‡æ»¤è¯¥å·é›†ã€‚ åªæœ‰æ ‡ç­¾ä¸é€‰æ‹©å™¨åŒ¹é…çš„å·æ‰èƒ½ç»‘å®šåˆ°å£°æ˜ã€‚ é€‰æ‹©å™¨å¯ä»¥ç”±ä¸¤ä¸ªå­—æ®µç»„æˆï¼š\nmatchLabels - å·å¿…é¡»å…·æœ‰å¸¦æ­¤å€¼çš„æ ‡ç­¾\rmatchExpressions - é€šè¿‡æŒ‡å®šå…³é”®å­—å’Œå€¼çš„å…³é”®å­—ï¼Œå€¼åˆ—è¡¨å’Œè¿ç®—ç¬¦æ‰€åšçš„è¦æ±‚åˆ—è¡¨ã€‚ æœ‰æ•ˆè¿ç®—ç¬¦åŒ…æ‹¬Inï¼ŒNotInï¼ŒExistså’ŒDoesNotExistã€‚\ræ‰€æœ‰æ¥è‡ªmatchLabelså’ŒmatchExpressionsçš„è¦æ±‚éƒ½ä¸ANDä¸€èµ·ä½¿ç”¨ï¼Œæ‰€æœ‰è¿™äº›è¦æ±‚éƒ½å¿…é¡»æ»¡è¶³æ‰èƒ½åŒ¹é…ã€‚\nClass å£°æ˜å¯ä»¥é€šè¿‡ä½¿ç”¨å±æ€§storageClassNameæŒ‡å®šStorageClassçš„åç§°æ¥è¯·æ±‚ç‰¹å®šçš„ç±»ã€‚åªæœ‰æ‰€è¯·æ±‚çš„ç±»çš„PVï¼Œä¸PVCç›¸åŒçš„storageClassNameçš„PVå¯ä»¥ç»‘å®šåˆ°PVCã€‚\nPVCä¸ä¸€å®šè¦æ±‚ä¸€ä¸ªç­çº§ã€‚å®ƒçš„storageClassNameè®¾ç½®ä¸ºç­‰äºâ€œâ€çš„PVCæ€»æ˜¯è¢«è§£é‡Šä¸ºè¯·æ±‚æ²¡æœ‰ç±»çš„PVï¼Œå› æ­¤å®ƒåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»çš„PVï¼ˆæ²¡æœ‰æ³¨é‡Šæˆ–ä¸€ä¸ªç­‰äºâ€œâ€ï¼‰ã€‚æ²¡æœ‰storageClassNameçš„PVCä¸å®Œå…¨ç›¸åŒï¼Œå¹¶ä¸”æ ¹æ®æ˜¯å¦å¯ç”¨äº†DefaultStorageClasså…¥é—¨æ’ä»¶ï¼Œé›†ç¾¤çš„å¤„ç†æ–¹å¼ä¸åŒã€‚\nå¦‚æœæ¥çº³æ’ä»¶å·²æ‰“å¼€ï¼Œåˆ™ç®¡ç†å‘˜å¯ä»¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚æ²¡æœ‰storageClassNameçš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°è¯¥é»˜è®¤çš„PVã€‚é€šè¿‡å°†StorageClasså¯¹è±¡ä¸­çš„annotation storageclass.kubernetes.io/is-default-classè®¾ç½®ä¸ºâ€œtrueâ€æ¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚å¦‚æœç®¡ç†å‘˜æ²¡æœ‰æŒ‡å®šé»˜è®¤å€¼ï¼Œåˆ™é›†ç¾¤ä¼šå¯¹PVCåˆ›å»ºåšå‡ºå“åº”ï¼Œå°±åƒå…¥é—¨æ’ä»¶è¢«å…³é—­ä¸€æ ·ã€‚å¦‚æœæŒ‡å®šäº†å¤šä¸ªé»˜è®¤å€¼ï¼Œåˆ™éªŒæ”¶æ’ä»¶ç¦æ­¢åˆ›å»ºæ‰€æœ‰PVCã€‚ å¦‚æœå…¥é—¨æ’ä»¶å·²å…³é—­ï¼Œåˆ™ä¸å­˜åœ¨é»˜è®¤StorageClassçš„æ¦‚å¿µã€‚æ²¡æœ‰storageClassNameçš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»çš„PVã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ²¡æœ‰storageClassNameçš„PVCçš„å¤„ç†æ–¹å¼ä¸å°†å…¶storageClassNameè®¾ç½®ä¸ºâ€œâ€çš„PVCç›¸åŒã€‚\næ ¹æ®å®‰è£…æ–¹æ³•ï¼Œå®‰è£…è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡addon manageråœ¨Kubernetesç¾¤é›†ä¸­éƒ¨ç½²é»˜è®¤çš„StorageClassã€‚\nå½“PVCæŒ‡å®šä¸€ä¸ªé€‰æ‹©å™¨ï¼Œé™¤äº†è¯·æ±‚ä¸€ä¸ªStorageClassä¹‹å¤–ï¼Œè¿™äº›è¦æ±‚è¢«ANDç»„åˆåœ¨ä¸€èµ·ï¼šåªæœ‰æ‰€è¯·æ±‚çš„ç±»å’Œæ‰€è¯·æ±‚çš„æ ‡ç­¾çš„PVå¯èƒ½è¢«ç»‘å®šåˆ°PVCã€‚è¯·æ³¨æ„ï¼Œå½“å‰ï¼Œå…·æœ‰éç©ºé€‰æ‹©å™¨çš„PVCä¸èƒ½ä¸ºå…¶åŠ¨æ€é…ç½®PVã€‚\nåœ¨è¿‡å»ï¼Œä½¿ç”¨äº†æ³¨é‡Švolume.beta.kubernetes.io/storage-classï¼Œè€Œä¸æ˜¯storageClassNameå±æ€§ã€‚è¯¥æ³¨é‡Šä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†åœ¨æœªæ¥çš„Kubernetesç‰ˆæœ¬ä¸­å®ƒå°†ä¸è¢«æ”¯æŒã€‚\nå£°æ˜PVCä½œä¸ºVolumes Podsé€šè¿‡å°†å£°æ˜ç”¨ä½œå·æ¥è®¿é—®å­˜å‚¨ã€‚ å£°æ˜å¿…é¡»å­˜åœ¨äºä¸ä½¿ç”¨å£°æ˜çš„podç›¸åŒçš„å‘½åç©ºé—´ä¸­ã€‚ ç¾¤é›†åœ¨podçš„å‘½åç©ºé—´ä¸­æŸ¥æ‰¾å£°æ˜ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥è·å–æ”¯æŒå£°æ˜çš„PersistentVolumeã€‚ ç„¶åå°†ä½“ç§¯å®‰è£…åˆ°ä¸»æœºå¹¶è¿›å…¥Podã€‚\nkind: Pod\rapiVersion: v1\rmetadata:\rname: mypod\rspec:\rcontainers:\r- name: myfrontend\rimage: dockerfile/nginx\rvolumeMounts:\r- mountPath: \u0026quot;/var/www/html\u0026quot;\rname: mypd\rvolumes:\r- name: mypd\rpersistentVolumeClaim:\rclaimName: myclaim\rPersistentVolumesç»‘å®šæ˜¯ç‹¬å çš„ï¼Œå¹¶ä¸”ç”±äºPersistentVolumeClaimsæ˜¯å‘½åç©ºé—´å¯¹è±¡ï¼Œæ‰€ä»¥åªèƒ½åœ¨ä¸€ä¸ªå‘½åç©ºé—´å†…å®‰è£…â€œè®¸å¤šâ€æ¨¡å¼ï¼ˆROXï¼ŒRWXï¼‰â€”PVCæ”¯æŒè¢«å¤šä¸ªpodæŒ‚è½½\nStorageClasses æ¯ä¸ªStorageClassåŒ…å«å­—æ®µprovisioningerå’Œå‚æ•°ï¼Œå½“å±äºç±»çš„PersistentVolumeéœ€è¦åŠ¨æ€é…ç½®æ—¶ä½¿ç”¨ã€‚\nStorageClasså¯¹è±¡çš„åç§°å¾ˆé‡è¦ï¼Œç”¨æˆ·å¯ä»¥å¦‚ä½•è¯·æ±‚ç‰¹å®šçš„ç±»ã€‚ ç®¡ç†å‘˜åœ¨é¦–æ¬¡åˆ›å»ºStorageClasså¯¹è±¡æ—¶è®¾ç½®ç±»çš„åç§°å’Œå…¶ä»–å‚æ•°ï¼Œå¹¶ä¸”åœ¨åˆ›å»ºå¯¹è±¡åæ— æ³•æ›´æ–°å¯¹è±¡ã€‚\nç®¡ç†å‘˜å¯ä»¥ä»…ä¸ºä¸è¦æ±‚ä»»ä½•ç‰¹å®šç±»ç»‘å®šçš„PVCæŒ‡å®šé»˜è®¤çš„StorageClassï¼šæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…PersistentVolumeClaiméƒ¨åˆ†ã€‚\nkind: StorageClass\rapiVersion: storage.k8s.io/v1\rmetadata:\rname: standard\rprovisioner: kubernetes.io/aws-ebs\rparameters:\rtype: gp2\rProvisioner å­˜å‚¨ç±»æœ‰ä¸€ä¸ªä¾›åº”å•†ï¼Œå®ƒç¡®å®šç”¨äºé…ç½®PVçš„å·æ’ä»¶ã€‚ å¿…é¡»æŒ‡å®šæ­¤å­—æ®µã€‚\næ‚¨ä¸é™äºæŒ‡å®šæ­¤å¤„åˆ—å‡ºçš„â€œå†…éƒ¨â€ä¾›åº”å•†ï¼ˆå…¶åç§°å‰ç¼€ä¸ºâ€œkubernetes.ioâ€å¹¶ä¸Kubernetesä¸€èµ·è¿é€ï¼‰ã€‚ æ‚¨è¿˜å¯ä»¥è¿è¡Œå’ŒæŒ‡å®šå¤–éƒ¨æä¾›ç¨‹åºï¼Œå®ƒä»¬æ˜¯éµå¾ªKuberneteså®šä¹‰çš„è§„èŒƒçš„ç‹¬ç«‹ç¨‹åºã€‚ å¤–éƒ¨æä¾›è€…çš„ä½œè€…å¯¹ä»£ç çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾›åº”å•†çš„è¿è¾“çŠ¶å†µï¼Œè¿è¡ŒçŠ¶å†µä»¥åŠä½¿ç”¨çš„å·æ’ä»¶ï¼ˆåŒ…æ‹¬Flexï¼‰ç­‰éƒ½æœ‰å……åˆ†çš„è‡ªä¸»æƒã€‚å­˜å‚¨åº“kubernetes-incubator /å¤–éƒ¨å­˜å‚¨åº“åŒ…å«ä¸€ä¸ªåº“ ç”¨äºç¼–å†™å®æ–½å¤§éƒ¨åˆ†è§„èŒƒçš„å¤–éƒ¨æä¾›è€…ä»¥åŠå„ç§ç¤¾åŒºç»´æŠ¤çš„å¤–éƒ¨æä¾›è€…ã€‚\nParameters å­˜å‚¨ç±»å…·æœ‰æè¿°å±äºå­˜å‚¨ç±»çš„å·çš„å‚æ•°ã€‚ å–å†³äºä¾›åº”å•†ï¼Œå¯ä»¥æ¥å—ä¸åŒçš„å‚æ•°ã€‚ ä¾‹å¦‚ï¼Œå‚æ•°ç±»å‹çš„å€¼io1å’Œå‚æ•°iopsPerGBç‰¹å®šäºEBSã€‚ å½“çœç•¥å‚æ•°æ—¶ï¼Œä½¿ç”¨ä¸€äº›é»˜è®¤å€¼ã€‚\nAWS/GCE/Glusterfs/\nOpenStack Cinder\nkind: StorageClass\rapiVersion: storage.k8s.io/v1\rmetadata:\rname: gold\rprovisioner: kubernetes.io/cinder\rparameters:\rtype: fast\ravailability: nova\rtype: VolumeType created in Cinder. Default is empty. availability: Availability Zone. If not specified, volumes are generally round-robin-ed across all active zones where Kubernetes cluster has a node. å…¶å®ƒç±»å‹çš„storageClassé…ç½®å‚è€ƒ\nhttps://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes\ré…ç½® å¦‚æœæ‚¨æ­£åœ¨ç¼–å†™åœ¨å„ç§ç¾¤é›†ä¸Šè¿è¡Œå¹¶éœ€è¦æŒä¹…å­˜å‚¨çš„é…ç½®æ¨¡æ¿æˆ–ç¤ºä¾‹ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨ä»¥ä¸‹æ¨¡å¼ï¼š\nåœ¨æ‚¨çš„é…ç½®æ–‡ä»¶å¤¹ï¼ˆåŒ…æ‹¬éƒ¨ç½²ï¼ŒConfigMapsç­‰ï¼‰ä¸­åŒ…å«PersistentVolumeClaimå¯¹è±¡ã€‚ åœ¨é…ç½®ä¸­ä¸è¦åŒ…å«PersistentVolumeå¯¹è±¡ï¼Œå› ä¸ºå®ä¾‹åŒ–é…ç½®çš„ç”¨æˆ·å¯èƒ½æ²¡æœ‰åˆ›å»ºPersistentVolumesçš„æƒé™ã€‚ ç»™ç”¨æˆ·æä¾›å®ä¾‹åŒ–æ¨¡æ¿æ—¶æä¾›å­˜å‚¨ç±»åç§°çš„é€‰é¡¹ã€‚ ï¼‘ï¼ã€€å¦‚æœç”¨æˆ·æä¾›å­˜å‚¨ç±»åç§°ï¼Œå¹¶ä¸”é›†ç¾¤æ˜¯1.4æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œè¯·å°†è¯¥å€¼æ”¾å…¥PVCçš„volume.beta.kubernetes.io/storage-classæ³¨é‡Šä¸­ã€‚å¦‚æœé›†ç¾¤çš„ç®¡ç†å‘˜å¯ç”¨äº†StorageClassesï¼Œè¿™å°†å¯¼è‡´PVCä¸æ­£ç¡®çš„å­˜å‚¨ç±»åŒ¹é…ã€‚ ï¼’ï¼ã€€å¦‚æœç”¨æˆ·ä¸æä¾›å­˜å‚¨ç±»åç§°æˆ–è€…é›†ç¾¤æ˜¯ç‰ˆæœ¬1.3ï¼Œé‚£ä¹ˆåœ¨PVCä¸Šæ”¾ç½®ä¸€ä¸ªvolume.alpha.kubernetes.io/storage-classï¼šdefaultæ³¨é‡Šã€‚ è¿™å°†å¯¼è‡´åœ¨æŸäº›ç¾¤é›†ä¸Šä¸ºç”¨æˆ·è‡ªåŠ¨é…ç½®PVï¼Œå¹¶å…·æœ‰åˆç†çš„é»˜è®¤ç‰¹æ€§ã€‚ å°½ç®¡åœ¨åç§°ä¸­ä½¿ç”¨äº†alphaï¼Œä½†è¿™ä¸ªæ³¨é‡ŠèƒŒåçš„ä»£ç å…·æœ‰betaçº§åˆ«çš„æ”¯æŒã€‚ ï¼“ï¼ã€€ä¸è¦ä½¿ç”¨volume.beta.kubernetes.io/storage-classï¼šåŒ…å«ç©ºå­—ç¬¦ä¸²çš„ä»»ä½•å€¼ï¼Œå› ä¸ºå®ƒå°†é˜»æ­¢DefaultStorageClassæ¥çº³æ§åˆ¶å™¨è¿è¡Œï¼ˆå¦‚æœå¯ç”¨ï¼‰ã€‚\nåœ¨æ‚¨çš„å·¥å…·ä¸­ï¼Œè¯·æ³¨æ„åœ¨ä¸€æ®µæ—¶é—´åæœªç»‘å®šçš„PVCï¼Œå¹¶å°†å…¶è¡¨ç¤ºç»™ç”¨æˆ·ï¼Œå› ä¸ºè¿™å¯èƒ½è¡¨æ˜é›†ç¾¤æ²¡æœ‰åŠ¨æ€å­˜å‚¨æ”¯æŒï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·åº”åˆ›å»ºåŒ¹é…çš„PVï¼‰æˆ–é›†ç¾¤æ²¡æœ‰å­˜å‚¨ç³»ç»Ÿï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ— æ³•éƒ¨ç½²éœ€è¦PVCçš„é…ç½®ï¼‰ã€‚\nåœ¨å°†æ¥ï¼Œæˆ‘ä»¬é¢„è®¡å¤§å¤šæ•°é›†ç¾¤éƒ½å°†å¯ç”¨DefaultStorageClassï¼Œå¹¶æä¾›æŸç§å½¢å¼çš„å­˜å‚¨ã€‚ä½†æ˜¯ï¼Œå¯èƒ½æ²¡æœ‰ä»»ä½•å­˜å‚¨ç±»åå¯ç”¨äºæ‰€æœ‰é›†ç¾¤ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹ç»§ç»­ä¸è®¾ç½®ã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œalphaæ³¨é‡Šå°†ä¸å†æœ‰æ„ä¹‰ï¼Œä½†PVCä¸Šçš„æœªè®¾ç½®çš„storageClasså­—æ®µå°†å…·æœ‰æ‰€éœ€çš„æ•ˆæœã€‚\nè¯‘è€…ï¼šé˜¿ä»†æ¥è€¶ http://blog.csdn.net/jettery/article/details/72722324\r\nå‚è€ƒé“¾æ¥\nhttps://www.kubernetes.org.cn/\rhttp://docs.kubernetes.org.cn/\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.8-k8s%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/1.2.8.1pv-pvc-storageclass/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.8.1 PV/PVC/StorageClass"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.8.2 Services åè¯è§£é‡Š Services\r Overviewï¼ˆæ¦‚è¿°ï¼‰ Kubernetes Podæ˜¯å¹³å‡¡çš„ï¼Œå®ƒé—¨ä¼šè¢«åˆ›å»ºï¼Œä¹Ÿä¼šæ­»æ‰ï¼ˆç”Ÿè€ç—…æ­»ï¼‰ï¼Œå¹¶ä¸”ä»–ä»¬æ˜¯ä¸å¯å¤æ´»çš„ã€‚ ReplicationControllersåŠ¨æ€çš„åˆ›å»ºå’Œé”€æ¯Pods(æ¯”å¦‚è§„æ¨¡æ‰©å¤§æˆ–è€…ç¼©å°ï¼Œæˆ–è€…æ‰§è¡ŒåŠ¨æ€æ›´æ–°)ã€‚æ¯ä¸ªpodéƒ½ç”±è‡ªå·±çš„ipï¼Œè¿™äº›IPä¹Ÿéšç€æ—¶é—´çš„å˜åŒ–ä¹Ÿä¸èƒ½æŒç»­ä¾èµ–ã€‚è¿™æ ·å°±å¼•å‘äº†ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœä¸€äº›Podsï¼ˆè®©æˆ‘ä»¬å«å®ƒä½œåå°ï¼Œåç«¯ï¼‰æä¾›äº†ä¸€äº›åŠŸèƒ½ä¾›å…¶å®ƒçš„Podä½¿ç”¨ï¼ˆè®©æˆ‘ä»¬å«ä½œå‰å°ï¼‰ï¼Œåœ¨kuberneteé›†ç¾¤ä¸­æ˜¯å¦‚ä½•å®ç°è®©è¿™äº›å‰å°èƒ½å¤ŸæŒç»­çš„è¿½è¸ªåˆ°è¿™äº›åå°çš„ï¼Ÿ\nç­”æ¡ˆæ˜¯ï¼šService\nKubernete Service æ˜¯ä¸€ä¸ªå®šä¹‰äº†ä¸€ç»„Pod\rçš„ç­–ç•¥çš„æŠ½è±¡ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰æ—¶å€™å«åšå®è§‚æœåŠ¡ã€‚è¿™äº›è¢«æœåŠ¡æ ‡è®°çš„Podéƒ½æ˜¯ï¼ˆä¸€èˆ¬ï¼‰é€šè¿‡label Selectorå†³å®šçš„ï¼ˆä¸‹é¢æˆ‘ä»¬ä¼šè®²åˆ°æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªæ²¡æœ‰label selectorçš„æœåŠ¡ï¼‰\nä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å‡è®¾åå°æ˜¯ä¸€ä¸ªå›¾å½¢å¤„ç†çš„åå°ï¼Œå¹¶ä¸”ç”±3ä¸ªå‰¯æœ¬ã€‚è¿™äº›å‰¯æœ¬æ˜¯å¯ä»¥ç›¸äº’æ›¿ä»£çš„ï¼Œå¹¶ä¸”å‰å°å¹¶éœ€è¦å…³å¿ƒä½¿ç”¨çš„å“ªä¸€ä¸ªåå°Podï¼Œå½“è¿™ä¸ªæ‰¿è½½å‰å°è¯·æ±‚çš„podå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‰å°å¹¶ä¸éœ€è¦ç›´åˆ°è¿™äº›å˜åŒ–ï¼Œæˆ–è€…è¿½è¸ªåå°çš„è¿™äº›å‰¯æœ¬ï¼ŒæœåŠ¡æ˜¯è¿™äº›å»è€¦\nå¯¹äºKuberneteåŸç”Ÿçš„åº”ç”¨ï¼ŒKuberneteæä¾›äº†ä¸€ä¸ªç®€å•çš„Endpoints APIï¼Œè¿™ä¸ªEndpoints apiçš„ä½œç”¨å°±æ˜¯å½“ä¸€ä¸ªæœåŠ¡ä¸­çš„podå‘ç”Ÿå˜åŒ–æ—¶ï¼ŒEndpoints APIéšä¹‹å˜åŒ–ï¼Œå¯¹äºå“ªäº›ä¸æ˜¯åŸç”Ÿçš„ç¨‹åºï¼ŒKubernetesæä¾›äº†ä¸€ä¸ªåŸºäºè™šæ‹ŸIPçš„ç½‘æ¡¥çš„æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡ä¼šå°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„åå°pod\nDefining a service(å®šä¹‰ä¸€ä¸ªæœåŠ¡) ä¸€ä¸ªKuberneteæœåŠ¡æ˜¯ä¸€ä¸ªæœ€å°çš„å¯¹è±¡ï¼Œç±»ä¼¼pod,å’Œå…¶å®ƒçš„ç»ˆç«¯å¯¹è±¡ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æœpaiserverå‘é€è¯·æ±‚æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œæ¯”å¦‚ï¼Œå‡è®¾ä½ æ‹¥æœ‰ä¸€äº›Pod,æ¯ä¸ªpodéƒ½å¼€æ”¾äº†9376ç«¯å£ï¼Œå¹¶ä¸”å‡å¸¦æœ‰ä¸€ä¸ªæ ‡ç­¾app=MyApp\n{ \u0026#34;â€œkindâ€\u0026#34;: \u0026#34;â€œServiceâ€\u0026#34;, \u0026#34;â€œapiVersionâ€\u0026#34;: \u0026#34;â€œv1â€\u0026#34;, \u0026#34;â€œmetadataâ€\u0026#34;: { \u0026#34;â€œnameâ€\u0026#34;: \u0026#34;â€œmy-serviceâ€\u0026#34; }, \u0026#34;â€œspecâ€\u0026#34;: { \u0026#34;â€œselectorâ€\u0026#34;: { \u0026#34;â€œappâ€\u0026#34;: \u0026#34;â€œMyAppâ€\u0026#34; }, \u0026#34;â€œportsâ€\u0026#34;: [ { \u0026#34;â€œprotocolâ€\u0026#34;: \u0026#34;â€œTCPâ€\u0026#34;, \u0026#34;â€œportâ€\u0026#34;: 80, \u0026#34;â€œtargetPortâ€\u0026#34;: 9376 } ] } } è¿™æ®µä»£ç ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡å¯¹è±¡ï¼Œåç§°ä¸ºï¼šmy-serviceï¼Œå¹¶ä¸”ä¼šè¿æ¥ç›®æ ‡ç«¯å£9376ï¼Œå¹¶ä¸”å¸¦æœ‰label app=MyAppçš„pod,è¿™ä¸ªæœåŠ¡ä¼šè¢«åˆ†é…ä¸€ä¸ªipåœ°å€ï¼Œè¿™ä¸ªipæ˜¯ç»™æœåŠ¡ä»£ç†ä½¿ç”¨çš„ï¼ˆä¸‹é¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼‰ï¼ŒæœåŠ¡çš„é€‰æ‹©å™¨ä¼šæŒç»­çš„è¯„ä¼°ï¼Œå¹¶ä¸”ç»“æœä¼šè¢«å‘é€åˆ°ä¸€ä¸ªEndpoints å¯¹è±¡ï¼Œè¿™ä¸ªEndpointsçš„å¯¹è±¡çš„åå­—ä¹Ÿå«â€œmy-serviceâ€.\næœåŠ¡å¯ä»¥å°†ä¸€ä¸ªâ€œå…¥ç«¯å£â€è½¬å‘åˆ°ä»»ä½•â€œç›®æ ‡ç«¯å£â€ï¼Œé»˜è®¤æƒ…å†µä¸‹targetPortçš„å€¼ä¼šå’Œportçš„å€¼ç›¸åŒï¼Œæ›´æœ‰è¶£çš„æ˜¯ï¼ŒtargetPortå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œå¯ä»¥æŒ‡å®šåˆ°ä¸€ä¸ªname,è¿™ä¸ªnameæ˜¯podçš„ä¸€ä¸ªç«¯å£ã€‚å¹¶ä¸”å®é™…æŒ‡æ´¾ç»™è¿™ä¸ªnameçš„ç«¯å£å¯ä»¥æ˜¯ä¸åŒåœ¨ä¸åŒçš„åå°podä¸­ï¼Œè¿™æ ·è®©æˆ‘ä»¬èƒ½æ›´åŠ çµæ´»çš„éƒ¨ç½²æˆ‘ä»¬çš„æœåŠ¡ï¼Œæ¯”å¦‚ï¼›æˆ‘ä»¬å¯ä»¥åœ¨ä¸‹ä¸€ä¸ªæ›´æ–°ç‰ˆæœ¬ä¸­ä¿®æ”¹åå°podæš´éœ²çš„ç«¯å£è€Œä¸ä¼šå½±å“å®¢æˆ·çš„ä½¿ç”¨ï¼ˆæ›´æ–°è¿‡ç¨‹ä¸ä¼šæ‰“æ–­ï¼‰\n æœåŠ¡æ”¯æŒtcpå’ŒUDPï¼Œä½†æ˜¯é»˜è®¤çš„æ˜¯TCP Services without selectorsï¼ˆæ²¡æœ‰é€‰æ‹©å™¨çš„æœåŠ¡ï¼‰  æœåŠ¡æ€»ä½“ä¸ŠæŠ½è±¡äº†å¯¹Podçš„è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡ä¹ŸæŠ½è±¡äº†å…¶å®ƒçš„å†…å®¹ï¼Œæ¯”å¦‚ï¼š\n1ï¼šæ¯”å¦‚ä½ å¸Œæœ›æœ‰ä¸€ä¸ªé¢å¤–çš„æ•°æ®åº“äº‘åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½†æ˜¯åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨è‡ªå·±çš„æ•°æ®åº“\n2ï¼šæˆ‘ä»¬å¸Œæœ›å°†æœåŠ¡æŒ‡å‘å…¶å®ƒçš„æœåŠ¡æˆ–è€…å…¶å®ƒå‘½åç©ºé—´æˆ–è€…å…¶å®ƒçš„äº‘å¹³å°ä¸Šçš„æœåŠ¡\n3ï¼šæˆ‘ä»¬æ­£åœ¨å‘kuberneteè¿ç§»ï¼Œå¹¶ä¸”æˆ‘ä»¬åå°å¹¶æ²¡æœ‰åœ¨Kuberneteä¸­\nå¦‚ä¸Šçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæœåŠ¡æ²¡æœ‰é€‰æ‹©å™¨\n{ \u0026#34;â€œkindâ€\u0026#34;: \u0026#34;â€œServiceâ€\u0026#34;, \u0026#34;â€œapiVersionâ€\u0026#34;: \u0026#34;â€œv1â€³\u0026#34;, \u0026#34;â€œmetadataâ€\u0026#34;: { \u0026#34;â€œnameâ€\u0026#34;: \u0026#34;â€œmy-serviceâ€\u0026#34; }, \u0026#34;â€œspecâ€\u0026#34;: { \u0026#34;â€œportsâ€\u0026#34;: [ { \u0026#34;â€œprotocolâ€\u0026#34;: \u0026#34;â€œTCPâ€\u0026#34;, \u0026#34;â€œportâ€\u0026#34;: 80, \u0026#34;â€œtargetPortâ€\u0026#34;: 9376 } ] } } å› ä¸ºæ²¡æœ‰é€‰æ‹©å™¨ï¼Œæ‰€ä»¥ç›¸åº”çš„Endpointså¯¹è±¡å°±ä¸ä¼šè¢«åˆ›å»ºï¼Œä½†æ˜¯æˆ‘ä»¬æ‰‹åŠ¨æŠŠæˆ‘ä»¬çš„æœåŠ¡å’ŒEndpointså¯¹åº”èµ·æ¥\n{ \u0026#34;â€œkindâ€\u0026#34;: \u0026#34;â€œEndpointsâ€\u0026#34;, \u0026#34;â€œapiVersionâ€\u0026#34;: \u0026#34;â€œv1â€³\u0026#34;, \u0026#34;â€œmetadataâ€\u0026#34;: { \u0026#34;â€œnameâ€\u0026#34;: \u0026#34;â€œmy-serviceâ€\u0026#34; }, \u0026#34;â€œsubsetsâ€\u0026#34;: [ { \u0026#34;â€œaddressesâ€\u0026#34;: [ { \u0026#34;â€œIPâ€\u0026#34;: \u0026#34;â€œ1.2.3.4â€\u0026#34; } ], \u0026#34;â€œportsâ€\u0026#34;: [ { \u0026#34;â€œportâ€\u0026#34;: 80 } ] } ] } è¿™æ ·çš„è¯ï¼Œè¿™ä¸ªæœåŠ¡è™½ç„¶æ²¡æœ‰selectorï¼Œä½†æ˜¯å´å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°1.2.3.4:80\nVirtual IPs and service proxiesï¼ˆè™šæ‹ŸIPå’ŒæœåŠ¡ä»£ç†ï¼‰ æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œäº†ä¸€ä¸ªkube-proxyï¼Œè¿™ä¸ªåº”ç”¨ç›‘æ§ç€Kubermasterå¢åŠ å’Œåˆ é™¤æœåŠ¡ï¼Œå¯¹äºæ¯ä¸€ä¸ªæœåŠ¡ï¼Œkube-proxyä¼šéšæœºå¼€å¯ä¸€ä¸ªæœ¬æœºç«¯å£ï¼Œä»»ä½•å‘å‘è¿™ä¸ªç«¯å£çš„è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°ä¸€ä¸ªåå°çš„Podå½“ä¸­ï¼Œè€Œå¦‚ä½•é€‰æ‹©æ˜¯å“ªä¸€ä¸ªåå°çš„podçš„æ˜¯åŸºäºSessionAffinityè¿›è¡Œçš„åˆ†é…ã€‚kube-proxyä¼šå¢åŠ iptables rulesæ¥å®ç°æ•æ‰è¿™ä¸ªæœåŠ¡çš„Ipå’Œç«¯å£æ¥å¹¶é‡å®šå‘åˆ°å‰é¢æåˆ°çš„ç«¯å£ã€‚\næœ€ç»ˆçš„ç»“æœå°±æ˜¯æ‰€æœ‰çš„å¯¹äºè¿™ä¸ªæœåŠ¡çš„è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°åå°çš„Podä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”¨æˆ·æ ¹æœ¬å¯Ÿè§‰ä¸åˆ°\né»˜è®¤çš„ï¼Œåå°çš„é€‰æ‹©æ˜¯éšæœºçš„ï¼ŒåŸºäºç”¨æˆ·sessionæœºåˆ¶çš„ç­–ç•¥å¯ä»¥é€šè¿‡ä¿®æ”¹service.spec.sessionAffinity çš„å€¼ä»NONEåˆ°ClientIP\nMulti-Port Servicesï¼ˆå¤šç«¯å£æœåŠ¡ï¼‰ å¯èƒ½å¾ˆå¤šæœåŠ¡éœ€è¦å¼€å‘ä¸æ­¢ä¸€ä¸ªç«¯å£,ä¸ºäº†æ»¡è¶³è¿™æ ·çš„æƒ…å†µï¼ŒKuberneteså…è®¸åœ¨å®šä¹‰æ—¶å€™æŒ‡å®šå¤šä¸ªç«¯å£ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨å¤šä¸ªç«¯å£çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šæ‰€æœ‰ç«¯å£çš„åç§°ï¼Œè¿™æ ·endpointsæ‰èƒ½æ¸…æ¥šï¼Œä¾‹å¦‚\n{ \u0026#34;â€œkindâ€\u0026#34;: \u0026#34;â€œServiceâ€\u0026#34;, \u0026#34;â€œapiVersionâ€\u0026#34;: \u0026#34;â€œv1â€\u0026#34;, \u0026#34;â€œmetadataâ€\u0026#34;: { \u0026#34;â€œnameâ€\u0026#34;: \u0026#34;â€œmy-serviceâ€\u0026#34; }, \u0026#34;â€œspecâ€\u0026#34;: { \u0026#34;â€œselectorâ€\u0026#34;: { \u0026#34;â€œappâ€\u0026#34;: \u0026#34;â€œMyAppâ€\u0026#34; }, \u0026#34;â€œportsâ€\u0026#34;: [ { \u0026#34;â€œnameâ€\u0026#34;: \u0026#34;â€œhttpâ€\u0026#34;, \u0026#34;â€œprotocolâ€\u0026#34;: \u0026#34;â€œTCPâ€\u0026#34;, \u0026#34;â€œportâ€\u0026#34;: 80, \u0026#34;â€œtargetPortâ€\u0026#34;: 9376 }, { \u0026#34;â€œnameâ€\u0026#34;: \u0026#34;â€œhttpsâ€\u0026#34;, \u0026#34;â€œprotocolâ€\u0026#34;: \u0026#34;â€œTCPâ€\u0026#34;, \u0026#34;â€œportâ€\u0026#34;: 443, \u0026#34;â€œtargetPortâ€\u0026#34;: 9377 } ] } } é€‰æ‹©è‡ªå·±çš„IPåœ°å€ æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºæœåŠ¡çš„æ—¶å€™æŒ‡å®šIPåœ°å€ï¼Œå°†spec.clusterIPçš„å€¼è®¾å®šä¸ºæˆ‘ä»¬æƒ³è¦çš„IPåœ°å€å³å¯ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªDNSåŸŸæˆ‘ä»¬å¸Œæœ›ç”¨æ¥æ›¿æ¢ï¼Œæˆ–è€…é—ç•™ç³»ç»Ÿåªèƒ½å¯¹æŒ‡å®šIPæä¾›æœåŠ¡ï¼Œå¹¶ä¸”è¿™äº›éƒ½éå¸¸éš¾ä¿®æ”¹ï¼Œç”¨æˆ·é€‰æ‹©çš„IPåœ°å€å¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„IPåœ°å€ï¼Œå¹¶ä¸”è¦åœ¨API serveråˆ†é…çš„IPèŒƒå›´å†…ï¼Œå¦‚æœè¿™ä¸ªIPåœ°å€æ˜¯ä¸å¯ç”¨çš„ï¼Œapiserverä¼šè¿”å›422httpé”™è¯¯ä»£ç æ¥å‘ŠçŸ¥æ˜¯IPåœ°å€ä¸å¯ç”¨\nä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¾ªç¯çš„DNS ä¸€ä¸ªé—®é¢˜æŒç»­çš„è¢«æå‡ºæ¥ï¼Œè¿™ä¸ªé—®é¢˜å°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ ‡å‡†çš„å¾ªç¯DNSè€Œä½¿ç”¨è™šæ‹ŸIPï¼Œæˆ‘ä»¬ä¸»è¦æœ‰å¦‚ä¸‹å‡ ä¸ªåŸå› \n1ï¼šDNSä¸éµå¾ªTTLæŸ¥è¯¢å’Œç¼“å­˜nameæŸ¥è¯¢çš„é—®é¢˜ç”±æ¥å·²ä¹…ï¼ˆè¿™ä¸ªè¿˜çœŸä¸çŸ¥é“ï¼Œå°±æ˜¯DNSæ›´æ–°çš„é—®é¢˜ä¼°è®¡ï¼‰\n2ï¼šè®¸å¤šçš„åº”ç”¨çš„DNSæŸ¥è¯¢æŸ¥è¯¢ä¸€æ¬¡åå°±ç¼“å­˜èµ·æ¥\n3ï¼šå³ä½¿å¦‚ä¸Šäº®ç‚¹è¢«è§£å†³äº†ï¼Œä½†æ˜¯ä¸åœçš„è¿›è¡ŒDNSè¿›è¡ŒæŸ¥è¯¢ï¼Œå¤§é‡çš„è¯·æ±‚ä¹Ÿæ˜¯å¾ˆéš¾è¢«ç®¡ç†çš„\næˆ‘ä»¬å¸Œæœ›é˜»æ­¢ç”¨æˆ·ä½¿ç”¨è¿™äº›å¯èƒ½ä¼šâ€œä¼¤å®³â€ä»–ä»¬çš„äº‹æƒ…ï¼Œä½†æ˜¯å¦‚æœè¶³å¤Ÿå¤šçš„äººè¦æ±‚è¿™ä¹ˆä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å¯¹æ­¤æä¾›æ”¯æŒï¼Œæ¥ä½œä¸ºä¸€ä¸ªå¯é€‰é¡¹.\nDiscovering servicesï¼ˆæœåŠ¡çš„å‘ç°ï¼‰ Kubernetes æ”¯æŒä¸¤ç§æ–¹å¼çš„æ¥å‘ç°æœåŠ¡ ï¼Œç¯å¢ƒå˜é‡å’Œ DNS\nç¯å¢ƒå˜é‡ å½“ä¸€ä¸ªPodåœ¨ä¸€ä¸ªnodeä¸Šè¿è¡Œæ—¶ï¼Œkubelet ä¼šé’ˆå¯¹è¿è¡Œçš„æœåŠ¡å¢åŠ ä¸€ç³»åˆ—çš„ç¯å¢ƒå˜é‡ï¼Œå®ƒæ”¯æŒDocker links compatible å’Œæ™®é€šç¯å¢ƒå˜é‡\nä¸¾ä¾‹å­æ¥è¯´ï¼š\nredis-masteræœåŠ¡æš´éœ²äº† TCP 6379ç«¯å£ï¼Œå¹¶ä¸”è¢«åˆ†é…äº†10.0.0.11 IPåœ°å€\né‚£ä¹ˆæˆ‘ä»¬å°±ä¼šæœ‰å¦‚ä¸‹çš„ç¯å¢ƒå˜é‡\n REDIS_MASTER_SERVICE_HOST=10.0.0.11\nREDIS_MASTER_SERVICE_PORT=6379\nREDIS_MASTER_PORT=tcp://10.0.0.11:6379\nREDIS_MASTER_PORT_6379_TCP=tcp://10.0.0.11:6379\nREDIS_MASTER_PORT_6379_TCP_PROTO=tcp\nREDIS_MASTER_PORT_6379_TCP_PORT=6379\nREDIS_MASTER_PORT_6379_TCP_ADDR=10.0.0.11\n è¿™æ ·çš„è¯ï¼Œå¯¹ç³»ç»Ÿæœ‰ä¸€ä¸ªè¦æ±‚ï¼šæ‰€æœ‰çš„æƒ³è¦è¢«PODè®¿é—®çš„æœåŠ¡ï¼Œå¿…é¡»åœ¨PODåˆ›å»ºä¹‹å‰åˆ›å»ºï¼Œå¦åˆ™è¿™ä¸ªç¯å¢ƒå˜é‡ä¸ä¼šè¢«å¡«å……ï¼Œä½¿ç”¨DNSåˆ™æ²¡æœ‰è¿™ä¸ªé—®é¢˜\nDNS ä¸€ä¸ªå¯é€‰æ‹©çš„äº‘å¹³å°æ’ä»¶å°±æ˜¯DNSï¼ŒDNS æœåŠ¡å™¨ç›‘æ§ç€API SERVER ï¼Œå½“æœ‰æœåŠ¡è¢«åˆ›å»ºçš„æ—¶å€™ï¼ŒDNS æœåŠ¡å™¨ä¼šä¸ºä¹‹åˆ›å»ºç›¸åº”çš„è®°å½•ï¼Œå¦‚æœDNSè¿™ä¸ªæœåŠ¡è¢«æ·»åŠ äº†ï¼Œé‚£ä¹ˆPodåº”è¯¥æ˜¯å¯ä»¥è‡ªåŠ¨è§£ææœåŠ¡çš„ã€‚\nä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼šå¦‚æœæˆ‘ä»¬åœ¨my-nså‘½åç©ºé—´ä¸‹æœ‰ä¸€ä¸ªæœåŠ¡å«åšâ€œmy-serviceâ€ï¼Œè¿™ä¸ªæ—¶å€™DNSå°±ä¼šåˆ›å»ºä¸€ä¸ªmy-service.my-nsçš„è®°å½•ï¼Œæ‰€æœ‰my-nså‘½åç©ºé—´ä¸‹çš„Pod,éƒ½å¯ä»¥é€šè¿‡åŸŸåmy-serviceæŸ¥è¯¢æ‰¾åˆ°å¯¹åº”çš„ipåœ°å€ï¼Œä¸åŒå‘½åç©ºé—´ä¸‹çš„Podåœ¨æŸ¥æ‰¾æ˜¯å¿…é¡»ä½¿ç”¨my-sesrvice.my-nsæ‰å¯ä»¥ã€‚\nKubernete åŒæ ·æ”¯æŒç«¯å£çš„è§£æï¼Œå¦‚æœmy-serviceæœ‰ä¸€ä¸ªæä¾›httpçš„TCPä¸»æŒçš„ç«¯å£ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥è¯¢â€œ_http._tcp.my-service.my-nsâ€æ¥æŸ¥è¯¢è¿™ä¸ªç«¯å£\nHeadless services æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¸éœ€è¦ä¸€ä¸ªå›ºå®šçš„IPå’Œåˆ†å‘ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬åªéœ€è¦å°†spec.clusterIPçš„å€¼è®¾ç½®ä¸ºnoneå°±å¯ä»¥äº†\nå¯¹äºè¿™æ ·çš„æœåŠ¡æ¥è¯´ï¼Œé›†ç¾¤IPæ²¡æœ‰åˆ†é…ï¼Œè¿™ä¸ªæ—¶å€™å½“ä½ æŸ¥è¯¢æœåŠ¡çš„åç§°çš„æ—¶å€™ï¼ŒDNSä¼šè¿”å›å¤šä¸ªAè®°å½•ï¼Œè¿™äº›è®°å½•éƒ½æ˜¯æŒ‡å‘åç«¯Podçš„ã€‚Kube ä»£ç†ä¸ä¼šå¤„ç†è¿™ä¸ªæœåŠ¡ï¼Œåœ¨æœåŠ¡çš„å‰ç«¯ä¹Ÿæ²¡æœ‰è´Ÿè½½å‡è¡¡å™¨ã€‚ä½†æ˜¯endpoints controllerè¿˜æ˜¯ä¼šåˆ›å»ºEndpoints\nï¼ˆå¥½å§ï¼Œè¿™ä¸ªå¥½å¤„è²Œä¼¼æˆ‘è¿˜ç†è§£å¥½ï¼‰\nThis option allows developers to reduce coupling to the Kubernetes system, if they desire, but leaves them freedom to do discovery in their own way. Applications can still use a self-registration pattern and adapters for other discovery systems could easily be built upon this API.\nExternal servicesï¼ˆå¤–éƒ¨æœåŠ¡ï¼‰ å¯¹äºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰ä¸€éƒ¨åˆ†æ˜¯æ”¾åœ¨Kuberneteå¤–éƒ¨çš„ï¼ˆæ¯”å¦‚æˆ‘ä»¬æœ‰å•ç‹¬çš„ç‰©ç†æœºæ¥æ‰¿æ‹…æ•°æ®åº“çš„è§’è‰²ï¼‰ï¼ŒKubernetesæ”¯æŒä¸¤ç§æ–¹å¼ï¼šNodePortsï¼ŒLoadBalancers\næ¯ä¸€ä¸ªæœåŠ¡éƒ½ä¼šæœ‰ä¸€ä¸ªå­—æ®µå®šä¹‰äº†è¯¥æœåŠ¡å¦‚ä½•è¢«è°ƒç”¨ï¼ˆå‘ç°ï¼‰ï¼Œè¿™ä¸ªå­—æ®µçš„å€¼å¯ä»¥ä¸ºï¼š\n ClusterIP:ä½¿ç”¨ä¸€ä¸ªé›†ç¾¤å›ºå®šIPï¼Œè¿™ä¸ªæ˜¯é»˜è®¤é€‰é¡¹ NodePortï¼šä½¿ç”¨ä¸€ä¸ªé›†ç¾¤å›ºå®šIPï¼Œä½†æ˜¯é¢å¤–åœ¨æ¯ä¸ªPODä¸Šå‡æš´éœ²è¿™ä¸ªæœåŠ¡ï¼Œç«¯å£ LoadBalancerï¼šä½¿ç”¨é›†ç¾¤å›ºå®šIPï¼Œå’ŒNODEPord,é¢å¤–è¿˜ä¼šç”³è¯·ç”³è¯·ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨æ¥è½¬å‘åˆ°æœåŠ¡ï¼ˆload balancer ï¼‰  æ³¨æ„ï¼šNodePort æ”¯æŒTCPå’ŒUDNï¼Œä½†æ˜¯LoadBalancersåœ¨1.0ç‰ˆæœ¬åªæ”¯æŒTCP\nType NodePort å¦‚æœä½ é€‰æ‹©äº†â€œNodePortâ€ï¼Œé‚£ä¹ˆ Kubernetes master ä¼šåˆ†é…ä¸€ä¸ªåŒºåŸŸèŒƒå›´å†…ï¼Œï¼ˆé»˜è®¤æ˜¯30000-32767ï¼‰ï¼Œå¹¶ä¸”ï¼Œæ¯ä¸€ä¸ªnodeï¼Œéƒ½ä¼šä»£ç†ï¼ˆproxyï¼‰è¿™ä¸ªç«¯å£åˆ°ä½ çš„æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨spec.ports[*].nodePort æ‰¾åˆ°å…·ä½“çš„å€¼\nå¦‚æœæˆ‘ä»¬å‘æŒ‡å®šä¸€ä¸ªç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å†™åœ¨nodePortä¸Šï¼Œç³»ç»Ÿå°±ä¼šç»™ä½ æŒ‡æ´¾æŒ‡å®šç«¯å£ï¼Œä½†æ˜¯è¿™ä¸ªå€¼å¿…é¡»æ˜¯æŒ‡å®šèŒƒå›´å†…çš„ã€‚\nè¿™æ ·çš„è¯å°±èƒ½å¤Ÿè®©å¼€å‘è€…æ­é…è‡ªå·±çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå»æ’˜å»ºä¸€ä¸ªkuberneteä¸æ˜¯å®Œå…¨æ”¯æŒçš„ç³»ç»Ÿï¼Œåˆæˆ–è€…æ˜¯ç›´æ¥æš´éœ²ä¸€ä¸ªnodeçš„ipåœ°å€\nType LoadBalancer åœ¨æ”¯æŒé¢å¤–çš„è´Ÿè½½å‡è¡¡å™¨çš„çš„å¹³å°ä¸Šï¼Œå°†å€¼è®¾ç½®ä¸ºLoadBalancerä¼šæä¾›ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ç»™ä½ çš„æœåŠ¡ï¼Œè´Ÿè½½å‡è¡¡å™¨çš„åˆ›å»ºå…¶å®æ˜¯å¼‚æ­¥çš„ã€‚ä¸‹é¢çš„ä¾‹å­\n{ \u0026#34;â€œkindâ€\u0026#34;: \u0026#34;â€œServiceâ€\u0026#34;, \u0026#34;â€œapiVersionâ€\u0026#34;: \u0026#34;â€œv1â€³\u0026#34;, \u0026#34;â€œmetadataâ€\u0026#34;: { \u0026#34;â€œnameâ€\u0026#34;: \u0026#34;â€œmy-serviceâ€\u0026#34; }, \u0026#34;â€œspecâ€\u0026#34;: { \u0026#34;â€œselectorâ€\u0026#34;: { \u0026#34;â€œappâ€\u0026#34;: \u0026#34;â€œMyAppâ€\u0026#34; }, \u0026#34;â€œportsâ€\u0026#34;: [ { \u0026#34;â€œprotocolâ€\u0026#34;: \u0026#34;â€œTCPâ€\u0026#34;, \u0026#34;â€œportâ€\u0026#34;: 80, \u0026#34;â€œtargetPortâ€\u0026#34;: 9376, \u0026#34;â€œnodePortâ€\u0026#34;: 30061 } ], \u0026#34;â€œclusterIPâ€\u0026#34;: \u0026#34;â€œ10.0.171.239â€\u0026#34;, \u0026#34;â€œtypeâ€\u0026#34;: \u0026#34;â€œLoadBalancerâ€\u0026#34; }, \u0026#34;â€œstatusâ€\u0026#34;: { \u0026#34;â€œloadBalancerâ€\u0026#34;: { \u0026#34;â€œingressâ€\u0026#34;: [ { \u0026#34;â€œipâ€\u0026#34;: \u0026#34;â€œ146.148.47.155â€\u0026#34; } ] } } } æ‰€æœ‰æœåŠ¡çš„è¯·æ±‚å‡ä¼šç›´æ¥åˆ°åˆ°Pod,å…·ä½“æ˜¯å¦‚ä½•å·¥ä½œçš„æ˜¯ç”±å¹³å°å†³å®šçš„\nç¼ºç‚¹\næˆ‘ä»¬å¸Œæœ›ä½¿ç”¨IPTABLESå’Œç”¨æˆ·å‘½åç©ºé—´æ¥ä»£ç†è™šæ‹ŸIPèƒ½åœ¨ä¸­å°å‹è§„æ¨¡çš„å¹³å°ä¸Šæ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯å¯èƒ½å‡ºç°é—®é¢˜åœ¨æ¯”è¾ƒå¤§çš„å¹³å°ä¸Šå½“åº”å¯¹æˆåƒä¸Šä¸‡çš„æœåŠ¡çš„æ—¶å€™ã€‚\nè¿™ä¸ªæ—¶å€™ï¼Œä½¿ç”¨kube-proxyæ¥å°è£…æœåŠ¡çš„è¯·æ±‚ï¼Œè¿™ä½¿å¾—è¿™äº›å˜æˆå¯èƒ½\nLoadBalancers åªæ”¯æŒTCPï¼Œä¸æ”¯æŒUDP\nType çš„å€¼æ˜¯è®¾å®šå¥½çš„ï¼Œä¸åŒçš„å€¼ä»£è¡¨ä¸åŒçš„åŠŸèƒ½ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å¹³å°éƒ½éœ€è¦çš„ï¼Œä½†æ˜¯æ˜¯æ‰€æœ‰APIéœ€è¦çš„\nFuture work åœ¨å°†æ¥ï¼Œæˆ‘ä»¬é¢„æƒ³proxyçš„ç­–ç•¥èƒ½å¤Ÿæ›´åŠ ç»†è‡´ï¼Œä¸å†æ˜¯å•çº¯çš„è½¬å‘ï¼Œæ¯”å¦‚master-elected or shardedï¼Œæˆ‘ä»¬é¢„æƒ³å°†æ¥æœåŠ¡ä¼šæ‹¥æœ‰çœŸæ­£çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œåˆ°æ—¶å€™è™šæ‹ŸIPç›´æ¥è½¬å‘åˆ°è´Ÿè½½å‡è¡¡å™¨\nå°†æ¥æœ‰å€¾å‘ä¸å°†æ‰€çš„å·¥ä½œå‡é€šè¿‡iptablesæ¥è¿›è¡Œï¼Œä»è€Œå°ä»ç”¨æˆ·å‘½åç©ºé—´ä»£ç†ï¼Œè¿™æ ·çš„è¯ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½å’Œæ¶ˆé™¤ä¸€äº›åŸåœ°å€¼IPçš„é—®é¢˜ï¼Œå°½ç®¡è¿™æ ·çš„ä¼šå‡å°‘ä¸€äº›çµæ´»æ€§.\nå‚è€ƒé“¾æ¥\nhttps://www.kubernetes.org.cn/\rhttp://docs.kubernetes.org.cn/\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.8-k8s%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/1.2.8.2services/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.8.2 Services"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.9.1 ingresså®ç°ç°åº¦ Nginx-ingress æ¶æ„å’ŒåŸç† è¿…é€Ÿå›é¡¾ä¸€ä¸‹ Nginx-ingress çš„æ¶æ„å’Œå®ç°åŸç†ï¼š\nNginx-ingress é€šè¿‡å‰ç½®çš„ Loadbalancer ç±»å‹çš„ Service æ¥æ”¶é›†ç¾¤æµé‡ï¼Œå°†æµé‡è½¬å‘è‡³ Nginx-ingress Pod å†…å¹¶å¯¹é…ç½®çš„ç­–ç•¥è¿›è¡Œæ£€æŸ¥ï¼Œå†è½¬å‘è‡³ç›®æ ‡ Serviceï¼Œæœ€ç»ˆå°†æµé‡è½¬å‘è‡³ä¸šåŠ¡å®¹å™¨ã€‚\nä¼ ç»Ÿçš„ Nginx éœ€è¦æˆ‘ä»¬é…ç½® conf æ–‡ä»¶ç­–ç•¥ã€‚ä½† Nginx-ingress é€šè¿‡å®ç° Nginx-ingress-Controller å°†åŸç”Ÿ conf é…ç½®æ–‡ä»¶å’Œ yaml é…ç½®æ–‡ä»¶è¿›è¡Œäº†è½¬åŒ–ï¼Œå½“æˆ‘ä»¬é…ç½® yaml æ–‡ä»¶çš„ç­–ç•¥åï¼ŒNginx-ingress-Controller å°†å¯¹å…¶è¿›è¡Œè½¬åŒ–ï¼Œå¹¶ä¸”åŠ¨æ€æ›´æ–°ç­–ç•¥ï¼ŒåŠ¨æ€ Reload Nginx Podï¼Œå®ç°è‡ªåŠ¨ç®¡ç†ã€‚\né‚£ä¹ˆ Nginx-ingress-Controller å¦‚ä½•èƒ½å¤ŸåŠ¨æ€æ„ŸçŸ¥é›†ç¾¤çš„ç­–ç•¥å˜åŒ–å‘¢ï¼Ÿæ–¹æ³•æœ‰å¾ˆå¤šç§ï¼Œå¯ä»¥é€šè¿‡ webhook admission æ‹¦æˆªå™¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ ServiceAccount ä¸ Kubernetes Api è¿›è¡Œäº¤äº’ï¼ŒåŠ¨æ€è·å–ã€‚Nginx-ingress-Controller ä½¿ç”¨åè€…æ¥å®ç°ã€‚æ‰€ä»¥åœ¨éƒ¨ç½² Nginx-ingress æˆ‘ä»¬ä¼šå‘ç° Deployment å†…æŒ‡å®šäº† Pod çš„ ServiceAccountï¼Œä»¥åŠå®ç°äº† RoleBinding ï¼Œæœ€ç»ˆè¾¾åˆ° Pod ä¸ Kubernetes Api äº¤äº’çš„ç›®æ ‡ã€‚\ndev apiVersion: v1 kind: Namespace metadata: name: dev --- apiVersion: apps/v1 kind: Deployment metadata: name: nginx namespace: dev spec: selector: matchLabels: app: nginx replicas: 1 template: metadata: labels: app: nginx spec: containers: - name: nginx image: wangweicoding-docker.pkg.coding.net/nginx-ingress-gray/docker/nginx ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: nginx namespace: dev spec: ports: - name: tcp-80-80 port: 80 protocol: TCP targetPort: 80 selector: app: nginx sessionAffinity: None type: NodePort --- apiVersion: extensions/v1beta1 kind: Ingress metadata: annotations: kubernetes.io/ingress.class: nginx  # nginx=nginx-ingress| qcloud=CLB ingress ## kubernetes.io/ingress.subnetId: subnet-xxxxxxxx # if qcloud, should give subnet name: my-ingress namespace: dev spec: rules: - host: nginx-ingress.coding.dev http: paths: - backend: serviceName: nginx servicePort: 80 path: / Prd apiVersion: v1 kind: Namespace metadata: name: pro --- apiVersion: apps/v1 kind: Deployment metadata: name: nginx namespace: pro spec: selector: matchLabels: app: nginx replicas: 1 template: metadata: labels: app: nginx spec: containers: - name: nginx image: wangweicoding-docker.pkg.coding.net/nginx-ingress-gray/docker/nginx ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: nginx namespace: pro spec: ports: - name: tcp-80-80 port: 80 protocol: TCP targetPort: 80 selector: app: nginx sessionAffinity: None type: NodePort --- apiVersion: extensions/v1beta1 kind: Ingress metadata: annotations: kubernetes.io/ingress.class: nginx  # nginx=nginx-ingress| qcloud=CLB ingress ## kubernetes.io/ingress.subnetId: subnet-xxxxxxxx # if qcloud, should give subnet name: my-ingress namespace: pro spec: rules: - host: nginx-ingress.coding.pro http: paths: - backend: serviceName: nginx servicePort: 80 path: / Canary apiVersion: v1 kind: Namespace metadata: name: pro --- apiVersion: apps/v1 kind: Deployment metadata: name: nginx-canary namespace: pro spec: selector: matchLabels: app: nginx-canary replicas: 1 template: metadata: labels: app: nginx-canary spec: containers: - name: nginx image: wangweicoding-docker.pkg.coding.net/nginx-ingress-gray/docker/nginx ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: nginx-canary namespace: pro spec: ports: - name: tcp-80-80 port: 80 protocol: TCP targetPort: 80 selector: app: nginx-canary sessionAffinity: None type: NodePort --- apiVersion: extensions/v1beta1 kind: Ingress metadata: annotations: kubernetes.io/ingress.class: nginx  # nginx=nginx-ingress| qcloud=CLB ingress ## kubernetes.io/ingress.subnetId: subnet-xxxxxxxx # if qcloud, should give subnet nginx.ingress.kubernetes.io/canary: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/canary-by-header: \u0026#34;location\u0026#34; nginx.ingress.kubernetes.io/canary-by-header-value: \u0026#34;shenzhen\u0026#34; #nginx.ingress.kubernetes.io/canary-weight: 100 name: my-ingress namespace: pro spec: rules: - host: nginx-ingress.coding.pro http: paths: - backend: serviceName: nginx-canary servicePort: 80 path: / ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.9-k8s%E5%AE%9E%E7%8E%B0%E7%81%B0%E5%BA%A6/1.2.9.1ingress%E5%AE%9E%E7%8E%B0%E7%81%B0%E5%BA%A6/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.9.1 ingresså®ç°ç°åº¦"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.9.2 å¤šPodå®ç°ç°åº¦ å¦‚æœæ‚¨æƒ³ä½¿ç”¨ Deployment å°†æœ€æ–°çš„åº”ç”¨ç¨‹åºç‰ˆæœ¬å‘å¸ƒç»™ä¸€éƒ¨åˆ†ç”¨æˆ·ï¼ˆæˆ–æœåŠ¡å™¨ï¼‰ï¼Œæ‚¨å¯ä»¥ä¸ºæ¯ä¸ªç‰ˆæœ¬åˆ›å»ºä¸€ä¸ª Deploymentï¼Œæ­¤æ—¶ï¼Œåº”ç”¨ç¨‹åºçš„æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬éƒ½å¯ä»¥åŒæ—¶è·å¾—ç”Ÿäº§ä¸Šçš„æµé‡ã€‚\nå®æ–½æ–¹æ¡ˆ   éƒ¨ç½²ç¬¬ä¸€ä¸ªç‰ˆæœ¬\nç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ Deployment åŒ…å«äº† 3 ä¸ªPodå‰¯æœ¬ï¼ŒService é€šè¿‡ label selector app: nginx é€‰æ‹©å¯¹åº”çš„ Podï¼Œnginx çš„æ ‡ç­¾ä¸º 1.7.9\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.7.9 --- apiVersion: v1 kind: Service metadata: name: nginx-service labels: app: nginx spec: selector: app: nginx ports: - name: nginx-port protocol: TCP port: 80 nodePort: 32600 targetPort: 80 type: NodePort   å‡è®¾æ­¤æ—¶æƒ³è¦å‘å¸ƒæ–°çš„ç‰ˆæœ¬ nginx 1.8.0ï¼Œå¯ä»¥åˆ›å»ºç¬¬äºŒä¸ª Deploymentï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment-canary labels: app: nginx track: canary spec: replicas: 1 selector: matchLabels: app: nginx track: canary template: metadata: labels: app: nginx track: canary spec: containers: - name: nginx image: nginx:1.8.0  å› ä¸º Service çš„LabelSelector æ˜¯ app: nginxï¼Œç”± nginx-deployment å’Œ nginx-deployment-canary åˆ›å»ºçš„ Pod éƒ½å¸¦æœ‰æ ‡ç­¾ app: nginxï¼Œæ‰€ä»¥ï¼ŒService çš„æµé‡å°†ä¼šåœ¨ä¸¤ä¸ª release ä¹‹é—´åˆ†é… åœ¨æ–°æ—§ç‰ˆæœ¬ä¹‹é—´ï¼Œæµé‡åˆ†é…çš„æ¯”ä¾‹ä¸ºä¸¤ä¸ªç‰ˆæœ¬å‰¯æœ¬æ•°çš„æ¯”ä¾‹ï¼Œæ­¤å¤„ä¸º 1:3 å½“æ‚¨ç¡®å®šæ–°çš„ç‰ˆæœ¬æ²¡æœ‰é—®é¢˜ä¹‹åï¼Œå¯ä»¥å°† nginx-deployment çš„é•œåƒæ ‡ç­¾ä¿®æ”¹ä¸ºæ–°ç‰ˆæœ¬çš„é•œåƒæ ‡ç­¾ï¼Œå¹¶åœ¨å®Œæˆå¯¹ nginx-deployment çš„æ»šåŠ¨æ›´æ–°ä¹‹åï¼Œåˆ é™¤ nginx-deployment-canary è¿™ä¸ª Deployment    å±€é™æ€§ æŒ‰ç…§ Kubernetes é»˜è®¤æ”¯æŒçš„è¿™ç§æ–¹å¼è¿›è¡Œé‡‘ä¸é›€å‘å¸ƒï¼Œæœ‰ä¸€å®šçš„å±€é™æ€§ï¼š\n ä¸èƒ½æ ¹æ®ç”¨æˆ·æ³¨å†Œæ—¶é—´ã€åœ°åŒºç­‰è¯·æ±‚ä¸­çš„å†…å®¹å±æ€§è¿›è¡Œæµé‡åˆ†é… åŒä¸€ä¸ªç”¨æˆ·å¦‚æœå¤šæ¬¡è°ƒç”¨è¯¥ Serviceï¼Œæœ‰å¯èƒ½ç¬¬ä¸€æ¬¡è¯·æ±‚åˆ°äº†æ—§ç‰ˆæœ¬çš„ Podï¼Œç¬¬äºŒæ¬¡è¯·æ±‚åˆ°äº†æ–°ç‰ˆæœ¬çš„ Pod  TIP åœ¨ Kubernetes ä¸­ä¸èƒ½è§£å†³ä¸Šè¿°å±€é™æ€§çš„åŸå› æ˜¯ï¼šKubernetes Service åªåœ¨ TCP å±‚é¢è§£å†³è´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼Œå¹¶ä¸å¯¹è¯·æ±‚å“åº”çš„æ¶ˆæ¯å†…å®¹åšä»»ä½•è§£æå’Œè¯†åˆ«ã€‚å¦‚æœæƒ³è¦æ›´å®Œå–„åœ°å®ç°é‡‘ä¸é›€å‘å¸ƒï¼Œå¯ä»¥è€ƒè™‘å¦‚ä¸‹ä¸‰ç§é€‰æ‹©ï¼š\n ä¸šåŠ¡ä»£ç ç¼–ç å®ç° Spring Cloud ç°åº¦å‘å¸ƒ Istio ç°åº¦å‘å¸ƒ  ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/1.%E5%9F%BA%E7%A1%80/1.2-k8s%E5%9F%BA%E7%A1%80/1.2.9-k8s%E5%AE%9E%E7%8E%B0%E7%81%B0%E5%BA%A6/1.2.9.2%E5%A4%9Apod%E5%AE%9E%E7%8E%B0%E7%81%B0%E5%BA%A6/","series":["k8s"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"1.2.9.2 å¤šPodå®ç°ç°åº¦"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"class Solution { public int lengthOfLIS(int[] nums) { if (nums == null || nums.length == 0){return 0;} int[] dp = new int[nums.length]; Arrays.fill(dp,1); for (int i = 0; i \u0026lt; nums.length; i++) { for (int j = 0; j \u0026lt; i; j++) { if(nums[i] \u0026gt; nums[j] \u0026amp;\u0026amp; dp[j] + 1 \u0026gt; dp[i]){ dp[i] = dp[j] + 1; } } } return Arrays.stream(dp).max().getAsInt(); } } 300. æœ€é•¿é€’å¢å­åºåˆ—\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/leetcode/300.-%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97/","series":["Manual"],"tags":["LeetCode"],"title":"300. æœ€é•¿é€’å¢å­åºåˆ—"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"éœ€è¦è®¾ç½® proxy_set_header Host $host:$server_port;\nlocation ^~/gateway/ { proxy_set_header Host $host:$server_port; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-NginX-Proxy true; proxy_pass http://k8s_yshop-gateway-svc/; } ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/nginx/400-bad-request/","series":["Manual"],"tags":["nginx"],"title":"400 Bad Request"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"1. å‰è¨€ W. Richard Stevensåœ¨ ã€ŠUnix Network Programming Volume 1 3rd Edition - The Sockets Networking APIã€‹æ–‡ä¸­çš„6.2 I/O Modelså°èŠ‚ä¸­å¯¹å¦‚ä¸‹5ä¸­IOæ¨¡å‹è¿›è¡Œäº†è¯¦ç»†çš„é˜è¿°ï¼š\n blocking I/O nonblocking I/O I/O multiplexing (select and poll) signal driven I/O (SIGIO) asynchronous I/O (the POSIX aio_functions)  ç”±signal driven IOåœ¨å®é™…ä¸­å¹¶ä¸å¸¸ç”¨ï¼Œæ‰€ä»¥ä¸»è¦ä»‹ç»å…¶ä½™å››ç§IO Modelã€‚\nå†è¯´ä¸€ä¸‹IOå‘ç”Ÿæ—¶æ¶‰åŠçš„å¯¹è±¡å’Œæ­¥éª¤ã€‚å¯¹äºä¸€ä¸ªnetwork IO (è¿™é‡Œæˆ‘ä»¬ä»¥readä¸¾ä¾‹)ï¼Œå®ƒä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªç³»ç»Ÿå¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯è°ƒç”¨è¿™ä¸ªIOçš„process (or thread)ï¼Œå¦ä¸€ä¸ªå°±æ˜¯ç³»ç»Ÿå†…æ ¸(kernel)ã€‚å½“ä¸€ä¸ªreadæ“ä½œå‘ç”Ÿæ—¶ï¼Œå®ƒä¼šç»å†ä¸¤ä¸ªé˜¶æ®µï¼š\n ç­‰å¾…æ•°æ®å‡†å¤‡ (Waiting for the data to be ready)ï¼ˆå°†æ•°æ®ä»ç½‘å¡è¯»åˆ°å†…æ ¸ï¼‰ å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°è¿›ç¨‹ä¸­(Copying the data from the kernel to the process)  è®°ä½è¿™ä¸¤ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™äº›IOæ¨¡å‹çš„åŒºåˆ«å°±æ˜¯åœ¨ä¸¤ä¸ªé˜¶æ®µä¸Šå„æœ‰ä¸åŒçš„æƒ…å†µã€‚\n2. æ¦‚å¿µè¯´æ˜ åœ¨è¿›è¡Œè§£é‡Šä¹‹å‰ï¼Œé¦–å…ˆè¦è¯´æ˜å‡ ä¸ªæ¦‚å¿µï¼š\n ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ è¿›ç¨‹åˆ‡æ¢ è¿›ç¨‹çš„é˜»å¡ æ–‡ä»¶æè¿°ç¬¦ ç¼“å­˜ I/O  2.1 ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ ç°åœ¨æ“ä½œç³»ç»Ÿéƒ½æ˜¯é‡‡ç”¨è™šæ‹Ÿå­˜å‚¨å™¨ï¼Œé‚£ä¹ˆå¯¹32ä½æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå®ƒçš„å¯»å€ç©ºé—´ï¼ˆè™šæ‹Ÿå­˜å‚¨ç©ºé—´ï¼‰ä¸º4Gï¼ˆ2çš„32æ¬¡æ–¹ï¼‰ã€‚æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯å†…æ ¸ï¼Œç‹¬ç«‹äºæ™®é€šçš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿæœ‰è®¿é—®åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†ä¿è¯ç”¨æˆ·è¿›ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸ï¼ˆkernelï¼‰ï¼Œä¿è¯å†…æ ¸çš„å®‰å…¨ï¼Œæ“å¿ƒç³»ç»Ÿå°†è™šæ‹Ÿç©ºé—´åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºå†…æ ¸ç©ºé—´ï¼Œä¸€éƒ¨åˆ†ä¸ºç”¨æˆ·ç©ºé—´ã€‚é’ˆå¯¹linuxæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå°†æœ€é«˜çš„1Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0xC0000000åˆ°0xFFFFFFFFï¼‰ï¼Œä¾›å†…æ ¸ä½¿ç”¨ï¼Œç§°ä¸ºå†…æ ¸ç©ºé—´ï¼Œè€Œå°†è¾ƒä½çš„3Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0x00000000åˆ°0xBFFFFFFFï¼‰ï¼Œä¾›å„ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºç”¨æˆ·ç©ºé—´ã€‚\n2.2 è¿›ç¨‹åˆ‡æ¢ ä¸ºäº†æ§åˆ¶è¿›ç¨‹çš„æ‰§è¡Œï¼Œå†…æ ¸å¿…é¡»æœ‰èƒ½åŠ›æŒ‚èµ·æ­£åœ¨CPUä¸Šè¿è¡Œçš„è¿›ç¨‹ï¼Œå¹¶æ¢å¤ä»¥å‰æŒ‚èµ·çš„æŸä¸ªè¿›ç¨‹çš„æ‰§è¡Œã€‚è¿™ç§è¡Œä¸ºè¢«ç§°ä¸ºè¿›ç¨‹åˆ‡æ¢ã€‚å› æ­¤å¯ä»¥è¯´ï¼Œä»»ä½•è¿›ç¨‹éƒ½æ˜¯åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸çš„æ”¯æŒä¸‹è¿è¡Œçš„ï¼Œæ˜¯ä¸å†…æ ¸ç´§å¯†ç›¸å…³çš„ã€‚ ä»ä¸€ä¸ªè¿›ç¨‹çš„è¿è¡Œè½¬åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ä¸Šè¿è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ç»è¿‡ä¸‹é¢è¿™äº›å˜åŒ–ï¼š\n  ä¿å­˜å¤„ç†æœºä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨å’Œå…¶ä»–å¯„å­˜å™¨ã€‚\n  æ›´æ–°PCBä¿¡æ¯ã€‚\n  æŠŠè¿›ç¨‹çš„PCBç§»å…¥ç›¸åº”çš„é˜Ÿåˆ—ï¼Œå¦‚å°±ç»ªã€åœ¨æŸäº‹ä»¶é˜»å¡ç­‰é˜Ÿåˆ—ã€‚\n  é€‰æ‹©å¦ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œï¼Œå¹¶æ›´æ–°å…¶PCBã€‚\n  æ›´æ–°å†…å­˜ç®¡ç†çš„æ•°æ®ç»“æ„ã€‚\n  æ¢å¤å¤„ç†æœºä¸Šä¸‹æ–‡ã€‚\næ³¨ï¼šæ€»è€Œè¨€ä¹‹å°±æ˜¯å¾ˆè€—èµ„æº\n  2.3 è¿›ç¨‹çš„é˜»å¡ æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹ï¼Œç”±äºæœŸå¾…çš„æŸäº›äº‹ä»¶æœªå‘ç”Ÿï¼Œå¦‚è¯·æ±‚ç³»ç»Ÿèµ„æºå¤±è´¥ã€ç­‰å¾…æŸç§æ“ä½œçš„å®Œæˆã€æ–°æ•°æ®å°šæœªåˆ°è¾¾æˆ–æ— æ–°å·¥ä½œåšç­‰ï¼Œåˆ™ç”±ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œé˜»å¡åŸè¯­(Block)ï¼Œä½¿è‡ªå·±ç”±è¿è¡ŒçŠ¶æ€å˜ä¸ºé˜»å¡çŠ¶æ€ã€‚å¯è§ï¼Œè¿›ç¨‹çš„é˜»å¡æ˜¯è¿›ç¨‹è‡ªèº«çš„ä¸€ç§ä¸»åŠ¨è¡Œä¸ºï¼Œä¹Ÿå› æ­¤åªæœ‰å¤„äºè¿è¡Œæ€çš„è¿›ç¨‹ï¼ˆè·å¾—CPUï¼‰ï¼Œæ‰å¯èƒ½å°†å…¶è½¬ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“è¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæ˜¯ä¸å ç”¨CPUèµ„æºçš„ã€‚\n2.4 æ–‡ä»¶æè¿°ç¬¦fd æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile descriptorï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­çš„ä¸€ä¸ªæœ¯è¯­ï¼Œæ˜¯ä¸€ä¸ªç”¨äºè¡¨è¿°æŒ‡å‘æ–‡ä»¶çš„å¼•ç”¨çš„æŠ½è±¡åŒ–æ¦‚å¿µã€‚ æ–‡ä»¶æè¿°ç¬¦åœ¨å½¢å¼ä¸Šæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚å®é™…ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼ŒæŒ‡å‘å†…æ ¸ä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹æ‰€ç»´æŠ¤çš„è¯¥è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„è®°å½•è¡¨ã€‚å½“ç¨‹åºæ‰“å¼€ä¸€ä¸ªç°æœ‰æ–‡ä»¶æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œå†…æ ¸å‘è¿›ç¨‹è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚åœ¨ç¨‹åºè®¾è®¡ä¸­ï¼Œä¸€äº›æ¶‰åŠåº•å±‚çš„ç¨‹åºç¼–å†™å¾€å¾€ä¼šå›´ç»•ç€æ–‡ä»¶æè¿°ç¬¦å±•å¼€ã€‚ä½†æ˜¯æ–‡ä»¶æè¿°ç¬¦è¿™ä¸€æ¦‚å¿µå¾€å¾€åªé€‚ç”¨äºUNIXã€Linuxè¿™æ ·çš„æ“ä½œç³»ç»Ÿã€‚\n2.5 ç¼“å­˜ I/O ç¼“å­˜ I/O åˆè¢«ç§°ä½œæ ‡å‡† I/Oï¼Œå¤§å¤šæ•°æ–‡ä»¶ç³»ç»Ÿçš„é»˜è®¤ I/O æ“ä½œéƒ½æ˜¯ç¼“å­˜ I/Oã€‚åœ¨ Linux çš„ç¼“å­˜ I/O æœºåˆ¶ä¸­ï¼Œæ“ä½œç³»ç»Ÿä¼šå°† I/O çš„æ•°æ®ç¼“å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿçš„é¡µç¼“å­˜ï¼ˆ page cache ï¼‰ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ•°æ®ä¼šå…ˆè¢«æ‹·è´åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºä¸­ï¼Œç„¶åæ‰ä¼šä»æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºæ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´ã€‚\n ç¼“å­˜ I/O çš„ç¼ºç‚¹ï¼š æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éœ€è¦åœ¨åº”ç”¨ç¨‹åºåœ°å€ç©ºé—´å’Œå†…æ ¸è¿›è¡Œå¤šæ¬¡æ•°æ®æ‹·è´æ“ä½œï¼Œè¿™äº›æ•°æ®æ‹·è´æ“ä½œæ‰€å¸¦æ¥çš„ CPU ä»¥åŠå†…å­˜å¼€é”€æ˜¯\n 3. IOæ¨¡å‹ 3.1 blocking IO åœ¨linuxä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰çš„socketéƒ½æ˜¯blockingï¼Œä¸€ä¸ªå…¸å‹çš„è¯»æ“ä½œæµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·ï¼š\nå½“ç”¨æˆ·è¿›ç¨‹è°ƒç”¨äº†recvfromè¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œkernelå°±å¼€å§‹äº†IOçš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼šå‡†å¤‡æ•°æ®ï¼ˆå¯¹äºç½‘ç»œIOæ¥è¯´ï¼Œå¾ˆå¤šæ—¶å€™æ•°æ®åœ¨ä¸€å¼€å§‹è¿˜æ²¡æœ‰åˆ°è¾¾ã€‚æ¯”å¦‚ï¼Œè¿˜æ²¡æœ‰æ”¶åˆ°ä¸€ä¸ªå®Œæ•´çš„UDPåŒ…ã€‚è¿™ä¸ªæ—¶å€™kernelå°±è¦ç­‰å¾…è¶³å¤Ÿçš„æ•°æ®åˆ°æ¥ï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦ç­‰å¾…ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®è¢«æ‹·è´åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºä¸­æ˜¯éœ€è¦ä¸€ä¸ªè¿‡ç¨‹çš„ã€‚è€Œåœ¨ç”¨æˆ·è¿›ç¨‹è¿™è¾¹ï¼Œæ•´ä¸ªè¿›ç¨‹ä¼šè¢«é˜»å¡ï¼ˆå½“ç„¶ï¼Œæ˜¯è¿›ç¨‹è‡ªå·±é€‰æ‹©çš„é˜»å¡)ã€‚å½“kernelä¸€ç›´ç­‰åˆ°æ•°æ®å‡†å¤‡å¥½äº†ï¼Œå®ƒå°±ä¼šå°†æ•°æ®ä»kernelä¸­æ‹·è´åˆ°ç”¨æˆ·å†…å­˜ï¼Œç„¶åkernelè¿”å›ç»“æœï¼Œç”¨æˆ·è¿›ç¨‹æ‰è§£é™¤blockçš„çŠ¶æ€ï¼Œé‡æ–°è¿è¡Œèµ·æ¥ã€‚\n æ‰€ä»¥ï¼Œblocking IOçš„ç‰¹ç‚¹å°±æ˜¯åœ¨IOæ‰§è¡Œçš„ä¸¤ä¸ªé˜¶æ®µéƒ½è¢«blockäº†ã€‚\n 3.2 nonblocking IO linuxä¸‹ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®socketä½¿å…¶å˜ä¸ºnon-blockingã€‚å½“å¯¹ä¸€ä¸ªnon-blocking socketæ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œæµç¨‹æ˜¯è¿™ä¸ªæ ·å­ï¼š\nå½“ç”¨æˆ·è¿›ç¨‹å‘å‡ºreadæ“ä½œæ—¶ï¼Œå¦‚æœkernelä¸­çš„æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œé‚£ä¹ˆå®ƒå¹¶ä¸ä¼šblockç”¨æˆ·è¿›ç¨‹ï¼Œè€Œæ˜¯ç«‹åˆ»è¿”å›ä¸€ä¸ªEWOULDBLOCKçš„errorã€‚ä»ç”¨æˆ·è¿›ç¨‹è§’åº¦è®² ï¼Œå®ƒå‘èµ·ä¸€ä¸ªreadæ“ä½œåï¼Œå¹¶ä¸éœ€è¦ç­‰å¾…ï¼Œè€Œæ˜¯é©¬ä¸Šå°±å¾—åˆ°äº†ä¸€ä¸ªç»“æœã€‚ç”¨æˆ·è¿›ç¨‹åˆ¤æ–­ç»“æœæ˜¯ä¸€ä¸ªerroræ—¶ï¼Œå®ƒå°±çŸ¥é“æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œäºæ˜¯å®ƒå¯ä»¥å†æ¬¡å‘é€readæ“ä½œã€‚ä¸€æ—¦kernelä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œå¹¶ä¸”åˆå†æ¬¡æ”¶åˆ°äº†ç”¨æˆ·è¿›ç¨‹çš„system callï¼Œé‚£ä¹ˆå®ƒé©¬ä¸Šå°±å°†æ•°æ®æ‹·è´åˆ°äº†ç”¨æˆ·å†…å­˜ï¼Œç„¶åè¿”å›ã€‚\n æ‰€ä»¥ï¼Œnonblocking IOçš„ç‰¹ç‚¹æ˜¯ç”¨æˆ·è¿›ç¨‹éœ€è¦ä¸æ–­çš„ä¸»åŠ¨è¯¢é—®kernelæ•°æ®å¥½äº†æ²¡æœ‰ã€‚\n 3.3 IO multiplexing IO multiplexingå°±æ˜¯æˆ‘ä»¬è¯´çš„selectï¼Œpollï¼Œepollï¼Œæœ‰äº›åœ°æ–¹ä¹Ÿç§°è¿™ç§IOæ–¹å¼ä¸ºevent driven IOã€‚select/epollçš„å¥½å¤„å°±åœ¨äºå•ä¸ªprocesså°±å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªç½‘ç»œè¿æ¥çš„IOã€‚å®ƒçš„åŸºæœ¬åŸç†å°±æ˜¯selectï¼Œpollï¼Œepollè¿™ä¸ªfunctionä¼šä¸æ–­çš„è½®è¯¢æ‰€è´Ÿè´£çš„æ‰€æœ‰socketï¼Œå½“æŸä¸ªsocketæœ‰æ•°æ®åˆ°è¾¾äº†ï¼Œå°±é€šçŸ¥ç”¨æˆ·è¿›ç¨‹ã€‚\nå½“ç”¨æˆ·è¿›ç¨‹è°ƒç”¨äº†selectï¼Œé‚£ä¹ˆæ•´ä¸ªè¿›ç¨‹ä¼šè¢«blockï¼Œè€ŒåŒæ—¶ï¼Œkernelä¼šâ€œç›‘è§†â€æ‰€æœ‰selectè´Ÿè´£çš„socketï¼Œå½“ä»»ä½•ä¸€ä¸ªsocketä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œselectå°±ä¼šè¿”å›ã€‚è¿™ä¸ªæ—¶å€™ç”¨æˆ·è¿›ç¨‹å†è°ƒç”¨readæ“ä½œï¼Œå°†æ•°æ®ä»kernelæ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ã€‚\nè¿™ä¸ªå›¾å’Œblocking IOçš„å›¾å…¶å®å¹¶æ²¡æœ‰å¤ªå¤§çš„ä¸åŒï¼Œäº‹å®ä¸Šï¼Œè¿˜æ›´å·®ä¸€äº›ã€‚å› ä¸ºè¿™é‡Œéœ€è¦ä½¿ç”¨ä¸¤ä¸ªsystem call (selectå’Œ recvfrom)ï¼Œè€Œblocking IOåªè°ƒç”¨äº†ä¸€ä¸ªsystem call (recvfrom)ã€‚ä½†æ˜¯ï¼Œç”¨selectçš„ä¼˜åŠ¿åœ¨äºå®ƒå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªconnectionã€‚\næ‰€ä»¥ï¼Œå¦‚æœå¤„ç†çš„è¿æ¥æ•°ä¸æ˜¯å¾ˆé«˜çš„è¯ï¼Œä½¿ç”¨select/epollçš„web serverä¸ä¸€å®šæ¯”ä½¿ç”¨multi-threading + blocking IOçš„web serveræ€§èƒ½æ›´å¥½ï¼Œå¯èƒ½å»¶è¿Ÿè¿˜æ›´å¤§ã€‚select/epollçš„ä¼˜åŠ¿å¹¶ä¸æ˜¯å¯¹äºå•ä¸ªè¿æ¥èƒ½å¤„ç†å¾—æ›´å¿«ï¼Œè€Œæ˜¯åœ¨äºèƒ½å¤„ç†æ›´å¤šçš„è¿æ¥ã€‚\nåœ¨I/Oç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼Œå½“éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯æ¥å…¥è¯·æ±‚æ—¶ï¼Œå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æˆ–è€…I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯è¿›è¡Œå¤„ç†ã€‚I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯é€šè¿‡æŠŠå¤šä¸ªI/Oçš„é˜»å¡å¤ç”¨åˆ°åŒä¸€ä¸ªselectçš„é˜»å¡ä¸Šï¼Œä»è€Œä½¿å¾—ç³»ç»Ÿåœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ã€‚ä¸ä¼ ç»Ÿçš„å¤šçº¿ç¨‹/å¤šè¿›ç¨‹æ¨¡å‹æ¯”ï¼ŒI/Oå¤šè·¯å¤ç”¨çš„æœ€å¤§ä¼˜åŠ¿æ˜¯ç³»ç»Ÿå¼€é”€å°ï¼Œç³»ç»Ÿä¸éœ€è¦åˆ›å»ºæ–°çš„é¢å¤–è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œä¹Ÿä¸éœ€è¦ç»´æŠ¤è¿™äº›è¿›ç¨‹å’Œçº¿ç¨‹çš„è¿è¡Œï¼Œé™åº•äº†ç³»ç»Ÿçš„ç»´æŠ¤å·¥ä½œé‡ï¼ŒèŠ‚çœäº†ç³»ç»Ÿèµ„æºã€‚\n æ‰€ä»¥ï¼ŒI/O å¤šè·¯å¤ç”¨çš„ç‰¹ç‚¹æ˜¯é€šè¿‡ä¸€ç§æœºåˆ¶ä¸€ä¸ªè¿›ç¨‹èƒ½åŒæ—¶ç­‰å¾…å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œè¿™äº›æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¥—æ¥å­—æè¿°ç¬¦ï¼‰å…¶ä¸­çš„ä»»æ„ä¸€ä¸ªè¿›å…¥è¯»å°±ç»ªçŠ¶æ€ï¼Œselect()å‡½æ•°å°±å¯ä»¥è¿”å›ã€‚\n 3.4 signal-driven IO ä¿¡å·é©±åŠ¨å¼I/Oï¼šé¦–å…ˆæˆ‘ä»¬å…è®¸Socketè¿›è¡Œä¿¡å·é©±åŠ¨IO,å¹¶å®‰è£…ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œå¹¶ä¸é˜»å¡ã€‚å½“æ•°æ®å‡†å¤‡å¥½æ—¶ï¼Œè¿›ç¨‹ä¼šæ”¶åˆ°ä¸€ä¸ªSIGIOä¿¡å·ï¼Œå¯ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨I/Oæ“ä½œå‡½æ•°å¤„ç†æ•°æ®ã€‚è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n3.5 asynchronous IO ç›¸å¯¹äºåŒæ­¥IOï¼Œå¼‚æ­¥IOä¸æ˜¯é¡ºåºæ‰§è¡Œã€‚ç”¨æˆ·è¿›ç¨‹è¿›è¡Œaio_readç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œæ— è®ºå†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ï¼Œéƒ½ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ï¼Œç„¶åç”¨æˆ·æ€è¿›ç¨‹å¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚ç­‰åˆ°socketæ•°æ®å‡†å¤‡å¥½äº†ï¼Œå†…æ ¸ç›´æ¥å¤åˆ¶æ•°æ®ç»™è¿›ç¨‹ï¼Œç„¶åä»å†…æ ¸å‘è¿›ç¨‹å‘é€é€šçŸ¥ã€‚IOä¸¤ä¸ªé˜¶æ®µï¼Œè¿›ç¨‹éƒ½æ˜¯éé˜»å¡çš„ã€‚\nLinuxæä¾›äº†AIOåº“å‡½æ•°å®ç°å¼‚æ­¥ï¼Œä½†æ˜¯ç”¨çš„å¾ˆå°‘ã€‚ç›®å‰æœ‰å¾ˆå¤šå¼€æºçš„å¼‚æ­¥IOåº“ï¼Œä¾‹å¦‚libeventã€libevã€libuvã€‚å¼‚æ­¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nç”¨æˆ·è¿›ç¨‹å‘èµ·readæ“ä½œä¹‹åï¼Œç«‹åˆ»å°±å¯ä»¥å¼€å§‹å»åšå…¶å®ƒçš„äº‹ã€‚è€Œå¦ä¸€æ–¹é¢ï¼Œä»kernelçš„è§’åº¦ï¼Œå½“å®ƒå—åˆ°ä¸€ä¸ªasynchronous readä¹‹åï¼Œé¦–å…ˆå®ƒä¼šç«‹åˆ»è¿”å›ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹ç”¨æˆ·è¿›ç¨‹äº§ç”Ÿä»»ä½•blockã€‚ç„¶åï¼Œkernelä¼šç­‰å¾…æ•°æ®å‡†å¤‡å®Œæˆï¼Œç„¶åå°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·å†…å­˜ï¼Œå½“è¿™ä¸€åˆ‡éƒ½å®Œæˆä¹‹åï¼Œkernelä¼šç»™ç”¨æˆ·è¿›ç¨‹å‘é€ä¸€ä¸ªsignalï¼Œå‘Šè¯‰å®ƒreadæ“ä½œå®Œæˆäº†ã€‚\n æ‰€ä»¥ï¼Œaioçš„ç‰¹ç‚¹æ˜¯ä¸¤ä¸ªé˜¶æ®µéƒ½ä¸é˜»å¡ï¼Œç‰¹åˆ«æ˜¯ç¬¬äºŒé˜¶æ®µï¼Œæ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´æ˜¯æ˜¯ç³»ç»Ÿå®Œæˆçš„ï¼Œç³»ç»Ÿå®Œæˆæ‹·è´åå†é€šçŸ¥åº”ç”¨è¿›ç¨‹ã€‚\n 4. æ€»ç»“ 5. å‚è€ƒèµ„æ–™ W. Richard Stevens - Unix Network Programming Volume 1 3rd Edition - The Sockets Networking API.pdf\rèŠèŠLinux äº”ç§IOæ¨¡å‹ çŒ¿ç æ¶æ„\rLinux IOæ¨¡å¼åŠ selectã€pollã€epollè¯¦è§£\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/5%E7%A7%8Dio%E6%A8%A1%E5%9E%8B/","series":["Manual"],"tags":["IO","CS"],"title":"5ç§IOæ¨¡å‹"},{"categories":["æ¶æ„æ¼”è¿›"],"content":" éªŒç­¾ï¼šé˜²æ¥å£è¢«è‚†æ„è°ƒç”¨  clientå¯¹requestç­¾åï¼Œserverå¯¹è¯·æ±‚è¿›è¡ŒéªŒç­¾ã€‚\né‰´æƒï¼šé˜²è°ƒç”¨æ²¡æœ‰æƒé™çš„æ¥å£  tokené‰´æƒï¼Œå®é™…ä¸ŠéªŒç­¾ã€é‰´æƒé€šå¸¸æ˜¯ä¸€åŒå¤„ç†çš„ï¼Œä¾‹å¦‚ï¼šOAuth2\néªŒè¯è¯·æ±‚çš„timestampï¼šé˜²ç›—é“¾  å½“å‰æ—¶é—´ - timestamp \u0026gt; é˜ˆå€¼ï¼Œåˆ™è¯´æ˜è¯¥è¯·æ±‚å·²ç»å¤±æ•ˆã€‚\nnonceéšæœºæ•°ï¼šé˜²é‡å¤æäº¤  ä¸Šè¿°éªŒè¯timestampçš„è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚ï¼šé˜ˆå€¼ = 60sï¼Œé‚£ä¹ˆ60så†…å‘ç”Ÿé‡å¤æäº¤æ€ä¹ˆåŠï¼Ÿ\nè§£å†³åŠæ³•æ˜¯ï¼šserverç«¯ä¿å­˜å¸¦éšæœºæ•°çš„è¯·æ±‚ï¼ˆéšæœºæ•°+åŸè¯·æ±‚ = æ–°è¯·æ±‚ï¼Œé€šå¸¸æ˜¯redisä¿å­˜ï¼‰ã€‚\næ¥å£å¹‚ç­‰æ€§ä¿è¯ï¼ˆå”¯ä¸€ä¸»é”®ã€ä¹è§‚é”ï¼‰  å¹‚ç­‰æ€§ï¼šä»¥ç›¸åŒçš„è¯·æ±‚è°ƒç”¨è¿™ä¸ªæ¥å£ä¸€æ¬¡å’Œè°ƒç”¨è¿™ä¸ªæ¥å£å¤šæ¬¡ï¼Œå¯¹ç³»ç»Ÿäº§ç”Ÿçš„å½±å“æ˜¯ç›¸åŒçš„ã€‚\næ¶æ„çš„é‡å¤æäº¤ï¼šè¯·æ±‚çš„timestampã€nonceè¾ƒä¸Šä¸€æ¬¡æ²¡å˜ï¼Œè¿™ç§æƒ…å†µé€šè¿‡redisä¿å­˜å¸¦éšæœºæ•°çš„è¯·æ±‚å¯ä»¥æœç»ã€‚\nç”¨æˆ·è¯¯æ“ä½œå¯¼è‡´çš„é‡å¤æäº¤ï¼šå‰ç«¯æ§åˆ¶+å¹‚ç­‰è®¾è®¡ã€‚\nå¹‚ç­‰ä¸é‡å¤æäº¤çš„åŒºåˆ«åœ¨äºï¼šå¹‚ç­‰æ˜¯åœ¨é‡å¤æäº¤å·²ç»å‘ç”Ÿäº†çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•ä¿è¯å¤šæ¬¡è°ƒç”¨æ¥å£çš„ç»“æœä¸€è‡´ï¼Œé‡å¤æäº¤åœ¨å‰ï¼Œå¹‚ç­‰ä¿è¯åœ¨åã€‚\nå‚è€ƒé“¾æ¥ï¼š å¦‚ä½•ä¿è¯æ¥å£çš„å¹‚ç­‰æ€§\rè¯´è¯´APIçš„é˜²é‡æ”¾æœºåˆ¶\rJavaç”Ÿé²œç”µå•†å¹³å°-APIæ¥å£è®¾è®¡ä¹‹tokenã€timestampã€sign å…·ä½“æ¶æ„ä¸å®ç°ï¼ˆAPP/å°ç¨‹åºï¼Œä¼ è¾“å®‰å…¨ï¼‰\ré˜¿é‡Œä¸€é¢ï¼šå¦‚ä½•ä¿è¯APIæ¥å£æ•°æ®å®‰å…¨ï¼Ÿ\rå®ç°æ¥å£å¹‚ç­‰æ€§çš„å‡ ç§æ–¹æ¡ˆ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/api%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8%E8%AE%BE%E8%AE%A1/","series":["Manual"],"tags":["SA"],"title":"APIæ¥å£å®‰å…¨è®¾è®¡"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"Javaå¹¶å‘ä¹‹AQSè¯¦è§£\rå¹¶å‘ä¹‹AQSåŸç†(äºŒ) CLHé˜Ÿåˆ—ä¸Nodeè§£æ\rä»ReentrantLockçš„å®ç°çœ‹AQSçš„åŸç†åŠåº”ç”¨\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/aqs/","series":["Manual"],"tags":["Java"],"title":"AQS"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"Spring Bootç³»åˆ—äºŒ Spring @Asyncå¼‚æ­¥çº¿ç¨‹æ± ç”¨æ³•æ€»ç»“\rspringbootåˆ©ç”¨@Asyncæå‡APIæ¥å£å¹¶å‘èƒ½åŠ›\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/async/","series":["Manual"],"tags":["Spring"],"title":"Async"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"BeanFactoryPostProcessorå’ŒBeanPostProcessorï¼Œè¿™ä¸¤ä¸ªæ¥å£ï¼Œéƒ½æ˜¯Springåˆå§‹åŒ–beanæ—¶å¯¹å¤–æš´éœ²çš„æ‰©å±•ç‚¹ã€‚ä¸¤ä¸ªæ¥å£åç§°çœ‹èµ·æ¥å¾ˆç›¸ä¼¼ï¼Œä½†ä½œç”¨åŠä½¿ç”¨åœºæ™¯å´ä¸åŒï¼Œåˆ†æå¦‚ä¸‹ï¼š\n1ã€BeanFactoryPostProcessoræ¥å£ è¯¥æ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š\npublic interface BeanFactoryPostProcessor {\n/** * Modify the application context\u0026#39;s internal bean factory after its standard * initialization. All bean definitions will have been loaded, but no beans * will have been instantiated yet. This allows for overriding or adding * properties even to eager-initializing beans. * @param beanFactory the bean factory used by the application context * @throws org.springframework.beans.BeansException in case of errors */ void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException; } å®ç°è¯¥æ¥å£ï¼Œå¯ä»¥åœ¨springçš„beanåˆ›å»ºä¹‹å‰ï¼Œä¿®æ”¹beançš„å®šä¹‰å±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒSpringå…è®¸BeanFactoryPostProcessoråœ¨å®¹å™¨å®ä¾‹åŒ–ä»»ä½•å…¶å®ƒbeanä¹‹å‰è¯»å–é…ç½®å…ƒæ•°æ®ï¼Œå¹¶å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹ï¼Œä¾‹å¦‚å¯ä»¥æŠŠbeançš„scopeä»singletonæ”¹ä¸ºprototypeï¼Œä¹Ÿå¯ä»¥æŠŠpropertyçš„å€¼ç»™ä¿®æ”¹æ‰ã€‚å¯ä»¥åŒæ—¶é…ç½®å¤šä¸ªBeanFactoryPostProcessorï¼Œå¹¶é€šè¿‡è®¾ç½®\u0026rsquo;order\u0026rsquo;å±æ€§æ¥æ§åˆ¶å„ä¸ªBeanFactoryPostProcessorçš„æ‰§è¡Œæ¬¡åºã€‚\n æ³¨æ„ï¼šBeanFactoryPostProcessoræ˜¯åœ¨springå®¹å™¨åŠ è½½äº†beançš„å®šä¹‰æ–‡ä»¶ä¹‹åï¼Œåœ¨beanå®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œçš„ã€‚æ¥å£æ–¹æ³•çš„å…¥å‚æ˜¯ConfigurrableListableBeanFactoryï¼Œä½¿ç”¨è¯¥å‚æ•°ï¼Œå¯ä»¥è·å–åˆ°ç›¸å…³beançš„å®šä¹‰ä¿¡æ¯ã€‚\n 2ã€BeanPostProcessoræ¥å£ è¯¥æ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š\npublic interface BeanPostProcessor {\n/** * Apply this BeanPostProcessor to the given new bean instance \u0026lt;i\u0026gt;before\u0026lt;/i\u0026gt; any bean * initialization callbacks (like InitializingBean\u0026#39;s \u0026lt;code\u0026gt;afterPropertiesSet\u0026lt;/code\u0026gt; * or a custom init-method). The bean will already be populated with property values. * The returned bean instance may be a wrapper around the original. * @param bean the new bean instance * @param beanName the name of the bean * @return the bean instance to use, either the original or a wrapped one * @throws org.springframework.beans.BeansException in case of errors * @see org.springframework.beans.factory.InitializingBean#afterPropertiesSet */ Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException; /** * Apply this BeanPostProcessor to the given new bean instance \u0026lt;i\u0026gt;after\u0026lt;/i\u0026gt; any bean * initialization callbacks (like InitializingBean\u0026#39;s \u0026lt;code\u0026gt;afterPropertiesSet\u0026lt;/code\u0026gt; * or a custom init-method). The bean will already be populated with property values. * The returned bean instance may be a wrapper around the original. * \u0026lt;p\u0026gt;In case of a FactoryBean, this callback will be invoked for both the FactoryBean * instance and the objects created by the FactoryBean (as of Spring 2.0). The * post-processor can decide whether to apply to either the FactoryBean or created * objects or both through corresponding \u0026lt;code\u0026gt;bean instanceof FactoryBean\u0026lt;/code\u0026gt; checks. * \u0026lt;p\u0026gt;This callback will also be invoked after a short-circuiting triggered by a * {@link InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation} method, * in contrast to all other BeanPostProcessor callbacks. * @param bean the new bean instance * @param beanName the name of the bean * @return the bean instance to use, either the original or a wrapped one * @throws org.springframework.beans.BeansException in case of errors * @see org.springframework.beans.factory.InitializingBean#afterPropertiesSet * @see org.springframework.beans.factory.FactoryBean */ Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException; } BeanPostProcessorï¼Œå¯ä»¥åœ¨springå®¹å™¨å®ä¾‹åŒ–beanä¹‹åï¼Œåœ¨æ‰§è¡Œbeançš„åˆå§‹åŒ–æ–¹æ³•å‰åï¼Œæ·»åŠ ä¸€äº›è‡ªå·±çš„å¤„ç†é€»è¾‘ã€‚è¿™é‡Œè¯´çš„åˆå§‹åŒ–æ–¹æ³•ï¼ŒæŒ‡çš„æ˜¯ä¸‹é¢ä¸¤ç§ï¼š\n1ï¼‰beanå®ç°äº†InitializingBeanæ¥å£ï¼Œå¯¹åº”çš„æ–¹æ³•ä¸ºafterPropertiesSet\n2ï¼‰åœ¨beanå®šä¹‰çš„æ—¶å€™ï¼Œé€šè¿‡init-methodè®¾ç½®çš„æ–¹æ³•\n æ³¨æ„ï¼šBeanPostProcessoræ˜¯åœ¨springå®¹å™¨åŠ è½½äº†beançš„å®šä¹‰æ–‡ä»¶å¹¶ä¸”å®ä¾‹åŒ–beanä¹‹åæ‰§è¡Œçš„ã€‚BeanPostProcessorçš„æ‰§è¡Œé¡ºåºæ˜¯åœ¨BeanFactoryPostProcessorä¹‹åã€‚\n 3ã€å®æˆ˜ BeanFactoryPostProcessor\npublic class MyBeanFactoryPostProcessor implements BeanFactoryPostProcessor { @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException { System.out.println(\u0026#34;1. è°ƒç”¨BeanFactoryPostProcessorçš„postProcessBeanFactory\u0026#34;); BeanDefinition bd = beanFactory.getBeanDefinition(\u0026#34;myJavaBean\u0026#34;); MutablePropertyValues pv = bd.getPropertyValues(); pv.addPropertyValue(\u0026#34;remark\u0026#34;, \u0026#34;BeanFactoryPostProcessorä¸­ä¿®æ”¹ä¹‹åçš„remark\u0026#34;); } } BeanPostProcessor\npublic class MyBeanPostProcessor implements BeanPostProcessor { @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException { if (\u0026#34;myJavaBean\u0026#34;.equals(beanName)){ System.out.println(\u0026#34;3. è°ƒç”¨BeanPostProcessor.postProcessBeforeInitialization\u0026#34;); } return bean; } @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { if (\u0026#34;myJavaBean\u0026#34;.equals(beanName)){ System.out.println(\u0026#34;7. è°ƒç”¨BeanPostProcessor.postProcessAfterInitialization\u0026#34;); } return bean; } } é…ç½®ç±»\n@Configuration public class MyConfig { @Bean(initMethod = \u0026#34;initMethod\u0026#34;, destroyMethod = \u0026#34;destroyMethod\u0026#34;) public MyJavaBean myJavaBean() { MyJavaBean bean = new MyJavaBean(); bean.setRemark(\u0026#34;åŸå§‹remark\u0026#34;); return bean; } @Bean public MyBeanFactoryPostProcessor myBeanFactoryPostProcessor(){ return new MyBeanFactoryPostProcessor(); } @Bean public MyBeanPostProcessor myBeanPostProcessor(){ return new MyBeanPostProcessor(); } } Bean\npublic class MyJavaBean implements InitializingBean, DisposableBean { private String desc; private String remark; public MyJavaBean() { System.out.println(\u0026#34;2 Beançš„æ— å‚æ„é€ å‡½æ•°\u0026#34;); } public MyJavaBean(String desc, String remark) { this.desc = desc; this.remark = remark; System.out.println(\u0026#34;2 Beançš„å…¨å‚æ„é€ å‡½æ•°\u0026#34;); } @PostConstruct public void postConstruct() { System.out.println(\u0026#34;4. è°ƒç”¨PostConstructæ–¹æ³•\u0026#34;); } public String getDesc() { return desc; } public void setDesc(String desc) { System.out.println(\u0026#34;è°ƒç”¨setDescæ–¹æ³•\u0026#34;); this.desc = desc; } public String getRemark() { return remark; } public void setRemark(String remark) { System.out.println(\u0026#34;è°ƒç”¨setRemarkæ–¹æ³•\u0026#34;); this.remark = remark; System.out.println(\u0026#34;remark = \u0026#34; + this.remark); } @Override public void afterPropertiesSet() throws Exception { System.out.println(\u0026#34;5. è°ƒç”¨InitializingBean.afterPropertiesSetæ–¹æ³•\u0026#34;); this.desc = \u0026#34;afterPropertiesSetä¸­ä¿®æ”¹ä¹‹åçš„desc\u0026#34;; } public void initMethod() { System.out.println(\u0026#34;6. è°ƒç”¨Beançš„initæ–¹æ³•\u0026#34;); } @Override public void destroy() throws Exception { System.out.println(\u0026#34;8. è°ƒç”¨DisposableBean.destroy\u0026#34;); } public void destroyMethod() { System.out.println(\u0026#34;9. è°ƒç”¨Beançš„destroyæ–¹æ³•\u0026#34;); } @Override public String toString() { StringBuilder builder = new StringBuilder(); builder.append(\u0026#34;[descï¼š\u0026#34;).append(desc); builder.append(\u0026#34;ï¼Œ remarkï¼š\u0026#34;).append(remark).append(\u0026#34;]\u0026#34;); return builder.toString(); } } å¯åŠ¨ç±»\n@SpringBootApplication public class PostProcessorApplication { public static void main(String[] args) { ApplicationContext applicationContext = SpringApplication.run(PostProcessorApplication.class, args); MyJavaBean bean = (MyJavaBean) applicationContext.getBean(\u0026#34;myJavaBean\u0026#34;); System.out.println(\u0026#34;=======================ç»“æœ====================\u0026#34;); System.out.println(\u0026#34;descï¼š\u0026#34; + bean.getDesc()); System.out.println(\u0026#34;remarkï¼š\u0026#34; + bean.getRemark()); System.out.println(\u0026#34;======================ç»“æœ====================\u0026#34;); } } æ‰§è¡Œé¡ºåºï¼š\n1. è°ƒç”¨BeanFactoryPostProcessorçš„postProcessBeanFactory 2 Beançš„æ— å‚æ„é€ å‡½æ•° è°ƒç”¨setRemarkæ–¹æ³• remark = åŸå§‹remark è°ƒç”¨setRemarkæ–¹æ³• remark = BeanFactoryPostProcessorä¸­ä¿®æ”¹ä¹‹åçš„remark ******beanName = myJavaBean ******beanFactory = org.springframework.beans.factory.support.DefaultListableBeanFactory ******applicationContext = org.springframework.context.annotation.AnnotationConfigApplicationContext 3. è°ƒç”¨BeanPostProcessor.postProcessBeforeInitialization 4. è°ƒç”¨PostConstructæ–¹æ³• 5. è°ƒç”¨InitializingBean.afterPropertiesSetæ–¹æ³• 6. è°ƒç”¨Beançš„initæ–¹æ³• 7. è°ƒç”¨BeanPostProcessor.postProcessAfterInitialization =======================ç»“æœ==================== descï¼šafterPropertiesSetä¸­ä¿®æ”¹ä¹‹åçš„desc remarkï¼šBeanFactoryPostProcessorä¸­ä¿®æ”¹ä¹‹åçš„remark ======================ç»“æœ==================== 8. è°ƒç”¨DisposableBean.destroy 9. è°ƒç”¨Beançš„destroyæ–¹æ³•  BeanFactoryPostProcessorå¯¹Beanå±æ€§çš„ä¿®æ”¹å»¶è¿Ÿåˆ°äº†Beanåˆå§‹åŒ–å®Œæˆä¹‹åæ‰æ‰§è¡Œ\n 4ã€è¿›ä¸€æ­¥æ·±å…¥åˆ†æ åœ¨ä½¿ç”¨ApplicationContextå¯åŠ¨springå®¹å™¨çš„æ—¶å€™ï¼Œåœ¨AbstractApplicationContext.refresh()æ–¹æ³•ä¸­ï¼Œå®Œæˆç›¸å…³åˆå§‹åŒ–å·¥ä½œï¼š\n1ï¼‰BeanFactoryPostProcessor.postProcessBeanFactoryï¼Œæ˜¯åœ¨ç¬¬5æ­¥æ‰§è¡Œçš„\n2ï¼‰è€ŒBeanPostProcessorçš„æ‰§è¡Œï¼Œå–å†³äºé…ç½®æ–‡ä»¶ä¸­beançš„å®šä¹‰ï¼Œå¦‚æœå®šä¹‰çš„beanæ˜¯singletonå¹¶ä¸”ä¸æ˜¯æŠ½è±¡ç±»ï¼Œä¹Ÿä¸å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåˆ™BeanPostProcessoræ˜¯åœ¨ç¬¬11æ­¥ä¸­æ‰§è¡Œï¼›è€Œå¯¹äºprototypeçš„beanï¼ŒBeanPostProcessoræ˜¯åœ¨ç¨‹åºgetBeançš„æ—¶å€™æ‰§è¡Œçš„ã€‚åœ¨ç¬¬6æ­¥ä¸­ï¼Œè°ƒç”¨registerBeanPostProcessorsæ–¹æ³•ï¼Œæ³¨å†Œæ‰€æœ‰å®ç°BeanPostProcessoræ¥å£çš„bean\n5ã€æ€»ç»“ 1ã€åˆ›å»ºï¼ˆè°ƒç”¨æ„é€ å‡½æ•°ï¼‰ 2ã€setå±æ€§ï¼ˆsetæ–¹æ³•æ³¨å…¥å±æ€§ï¼‰ 3ã€åˆ¤æ–­æ˜¯å¦å®ç°BeanNameAwareæ¥å£ï¼Œå¹¶è°ƒç”¨æ¥å£çš„setBeanNameæ–¹æ³• 4ã€åˆ¤æ–­æ˜¯å¦å®ç°BeanFactoryAwareæ¥å£ï¼Œå¹¶è°ƒç”¨æ¥å£çš„setBeanFactoryæ–¹æ³• 5ã€åˆ¤æ–­æ˜¯å¦å®ç°ApplicationContextAwareæ¥å£ï¼Œå¹¶è°ƒç”¨æ¥å£çš„setApplicationContextæ–¹æ³• 6ã€åˆ¤æ–­æ˜¯å¦å®ç°BeanPostProcessoræ¥å£ï¼Œå¹¶è°ƒç”¨æ¥å£çš„postProcessBeforeInitializationæ–¹æ³• 7ã€åˆ¤æ–­æ˜¯å¦å®ç°InitializingBeanæ¥å£ï¼Œå¹¶è°ƒç”¨æ¥å£çš„afterPropertiesSetæ–¹æ³• 8ã€åˆ¤æ–­æ˜¯å¦è‡ªå®šä¹‰initæ–¹æ³•ï¼Œå¹¶è°ƒç”¨ 9ã€åˆ¤æ–­æ˜¯å¦å®ç°BeanPostProcessoræ¥å£ï¼ˆåŒ6ï¼‰ï¼Œå¹¶è°ƒç”¨æ¥å£çš„postProcessAfterInitializationæ–¹æ³• 10ã€ä¸šåŠ¡ä»£ç ä¸­Beanå¯¹è±¡çš„ä½¿ç”¨ 11ã€å½“å®¹å™¨é”€æ¯æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å®ç°DisposableBeanæ¥å£ï¼Œå¹¶è°ƒç”¨æ¥å£çš„destroyæ–¹æ³• 12ã€åˆ¤æ–­æ˜¯å¦è‡ªå®šä¹‰é”€æ¯æ–¹æ³•ï¼Œå¹¶è°ƒç”¨\nå¯¹äº BeanNameAware BeanFactoryAware ApplicationContextAware è¿™3ä¸ªæ¥å£æˆ‘ä»¬å¹³æ—¶å¾ˆå°‘å®ç°å®ƒï¼Œä¸€èˆ¬ç”¨äºè®©Beanèƒ½å¤Ÿæ„ŸçŸ¥åˆ°BeanName BeanFactory ApplicationContext\npublic class MyJavaBean implements BeanNameAware, BeanFactoryAware, ApplicationContextAware { private String beanName; private BeanFactory beanFactory; private ApplicationContext applicationContext; @Override public void setBeanName(String s) { this.beanName = s; System.out.println(\u0026#34;******beanName = \u0026#34; + this.beanName); } @Override public void setBeanFactory(BeanFactory beanFactory) throws BeansException { this.beanFactory = beanFactory; System.out.println(\u0026#34;******beanFactory = \u0026#34; + this.beanFactory); } @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException { this.applicationContext = applicationContext; System.out.println(\u0026#34;******applicationContext = \u0026#34; + this.applicationContext); } } å‚è€ƒ Springçš„BeanFactoryPostProcessorå’ŒBeanPostProcessor\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/beanfactorypostprocessor%E5%92%8Cbeanpostprocessor/","series":["Manual"],"tags":["Spring"],"title":"BeanFactoryPostProcessorå’ŒBeanPostProcessor"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å®ä¾‹åŒ– -\u0026gt; å±æ€§èµ‹å€¼ -\u0026gt; åˆå§‹åŒ– -\u0026gt; é”€æ¯ å‚è€ƒé“¾æ¥ è¯·åˆ«å†é—®Spring Beançš„ç”Ÿå‘½å‘¨æœŸäº†ï¼\rSpring Beançš„ç”Ÿå‘½å‘¨æœŸï¼ˆéå¸¸è¯¦ç»†ï¼‰\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/","series":["Manual"],"tags":["Spring"],"title":"beanç”Ÿå‘½å‘¨æœŸ"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ free -m æŸ¥çœ‹ç³»ç»Ÿå†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼š\nå¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿå†…å­˜ä¸º 16Gï¼ŒSwap å†…å­˜ 16Gï¼Œmem free è™½ç„¶æ˜¾ç¤ºä¸º 1118ï¼Œå› ç¼“å­˜çš„å­˜åœ¨ï¼Œä¸èƒ½è®¤ä¸ºç³»ç»Ÿç›®å‰å†…å‰©ä¸‹è¿™ä¹ˆå¤šå†…å­˜ã€‚è€Œåº”è¯¥æŠŠ buffersã€cached çš„ä¹Ÿç®—ä¸Šï¼Œå³ free+cached+buffers=1118+7110+430ï¼8658ï¼Œæ€»å†…å­˜å†å‡å» 8658ï¼7314ï¼Œä¸ buffers/cache è¡Œä¸­å¯¹åº” free åˆ—çš„ 7312 å’Œ 8659 åŸºæœ¬ä¸€è‡´ã€‚\n è¿™é‡Œé¡ºä¾¿ä»‹ç»ä¸€ä¸‹Swapï¼Œäº†è§£Swapæ›´å¤šè¯¦æƒ…è¯·ç§»æ­¥ ğŸ‘‰ Swapäº¤æ¢åˆ†åŒºæ¦‚å¿µ\r  Linuxå†…æ ¸ä¸ºäº†æé«˜è¯»å†™æ•ˆç‡ä¸é€Ÿåº¦ï¼Œä¼šå°†æ–‡ä»¶åœ¨å†…å­˜ä¸­è¿›è¡Œç¼“å­˜ï¼Œè¿™éƒ¨åˆ†å†…å­˜å°±æ˜¯Cache Memory(ç¼“å­˜å†…å­˜)ã€‚å³ä½¿ä½ çš„ç¨‹åºè¿è¡Œç»“æŸåï¼ŒCache Memoryä¹Ÿä¸ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚è¿™å°±ä¼šå¯¼è‡´ä½ åœ¨Linuxç³»ç»Ÿä¸­ç¨‹åºé¢‘ç¹è¯»å†™æ–‡ä»¶åï¼Œä½ ä¼šå‘ç°å¯ç”¨ç‰©ç†å†…å­˜å˜å°‘ã€‚å½“ç³»ç»Ÿçš„ç‰©ç†å†…å­˜ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œå°±éœ€è¦å°†ç‰©ç†å†…å­˜ä¸­çš„ä¸€éƒ¨åˆ†ç©ºé—´é‡Šæ”¾å‡ºæ¥ï¼Œä»¥ä¾›å½“å‰è¿è¡Œçš„ç¨‹åºä½¿ç”¨ã€‚é‚£äº›è¢«é‡Šæ”¾çš„ç©ºé—´å¯èƒ½æ¥è‡ªä¸€äº›å¾ˆé•¿æ—¶é—´æ²¡æœ‰ä»€ä¹ˆæ“ä½œçš„ç¨‹åºï¼Œè¿™äº›è¢«é‡Šæ”¾çš„ç©ºé—´è¢«ä¸´æ—¶ä¿å­˜åˆ°Swapç©ºé—´ä¸­ï¼Œç­‰åˆ°é‚£äº›ç¨‹åºè¦è¿è¡Œæ—¶ï¼Œå†ä»Swapåˆ†åŒºä¸­æ¢å¤ä¿å­˜çš„æ•°æ®åˆ°å†…å­˜ä¸­ã€‚è¿™æ ·ï¼Œç³»ç»Ÿæ€»æ˜¯åœ¨ç‰©ç†å†…å­˜ä¸å¤Ÿæ—¶ï¼Œæ‰è¿›è¡ŒSwapäº¤æ¢ã€‚\n ä»Linux kernel version 2.4å¼€å§‹ï¼Œbuffer/cacheåˆå¹¶ï¼ˆè¯¦æƒ…è§ ğŸ‘‰ Linux IOçš„buffer cacheå’Œpage cacheåˆå¹¶çš„åŸå› \rï¼‰ï¼Œæ‰€ä»¥åŒæ ·ä½¿ç”¨ free -m çœ‹åˆ°çš„æ˜¯ï¼š\n[root@k8s-node3 ~]# free -m total used free shared buff/cache available Mem: 7820 6577 147 30 1095 907 Swap: 0 0 0  ä½¿ç”¨ hostnamectl æˆ–è€… cat /proc/version å¯ä»¥æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ï¼š\n  [root@k8s-node3 ~]# hostnamectl Static hostname: k8s-node3 Pretty hostname: VM-0-4-centos Icon name: computer-vm Chassis: vm Machine ID: 8a248d59684442b3a2edd315013b7d1f Boot ID: c14dd5b3b84646a58a98db62d5379832 Virtualization: kvm Operating System: CentOS Linux 7 (Core) CPE OS Name: cpe:/o:centos:centos:7 Kernel: Linux 3.10.0-1127.19.1.el7.x86_64 Architecture: x86-64 [root@k8s-node3 ~]# cat /proc/version Linux version 3.10.0-1127.19.1.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) ) #1 SMP Tue Aug 25 17:23:54 UTC 2020  æˆ‘ä»¬å‡è®¾buffer/cacheè¿˜æ²¡å‘ç”Ÿåˆå¹¶ï¼Œé‚£å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\nè¿™é‡Œç½—åˆ—å‡ ä¸ªé«˜èµğŸ‘çŸ¥ä¹å›ç­”ï¼š\nCache å’Œ Buffer éƒ½æ˜¯ç¼“å­˜ï¼Œä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ\r  cache æ˜¯ä¸ºäº†å¼¥è¡¥é«˜é€Ÿè®¾å¤‡å’Œä½é€Ÿè®¾å¤‡çš„é¸¿æ²Ÿè€Œå¼•å…¥çš„ä¸­é—´å±‚ï¼Œæœ€ç»ˆèµ·åˆ°åŠ å¿«è®¿é—®é€Ÿåº¦çš„ä½œç”¨ã€‚ è€Œ buffer çš„ä¸»è¦ç›®çš„è¿›è¡Œæµé‡æ•´å½¢ï¼ŒæŠŠçªå‘çš„å¤§æ•°é‡è¾ƒå°è§„æ¨¡çš„ I/O æ•´ç†æˆå¹³ç¨³çš„å°æ•°é‡è¾ƒå¤§è§„æ¨¡çš„ I/Oï¼Œä»¥å‡å°‘å“åº”æ¬¡æ•°ï¼ˆæ¯”å¦‚ä»ç½‘ä¸Šä¸‹ç”µå½±ï¼Œä½ ä¸èƒ½ä¸‹ä¸€ç‚¹ç‚¹æ•°æ®å°±å†™ä¸€ä¸‹ç¡¬ç›˜ï¼Œè€Œæ˜¯ç§¯æ”’ä¸€å®šé‡çš„æ•°æ®ä»¥åä¸€æ•´å—ä¸€èµ·å†™ï¼Œä¸ç„¶ç¡¬ç›˜éƒ½è¦è¢«ä½ ç©åäº†ï¼‰ã€‚   Linuxç³»ç»Ÿä¸­çš„Page cacheå’ŒBuffer cache\r ç£ç›˜çš„æ“ä½œæœ‰é€»è¾‘çº§ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰å’Œç‰©ç†çº§ï¼ˆç£ç›˜å—ï¼‰ï¼Œè¿™ä¸¤ç§Cacheå°±æ˜¯åˆ†åˆ«ç¼“å­˜é€»è¾‘å’Œç‰©ç†çº§æ•°æ®çš„ã€‚\nå‡è®¾æˆ‘ä»¬é€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ“ä½œæ–‡ä»¶ï¼Œé‚£ä¹ˆæ–‡ä»¶å°†è¢«ç¼“å­˜åˆ°Page Cacheï¼Œå¦‚æœéœ€è¦åˆ·æ–°æ–‡ä»¶çš„æ—¶å€™ï¼ŒPage Cacheå°†äº¤ç»™Buffer Cacheå»å®Œæˆï¼Œå› ä¸ºBuffer Cacheå°±æ˜¯ç¼“å­˜ç£ç›˜å—çš„ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œç›´æ¥å»æ“ä½œæ–‡ä»¶ï¼Œé‚£å°±æ˜¯Page CacheåŒºç¼“å­˜ï¼Œç”¨ddç­‰å‘½ä»¤ç›´æ¥æ“ä½œç£ç›˜å—ï¼Œå°±æ˜¯Buffer Cacheç¼“å­˜çš„ä¸œè¥¿ã€‚\nPage cacheå®é™…ä¸Šæ˜¯é’ˆå¯¹æ–‡ä»¶ç³»ç»Ÿçš„ï¼Œæ˜¯æ–‡ä»¶çš„ç¼“å­˜ï¼Œåœ¨æ–‡ä»¶å±‚é¢ä¸Šçš„æ•°æ®ä¼šç¼“å­˜åˆ°page cacheã€‚æ–‡ä»¶çš„é€»è¾‘å±‚éœ€è¦æ˜ å°„åˆ°å®é™…çš„ç‰©ç†ç£ç›˜ï¼Œè¿™ç§æ˜ å°„å…³ç³»ç”±æ–‡ä»¶ç³»ç»Ÿæ¥å®Œæˆã€‚å½“page cacheçš„æ•°æ®éœ€è¦åˆ·æ–°æ—¶ï¼Œpage cacheä¸­çš„æ•°æ®äº¤ç»™buffer cacheï¼Œä½†æ˜¯è¿™ç§å¤„ç†åœ¨2.6ç‰ˆæœ¬çš„å†…æ ¸ä¹‹åå°±å˜çš„å¾ˆç®€å•äº†ï¼Œæ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„cacheæ“ä½œã€‚\nBuffer cacheæ˜¯é’ˆå¯¹ç£ç›˜å—çš„ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯åœ¨æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œç›´æ¥å¯¹ç£ç›˜è¿›è¡Œæ“ä½œçš„æ•°æ®ä¼šç¼“å­˜åˆ°buffer cacheä¸­ï¼Œä¾‹å¦‚ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®éƒ½ä¼šç¼“å­˜åˆ°buffer cacheä¸­ã€‚\nç®€å•è¯´æ¥ï¼Œpage cacheç”¨æ¥ç¼“å­˜æ–‡ä»¶æ•°æ®ï¼Œbuffer cacheç”¨æ¥ç¼“å­˜ç£ç›˜æ•°æ®ã€‚åœ¨æœ‰æ–‡ä»¶ç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œå¯¹æ–‡ä»¶æ“ä½œï¼Œé‚£ä¹ˆæ•°æ®ä¼šç¼“å­˜åˆ°page cacheï¼Œå¦‚æœç›´æ¥é‡‡ç”¨ddç­‰å·¥å…·å¯¹ç£ç›˜è¿›è¡Œè¯»å†™ï¼Œé‚£ä¹ˆæ•°æ®ä¼šç¼“å­˜åˆ°buffer cacheã€‚\nBuffer(Buffer Cache)ä»¥å—å½¢å¼ç¼“å†²äº†å—è®¾å¤‡çš„æ“ä½œï¼Œå®šæ—¶æˆ–æ‰‹åŠ¨çš„åŒæ­¥åˆ°ç¡¬ç›˜ï¼Œå®ƒæ˜¯ä¸ºäº†ç¼“å†²å†™æ“ä½œç„¶åä¸€æ¬¡æ€§å°†å¾ˆå¤šæ”¹åŠ¨å†™å…¥ç¡¬ç›˜ï¼Œé¿å…é¢‘ç¹å†™ç¡¬ç›˜ï¼Œæé«˜å†™å…¥æ•ˆç‡ã€‚\nCache(Page Cache)ä»¥é¡µé¢å½¢å¼ç¼“å­˜äº†æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ï¼Œç»™éœ€è¦ä½¿ç”¨çš„ç¨‹åºè¯»å–ï¼Œå®ƒæ˜¯ä¸ºäº†ç»™è¯»æ“ä½œæä¾›ç¼“å†²ï¼Œé¿å…é¢‘ç¹è¯»ç¡¬ç›˜ï¼Œæé«˜è¯»å–æ•ˆç‡ã€‚\n å‚è€ƒ Linux æ“ä½œç³»ç»ŸåŸç† â€” å†…å­˜ â€” Cache å’Œ Buffer\rLinuxç³»ç»Ÿä¸­çš„Page cacheå’ŒBuffer cache\rCache å’Œ Buffer éƒ½æ˜¯ç¼“å­˜ï¼Œä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ\r[Swapäº¤æ¢åˆ†åŒºæ¦‚å¿µ](\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/system/cache%E5%92%8Cbuffer/","series":["Manual"],"tags":["CS","System"],"title":"cacheå’Œbuffer"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"1. LRU å’Œ LFU çš„ç¼ºç‚¹  LRU å®ç°ç®€å•ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹èƒ½å¤Ÿè¡¨ç°å‡ºå¾ˆå¥½çš„å‘½ä¸­ç‡ï¼Œæ˜¯ä¸€ä¸ªâ€œæ€§ä»·æ¯”â€å¾ˆé«˜çš„ç®—æ³•ï¼Œå¹³æ—¶ä¹Ÿå¾ˆå¸¸ç”¨ã€‚è™½ç„¶ LRU å¯¹çªå‘æ€§çš„ç¨€ç–æµé‡ï¼ˆsparse burstsï¼‰è¡¨ç°å¾ˆå¥½ï¼Œä½†åŒæ—¶ä¹Ÿä¼šäº§ç”Ÿç¼“å­˜æ±¡æŸ“ï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœå¶ç„¶æ€§çš„è¦å¯¹å…¨é‡æ•°æ®è¿›è¡Œéå†ï¼Œé‚£ä¹ˆâ€œå†å²è®¿é—®è®°å½•â€å°±ä¼šè¢«åˆ·èµ°ï¼Œé€ æˆæ±¡æŸ“ã€‚ å¦‚æœæ•°æ®çš„åˆ†å¸ƒåœ¨ä¸€æ®µæ—¶é—´å†…æ˜¯å›ºå®šçš„è¯ï¼Œé‚£ä¹ˆ LFU å¯ä»¥è¾¾åˆ°æœ€é«˜çš„å‘½ä¸­ç‡ã€‚ä½†æ˜¯ LFU æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼Œç¬¬ä¸€ï¼Œå®ƒéœ€è¦ç»™æ¯ä¸ªè®°å½•é¡¹ç»´æŠ¤é¢‘ç‡ä¿¡æ¯ï¼Œæ¯æ¬¡è®¿é—®éƒ½éœ€è¦æ›´æ–°ï¼Œè¿™æ˜¯ä¸ªå·¨å¤§çš„å¼€é”€ï¼›ç¬¬äºŒï¼Œå¯¹çªå‘æ€§çš„ç¨€ç–æµé‡æ— åŠ›ï¼Œå› ä¸ºå‰æœŸç»å¸¸è®¿é—®çš„è®°å½•å·²ç»å ç”¨äº†ç¼“å­˜ï¼Œå¶ç„¶çš„æµé‡ä¸å¤ªå¯èƒ½ä¼šè¢«ä¿ç•™ä¸‹æ¥ï¼Œè€Œä¸”è¿‡å»çš„ä¸€äº›å¤§é‡è¢«è®¿é—®çš„è®°å½•åœ¨å°†æ¥ä¹Ÿä¸ä¸€å®šä¼šä½¿ç”¨ä¸Šï¼Œè¿™æ ·å°±ä¸€ç›´æŠŠâ€œå‘â€å ç€äº†ã€‚  æ— è®º LRU è¿˜æ˜¯ LFU éƒ½æœ‰å…¶å„è‡ªçš„ç¼ºç‚¹ï¼Œä¸è¿‡ï¼Œç°åœ¨å·²ç»æœ‰å¾ˆå¤šé’ˆå¯¹å…¶ç¼ºç‚¹è€Œæ”¹è‰¯ã€ä¼˜åŒ–å‡ºæ¥çš„å˜ç§ç®—æ³•ã€‚\n2. TinyLFU TinyLFU å°±æ˜¯å…¶ä¸­ä¸€ä¸ªä¼˜åŒ–ç®—æ³•ï¼Œå®ƒæ˜¯ä¸“é—¨ä¸ºäº†è§£å†³ LFU ä¸Šè¿°æåˆ°çš„ä¸¤ä¸ªé—®é¢˜è€Œè¢«è®¾è®¡å‡ºæ¥çš„ã€‚\nè§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯é‡‡ç”¨äº† Countâ€“Min Sketch ç®—æ³•ã€‚\nè§£å†³ç¬¬äºŒä¸ªé—®é¢˜æ˜¯è®©è®°å½•å°½é‡ä¿æŒç›¸å¯¹çš„â€œæ–°é²œâ€ï¼ˆFreshness Mechanismï¼‰ï¼Œå¹¶ä¸”å½“æœ‰æ–°çš„è®°å½•æ’å…¥æ—¶ï¼Œå¯ä»¥è®©å®ƒè·Ÿè€çš„è®°å½•è¿›è¡Œâ€œPKâ€ï¼Œè¾“è€…å°±ä¼šè¢«æ·˜æ±°ï¼Œè¿™æ ·ä¸€äº›è€çš„ã€ä¸å†éœ€è¦çš„è®°å½•å°±ä¼šè¢«å‰”é™¤ã€‚\n2.1 ç»Ÿè®¡é¢‘ç‡ Countâ€“Min Sketch ç®—æ³• å¦‚ä½•å¯¹ä¸€ä¸ª key è¿›è¡Œç»Ÿè®¡ï¼Œä½†åˆå¯ä»¥èŠ‚çœç©ºé—´å‘¢ï¼Ÿï¼ˆä¸æ˜¯ç®€å•çš„ä½¿ç”¨HashMapï¼Œè¿™å¤ªæ¶ˆè€—å†…å­˜äº†ï¼‰ï¼Œæ³¨æ„å“¦ï¼Œä¸éœ€è¦ç²¾ç¡®çš„ç»Ÿè®¡ï¼Œåªéœ€è¦ä¸€ä¸ªè¿‘ä¼¼å€¼å°±å¯ä»¥äº†ï¼Œæ€ä¹ˆæ ·ï¼Œè¿™æ ·åœºæ™¯æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå¦‚æœä½ æ˜¯è€å¸æœºï¼Œæˆ–è®¸å·²ç»è”æƒ³åˆ°å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰çš„åº”ç”¨äº†ã€‚\næ²¡é”™ï¼Œå°†è¦ä»‹ç»çš„ Countâ€“Min Sketch çš„åŸç†è·Ÿ Bloom Filter ä¸€æ ·ï¼Œåªä¸è¿‡ Bloom Filter åªæœ‰ 0 å’Œ 1 çš„å€¼ï¼Œé‚£ä¹ˆä½ å¯ä»¥æŠŠ Countâ€“Min Sketch çœ‹ä½œæ˜¯â€œæ•°å€¼â€ç‰ˆçš„ Bloom Filterã€‚\n2.2 ä¿æ–°æœºåˆ¶ ä¸ºäº†è®©ç¼“å­˜ä¿æŒâ€œæ–°é²œâ€ï¼Œå‰”é™¤æ‰è¿‡å¾€é¢‘ç‡å¾ˆé«˜ä½†ä¹‹åä¸ç»å¸¸çš„ç¼“å­˜ï¼ŒCaffeine æœ‰ä¸€ä¸ª Freshness Mechanismã€‚åšæ³•å¾ˆç®€ç­”ï¼Œå°±æ˜¯å½“æ•´ä½“çš„ç»Ÿè®¡è®¡æ•°ï¼ˆå½“å‰æ‰€æœ‰è®°å½•çš„é¢‘ç‡ç»Ÿè®¡ä¹‹å’Œï¼Œè¿™ä¸ªæ•°å€¼å†…éƒ¨ç»´æŠ¤ï¼‰è¾¾åˆ°æŸä¸€ä¸ªå€¼æ—¶ï¼Œé‚£ä¹ˆæ‰€æœ‰è®°å½•çš„é¢‘ç‡ç»Ÿè®¡é™¤ä»¥ 2ã€‚\n3. Window Tiny LFU Caffeine é€šè¿‡æµ‹è¯•å‘ç° TinyLFU åœ¨é¢å¯¹çªå‘æ€§çš„ç¨€ç–æµé‡ï¼ˆsparse burstsï¼‰æ—¶è¡¨ç°å¾ˆå·®ï¼Œå› ä¸ºæ–°çš„è®°å½•ï¼ˆnew itemsï¼‰è¿˜æ²¡æ¥å¾—åŠå»ºç«‹è¶³å¤Ÿçš„é¢‘ç‡å°±è¢«å‰”é™¤å‡ºå»äº†ï¼Œè¿™å°±ä½¿å¾—å‘½ä¸­ç‡ä¸‹é™ã€‚\näºæ˜¯ Caffeine è®¾è®¡å‡ºä¸€ç§æ–°çš„ policyï¼Œå³ Window Tiny LFUï¼ˆW-TinyLFUï¼‰ï¼Œå¹¶é€šè¿‡å®éªŒå’Œå®è·µå‘ç° W-TinyLFU æ¯” TinyLFU è¡¨ç°çš„æ›´å¥½ã€‚\nW-TinyLFU çš„è®¾è®¡å¦‚ä¸‹æ‰€ç¤ºï¼ˆä¸¤å›¾ç­‰ä»·ï¼‰ï¼š\nå®ƒä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªç¼“å­˜æ¨¡å—ï¼Œä¸»ç¼“å­˜æ˜¯ SLRUï¼ˆSegmented LRUï¼Œå³åˆ†æ®µ LRUï¼‰ï¼ŒSLRU åŒ…æ‹¬ä¸€ä¸ªåä¸º protected å’Œä¸€ä¸ªåä¸º probation çš„ç¼“å­˜åŒºã€‚é€šè¿‡å¢åŠ ä¸€ä¸ªç¼“å­˜åŒºï¼ˆå³ Window Cacheï¼‰ï¼Œå½“æœ‰æ–°çš„è®°å½•æ’å…¥æ—¶ï¼Œä¼šå…ˆåœ¨ window åŒºå‘†ä¸€ä¸‹ï¼Œå°±å¯ä»¥é¿å…ä¸Šè¿°è¯´çš„ sparse bursts é—®é¢˜ã€‚\n3.1 æ•°æ®æ·˜æ±°ç­–ç•¥ åœ¨caffeineæ‰€æœ‰çš„æ•°æ®éƒ½åœ¨ConcurrentHashMapä¸­ï¼Œè¿™ä¸ªå’Œguava cacheä¸åŒï¼Œguava cacheæ˜¯è‡ªå·±å®ç°äº†ä¸ªç±»ä¼¼ConcurrentHashMapçš„ç»“æ„ã€‚åœ¨caffeineä¸­æœ‰ä¸‰ä¸ªè®°å½•å¼•ç”¨çš„LRUé˜Ÿåˆ—:\n Edené˜Ÿåˆ—:åœ¨caffeineä¸­è§„å®šåªèƒ½ä¸ºç¼“å­˜å®¹é‡çš„%1,å¦‚æœsize=100,é‚£è¿™ä¸ªé˜Ÿåˆ—çš„æœ‰æ•ˆå¤§å°å°±ç­‰äº1ã€‚è¿™ä¸ªé˜Ÿåˆ—ä¸­è®°å½•çš„æ˜¯æ–°åˆ°çš„æ•°æ®ï¼Œé˜²æ­¢çªå‘æµé‡ç”±äºä¹‹å‰æ²¡æœ‰è®¿é—®é¢‘ç‡ï¼Œè€Œå¯¼è‡´è¢«æ·˜æ±°ã€‚æ¯”å¦‚æœ‰ä¸€éƒ¨æ–°å‰§ä¸Šçº¿ï¼Œåœ¨æœ€å¼€å§‹å…¶å®æ˜¯æ²¡æœ‰è®¿é—®é¢‘ç‡çš„ï¼Œé˜²æ­¢ä¸Šçº¿ä¹‹åè¢«å…¶ä»–ç¼“å­˜æ·˜æ±°å‡ºå»ï¼Œè€ŒåŠ å…¥è¿™ä¸ªåŒºåŸŸã€‚ä¼Šç”¸åŒºï¼Œæœ€èˆ’æœæœ€å®‰é€¸çš„åŒºåŸŸï¼Œåœ¨è¿™é‡Œå¾ˆéš¾è¢«å…¶ä»–æ•°æ®æ·˜æ±°ã€‚ Probationé˜Ÿåˆ—:å«åšç¼“åˆ‘é˜Ÿåˆ—ï¼Œåœ¨è¿™ä¸ªé˜Ÿåˆ—å°±ä»£è¡¨ä½ çš„æ•°æ®ç›¸å¯¹æ¯”è¾ƒå†·ï¼Œé©¬ä¸Šå°±è¦è¢«æ·˜æ±°äº†ã€‚è¿™ä¸ªæœ‰æ•ˆå¤§å°ä¸ºsizeå‡å»edenå‡å»protectedã€‚ Protectedé˜Ÿåˆ—:åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¯ä»¥ç¨å¾®æ”¾å¿ƒä¸€ä¸‹äº†ï¼Œä½ æš‚æ—¶ä¸ä¼šè¢«æ·˜æ±°ï¼Œä½†æ˜¯åˆ«æ€¥ï¼Œå¦‚æœProbationé˜Ÿåˆ—æ²¡æœ‰æ•°æ®äº†æˆ–è€…Protectedæ•°æ®æ»¡äº†ï¼Œä½ ä¹Ÿå°†ä¼šè¢«é¢ä¸´æ·˜æ±°çš„å°´å°¬å±€é¢ã€‚å½“ç„¶æƒ³è¦å˜æˆè¿™ä¸ªé˜Ÿåˆ—ï¼Œéœ€è¦æŠŠProbationè®¿é—®ä¸€æ¬¡ä¹‹åï¼Œå°±ä¼šæå‡ä¸ºProtectedé˜Ÿåˆ—ã€‚è¿™ä¸ªæœ‰æ•ˆå¤§å°ä¸º(sizeå‡å»eden) X 80% å¦‚æœsize =100ï¼Œå°±ä¼šæ˜¯79ã€‚  è¿™ä¸‰ä¸ªé˜Ÿåˆ—å…³ç³»å¦‚ä¸‹:\n æ‰€æœ‰çš„æ–°æ•°æ®éƒ½ä¼šè¿›å…¥Edenã€‚ Edenæ»¡äº†ï¼Œæ·˜æ±°è¿›å…¥Probationã€‚ å¦‚æœåœ¨Probationä¸­è®¿é—®äº†å…¶ä¸­æŸä¸ªæ•°æ®ï¼Œåˆ™è¿™ä¸ªæ•°æ®å‡çº§ä¸ºProtectedã€‚ å¦‚æœProtectedæ»¡äº†åˆä¼šç»§ç»­é™çº§ä¸ºProbationã€‚  å¯¹äºå‘ç”Ÿæ•°æ®æ·˜æ±°çš„æ—¶å€™ï¼Œä¼šä»Probationä¸­è¿›è¡Œæ·˜æ±°ã€‚ä¼šæŠŠè¿™ä¸ªé˜Ÿåˆ—ä¸­çš„æ•°æ®é˜Ÿå¤´ç§°ä¸ºå—å®³è€…ï¼Œè¿™ä¸ªé˜Ÿå¤´è‚¯å®šæ˜¯æœ€æ—©è¿›å…¥çš„ï¼ŒæŒ‰ç…§LRUé˜Ÿåˆ—çš„ç®—æ³•çš„è¯é‚£ä»–å…¶å®ä»–å°±åº”è¯¥è¢«æ·˜æ±°ï¼Œä½†æ˜¯åœ¨è¿™é‡Œåªèƒ½å«ä»–å—å®³è€…ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯ç¼“åˆ‘é˜Ÿåˆ—ï¼Œä»£è¡¨é©¬ä¸Šè¦ç»™ä»–è¡Œåˆ‘äº†ã€‚è¿™é‡Œä¼šå–å‡ºé˜Ÿå°¾å«å€™é€‰è€…ï¼Œä¹Ÿå«æ”»å‡»è€…ã€‚è¿™é‡Œå—å®³è€…ä¼šå’Œæ”»å‡»è€…çš‡åŸPKå†³å‡ºæˆ‘ä»¬åº”è¯¥è¢«æ·˜æ±°çš„ã€‚\né€šè¿‡æˆ‘ä»¬çš„Count-Min Sketchä¸­çš„è®°å½•çš„é¢‘ç‡æ•°æ®æœ‰ä»¥ä¸‹å‡ ä¸ªåˆ¤æ–­:\n  å¦‚æœæ”»å‡»è€…å¤§äºå—å®³è€…ï¼Œé‚£ä¹ˆå—å®³è€…å°±ç›´æ¥è¢«æ·˜æ±°ã€‚\n  å¦‚æœæ”»å‡»è€…\u0026lt;=5ï¼Œé‚£ä¹ˆç›´æ¥æ·˜æ±°æ”»å‡»è€…ã€‚è¿™ä¸ªé€»è¾‘åœ¨ä»–çš„æ³¨é‡Šä¸­æœ‰è§£é‡Š:\nä»–è®¤ä¸ºè®¾ç½®ä¸€ä¸ªé¢„çƒ­çš„é—¨æ§›ä¼šè®©æ•´ä½“å‘½ä¸­ç‡æ›´é«˜ã€‚\n  å…¶ä»–æƒ…å†µï¼Œéšæœºæ·˜æ±°ã€‚\n  4. å¼‚æ­¥é«˜æ€§èƒ½è¯»å†™ åœ¨guava cacheä¸­æˆ‘ä»¬è¯´è¿‡å…¶è¯»å†™æ“ä½œä¸­å¤¹æ‚ç€è¿‡æœŸæ—¶é—´çš„å¤„ç†ï¼Œä¹Ÿå°±æ˜¯ä½ åœ¨ä¸€æ¬¡Putæ“ä½œä¸­æœ‰å¯èƒ½è¿˜ä¼šåšæ·˜æ±°æ“ä½œï¼Œè™½ç„¶ Guava Cache å·§å¦™åœ°åˆ©ç”¨äº† JDK çš„ ConcurrentHashMapï¼ˆåˆ†æ®µé”æˆ–è€…æ— é” CASï¼‰æ¥é™ä½é”çš„å¯†åº¦ï¼Œè¾¾åˆ°æé«˜å¹¶å‘åº¦çš„ç›®çš„ï¼Œä½†æ˜¯ï¼Œå¯¹äºä¸€äº›çƒ­ç‚¹æ•°æ®ï¼Œè¿™ç§åšæ³•è¿˜æ˜¯é¿å…ä¸äº†é¢‘ç¹çš„é”ç«äº‰ï¼Œæ‰€ä»¥å…¶è¯»å†™æ€§èƒ½ä¼šå—åˆ°ä¸€å®šå½±å“ï¼Œå¯ä»¥çœ‹ä¸Šé¢çš„å›¾ä¸­ï¼Œcaffeineçš„ç¡®åœ¨è¯»å†™æ“ä½œä¸Šé¢å®Œçˆ†guava cacheã€‚ä¸»è¦æ˜¯å› ä¸ºåœ¨caffeineï¼Œå¯¹è¿™äº›äº‹ä»¶çš„æ“ä½œæ˜¯é€šè¿‡å¼‚æ­¥æ“ä½œï¼Œä»–å°†äº‹ä»¶æäº¤è‡³é˜Ÿåˆ—ï¼Œè¿™é‡Œçš„é˜Ÿåˆ—çš„æ•°æ®ç»“æ„æ˜¯RingBuffer,ä¸æ¸…æ¥šçš„å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ,ä½ åº”è¯¥çŸ¥é“çš„é«˜æ€§èƒ½æ— é”é˜Ÿåˆ—Disruptor\rã€‚ç„¶åä¼šé€šè¿‡é»˜è®¤çš„ForkJoinPool.commonPool()ï¼Œæˆ–è€…è‡ªå·±é…ç½®çº¿ç¨‹æ± ï¼Œè¿›è¡Œå–é˜Ÿåˆ—æ“ä½œï¼Œç„¶ååœ¨è¿›è¡Œåç»­çš„æ·˜æ±°ï¼Œè¿‡æœŸæ“ä½œã€‚\n5. æ€»ç»“ Caffeine æ˜¯ä¸€ä¸ªä¼˜ç§€çš„æœ¬åœ°ç¼“å­˜ï¼Œé€šè¿‡ä½¿ç”¨ W-TinyLFU ç®—æ³•ï¼Œ åŸºäºDisruptorçš„å¼‚æ­¥é«˜æ€§èƒ½è¯»å†™ï¼Œä½¿å¾—å®ƒæ‹¥æœ‰é«˜æ€§èƒ½ï¼Œé«˜å‘½ä¸­ç‡ï¼ˆnear optimalï¼‰ï¼Œä½å†…å­˜å ç”¨ç­‰ç‰¹ç‚¹ã€‚\nå‚è€ƒ æ·±å…¥è§£å¯†æ¥è‡ªæœªæ¥çš„ç¼“å­˜-Caffeine\rä¸‡å­—è¯¦è§£æœ¬åœ°ç¼“å­˜ä¹‹ç‹ Caffeine çš„é«˜æ€§èƒ½è®¾è®¡ä¹‹é“\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/caffeine/","series":["Manual"],"tags":["CS"],"title":"Caffeine"},{"categories":["å…¶ä»–"],"content":"Centos Linuxæ¸…ç†ç£ç›˜ç©ºé—´\n df -hl æŸ¥çœ‹å æ¯”  [root@VM-0-12-centos apioak-document]# df -hl Filesystem Size Used Avail Use% Mounted on devtmpfs 1.9G 0 1.9G 0% /dev tmpfs 1.9G 24K 1.9G 1% /dev/shm tmpfs 1.9G 788K 1.9G 1% /run tmpfs 1.9G 0 1.9G 0% /sys/fs/cgroup /dev/vda1 50G 48G 0 100% / tmpfs 379M 0 379M 0% /run/user/0 overlay 50G 48G 0 100% /var/lib/docker/overlay2/b3b7c9bcd6a086d488f5ca533ec7fc934f863340e4efa40513c354f3a13c6ccd/merged shm 64M 0 64M 0% /var/lib/docker/containers/76627689f39c84201d3554e95cf7a8ca53bc53f660fbf1127d86c49db2a67591/mounts/shm overlay 50G 48G 0 100% /var/lib/docker/overlay2/f3fac618fb01637e586b483c87d9075d1cb08bee9c9d1f3afffd0a012394b067/merged shm 64M 0 64M 0% /var/lib/docker/containers/36172ef8f5a337d595f41fda4a2e7864b333278a9d2102b700d7f2a6f47c52a8/mounts/shm åœ¨æ ¹ç›®å½•æ‰§è¡Œdu -sh *  [root@VM-0-12-centos /]# du -sh * 0\tbin 147M\tboot 987M\tdata 0\tdev 6.5G\tdocker 39M\tetc 4.0K\thome 0\tlib 0\tlib64 16K\tlost+found 4.0K\tmedia 4.0K\tmnt 20K\topt du: cannot access â€˜proc/31203/task/31203/fd/4â€™: No such file or directory du: cannot access â€˜proc/31203/task/31203/fdinfo/4â€™: No such file or directory du: cannot access â€˜proc/31203/fd/4â€™: No such file or directory du: cannot access â€˜proc/31203/fdinfo/4â€™: No such file or directory 0\tproc 1.6G\troot 788K\trun 0\tsbin 4.0K\tsrv 0\tsys 181M\ttmp 7.4G\tusr 31G\tvar cdåˆ°ç©ºé—´å ç”¨å¤§çš„ç›®å½•ç»§ç»­æ‰§è¡Œdu -sh *  [root@VM-0-12-centos var]# du -sh * 4.0K\tadm 131M\tcache 4.0K\tcrash 20K\tdb 8.0K\tempty 4.0K\tgames 4.0K\tgopher 12K\tkerberos 27G\tlib 4.0K\tlocal 0\tlock 4.5G\tlog 0\tmail 4.0K\tnis 4.0K\topt 4.0K\tpreserve 0\trun 124K\tspool 24K\ttmp 4.0K\typ æ¸…é™¤å ç”¨å¤§çš„log\nå‚è€ƒï¼š\nCentos Linux æ€ä¹ˆæ¸…ç†ç£ç›˜å ç”¨ç©ºé—´å¤§ï¼š/dev/xvda1\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/centos-linux%E6%B8%85%E7%90%86%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4/","series":["Manual"],"tags":["Other"],"title":"Centos Linuxæ¸…ç†ç£ç›˜ç©ºé—´"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‚è€ƒ MySQLä¹‹charã€varcharå’Œtextçš„è®¾è®¡\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mysql/charvarchartext%E5%8C%BA%E5%88%AB/","series":["Manual"],"tags":["MySQL"],"title":"charã€varcharã€textåŒºåˆ«"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"åˆ—å¼å­˜å‚¨ä¼˜åŠ¿   å½“æŸ¥è¯¢è¯­å¥åªæ¶‰åŠéƒ¨åˆ†åˆ—æ—¶ï¼Œåªéœ€è¦æ‰«æç›¸å…³çš„åˆ—\n  æ¯ä¸€åˆ—çš„æ•°æ®éƒ½æ˜¯ç›¸åŒç±»å‹çš„ï¼Œå½¼æ­¤é—´ç›¸å…³æ€§æ›´å¤§ï¼Œå¯¹åˆ—æ•°æ®å‹ç¼©çš„æ•ˆç‡è¾ƒé«˜\n  å‚è€ƒ â€œè¡Œå¼å­˜å‚¨â€å’Œâ€œåˆ—å¼å­˜å‚¨â€çš„åŒºåˆ«\rä»€ä¹ˆæ˜¯ClickHouseï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/clickhouse/clickhouse%E7%BB%BC%E6%9C%AF/","series":["Manual"],"tags":["ClickHouse"],"title":"ClickHouseç»¼è¿°"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1ã€ runAsync å’Œ supplyAsyncæ–¹æ³• CompletableFuture æä¾›äº†å››ä¸ªé™æ€æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚\npublic static CompletableFuture\u0026lt;Void\u0026gt; runAsync(Runnable runnable) public static CompletableFuture\u0026lt;Void\u0026gt; runAsync(Runnable runnable, Executor executor) public static \u0026lt;U\u0026gt; CompletableFuture\u0026lt;U\u0026gt; supplyAsync(Supplier\u0026lt;U\u0026gt; supplier) public static \u0026lt;U\u0026gt; CompletableFuture\u0026lt;U\u0026gt; supplyAsync(Supplier\u0026lt;U\u0026gt; supplier, Executor executor) æ²¡æœ‰æŒ‡å®šExecutorçš„æ–¹æ³•ä¼šä½¿ç”¨ForkJoinPool.commonPool() ä½œä¸ºå®ƒçš„çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥ä»£ç ã€‚å¦‚æœæŒ‡å®šçº¿ç¨‹æ± ï¼Œåˆ™ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± è¿è¡Œã€‚ä»¥ä¸‹æ‰€æœ‰çš„æ–¹æ³•éƒ½ç±»åŒã€‚\n runAsyncæ–¹æ³•ä¸æ”¯æŒè¿”å›å€¼ã€‚ supplyAsyncå¯ä»¥æ”¯æŒè¿”å›å€¼ã€‚  ç¤ºä¾‹ //æ— è¿”å›å€¼ public static void runAsync() throws Exception { CompletableFuture\u0026lt;Void\u0026gt; future = CompletableFuture.runAsync(() -\u0026gt; { try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { } System.out.println(\u0026#34;run end ...\u0026#34;); }); future.get(); } //æœ‰è¿”å›å€¼ public static void supplyAsync() throws Exception { CompletableFuture\u0026lt;Long\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { } System.out.println(\u0026#34;run end ...\u0026#34;); return System.currentTimeMillis(); }); long time = future.get(); System.out.println(\u0026#34;time = \u0026#34;+time); } 2ã€è®¡ç®—ç»“æœå®Œæˆæ—¶çš„å›è°ƒæ–¹æ³• å½“CompletableFutureçš„è®¡ç®—ç»“æœå®Œæˆï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œå¯ä»¥æ‰§è¡Œç‰¹å®šçš„Actionã€‚ä¸»è¦æ˜¯ä¸‹é¢çš„æ–¹æ³•ï¼š\npublic CompletableFuture\u0026lt;T\u0026gt; whenComplete(BiConsumer\u0026lt;? super T,? super Throwable\u0026gt; action) public CompletableFuture\u0026lt;T\u0026gt; whenCompleteAsync(BiConsumer\u0026lt;? super T,? super Throwable\u0026gt; action) public CompletableFuture\u0026lt;T\u0026gt; whenCompleteAsync(BiConsumer\u0026lt;? super T,? super Throwable\u0026gt; action, Executor executor) public CompletableFuture\u0026lt;T\u0026gt; exceptionally(Function\u0026lt;Throwable,? extends T\u0026gt; fn) å¯ä»¥çœ‹åˆ°Actionçš„ç±»å‹æ˜¯BiConsumer\u0026lt;? super T,? super Throwable\u0026gt;å®ƒå¯ä»¥å¤„ç†æ­£å¸¸çš„è®¡ç®—ç»“æœï¼Œæˆ–è€…å¼‚å¸¸æƒ…å†µã€‚\nwhenComplete å’Œ whenCompleteAsync çš„åŒºåˆ«ï¼š whenCompleteï¼šæ˜¯æ‰§è¡Œå½“å‰ä»»åŠ¡çš„çº¿ç¨‹æ‰§è¡Œç»§ç»­æ‰§è¡Œ whenComplete çš„ä»»åŠ¡ã€‚ whenCompleteAsyncï¼šæ˜¯æ‰§è¡ŒæŠŠ whenCompleteAsync è¿™ä¸ªä»»åŠ¡ç»§ç»­æäº¤ç»™çº¿ç¨‹æ± æ¥è¿›è¡Œæ‰§è¡Œã€‚\nç¤ºä¾‹ public static void whenComplete() throws Exception { CompletableFuture\u0026lt;Void\u0026gt; future = CompletableFuture.runAsync(() -\u0026gt; { try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { } if(new Random().nextInt()%2\u0026gt;=0) { int i = 12/0; } System.out.println(\u0026#34;run end ...\u0026#34;); }); future.whenComplete(new BiConsumer\u0026lt;Void, Throwable\u0026gt;() { @Override public void accept(Void t, Throwable action) { System.out.println(\u0026#34;æ‰§è¡Œå®Œæˆï¼\u0026#34;); } }); future.exceptionally(new Function\u0026lt;Throwable, Void\u0026gt;() { @Override public Void apply(Throwable t) { System.out.println(\u0026#34;æ‰§è¡Œå¤±è´¥ï¼\u0026#34;+t.getMessage()); return null; } }); TimeUnit.SECONDS.sleep(2); } 3ã€ thenApply æ–¹æ³• å½“ä¸€ä¸ªçº¿ç¨‹ä¾èµ–å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ thenApply æ–¹æ³•æ¥æŠŠè¿™ä¸¤ä¸ªçº¿ç¨‹ä¸²è¡ŒåŒ–ã€‚\npublic \u0026lt;U\u0026gt; CompletableFuture\u0026lt;U\u0026gt; thenApply(Function\u0026lt;? super T,? extends U\u0026gt; fn) public \u0026lt;U\u0026gt; CompletableFuture\u0026lt;U\u0026gt; thenApplyAsync(Function\u0026lt;? super T,? extends U\u0026gt; fn) public \u0026lt;U\u0026gt; CompletableFuture\u0026lt;U\u0026gt; thenApplyAsync(Function\u0026lt;? super T,? extends U\u0026gt; fn, Executor executor) Function\u0026lt;? super T,? extends U\u0026gt; Tï¼šä¸Šä¸€ä¸ªä»»åŠ¡è¿”å›ç»“æœçš„ç±»å‹ Uï¼šå½“å‰ä»»åŠ¡çš„è¿”å›å€¼ç±»å‹\nç¤ºä¾‹ private static void thenApply() throws Exception { CompletableFuture\u0026lt;Long\u0026gt; future = CompletableFuture.supplyAsync(new Supplier\u0026lt;Long\u0026gt;() { @Override public Long get() { long result = new Random().nextInt(100); System.out.println(\u0026#34;result1=\u0026#34;+result); return result; } }).thenApply(new Function\u0026lt;Long, Long\u0026gt;() { @Override public Long apply(Long t) { long result = t*5; System.out.println(\u0026#34;result2=\u0026#34;+result); return result; } }); long result = future.get(); System.out.println(result); } ç¬¬äºŒä¸ªä»»åŠ¡ä¾èµ–ç¬¬ä¸€ä¸ªä»»åŠ¡çš„ç»“æœã€‚\n4ã€ handle æ–¹æ³• handle æ˜¯æ‰§è¡Œä»»åŠ¡å®Œæˆæ—¶å¯¹ç»“æœçš„å¤„ç†ã€‚ handle æ–¹æ³•å’Œ thenApply æ–¹æ³•å¤„ç†æ–¹å¼åŸºæœ¬ä¸€æ ·ã€‚ä¸åŒçš„æ˜¯ handle æ˜¯åœ¨ä»»åŠ¡å®Œæˆåå†æ‰§è¡Œï¼Œè¿˜å¯ä»¥å¤„ç†å¼‚å¸¸çš„ä»»åŠ¡ã€‚thenApply åªå¯ä»¥æ‰§è¡Œæ­£å¸¸çš„ä»»åŠ¡ï¼Œä»»åŠ¡å‡ºç°å¼‚å¸¸åˆ™ä¸æ‰§è¡Œ thenApply æ–¹æ³•ã€‚\npublic \u0026lt;U\u0026gt; CompletionStage\u0026lt;U\u0026gt; handle(BiFunction\u0026lt;? super T, Throwable, ? extends U\u0026gt; fn); public \u0026lt;U\u0026gt; CompletionStage\u0026lt;U\u0026gt; handleAsync(BiFunction\u0026lt;? super T, Throwable, ? extends U\u0026gt; fn); public \u0026lt;U\u0026gt; CompletionStage\u0026lt;U\u0026gt; handleAsync(BiFunction\u0026lt;? super T, Throwable, ? extends U\u0026gt; fn,Executor executor); ç¤ºä¾‹ public static void handle() throws Exception{ CompletableFuture\u0026lt;Integer\u0026gt; future = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int i= 10/0; return new Random().nextInt(10); } }).handle(new BiFunction\u0026lt;Integer, Throwable, Integer\u0026gt;() { @Override public Integer apply(Integer param, Throwable throwable) { int result = -1; if(throwable==null){ result = param * 2; }else{ System.out.println(throwable.getMessage()); } return result; } }); System.out.println(future.get()); } ä»ç¤ºä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨ handle ä¸­å¯ä»¥æ ¹æ®ä»»åŠ¡æ˜¯å¦æœ‰å¼‚å¸¸æ¥è¿›è¡Œåšç›¸åº”çš„åç»­å¤„ç†æ“ä½œã€‚è€Œ thenApply æ–¹æ³•ï¼Œå¦‚æœä¸Šä¸ªä»»åŠ¡å‡ºç°é”™è¯¯ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œ thenApply æ–¹æ³•ã€‚\n5ã€ thenAccept æ¶ˆè´¹å¤„ç†ç»“æœ æ¥æ”¶ä»»åŠ¡çš„å¤„ç†ç»“æœï¼Œå¹¶æ¶ˆè´¹å¤„ç†ï¼Œæ— è¿”å›ç»“æœã€‚\npublic CompletionStage\u0026lt;Void\u0026gt; thenAccept(Consumer\u0026lt;? super T\u0026gt; action); public CompletionStage\u0026lt;Void\u0026gt; thenAcceptAsync(Consumer\u0026lt;? super T\u0026gt; action); public CompletionStage\u0026lt;Void\u0026gt; thenAcceptAsync(Consumer\u0026lt;? super T\u0026gt; action,Executor executor); ç¤ºä¾‹ public static void thenAccept() throws Exception{ CompletableFuture\u0026lt;Void\u0026gt; future = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { return new Random().nextInt(10); } }).thenAccept(integer -\u0026gt; { System.out.println(integer); }); future.get(); } ä»ç¤ºä¾‹ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¯¥æ–¹æ³•åªæ˜¯æ¶ˆè´¹æ‰§è¡Œå®Œæˆçš„ä»»åŠ¡ï¼Œå¹¶å¯ä»¥æ ¹æ®ä¸Šé¢çš„ä»»åŠ¡è¿”å›çš„ç»“æœè¿›è¡Œå¤„ç†ã€‚å¹¶æ²¡æœ‰åç»­çš„è¾“å‡ºæ“ä½œã€‚\n6ã€thenRun æ–¹æ³• è·Ÿ thenAccept æ–¹æ³•ä¸ä¸€æ ·çš„æ˜¯ï¼Œä¸å…³å¿ƒä»»åŠ¡çš„å¤„ç†ç»“æœã€‚åªè¦ä¸Šé¢çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå°±å¼€å§‹æ‰§è¡Œ thenAccept ã€‚\npublic CompletionStage\u0026lt;Void\u0026gt; thenRun(Runnable action); public CompletionStage\u0026lt;Void\u0026gt; thenRunAsync(Runnable action); public CompletionStage\u0026lt;Void\u0026gt; thenRunAsync(Runnable action,Executor executor); ç¤ºä¾‹ public static void thenRun() throws Exception{ CompletableFuture\u0026lt;Void\u0026gt; future = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { return new Random().nextInt(10); } }).thenRun(() -\u0026gt; { System.out.println(\u0026#34;thenRun ...\u0026#34;); }); future.get(); } è¯¥æ–¹æ³•åŒ thenAccept æ–¹æ³•ç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯ä¸Šä¸ªä»»åŠ¡å¤„ç†å®Œæˆåï¼Œå¹¶ä¸ä¼šæŠŠè®¡ç®—çš„ç»“æœä¼ ç»™ thenRun æ–¹æ³•ã€‚åªæ˜¯å¤„ç†ç©ä»»åŠ¡åï¼Œæ‰§è¡Œ thenRun çš„åç»­æ“ä½œã€‚\n7ã€thenCombine åˆå¹¶ä»»åŠ¡ thenCombine ä¼šæŠŠ ä¸¤ä¸ª CompletionStage çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆåï¼ŒæŠŠä¸¤ä¸ªä»»åŠ¡çš„ç»“æœä¸€å—äº¤ç»™ thenCombine æ¥å¤„ç†ã€‚\npublic \u0026lt;U,V\u0026gt; CompletionStage\u0026lt;V\u0026gt; thenCombine(CompletionStage\u0026lt;? extends U\u0026gt; other,BiFunction\u0026lt;? super T,? super U,? extends V\u0026gt; fn); public \u0026lt;U,V\u0026gt; CompletionStage\u0026lt;V\u0026gt; thenCombineAsync(CompletionStage\u0026lt;? extends U\u0026gt; other,BiFunction\u0026lt;? super T,? super U,? extends V\u0026gt; fn); public \u0026lt;U,V\u0026gt; CompletionStage\u0026lt;V\u0026gt; thenCombineAsync(CompletionStage\u0026lt;? extends U\u0026gt; other,BiFunction\u0026lt;? super T,? super U,? extends V\u0026gt; fn,Executor executor); ç¤ºä¾‹ private static void thenCombine() throws Exception { CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(new Supplier\u0026lt;String\u0026gt;() { @Override public String get() { return \u0026#34;hello\u0026#34;; } }); CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(new Supplier\u0026lt;String\u0026gt;() { @Override public String get() { return \u0026#34;hello\u0026#34;; } }); CompletableFuture\u0026lt;String\u0026gt; result = future1.thenCombine(future2, new BiFunction\u0026lt;String, String, String\u0026gt;() { @Override public String apply(String t, String u) { return t+\u0026#34; \u0026#34;+u; } }); System.out.println(result.get()); } 8ã€thenAcceptBoth å½“ä¸¤ä¸ªCompletionStageéƒ½æ‰§è¡Œå®Œæˆåï¼ŒæŠŠç»“æœä¸€å—äº¤ç»™thenAcceptBothæ¥è¿›è¡Œæ¶ˆè€—\npublic \u0026lt;U\u0026gt; CompletionStage\u0026lt;Void\u0026gt; thenAcceptBoth(CompletionStage\u0026lt;? extends U\u0026gt; other,BiConsumer\u0026lt;? super T, ? super U\u0026gt; action); public \u0026lt;U\u0026gt; CompletionStage\u0026lt;Void\u0026gt; thenAcceptBothAsync(CompletionStage\u0026lt;? extends U\u0026gt; other,BiConsumer\u0026lt;? super T, ? super U\u0026gt; action); public \u0026lt;U\u0026gt; CompletionStage\u0026lt;Void\u0026gt; thenAcceptBothAsync(CompletionStage\u0026lt;? extends U\u0026gt; other,BiConsumer\u0026lt;? super T, ? super U\u0026gt; action, Executor executor); ç¤ºä¾‹ private static void thenAcceptBoth() throws Exception { CompletableFuture\u0026lt;Integer\u0026gt; f1 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f1=\u0026#34;+t); return t; } }); CompletableFuture\u0026lt;Integer\u0026gt; f2 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f2=\u0026#34;+t); return t; } }); f1.thenAcceptBoth(f2, new BiConsumer\u0026lt;Integer, Integer\u0026gt;() { @Override public void accept(Integer t, Integer u) { System.out.println(\u0026#34;f1=\u0026#34;+t+\u0026#34;;f2=\u0026#34;+u+\u0026#34;;\u0026#34;); } }); } 9ã€applyToEither æ–¹æ³• ä¸¤ä¸ªCompletionStageï¼Œè°æ‰§è¡Œè¿”å›çš„ç»“æœå¿«ï¼Œæˆ‘å°±ç”¨é‚£ä¸ªCompletionStageçš„ç»“æœè¿›è¡Œä¸‹ä¸€æ­¥çš„è½¬åŒ–æ“ä½œã€‚\npublic \u0026lt;U\u0026gt; CompletionStage\u0026lt;U\u0026gt; applyToEither(CompletionStage\u0026lt;? extends T\u0026gt; other,Function\u0026lt;? super T, U\u0026gt; fn); public \u0026lt;U\u0026gt; CompletionStage\u0026lt;U\u0026gt; applyToEitherAsync(CompletionStage\u0026lt;? extends T\u0026gt; other,Function\u0026lt;? super T, U\u0026gt; fn); public \u0026lt;U\u0026gt; CompletionStage\u0026lt;U\u0026gt; applyToEitherAsync(CompletionStage\u0026lt;? extends T\u0026gt; other,Function\u0026lt;? super T, U\u0026gt; fn,Executor executor); ç¤ºä¾‹ private static void applyToEither() throws Exception { CompletableFuture\u0026lt;Integer\u0026gt; f1 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f1=\u0026#34; + t); return t; } }); CompletableFuture\u0026lt;Integer\u0026gt; f2 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f2=\u0026#34; + t); return t; } }); CompletableFuture\u0026lt;Integer\u0026gt; result = f1.applyToEither(f2, new Function\u0026lt;Integer, Integer\u0026gt;() { @Override public Integer apply(Integer t) { System.out.println(t); return t * 2; } }); System.out.println(result.get()); //ç­‰å¾…è¾ƒæ…¢çš„é‚£ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•  try { TimeUnit.SECONDS.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); } } 10ã€acceptEither æ–¹æ³• ä¸¤ä¸ªCompletionStageï¼Œè°æ‰§è¡Œè¿”å›çš„ç»“æœå¿«ï¼Œæˆ‘å°±ç”¨é‚£ä¸ªCompletionStageçš„ç»“æœè¿›è¡Œä¸‹ä¸€æ­¥çš„æ¶ˆè€—æ“ä½œã€‚\npublic CompletionStage\u0026lt;Void\u0026gt; acceptEither(CompletionStage\u0026lt;? extends T\u0026gt; other,Consumer\u0026lt;? super T\u0026gt; action); public CompletionStage\u0026lt;Void\u0026gt; acceptEitherAsync(CompletionStage\u0026lt;? extends T\u0026gt; other,Consumer\u0026lt;? super T\u0026gt; action); public CompletionStage\u0026lt;Void\u0026gt; acceptEitherAsync(CompletionStage\u0026lt;? extends T\u0026gt; other,Consumer\u0026lt;? super T\u0026gt; action,Executor executor); ç¤ºä¾‹ private static void acceptEither() throws Exception { CompletableFuture\u0026lt;Integer\u0026gt; f1 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f1=\u0026#34;+t); return t; } }); CompletableFuture\u0026lt;Integer\u0026gt; f2 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f2=\u0026#34;+t); return t; } }); CompletableFuture\u0026lt;Void\u0026gt; f3 = f1.acceptEither(f2, new Consumer\u0026lt;Integer\u0026gt;() { @Override public void accept(Integer t) { System.out.println(t); } }); //é˜»å¡ç­‰å¾…ï¼Œé˜²æ­¢f3è¿˜æ²¡æ‰§è¡Œå®Œï¼Œä¸»çº¿ç¨‹å°±å·²ç»é€€å‡ºäº†  //f3.get(); } 11ã€runAfterEither æ–¹æ³• ä¸¤ä¸ªCompletionStageï¼Œä»»ä½•ä¸€ä¸ªå®Œæˆäº†éƒ½ä¼šæ‰§è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œï¼ˆRunnableï¼‰\npublic CompletionStage\u0026lt;Void\u0026gt; runAfterEither(CompletionStage\u0026lt;?\u0026gt; other,Runnable action); public CompletionStage\u0026lt;Void\u0026gt; runAfterEitherAsync(CompletionStage\u0026lt;?\u0026gt; other,Runnable action); public CompletionStage\u0026lt;Void\u0026gt; runAfterEitherAsync(CompletionStage\u0026lt;?\u0026gt; other,Runnable action,Executor executor); ç¤ºä¾‹ private static void runAfterEither() throws Exception { CompletableFuture\u0026lt;Integer\u0026gt; f1 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f1=\u0026#34;+t); return t; } }); CompletableFuture\u0026lt;Integer\u0026gt; f2 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f2=\u0026#34;+t); return t; } }); CompletableFuture\u0026lt;Void\u0026gt; f3 = f1.runAfterEither(f2, new Runnable() { @Override public void run() { System.out.println(\u0026#34;ä¸Šé¢æœ‰ä¸€ä¸ªå·²ç»å®Œæˆäº†ã€‚\u0026#34;); } }); //é˜»å¡ç­‰å¾…ï¼Œé˜²æ­¢f3è¿˜æ²¡æ‰§è¡Œå®Œï¼Œä¸»çº¿ç¨‹å°±å·²ç»é€€å‡ºäº†  //f3.get(); } 12ã€runAfterBoth ä¸¤ä¸ªCompletionStageï¼Œéƒ½å®Œæˆäº†è®¡ç®—æ‰ä¼šæ‰§è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œï¼ˆRunnableï¼‰\npublic CompletionStage\u0026lt;Void\u0026gt; runAfterBoth(CompletionStage\u0026lt;?\u0026gt; other,Runnable action); public CompletionStage\u0026lt;Void\u0026gt; runAfterBothAsync(CompletionStage\u0026lt;?\u0026gt; other,Runnable action); public CompletionStage\u0026lt;Void\u0026gt; runAfterBothAsync(CompletionStage\u0026lt;?\u0026gt; other,Runnable action,Executor executor); ç¤ºä¾‹ private static void runAfterBoth() throws Exception { CompletableFuture\u0026lt;Integer\u0026gt; f1 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f1=\u0026#34;+t); return t; } }); CompletableFuture\u0026lt;Integer\u0026gt; f2 = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(3); try { TimeUnit.SECONDS.sleep(t); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;f2=\u0026#34;+t); return t; } }); CompletableFuture\u0026lt;Void\u0026gt; f3 = f1.runAfterBoth(f2, new Runnable() { @Override public void run() { System.out.println(\u0026#34;ä¸Šé¢ä¸¤ä¸ªä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆäº†ã€‚\u0026#34;); } }); //é˜»å¡ç­‰å¾…ï¼Œé˜²æ­¢f3è¿˜æ²¡æ‰§è¡Œå®Œï¼Œä¸»çº¿ç¨‹å°±å·²ç»é€€å‡ºäº†  //f3.get(); } 13ã€thenCompose æ–¹æ³• thenCompose æ–¹æ³•å…è®¸ä½ å¯¹ä¸¤ä¸ª CompletionStage è¿›è¡Œæµæ°´çº¿æ“ä½œï¼Œç¬¬ä¸€ä¸ªæ“ä½œå®Œæˆæ—¶ï¼Œå°†å…¶ç»“æœä½œä¸ºå‚æ•°ä¼ é€’ç»™ç¬¬äºŒä¸ªæ“ä½œã€‚\npublic \u0026lt;U\u0026gt; CompletableFuture\u0026lt;U\u0026gt; thenCompose(Function\u0026lt;? super T, ? extends CompletionStage\u0026lt;U\u0026gt;\u0026gt; fn); public \u0026lt;U\u0026gt; CompletableFuture\u0026lt;U\u0026gt; thenComposeAsync(Function\u0026lt;? super T, ? extends CompletionStage\u0026lt;U\u0026gt;\u0026gt; fn) ; public \u0026lt;U\u0026gt; CompletableFuture\u0026lt;U\u0026gt; thenComposeAsync(Function\u0026lt;? super T, ? extends CompletionStage\u0026lt;U\u0026gt;\u0026gt; fn, Executor executor) ; ç¤ºä¾‹ private static void thenCompose() throws Exception { CompletableFuture\u0026lt;String\u0026gt; f = CompletableFuture.supplyAsync(new Supplier\u0026lt;Integer\u0026gt;() { @Override public Integer get() { int t = new Random().nextInt(10); System.out.println(\u0026#34;t1=\u0026#34;+t); return t; } }).thenCompose(new Function\u0026lt;Integer, CompletionStage\u0026lt;String\u0026gt;\u0026gt;() { @Override public CompletionStage\u0026lt;String\u0026gt; apply(Integer param) { return CompletableFuture.supplyAsync(new Supplier\u0026lt;String\u0026gt;() { @Override public String get() { int t = param *2; System.out.println(\u0026#34;t2=\u0026#34;+t); return t +\u0026#34;\u0026#34;; } }); } }); System.out.println(\u0026#34;thenCompose result : \u0026#34;+f.get()); } å‚è€ƒï¼š CompletableFuture ä½¿ç”¨è¯¦è§£\rç¼–ç¨‹è€å¸æœºå¸¦ä½ ç©è½¬ CompletableFuture å¼‚æ­¥ç¼–ç¨‹\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/completablefuture%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/","series":["Manual"],"tags":["Java"],"title":"CompletableFutureä½¿ç”¨è¯¦è§£"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"JAVA æ‹¾é— â€” CPU Cache ä¸ç¼“å­˜è¡Œ\ræ—¢ç„¶CPUæœ‰ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰ï¼Œä¸ºä»€ä¹ˆJMMè¿˜éœ€è¦volatileå…³é”®å­—ï¼Ÿ\rCPUç¼“å­˜è¡Œ\rJavaå†…å­˜è®¿é—®é‡æ’åºçš„ç ”ç©¶\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/cpu%E7%BC%93%E5%AD%98%E8%A1%8C/","series":["Manual"],"tags":["CS"],"title":"CPUç¼“å­˜è¡Œ"},{"categories":["å…¶ä»–"],"content":"CSSä¸­å†…è”SVG\nå†…è”SVGæ¯”å†…è”å›¾åƒçš„base64æ•ˆæœæ›´å¥½ï¼Œå›¾ç‰‡æ›´åŠ ä¿çœŸï¼š\n.icon-arrow-down { width: 20px; height: 20px; background: url(\u0026#39;data:image/svg+xml;utf8,\u0026lt;svg version=\u0026#34;1.1\u0026#34; xmlns=\u0026#34;http://www.w3.org/2000/svg\u0026#34; width=\u0026#34;200\u0026#34; height=\u0026#34;200\u0026#34; viewBox=\u0026#34;0 0 200 200\u0026#34;\u0026gt;\u0026lt;path fill=\u0026#34;#00A5E0\u0026#34; d=\u0026#34;M145.659,68.949c-5.101-5.208-13.372-5.208-18.473,0L99.479,97.233 L71.772,68.949c-5.1-5.208-13.371-5.208-18.473,0c-5.099,5.208-5.099,13.648,0,18.857l46.18,47.14l46.181-47.14 C150.759,82.598,150.759,74.157,145.659,68.949z\u0026#34;/\u0026gt;\u0026lt;/svg\u0026gt;\u0026#39;) no-repeat center; background-size: 100%; } ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/css%E4%B8%AD%E5%86%85%E8%81%94svg/","series":["Manual"],"tags":["Other"],"title":"CSSä¸­å†…è”SVG"},{"categories":["å…¶ä»–"],"content":"docker-compose.ymlæ–‡ä»¶è¯¦è§£\nComposeå’ŒDockerå…¼å®¹æ€§ï¼š Compose æ–‡ä»¶æ ¼å¼æœ‰3ä¸ªç‰ˆæœ¬,åˆ†åˆ«ä¸º1, 2.x å’Œ 3.x ç›®å‰ä¸»æµçš„ä¸º 3.x å…¶æ”¯æŒ docker 1.13.0 åŠå…¶ä»¥ä¸Šçš„ç‰ˆæœ¬ å¸¸ç”¨å‚æ•°ï¼š version  # æŒ‡å®š compose æ–‡ä»¶çš„ç‰ˆæœ¬ services  # å®šä¹‰æ‰€æœ‰çš„ service ä¿¡æ¯, services ä¸‹é¢çš„ç¬¬ä¸€çº§åˆ«çš„ key æ—¢æ˜¯ä¸€ä¸ª service çš„åç§° build  # æŒ‡å®šåŒ…å«æ„å»ºä¸Šä¸‹æ–‡çš„è·¯å¾„, æˆ–ä½œä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å…·æœ‰ context å’ŒæŒ‡å®šçš„ dockerfile æ–‡ä»¶ä»¥åŠ args å‚æ•°å€¼ context # context: æŒ‡å®š Dockerfile æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ dockerfile # dockerfile: æŒ‡å®š context æŒ‡å®šçš„ç›®å½•ä¸‹é¢çš„ Dockerfile çš„åç§°(é»˜è®¤ä¸º Dockerfile) args # args: Dockerfile åœ¨ build è¿‡ç¨‹ä¸­éœ€è¦çš„å‚æ•° (ç­‰åŒäº docker container build --build-arg çš„ä½œç”¨) cache_from  # v3.2ä¸­æ–°å¢çš„å‚æ•°, æŒ‡å®šç¼“å­˜çš„é•œåƒåˆ—è¡¨ (ç­‰åŒäº docker container build --cache_from çš„ä½œç”¨) labels  # v3.3ä¸­æ–°å¢çš„å‚æ•°, è®¾ç½®é•œåƒçš„å…ƒæ•°æ® (ç­‰åŒäº docker container build --labels çš„ä½œç”¨) shm_size  # v3.5ä¸­æ–°å¢çš„å‚æ•°, è®¾ç½®å®¹å™¨ /dev/shm åˆ†åŒºçš„å¤§å° (ç­‰åŒäº docker container build --shm-size çš„ä½œç”¨) command  # è¦†ç›–å®¹å™¨å¯åŠ¨åé»˜è®¤æ‰§è¡Œçš„å‘½ä»¤, æ”¯æŒ shell æ ¼å¼å’Œ [] æ ¼å¼ configs  # ä¸çŸ¥é“æ€ä¹ˆç”¨ cgroup_parent  # ä¸çŸ¥é“æ€ä¹ˆç”¨ container_name  # æŒ‡å®šå®¹å™¨çš„åç§° (ç­‰åŒäº docker run --name çš„ä½œç”¨) credential_spec  # ä¸çŸ¥é“æ€ä¹ˆç”¨ deploy  # v3 ç‰ˆæœ¬ä»¥ä¸Š, æŒ‡å®šä¸éƒ¨ç½²å’Œè¿è¡ŒæœåŠ¡ç›¸å…³çš„é…ç½®, deploy éƒ¨åˆ†æ˜¯ docker stack ä½¿ç”¨çš„, docker stack ä¾èµ– docker swarm endpoint_mode  # v3.3 ç‰ˆæœ¬ä¸­æ–°å¢çš„åŠŸèƒ½, æŒ‡å®šæœåŠ¡æš´éœ²çš„æ–¹å¼ vip  # Docker ä¸ºè¯¥æœåŠ¡åˆ†é…äº†ä¸€ä¸ªè™šæ‹Ÿ IP(VIP), ä½œä¸ºå®¢æˆ·ç«¯çš„è®¿é—®æœåŠ¡çš„åœ°å€ dnsrr  # DNSè½®è¯¢, Docker ä¸ºè¯¥æœåŠ¡è®¾ç½® DNS æ¡ç›®, ä½¿å¾—æœåŠ¡åç§°çš„ DNS æŸ¥è¯¢è¿”å›ä¸€ä¸ª IP åœ°å€åˆ—è¡¨, å®¢æˆ·ç«¯ç›´æ¥è®¿é—®å…¶ä¸­çš„ä¸€ä¸ªåœ°å€ labels  # æŒ‡å®šæœåŠ¡çš„æ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾ä»…åœ¨æœåŠ¡ä¸Šè®¾ç½® mode  # æŒ‡å®š deploy çš„æ¨¡å¼ global  # æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹éƒ½åªæœ‰ä¸€ä¸ªå®¹å™¨ replicated  # ç”¨æˆ·å¯ä»¥æŒ‡å®šé›†ç¾¤ä¸­å®¹å™¨çš„æ•°é‡(é»˜è®¤) placement  # ä¸çŸ¥é“æ€ä¹ˆç”¨ replicas  # deploy çš„ mode ä¸º replicated æ—¶, æŒ‡å®šå®¹å™¨å‰¯æœ¬çš„æ•°é‡ resources  # èµ„æºé™åˆ¶ limits  # è®¾ç½®å®¹å™¨çš„èµ„æºé™åˆ¶ cpus: \u0026#34;0.5\u0026#34; # è®¾ç½®è¯¥å®¹å™¨æœ€å¤šåªèƒ½ä½¿ç”¨ 50% çš„ CPU  memory: 50M  # è®¾ç½®è¯¥å®¹å™¨æœ€å¤šåªèƒ½ä½¿ç”¨ 50M çš„å†…å­˜ç©ºé—´  reservations  # è®¾ç½®ä¸ºå®¹å™¨é¢„ç•™çš„ç³»ç»Ÿèµ„æº(éšæ—¶å¯ç”¨) cpus: \u0026#34;0.2\u0026#34; # ä¸ºè¯¥å®¹å™¨ä¿ç•™ 20% çš„ CPU memory: 20M  # ä¸ºè¯¥å®¹å™¨ä¿ç•™ 20M çš„å†…å­˜ç©ºé—´ restart_policy  # å®šä¹‰å®¹å™¨é‡å¯ç­–ç•¥, ç”¨äºä»£æ›¿ restart å‚æ•° condition  # å®šä¹‰å®¹å™¨é‡å¯ç­–ç•¥(æ¥å—ä¸‰ä¸ªå‚æ•°) none  # ä¸å°è¯•é‡å¯ on-failure  # åªæœ‰å½“å®¹å™¨å†…éƒ¨åº”ç”¨ç¨‹åºå‡ºç°é—®é¢˜æ‰ä¼šé‡å¯ any  # æ— è®ºå¦‚ä½•éƒ½ä¼šå°è¯•é‡å¯(é»˜è®¤) delay  # å°è¯•é‡å¯çš„é—´éš”æ—¶é—´(é»˜è®¤ä¸º 0s) max_attempts  # å°è¯•é‡å¯æ¬¡æ•°(é»˜è®¤ä¸€ç›´å°è¯•é‡å¯) window  # æ£€æŸ¥é‡å¯æ˜¯å¦æˆåŠŸä¹‹å‰çš„ç­‰å¾…æ—¶é—´(å³å¦‚æœå®¹å™¨å¯åŠ¨äº†, éš”å¤šå°‘ç§’ä¹‹åå»æ£€æµ‹å®¹å™¨æ˜¯å¦æ­£å¸¸, é»˜è®¤ 0s) update_config  # ç”¨äºé…ç½®æ»šåŠ¨æ›´æ–°é…ç½® parallelism  # ä¸€æ¬¡æ€§æ›´æ–°çš„å®¹å™¨æ•°é‡ delay  # æ›´æ–°ä¸€ç»„å®¹å™¨ä¹‹é—´çš„é—´éš”æ—¶é—´ failure_action  # å®šä¹‰æ›´æ–°å¤±è´¥çš„ç­–ç•¥ continue  # ç»§ç»­æ›´æ–° rollback  # å›æ»šæ›´æ–° pause  # æš‚åœæ›´æ–°(é»˜è®¤) monitor # æ¯æ¬¡æ›´æ–°åçš„æŒç»­æ—¶é—´ä»¥ç›‘è§†æ›´æ–°æ˜¯å¦å¤±è´¥(å•ä½: ns|us|ms|s|m|h) (é»˜è®¤ä¸º0) max_failure_ratio  # å›æ»šæœŸé—´å®¹å¿çš„å¤±è´¥ç‡(é»˜è®¤å€¼ä¸º0) order  # v3.4 ç‰ˆæœ¬ä¸­æ–°å¢çš„å‚æ•°, å›æ»šæœŸé—´çš„æ“ä½œé¡ºåº stop-first  #æ—§ä»»åŠ¡åœ¨å¯åŠ¨æ–°ä»»åŠ¡ä¹‹å‰åœæ­¢(é»˜è®¤) start-first  #é¦–å…ˆå¯åŠ¨æ–°ä»»åŠ¡, å¹¶ä¸”æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æš‚æ—¶é‡å  rollback_config  # v3.7 ç‰ˆæœ¬ä¸­æ–°å¢çš„å‚æ•°, ç”¨äºå®šä¹‰åœ¨ update_config æ›´æ–°å¤±è´¥çš„å›æ»šç­–ç•¥ parallelism  # ä¸€æ¬¡å›æ»šçš„å®¹å™¨æ•°, å¦‚æœè®¾ç½®ä¸º0, åˆ™æ‰€æœ‰å®¹å™¨åŒæ—¶å›æ»š delay  # æ¯ä¸ªç»„å›æ»šä¹‹é—´çš„æ—¶é—´é—´éš”(é»˜è®¤ä¸º0) failure_action  # å®šä¹‰å›æ»šå¤±è´¥çš„ç­–ç•¥ continue  # ç»§ç»­å›æ»š pause  # æš‚åœå›æ»š monitor # æ¯æ¬¡å›æ»šä»»åŠ¡åçš„æŒç»­æ—¶é—´ä»¥ç›‘è§†å¤±è´¥(å•ä½: ns|us|ms|s|m|h) (é»˜è®¤ä¸º0) max_failure_ratio  # å›æ»šæœŸé—´å®¹å¿çš„å¤±è´¥ç‡(é»˜è®¤å€¼0) order  # å›æ»šæœŸé—´çš„æ“ä½œé¡ºåº stop-first  # æ—§ä»»åŠ¡åœ¨å¯åŠ¨æ–°ä»»åŠ¡ä¹‹å‰åœæ­¢(é»˜è®¤) start-first  # é¦–å…ˆå¯åŠ¨æ–°ä»»åŠ¡, å¹¶ä¸”æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æš‚æ—¶é‡å  æ³¨æ„ï¼š æ”¯æŒ docker-compose up å’Œ docker-compose run ä½†ä¸æ”¯æŒ docker stack deploy çš„å­é€‰é¡¹ security_opt container_name devices tmpfs stop_signal links cgroup_parent network_mode external_links restart build userns_mode sysctls devices  # æŒ‡å®šè®¾å¤‡æ˜ å°„åˆ—è¡¨ (ç­‰åŒäº docker run --device çš„ä½œç”¨) depends_on  # å®šä¹‰å®¹å™¨å¯åŠ¨é¡ºåº (æ­¤é€‰é¡¹è§£å†³äº†å®¹å™¨ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œ æ­¤é€‰é¡¹åœ¨ v3 ç‰ˆæœ¬ä¸­ ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) ç¤ºä¾‹ï¼š docker-compose up ä»¥ä¾èµ–é¡ºåºå¯åŠ¨æœåŠ¡ï¼Œä¸‹é¢ä¾‹å­ä¸­ redis å’Œ db æœåŠ¡åœ¨ web å¯åŠ¨å‰å¯åŠ¨ é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ docker-compose up web è¿™æ ·çš„æ–¹å¼å¯åŠ¨ web æœåŠ¡æ—¶ï¼Œä¹Ÿä¼šå¯åŠ¨ redis å’Œ db ä¸¤ä¸ªæœåŠ¡ï¼Œå› ä¸ºåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†ä¾èµ–å…³ç³» version: \u0026#39;3\u0026#39; services: web: build: . depends_on: - db  - redis  redis: image: redis db: image: postgres  dns  # è®¾ç½® DNS åœ°å€(ç­‰åŒäº docker run --dns çš„ä½œç”¨) dns_search  # è®¾ç½® DNS æœç´¢åŸŸ(ç­‰åŒäº docker run --dns-search çš„ä½œç”¨) tmpfs  # v2 ç‰ˆæœ¬ä»¥ä¸Š, æŒ‚è½½ç›®å½•åˆ°å®¹å™¨ä¸­, ä½œä¸ºå®¹å™¨çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ(ç­‰åŒäº docker run --tmpfs çš„ä½œç”¨, åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) entrypoint  # è¦†ç›–å®¹å™¨çš„é»˜è®¤ entrypoint æŒ‡ä»¤ (ç­‰åŒäº docker run --entrypoint çš„ä½œç”¨) env_file  # ä»æŒ‡å®šæ–‡ä»¶ä¸­è¯»å–å˜é‡è®¾ç½®ä¸ºå®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡, å¯ä»¥æ˜¯å•ä¸ªå€¼æˆ–è€…ä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨, å¦‚æœå¤šä¸ªæ–‡ä»¶ä¸­çš„å˜é‡é‡ååˆ™åé¢çš„å˜é‡è¦†ç›–å‰é¢çš„å˜é‡, environment çš„å€¼è¦†ç›– env_file çš„å€¼ æ–‡ä»¶æ ¼å¼ï¼š RACK_ENV=development  environment  # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œ environment çš„å€¼å¯ä»¥è¦†ç›– env_file çš„å€¼ (ç­‰åŒäº docker run --env çš„ä½œç”¨) expose  # æš´éœ²ç«¯å£, ä½†æ˜¯ä¸èƒ½å’Œå®¿ä¸»æœºå»ºç«‹æ˜ å°„å…³ç³», ç±»ä¼¼äº Dockerfile çš„ EXPOSE æŒ‡ä»¤ external_links  # è¿æ¥ä¸åœ¨ docker-compose.yml ä¸­å®šä¹‰çš„å®¹å™¨æˆ–è€…ä¸åœ¨ compose ç®¡ç†çš„å®¹å™¨(docker run å¯åŠ¨çš„å®¹å™¨, åœ¨ v3 ç‰ˆæœ¬ä¸­ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) extra_hosts  # æ·»åŠ  host è®°å½•åˆ°å®¹å™¨ä¸­çš„ /etc/hosts ä¸­ (ç­‰åŒäº docker run --add-host çš„ä½œç”¨) healthcheck  # v2.1 ä»¥ä¸Šç‰ˆæœ¬, å®šä¹‰å®¹å™¨å¥åº·çŠ¶æ€æ£€æŸ¥, ç±»ä¼¼äº Dockerfile çš„ HEALTHCHECK æŒ‡ä»¤ è®¡ç®—æœºç§‘å­¦  # æ£€æŸ¥å®¹å™¨æ£€æŸ¥çŠ¶æ€çš„å‘½ä»¤, è¯¥é€‰é¡¹å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…åˆ—è¡¨, ç¬¬ä¸€é¡¹å¿…é¡»æ˜¯ NONE, CMD æˆ– CMD-SHELL, å¦‚æœå…¶æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ™ç›¸å½“äº CMD-SHELL åŠ è¯¥å­—ç¬¦ä¸² NONE  # ç¦ç”¨å®¹å™¨çš„å¥åº·çŠ¶æ€æ£€æµ‹ CMD # è®¡ç®—æœºç§‘å­¦: [\u0026#34;CMD\u0026#34;, \u0026#34;curl\u0026#34;, \u0026#34;-f\u0026#34;, \u0026#34;http://localhost\u0026#34;] CMD-SHELL # è®¡ç®—æœºç§‘å­¦: [\u0026#34;CMD-SHELL\u0026#34;, \u0026#34;curl -f http://localhost || exit 1\u0026#34;] æˆ–è€…ã€€è®¡ç®—æœºç§‘å­¦: curl -f https://localhost || exit 1 interval: 1m30s  # æ¯æ¬¡æ£€æŸ¥ä¹‹é—´çš„é—´éš”æ—¶é—´ timeout: 10s  # è¿è¡Œå‘½ä»¤çš„è¶…æ—¶æ—¶é—´ retries: 3 # é‡è¯•æ¬¡æ•° start_period: 40s  # v3.4 ä»¥ä¸Šæ–°å¢çš„é€‰é¡¹, å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶é—´é—´éš” disable: true # true æˆ– false, è¡¨ç¤ºæ˜¯å¦ç¦ç”¨å¥åº·çŠ¶æ€æ£€æµ‹å’Œã€€è®¡ç®—æœºç§‘å­¦: NONE ç›¸åŒ image  # æŒ‡å®š docker é•œåƒ, å¯ä»¥æ˜¯è¿œç¨‹ä»“åº“é•œåƒã€æœ¬åœ°é•œåƒ init  # v3.7 ä¸­æ–°å¢çš„å‚æ•°, true æˆ– false è¡¨ç¤ºæ˜¯å¦åœ¨å®¹å™¨ä¸­è¿è¡Œä¸€ä¸ª init, å®ƒæ¥æ”¶ä¿¡å·å¹¶ä¼ é€’ç»™è¿›ç¨‹ isolation  # éš”ç¦»å®¹å™¨æŠ€æœ¯, åœ¨ Linux ä¸­ä»…æ”¯æŒ default å€¼ labels  # ä½¿ç”¨ Docker æ ‡ç­¾å°†å…ƒæ•°æ®æ·»åŠ åˆ°å®¹å™¨, ä¸ Dockerfile ä¸­çš„ LABELS ç±»ä¼¼ links  # é“¾æ¥åˆ°å…¶å®ƒæœåŠ¡ä¸­çš„å®¹å™¨, è¯¥é€‰é¡¹æ˜¯ docker å†å²é—ç•™çš„é€‰é¡¹, ç›®å‰å·²è¢«ç”¨æˆ·è‡ªå®šä¹‰ç½‘ç»œåç§°ç©ºé—´å–ä»£, æœ€ç»ˆæœ‰å¯èƒ½è¢«åºŸå¼ƒ (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) logging  # è®¾ç½®å®¹å™¨æ—¥å¿—æœåŠ¡ driver  # æŒ‡å®šæ—¥å¿—è®°å½•é©±åŠ¨ç¨‹åº, é»˜è®¤ json-file (ç­‰åŒäº docker run --log-driver çš„ä½œç”¨) options  # æŒ‡å®šæ—¥å¿—çš„ç›¸å…³å‚æ•° (ç­‰åŒäº docker run --log-opt çš„ä½œç”¨) max-size  # è®¾ç½®å•ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤§å°, å½“åˆ°è¾¾è¿™ä¸ªå€¼åä¼šè¿›è¡Œæ—¥å¿—æ»šåŠ¨æ“ä½œ max-file  # æ—¥å¿—æ–‡ä»¶ä¿ç•™çš„æ•°é‡ network_mode  # æŒ‡å®šç½‘ç»œæ¨¡å¼ (ç­‰åŒäº docker run --net çš„ä½œç”¨, åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)  networks  # å°†å®¹å™¨åŠ å…¥æŒ‡å®šç½‘ç»œ (ç­‰åŒäº docker network connect çš„ä½œç”¨), networks å¯ä»¥ä½äº compose æ–‡ä»¶é¡¶çº§é”®å’Œ services é”®çš„äºŒçº§é”® aliases  # åŒä¸€ç½‘ç»œä¸Šçš„å®¹å™¨å¯ä»¥ä½¿ç”¨æœåŠ¡åç§°æˆ–åˆ«åè¿æ¥åˆ°å…¶ä¸­ä¸€ä¸ªæœåŠ¡çš„å®¹å™¨ ipv4_address  # IP V4 æ ¼å¼ ipv6_address  # IP V6 æ ¼å¼ ç¤ºä¾‹: version: \u0026#39;3.7\u0026#39; services: test: image: nginx:1.14-alpine container_name: mynginx command: ifconfig networks: app_net: # è°ƒç”¨ä¸‹é¢ networks å®šä¹‰çš„ app_net ç½‘ç»œ ipv4_address: 172.16.238.10 networks: app_net: driver: bridge ipam: driver: default config: - subnet: 172.16.238.0/24 pid: \u0026#39;host\u0026#39; # å…±äº«å®¿ä¸»æœºçš„ è¿›ç¨‹ç©ºé—´(PID) ports  # å»ºç«‹å®¿ä¸»æœºå’Œå®¹å™¨ä¹‹é—´çš„ç«¯å£æ˜ å°„å…³ç³», ports æ”¯æŒä¸¤ç§è¯­æ³•æ ¼å¼ SHORT è¯­æ³•æ ¼å¼ç¤ºä¾‹: - \u0026#34;3000\u0026#34; # æš´éœ²å®¹å™¨çš„ 3000 ç«¯å£, å®¿ä¸»æœºçš„ç«¯å£ç”± docker éšæœºæ˜ å°„ä¸€ä¸ªæ²¡æœ‰è¢«å ç”¨çš„ç«¯å£ - \u0026#34;3000-3005\u0026#34; # æš´éœ²å®¹å™¨çš„ 3000 åˆ° 3005 ç«¯å£, å®¿ä¸»æœºçš„ç«¯å£ç”± docker éšæœºæ˜ å°„æ²¡æœ‰è¢«å ç”¨çš„ç«¯å£ - \u0026#34;8000:8000\u0026#34; # å®¹å™¨çš„ 8000 ç«¯å£å’Œå®¿ä¸»æœºçš„ 8000 ç«¯å£å»ºç«‹æ˜ å°„å…³ç³» - \u0026#34;9090-9091:8080-8081\u0026#34; - \u0026#34;127.0.0.1:8001:8001\u0026#34; # æŒ‡å®šæ˜ å°„å®¿ä¸»æœºçš„æŒ‡å®šåœ°å€çš„ - \u0026#34;127.0.0.1:5000-5010:5000-5010\u0026#34; - \u0026#34;6060:6060/udp\u0026#34; # æŒ‡å®šåè®® LONG è¯­æ³•æ ¼å¼ç¤ºä¾‹:(v3.2 æ–°å¢çš„è¯­æ³•æ ¼å¼) ports: - target: 80 # å®¹å™¨ç«¯å£ published: 8080 # å®¿ä¸»æœºç«¯å£ protocol: tcp  # åè®®ç±»å‹ mode: host  # host åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå‘å¸ƒä¸»æœºç«¯å£, ingress å¯¹äºç¾¤æ¨¡å¼ç«¯å£è¿›è¡Œè´Ÿè½½å‡è¡¡ secrets  # ä¸çŸ¥é“æ€ä¹ˆç”¨ security_opt  # ä¸ºæ¯ä¸ªå®¹å™¨è¦†ç›–é»˜è®¤çš„æ ‡ç­¾ (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) stop_grace_period  # æŒ‡å®šåœ¨å‘é€äº† SIGTERM ä¿¡å·ä¹‹å, å®¹å™¨ç­‰å¾…å¤šå°‘ç§’ä¹‹åé€€å‡º(é»˜è®¤ 10s) stop_signal  # æŒ‡å®šåœæ­¢å®¹å™¨å‘é€çš„ä¿¡å· (é»˜è®¤ä¸º SIGTERM ç›¸å½“äº kill PID; SIGKILL ç›¸å½“äº kill -9 PID; åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) sysctls  # è®¾ç½®å®¹å™¨ä¸­çš„å†…æ ¸å‚æ•° (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) ulimits  # è®¾ç½®å®¹å™¨çš„ limit userns_mode  # å¦‚æœDockerå®ˆæŠ¤ç¨‹åºé…ç½®äº†ç”¨æˆ·åç§°ç©ºé—´, åˆ™ç¦ç”¨æ­¤æœåŠ¡çš„ç”¨æˆ·åç§°ç©ºé—´ (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) volumes  # å®šä¹‰å®¹å™¨å’Œå®¿ä¸»æœºçš„å·æ˜ å°„å…³ç³», å…¶å’Œ networks ä¸€æ ·å¯ä»¥ä½äº services é”®çš„äºŒçº§é”®å’Œ compose é¡¶çº§é”®, å¦‚æœéœ€è¦è·¨æœåŠ¡é—´ä½¿ç”¨åˆ™åœ¨é¡¶çº§é”®å®šä¹‰, åœ¨ services ä¸­å¼•ç”¨ SHORT è¯­æ³•æ ¼å¼ç¤ºä¾‹: volumes: - /var/lib/mysql  # æ˜ å°„å®¹å™¨å†…çš„ /var/lib/mysql åˆ°å®¿ä¸»æœºçš„ä¸€ä¸ªéšæœºç›®å½•ä¸­ - /opt/data:/var/lib/mysql  # æ˜ å°„å®¹å™¨å†…çš„ /var/lib/mysql åˆ°å®¿ä¸»æœºçš„ /opt/data - ./cache:/tmp/cache  # æ˜ å°„å®¹å™¨å†…çš„ /var/lib/mysql åˆ°å®¿ä¸»æœº compose æ–‡ä»¶æ‰€åœ¨çš„ä½ç½® - ~/configs:/etc/configs/:ro  # æ˜ å°„å®¹å™¨å®¿ä¸»æœºçš„ç›®å½•åˆ°å®¹å™¨ä¸­å», æƒé™åªè¯» - datavolume:/var/lib/mysql  # datavolume ä¸º volumes é¡¶çº§é”®å®šä¹‰çš„ç›®å½•, åœ¨æ­¤å¤„ç›´æ¥è°ƒç”¨ LONG è¯­æ³•æ ¼å¼ç¤ºä¾‹:(v3.2 æ–°å¢çš„è¯­æ³•æ ¼å¼) version: \u0026#34;3.2\u0026#34; services: web: image: nginx:alpine ports: - \u0026#34;80:80\u0026#34; volumes: - type: volume  # mount çš„ç±»å‹, å¿…é¡»æ˜¯ bindã€volume æˆ– tmpfs source: mydata  # å®¿ä¸»æœºç›®å½• target: /data  # å®¹å™¨ç›®å½• volume: # é…ç½®é¢å¤–çš„é€‰é¡¹, å…¶ key å¿…é¡»å’Œ type çš„å€¼ç›¸åŒ nocopy: true # volume é¢å¤–çš„é€‰é¡¹, åœ¨åˆ›å»ºå·æ—¶ç¦ç”¨ä»å®¹å™¨å¤åˆ¶æ•°æ® - type: bind  # volume æ¨¡å¼åªæŒ‡å®šå®¹å™¨è·¯å¾„å³å¯, å®¿ä¸»æœºè·¯å¾„éšæœºç”Ÿæˆ; bind éœ€è¦æŒ‡å®šå®¹å™¨å’Œæ•°æ®æœºçš„æ˜ å°„è·¯å¾„ source: ./static target: /opt/app/static read_only: true # è®¾ç½®æ–‡ä»¶ç³»ç»Ÿä¸ºåªè¯»æ–‡ä»¶ç³»ç»Ÿ volumes: mydata: # å®šä¹‰åœ¨ volume, å¯åœ¨æ‰€æœ‰æœåŠ¡ä¸­è°ƒç”¨ restart  # å®šä¹‰å®¹å™¨é‡å¯ç­–ç•¥(åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹, åœ¨ swarm ä½¿ç”¨ restart_policy ä»£æ›¿ restart) no # ç¦æ­¢è‡ªåŠ¨é‡å¯å®¹å™¨(é»˜è®¤) always  # æ— è®ºå¦‚ä½•å®¹å™¨éƒ½ä¼šé‡å¯ on-failure  # å½“å‡ºç° on-failure æŠ¥é”™æ—¶, å®¹å™¨é‡æ–°å¯åŠ¨ å…¶ä»–é€‰é¡¹ï¼š domainname, hostname, ipc, mac_address, privileged, read_only, shm_size, stdin_open, tty, user, working_dir ä¸Šé¢è¿™äº›é€‰é¡¹éƒ½åªæ¥å—å•ä¸ªå€¼å’Œ docker run çš„å¯¹åº”å‚æ•°ç±»ä¼¼ å¯¹äºå€¼ä¸ºæ—¶é—´çš„å¯æ¥å—çš„å€¼ï¼š 2.5s 10s 1m30s 2h32m 5h34m56s æ—¶é—´å•ä½: us, ms, s, mï¼Œ h å¯¹äºå€¼ä¸ºå¤§å°çš„å¯æ¥å—çš„å€¼ï¼š 2b 1024kb 2048k 300m 1gb å•ä½: b, k, m, g æˆ–è€… kb, mb, gb networks  # å®šä¹‰ networks ä¿¡æ¯ driver  # æŒ‡å®šç½‘ç»œæ¨¡å¼, å¤§å¤šæ•°æƒ…å†µä¸‹, å®ƒ bridge äºå•ä¸ªä¸»æœºå’Œ overlay Swarm ä¸Š bridge  # Docker é»˜è®¤ä½¿ç”¨ bridge è¿æ¥å•ä¸ªä¸»æœºä¸Šçš„ç½‘ç»œ overlay  # overlay é©±åŠ¨ç¨‹åºåˆ›å»ºä¸€ä¸ªè·¨å¤šä¸ªèŠ‚ç‚¹å‘½åçš„ç½‘ç»œ host  # å…±äº«ä¸»æœºç½‘ç»œåç§°ç©ºé—´(ç­‰åŒäº docker run --net=host) none  # ç­‰åŒäº docker run --net=none driver_opts  # v3.2ä»¥ä¸Šç‰ˆæœ¬, ä¼ é€’ç»™é©±åŠ¨ç¨‹åºçš„å‚æ•°, è¿™äº›å‚æ•°å–å†³äºé©±åŠ¨ç¨‹åº attachable  # driver ä¸º overlay æ—¶ä½¿ç”¨, å¦‚æœè®¾ç½®ä¸º true åˆ™é™¤äº†æœåŠ¡ä¹‹å¤–ï¼Œç‹¬ç«‹å®¹å™¨ä¹Ÿå¯ä»¥é™„åŠ åˆ°è¯¥ç½‘ç»œ; å¦‚æœç‹¬ç«‹å®¹å™¨è¿æ¥åˆ°è¯¥ç½‘ç»œï¼Œåˆ™å®ƒå¯ä»¥ä¸å…¶ä»– Docker å®ˆæŠ¤è¿›ç¨‹è¿æ¥åˆ°çš„è¯¥ç½‘ç»œçš„æœåŠ¡å’Œç‹¬ç«‹å®¹å™¨è¿›è¡Œé€šä¿¡ ipam  # è‡ªå®šä¹‰ IPAM é…ç½®. è¿™æ˜¯ä¸€ä¸ªå…·æœ‰å¤šä¸ªå±æ€§çš„å¯¹è±¡, æ¯ä¸ªå±æ€§éƒ½æ˜¯å¯é€‰çš„ driver  # IPAM é©±åŠ¨ç¨‹åº, bridge æˆ–è€… default config  # é…ç½®é¡¹ subnet  # CIDRæ ¼å¼çš„å­ç½‘ï¼Œè¡¨ç¤ºè¯¥ç½‘ç»œçš„ç½‘æ®µ external  # å¤–éƒ¨ç½‘ç»œ, å¦‚æœè®¾ç½®ä¸º true åˆ™ docker-compose up ä¸ä¼šå°è¯•åˆ›å»ºå®ƒ, å¦‚æœå®ƒä¸å­˜åœ¨åˆ™å¼•å‘é”™è¯¯ name  # v3.5 ä»¥ä¸Šç‰ˆæœ¬, ä¸ºæ­¤ç½‘ç»œè®¾ç½®åç§° æ–‡ä»¶æ ¼å¼ç¤ºä¾‹ï¼š version: \u0026#34;3\u0026#34; services: redis: image: redis:alpine ports: - \u0026#34;6379\u0026#34; networks: - frontend deploy: replicas: 2 update_config: parallelism: 2 delay: 10s restart_policy: condition: on-failure db: image: postgres:9.4 volumes: - db-data:/var/lib/postgresql/data networks: - backend deploy: placement: constraints: [node.role == manager] ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/docker-compose.yml%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/","series":["Manual"],"tags":["Other"],"title":"docker-compose.ymlæ–‡ä»¶è¯¦è§£"},{"categories":["æŒç»­é›†æˆéƒ¨ç½²"],"content":"docker-composeçš„æ–¹å¼å¯åŠ¨jenkins\njenkinså®˜ç½‘æä¾›äº†å¤šç§å®‰è£…æ–¹å¼ï¼Œå”¯ç‹¬æ²¡æœ‰æä¾›docker composeçš„æ•™ç¨‹ï¼å’±ä¹Ÿä¸çŸ¥é“ä¸ºå•¥ï¼Œæ‰€ä»¥è‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿã€‚\n1. ç¼–å†™docker-compose.yml version: \u0026#39;3\u0026#39; services: jenkins: image: jenkinsci/blueocean container_name: jenkins user: root ports: - \u0026#39;8080:8080\u0026#39; - \u0026#39;50000:50000\u0026#39; volumes: - \u0026#39;/docker/volumes/jenkins:/var/jenkins_home\u0026#39; - \u0026#39;/var/run/docker.sock:/var/run/docker.sock\u0026#39; - \u0026#39;/usr/local/jdk1.8.0_241:/usr/local/jdk1.8.0_241\u0026#39; - \u0026#39;/usr/local/apache-maven-3.6.3:/usr/local/apache-maven-3.6.3\u0026#39; restart: always 2. å¯åŠ¨jenkins docker-compose up -d jenkins \u0026amp;\u0026amp; docker logs -f jenkins ==jenkins å¯åŠ¨æ—¶ï¼Œä¸€ç›´å¤„åœ¨ Please wait while Jenkins is getting ready to work \u0026hellip;== éœ€è¦æ›´æ–°hudson.model.UpdateCenter.xmlçš„urlï¼š\n\u0026lt;?xml version=\u0026#39;1.1\u0026#39; encoding=\u0026#39;UTF-8\u0026#39;?\u0026gt; \u0026lt;sites\u0026gt; \u0026lt;site\u0026gt; \u0026lt;id\u0026gt;default\u0026lt;/id\u0026gt; \u0026lt;url\u0026gt;https://updates.jenkins.io/update-center.json\u0026lt;/url\u0026gt; \u0026lt;/site\u0026gt; \u0026lt;/sites\u0026gt; æ›´æ–°ä¸ºï¼š\n\u0026lt;?xml version=\u0026#39;1.1\u0026#39; encoding=\u0026#39;UTF-8\u0026#39;?\u0026gt; \u0026lt;sites\u0026gt; \u0026lt;site\u0026gt; \u0026lt;id\u0026gt;default\u0026lt;/id\u0026gt; \u0026lt;url\u0026gt;http://mirror.xmission.com/jenkins/updates/update-center.json\u0026lt;/url\u0026gt; \u0026lt;/site\u0026gt; \u0026lt;/sites\u0026gt; ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/cicd/docker-compose%E7%9A%84%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8jenkins/","series":null,"tags":["Jenkins","docker-compose"],"title":"docker-composeçš„æ–¹å¼å¯åŠ¨jenkins"},{"categories":["å…¶ä»–"],"content":"docker-composeçš„æ–¹å¼éƒ¨ç½²wordpress\n å®‰è£…docker  sudo yum install -y yum-utils device-mapper-persistent-data lvm2 sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo sudo yum install docker-ce docker-ce-cli containerd.io  ç¼–å†™docker-compose.yml  mysql: image: mysql:5.7 environment: - MYSQL_ROOT_PASSWORD=123456 - MYSQL_DATABASE=wordpress web: image: wordpress links: - mysql environment: - WORDPRESS_DB_PASSWORD=123456 ports: - \u0026#34;0.0.0.0:8080:80\u0026#34; working_dir: /var/www/html volumes: - wordpress:/var/www/html  å¯åŠ¨docker  sudo systemctl start docker\r è¿è¡Œdocker-compose  docker-compose up å‚è€ƒï¼š\nWhat does \u0026ldquo;local address\u0026rdquo; and \u0026ldquo;foreign address\u0026rdquo; mean in the netstat command result?\rDocker å…¥é—¨æ•™ç¨‹\rDocker å¾®æœåŠ¡æ•™ç¨‹\rWordpress å®¹å™¨åŒ–ã€HTTPSåŒ–å…¨æ”»ç•¥\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/wordpress/docker-compose%E7%9A%84%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2wordpress/","series":["Manual"],"tags":["WordPress"],"title":"docker-composeçš„æ–¹å¼éƒ¨ç½²wordpress"},{"categories":["å…¶ä»–"],"content":"Docker Compose ç½‘ç»œè®¾ç½®\nåŸºæœ¬æ¦‚å¿µ é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompose ä¼šä¸ºæˆ‘ä»¬çš„åº”ç”¨åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼ŒæœåŠ¡çš„æ¯ä¸ªå®¹å™¨éƒ½ä¼šåŠ å…¥è¯¥ç½‘ç»œä¸­ã€‚è¿™æ ·ï¼Œå®¹å™¨å°±å¯è¢«è¯¥ç½‘ç»œä¸­çš„å…¶ä»–å®¹å™¨è®¿é—®ï¼Œä¸ä»…å¦‚æ­¤ï¼Œè¯¥å®¹å™¨è¿˜èƒ½ä»¥æœåŠ¡åç§°ä½œä¸º hostname è¢«å…¶ä»–å®¹å™¨è®¿é—®ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºçš„ç½‘ç»œåç§°åŸºäº Compose çš„å·¥ç¨‹åç§°ï¼Œè€Œé¡¹ç›®åç§°åŸºäº docker-compose.yml æ‰€åœ¨ç›®å½•çš„åç§°ã€‚å¦‚éœ€ä¿®æ”¹å·¥ç¨‹åç§°ï¼Œå¯ä½¿ç”¨\u0026ndash;project-name æ ‡è¯†æˆ– COMPOSE_PORJECT_NAME ç¯å¢ƒå˜é‡ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ä¸€ä¸ªåº”ç”¨ç¨‹åºåœ¨åä¸º myapp çš„ç›®å½•ä¸­ï¼Œå¹¶ä¸” docker-compose.yml å¦‚ä¸‹æ‰€ç¤ºï¼š\nversion: \u0026#39;2\u0026#39; services: web: build: . ports: - \u0026#34;8000:8000\u0026#34; db: image: postgres å½“æˆ‘ä»¬è¿è¡Œ docker-compose up æ—¶ï¼Œå°†ä¼šæ‰§è¡Œä»¥ä¸‹å‡ æ­¥ï¼š\n- åˆ›å»ºä¸€ä¸ªåä¸º myapp_default çš„ç½‘ç»œï¼› - ä½¿ç”¨ web æœåŠ¡çš„é…ç½®åˆ›å»ºå®¹å™¨ï¼Œå®ƒä»¥â€œwebâ€è¿™ä¸ªåç§°åŠ å…¥ç½‘ç»œ myapp_defaultï¼› - ä½¿ç”¨ db æœåŠ¡çš„é…ç½®åˆ›å»ºå®¹å™¨ï¼Œå®ƒä»¥â€œdbâ€è¿™ä¸ªåç§°åŠ å…¥ç½‘ç»œ myapp_defaultã€‚\nå®¹å™¨é—´å¯ä½¿ç”¨æœåŠ¡åç§°ï¼ˆweb æˆ– dbï¼‰ä½œä¸º hostname ç›¸äº’è®¿é—®ã€‚ä¾‹å¦‚ï¼Œweb è¿™ä¸ªæœåŠ¡å¯ä½¿ç”¨postgres://db:5432 è®¿é—® db å®¹å™¨ã€‚\næ›´æ–°å®¹å™¨ å½“æœåŠ¡çš„é…ç½®å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œå¯ä½¿ç”¨ docker-compose up å‘½ä»¤æ›´æ–°é…ç½®ã€‚\næ­¤æ—¶ï¼ŒCompose ä¼šåˆ é™¤æ—§å®¹å™¨å¹¶åˆ›å»ºæ–°å®¹å™¨ã€‚æ–°å®¹å™¨ä¼šä»¥ä¸åŒçš„ IP åœ°å€åŠ å…¥ç½‘ç»œï¼Œåç§°ä¿æŒä¸å˜ã€‚ä»»ä½•æŒ‡å‘æ—§å®¹å™¨çš„è¿æ¥éƒ½ä¼šè¢«å…³é—­ï¼Œå®¹å™¨ä¼šé‡æ–°æ‰¾åˆ°æ–°å®¹å™¨å¹¶è¿æ¥ä¸Šå»ã€‚\nlinks å‰æ–‡è®²è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡ä¹‹é—´å¯ä½¿ç”¨æœåŠ¡åç§°ç›¸äº’è®¿é—®ã€‚links å…è®¸æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåˆ«åï¼Œä»è€Œä½¿ç”¨è¯¥åˆ«åè®¿é—®å…¶ä»–æœåŠ¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š\nversion: \u0026#39;2\u0026#39; services: web: build: . links: - \u0026#34;db:database\u0026#34; db: image: postgres è¿™æ · web æœåŠ¡å°±å¯ä½¿ç”¨ db æˆ– database ä½œä¸º hostname è®¿é—® db æœåŠ¡äº†ã€‚\næŒ‡å®šè‡ªå®šä¹‰ç½‘ç»œ ä¸€äº›åœºæ™¯ä¸‹ï¼Œé»˜è®¤çš„ç½‘ç»œé…ç½®æ»¡è¶³ä¸äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä½¿ç”¨ networks å‘½ä»¤è‡ªå®šä¹‰ç½‘ç»œã€‚networks å‘½ä»¤å…è®¸æˆ‘ä»¬åˆ›å»ºæ›´åŠ å¤æ‚çš„ç½‘ç»œæ‹“æ‰‘å¹¶æŒ‡å®šè‡ªå®šä¹‰ç½‘ç»œé©±åŠ¨å’Œé€‰é¡¹ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜å¯ä½¿ç”¨ networks å°†æœåŠ¡è¿æ¥åˆ°ä¸æ˜¯ç”± Compose ç®¡ç†çš„ã€å¤–éƒ¨åˆ›å»ºçš„ç½‘ç»œã€‚\nå¦‚ä¸‹ï¼Œæˆ‘ä»¬åœ¨å…¶ä¸­å®šä¹‰äº†ä¸¤ä¸ªè‡ªå®šä¹‰ç½‘ç»œã€‚\nversion: \u0026#39;2\u0026#39; services: proxy: build: ./proxy networks: - front app: build: ./app networks: - front - back db: image: postgres networks: - back networks: front: # Use a custom driver driver: custom-driver-1 back: # Use a custom driver which takes special options driver: custom-driver-2 driver_opts: foo: \u0026#34;1\u0026#34; bar: \u0026#34;2\u0026#34; å…¶ä¸­ï¼Œproxy æœåŠ¡ä¸ db æœåŠ¡éš”ç¦»ï¼Œä¸¤è€…åˆ†åˆ«ä½¿ç”¨è‡ªå·±çš„ç½‘ç»œï¼›app æœåŠ¡å¯ä¸ä¸¤è€…é€šä¿¡ã€‚\nç”±æœ¬ä¾‹ä¸éš¾å‘ç°ï¼Œä½¿ç”¨ networks å‘½ä»¤ï¼Œå³å¯æ–¹ä¾¿å®ç°æœåŠ¡é—´çš„ç½‘ç»œéš”ç¦»ä¸è¿æ¥ã€‚\né…ç½®é»˜è®¤ç½‘ç»œ é™¤è‡ªå®šä¹‰ç½‘ç»œå¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä¸ºé»˜è®¤ç½‘ç»œè‡ªå®šä¹‰é…ç½®ã€‚\nversion: \u0026#39;2\u0026#39; services: web: build: . ports: - \u0026#34;8000:8000\u0026#34; db: image: postgres networks: default: # Use a custom driver driver: custom-driver-1 è¿™æ ·ï¼Œå°±å¯ä¸ºè¯¥åº”ç”¨æŒ‡å®šè‡ªå®šä¹‰çš„ç½‘ç»œé©±åŠ¨ã€‚\nä½¿ç”¨å·²å­˜åœ¨çš„ç½‘ç»œ ä¸€äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦åˆ›å»ºæ–°çš„ç½‘ç»œï¼Œè€Œåªéœ€åŠ å…¥å·²å­˜åœ¨çš„ç½‘ç»œï¼Œæ­¤æ—¶å¯ä½¿ç”¨ external é€‰é¡¹ã€‚ç¤ºä¾‹ï¼š\nnetworks: default: external: name: my-pre-existing-network Docker Compose é“¾æ¥å¤–éƒ¨å®¹å™¨çš„å‡ ç§æ–¹å¼ åœ¨ Docker ä¸­ï¼Œå®¹å™¨ä¹‹é—´çš„é“¾æ¥æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ“ä½œï¼šå®ƒæä¾›äº†è®¿é—®å…¶ä¸­çš„æŸä¸ªå®¹å™¨çš„ç½‘ç»œæœåŠ¡è€Œä¸éœ€è¦å°†æ‰€éœ€çš„ç«¯å£æš´éœ²ç»™ Docker Host ä¸»æœºçš„åŠŸèƒ½ã€‚Docker Compose ä¸­å¯¹è¯¥ç‰¹æ€§çš„æ”¯æŒåŒæ ·æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚ç„¶è€Œï¼Œå¦‚æœéœ€è¦é“¾æ¥çš„å®¹å™¨æ²¡æœ‰å®šä¹‰åœ¨åŒä¸€ä¸ªdocker-compose.ymlä¸­çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™å°±ç¨å¾®éº»çƒ¦å¤æ‚äº†ç‚¹ã€‚\nåœ¨ä¸ä½¿ç”¨ Docker Compose çš„æ—¶å€™ï¼Œå°†ä¸¤ä¸ªå®¹å™¨é“¾æ¥èµ·æ¥ä½¿ç”¨â€”linkå‚æ•°ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œä»¥nginxé•œåƒä¸ºä¾‹å­ï¼š\ndocker run --rm --name test1 -d nginx #å¼€å¯ä¸€ä¸ªå®ä¾‹test1 docker run --rm --name test2 --link test1 -d nginx #å¼€å¯ä¸€ä¸ªå®ä¾‹test2å¹¶ä¸test1å»ºç«‹é“¾æ¥ è¿™æ ·ï¼Œtest2ä¸test1ä¾¿å»ºç«‹äº†é“¾æ¥ï¼Œå°±å¯ä»¥åœ¨test2ä¸­ä½¿ç”¨è®¿é—®test1ä¸­çš„æœåŠ¡äº†ã€‚\nå¦‚æœä½¿ç”¨ Docker Composeï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹æƒ…å°±æ›´ç®€å•äº†ï¼Œè¿˜æ˜¯ä»¥ä¸Šé¢çš„nginxé•œåƒä¸ºä¾‹å­ï¼Œç¼–è¾‘docker-compose.ymlæ–‡ä»¶ä¸ºï¼š\nversion: \u0026#34;3\u0026#34; services: test2: image: nginx depends_on: - test1 links: - test1 test1: image: nginx æœ€ç»ˆæ•ˆæœä¸ä½¿ç”¨æ™®é€šçš„ Docker å‘½ä»¤docker run xxxxå»ºç«‹çš„é“¾æ¥å¹¶æ— åŒºåˆ«ã€‚è¿™åªæ˜¯ä¸€ç§æœ€ä¸ºç†æƒ³çš„æƒ…å†µã€‚\n\\1. å¦‚æœå®¹å™¨æ²¡æœ‰å®šä¹‰åœ¨åŒä¸€ä¸ªdocker-compose.ymlæ–‡ä»¶ä¸­ï¼Œåº”è¯¥å¦‚ä½•é“¾æ¥å®ƒä»¬å‘¢ï¼Ÿ \\2. åˆå¦‚æœå®šä¹‰åœ¨docker-compose.ymlæ–‡ä»¶ä¸­çš„å®¹å™¨éœ€è¦ä¸docker run xxxå¯åŠ¨çš„å®¹å™¨é“¾æ¥ï¼Œéœ€è¦å¦‚ä½•å¤„ç†ï¼Ÿ\né’ˆå¯¹è¿™ä¸¤ç§å…¸å‹çš„æƒ…å†µï¼Œä¸‹é¢ç»™å‡ºæˆ‘ä¸ªäººæµ‹è¯•å¯è¡Œçš„åŠæ³•ï¼š\næ–¹å¼ä¸€ï¼šè®©éœ€è¦é“¾æ¥çš„å®¹å™¨åŒå±ä¸€ä¸ªå¤–éƒ¨ç½‘ç»œ æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ nginx é•œåƒæ¥æ¨¡æ‹Ÿè¿™æ ·çš„ä¸€ä¸ªæƒ…æ™¯ï¼šå‡è®¾æˆ‘ä»¬éœ€è¦å°†ä¸¤ä¸ªä½¿ç”¨ Docker Compose ç®¡ç†çš„ nignx å®¹å™¨ï¼ˆtest1å’Œtest2ï¼‰é“¾æ¥èµ·æ¥ï¼Œä½¿å¾—test2èƒ½å¤Ÿè®¿é—®test1ä¸­æä¾›çš„æœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥èƒ½ ping é€šä¸ºå‡†ã€‚\né¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰å®¹å™¨test1çš„docker-compose.ymlæ–‡ä»¶å†…å®¹ä¸ºï¼š\nversion: \u0026#34;3\u0026#34; services: test2: image: nginx container_name: test1 networks: - default - app_net networks: app_net: external: true å®¹å™¨test2å†…å®¹ä¸test1åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªexternal_links,éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼šæœ€è¿‘å‘å¸ƒçš„ Docker ç‰ˆæœ¬å·²ç»ä¸éœ€è¦ä½¿ç”¨ external_links æ¥é“¾æ¥å®¹å™¨ï¼Œå®¹å™¨çš„ DNS æœåŠ¡å¯ä»¥æ­£ç¡®çš„ä½œå‡ºåˆ¤æ–­ï¼Œå› æ­¤å¦‚æœä½ ä½ éœ€è¦å…¼å®¹è¾ƒè€ç‰ˆæœ¬çš„ Docker çš„è¯ï¼Œé‚£ä¹ˆå®¹å™¨test2çš„docker-compose.ymlæ–‡ä»¶å†…å®¹ä¸ºï¼š\nversion: \u0026#34;3\u0026#34; services: test2: image: nginx networks: - default - app_net external_links: - test1 container_name: test2 networks: app_net: external: true å¦åˆ™çš„è¯ï¼Œtest2çš„docker-compose.ymlå’Œtest1çš„å®šä¹‰å®Œå…¨ä¸€è‡´ï¼Œä¸éœ€è¦é¢å¤–å¤šæŒ‡å®šä¸€ä¸ªexternal_linksã€‚ç›¸å…³çš„é—®é¢˜è¯·å‚è§ stackoverflow ä¸Šçš„ç›¸å…³é—®é¢˜ï¼šdocker-compose + external container\ræ­£å¦‚ä½ çœ‹åˆ°çš„é‚£æ ·ï¼Œè¿™é‡Œä¸¤ä¸ªå®¹å™¨çš„å®šä¹‰é‡Œéƒ½ä½¿ç”¨äº†åŒä¸€ä¸ªå¤–éƒ¨ç½‘ç»œapp_net,å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨è¿™ä¸¤ä¸ªå®¹å™¨ä¹‹å‰é€šè¿‡ä»¥ä¸‹å‘½ä»¤å†åˆ›å»ºå¤–éƒ¨ç½‘ç»œï¼š\ndocker network create app_netå¤åˆ¶ä»£ç \nä¹‹åï¼Œé€šè¿‡docker-compose up -då‘½ä»¤å¯åŠ¨è¿™ä¸¤ä¸ªå®¹å™¨ï¼Œç„¶åæ‰§è¡Œdocker exec -it test2 ping test1,ä½ å°†ä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š\ndocker exec -it test2 ping test1 PING test1 (172.18.0.2): 56 data bytes 64 bytes from 172.18.0.2: icmp_seq=0 ttl=64 time=0.091 ms 64 bytes from 172.18.0.2: icmp_seq=1 ttl=64 time=0.146 ms 64 bytes from 172.18.0.2: icmp_seq=2 ttl=64 time=0.150 ms 64 bytes from 172.18.0.2: icmp_seq=3 ttl=64 time=0.145 ms 64 bytes from 172.18.0.2: icmp_seq=4 ttl=64 time=0.126 ms 64 bytes from 172.18.0.2: icmp_seq=5 ttl=64 time=0.147 ms è¯æ˜è¿™ä¸¤ä¸ªå®¹å™¨æ˜¯æˆåŠŸé“¾æ¥äº†ï¼Œåè¿‡æ¥åœ¨test1ä¸­ pingtest2ä¹Ÿæ˜¯èƒ½å¤Ÿæ­£å¸¸ ping é€šçš„ã€‚\nå¦‚æœæˆ‘ä»¬é€šè¿‡docker run --rm --name test3 -d nginxè¿™ç§æ–¹å¼æ¥å…ˆå¯åŠ¨äº†ä¸€ä¸ªå®¹å™¨(test3)å¹¶ä¸”æ²¡æœ‰æŒ‡å®šå®ƒæ‰€å±çš„å¤–éƒ¨ç½‘ç»œï¼Œè€Œéœ€è¦å°†å…¶ä¸test1æˆ–è€…test2é“¾æ¥çš„è¯ï¼Œè¿™ä¸ªæ—¶å€™æ‰‹åŠ¨é“¾æ¥å¤–éƒ¨ç½‘ç»œå³å¯ï¼š\ndocker network connect app_net test3è¿™æ ·ï¼Œä¸‰ä¸ªå®¹å™¨éƒ½å¯ä»¥ç›¸äº’è®¿é—®äº†ã€‚ æ–¹å¼äºŒï¼šæ›´æ”¹éœ€è¦é“¾æ¥çš„å®¹å™¨çš„ç½‘ç»œæ¨¡å¼ é€šè¿‡æ›´æ”¹ä½ æƒ³è¦ç›¸äº’é“¾æ¥çš„å®¹å™¨çš„ç½‘ç»œæ¨¡å¼ä¸ºbridge,å¹¶æŒ‡å®šéœ€è¦é“¾æ¥çš„å¤–éƒ¨å®¹å™¨ï¼ˆexternal_links)å³å¯ã€‚ä¸åŒå±å¤–éƒ¨ç½‘ç»œçš„å®¹å™¨å¯ä»¥ç›¸äº’è®¿é—®çš„é“¾æ¥æ–¹å¼ä¸€ä¸åŒï¼Œè¿™ç§æ–¹å¼çš„è®¿é—®æ˜¯å•å‘çš„ã€‚\nè¿˜æ˜¯ä»¥ nginx å®¹å™¨é•œåƒä¸ºä¾‹å­ï¼Œå¦‚æœå®¹å™¨å®ä¾‹nginx1éœ€è¦è®¿é—®å®¹å™¨å®ä¾‹nginx2ï¼Œé‚£ä¹ˆnginx2çš„doker-compose.ymlå®šä¹‰ä¸ºï¼š\nversion: \u0026#34;3\u0026#34; services: nginx2: image: nginx container_name: nginx2 network_mode: bridge ä¸å…¶å¯¹åº”çš„ï¼Œnginx1çš„docker-compose.ymlå®šä¹‰ä¸ºï¼š\nversion: \u0026#34;3\u0026#34; services: nginx1: image: nginx external_links: - nginx2 container_name: nginx1 network_mode: bridge [v_tips]éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œè¿™é‡Œçš„external_linksæ˜¯ä¸èƒ½çœç•¥çš„ï¼Œè€Œä¸”nginx1çš„å¯åŠ¨å¿…é¡»è¦åœ¨nginx2ä¹‹åï¼Œå¦åˆ™å¯èƒ½ä¼šæŠ¥æ‰¾ä¸åˆ°å®¹å™¨nginx2çš„é”™è¯¯ã€‚[/v_tips]\næ¥ç€æˆ‘ä»¬ä½¿ç”¨ ping æ¥æµ‹è¯•ä¸‹è¿é€šæ€§ï¼š\n$ docker exec -it nginx1 ping nginx2 # nginx1 to nginx2 PING nginx2 (172.17.0.4): 56 data bytes 64 bytes from 172.17.0.4: icmp_seq=0 ttl=64 time=0.141 ms 64 bytes from 172.17.0.4: icmp_seq=1 ttl=64 time=0.139 ms 64 bytes from 172.17.0.4: icmp_seq=2 ttl=64 time=0.145 ms $ docker exec -it nginx2 ping nginx1 #nginx2 to nginx1 ping: unknown host ä»¥ä¸Šä¹Ÿèƒ½å……åˆ†è¯æ˜è¿™ç§æ–¹å¼æ˜¯å±äºå•å‘è”é€šçš„ã€‚\nåœ¨å®é™…åº”ç”¨ä¸­æ ¹æ®è‡ªå·±çš„éœ€è¦çµæ´»çš„é€‰æ‹©è¿™ä¸¤ç§é“¾æ¥æ–¹å¼ï¼Œå¦‚æœæƒ³å·æ‡’çš„è¯ï¼Œå¤§å¯é€‰æ‹©ç¬¬äºŒç§ã€‚ä¸è¿‡æˆ‘æ›´æ¨èç¬¬ä¸€ç§ï¼Œä¸éš¾çœ‹å‡ºæ— è®ºæ˜¯è”é€šæ€§è¿˜æ˜¯çµæ´»æ€§ï¼Œè¾ƒä¸ºæ›´æ”¹ç½‘ç»œæ¨¡å¼çš„ç¬¬äºŒç§éƒ½æ›´ä¸ºå‹å¥½ã€‚ é™„ï¼šdocker-compose.ymlæ–‡ä»¶è¯¦è§£\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/docker-compose%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE/","series":["Manual"],"tags":["Other"],"title":"docker-composeç½‘ç»œè®¾ç½®"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"\u0026lt;properties\u0026gt; \u0026lt;docker.image.prefix\u0026gt;anaham-docker.pkg.coding.net/cereshop/ceres\u0026lt;/docker.image.prefix\u0026gt; \u0026lt;anaham-docker.username\u0026gt;ç”¨æˆ·å\u0026lt;/anaham-docker.username\u0026gt; \u0026lt;anaham-docker.password\u0026gt;å¯†ç \u0026lt;/anaham-docker.password\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;repackage\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;!-- dockeræ‰“åŒ…æ’ä»¶ --\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;com.spotify\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;dockerfile-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${dockerfile-maven-plugin.version}\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;username\u0026gt;${anaham-docker.username}\u0026lt;/username\u0026gt; \u0026lt;password\u0026gt;${anaham-docker.password}\u0026lt;/password\u0026gt; \u0026lt;repository\u0026gt;${docker.image.prefix}/${project.artifactId}\u0026lt;/repository\u0026gt; \u0026lt;tag\u0026gt;${ceres.version}\u0026lt;/tag\u0026gt; \u0026lt;!-- ä¸æŒ‡å®štagé»˜è®¤ä¸ºlatest --\u0026gt; \u0026lt;buildArgs\u0026gt; \u0026lt;JAR_FILE\u0026gt;target/${project.build.finalName}.jar\u0026lt;/JAR_FILE\u0026gt; \u0026lt;/buildArgs\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt;  æ„å»ºé•œåƒ  mvn clean package -Dmaven.è®¡ç®—æœºç§‘å­¦.skip=true dockerfile:build -Ddockerfile.tag=latest å› ä¸ºä¸Šé¢pom.xmlå·²ç»æŒ‡å®šäº†tagï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼šmvn dockerfile:build ä¼šä¼˜å…ˆé€‰æ‹©pom.xmlé…ç½®çš„tag\nä¸Šä¼ é•œåƒ  mvn dockerfile:push -Ddockerfile.username=[é•œåƒä»“åº“è´¦å·] -Ddockerfile.password=[é•œåƒä»“åº“å¯†ç ] å› ä¸ºä¸Šé¢pom.xmlå·²ç»æŒ‡å®šäº†usernameå’Œpasswordï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼šmvn dockerfile:push\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/maven/dockerfile-maven-plugin%E4%BD%BF%E7%94%A8/","series":["Manual"],"tags":["Maven"],"title":"dockerfile-maven-pluginä½¿ç”¨"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. ES çš„åˆ†å¸ƒå¼æ¶æ„åŸç† ElasticSearch è®¾è®¡çš„ç†å¿µå°±æ˜¯åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œåº•å±‚å…¶å®è¿˜æ˜¯åŸºäº lucene çš„ã€‚æ ¸å¿ƒæ€æƒ³å°±æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ª ES è¿›ç¨‹å®ä¾‹ï¼Œç»„æˆäº†ä¸€ä¸ª ES é›†ç¾¤ã€‚\né»˜è®¤èŠ‚ç‚¹ä¼šå»åŠ å…¥ä¸€ä¸ªåç§°ä¸º elasticsearch çš„é›†ç¾¤ã€‚å¦‚æœç›´æ¥å¯åŠ¨ä¸€å †èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒä»¬ä¼šè‡ªåŠ¨ç»„æˆä¸€ä¸ª elasticsearch é›†ç¾¤ï¼Œå½“ç„¶ä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥ç»„æˆ elasticsearch é›†ç¾¤ã€‚\n1.1 ESæ•°æ®ç»“æ„ ES ä¸­å­˜å‚¨æ•°æ®çš„åŸºæœ¬å•ä½æ˜¯ç´¢å¼•ï¼Œæ¯”å¦‚è¯´ä½ ç°åœ¨è¦åœ¨ ES ä¸­å­˜å‚¨ä¸€äº›è®¢å•æ•°æ®ï¼Œä½ å°±åº”è¯¥åœ¨ ES ä¸­åˆ›å»ºä¸€ä¸ªç´¢å¼• order_idx ï¼Œæ‰€æœ‰çš„è®¢å•æ•°æ®å°±éƒ½å†™åˆ°è¿™ä¸ªç´¢å¼•é‡Œé¢å»ï¼Œä¸€ä¸ªç´¢å¼•å·®ä¸å¤šå°±æ˜¯ç›¸å½“äºæ˜¯ mysql é‡Œçš„ä¸€å¼ è¡¨ã€‚\nindex -\u0026gt; type -\u0026gt; mapping -\u0026gt; document -\u0026gt; fieldã€‚\r1.2 ESé«˜å¯ç”¨ ç±»ä¼¼kafkaå°†ä¸€ä¸ªtopicåˆ†æˆå¤šä¸ªpartitionï¼Œeså°†ä¸€ä¸ªindexåˆ†æˆå¤šä¸ªshardã€‚\n æ¯ä¸ª shard å­˜å‚¨éƒ¨åˆ†æ•°æ®ã€‚æ‹†åˆ†å¤šä¸ª shard æ˜¯æœ‰å¥½å¤„çš„ï¼Œä¸€æ˜¯æ”¯æŒæ¨ªå‘æ‰©å±•ï¼Œæ¯”å¦‚ä½ æ•°æ®é‡æ˜¯ 3Tï¼Œ3 ä¸ª shardï¼Œæ¯ä¸ª shard å°± 1T çš„æ•°æ®ï¼Œè‹¥ç°åœ¨æ•°æ®é‡å¢åŠ åˆ° 4Tï¼Œæ€ä¹ˆæ‰©å±•ï¼Œå¾ˆç®€å•ï¼Œé‡æ–°å»ºä¸€ä¸ªæœ‰ 4 ä¸ª shard çš„ç´¢å¼•ï¼Œå°†æ•°æ®å¯¼è¿›å»ï¼›äºŒæ˜¯æé«˜æ€§èƒ½ï¼Œæ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ª shardï¼Œå³å¤šå°æœåŠ¡å™¨ä¸Šï¼Œæ‰€æœ‰çš„æ“ä½œï¼Œéƒ½ä¼šåœ¨å¤šå°æœºå™¨ä¸Šå¹¶è¡Œåˆ†å¸ƒå¼æ‰§è¡Œï¼Œæé«˜äº†ååé‡å’Œæ€§èƒ½ã€‚\n kafkaçš„æ¯ä¸ªpartitionæœ‰å¤šä¸ªreplicaå‰¯æœ¬ï¼Œæ‰€æœ‰å‰¯æœ¬é€‰å‡ºä¸€ä¸ªleaderï¼ˆä¾èµ–zookeeperå®Œæˆé€‰ä¸¾ï¼‰è´Ÿè´£æ‰€æœ‰çš„è¯»å†™è¯·æ±‚ã€‚\nES çš„æ¯ä¸ªshardä¹Ÿå¯ä»¥é…ç½®å¤šä¸ªreplicaå‰¯æœ¬ï¼Œæ¯ä¸ª shard éƒ½æœ‰ä¸€ä¸ª primary shard ï¼Œè´Ÿè´£å†™å…¥æ•°æ®ï¼Œä½†æ˜¯è¿˜æœ‰å‡ ä¸ª replica shard ã€‚ primary shard å†™å…¥æ•°æ®ä¹‹åï¼Œä¼šå°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–å‡ ä¸ª replica shard ä¸Šå»ã€‚\n primary shardï¼ˆå»ºç«‹ç´¢å¼•æ—¶ä¸€æ¬¡è®¾ç½®ï¼Œä¸èƒ½ä¿®æ”¹ï¼Œé»˜è®¤ 5 ä¸ªï¼‰ï¼Œreplica shardï¼ˆéšæ—¶ä¿®æ”¹æ•°é‡ï¼Œé»˜è®¤ 1 ä¸ªï¼‰ï¼Œé»˜è®¤æ¯ä¸ªç´¢å¼• 10 ä¸ª shardï¼Œ5 ä¸ª primary shardï¼Œ5 ä¸ª replica shardï¼Œæœ€å°çš„é«˜å¯ç”¨é…ç½®ï¼Œæ˜¯ 2 å°æœåŠ¡å™¨ã€‚\n ä¸kafka partitionå‰¯æœ¬ä¸åŒçš„æ˜¯ï¼Œesä¸ä»… primary shard èƒ½è¯»å†™ï¼Œreplica shard ä¹Ÿèƒ½è¯»ã€‚\nES é›†ç¾¤å¤šä¸ªèŠ‚ç‚¹ï¼Œä¼šè‡ªåŠ¨é€‰ä¸¾ä¸€ä¸ªèŠ‚ç‚¹ä¸º master èŠ‚ç‚¹ï¼Œè¿™ä¸ª master èŠ‚ç‚¹å…¶å®å°±æ˜¯å¹²ä¸€äº›ç®¡ç†çš„å·¥ä½œçš„ï¼Œæ¯”å¦‚ç»´æŠ¤ç´¢å¼•å…ƒæ•°æ®ã€è´Ÿè´£åˆ‡æ¢ primary shard å’Œ replica shard èº«ä»½ç­‰ã€‚è¦æ˜¯ master èŠ‚ç‚¹å®•æœºäº†ï¼Œé‚£ä¹ˆä¼šé‡æ–°é€‰ä¸¾ä¸€ä¸ªèŠ‚ç‚¹ä¸º master èŠ‚ç‚¹ã€‚\nä¸kafkaä¾èµ–zookeeperå®Œæˆ é€‰ä¸¾ä¸»èŠ‚ç‚¹æœåŠ¡å™¨(controller)ã€ é€‰ä¸¾partition leaderæ–¹å¼ä¸åŒçš„æ˜¯ï¼Œesä¾èµ–è‡ªå·±çš„å®ç°ï¼ˆZenDiscoveryï¼‰å®Œæˆé›†ç¾¤master èŠ‚ç‚¹é€‰ä¸¾ã€primary shardåˆ‡æ¢ ä¸ä¾èµ–ç¬¬ä¸‰æ–¹ç»„ä»¶ã€‚\n ä¸€è‡´æ€§ç®—æ³•ç ”ç©¶(ä¸‰)Kafka\rä½†æ˜¯ï¼Œä¸­é—´è¿‡ç¨‹ä¸­çš„æœºå™¨å®•æœºç­‰æƒ…å†µæ—¶ï¼Œæ€ä¹ˆæ¥ä¿è¯ä¸€è‡´æ€§å‘¢ï¼Ÿ è¿™ä¸ªé—®é¢˜ï¼Œkafkaäº¤ç»™äº†zookeeperæ¥è§£å†³ã€‚kafkaé›†ç¾¤å¯åŠ¨æ—¶ï¼Œä¼šä¾é zookeeperæ¥é€‰ä¸¾ä¸€ä¸ªé›†ç¾¤çš„ä¸»èŠ‚ç‚¹æœåŠ¡å™¨(controller)ï¼Œcontrolleræ¥ç®¡ç†æ•´ä¸ªé›†ç¾¤ï¼Œæ¯”å¦‚é˜Ÿåˆ—çš„åˆ›å»ºã€åˆ é™¤ï¼Œé˜Ÿåˆ—åˆ†åŒºçš„é€‰ä¸»ï¼Œå¦‚å‰è¾¹æ‰€è¯´çš„ï¼ŒtopicAæœ‰3ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºæœ‰3ä¸ªå‰¯æœ¬(replica)ï¼Œåœ¨åˆ›å»ºæ¯ä¸ªåˆ†åŒºæ—¶ï¼Œkafkaä¼šä½¿ç”¨zookeeperæ¥é€‰ä¸¾ä¸€ä¸ªåˆ†åŒºå‰¯æœ¬çš„ä¸»(leader)ã€‚\nä¸€ä¸ªé›†ç¾¤å†…æœ‰ä¸Šåƒä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—éƒ½æœ‰æ•°åä¸ªç”šè‡³æ•°ç™¾ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºåˆä¼šæœ‰è‹¥å¹²ä¸ªå‰¯æœ¬ï¼Œå¤šä¸ªå‰¯æœ¬ä¹‹é—´è°æ˜¯leaderå‰¯æœ¬ï¼Ÿè¿™äº›ä¿¡æ¯ç§°ä¹‹ä¸ºmetadataï¼Œkafkaå…¨éƒ¨å‚¨å­˜åœ¨äº†zookeeperä¸Šã€‚\næ‰€ä»¥æœºå™¨å®•æœºæ—¶ï¼Œcontrollerå’Œleader replicaçš„é€‰ä¸¾ä»»åŠ¡éƒ½äº¤ç»™äº†zookeeperæ¥å®Œæˆï¼Œé‚£ä¹ˆè¿™æ—¶é›†ç¾¤å†…æœºå™¨ä¹‹é—´çš„ä¸€è‡´æ€§ï¼Œåˆ†åŒºå‰¯æœ¬ä¹‹é—´çš„ä¸€è‡´æ€§ï¼Œè¿™äº›å…±è¯†é—®é¢˜éƒ½äº¤ç»™äº†zookeeperæ¥è§£å†³ã€‚æœ‰äº†zookeeperï¼Œé›†ç¾¤å†…æ¯ä¸ªæœºå™¨ä¸ä¼šå¯¹è°æ˜¯controllerå†äº§ç”Ÿåˆ†æ­§ï¼Œæœ‰äº†controllerï¼Œä¸€ä¸ªé›†ç¾¤å°±ä¸€ä¸ªç»Ÿä¸€çš„â€œè´Ÿè´£äººâ€ã€‚åŒæ—¶ï¼Œæ¯ä¸ªåˆ†åŒºçš„å‰¯æœ¬ä¹‹é—´ä½¿ç”¨zookeeperæ¥é€‰ä¸»ï¼Œä¹Ÿä¼šäº§ç”Ÿä¸€ä¸ªâ€œè´Ÿè´£äººâ€ï¼Œæ‰€æœ‰æœºå™¨ï¼Œå¤šä¸ªå‰¯æœ¬ä¹‹é—´éƒ½äº¤ç”±è¿™äº›è´Ÿè´£äººæ¥åè°ƒï¼Œä¸ä¼šå†äº§ç”Ÿåˆ†æ­§ï¼Œè€Œä¸”ä¸ä¼šè„‘è£‚ã€‚\n  Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ(ä¸€)-èŠ‚ç‚¹ç¯‡\ré‚£ä¸ºä»€ä¹ˆESä¸ä½¿ç”¨Zookeeperå‘¢ï¼Œå¤§æ¦‚æ˜¯å®˜æ–¹å¼€å‘è§‰å¾—å¢åŠ Zookeeperä¾èµ–åä¼šå¤šä¾èµ–ä¸€ä¸ªç»„ä»¶ï¼Œä½¿é›†ç¾¤éƒ¨ç½²å˜å¾—æ›´å¤æ‚ï¼Œç”¨æˆ·åœ¨è¿ç»´æ—¶éœ€è¦å¤šè¿ç»´ä¸€ä¸ªZookeeperã€‚\né‚£ä¹ˆåœ¨è‡ªä¸»å®ç°è¿™æ¡è·¯ä¸Šï¼Œè¿˜æœ‰ä»€ä¹ˆåˆ«çš„ç®—æ³•é€‰æ‹©å—ï¼Ÿå½“ç„¶æœ‰çš„ï¼Œæ¯”å¦‚raft\nraftä»æ­£ç¡®æ€§ä¸Šçœ‹è‚¯å®šæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œè€ŒESçš„é€‰ä¸¾ç®—æ³•ç»è¿‡å‡ æ¬¡bug fixä¹Ÿè¶Šæ¥è¶Šåƒraftã€‚å½“ç„¶ï¼Œåœ¨ESæœ€æ—©å¼€å‘æ—¶è¿˜æ²¡æœ‰raftï¼ˆesçš„å‰èº«compassäº2004å¼€æºï¼Œ2010è¿›è¡Œé‡æ„å¹¶æ”¹åä¸ºesï¼Œraftç®—æ³•2012æ‰å‘è¡¨ğŸ˜”ï¼‰ï¼Œè€Œæœªæ¥ESå¦‚æœç»§ç»­æ²¿ç€è¿™ä¸ªæ–¹å‘èµ°å¾ˆå¯èƒ½æœ€ç»ˆå°±å˜æˆä¸€ä¸ªraftå®ç°ã€‚\n 2. ES çš„å·¥ä½œåŸç† 2.1 åº•å±‚ lucene ç®€å•æ¥è¯´ï¼Œlucene å°±æ˜¯ä¸€ä¸ª jar åŒ…ï¼Œé‡Œé¢åŒ…å«äº†å°è£…å¥½çš„å„ç§å»ºç«‹å€’æ’ç´¢å¼•çš„ç®—æ³•ä»£ç ã€‚æˆ‘ä»¬ç”¨ Java å¼€å‘çš„æ—¶å€™ï¼Œå¼•å…¥ lucene jarï¼Œç„¶ååŸºäº lucene çš„ api å»å¼€å‘å°±å¯ä»¥äº†ã€‚\né€šè¿‡ luceneï¼Œæˆ‘ä»¬å¯ä»¥å°†å·²æœ‰çš„æ•°æ®å»ºç«‹ç´¢å¼•ï¼Œlucene ä¼šåœ¨æœ¬åœ°ç£ç›˜ä¸Šé¢ï¼Œç»™æˆ‘ä»¬ç»„ç»‡ç´¢å¼•çš„æ•°æ®ç»“æ„ã€‚\n2.2 å€’æ’ç´¢å¼• åœ¨æœç´¢å¼•æ“ä¸­ï¼Œæ¯ä¸ªæ–‡æ¡£éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„æ–‡æ¡£ IDï¼Œæ–‡æ¡£å†…å®¹è¢«è¡¨ç¤ºä¸ºä¸€ç³»åˆ—å…³é”®è¯çš„é›†åˆã€‚ä¾‹å¦‚ï¼Œæ–‡æ¡£ 1 ç»è¿‡åˆ†è¯ï¼Œæå–äº† 20 ä¸ªå…³é”®è¯ï¼Œæ¯ä¸ªå…³é”®è¯éƒ½ä¼šè®°å½•å®ƒåœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°å’Œå‡ºç°ä½ç½®ã€‚\né‚£ä¹ˆï¼Œå€’æ’ç´¢å¼•å°±æ˜¯å…³é”®è¯åˆ°æ–‡æ¡£ ID çš„æ˜ å°„ï¼Œæ¯ä¸ªå…³é”®è¯éƒ½å¯¹åº”ç€ä¸€ç³»åˆ—çš„æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¸­éƒ½å‡ºç°äº†å…³é”®è¯ã€‚\nä¸¾ä¸ªæ —å­ã€‚\næœ‰ä»¥ä¸‹æ–‡æ¡£ï¼š\n   DocId Doc     1 è°·æ­Œåœ°å›¾ä¹‹çˆ¶è·³æ§½ Facebook   2 è°·æ­Œåœ°å›¾ä¹‹çˆ¶åŠ ç›Ÿ Facebook   3 è°·æ­Œåœ°å›¾åˆ›å§‹äººæ‹‰æ–¯ç¦»å¼€è°·æ­ŒåŠ ç›Ÿ Facebook   4 è°·æ­Œåœ°å›¾ä¹‹çˆ¶è·³æ§½ Facebook ä¸ Wave é¡¹ç›®å–æ¶ˆæœ‰å…³   5 è°·æ­Œåœ°å›¾ä¹‹çˆ¶æ‹‰æ–¯åŠ ç›Ÿç¤¾äº¤ç½‘ç«™ Facebook    å¯¹æ–‡æ¡£è¿›è¡Œåˆ†è¯ä¹‹åï¼Œå¾—åˆ°ä»¥ä¸‹å€’æ’ç´¢å¼•ã€‚\n   WordId Word DocIds     1 è°·æ­Œ 1, 2, 3, 4, 5   2 åœ°å›¾ 1, 2, 3, 4, 5   3 ä¹‹çˆ¶ 1, 2, 4, 5   4 è·³æ§½ 1, 4   5 Facebook 1, 2, 3, 4, 5   6 åŠ ç›Ÿ 2, 3, 5   7 åˆ›å§‹äºº 3   8 æ‹‰æ–¯ 3, 5   9 ç¦»å¼€ 3   10 ä¸ 4   .. .. ..    å¦å¤–ï¼Œå®ç”¨çš„å€’æ’ç´¢å¼•è¿˜å¯ä»¥è®°å½•æ›´å¤šçš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡æ¡£é¢‘ç‡ä¿¡æ¯ï¼Œè¡¨ç¤ºåœ¨æ–‡æ¡£é›†åˆä¸­æœ‰å¤šå°‘ä¸ªæ–‡æ¡£åŒ…å«æŸä¸ªå•è¯ã€‚\né‚£ä¹ˆï¼Œæœ‰äº†å€’æ’ç´¢å¼•ï¼Œæœç´¢å¼•æ“å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å“åº”ç”¨æˆ·çš„æŸ¥è¯¢ã€‚æ¯”å¦‚ç”¨æˆ·è¾“å…¥æŸ¥è¯¢ Facebook ï¼Œæœç´¢ç³»ç»ŸæŸ¥æ‰¾å€’æ’ç´¢å¼•ï¼Œä»ä¸­è¯»å‡ºåŒ…å«è¿™ä¸ªå•è¯çš„æ–‡æ¡£ï¼Œè¿™äº›æ–‡æ¡£å°±æ˜¯æä¾›ç»™ç”¨æˆ·çš„æœç´¢ç»“æœã€‚\nè¦æ³¨æ„å€’æ’ç´¢å¼•çš„ä¸¤ä¸ªé‡è¦ç»†èŠ‚ï¼š\n å€’æ’ç´¢å¼•ä¸­çš„æ‰€æœ‰è¯é¡¹å¯¹åº”ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡æ¡£ï¼› å€’æ’ç´¢å¼•ä¸­çš„è¯é¡¹æ ¹æ®å­—å…¸é¡ºåºå‡åºæ’åˆ—   ä¸Šé¢åªæ˜¯ä¸€ä¸ªç®€å•çš„æ —å­ï¼Œå¹¶æ²¡æœ‰ä¸¥æ ¼æŒ‰ç…§å­—å…¸é¡ºåºå‡åºæ’åˆ—ã€‚\n 3.ES è¯»å†™æ£€ç´¢æ•°æ®çš„è¿‡ç¨‹ 3.1 ES å†™æ•°æ®è¿‡ç¨‹  å®¢æˆ·ç«¯é€‰æ‹©ä¸€ä¸ª node å‘é€è¯·æ±‚è¿‡å»ï¼Œè¿™ä¸ª node å°±æ˜¯ coordinating node ï¼ˆåè°ƒèŠ‚ç‚¹ï¼‰ã€‚ coordinating node å¯¹ document è¿›è¡Œè·¯ç”±ï¼Œå°†è¯·æ±‚è½¬å‘ç»™å¯¹åº”çš„ nodeï¼ˆæœ‰ primary shardï¼‰ã€‚ å®é™…çš„ node ä¸Šçš„ primary shard å¤„ç†è¯·æ±‚ï¼Œç„¶åå°†æ•°æ®åŒæ­¥åˆ° replica node ã€‚ coordinating node å¦‚æœå‘ç° primary node å’Œæ‰€æœ‰ replica node éƒ½æå®šä¹‹åï¼Œå°±è¿”å›å“åº”ç»“æœç»™å®¢æˆ·ç«¯ã€‚  3.2 ES è¯»æ•°æ®è¿‡ç¨‹ GET my-index/_doc/0  Client å°†è¯·æ±‚å‘é€åˆ°ä»»æ„èŠ‚ç‚¹ nodeï¼Œæ­¤æ—¶ node èŠ‚ç‚¹å°±æ˜¯åè°ƒèŠ‚ç‚¹ï¼ˆcoordinating nodeï¼‰ã€‚ åè°ƒèŠ‚ç‚¹å¯¹ id è¿›è¡Œè·¯ç”±ï¼Œä»è€Œåˆ¤æ–­è¯¥æ•°æ®åœ¨å“ªä¸ª shardã€‚ åœ¨ primary shard å’Œ replica shard ä¹‹é—´ éšæœºé€‰æ‹©ä¸€ä¸ªï¼Œè¯·æ±‚è·å– docã€‚ æ¥æ”¶è¯·æ±‚çš„èŠ‚ç‚¹ä¼šå°†æ•°æ®è¿”å›ç»™åè°ƒèŠ‚ç‚¹ï¼Œåè°ƒèŠ‚ç‚¹ä¼šå°†æ•°æ®è¿”å›ç»™ Clientã€‚   å¯ä»¥é€šè¿‡ preference å‚æ•°æŒ‡å®šæ‰§è¡Œæ“ä½œçš„èŠ‚ç‚¹æˆ–åˆ†ç‰‡ã€‚é»˜è®¤ä¸ºéšæœºã€‚\n 3.3 ES æ£€ç´¢æ•°æ®è¿‡ç¨‹ GET /my-index/_search es æœ€å¼ºå¤§çš„æ˜¯åšå…¨æ–‡æ£€ç´¢ï¼Œå°±æ˜¯æ¯”å¦‚ä½ æœ‰ä¸‰æ¡æ•°æ®ï¼š\njavaçœŸå¥½ç©å„¿å•Š\rjavaå¥½éš¾å­¦å•Š\rj2eeç‰¹åˆ«ç‰›\rä½ æ ¹æ® java å…³é”®è¯æ¥æœç´¢ï¼Œå°†åŒ…å« java çš„ document ç»™æœç´¢å‡ºæ¥ã€‚es å°±ä¼šç»™ä½ è¿”å›ï¼šjava çœŸå¥½ç©å„¿å•Šï¼Œjava å¥½éš¾å­¦å•Šã€‚\n å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°ä¸€ä¸ª coordinate node ã€‚ åè°ƒèŠ‚ç‚¹å°†æœç´¢è¯·æ±‚è½¬å‘åˆ°æ‰€æœ‰çš„ shard å¯¹åº”çš„ primary shard æˆ– replica shard ï¼Œéƒ½å¯ä»¥ã€‚ query phaseï¼šæ¯ä¸ª shard å°†è‡ªå·±çš„æœç´¢ç»“æœï¼ˆå…¶å®å°±æ˜¯ä¸€äº› doc id ï¼‰è¿”å›ç»™åè°ƒèŠ‚ç‚¹ï¼Œç”±åè°ƒèŠ‚ç‚¹è¿›è¡Œæ•°æ®çš„åˆå¹¶ã€æ’åºã€åˆ†é¡µç­‰æ“ä½œï¼Œäº§å‡ºæœ€ç»ˆç»“æœã€‚ fetch phaseï¼šæ¥ç€ç”±åè°ƒèŠ‚ç‚¹æ ¹æ® doc id å»å„ä¸ªèŠ‚ç‚¹ä¸Šæ‹‰å–å®é™…çš„ document æ•°æ®ï¼Œæœ€ç»ˆè¿”å›ç»™å®¢æˆ·ç«¯ã€‚   å†™è¯·æ±‚æ˜¯å†™å…¥ primary shardï¼Œç„¶ååŒæ­¥ç»™æ‰€æœ‰çš„ replica shardï¼›è¯»è¯·æ±‚å¯ä»¥ä» primary shard æˆ– replica shard è¯»å–ï¼Œé‡‡ç”¨çš„æ˜¯éšæœºè½®è¯¢ç®—æ³•ã€‚\n 4. ä¼˜åŒ–ESæå‡æ£€ç´¢æ•ˆç‡ 4.1 filesystem cache filesystem cache å³æ–‡ä»¶ç³»ç»Ÿcacheï¼Œç”±æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œçƒ­ç‚¹æ•°æ®ç¼“å­˜ï¼Œä¸å—è¿›ç¨‹è‡ªä¸»æ§åˆ¶ã€‚å…³äºcacheçš„è¯¦ç»†ä»‹ç»è¯· ğŸ‘‰ cacheå’Œbuffer\rä½ å¾€ es é‡Œå†™çš„æ•°æ®ï¼Œå®é™…ä¸Šéƒ½å†™åˆ°ç£ç›˜æ–‡ä»¶é‡Œå»äº†ï¼ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†ç£ç›˜æ–‡ä»¶é‡Œçš„æ•°æ®è‡ªåŠ¨ç¼“å­˜åˆ° filesystem cache é‡Œé¢å»ã€‚\nå½’æ ¹ç»“åº•ï¼Œä½ è¦è®© es æ€§èƒ½è¦å¥½ï¼Œæœ€ä½³çš„æƒ…å†µä¸‹ï¼Œå°±æ˜¯ä½ çš„æœºå™¨çš„å†…å­˜ï¼Œè‡³å°‘å¯ä»¥å®¹çº³ä½ çš„æ€»æ•°æ®é‡çš„ä¸€åŠã€‚\næ ¹æ®æˆ‘ä»¬è‡ªå·±çš„ç”Ÿäº§ç¯å¢ƒå®è·µç»éªŒï¼Œæœ€ä½³çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä»…ä»…åœ¨ es ä¸­å°±å­˜å°‘é‡çš„æ•°æ®ï¼Œå°±æ˜¯ä½ è¦ç”¨æ¥æœç´¢çš„é‚£äº›ç´¢å¼•ï¼Œå¦‚æœå†…å­˜ç•™ç»™ filesystem cache çš„æ˜¯ 100Gï¼Œé‚£ä¹ˆä½ å°±å°†ç´¢å¼•æ•°æ®æ§åˆ¶åœ¨ 100G ä»¥å†…ï¼Œè¿™æ ·çš„è¯ï¼Œä½ çš„æ•°æ®å‡ ä¹å…¨éƒ¨èµ°å†…å­˜æ¥æœç´¢ï¼Œæ€§èƒ½éå¸¸ä¹‹é«˜ï¼Œä¸€èˆ¬å¯ä»¥åœ¨ 1 ç§’ä»¥å†…ã€‚\næ¯”å¦‚è¯´ä½ ç°åœ¨æœ‰ä¸€è¡Œæ•°æ®ã€‚ id,name,age .... 30 ä¸ªå­—æ®µã€‚ä½†æ˜¯ä½ ç°åœ¨æœç´¢ï¼Œåªéœ€è¦æ ¹æ® id,name,age ä¸‰ä¸ªå­—æ®µæ¥æœç´¢ã€‚å¦‚æœä½ å‚»ä¹ä¹å¾€ es é‡Œå†™å…¥ä¸€è¡Œæ•°æ®æ‰€æœ‰çš„å­—æ®µï¼Œå°±ä¼šå¯¼è‡´è¯´ 90% çš„æ•°æ®æ˜¯ä¸ç”¨æ¥æœç´¢çš„ï¼Œç»“æœç¡¬æ˜¯å æ®äº† es æœºå™¨ä¸Šçš„ filesystem cache çš„ç©ºé—´ï¼Œå•æ¡æ•°æ®çš„æ•°æ®é‡è¶Šå¤§ï¼Œå°±ä¼šå¯¼è‡´ filesystem cahce èƒ½ç¼“å­˜çš„æ•°æ®å°±è¶Šå°‘ã€‚å…¶å®ï¼Œä»…ä»…å†™å…¥ es ä¸­è¦ç”¨æ¥æ£€ç´¢çš„å°‘æ•°å‡ ä¸ªå­—æ®µå°±å¯ä»¥äº†ï¼Œæ¯”å¦‚è¯´å°±å†™å…¥ es id,name,age ä¸‰ä¸ªå­—æ®µï¼Œç„¶åä½ å¯ä»¥æŠŠå…¶ä»–çš„å­—æ®µæ•°æ®å­˜åœ¨ mysql/hbase é‡Œï¼Œæˆ‘ä»¬ä¸€èˆ¬æ˜¯å»ºè®®ç”¨ es + hbase è¿™ä¹ˆä¸€ä¸ªæ¶æ„ã€‚\nhbase çš„ç‰¹ç‚¹æ˜¯é€‚ç”¨äºæµ·é‡æ•°æ®çš„åœ¨çº¿å­˜å‚¨ï¼Œå°±æ˜¯å¯¹ hbase å¯ä»¥å†™å…¥æµ·é‡æ•°æ®ï¼Œä½†æ˜¯ä¸è¦åšå¤æ‚çš„æœç´¢ï¼Œåšå¾ˆç®€å•çš„ä¸€äº›æ ¹æ® id æˆ–è€…èŒƒå›´è¿›è¡ŒæŸ¥è¯¢çš„è¿™ä¹ˆä¸€ä¸ªæ“ä½œå°±å¯ä»¥äº†ã€‚ä» es ä¸­æ ¹æ® name å’Œ age å»æœç´¢ï¼Œæ‹¿åˆ°çš„ç»“æœå¯èƒ½å°± 20 ä¸ª doc id ï¼Œç„¶åæ ¹æ® doc id åˆ° hbase é‡Œå»æŸ¥è¯¢æ¯ä¸ª doc id å¯¹åº”çš„å®Œæ•´çš„æ•°æ®ï¼Œç»™æŸ¥å‡ºæ¥ï¼Œå†è¿”å›ç»™å‰ç«¯ã€‚\nå†™å…¥ es çš„æ•°æ®æœ€å¥½å°äºç­‰äºï¼Œæˆ–è€…æ˜¯ç•¥å¾®å¤§äº es çš„ filesystem cache çš„å†…å­˜å®¹é‡ã€‚ç„¶åä½ ä» es æ£€ç´¢å¯èƒ½å°±èŠ±è´¹ 20msï¼Œç„¶åå†æ ¹æ® es è¿”å›çš„ id å» hbase é‡ŒæŸ¥è¯¢ï¼ŒæŸ¥ 20 æ¡æ•°æ®ï¼Œå¯èƒ½ä¹Ÿå°±è€—è´¹ä¸ª 30msï¼Œå¯èƒ½ä½ åŸæ¥é‚£ä¹ˆç©å„¿ï¼Œ1T æ•°æ®éƒ½æ”¾ esï¼Œä¼šæ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¯ 5~10sï¼Œç°åœ¨å¯èƒ½æ€§èƒ½å°±ä¼šå¾ˆé«˜ï¼Œæ¯æ¬¡æŸ¥è¯¢å°±æ˜¯ 50msã€‚\n4.2 æ•°æ®é¢„çƒ­ å¯¹äºé‚£äº›ä½ è§‰å¾—æ¯”è¾ƒçƒ­çš„ã€ç»å¸¸ä¼šæœ‰äººè®¿é—®çš„æ•°æ®ï¼Œæœ€å¥½åšä¸€ä¸ªä¸“é—¨çš„ç¼“å­˜é¢„çƒ­å­ç³»ç»Ÿï¼Œå°±æ˜¯å¯¹çƒ­æ•°æ®æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œå°±æå‰è®¿é—®ä¸€ä¸‹ï¼Œè®©æ•°æ®è¿›å…¥ filesystem cache é‡Œé¢å»ã€‚è¿™æ ·ä¸‹æ¬¡åˆ«äººè®¿é—®çš„æ—¶å€™ï¼Œæ€§èƒ½ä¸€å®šä¼šå¥½å¾ˆå¤šã€‚\n4.3 å†·çƒ­åˆ†ç¦» å‡è®¾ä½ æœ‰ 6 å°æœºå™¨ï¼Œ2 ä¸ªç´¢å¼•ï¼Œä¸€ä¸ªæ”¾å†·æ•°æ®ï¼Œä¸€ä¸ªæ”¾çƒ­æ•°æ®ï¼Œæ¯ä¸ªç´¢å¼• 3 ä¸ª shardã€‚3 å°æœºå™¨æ”¾çƒ­æ•°æ® indexï¼Œå¦å¤– 3 å°æœºå™¨æ”¾å†·æ•°æ® indexã€‚ç„¶åè¿™æ ·çš„è¯ï¼Œä½ å¤§é‡çš„æ—¶é—´æ˜¯åœ¨è®¿é—®çƒ­æ•°æ® indexï¼Œçƒ­æ•°æ®å¯èƒ½å°±å æ€»æ•°æ®é‡çš„ 10%ï¼Œæ­¤æ—¶æ•°æ®é‡å¾ˆå°‘ï¼Œå‡ ä¹å…¨éƒ½ä¿ç•™åœ¨ filesystem cache é‡Œé¢äº†ï¼Œå°±å¯ä»¥ç¡®ä¿çƒ­æ•°æ®çš„è®¿é—®æ€§èƒ½æ˜¯å¾ˆé«˜çš„ã€‚ä½†æ˜¯å¯¹äºå†·æ•°æ®è€Œè¨€ï¼Œæ˜¯åœ¨åˆ«çš„ index é‡Œçš„ï¼Œè·Ÿçƒ­æ•°æ® index ä¸åœ¨ç›¸åŒçš„æœºå™¨ä¸Šï¼Œå¤§å®¶äº’ç›¸ä¹‹é—´éƒ½æ²¡ä»€ä¹ˆè”ç³»äº†ã€‚å¦‚æœæœ‰äººè®¿é—®å†·æ•°æ®ï¼Œå¯èƒ½å¤§é‡æ•°æ®æ˜¯åœ¨ç£ç›˜ä¸Šçš„ï¼Œæ­¤æ—¶æ€§èƒ½å·®ç‚¹ï¼Œå°± 10% çš„äººå»è®¿é—®å†·æ•°æ®ï¼Œ90% çš„äººåœ¨è®¿é—®çƒ­æ•°æ®ï¼Œä¹Ÿæ— æ‰€è°“äº†ã€‚\n4.4 document æ¨¡å‹è®¾è®¡ æœ€å¥½æ˜¯å…ˆåœ¨ Java ç³»ç»Ÿé‡Œå°±å®Œæˆå…³è”ï¼Œå°†å…³è”å¥½çš„æ•°æ®ç›´æ¥å†™å…¥ es ä¸­ã€‚æœç´¢çš„æ—¶å€™ï¼Œå°±ä¸éœ€è¦åˆ©ç”¨ es çš„æœç´¢è¯­æ³•æ¥å®Œæˆ join ä¹‹ç±»çš„å…³è”æœç´¢äº†ã€‚\ndocument æ¨¡å‹è®¾è®¡æ˜¯éå¸¸é‡è¦çš„ï¼Œå¾ˆå¤šæ“ä½œï¼Œä¸è¦åœ¨æœç´¢çš„æ—¶å€™æ‰æƒ³å»æ‰§è¡Œå„ç§å¤æ‚çš„ä¹±ä¸ƒå…«ç³Ÿçš„æ“ä½œã€‚es èƒ½æ”¯æŒçš„æ“ä½œå°±é‚£ä¹ˆå¤šï¼Œä¸è¦è€ƒè™‘ç”¨ es åšä¸€äº›å®ƒä¸å¥½æ“ä½œçš„äº‹æƒ…ã€‚å¦‚æœçœŸçš„æœ‰é‚£ç§æ“ä½œï¼Œå°½é‡åœ¨ document æ¨¡å‹è®¾è®¡çš„æ—¶å€™ï¼Œå†™å…¥çš„æ—¶å€™å°±å®Œæˆã€‚å¦å¤–å¯¹äºä¸€äº›å¤ªå¤æ‚çš„æ“ä½œï¼Œæ¯”å¦‚ join/nested/parent-child æœç´¢éƒ½è¦å°½é‡é¿å…ï¼Œæ€§èƒ½éƒ½å¾ˆå·®çš„ã€‚\n4.5 åˆ†é¡µæ€§èƒ½ä¼˜åŒ– es çš„åˆ†é¡µæ˜¯è¾ƒå‘çš„ï¼Œä¸ºå•¥å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­å§ï¼Œå‡å¦‚ä½ æ¯é¡µæ˜¯ 10 æ¡æ•°æ®ï¼Œä½ ç°åœ¨è¦æŸ¥è¯¢ç¬¬ 100 é¡µï¼Œå®é™…ä¸Šæ˜¯ä¼šæŠŠæ¯ä¸ª shard ä¸Šå­˜å‚¨çš„å‰ 1000 æ¡æ•°æ®éƒ½æŸ¥åˆ°ä¸€ä¸ªåè°ƒèŠ‚ç‚¹ä¸Šï¼Œå¦‚æœä½ æœ‰ä¸ª 5 ä¸ª shardï¼Œé‚£ä¹ˆå°±æœ‰ 5000 æ¡æ•°æ®ï¼Œæ¥ç€åè°ƒèŠ‚ç‚¹å¯¹è¿™ 5000 æ¡æ•°æ®è¿›è¡Œä¸€äº›åˆå¹¶ã€å¤„ç†ï¼Œå†è·å–åˆ°æœ€ç»ˆç¬¬ 100 é¡µçš„ 10 æ¡æ•°æ®ã€‚\nåˆ†å¸ƒå¼çš„ï¼Œä½ è¦æŸ¥ç¬¬ 100 é¡µçš„ 10 æ¡æ•°æ®ï¼Œä¸å¯èƒ½è¯´ä» 5 ä¸ª shardï¼Œæ¯ä¸ª shard å°±æŸ¥ 2 æ¡æ•°æ®ï¼Œæœ€ååˆ°åè°ƒèŠ‚ç‚¹åˆå¹¶æˆ 10 æ¡æ•°æ®å§ï¼Ÿä½ å¿…é¡»å¾—ä»æ¯ä¸ª shard éƒ½æŸ¥ 1000 æ¡æ•°æ®è¿‡æ¥ï¼Œç„¶åæ ¹æ®ä½ çš„éœ€æ±‚è¿›è¡Œæ’åºã€ç­›é€‰ç­‰ç­‰æ“ä½œï¼Œæœ€åå†æ¬¡åˆ†é¡µï¼Œæ‹¿åˆ°é‡Œé¢ç¬¬ 100 é¡µçš„æ•°æ®ã€‚ä½ ç¿»é¡µçš„æ—¶å€™ï¼Œç¿»çš„è¶Šæ·±ï¼Œæ¯ä¸ª shard è¿”å›çš„æ•°æ®å°±è¶Šå¤šï¼Œè€Œä¸”åè°ƒèŠ‚ç‚¹å¤„ç†çš„æ—¶é—´è¶Šé•¿ï¼Œéå¸¸å‘çˆ¹ã€‚æ‰€ä»¥ç”¨ es åšåˆ†é¡µçš„æ—¶å€™ï¼Œä½ ä¼šå‘ç°è¶Šç¿»åˆ°åé¢ï¼Œå°±è¶Šæ˜¯æ…¢ã€‚\næˆ‘ä»¬ä¹‹å‰ä¹Ÿæ˜¯é‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜ï¼Œç”¨ es ä½œåˆ†é¡µï¼Œå‰å‡ é¡µå°±å‡ åæ¯«ç§’ï¼Œç¿»åˆ° 10 é¡µæˆ–è€…å‡ åé¡µçš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šå°±è¦ 5~10 ç§’æ‰èƒ½æŸ¥å‡ºæ¥ä¸€é¡µæ•°æ®äº†ã€‚\næœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆå—ï¼Ÿ\nä¸å…è®¸æ·±åº¦åˆ†é¡µï¼ˆé»˜è®¤æ·±åº¦åˆ†é¡µæ€§èƒ½å¾ˆå·®ï¼‰\nè·Ÿäº§å“ç»ç†è¯´ï¼Œä½ ç³»ç»Ÿä¸å…è®¸ç¿»é‚£ä¹ˆæ·±çš„é¡µï¼Œé»˜è®¤ç¿»çš„è¶Šæ·±ï¼Œæ€§èƒ½å°±è¶Šå·®ã€‚\nç±»ä¼¼äº app é‡Œçš„æ¨èå•†å“ä¸æ–­ä¸‹æ‹‰å‡ºæ¥ä¸€é¡µä¸€é¡µçš„\nscroll api æˆ–è€… search_after\nå‚è€ƒ åŸºç¡€ï¼š\ndoocs/advanced-java\rã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” ES æŸ¥è¯¢æ£€ç´¢æ•°æ®çš„è¿‡ç¨‹ï¼Œæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ\rå…¨æ–‡æœç´¢å¼•æ“ Elasticsearch å…¥é—¨æ•™ç¨‹\råº”ç”¨åœºæ™¯ï¼š\nä¸ƒä¸ªç”Ÿäº§æ¡ˆä¾‹å‘Šè¯‰ä½ BATJä¸ºä½•é€‰æ‹©ElasticSearchï¼åº”ç”¨åœºæ™¯å’Œä¼˜åŠ¿ï¼\ré¡¹ç›®å®æˆ˜ï¼š\nElasticsearchå¿«é€Ÿå…¥é—¨ï¼ŒæŒæ¡è¿™äº›åˆšåˆšå¥½ï¼\rmallæ•´åˆElasticsearchå®ç°å•†å“æœç´¢\rElasticsearché¡¹ç›®å®æˆ˜ï¼Œå•†å“æœç´¢åŠŸèƒ½è®¾è®¡ä¸å®ç°ï¼\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/es/es%E7%BB%BC%E8%BF%B0/","series":["Manual"],"tags":["ES"],"title":"ESç»¼è¿°"},{"categories":["å…¶ä»–"],"content":"gitbookå®‰è£…\n å®‰è£…  sudo npm install gitbook -g sudo npm install -g gitbook-cli éªŒè¯  gitbook -V åˆå§‹åŒ–é¡¹ç›®  mkdir direName //åˆ›å»ºè‡ªå·±çš„æ–‡ä»¶å¤¹ç›®å½• cd direName //è¿›å…¥åˆ°è‡ªå·±çš„gitbookæ–‡ä»¶å¤¹ç›®å½• gitbook init //åˆå§‹åŒ–gitbooké¡¹ç›® å¯åŠ¨  gitbook serve æˆ–è€…gitbook serve \u0026amp;åå°è¿è¡Œï¼Œé»˜è®¤åœ¨4000ç«¯å£å¯åŠ¨ã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/gitbook%E5%AE%89%E8%A3%85/","series":["Manual"],"tags":["Other"],"title":"gitbookå®‰è£…"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"æˆ‘ä»¬çœŸæ˜¯ä¸€ä¸ªç¥å¥‡çš„å›½åº¦ï¼Œè¿githubéƒ½è¦å°ç¦ã€‚\næœ€è¿‘github httpsæ— æ³•æ¥å…¥ï¼š\nfatal: unable to access \u0026#39;https://github.com/xuzhijvn/tony-demo.git/\u0026#39;: LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to github.com:443 è¯•äº†nç§æ–¹å¼éƒ½ä¸è¡Œï¼š\n  åˆ‡æ¢SSRä»£ç†èŠ‚ç‚¹\n  åˆ‡æ¢SSRä»£ç†æ¨¡å¼åˆ°å…¨å±€\n  é€€å‡ºSSR\n  ä½¿ç”¨è“ç¯ä»£ç†\n  è®¾ç½®gitä»£ç†ï¼ˆ61885æ˜¯æˆ‘è“ç¯ä»£ç†çš„ç«¯å£ï¼‰\n  git config --global --list git config --global https.proxy \u0026#39;127.0.0.1:61885\u0026#39; git config --global http.proxy \u0026#39;127.0.0.1:61885\u0026#39; git config --global --list ç¦ç”¨gitä»£ç†  git config --global --list git config --global --unset http.proxy git config --global --list networksetup -setv6off Wi-Fi  ä»¥ä¸Šæ–¹æ³•å…¨éƒ¨ä¸å¥½ä½¿ï¼ŒæŠ˜è…¾äº†ä¸€ä¸‹åˆå¿ƒæ€å´©äº†ğŸ’”ğŸ’”\næœ€ååªèƒ½æ”¹æˆé€šè¿‡sshæ–¹å¼æ¥å…¥äº†ï¼š\n ç”Ÿæˆå…¬ç§é’¥å¯¹  ssh-keygen -t rsa -C \u0026#34;783175223@qq.com\u0026#34; æ‹·è´åˆ°github  pbcopy \u0026lt; ~/.ssh/github_id_rsa.pub è¦ä½¿ç”¨ssh-addå‘½ä»¤æ˜¯æŠŠä¸“ç”¨å¯†é’¥æ·»åŠ åˆ°ssh-agentçš„é«˜é€Ÿç¼“å­˜ä¸­  ssh-add -K ~/.ssh/github_id_rsa ä¸Šé¢çš„å‘½ä»¤åœ¨é‡å¯ç”µè„‘ä¹‹åä¼šå¤±æ•ˆï¼Œæ‰€ä»¥å¾—é€šè¿‡åœ¨~/.ssh/configæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹æ¥å–ä»£ï¼š  Host * AddKeysToAgent yes UseKeychain yes IdentityFile ~/.ssh/github_id_rsa IdentityFile ~/.ssh/huolala_id_rsa æ¥å…¥githubçš„æ—¶å€™ç”¨sshæ¨¡å¼  å‚è€ƒé“¾æ¥ï¼š å·¥ä½œã€å¼€æºä¸¤ä¸è¯¯ï¼šGitå¤šè´¦å·ç®¡ç†\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/git/github-443/","series":["Manual"],"tags":["github"],"title":"GitHub 443"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":" æœ¬èŠ‚ä¸ºé‡ç‚¹ç« èŠ‚ æœ¬ç« èŠ‚å«è§†é¢‘ç‰ˆ:\n \r ä¸€ã€Golangâ€œè°ƒåº¦å™¨â€çš„ç”±æ¥ï¼Ÿ (1) å•è¿›ç¨‹æ—¶ä»£ä¸éœ€è¦è°ƒåº¦å™¨ æˆ‘ä»¬çŸ¥é“ï¼Œä¸€åˆ‡çš„è½¯ä»¶éƒ½æ˜¯è·‘åœ¨æ“ä½œç³»ç»Ÿä¸Šï¼ŒçœŸæ­£ç”¨æ¥å¹²æ´»(è®¡ç®—)çš„æ˜¯CPUã€‚æ—©æœŸçš„æ“ä½œç³»ç»Ÿæ¯ä¸ªç¨‹åºå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œç›´åˆ°ä¸€ä¸ªç¨‹åºè¿è¡Œå®Œï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œå°±æ˜¯â€œå•è¿›ç¨‹æ—¶ä»£â€\nä¸€åˆ‡çš„ç¨‹åºåªèƒ½ä¸²è¡Œå‘ç”Ÿã€‚\næ—©æœŸçš„å•è¿›ç¨‹æ“ä½œç³»ç»Ÿï¼Œé¢ä¸´2ä¸ªé—®é¢˜ï¼š\n1.å•ä¸€çš„æ‰§è¡Œæµç¨‹ï¼Œè®¡ç®—æœºåªèƒ½ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡å¤„ç†ã€‚\n2.è¿›ç¨‹é˜»å¡æ‰€å¸¦æ¥çš„CPUæ—¶é—´æµªè´¹ã€‚\né‚£ä¹ˆèƒ½ä¸èƒ½æœ‰å¤šä¸ªè¿›ç¨‹æ¥å®è§‚ä¸€èµ·æ¥æ‰§è¡Œå¤šä¸ªä»»åŠ¡å‘¢ï¼Ÿ\nåæ¥æ“ä½œç³»ç»Ÿå°±å…·æœ‰äº†æœ€æ—©çš„å¹¶å‘èƒ½åŠ›ï¼šå¤šè¿›ç¨‹å¹¶å‘ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹é˜»å¡çš„æ—¶å€™ï¼Œåˆ‡æ¢åˆ°å¦å¤–ç­‰å¾…æ‰§è¡Œçš„è¿›ç¨‹ï¼Œè¿™æ ·å°±èƒ½å°½é‡æŠŠCPUåˆ©ç”¨èµ·æ¥ï¼ŒCPUå°±ä¸æµªè´¹äº†ã€‚\n(2)å¤šè¿›ç¨‹/çº¿ç¨‹æ—¶ä»£æœ‰äº†è°ƒåº¦å™¨éœ€æ±‚ åœ¨å¤šè¿›ç¨‹/å¤šçº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œå°±è§£å†³äº†é˜»å¡çš„é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹é˜»å¡cpuå¯ä»¥ç«‹åˆ»åˆ‡æ¢åˆ°å…¶ä»–è¿›ç¨‹ä¸­å»æ‰§è¡Œï¼Œè€Œä¸”è°ƒåº¦cpuçš„ç®—æ³•å¯ä»¥ä¿è¯åœ¨è¿è¡Œçš„è¿›ç¨‹éƒ½å¯ä»¥è¢«åˆ†é…åˆ°cpuçš„è¿è¡Œæ—¶é—´ç‰‡ã€‚è¿™æ ·ä»å®è§‚æ¥çœ‹ï¼Œä¼¼ä¹å¤šä¸ªè¿›ç¨‹æ˜¯åœ¨åŒæ—¶è¢«è¿è¡Œã€‚\nä½†æ–°çš„é—®é¢˜å°±åˆå‡ºç°äº†ï¼Œè¿›ç¨‹æ‹¥æœ‰å¤ªå¤šçš„èµ„æºï¼Œè¿›ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€é”€æ¯ï¼Œéƒ½ä¼šå ç”¨å¾ˆé•¿çš„æ—¶é—´ï¼ŒCPUè™½ç„¶åˆ©ç”¨èµ·æ¥äº†ï¼Œä½†å¦‚æœè¿›ç¨‹è¿‡å¤šï¼ŒCPUæœ‰å¾ˆå¤§çš„ä¸€éƒ¨åˆ†éƒ½è¢«ç”¨æ¥è¿›è¡Œè¿›ç¨‹è°ƒåº¦äº†ã€‚\næ€ä¹ˆæ‰èƒ½æé«˜CPUçš„åˆ©ç”¨ç‡å‘¢ï¼Ÿ\nä½†æ˜¯å¯¹äºLinuxæ“ä½œç³»ç»Ÿæ¥è®²ï¼Œcpuå¯¹è¿›ç¨‹çš„æ€åº¦å’Œçº¿ç¨‹çš„æ€åº¦æ˜¯ä¸€æ ·çš„ã€‚\nå¾ˆæ˜æ˜¾ï¼ŒCPUè°ƒåº¦åˆ‡æ¢çš„æ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ã€‚å°½ç®¡çº¿ç¨‹çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œä½†å®é™…ä¸Šå¤šçº¿ç¨‹å¼€å‘è®¾è®¡ä¼šå˜å¾—æ›´åŠ å¤æ‚ï¼Œè¦è€ƒè™‘å¾ˆå¤šåŒæ­¥ç«äº‰ç­‰é—®é¢˜ï¼Œå¦‚é”ã€ç«äº‰å†²çªç­‰ã€‚\n(3)åç¨‹æ¥æé«˜CPUåˆ©ç”¨ç‡ å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹å·²ç»æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯åœ¨å½“ä»Šäº’è”ç½‘é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºæ¯ä¸ªä»»åŠ¡éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ç°å®çš„ï¼Œå› ä¸ºä¼šæ¶ˆè€—å¤§é‡çš„å†…å­˜(è¿›ç¨‹è™šæ‹Ÿå†…å­˜ä¼šå ç”¨4GB[32ä½æ“ä½œç³»ç»Ÿ], è€Œçº¿ç¨‹ä¹Ÿè¦å¤§çº¦4MB)ã€‚\nå¤§é‡çš„è¿›ç¨‹/çº¿ç¨‹å‡ºç°äº†æ–°çš„é—®é¢˜\n é«˜å†…å­˜å ç”¨ è°ƒåº¦çš„é«˜æ¶ˆè€—CPU  å¥½äº†ï¼Œç„¶åå·¥ç¨‹å¸ˆä»¬å°±å‘ç°ï¼Œå…¶å®ä¸€ä¸ªçº¿ç¨‹åˆ†ä¸ºâ€œå†…æ ¸æ€â€œçº¿ç¨‹å’Œâ€ç”¨æˆ·æ€â€œçº¿ç¨‹ã€‚\nä¸€ä¸ªâ€œç”¨æˆ·æ€çº¿ç¨‹â€å¿…é¡»è¦ç»‘å®šä¸€ä¸ªâ€œå†…æ ¸æ€çº¿ç¨‹â€ï¼Œä½†æ˜¯CPUå¹¶ä¸çŸ¥é“æœ‰â€œç”¨æˆ·æ€çº¿ç¨‹â€çš„å­˜åœ¨ï¼Œå®ƒåªçŸ¥é“å®ƒè¿è¡Œçš„æ˜¯ä¸€ä¸ªâ€œå†…æ ¸æ€çº¿ç¨‹â€(Linuxçš„PCBè¿›ç¨‹æ§åˆ¶å—)ã€‚\nè¿™æ ·ï¼Œæˆ‘ä»¬å†å»ç»†åŒ–å»åˆ†ç±»ä¸€ä¸‹ï¼Œå†…æ ¸çº¿ç¨‹ä¾ç„¶å«â€œçº¿ç¨‹(thread)â€ï¼Œç”¨æˆ·çº¿ç¨‹å«â€œåç¨‹(co-routine)\u0026quot;.\nçœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±è¦å¼€è„‘æ´äº†ï¼Œæ—¢ç„¶ä¸€ä¸ªåç¨‹(co-routine)å¯ä»¥ç»‘å®šä¸€ä¸ªçº¿ç¨‹(thread)ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½å¤šä¸ªåç¨‹(co-routine)ç»‘å®šä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹(thread)ä¸Šå‘¢ã€‚\nä¹‹åï¼Œæˆ‘ä»¬å°±çœ‹åˆ°äº†æœ‰3ä¸­åç¨‹å’Œçº¿ç¨‹çš„æ˜ å°„å…³ç³»ï¼š\n N:1å…³ç³»  Nä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œä¼˜ç‚¹å°±æ˜¯åç¨‹åœ¨ç”¨æˆ·æ€çº¿ç¨‹å³å®Œæˆåˆ‡æ¢ï¼Œä¸ä¼šé™·å…¥åˆ°å†…æ ¸æ€ï¼Œè¿™ç§åˆ‡æ¢éå¸¸çš„è½»é‡å¿«é€Ÿã€‚ä½†ä¹Ÿæœ‰å¾ˆå¤§çš„ç¼ºç‚¹ï¼Œ1ä¸ªè¿›ç¨‹çš„æ‰€æœ‰åç¨‹éƒ½ç»‘å®šåœ¨1ä¸ªçº¿ç¨‹ä¸Š\nç¼ºç‚¹ï¼š\n æŸä¸ªç¨‹åºç”¨ä¸äº†ç¡¬ä»¶çš„å¤šæ ¸åŠ é€Ÿèƒ½åŠ› ä¸€æ—¦æŸåç¨‹é˜»å¡ï¼Œé€ æˆçº¿ç¨‹é˜»å¡ï¼Œæœ¬è¿›ç¨‹çš„å…¶ä»–åç¨‹éƒ½æ— æ³•æ‰§è¡Œäº†ï¼Œæ ¹æœ¬å°±æ²¡æœ‰å¹¶å‘çš„èƒ½åŠ›äº†ã€‚   1:1 å…³ç³»  1ä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œè¿™ç§æœ€å®¹æ˜“å®ç°ã€‚åç¨‹çš„è°ƒåº¦éƒ½ç”±CPUå®Œæˆäº†ï¼Œä¸å­˜åœ¨N:1ç¼ºç‚¹ï¼Œ\nç¼ºç‚¹ï¼š\n åç¨‹çš„åˆ›å»ºã€åˆ é™¤å’Œåˆ‡æ¢çš„ä»£ä»·éƒ½ç”±CPUå®Œæˆï¼Œæœ‰ç‚¹ç•¥æ˜¾æ˜‚è´µäº†ã€‚   M:Nå…³ç³»  Mä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œæ˜¯N:1å’Œ1:1ç±»å‹çš„ç»“åˆï¼Œå…‹æœäº†ä»¥ä¸Š2ç§æ¨¡å‹çš„ç¼ºç‚¹ï¼Œä½†å®ç°èµ·æ¥æœ€ä¸ºå¤æ‚ã€‚\nåç¨‹è·Ÿçº¿ç¨‹æ˜¯æœ‰åŒºåˆ«çš„ï¼Œçº¿ç¨‹ç”±CPUè°ƒåº¦æ˜¯æŠ¢å å¼çš„ï¼Œåç¨‹ç”±ç”¨æˆ·æ€è°ƒåº¦æ˜¯åä½œå¼çš„ï¼Œä¸€ä¸ªåç¨‹è®©å‡ºCPUåï¼Œæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ã€‚\n(4)Goè¯­è¨€çš„åç¨‹goroutine Goä¸ºäº†æä¾›æ›´å®¹æ˜“ä½¿ç”¨çš„å¹¶å‘æ–¹æ³•ï¼Œä½¿ç”¨äº†goroutineå’Œchannelã€‚goroutineæ¥è‡ªåç¨‹çš„æ¦‚å¿µï¼Œè®©ä¸€ç»„å¯å¤ç”¨çš„å‡½æ•°è¿è¡Œåœ¨ä¸€ç»„çº¿ç¨‹ä¹‹ä¸Šï¼Œå³ä½¿æœ‰åç¨‹é˜»å¡ï¼Œè¯¥çº¿ç¨‹çš„å…¶ä»–åç¨‹ä¹Ÿå¯ä»¥è¢«runtimeè°ƒåº¦ï¼Œè½¬ç§»åˆ°å…¶ä»–å¯è¿è¡Œçš„çº¿ç¨‹ä¸Šã€‚æœ€å…³é”®çš„æ˜¯ï¼Œç¨‹åºå‘˜çœ‹ä¸åˆ°è¿™äº›åº•å±‚çš„ç»†èŠ‚ï¼Œè¿™å°±é™ä½äº†ç¼–ç¨‹çš„éš¾åº¦ï¼Œæä¾›äº†æ›´å®¹æ˜“çš„å¹¶å‘ã€‚\nGoä¸­ï¼Œåç¨‹è¢«ç§°ä¸ºgoroutineï¼Œå®ƒéå¸¸è½»é‡ï¼Œä¸€ä¸ªgoroutineåªå å‡ KBï¼Œå¹¶ä¸”è¿™å‡ KBå°±è¶³å¤Ÿgoroutineè¿è¡Œå®Œï¼Œè¿™å°±èƒ½åœ¨æœ‰é™çš„å†…å­˜ç©ºé—´å†…æ”¯æŒå¤§é‡goroutineï¼Œæ”¯æŒäº†æ›´å¤šçš„å¹¶å‘ã€‚è™½ç„¶ä¸€ä¸ªgoroutineçš„æ ˆåªå å‡ KBï¼Œä½†å®é™…æ˜¯å¯ä¼¸ç¼©çš„ï¼Œå¦‚æœéœ€è¦æ›´å¤šå†…å®¹ï¼Œruntimeä¼šè‡ªåŠ¨ä¸ºgoroutineåˆ†é…ã€‚\nGoroutineç‰¹ç‚¹ï¼š\n å ç”¨å†…å­˜æ›´å°ï¼ˆå‡ kbï¼‰ è°ƒåº¦æ›´çµæ´»(runtimeè°ƒåº¦)  (5)è¢«åºŸå¼ƒçš„goroutineè°ƒåº¦å™¨ å¥½äº†ï¼Œæ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†åç¨‹å’Œçº¿ç¨‹çš„å…³ç³»ï¼Œé‚£ä¹ˆæœ€å…³é”®çš„ä¸€ç‚¹å°±æ˜¯è°ƒåº¦åç¨‹çš„è°ƒåº¦å™¨çš„å®ç°äº†ã€‚\nGoç›®å‰ä½¿ç”¨çš„è°ƒåº¦å™¨æ˜¯2012å¹´é‡æ–°è®¾è®¡çš„ï¼Œå› ä¸ºä¹‹å‰çš„è°ƒåº¦å™¨æ€§èƒ½å­˜åœ¨é—®é¢˜ï¼Œæ‰€ä»¥ä½¿ç”¨4å¹´å°±è¢«åºŸå¼ƒäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹è¢«åºŸå¼ƒçš„è°ƒåº¦å™¨æ˜¯å¦‚ä½•è¿ä½œçš„ï¼Ÿ\n å¤§éƒ¨åˆ†æ–‡ç« éƒ½æ˜¯ä¼šç”¨Gæ¥è¡¨ç¤ºGoroutineï¼Œç”¨Mæ¥è¡¨ç¤ºçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿä¼šç”¨è¿™ç§è¡¨è¾¾çš„å¯¹åº”å…³ç³»ã€‚\n ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¢«åºŸå¼ƒçš„golangè°ƒåº¦å™¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ\nMæƒ³è¦æ‰§è¡Œã€æ”¾å›Géƒ½å¿…é¡»è®¿é—®å…¨å±€Gé˜Ÿåˆ—ï¼Œå¹¶ä¸”Mæœ‰å¤šä¸ªï¼Œå³å¤šçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºéœ€è¦åŠ é”è¿›è¡Œä¿è¯äº’æ–¥/åŒæ­¥ï¼Œæ‰€ä»¥å…¨å±€Gé˜Ÿåˆ—æ˜¯æœ‰äº’æ–¥é”è¿›è¡Œä¿æŠ¤çš„ã€‚\nè€è°ƒåº¦å™¨æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š\n åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦Géƒ½éœ€è¦æ¯ä¸ªMè·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„é”ç«äº‰ã€‚ Mè½¬ç§»Gä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“Gä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹çš„æ—¶å€™ï¼ŒMåˆ›å»ºäº†Gâ€™ï¼Œä¸ºäº†ç»§ç»­æ‰§è¡ŒGï¼Œéœ€è¦æŠŠGâ€™äº¤ç»™Mâ€™æ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†å¾ˆå·®çš„å±€éƒ¨æ€§ï¼Œå› ä¸ºGâ€™å’ŒGæ˜¯ç›¸å…³çš„ï¼Œæœ€å¥½æ”¾åœ¨Mä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»–M'ã€‚ ç³»ç»Ÿè°ƒç”¨(CPUåœ¨Mä¹‹é—´çš„åˆ‡æ¢)å¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹é˜»å¡å’Œå–æ¶ˆé˜»å¡æ“ä½œå¢åŠ äº†ç³»ç»Ÿå¼€é”€ã€‚  äºŒã€Goroutineè°ƒåº¦å™¨çš„GMPæ¨¡å‹çš„è®¾è®¡æ€æƒ³ é¢å¯¹ä¹‹å‰è°ƒåº¦å™¨çš„é—®é¢˜ï¼ŒGoè®¾è®¡äº†æ–°çš„è°ƒåº¦å™¨ã€‚\nåœ¨æ–°è°ƒåº¦å™¨ä¸­ï¼Œå‡ºåˆ—M(thread)å’ŒG(goroutine)ï¼Œåˆå¼•è¿›äº†P(Processor)ã€‚\nProcessorï¼Œå®ƒåŒ…å«äº†è¿è¡Œgoroutineçš„èµ„æºï¼Œå¦‚æœçº¿ç¨‹æƒ³è¿è¡Œgoroutineï¼Œå¿…é¡»å…ˆè·å–Pï¼ŒPä¸­è¿˜åŒ…å«äº†å¯è¿è¡Œçš„Gé˜Ÿåˆ—ã€‚\n(1)GMPæ¨¡å‹ åœ¨Goä¸­ï¼Œçº¿ç¨‹æ˜¯è¿è¡Œgoroutineçš„å®ä½“ï¼Œè°ƒåº¦å™¨çš„åŠŸèƒ½æ˜¯æŠŠå¯è¿è¡Œçš„goroutineåˆ†é…åˆ°å·¥ä½œçº¿ç¨‹ä¸Šã€‚\n å…¨å±€é˜Ÿåˆ—ï¼ˆGlobal Queueï¼‰ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„Gã€‚ Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼šåŒå…¨å±€é˜Ÿåˆ—ç±»ä¼¼ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯ç­‰å¾…è¿è¡Œçš„Gï¼Œå­˜çš„æ•°é‡æœ‰é™ï¼Œä¸è¶…è¿‡256ä¸ªã€‚æ–°å»ºG\u0026rsquo;æ—¶ï¼ŒG\u0026rsquo;ä¼˜å…ˆåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„Gç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚ Påˆ—è¡¨ï¼šæ‰€æœ‰çš„Péƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰GOMAXPROCS(å¯é…ç½®)ä¸ªã€‚ Mï¼šçº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å–Pï¼Œä»Pçš„æœ¬åœ°é˜Ÿåˆ—è·å–Gï¼ŒPé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒMä¹Ÿä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—æ‹¿ä¸€æ‰¹Gæ”¾åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–ä»å…¶ä»–Pçš„æœ¬åœ°é˜Ÿåˆ—å·ä¸€åŠæ”¾åˆ°è‡ªå·±Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚Mè¿è¡ŒGï¼ŒGæ‰§è¡Œä¹‹åï¼ŒMä¼šä»Pè·å–ä¸‹ä¸€ä¸ªGï¼Œä¸æ–­é‡å¤ä¸‹å»ã€‚  Goroutineè°ƒåº¦å™¨å’ŒOSè°ƒåº¦å™¨æ˜¯é€šè¿‡Mç»“åˆèµ·æ¥çš„ï¼Œæ¯ä¸ªMéƒ½ä»£è¡¨äº†1ä¸ªå†…æ ¸çº¿ç¨‹ï¼ŒOSè°ƒåº¦å™¨è´Ÿè´£æŠŠå†…æ ¸çº¿ç¨‹åˆ†é…åˆ°CPUçš„æ ¸ä¸Šæ‰§è¡Œã€‚\n æœ‰å…³På’ŒMçš„ä¸ªæ•°é—®é¢˜  1ã€Pçš„æ•°é‡ï¼š\n ç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡$GOMAXPROCSæˆ–è€…æ˜¯ç”±runtimeçš„æ–¹æ³•GOMAXPROCS()å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰$GOMAXPROCSä¸ªgoroutineåœ¨åŒæ—¶è¿è¡Œã€‚  2ã€Mçš„æ•°é‡:\n goè¯­è¨€æœ¬èº«çš„é™åˆ¶ï¼šgoç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½®Mçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤10000.ä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚ runtime/debugä¸­çš„SetMaxThreadså‡½æ•°ï¼Œè®¾ç½®Mçš„æœ€å¤§æ•°é‡ ä¸€ä¸ªMé˜»å¡äº†ï¼Œä¼šåˆ›å»ºæ–°çš„Mã€‚  Mä¸Pçš„æ•°é‡æ²¡æœ‰ç»å¯¹å…³ç³»ï¼Œä¸€ä¸ªMé˜»å¡ï¼ŒPå°±ä¼šå»åˆ›å»ºæˆ–è€…åˆ‡æ¢å¦ä¸€ä¸ªMï¼Œæ‰€ä»¥ï¼Œå³ä½¿Pçš„é»˜è®¤æ•°é‡æ˜¯1ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šåˆ›å»ºå¾ˆå¤šä¸ªMå‡ºæ¥ã€‚\n På’ŒMä½•æ—¶ä¼šè¢«åˆ›å»º  1ã€Pä½•æ—¶åˆ›å»ºï¼šåœ¨ç¡®å®šäº†Pçš„æœ€å¤§æ•°é‡nåï¼Œè¿è¡Œæ—¶ç³»ç»Ÿä¼šæ ¹æ®è¿™ä¸ªæ•°é‡åˆ›å»ºnä¸ªPã€‚\n2ã€Mä½•æ—¶åˆ›å»ºï¼šæ²¡æœ‰è¶³å¤Ÿçš„Mæ¥å…³è”På¹¶è¿è¡Œå…¶ä¸­çš„å¯è¿è¡Œçš„Gã€‚æ¯”å¦‚æ‰€æœ‰çš„Mæ­¤æ—¶éƒ½é˜»å¡ä½äº†ï¼Œè€ŒPä¸­è¿˜æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„Mï¼Œè€Œæ²¡æœ‰ç©ºé—²çš„ï¼Œå°±ä¼šå»åˆ›å»ºæ–°çš„Mã€‚\n(2)è°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥ å¤ç”¨çº¿ç¨‹ï¼šé¿å…é¢‘ç¹çš„åˆ›å»ºã€é”€æ¯çº¿ç¨‹ï¼Œè€Œæ˜¯å¯¹çº¿ç¨‹çš„å¤ç”¨ã€‚\n1ï¼‰work stealingæœºåˆ¶\nå½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„Gæ—¶ï¼Œå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„På·å–Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚\n2ï¼‰hand offæœºåˆ¶\nå½“æœ¬çº¿ç¨‹å› ä¸ºGè¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„Pï¼ŒæŠŠPè½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚\nåˆ©ç”¨å¹¶è¡Œï¼šGOMAXPROCSè®¾ç½®Pçš„æ•°é‡ï¼Œæœ€å¤šæœ‰GOMAXPROCSä¸ªçº¿ç¨‹åˆ†å¸ƒåœ¨å¤šä¸ªCPUä¸ŠåŒæ—¶è¿è¡Œã€‚GOMAXPROCSä¹Ÿé™åˆ¶äº†å¹¶å‘çš„ç¨‹åº¦ï¼Œæ¯”å¦‚GOMAXPROCS = æ ¸æ•°/2ï¼Œåˆ™æœ€å¤šåˆ©ç”¨äº†ä¸€åŠçš„CPUæ ¸è¿›è¡Œå¹¶è¡Œã€‚\næŠ¢å ï¼šåœ¨coroutineä¸­è¦ç­‰å¾…ä¸€ä¸ªåç¨‹ä¸»åŠ¨è®©å‡ºCPUæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ï¼Œåœ¨Goä¸­ï¼Œä¸€ä¸ªgoroutineæœ€å¤šå ç”¨CPU 10msï¼Œé˜²æ­¢å…¶ä»–goroutineè¢«é¥¿æ­»ï¼Œè¿™å°±æ˜¯goroutineä¸åŒäºcoroutineçš„ä¸€ä¸ªåœ°æ–¹ã€‚\nå…¨å±€Gé˜Ÿåˆ—ï¼šåœ¨æ–°çš„è°ƒåº¦å™¨ä¸­ä¾ç„¶æœ‰å…¨å±€Gé˜Ÿåˆ—ï¼Œä½†åŠŸèƒ½å·²ç»è¢«å¼±åŒ–äº†ï¼Œå½“Mæ‰§è¡Œwork stealingä»å…¶ä»–På·ä¸åˆ°Gæ—¶ï¼Œå®ƒå¯ä»¥ä»å…¨å±€Gé˜Ÿåˆ—è·å–Gã€‚\n(3) go func() è°ƒåº¦æµç¨‹ ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥åˆ†æå‡ºå‡ ä¸ªç»“è®ºï¼š\n1ã€æˆ‘ä»¬é€šè¿‡ go func()æ¥åˆ›å»ºä¸€ä¸ªgoroutineï¼›\n2ã€æœ‰ä¸¤ä¸ªå­˜å‚¨Gçš„é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯å±€éƒ¨è°ƒåº¦å™¨Pçš„æœ¬åœ°é˜Ÿåˆ—ã€ä¸€ä¸ªæ˜¯å…¨å±€Gé˜Ÿåˆ—ã€‚æ–°åˆ›å»ºçš„Gä¼šå…ˆä¿å­˜åœ¨Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœPçš„æœ¬åœ°é˜Ÿåˆ—å·²ç»æ»¡äº†å°±ä¼šä¿å­˜åœ¨å…¨å±€çš„é˜Ÿåˆ—ä¸­ï¼›\n3ã€Gåªèƒ½è¿è¡Œåœ¨Mä¸­ï¼Œä¸€ä¸ªMå¿…é¡»æŒæœ‰ä¸€ä¸ªPï¼ŒMä¸Pæ˜¯1ï¼š1çš„å…³ç³»ã€‚Mä¼šä»Pçš„æœ¬åœ°é˜Ÿåˆ—å¼¹å‡ºä¸€ä¸ªå¯æ‰§è¡ŒçŠ¶æ€çš„Gæ¥æ‰§è¡Œï¼Œå¦‚æœPçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œå°±ä¼šæƒ³å…¶ä»–çš„MPç»„åˆå·å–ä¸€ä¸ªå¯æ‰§è¡Œçš„Gæ¥æ‰§è¡Œï¼›\n4ã€ä¸€ä¸ªMè°ƒåº¦Gæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¾ªç¯æœºåˆ¶ï¼›\n5ã€å½“Mæ‰§è¡ŒæŸä¸€ä¸ªGæ—¶å€™å¦‚æœå‘ç”Ÿäº†syscallæˆ–åˆ™å…¶ä½™é˜»å¡æ“ä½œï¼ŒMä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æœ‰ä¸€äº›Gåœ¨æ‰§è¡Œï¼Œruntimeä¼šæŠŠè¿™ä¸ªçº¿ç¨‹Mä»Pä¸­æ‘˜é™¤(detach)ï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹(å¦‚æœæœ‰ç©ºé—²çš„çº¿ç¨‹å¯ç”¨å°±å¤ç”¨ç©ºé—²çº¿ç¨‹)æ¥æœåŠ¡äºè¿™ä¸ªPï¼›\n6ã€å½“Mç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶å€™ï¼Œè¿™ä¸ªGä¼šå°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pæ‰§è¡Œï¼Œå¹¶æ”¾å…¥åˆ°è¿™ä¸ªPçš„æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœè·å–ä¸åˆ°Pï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹Må˜æˆä¼‘çœ çŠ¶æ€ï¼Œ åŠ å…¥åˆ°ç©ºé—²çº¿ç¨‹ä¸­ï¼Œç„¶åè¿™ä¸ªGä¼šè¢«æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚\n(4)è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸ ç‰¹æ®Šçš„M0å’ŒG0\nM0\nM0æ˜¯å¯åŠ¨ç¨‹åºåçš„ç¼–å·ä¸º0çš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ªMå¯¹åº”çš„å®ä¾‹ä¼šåœ¨å…¨å±€å˜é‡runtime.m0ä¸­ï¼Œä¸éœ€è¦åœ¨heapä¸Šåˆ†é…ï¼ŒM0è´Ÿè´£æ‰§è¡Œåˆå§‹åŒ–æ“ä½œå’Œå¯åŠ¨ç¬¬ä¸€ä¸ªGï¼Œ åœ¨ä¹‹åM0å°±å’Œå…¶ä»–çš„Mä¸€æ ·äº†ã€‚\nG0\nG0æ˜¯æ¯æ¬¡å¯åŠ¨ä¸€ä¸ªMéƒ½ä¼šç¬¬ä¸€ä¸ªåˆ›å»ºçš„gourtineï¼ŒG0ä»…ç”¨äºè´Ÿè´£è°ƒåº¦çš„Gï¼ŒG0ä¸æŒ‡å‘ä»»ä½•å¯æ‰§è¡Œçš„å‡½æ•°, æ¯ä¸ªMéƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„G0ã€‚åœ¨è°ƒåº¦æˆ–ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šä½¿ç”¨G0çš„æ ˆç©ºé—´, å…¨å±€å˜é‡çš„G0æ˜¯M0çš„G0ã€‚\næˆ‘ä»¬æ¥è·Ÿè¸ªä¸€æ®µä»£ç \npackage main import \u0026#34;fmt\u0026#34; func main() { fmt.Println(\u0026#34;Hello world\u0026#34;) } æ¥ä¸‹æ¥æˆ‘ä»¬æ¥é’ˆå¯¹ä¸Šé¢çš„ä»£ç å¯¹è°ƒåº¦å™¨é‡Œé¢çš„ç»“æ„åšä¸€ä¸ªåˆ†æã€‚\nä¹Ÿä¼šç»å†å¦‚ä¸Šå›¾æ‰€ç¤ºçš„è¿‡ç¨‹ï¼š\n runtimeåˆ›å»ºæœ€åˆçš„çº¿ç¨‹m0å’Œgoroutine g0ï¼Œå¹¶æŠŠ2è€…å…³è”ã€‚ è°ƒåº¦å™¨åˆå§‹åŒ–ï¼šåˆå§‹åŒ–m0ã€æ ˆã€åƒåœ¾å›æ”¶ï¼Œä»¥åŠåˆ›å»ºå’Œåˆå§‹åŒ–ç”±GOMAXPROCSä¸ªPæ„æˆçš„Påˆ—è¡¨ã€‚ ç¤ºä¾‹ä»£ç ä¸­çš„mainå‡½æ•°æ˜¯main.mainï¼Œruntimeä¸­ä¹Ÿæœ‰1ä¸ªmainå‡½æ•°â€”â€”runtime.mainï¼Œä»£ç ç»è¿‡ç¼–è¯‘åï¼Œruntime.mainä¼šè°ƒç”¨main.mainï¼Œç¨‹åºå¯åŠ¨æ—¶ä¼šä¸ºruntime.mainåˆ›å»ºgoroutineï¼Œç§°å®ƒä¸ºmain goroutineå§ï¼Œç„¶åæŠŠmain goroutineåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚ å¯åŠ¨m0ï¼Œm0å·²ç»ç»‘å®šäº†Pï¼Œä¼šä»Pçš„æœ¬åœ°é˜Ÿåˆ—è·å–Gï¼Œè·å–åˆ°main goroutineã€‚ Gæ‹¥æœ‰æ ˆï¼ŒMæ ¹æ®Gä¸­çš„æ ˆä¿¡æ¯å’Œè°ƒåº¦ä¿¡æ¯è®¾ç½®è¿è¡Œç¯å¢ƒ Mè¿è¡ŒG Gé€€å‡ºï¼Œå†æ¬¡å›åˆ°Mè·å–å¯è¿è¡Œçš„Gï¼Œè¿™æ ·é‡å¤ä¸‹å»ï¼Œç›´åˆ°main.mainé€€å‡ºï¼Œruntime.mainæ‰§è¡ŒDeferå’ŒPanicå¤„ç†ï¼Œæˆ–è°ƒç”¨runtime.exité€€å‡ºç¨‹åºã€‚  è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸå‡ ä¹å æ»¡äº†ä¸€ä¸ªGoç¨‹åºçš„ä¸€ç”Ÿï¼Œruntime.mainçš„goroutineæ‰§è¡Œä¹‹å‰éƒ½æ˜¯ä¸ºè°ƒåº¦å™¨åšå‡†å¤‡å·¥ä½œï¼Œruntime.mainçš„goroutineè¿è¡Œï¼Œæ‰æ˜¯è°ƒåº¦å™¨çš„çœŸæ­£å¼€å§‹ï¼Œç›´åˆ°runtime.mainç»“æŸè€Œç»“æŸã€‚\n(5)å¯è§†åŒ–GMPç¼–ç¨‹ æœ‰2ç§æ–¹å¼å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç¨‹åºçš„GMPçš„æ•°æ®ã€‚\næ–¹å¼1ï¼šgo tool trace\ntraceè®°å½•äº†è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼Œèƒ½æä¾›å¯è§†åŒ–çš„Webé¡µé¢ã€‚\nç®€å•æµ‹è¯•ä»£ç ï¼šmainå‡½æ•°åˆ›å»ºtraceï¼Œtraceä¼šè¿è¡Œåœ¨å•ç‹¬çš„goroutineä¸­ï¼Œç„¶åmainæ‰“å°\u0026quot;Hello World\u0026quot;é€€å‡ºã€‚\n trace.go\n package main import ( \u0026#34;os\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;runtime/trace\u0026#34; ) func main() { //åˆ›å»ºtraceæ–‡ä»¶  f, err := os.Create(\u0026#34;trace.out\u0026#34;) if err != nil { panic(err) } defer f.Close() //å¯åŠ¨trace goroutine  err = trace.Start(f) if err != nil { panic(err) } defer trace.Stop() //main  fmt.Println(\u0026#34;Hello World\u0026#34;) } è¿è¡Œç¨‹åº\n$ go run trace.go Hello World ä¼šå¾—åˆ°ä¸€ä¸ªtrace.outæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå·¥å…·æ‰“å¼€ï¼Œæ¥åˆ†æè¿™ä¸ªæ–‡ä»¶ã€‚\n$ go tool trace trace.out 2020/02/23 10:44:11 Parsing trace... 2020/02/23 10:44:11 Splitting trace... 2020/02/23 10:44:11 Opening browser. Trace viewer is listening on http://127.0.0.1:33479 æˆ‘ä»¬å¯ä»¥é€šè¿‡æµè§ˆå™¨æ‰“å¼€http://127.0.0.1:33479ç½‘å€ï¼Œç‚¹å‡»view trace èƒ½å¤Ÿçœ‹è§å¯è§†åŒ–çš„è°ƒåº¦æµç¨‹ã€‚\nGä¿¡æ¯\nç‚¹å‡»Goroutinesé‚£ä¸€è¡Œå¯è§†åŒ–çš„æ•°æ®æ¡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€äº›è¯¦ç»†çš„ä¿¡æ¯ã€‚\nä¸€å…±æœ‰ä¸¤ä¸ªGåœ¨ç¨‹åºä¸­ï¼Œä¸€ä¸ªæ˜¯ç‰¹æ®Šçš„G0ï¼Œæ˜¯æ¯ä¸ªMå¿…é¡»æœ‰çš„ä¸€ä¸ªåˆå§‹åŒ–çš„Gï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸å¿…è®¨è®ºã€‚\nå…¶ä¸­G1åº”è¯¥å°±æ˜¯main goroutine(æ‰§è¡Œmainå‡½æ•°çš„åç¨‹)ï¼Œåœ¨ä¸€æ®µæ—¶é—´å†…å¤„äºå¯è¿è¡Œå’Œè¿è¡Œçš„çŠ¶æ€ã€‚\nMä¿¡æ¯\nç‚¹å‡»Threadsé‚£ä¸€è¡Œå¯è§†åŒ–çš„æ•°æ®æ¡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€äº›è¯¦ç»†çš„ä¿¡æ¯ã€‚\nä¸€å…±æœ‰ä¸¤ä¸ªMåœ¨ç¨‹åºä¸­ï¼Œä¸€ä¸ªæ˜¯ç‰¹æ®Šçš„M0ï¼Œç”¨äºåˆå§‹åŒ–ä½¿ç”¨ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸å¿…è®¨è®ºã€‚\nPä¿¡æ¯\nG1ä¸­è°ƒç”¨äº†main.mainï¼Œåˆ›å»ºäº†trace goroutine g18ã€‚G1è¿è¡Œåœ¨P1ä¸Šï¼ŒG18è¿è¡Œåœ¨P0ä¸Šã€‚\nè¿™é‡Œæœ‰ä¸¤ä¸ªPï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªPå¿…é¡»ç»‘å®šä¸€ä¸ªMæ‰èƒ½è°ƒåº¦Gã€‚\næˆ‘ä»¬åœ¨æ¥çœ‹çœ‹ä¸Šé¢çš„Mä¿¡æ¯ã€‚\næˆ‘ä»¬ä¼šå‘ç°ï¼Œç¡®å®G18åœ¨P0ä¸Šè¢«è¿è¡Œçš„æ—¶å€™ï¼Œç¡®å®åœ¨Threadsè¡Œå¤šäº†ä¸€ä¸ªMçš„æ•°æ®ï¼Œç‚¹å‡»æŸ¥çœ‹å¦‚ä¸‹ï¼š å¤šäº†ä¸€ä¸ªM2åº”è¯¥å°±æ˜¯P0ä¸ºäº†æ‰§è¡ŒG18è€ŒåŠ¨æ€åˆ›å»ºçš„M2.\næ–¹å¼2ï¼šDebug trace\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;time\u0026#34; ) func main() { for i := 0; i \u0026lt; 5; i++ { time.Sleep(time.Second) fmt.Println(\u0026#34;Hello World\u0026#34;) } } ç¼–è¯‘\n$ go build trace2.go\ré€šè¿‡Debugæ–¹å¼è¿è¡Œ\n$ GODEBUG=schedtrace=1000 ./trace2 SCHED 0ms: gomaxprocs=2 idleprocs=0 threads=4 spinningthreads=1 idlethreads=1 runqueue=0 [0 0] Hello World SCHED 1003ms: gomaxprocs=2 idleprocs=2 threads=4 spinningthreads=0 idlethreads=2 runqueue=0 [0 0] Hello World SCHED 2014ms: gomaxprocs=2 idleprocs=2 threads=4 spinningthreads=0 idlethreads=2 runqueue=0 [0 0] Hello World SCHED 3015ms: gomaxprocs=2 idleprocs=2 threads=4 spinningthreads=0 idlethreads=2 runqueue=0 [0 0] Hello World SCHED 4023ms: gomaxprocs=2 idleprocs=2 threads=4 spinningthreads=0 idlethreads=2 runqueue=0 [0 0] Hello World  SCHEDï¼šè°ƒè¯•ä¿¡æ¯è¾“å‡ºæ ‡å¿—å­—ç¬¦ä¸²ï¼Œä»£è¡¨æœ¬è¡Œæ˜¯goroutineè°ƒåº¦å™¨çš„è¾“å‡ºï¼› 0msï¼šå³ä»ç¨‹åºå¯åŠ¨åˆ°è¾“å‡ºè¿™è¡Œæ—¥å¿—çš„æ—¶é—´ï¼› gomaxprocs: Pçš„æ•°é‡ï¼Œæœ¬ä¾‹æœ‰2ä¸ªP, å› ä¸ºé»˜è®¤çš„Pçš„å±æ€§æ˜¯å’Œcpuæ ¸å¿ƒæ•°é‡é»˜è®¤ä¸€è‡´ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡GOMAXPROCSæ¥è®¾ç½®ï¼› idleprocs: å¤„äºidleçŠ¶æ€çš„Pçš„æ•°é‡ï¼›é€šè¿‡gomaxprocså’Œidleprocsçš„å·®å€¼ï¼Œæˆ‘ä»¬å°±å¯çŸ¥é“æ‰§è¡Œgoä»£ç çš„Pçš„æ•°é‡ï¼› threads: os threads/Mçš„æ•°é‡ï¼ŒåŒ…å«schedulerä½¿ç”¨çš„mæ•°é‡ï¼ŒåŠ ä¸Šruntimeè‡ªç”¨çš„ç±»ä¼¼sysmonè¿™æ ·çš„threadçš„æ•°é‡ï¼› spinningthreads: å¤„äºè‡ªæ—‹çŠ¶æ€çš„os threadæ•°é‡ï¼› idlethread: å¤„äºidleçŠ¶æ€çš„os threadçš„æ•°é‡ï¼› runqueue=0ï¼š Schedulerå…¨å±€é˜Ÿåˆ—ä¸­Gçš„æ•°é‡ï¼› [0 0]: åˆ†åˆ«ä¸º2ä¸ªPçš„local queueä¸­çš„Gçš„æ•°é‡ã€‚  ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬æ¥ç»§ç»­è¯¦ç»†çš„åˆ†æGMPè°ƒåº¦åŸç†çš„ä¸€äº›åœºæ™¯é—®é¢˜ã€‚\nä¸‰ã€Goè°ƒåº¦å™¨è°ƒåº¦åœºæ™¯è¿‡ç¨‹å…¨è§£æ (1)åœºæ™¯1 Pæ‹¥æœ‰G1ï¼ŒM1è·å–Påå¼€å§‹è¿è¡ŒG1ï¼ŒG1ä½¿ç”¨go func()åˆ›å»ºäº†G2ï¼Œä¸ºäº†å±€éƒ¨æ€§G2ä¼˜å…ˆåŠ å…¥åˆ°P1çš„æœ¬åœ°é˜Ÿåˆ—ã€‚\n (2)åœºæ™¯2 G1è¿è¡Œå®Œæˆå(å‡½æ•°ï¼šgoexit)ï¼ŒMä¸Šè¿è¡Œçš„goroutineåˆ‡æ¢ä¸ºG0ï¼ŒG0è´Ÿè´£è°ƒåº¦æ—¶åç¨‹çš„åˆ‡æ¢ï¼ˆå‡½æ•°ï¼šscheduleï¼‰ã€‚ä»Pçš„æœ¬åœ°é˜Ÿåˆ—å–G2ï¼Œä»G0åˆ‡æ¢åˆ°G2ï¼Œå¹¶å¼€å§‹è¿è¡ŒG2(å‡½æ•°ï¼šexecute)ã€‚å®ç°äº†çº¿ç¨‹M1çš„å¤ç”¨ã€‚\n (3)åœºæ™¯3 å‡è®¾æ¯ä¸ªPçš„æœ¬åœ°é˜Ÿåˆ—åªèƒ½å­˜4ä¸ªGã€‚G2è¦åˆ›å»ºäº†6ä¸ªGï¼Œå‰4ä¸ªGï¼ˆG3, G4, G5, G6ï¼‰å·²ç»åŠ å…¥p1çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œp1æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ã€‚\n (4)åœºæ™¯4 G2åœ¨åˆ›å»ºG7çš„æ—¶å€™ï¼Œå‘ç°P1çš„æœ¬åœ°é˜Ÿåˆ—å·²æ»¡ï¼Œéœ€è¦æ‰§è¡Œè´Ÿè½½å‡è¡¡(æŠŠP1ä¸­æœ¬åœ°é˜Ÿåˆ—ä¸­å‰ä¸€åŠçš„Gï¼Œè¿˜æœ‰æ–°åˆ›å»ºGè½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—)\n ï¼ˆå®ç°ä¸­å¹¶ä¸ä¸€å®šæ˜¯æ–°çš„Gï¼Œå¦‚æœGæ˜¯G2ä¹‹åå°±æ‰§è¡Œçš„ï¼Œä¼šè¢«ä¿å­˜åœ¨æœ¬åœ°é˜Ÿåˆ—ï¼Œåˆ©ç”¨æŸä¸ªè€çš„Gæ›¿æ¢æ–°GåŠ å…¥å…¨å±€é˜Ÿåˆ—ï¼‰\n è¿™äº›Gè¢«è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—æ—¶ï¼Œä¼šè¢«æ‰“ä¹±é¡ºåºã€‚æ‰€ä»¥G3,G4,G7è¢«è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—ã€‚\n (5)åœºæ™¯5 G2åˆ›å»ºG8æ—¶ï¼ŒP1çš„æœ¬åœ°é˜Ÿåˆ—æœªæ»¡ï¼Œæ‰€ä»¥G8ä¼šè¢«åŠ å…¥åˆ°P1çš„æœ¬åœ°é˜Ÿåˆ—ã€‚\nG8åŠ å…¥åˆ°P1ç‚¹æœ¬åœ°é˜Ÿåˆ—çš„åŸå› è¿˜æ˜¯å› ä¸ºP1æ­¤æ—¶åœ¨ä¸M1ç»‘å®šï¼Œè€ŒG2æ­¤æ—¶æ˜¯M1åœ¨æ‰§è¡Œã€‚æ‰€ä»¥G2åˆ›å»ºçš„æ–°çš„Gä¼šä¼˜å…ˆæ”¾ç½®åˆ°è‡ªå·±çš„Mç»‘å®šçš„Pä¸Šã€‚\n (6)åœºæ™¯6 è§„å®šï¼šåœ¨åˆ›å»ºGæ—¶ï¼Œè¿è¡Œçš„Gä¼šå°è¯•å”¤é†’å…¶ä»–ç©ºé—²çš„På’ŒMç»„åˆå»æ‰§è¡Œã€‚\nå‡å®šG2å”¤é†’äº†M2ï¼ŒM2ç»‘å®šäº†P2ï¼Œå¹¶è¿è¡ŒG0ï¼Œä½†P2æœ¬åœ°é˜Ÿåˆ—æ²¡æœ‰Gï¼ŒM2æ­¤æ—¶ä¸ºè‡ªæ—‹çº¿ç¨‹**ï¼ˆæ²¡æœ‰Gä½†ä¸ºè¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¸æ–­å¯»æ‰¾Gï¼‰**ã€‚\n (7)åœºæ™¯7 M2å°è¯•ä»å…¨å±€é˜Ÿåˆ—(ç®€ç§°â€œGQâ€)å–ä¸€æ‰¹Gæ”¾åˆ°P2çš„æœ¬åœ°é˜Ÿåˆ—ï¼ˆå‡½æ•°ï¼šfindrunnable()ï¼‰ã€‚M2ä»å…¨å±€é˜Ÿåˆ—å–çš„Gæ•°é‡ç¬¦åˆä¸‹é¢çš„å…¬å¼ï¼š\nn = min(len(GQ)/GOMAXPROCS + 1, len(GQ/2)) è‡³å°‘ä»å…¨å±€é˜Ÿåˆ—å–1ä¸ªgï¼Œä½†æ¯æ¬¡ä¸è¦ä»å…¨å±€é˜Ÿåˆ—ç§»åŠ¨å¤ªå¤šçš„gåˆ°pæœ¬åœ°é˜Ÿåˆ—ï¼Œç»™å…¶ä»–pç•™ç‚¹ã€‚è¿™æ˜¯ä»å…¨å±€é˜Ÿåˆ—åˆ°Pæœ¬åœ°é˜Ÿåˆ—çš„è´Ÿè½½å‡è¡¡ã€‚\nå‡å®šæˆ‘ä»¬åœºæ™¯ä¸­ä¸€å…±æœ‰4ä¸ªPï¼ˆGOMAXPROCSè®¾ç½®ä¸º4ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…è®¸æœ€å¤šå°±èƒ½ç”¨4ä¸ªPæ¥ä¾›Mä½¿ç”¨ï¼‰ã€‚æ‰€ä»¥M2åªä»èƒ½ä»å…¨å±€é˜Ÿåˆ—å–1ä¸ªGï¼ˆå³G3ï¼‰ç§»åŠ¨P2æœ¬åœ°é˜Ÿåˆ—ï¼Œç„¶åå®Œæˆä»G0åˆ°G3çš„åˆ‡æ¢ï¼Œè¿è¡ŒG3ã€‚\n (8)åœºæ™¯8 å‡è®¾G2ä¸€ç›´åœ¨M1ä¸Šè¿è¡Œï¼Œç»è¿‡2è½®åï¼ŒM2å·²ç»æŠŠG7ã€G4ä»å…¨å±€é˜Ÿåˆ—è·å–åˆ°äº†P2çš„æœ¬åœ°é˜Ÿåˆ—å¹¶å®Œæˆè¿è¡Œï¼Œå…¨å±€é˜Ÿåˆ—å’ŒP2çš„æœ¬åœ°é˜Ÿåˆ—éƒ½ç©ºäº†,å¦‚åœºæ™¯8å›¾çš„å·¦åŠéƒ¨åˆ†ã€‚\nå…¨å±€é˜Ÿåˆ—å·²ç»æ²¡æœ‰Gï¼Œé‚£må°±è¦æ‰§è¡Œwork stealing(å·å–)ï¼šä»å…¶ä»–æœ‰Gçš„På“ªé‡Œå·å–ä¸€åŠGè¿‡æ¥ï¼Œæ”¾åˆ°è‡ªå·±çš„Pæœ¬åœ°é˜Ÿåˆ—ã€‚P2ä»P1çš„æœ¬åœ°é˜Ÿåˆ—å°¾éƒ¨å–ä¸€åŠçš„Gï¼Œæœ¬ä¾‹ä¸­ä¸€åŠåˆ™åªæœ‰1ä¸ªG8ï¼Œæ”¾åˆ°P2çš„æœ¬åœ°é˜Ÿåˆ—å¹¶æ‰§è¡Œã€‚\n (9)åœºæ™¯9 G1æœ¬åœ°é˜Ÿåˆ—G5ã€G6å·²ç»è¢«å…¶ä»–Må·èµ°å¹¶è¿è¡Œå®Œæˆï¼Œå½“å‰M1å’ŒM2åˆ†åˆ«åœ¨è¿è¡ŒG2å’ŒG8ï¼ŒM3å’ŒM4æ²¡æœ‰goroutineå¯ä»¥è¿è¡Œï¼ŒM3å’ŒM4å¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œå®ƒä»¬ä¸æ–­å¯»æ‰¾goroutineã€‚\nä¸ºä»€ä¹ˆè¦è®©m3å’Œm4è‡ªæ—‹ï¼Œè‡ªæ—‹æœ¬è´¨æ˜¯åœ¨è¿è¡Œï¼Œçº¿ç¨‹åœ¨è¿è¡Œå´æ²¡æœ‰æ‰§è¡ŒGï¼Œå°±å˜æˆäº†æµªè´¹CPU. ä¸ºä»€ä¹ˆä¸é”€æ¯ç°åœºï¼Œæ¥èŠ‚çº¦CPUèµ„æºã€‚å› ä¸ºåˆ›å»ºå’Œé”€æ¯CPUä¹Ÿä¼šæµªè´¹æ—¶é—´ï¼Œæˆ‘ä»¬å¸Œæœ›å½“æœ‰æ–°goroutineåˆ›å»ºæ—¶ï¼Œç«‹åˆ»èƒ½æœ‰Mè¿è¡Œå®ƒï¼Œå¦‚æœé”€æ¯å†æ–°å»ºå°±å¢åŠ äº†æ—¶å»¶ï¼Œé™ä½äº†æ•ˆç‡ã€‚å½“ç„¶ä¹Ÿè€ƒè™‘äº†è¿‡å¤šçš„è‡ªæ—‹çº¿ç¨‹æ˜¯æµªè´¹CPUï¼Œæ‰€ä»¥ç³»ç»Ÿä¸­æœ€å¤šæœ‰GOMAXPROCSä¸ªè‡ªæ—‹çš„çº¿ç¨‹(å½“å‰ä¾‹å­ä¸­çš„GOMAXPROCS=4ï¼Œæ‰€ä»¥ä¸€å…±4ä¸ªP)ï¼Œå¤šä½™çš„æ²¡äº‹åšçº¿ç¨‹ä¼šè®©ä»–ä»¬ä¼‘çœ ã€‚\n (10)åœºæ™¯10 å‡å®šå½“å‰é™¤äº†M3å’ŒM4ä¸ºè‡ªæ—‹çº¿ç¨‹ï¼Œè¿˜æœ‰M5å’ŒM6ä¸ºç©ºé—²çš„çº¿ç¨‹(æ²¡æœ‰å¾—åˆ°Pçš„ç»‘å®šï¼Œæ³¨æ„æˆ‘ä»¬è¿™é‡Œæœ€å¤šå°±åªèƒ½å¤Ÿå­˜åœ¨4ä¸ªPï¼Œæ‰€ä»¥Pçš„æ•°é‡åº”è¯¥æ°¸è¿œæ˜¯M\u0026gt;=P, å¤§éƒ¨åˆ†éƒ½æ˜¯Måœ¨æŠ¢å éœ€è¦è¿è¡Œçš„P)ï¼ŒG8åˆ›å»ºäº†G9ï¼ŒG8è¿›è¡Œäº†é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒM2å’ŒP2ç«‹å³è§£ç»‘ï¼ŒP2ä¼šæ‰§è¡Œä»¥ä¸‹åˆ¤æ–­ï¼šå¦‚æœP2æœ¬åœ°é˜Ÿåˆ—æœ‰Gã€å…¨å±€é˜Ÿåˆ—æœ‰Gæˆ–æœ‰ç©ºé—²çš„Mï¼ŒP2éƒ½ä¼šç«‹é©¬å”¤é†’1ä¸ªMå’Œå®ƒç»‘å®šï¼Œå¦åˆ™P2åˆ™ä¼šåŠ å…¥åˆ°ç©ºé—²Påˆ—è¡¨ï¼Œç­‰å¾…Mæ¥è·å–å¯ç”¨çš„pã€‚æœ¬åœºæ™¯ä¸­ï¼ŒP2æœ¬åœ°é˜Ÿåˆ—æœ‰G9ï¼Œå¯ä»¥å’Œå…¶ä»–ç©ºé—²çš„çº¿ç¨‹M5ç»‘å®šã€‚\n (11)åœºæ™¯11 G8åˆ›å»ºäº†G9ï¼Œå‡å¦‚G8è¿›è¡Œäº†éé˜»å¡ç³»ç»Ÿè°ƒç”¨ã€‚\nM2å’ŒP2ä¼šè§£ç»‘ï¼Œä½†M2ä¼šè®°ä½P2ï¼Œç„¶åG8å’ŒM2è¿›å…¥ç³»ç»Ÿè°ƒç”¨çŠ¶æ€ã€‚å½“G8å’ŒM2é€€å‡ºç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šå°è¯•è·å–P2ï¼Œå¦‚æœæ— æ³•è·å–ï¼Œåˆ™è·å–ç©ºé—²çš„Pï¼Œå¦‚æœä¾ç„¶æ²¡æœ‰ï¼ŒG8ä¼šè¢«è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—,M2å› ä¸ºæ²¡æœ‰Pçš„ç»‘å®šè€Œå˜æˆä¼‘çœ çŠ¶æ€(é•¿æ—¶é—´ä¼‘çœ ç­‰å¾…GCå›æ”¶é”€æ¯)ã€‚\n å››ã€å°ç»“ æ€»ç»“ï¼ŒGoè°ƒåº¦å™¨å¾ˆè½»é‡ä¹Ÿå¾ˆç®€å•ï¼Œè¶³ä»¥æ’‘èµ·goroutineçš„è°ƒåº¦å·¥ä½œï¼Œå¹¶ä¸”è®©Goå…·æœ‰äº†åŸç”Ÿï¼ˆå¼ºå¤§ï¼‰å¹¶å‘çš„èƒ½åŠ›ã€‚Goè°ƒåº¦æœ¬è´¨æ˜¯æŠŠå¤§é‡çš„goroutineåˆ†é…åˆ°å°‘é‡çº¿ç¨‹ä¸Šå»æ‰§è¡Œï¼Œå¹¶åˆ©ç”¨å¤šæ ¸å¹¶è¡Œï¼Œå®ç°æ›´å¼ºå¤§çš„å¹¶å‘ã€‚\n å‚è€ƒé“¾æ¥ Golangçš„åç¨‹è°ƒåº¦å™¨åŸç†åŠGMPè®¾è®¡æ€æƒ³ï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/go/golang%E7%9A%84%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8%E5%8E%9F%E7%90%86%E5%8F%8Agmp%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/","series":["Manual"],"tags":["GO"],"title":"Golangçš„åç¨‹è°ƒåº¦å™¨åŸç†åŠGMPè®¾è®¡æ€æƒ³"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"æ–¹æ³•ä¸€ï¼šè°ƒæ•´PATH export PATH=/usr/local/go/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin æ–¹æ³•äºŒï¼šè°ƒæ•´è½¯é“¾æ¥(æœªéªŒè¯) //æŸ¥çœ‹å½“å‰è½¯é“¾æ¥æŒ‡å‘\rcd /usr/local/bin ls -trl | grep go\r//è°ƒæ•´è½¯é“¾æ¥\rln -snf /usr/local/Cellar/go/1.16.3/bin go\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/go/go%E5%A4%9A%E7%89%88%E6%9C%AC%E5%88%87%E6%8D%A2/","series":["Manual"],"tags":["GO"],"title":"goå¤šç‰ˆæœ¬åˆ‡æ¢"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1ã€HashMapæ˜¯HashTableçš„è½»é‡çº§ç‰ˆæœ¬ï¼Œ HashTableæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…¶æ–¹æ³•éƒ½è¢«synchronizedå…³é”®åŒæ­¥\n2ã€ HashMap æŠŠ Hashtable çš„ contains æ–¹æ³•å»æ‰äº†ï¼Œæ”¹æˆ containsValue å’Œ containsKeyã€‚å› ä¸º contains æ–¹æ³•å®¹æ˜“è®©äººå¼•èµ·è¯¯è§£ã€‚\n3ã€ HashMapå…è®¸å°† null ä½œä¸ºä¸€ä¸ª entry çš„ key æˆ–è€… valueï¼Œè€Œ Hashtable ä¸å…è®¸ã€‚\n4ã€HashTable ç»§æ‰¿è‡ª Dictionary ç±»ï¼Œè€Œ HashMap æ˜¯ Java1.2 å¼•è¿›çš„ Map interface çš„ä¸€ä¸ªå®ç°ã€‚\n5ã€Hashtable å’Œ HashMap é‡‡ç”¨çš„ hash/rehash ç®—æ³•éƒ½å¤§æ¦‚ä¸€æ ·ï¼Œæ‰€ä»¥æ€§èƒ½ä¸ä¼šæœ‰å¾ˆå¤§çš„å·®å¼‚ã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/hashmap%E5%92%8Chashtable%E5%8C%BA%E5%88%AB/","series":["Manual"],"tags":["Java"],"title":"HashMapå’ŒHashTableåŒºåˆ«"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"http/2åœ¨http/1ç³»åˆ—çš„åŸºç¡€ä¸Šä¼˜åŒ–äº†é€šä¿¡æ•ˆç‡ï¼Œä¸»è¦å¾—ç›Šäºå¦‚ä¸‹å‡ ç‚¹æ”¹è¿›ï¼š\nä¸€ã€ å¤šè·¯å¤ç”¨çš„å•ä¸€é•¿è¿æ¥ 1.å•ä¸€é•¿è¿æ¥ åœ¨HTTP/2ä¸­ï¼Œå®¢æˆ·ç«¯å‘æŸä¸ªåŸŸåçš„æœåŠ¡å™¨è¯·æ±‚é¡µé¢çš„è¿‡ç¨‹ä¸­ï¼Œåªä¼šåˆ›å»ºä¸€æ¡TCPè¿æ¥ï¼Œå³ä½¿è¿™é¡µé¢å¯èƒ½åŒ…å«ä¸Šç™¾ä¸ªèµ„æºã€‚ å•ä¸€çš„è¿æ¥åº”è¯¥æ˜¯HTTP2çš„ä¸»è¦ä¼˜åŠ¿ï¼Œå•ä¸€çš„è¿æ¥èƒ½å‡å°‘TCPæ¡æ‰‹ï¼ˆè¿˜æœ‰sslæ¡æ‰‹çš„å¼€é”€ï¼‰å¸¦æ¥çš„æ—¶å»¶ ã€‚HTTP2ä¸­ç”¨ä¸€æ¡å•ä¸€çš„é•¿è¿æ¥ï¼Œé¿å…äº†åˆ›å»ºå¤šä¸ªTCPè¿æ¥å¸¦æ¥çš„ç½‘ç»œå¼€é”€ï¼Œæé«˜äº†ååé‡ã€‚\n2.å¤šè·¯å¤ç”¨ HTTP2è™½ç„¶åªæœ‰ä¸€æ¡TCPè¿æ¥ï¼Œä½†æ˜¯åœ¨é€»è¾‘ä¸Šåˆ†æˆäº†å¾ˆå¤šstreamã€‚HTTP2æŠŠè¦ä¼ è¾“çš„ä¿¡æ¯åˆ†å‰²æˆä¸€ä¸ªä¸ªäºŒè¿›åˆ¶å¸§ï¼Œé¦–éƒ¨ä¿¡æ¯ä¼šè¢«å°è£…åˆ°HEADER Frameï¼Œç›¸åº”çš„request bodyå°±æ”¾åˆ°DATA Frame,ä¸€ä¸ªå¸§ä½ å¯ä»¥çœ‹æˆè·¯ä¸Šçš„ä¸€è¾†è½¦,åªè¦ç»™è¿™äº›è½¦ç¼–å·ï¼Œè®©1å·è½¦éƒ½èµ°1å·é—¨å‡ºï¼Œ2å·è½¦éƒ½èµ°2å·é—¨å‡ºï¼Œå°±æŠŠä¸åŒçš„httpè¯·æ±‚æˆ–è€…å“åº”åŒºåˆ†å¼€æ¥äº†ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œè¦æ±‚åŒä¸€ä¸ªè¯·æ±‚æˆ–è€…å“åº”çš„å¸§å¿…é¡»æ˜¯æœ‰æœ‰åºçš„ï¼Œè¦ä¿è¯FIFOçš„ï¼Œä½†æ˜¯ä¸åŒçš„è¯·æ±‚æˆ–è€…å“åº”å¸§å¯ä»¥äº’ç›¸ç©¿æ’ã€‚è¿™å°±æ˜¯HTTP2çš„å¤šè·¯å¤ç”¨ï¼Œæ˜¯ä¸æ˜¯å……åˆ†åˆ©ç”¨äº†ç½‘ç»œå¸¦å®½ï¼Œæ˜¯ä¸æ˜¯æé«˜äº†å¹¶å‘åº¦ï¼Ÿ\näºŒã€å¤´éƒ¨å‹ç¼©å’ŒäºŒè¿›åˆ¶æ ¼å¼ http1.xä¸€ç›´éƒ½æ˜¯plain text,å¯¹æ­¤æˆ‘åªèƒ½æƒ³åˆ°ä¸€ä¸ªä¼˜ç‚¹ï¼Œä¾¿äºé˜…è¯»å’Œdebugã€‚ä½†æ˜¯ï¼Œç°åœ¨å¾ˆå¤šéƒ½èµ°httpsï¼ŒSSLä¹ŸæŠŠplain textå˜æˆäº†äºŒè¿›åˆ¶ï¼Œé‚£è¿™ä¸ªä¼˜ç‚¹ä¹Ÿæ²¡äº†ã€‚ äºæ˜¯HTTP2æäº†ä¸ªHPACKå‹ç¼©æ¥å‹ç¼©å¤´éƒ¨ï¼Œå‡å°‘æŠ¥æ–‡å¤§å°(è°ƒè¯•è¿™æ ·çš„åè®®å°†éœ€è¦curlè¿™æ ·çš„å·¥å…·ï¼Œè¦è¿›ä¸€æ­¥åœ°åˆ†æç½‘ç»œæ•°æ®æµéœ€è¦ç±»ä¼¼Wiresharkçš„http2è§£æå™¨)ã€‚\nä¸‰ã€æœåŠ¡ç«¯æ¨é€Server Push è¿™ä¸ªåŠŸèƒ½é€šå¸¸è¢«ç§°ä½œâ€œç¼“å­˜æ¨é€â€ã€‚ä¸»è¦çš„æ€æƒ³æ˜¯ï¼šå½“ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚èµ„æºXï¼Œè€ŒæœåŠ¡å™¨çŸ¥é“å®ƒå¾ˆå¯èƒ½ä¹Ÿéœ€è¦èµ„æºZçš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨å¯ä»¥åœ¨å®¢æˆ·ç«¯å‘é€è¯·æ±‚å‰ï¼Œä¸»åŠ¨å°†èµ„æºZæ¨é€ç»™å®¢æˆ·ç«¯ã€‚è¿™ä¸ªåŠŸèƒ½å¸®åŠ©å®¢æˆ·ç«¯å°†Zæ”¾è¿›ç¼“å­˜ä»¥å¤‡å°†æ¥ä¹‹éœ€ã€‚\næ€»ç»“  å•ä¸€çš„é•¿è¿æ¥ï¼Œå‡å°‘äº†SSLæ¡æ‰‹çš„å¼€é”€ å¤´éƒ¨è¢«å‹ç¼©ï¼Œå‡å°‘äº†æ•°æ®ä¼ è¾“é‡ å¤šè·¯å¤ç”¨èƒ½å¤§å¹…æé«˜ä¼ è¾“æ•ˆç‡ï¼Œä¸ç”¨ç­‰å¾…ä¸Šä¸€ä¸ªè¯·æ±‚çš„å“åº” ä¸ç”¨åƒhttp1.xé‚£æ ·æŠŠå¤šä¸ªæ–‡ä»¶æˆ–è€…èµ„æºå¼„æˆä¸€ä¸ªæ–‡ä»¶æˆ–è€…èµ„æºï¼ˆhttp1.xå¸¸è§çš„ä¼˜åŒ–æ‰‹æ®µï¼‰ï¼Œè¿™æ—¶å€™ï¼Œç¼“å­˜å°±èƒ½æ›´å®¹æ˜“å‘½ä¸­å•Šï¼ˆhttp1.xé‡Œé¢ä½ æ‰æˆä¸€å›¢çš„ä¸œè¥¿æ€ä¹ˆå‘½ä¸­ç¼“å­˜ï¼Ÿï¼‰  å‚è€ƒ HTTP/2 ç›¸æ¯” 1.0 æœ‰å“ªäº›é‡å¤§æ”¹è¿›ï¼Ÿ\rHTTP 2 çš„æ–°ç‰¹æ€§ä½  get äº†å—ï¼Ÿ\rHTTP/2 æœåŠ¡å™¨æ¨é€ï¼ˆServer Pushï¼‰æ•™ç¨‹\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/http/http2/","series":["Manual"],"tags":["CS"],"title":"http2"},{"categories":["äº‘åŸç”Ÿ"],"content":"ingress 1. ingressæ˜¯ä»€ä¹ˆ ingressæ˜¯k8sä¸€ç§èµ„æºå¯¹è±¡ï¼Œå¦‚k8sçš„Deploymentã€Serviceèµ„æºå¯¹è±¡ä¸€æ ·ã€‚å®ƒæ˜¯ä¸€ç§é›†ç¾¤ç»´åº¦æš´éœ²æœåŠ¡çš„æ–¹å¼ï¼Œæ­£å¦‚k8sçš„ClusterIPã€NodePortã€LoadBalanceä¸€æ ·ï¼Œä½†æ˜¯ClusterIPçš„æ–¹å¼åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ï¼ŒNodePortæ–¹å¼çš„è¯ï¼Œæµ‹è¯•ç¯å¢ƒä½¿ç”¨è¿˜è¡Œï¼Œå½“æœ‰å‡ åä¸Šç™¾çš„æœåŠ¡åœ¨é›†ç¾¤ä¸­è¿è¡Œæ—¶ï¼ŒNodePortçš„ç«¯å£ç®¡ç†æ˜¯ç¾éš¾ï¼ŒLoadBalanceæ–¹å¼å—é™äºäº‘å¹³å°ï¼Œä¸”é€šå¸¸åœ¨äº‘å¹³å°éƒ¨ç½²ELBè¿˜éœ€è¦é¢å¤–çš„è´¹ç”¨ã€‚ingressè§„åˆ™æ˜¯å¾ˆçµæ´»çš„ï¼Œå¯ä»¥æ ¹æ®ä¸åŒåŸŸåã€ä¸åŒpathè½¬å‘è¯·æ±‚åˆ°ä¸åŒçš„serviceï¼Œå¹¶ä¸”æ”¯æŒhttps/httpã€‚ 2. ingressä¸ingress-controller è¦ç†è§£ingressï¼Œéœ€è¦åŒºåˆ†ä¸¤ä¸ªæ¦‚å¿µï¼Œingresså’Œingress-controllerï¼š\n ingressï¼šæŒ‡çš„æ˜¯k8sä¸­çš„ä¸€ä¸ªapiå¯¹è±¡ï¼Œä¸€èˆ¬ç”¨yamlé…ç½®ã€‚ä½œç”¨æ˜¯å®šä¹‰è¯·æ±‚å¦‚ä½•è½¬å‘åˆ°serviceçš„è§„åˆ™ï¼Œå¯ä»¥ç†è§£ä¸ºé…ç½®æ¨¡æ¿ã€‚ ingress-controllerï¼šå…·ä½“å®ç°åå‘ä»£ç†åŠè´Ÿè½½å‡è¡¡çš„ç¨‹åºï¼Œå¯¹ingresså®šä¹‰çš„è§„åˆ™è¿›è¡Œè§£æï¼Œæ ¹æ®é…ç½®çš„è§„åˆ™æ¥å®ç°è¯·æ±‚è½¬å‘ã€‚  ç®€å•æ¥è¯´ï¼Œingress-controlleræ‰æ˜¯è´Ÿè´£å…·ä½“è½¬å‘çš„ç»„ä»¶ï¼Œé€šè¿‡å„ç§æ–¹å¼å°†å®ƒæš´éœ²åœ¨é›†ç¾¤å…¥å£ï¼Œå¤–éƒ¨å¯¹é›†ç¾¤çš„è¯·æ±‚æµé‡ä¼šå…ˆåˆ°ingress-controllerï¼Œè€Œingresså¯¹è±¡æ˜¯ç”¨æ¥å‘Šè¯‰ingress-controllerè¯¥å¦‚ä½•è½¬å‘è¯·æ±‚ï¼Œæ¯”å¦‚å“ªäº›åŸŸåå“ªäº›pathè¦è½¬å‘åˆ°å“ªäº›æœåŠ¡ç­‰ç­‰ã€‚\n2.1 ingress ingressæ˜¯ä¸€ä¸ªAPIå¯¹è±¡ï¼Œå’Œå…¶ä»–å¯¹è±¡ä¸€æ ·ï¼Œé€šè¿‡yamlæ–‡ä»¶æ¥é…ç½®ã€‚ingressé€šè¿‡httpæˆ–httpsæš´éœ²é›†ç¾¤å†…éƒ¨serviceï¼Œç»™serviceæä¾›å¤–éƒ¨URLã€è´Ÿè½½å‡è¡¡ã€SSL/TLSèƒ½åŠ›ä»¥åŠåŸºäºhostçš„æ–¹å‘ä»£ç†ã€‚ingressè¦ä¾é ingress-controlleræ¥å…·ä½“å®ç°ä»¥ä¸ŠåŠŸèƒ½ã€‚å‰ä¸€å°èŠ‚çš„å›¾å¦‚æœç”¨ingressæ¥è¡¨ç¤ºï¼Œå¤§æ¦‚å°±æ˜¯å¦‚ä¸‹é…ç½®ï¼š\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: abc-ingress annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; nginx.ingress.kubernetes.io/use-regex: \u0026#34;true\u0026#34; spec: tls: - hosts: - api.abc.com secretName: abc-tls rules: - host: api.abc.com http: paths: - backend: serviceName: apiserver servicePort: 80 - host: www.abc.com http: paths: - path: /image/* backend: serviceName: fileserver servicePort: 80 - host: www.abc.com http: paths: - backend: serviceName: feserver servicePort: 8080 2.2 ingress-controller ingress-controllerå¹¶ä¸æ˜¯k8sè‡ªå¸¦çš„ç»„ä»¶ï¼Œå®é™…ä¸Šingress-controlleråªæ˜¯ä¸€ä¸ªç»Ÿç§°ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä¸åŒçš„ingress-controllerå®ç°ï¼Œç›®å‰ï¼Œç”±k8sç»´æŠ¤çš„ingress-controlleråªæœ‰googleäº‘çš„GCEä¸ingress-nginxä¸¤ä¸ªï¼Œå…¶ä»–è¿˜æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹ç»´æŠ¤çš„ingress-controllerï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ä½†æ˜¯ä¸ç®¡å“ªä¸€ç§ingress-controllerï¼Œå®ç°çš„æœºåˆ¶éƒ½å¤§åŒå°å¼‚ï¼Œåªæ˜¯åœ¨å…·ä½“é…ç½®ä¸Šæœ‰å·®å¼‚ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œingress-controllerçš„å½¢å¼éƒ½æ˜¯ä¸€ä¸ªpodï¼Œé‡Œé¢è·‘ç€daemonç¨‹åºå’Œåå‘ä»£ç†ç¨‹åºã€‚daemonè´Ÿè´£ä¸æ–­ç›‘æ§é›†ç¾¤çš„å˜åŒ–ï¼Œæ ¹æ®ingresså¯¹è±¡ç”Ÿæˆé…ç½®å¹¶åº”ç”¨æ–°é…ç½®åˆ°åå‘ä»£ç†ï¼Œæ¯”å¦‚nginx-ingresså°±æ˜¯åŠ¨æ€ç”Ÿæˆnginxé…ç½®ï¼ŒåŠ¨æ€æ›´æ–°upstreamï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™reloadç¨‹åºåº”ç”¨æ–°é…ç½®ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œåé¢çš„ä¾‹å­éƒ½ä»¥k8så®˜æ–¹ç»´æŠ¤çš„nginx-ingressä¸ºä¾‹ã€‚\n3. éƒ¨ç½²ingresså¯¹è±¡ ä¸‹é¢ä¼šä»‹ç»åˆ°ingress-controlleræœ‰å¤šç§éƒ¨ç½²æ–¹å¼ï¼Œä½†æ— è®ºingress-controlleré‡‡ç”¨ä½•ç§æ–¹å¼éƒ¨ç½²ï¼Œingressèµ„æºå¯¹è±¡çš„éƒ¨ç½²éƒ½ä¸€æ ·ï¼š\n[root@k8s-master ingress-nginx]# vi ingress-all.yaml  apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: ingress-all annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; # å¼€å¯use-regexï¼Œå¯ç”¨pathçš„æ­£åˆ™åŒ¹é… nginx.ingress.kubernetes.io/use-regex: \u0026#34;true\u0026#34; spec: rules: # å®šä¹‰åŸŸå - host: ceres-admin-web.6and.ltd http: paths: # ä¸åŒpathè½¬å‘åˆ°ä¸åŒç«¯å£ - path: / backend: serviceName: ceres-admin-web-svc servicePort: 80 #- path: /merchant # backend: # serviceName: ceres-merchant-web-svc # servicePort: 80 - host: ceres-merchant-web.6and.ltd http: paths: # ä¸åŒpathè½¬å‘åˆ°ä¸åŒç«¯å£ - path: / backend: serviceName: ceres-merchant-web-svc servicePort: 80 - host: ceres-admin-server.6and.ltd http: paths: # ä¸åŒpathè½¬å‘åˆ°ä¸åŒç«¯å£ - path: / backend: serviceName: ceres-admin-server-svc servicePort: 8764 4. éƒ¨ç½²ingress-controller ingress-controllerçš„éƒ¨ç½²ï¼Œéœ€è¦è€ƒè™‘ä¸¤ä¸ªæ–¹é¢ï¼š\n ingress-controlleræ˜¯ä½œä¸ºpodæ¥è¿è¡Œçš„ï¼Œä»¥ä»€ä¹ˆæ–¹å¼éƒ¨ç½²æ¯”è¾ƒå¥½ ingress-controllerè§£å†³äº†æŠŠå¦‚ä½•è¯·æ±‚è·¯ç”±åˆ°é›†ç¾¤å†…éƒ¨ï¼Œé‚£å®ƒè‡ªå·±æ€ä¹ˆæš´éœ²ç»™å¤–éƒ¨æ¯”è¾ƒå¥½  ä¸‹é¢åˆ—ä¸¾ä¸€äº›ç›®å‰å¸¸è§çš„éƒ¨ç½²å’Œæš´éœ²æ–¹å¼ï¼Œå…·ä½“ä½¿ç”¨å“ªç§æ–¹å¼è¿˜æ˜¯å¾—æ ¹æ®å®é™…éœ€æ±‚æ¥è€ƒè™‘å†³å®šã€‚\n4.1 Deployment+LoadBalanceræ¨¡å¼çš„Service å¦‚æœè¦æŠŠingresséƒ¨ç½²åœ¨å…¬æœ‰äº‘ï¼Œé‚£ç”¨è¿™ç§æ–¹å¼æ¯”è¾ƒåˆé€‚ã€‚ç”¨Deploymentéƒ¨ç½²ingress-controllerï¼Œåˆ›å»ºä¸€ä¸ªtypeä¸ºLoadBalancerçš„serviceå…³è”è¿™ç»„podã€‚å¤§éƒ¨åˆ†å…¬æœ‰äº‘ï¼Œéƒ½ä¼šä¸ºLoadBalancerçš„serviceè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œé€šå¸¸è¿˜ç»‘å®šäº†å…¬ç½‘åœ°å€ã€‚åªè¦æŠŠåŸŸåè§£ææŒ‡å‘è¯¥åœ°å€ï¼Œå°±å®ç°äº†é›†ç¾¤æœåŠ¡çš„å¯¹å¤–æš´éœ²ã€‚\n4.2 Deployment+NodePortæ¨¡å¼çš„Service åŒæ ·ç”¨deploymentæ¨¡å¼éƒ¨ç½²ingress-controllerï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„æœåŠ¡ï¼Œä½†æ˜¯typeä¸ºNodePortã€‚è¿™æ ·ï¼Œingresså°±ä¼šæš´éœ²åœ¨é›†ç¾¤èŠ‚ç‚¹ipçš„ç‰¹å®šç«¯å£ä¸Šã€‚ç”±äºnodeportæš´éœ²çš„ç«¯å£æ˜¯éšæœºç«¯å£ï¼Œä¸€èˆ¬ä¼šåœ¨å‰é¢å†æ­å»ºä¸€å¥—è´Ÿè½½å‡è¡¡å™¨æ¥è½¬å‘è¯·æ±‚ã€‚è¯¥æ–¹å¼ä¸€èˆ¬ç”¨äºå®¿ä¸»æœºæ˜¯ç›¸å¯¹å›ºå®šçš„ç¯å¢ƒipåœ°å€ä¸å˜çš„åœºæ™¯ã€‚ NodePortæ–¹å¼æš´éœ²ingressè™½ç„¶ç®€å•æ–¹ä¾¿ï¼Œä½†æ˜¯NodePortå¤šäº†ä¸€å±‚NATï¼Œåœ¨è¯·æ±‚é‡çº§å¾ˆå¤§æ—¶å¯èƒ½å¯¹æ€§èƒ½ä¼šæœ‰ä¸€å®šå½±å“ã€‚\n4.2.1 ä¸‹è½½éƒ¨ç½²ingress-nginx\rcontrolleræ‰€éœ€è¦çš„deploy.yamlæ–‡ä»¶ wget https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/baremetal/deploy.yaml è¯¥yamlé»˜è®¤ä½¿ç”¨nodePortæ–¹å¼éƒ¨ç½²Serviceï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šnodePortï¼Œè€Œä¸æ˜¯è®©k8sè‡ªå·±åˆ†é…ã€‚\napiVersion: v1 kind: Service metadata: labels: helm.sh/chart: ingress-nginx-2.11.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 0.34.1 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx spec: type: NodePort ports: - name: http nodePort: 31080 port: 80 protocol: TCP targetPort: http - name: https nodePort: 31443 port: 443 protocol: TCP targetPort: https ä¸è¦è¯•å›¾å°†nodePortæŒ‡å®šä¸º80æˆ–è€…443ï¼Œå¦åˆ™ä½ ä¼šå¾—åˆ°å¦‚ä¸‹æç¤ºï¼š\nThe Service \u0026#34;ingress-nginx-controller\u0026#34; is invalid: spec.ports[0].nodePort: Invalid value: 80: provided port is not in the valid range. The range of valid ports is 30000-32767 4.2.2 ä¿®æ”¹é•œåƒä»“åº“åœ°å€ deploy.yamlé‡Œé¢çš„é•œåƒåœ°å€æ˜¯ï¼šus.gcr.io/k8s-artifacts-prod/ingress-nginx/controller:v0.34.1@sha256:0e072dddd1f7f8fc8909a2ca6f65e76c5f0d2fcfb8be47935ae3457e8bbceb20\nè¯¥åœ°å€æ— æ³•è¢«è®¿é—®ï¼Œè§£å†³åŠæ³•å‚è€ƒï¼šå¦‚ä½•åœ¨å›½å†…é¡ºç•…ä¸‹è½½è¢«å¢™çš„ Docker é•œåƒï¼Ÿ\rä¿®æ”¹åå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n4.2.3 éƒ¨ç½²ingress-nginx controller kubectl apply -f deploy.yaml\rå¦‚æœä¿®æ”¹äº†yamlé‡æ–°éƒ¨ç½²ï¼š\nkubectl replace --force -f deploy.yaml\r4.2.4 æ£€æŸ¥æ˜¯å¦éƒ¨ç½²æˆåŠŸ æŸ¥çœ‹controlleræ˜¯å¦running\næŸ¥çœ‹service\nç™»é™†ä»»æ„èŠ‚ç‚¹ï¼Œè¿è¡Œï¼š\n[root@k8s-node1 ~]# curl -i localhost:31080/healthz HTTP/1.1 200 OK Server: nginx/1.19.1 Date: Sat, 22 Aug 2020 06:22:15 GMT Content-Type: text/html Content-Length: 0 Connection: keep-alive è¿”å› 200 ï¼Œè¯´æ˜ nginx OKã€‚\nè‡³æ­¤ï¼Œingress-nginx controllerå·²ç»éƒ¨ç½²å®Œæ¯•ã€‚é€šè¿‡åŸŸå+nodePortçš„æ–¹å¼è®¿é—®ç›¸åº”çš„serviceï¼Œä¾‹ï¼šhttp://ceres-admin-web.6and.ltd:31080ï¼Œå¦‚æœä½ è·Ÿæˆ‘ä¸€æ ·æ˜¯å¼ºè¿«ç—‡æ™šæœŸï¼Œä¸€å®šæœŸæœ›å®Œç¾çš„è®¿é—®æ–¹å¼æ˜¯ï¼šhttp://ceres-admin-web.6and.ltdï¼Œä¸‹é¢çš„4.3å°èŠ‚å°†æ˜¯å¼ºè¿«ç—‡æ™šæœŸçš„ç¦éŸ³ã€‚\n4.3 DaemonSet+HostNetwork+nodeSelector ç”¨DaemonSetç»“åˆnodeselectoræ¥éƒ¨ç½²ingress-controlleråˆ°ç‰¹å®šçš„nodeä¸Šï¼Œç„¶åä½¿ç”¨HostNetworkç›´æ¥æŠŠè¯¥podä¸å®¿ä¸»æœºnodeçš„ç½‘ç»œæ‰“é€šï¼Œç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„80/433ç«¯å£å°±èƒ½è®¿é—®æœåŠ¡ã€‚è¿™æ—¶ï¼Œingress-controlleræ‰€åœ¨çš„nodeæœºå™¨å°±å¾ˆç±»ä¼¼ä¼ ç»Ÿæ¶æ„çš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œæ¯”å¦‚æœºæˆ¿å…¥å£çš„nginxæœåŠ¡å™¨ã€‚è¯¥æ–¹å¼æ•´ä¸ªè¯·æ±‚é“¾è·¯æœ€ç®€å•ï¼Œæ€§èƒ½ç›¸å¯¹NodePortæ¨¡å¼æ›´å¥½ã€‚ç¼ºç‚¹æ˜¯ç”±äºç›´æ¥åˆ©ç”¨å®¿ä¸»æœºèŠ‚ç‚¹çš„ç½‘ç»œå’Œç«¯å£ï¼Œä¸€ä¸ªnodeåªèƒ½éƒ¨ç½²ä¸€ä¸ªingress-controller podã€‚æ¯”è¾ƒé€‚åˆå¤§å¹¶å‘çš„ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚\n4.3.1 ç»™è¦éƒ¨ç½²nginx-ingressçš„nodeæ‰“ä¸Šç‰¹å®šæ ‡ç­¾ æˆ‘ä»¬éœ€è¦ä½¿ç”¨daemonsetéƒ¨ç½²åˆ°ç‰¹å®šnodeï¼Œéœ€è¦ä¿®æ”¹éƒ¨åˆ†é…ç½®ï¼šå…ˆç»™è¦éƒ¨ç½²nginx-ingressçš„nodeæ‰“ä¸Šç‰¹å®šæ ‡ç­¾ï¼Œè¿™é‡Œæµ‹è¯•éƒ¨ç½²åœ¨k8s-node1è¿™ä¸ªèŠ‚ç‚¹ã€‚\nkubectl label node k8s-node1 isIngress=\u0026#34;true\u0026#34; 4.3.2 ä¿®æ”¹deploy.yamlçš„deploymentéƒ¨åˆ†é…ç½® åˆ é™¤æŒ‡å®šçš„nodePortï¼š\n4.3.3 é‡å¯ kubectl replace --force -f deploy.yaml 4.3.4 æ£€æŸ¥ å¯ä»¥çœ‹åˆ°ï¼Œnginx-controllerçš„podå·²ç»éƒ¨ç½²åœ¨åœ¨k8s-node1ä¸Šäº†ï¼š\nåˆ°k8s-node1ä¸Šçœ‹ä¸‹æœ¬åœ°ç«¯å£ï¼š\nç”±äºé…ç½®äº†hostnetworkï¼Œnginxå·²ç»åœ¨nodeä¸»æœºæœ¬åœ°ç›‘å¬80/443/8181ç«¯å£ã€‚å…¶ä¸­8181æ˜¯nginx-controlleré»˜è®¤é…ç½®çš„ä¸€ä¸ªdefault backendã€‚è¿™æ ·ï¼Œåªè¦è®¿é—®nodeä¸»æœºæœ‰å…¬ç½‘IPï¼Œå°±å¯ä»¥ç›´æ¥æ˜ å°„åŸŸåæ¥å¯¹å¤–ç½‘æš´éœ²æœåŠ¡äº†ã€‚å¦‚æœè¦nginxé«˜å¯ç”¨çš„è¯ï¼Œå¯ä»¥åœ¨å¤šä¸ªnodeä¸Šéƒ¨ç½²ï¼Œå¹¶åœ¨å‰é¢å†æ­å»ºä¸€å¥—LVS+keepaliveåšè´Ÿè½½å‡è¡¡ã€‚ç”¨hostnetworkçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¦‚æœlvsç”¨DRæ¨¡å¼çš„è¯ï¼Œæ˜¯ä¸æ”¯æŒç«¯å£æ˜ å°„çš„ï¼Œè¿™æ—¶å€™å¦‚æœç”¨nodeportï¼Œæš´éœ²éæ ‡å‡†çš„ç«¯å£ï¼Œç®¡ç†èµ·æ¥ä¼šå¾ˆéº»çƒ¦ã€‚\nç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ä¼˜é›…çš„ä½¿ç”¨ï¼šhttp://ceres-admin-web.6and.ltdæ¥è®¿é—®æˆ‘ä»¬çš„æœåŠ¡äº†ã€‚\nå‚è€ƒé“¾æ¥ k8s ingressåŸç†åŠingress-nginxéƒ¨ç½²æµ‹è¯•\rè§å¼‚æ€è¿ï¼šK8s éƒ¨ç½² Nginx Ingress Controller ä¹‹ kubernetes/ingress-nginx\rå¦‚ä½•åœ¨å›½å†…é¡ºç•…ä¸‹è½½è¢«å¢™çš„ Docker é•œåƒï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/ingress/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"ingress"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"lettuceè¿æ¥redisæŠ¥é”™io.lettuce.core.RedisCommandTimeoutException: Command timed out after 5 second(s)ï¼Œæˆ‘çš„spring.redis.timeout = 5000ã€‚\nè§£å†³åŠæ³•ï¼š\n1ã€ç™»é™†rediså®¹å™¨ 2ã€è¾“å…¥redis-cliè¿›å…¥redisæ§åˆ¶å° 3ã€è®¾ç½® CONFIG SET timeout \u0026quot;60\u0026quot; 4ã€è®¾ç½® CONFIG SET tcp-keepalive \u0026quot;300\u0026quot;\nå‚è€ƒé“¾æ¥ï¼šRedis é…ç½®\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/exception/io.lettuce.core.rediscommandtimeoutexception_-comm/","series":["Manual"],"tags":["redis"],"title":"io.lettuce.core.RedisCommandTimeoutException: Command timed out after 5 second(s)"},{"categories":["å…¶ä»–"],"content":"iptables: No chain/target/match by that name.\né‡å¯redisé•œåƒçš„æ—¶å€™æŠ¥é”™å¦‚ä¸‹ï¼š\nERROR: for redis Cannot start service redis: driver failed programming external connectivity on endpoint redis (f5211771e5a0ee705edb72f8a8dfbca2503456ab0e8330a32932b029a7c0568d): (iptables failed: iptables --wait -t nat -A DOCKER -p tcp -d 0/0 --dport 6379 -j DNAT --to-destination 192.168.80.2:6379 ! -i br-fbefac0273aa: iptables: No chain/target/match by that name. åŸå› ï¼š\ndocker æœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼ŒdockeræœåŠ¡ä¼šå‘iptablesæ³¨å†Œä¸€ä¸ªé“¾ï¼Œä»¥ä¾¿è®©dockeræœåŠ¡ç®¡ç†çš„containneræ‰€æš´éœ²çš„ç«¯å£ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚é€šè¿‡å‘½ä»¤iptables -Lå¯ä»¥æŸ¥çœ‹iptables é“¾ã€‚å¦‚æœä½ åˆ é™¤äº†iptablesä¸­çš„dockeré“¾ï¼Œæˆ–è€…iptablesçš„è§„åˆ™è¢«ä¸¢å¤±äº†ï¼ˆä¾‹å¦‚é‡å¯firewalldï¼Œæˆ‘å°±æ˜¯ä½¿ç”¨äº†systemctl stop iptableså¯¼è‡´é“¾ä¸¢å¤±ï¼‰ï¼Œdockerå°±ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ã€‚\nè§£å†³åŠæ³•ï¼š\nsystemctl restart docker é‡å¯dockeræœåŠ¡ï¼Œä¹‹åï¼Œæ­£ç¡®çš„iptablesè§„åˆ™å°±ä¼šè¢«åˆ›å»ºå‡ºæ¥ã€‚\nå‚è€ƒï¼š\nDocker å¯åŠ¨æ—¶æŠ¥é”™ï¼šiptables:No chain/target/match by the name\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/iptables_-no-chain_target_match-by-that-name/","series":["Manual"],"tags":["Other"],"title":"iptables: No chain/target/match by that name."},{"categories":["äº‘åŸç”Ÿ"],"content":"istioåŸç†\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/istio/istio%E5%9F%BA%E7%A1%80/istio%E5%8E%9F%E7%90%86/","series":null,"tags":["äº‘åŸç”Ÿ","istio"],"title":"istioåŸç†"},{"categories":["äº‘åŸç”Ÿ"],"content":"istioå¯ç”¨ç­–ç•¥æ£€æŸ¥åŠŸèƒ½\nä¸å¾—ä¸è¯´ï¼Œistioçš„å®˜æ–¹æ–‡æ¡£çœŸçš„å¾ˆåƒåœ¾ï¼Œæ“ä½œæ‰‹å†Œæ²¡æœ‰éšç€ç‰ˆæœ¬åŒæ­¥æ›´æ–°ä¸è¯´ï¼Œå¯ç”¨ç­–ç•¥æ£€æŸ¥åŠŸèƒ½ä¾ç…§å®˜æ–¹åšæ³•\rä¹Ÿä¸èƒ½ç”Ÿæ•ˆã€‚ç°å…ˆä»¥istio-1.5.10ä¸ºä¾‹æ€»ç»“å¯ç”¨ç­–ç•¥æ£€æŸ¥åŠŸèƒ½çš„æ–¹æ³•å¦‚ä¸‹ï¼š\n é»˜è®¤å®‰è£…istioä¹‹ådisablePolicyChecks=true  [root@k8s-master Istio-1.5.10]# kubectl -n Istio-system get cm Istio -o jsonpath=\u0026#34;{@.data.mesh}\u0026#34; | grep disablePolicyChecks disablePolicyChecks: true ç¼–è¾‘ istio configmap ä»¥å¯ç”¨ç­–ç•¥æ£€æŸ¥  [root@k8s-master Istio-1.5.10]# kubectl -n Istio-system get cm Istio -o jsonpath=\u0026#34;{@.data.mesh}\u0026#34; | sed -e \u0026#34;s/disablePolicyChecks: true/disablePolicyChecks: false/\u0026#34; \u0026gt; /tmp/mesh.yaml [root@k8s-master Istio-1.5.10]# kubectl -n Istio-system create cm Istio -o yaml --dry-run --from-file=mesh=/tmp/mesh.yaml | kubectl replace -f - W0902 17:00:37.208604 16538 helpers.go:535] --dry-run is deprecated and can be replaced with --dry-run=client. configmap/Istio replaced [root@k8s-master Istio-1.5.10]# kubectl -n Istio-system get cm Istio -o jsonpath=\u0026#34;{@.data.mesh}\u0026#34; | grep disablePolicyChecks disablePolicyChecks: false åˆ é™¤ä¸ºä¿®è¡¥ istio configmap è€Œåˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶  rm /tmp/mesh.yaml æ€»ç»“  è™½ç„¶æ­¤æ–¹æ³•å¯ä»¥è®¾ç½®disablePolicyChecks=falseï¼Œä½†æ˜¯è¿˜æ˜¯æ— æ³•å¯ç”¨istioé€Ÿç‡é™åˆ¶ï¼ˆRate Limitsï¼‰ï¼Œå…·ä½“åŸå› ä¸è¯¦ï¼ˆåº”è¯¥æ˜¯è¯¥ç‰ˆæœ¬çš„bugï¼‰ï¼Œè¯·ä½¿ç”¨istio-1.4.10\nå‚è€ƒï¼š  ç¬¬äºŒåä¸€éƒ¨åˆ† Istioç­–ç•¥æ£€æŸ¥\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/istio/istio%E5%AE%9E%E6%88%98/istio%E5%90%AF%E7%94%A8%E7%AD%96%E7%95%A5%E6%A3%80%E6%9F%A5%E5%8A%9F%E8%83%BD/","series":["istioå®æˆ˜"],"tags":["äº‘åŸç”Ÿ","istio"],"title":"istioå¯ç”¨ç­–ç•¥æ£€æŸ¥åŠŸèƒ½"},{"categories":["äº‘åŸç”Ÿ"],"content":"istioå®‰è£…\n1. ä¸‹è½½ Istio è¿™é‡Œæ¨èç›´æ¥ä¸‹è½½tar.gzå®‰è£…åŒ…ï¼Œä¸æ¨èä½¿ç”¨å®˜ç½‘ä¸Šçš„é‚£ä¸ªå®‰è£…è„šæœ¬ï¼ˆæ…¢å¾—ä¸€é€¼ï¼‰ã€‚å¦å¤–æ¨èä¸‹è½½istio-1.5.10ï¼Œä¸æ¨èä¸‹è½½1.7.0ã€‚\nè§£å‹ï¼š\ntar -xzvf Istio-1.5.10-linux.tar.gz æ‹·è´istioctlåˆ°/usr/local/bin/\ncd Istio-1.5.10/ cp bin/istioctl /usr/local/bin/ æŸ¥çœ‹ç‰ˆæœ¬ï¼š\nistioctl version 2. å®‰è£…istio åŸºäºdemoçš„é…ç½®å®‰è£…istioï¼ˆé™¤äº†demoï¼Œè¿˜æœ‰defaultç­‰ç­‰ï¼Œå…·ä½“é…ç½®è§istio-1.5.10/install/kubernetes/operator/profilesï¼‰\nistioctl manifest apply --set profile=demo æŸ¥çœ‹svcï¼škubectl get svc -n istio-system\næŸ¥çœ‹podï¼škubectl get pods -n istio-system\nè¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯1.5.10ä»¥åçš„é«˜ç‰ˆæœ¬ï¼Œå®‰è£…å‘½ä»¤åº”è¯¥æ˜¯ï¼šistioctl manifest install --set profile=demo\nå¹¶ä¸”ï¼Œæœ€æ–°ç‰ˆæœ¬1.7.0ä¸å†é»˜è®¤å®‰è£…grafana ``kiali ``zipkinç­‰ç­‰ç»„ä»¶ã€‚\nå½“ä½¿ç”¨ kubectl apply æ¥éƒ¨ç½²åº”ç”¨æ—¶ï¼Œå¦‚æœ pod å¯åŠ¨åœ¨æ ‡æœ‰ istio-injection=enabled çš„å‘½åç©ºé—´ä¸­ï¼Œé‚£ä¹ˆï¼ŒIstio sidecar æ³¨å…¥å™¨\rå°†è‡ªåŠ¨æ³¨å…¥ Envoy å®¹å™¨åˆ°åº”ç”¨çš„ pod ä¸­ï¼š\nkubectl label namespace \u0026lt;namespace\u0026gt; Istio-injection=enabled 3.å¸è½½ å¸è½½ç¨‹åºå°†åˆ é™¤ RBAC æƒé™ã€istio-system å‘½åç©ºé—´å’Œæ‰€æœ‰ç›¸å…³èµ„æºã€‚å¯ä»¥å¿½ç•¥é‚£äº›ä¸å­˜åœ¨çš„èµ„æºçš„æŠ¥é”™ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½å·²ç»è¢«åˆ é™¤æ‰äº†ã€‚\nistioctl manifest generate --set profile=demo | kubectl delete -f - å‚è€ƒ istioå®˜ç½‘: å¼€å§‹\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/istio/istio%E5%AE%9E%E6%88%98/istio%E5%AE%89%E8%A3%85/","series":["istioå®æˆ˜"],"tags":["äº‘åŸç”Ÿ","istio"],"title":"istioå®‰è£…"},{"categories":["äº‘åŸç”Ÿ"],"content":"istioå®ç°ç°åº¦\nGateway apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: bookinfo-gateway spec: selector: istio: ingressgateway # use istio default controller servers: - port: number: 80 name: http protocol: HTTP hosts: - \u0026#34;*\u0026#34; VirtualService æ˜¯åœ¨ Istio æœåŠ¡ç½‘æ ¼å†…å¯¹æœåŠ¡çš„è¯·æ±‚å¦‚ä½•è¿›è¡Œè·¯ç”±æ§åˆ¶ï¼ŸVirtualService\rä¸­å°±åŒ…å«äº†è¿™æ–¹é¢çš„å®šä¹‰ã€‚ä¾‹å¦‚ä¸€ä¸ª Virtual Service å¯ä»¥æŠŠè¯·æ±‚è·¯ç”±åˆ°ä¸åŒç‰ˆæœ¬ï¼Œç”šè‡³æ˜¯å¯ä»¥è·¯ç”±åˆ°ä¸€ä¸ªå®Œå…¨ä¸åŒäºè¯·æ±‚è¦æ±‚çš„æœåŠ¡ä¸Šå»ã€‚è·¯ç”±å¯ä»¥ç”¨å¾ˆå¤šæ¡ä»¶è¿›è¡Œåˆ¤æ–­ï¼Œä¾‹å¦‚è¯·æ±‚çš„æºå’Œç›®çš„åœ°ã€HTTP è·¯å¾„å’Œ Header ä»¥åŠå„ä¸ªæœåŠ¡ç‰ˆæœ¬çš„æƒé‡ç­‰ã€‚\nè·¯ç”±è§„åˆ™å¯¹åº”ç€ä¸€æˆ–å¤šä¸ªç”¨ VirtualService é…ç½®æŒ‡å®šçš„è¯·æ±‚ç›®çš„ä¸»æœºã€‚è¿™äº›ä¸»æœºå¯ä»¥æ˜¯ä¹Ÿå¯ä»¥ä¸æ˜¯å®é™…çš„ç›®æ ‡è´Ÿè½½ï¼Œç”šè‡³å¯ä»¥ä¸æ˜¯åŒä¸€ç½‘æ ¼å†…å¯è·¯ç”±çš„æœåŠ¡ã€‚ä¾‹å¦‚è¦ç»™åˆ° reviews æœåŠ¡çš„è¯·æ±‚å®šä¹‰è·¯ç”±è§„åˆ™ï¼Œå¯ä»¥ä½¿ç”¨å†…éƒ¨çš„åç§° reviewsï¼Œä¹Ÿå¯ä»¥ç”¨åŸŸå bookinfo.comï¼ŒVirtualService å¯ä»¥å®šä¹‰è¿™æ ·çš„ host å­—æ®µï¼š\nhosts:\r- reviews\r- bookinfo.comå¤åˆ¶ä»£ç \rhost å­—æ®µç”¨æ˜¾ç¤ºæˆ–è€…éšå¼çš„æ–¹å¼å®šä¹‰äº†ä¸€æˆ–å¤šä¸ªå®Œå…¨é™å®šåï¼ˆFQDNï¼‰ã€‚ä¸Šé¢çš„ reviewsï¼Œä¼šéšå¼çš„æ‰©å±•æˆä¸ºç‰¹å®šçš„ FQDNï¼Œä¾‹å¦‚åœ¨ Kubernetes ç¯å¢ƒä¸­ï¼Œå…¨åä¼šä» VirtualService æ‰€åœ¨çš„é›†ç¾¤å’Œå‘½åç©ºé—´ä¸­ç»§æ‰¿è€Œæ¥ï¼ˆæ¯”å¦‚è¯´ reviews.default.svc.cluster.localï¼‰ã€‚\n--- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: bookinfo spec: hosts: - \u0026#34;*\u0026#34; gateways: - bookinfo-gateway http: - match: - uri: exact: /productpage - uri: prefix: /static - uri: exact: /login - uri: exact: /logout - uri: prefix: /api/v1/products route: - destination: host: productpage port: number: 9080 æ‰€æœ‰çš„æµé‡éƒ½å»åˆ°reviews:v1\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 æ¥è‡ªåä¸º Jason çš„ç”¨æˆ·çš„æ‰€æœ‰æµé‡å°†è¢«è·¯ç”±åˆ°æœåŠ¡ reviews:v2ã€‚\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: jason route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v1 æŠŠ 50% çš„æµé‡ä» reviews:v1 è½¬ç§»åˆ° reviews:v3ï¼š\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 weight: 50 - destination: host: reviews subset: v3 weight: 50 ç»™å¯¹ reviews æœåŠ¡çš„è°ƒç”¨å¢åŠ ä¸€ä¸ªåŠç§’çš„è¯·æ±‚è¶…æ—¶ï¼š\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v2 timeout: 0.5s DestinationRule åœ¨è¯·æ±‚è¢« VirtualService è·¯ç”±ä¹‹åï¼ŒDestinationRule\ré…ç½®çš„ä¸€ç³»åˆ—ç­–ç•¥å°±ç”Ÿæ•ˆäº†ã€‚è¿™äº›ç­–ç•¥âš ï¸ç”±æœåŠ¡å±ä¸»ç¼–å†™âš ï¸ï¼ŒåŒ…å«æ–­è·¯å™¨ã€è´Ÿè½½å‡è¡¡ä»¥åŠ TLS ç­‰çš„é…ç½®å†…å®¹ã€‚\nDestinationRule è¿˜å®šä¹‰äº†å¯¹åº”ç›®æ ‡ä¸»æœºçš„å¯è·¯ç”± subsetï¼ˆä¾‹å¦‚æœ‰å‘½åçš„ç‰ˆæœ¬ï¼‰ã€‚VirtualService åœ¨å‘ç‰¹å®šæœåŠ¡ç‰ˆæœ¬å‘é€è¯·æ±‚æ—¶ä¼šç”¨åˆ°è¿™äº›å­é›†ã€‚\nä¸‹é¢æ˜¯ reviews æœåŠ¡çš„ DestinationRule é…ç½®ç­–ç•¥ä»¥åŠå­é›†ï¼š\napiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews trafficPolicy: loadBalancer: simple: RANDOM subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 trafficPolicy: loadBalancer: simple: ROUND_ROBIN - name: v3 labels: version: v3å¤åˆ¶ä»£ç  æ³¨æ„åœ¨å•ä¸ª DestinationRule é…ç½®ä¸­å¯ä»¥åŒ…å«å¤šæ¡ç­–ç•¥ï¼ˆæ¯”å¦‚ default å’Œ v2ï¼‰ã€‚\nâš ï¸åˆ°äº†DestinationRuleå±‚é¢ï¼Œæ˜¯é…ç½®æµé‡å»åˆ°æŒ‡å®šç‰ˆæœ¬çš„ç­–ç•¥ï¼Œéšæœºç­–ç•¥ã€è½®è®­ç­–ç•¥ç­‰ç­‰ï¼ˆæ³¨æ„æŒ‡å®šç‰ˆæœ¬æ˜¯å¯ä»¥å¤šå‰¯æœ¬çš„ï¼‰\nå¯ä»¥ç”¨ä¸€ç³»åˆ—çš„æ ‡å‡†ï¼Œä¾‹å¦‚è¿æ¥æ•°å’Œè¯·æ±‚æ•°é™åˆ¶æ¥å®šä¹‰ç®€å•çš„æ–­è·¯å™¨ã€‚\nä¾‹å¦‚ä¸‹é¢çš„ DestinationRule ç»™ reviews æœåŠ¡çš„ v1 ç‰ˆæœ¬è®¾ç½®äº† 100 è¿æ¥çš„é™åˆ¶ï¼š\napiVersion: networking.istio.io/v1alpha3\rkind: DestinationRule\rmetadata:\rname: reviews\rspec:\rhost: reviews\rsubsets:\r- name: v1\rlabels:\rversion: v1\rtrafficPolicy:\rconnectionPool:\rtcp:\rmaxConnections: 100\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/istio/istio%E5%AE%9E%E6%88%98/istio%E5%AE%9E%E7%8E%B0%E7%81%B0%E5%BA%A6/","series":["istioå®æˆ˜"],"tags":["äº‘åŸç”Ÿ","istio"],"title":"istioå®ç°ç°åº¦"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"**å¼€å‘è€…å¯ä»¥æ„å»ºä¸€ä¸ªç‹¬ç«‹äºåº”ç”¨ç¨‹åºçš„ä»£ç†ç¨‹åºï¼ˆAgentï¼‰ï¼Œç”¨æ¥ç›‘æµ‹å’ŒååŠ©è¿è¡Œåœ¨ JVM ä¸Šçš„ç¨‹åºï¼Œç”šè‡³èƒ½å¤Ÿæ›¿æ¢å’Œä¿®æ”¹æŸäº›ç±»çš„å®šä¹‰ã€‚**æœ‰äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œå¼€å‘è€…å°±å¯ä»¥å®ç°æ›´ä¸ºçµæ´»çš„è¿è¡Œæ—¶è™šæ‹Ÿæœºç›‘æ§å’Œ Java ç±»æ“ä½œäº†ï¼Œè¿™æ ·çš„ç‰¹æ€§å®é™…ä¸Šæä¾›äº† ä¸€ç§è™šæ‹Ÿæœºçº§åˆ«æ”¯æŒçš„ AOP å®ç°æ–¹å¼ï¼Œä½¿å¾—å¼€å‘è€…æ— éœ€å¯¹ JDK åšä»»ä½•å‡çº§å’Œæ”¹åŠ¨ï¼Œå°±å¯ä»¥å®ç°æŸäº› AOP çš„åŠŸèƒ½äº†ã€‚\n1.1 JVMå¯åŠ¨å‰é™æ€Instrument é€šè¿‡å¯åŠ¨å‘½ä»¤ java -javaagent:agent1.jar -javaagent:agent2.jar -jar MyProgram.jar åœ¨ç›®æ ‡ç¨‹åºmainæ–¹æ³•æ‰§è¡Œå‰ï¼Œå…ˆæ‰§è¡Œagentä¸­å®šä¹‰çš„ premain æ–¹æ³•\n1.2 JVMå¯åŠ¨ååŠ¨æ€Instrument Java6 ä»¥åæä¾›äº†åœ¨ç›®æ ‡ç¨‹åºmainæ–¹æ³•æ‰§è¡Œåï¼Œæ‰§è¡Œagentçš„agentmainæ–¹æ³•çš„æœºåˆ¶ï¼Œé€šè¿‡è¿™ç§æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€ä¿®æ”¹ç›®æ ‡ç¨‹åºå·²ç»åŠ è½½è¿‡çš„å­—èŠ‚ç ã€‚\nåœ¨Java6 ä»¥åå®ç°å¯åŠ¨ååŠ è½½çš„æ–°å®ç°æ˜¯Attach API ã€‚Attach API å¾ˆç®€å•ï¼Œåªæœ‰ 2 ä¸ªä¸»è¦çš„ç±»ï¼Œå³VirtualMachine å’Œ VirtualMachineDescriptorï¼Œéƒ½åœ¨tool.jar çš„ com.sun.tools.attach åŒ…é‡Œé¢ã€‚\nattachå®ç°åŠ¨æ€æ³¨å…¥çš„åŸç†å¦‚ä¸‹ï¼š\né€šè¿‡VirtualMachineç±»çš„attach(pid)æ–¹æ³•ï¼Œä¾¿å¯ä»¥attachåˆ°ä¸€ä¸ªè¿è¡Œä¸­çš„javaè¿›ç¨‹ä¸Šï¼Œä¹‹åä¾¿å¯ä»¥é€šè¿‡loadAgent(agentJarPath)æ¥å°†agentçš„jaråŒ…æ³¨å…¥åˆ°å¯¹åº”çš„è¿›ç¨‹ï¼Œç„¶åå¯¹åº”çš„è¿›ç¨‹ä¼šè°ƒç”¨agentmainæ–¹æ³•ã€‚\næ—¢ç„¶æ˜¯ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´é€šä¿¡é‚£è‚¯å®šçš„å»ºç«‹èµ·è¿æ¥ï¼ŒVirtualMachine.attachåŠ¨ä½œç±»ä¼¼TCPåˆ›å»ºè¿æ¥çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œç›®çš„å°±æ˜¯æ­å»ºattaché€šä¿¡çš„è¿æ¥ã€‚è€Œåé¢æ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚vm.loadAgentï¼Œå…¶å®å°±æ˜¯å‘è¿™ä¸ªsocketå†™å…¥æ•°æ®æµï¼Œæ¥æ”¶æ–¹target VMä¼šé’ˆå¯¹ä¸åŒçš„ä¼ å…¥æ•°æ®æ¥åšä¸åŒçš„å¤„ç†ã€‚\nä¾‹å¦‚ï¼šæ‰¾åˆ°å½“å‰JVMå¹¶åŠ è½½agent.jarï¼ˆå³attach JVM å’Œ runing JVM æ˜¯åŒä¸€ä¸ª JVMï¼ŒçœŸæ­£çš„åº”ç”¨ä¸­æ›´å¤šçš„æ˜¯ä¸åŒçš„ä¸¤ä¸ªJVMï¼Œè¿™é‡Œä»…ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ã€‚ï¼‰\npackage com.rickiyang.learn.job; import com.sun.tools.attach.*; import java.io.IOException; import java.util.List; /** * @author rickiyang * @date 2019-08-16 * @Desc */ public class TestAgentMain { public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException { //è·å–å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰ è¿è¡Œä¸­çš„ è™šæ‹Ÿæœº  System.out.println(\u0026#34;running JVM start \u0026#34;); List\u0026lt;VirtualMachineDescriptor\u0026gt; list = VirtualMachine.list(); for (VirtualMachineDescriptor vmd : list) { //å¦‚æœè™šæ‹Ÿæœºçš„åç§°ä¸º xxx åˆ™ è¯¥è™šæ‹Ÿæœºä¸ºç›®æ ‡è™šæ‹Ÿæœºï¼Œè·å–è¯¥è™šæ‹Ÿæœºçš„ pid  //ç„¶ååŠ è½½ agent.jar å‘é€ç»™è¯¥è™šæ‹Ÿæœº  System.out.println(vmd.displayName()); if (vmd.displayName().endsWith(\u0026#34;com.rickiyang.learn.job.TestAgentMain\u0026#34;)) { VirtualMachine virtualMachine = VirtualMachine.attach(vmd.id()); virtualMachine.loadAgent(\u0026#34;/Users/yangyue/Documents/java-agent.jar\u0026#34;); virtualMachine.detach(); } } } } å‚è€ƒ javaagent åº”ç”¨ | ä¸ƒæ—¥æ‰“å¡\rjavaagentä½¿ç”¨æŒ‡å—\råŸºäºJava Instrumentçš„Agentå®ç°\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/java-agent/","series":["Manual"],"tags":["Java"],"title":"Java agent"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"switch(expression){ case value : //è¯­å¥  break; //å¯é€‰  case value : //è¯­å¥  break; //å¯é€‰  //ä½ å¯ä»¥æœ‰ä»»æ„æ•°é‡çš„caseè¯­å¥  default : //å¯é€‰  //è¯­å¥ } è¿™é‡Œçš„ expression æ”¯æŒï¼š\n1ã€åŸºæœ¬æ•°æ®ç±»å‹ï¼šbyte, short, char, int\n2ã€åŒ…è£…æ•°æ®ç±»å‹ï¼šByte, Short, Character, Integer\n3ã€æšä¸¾ç±»å‹ï¼šEnum\n4ã€ å­—ç¬¦ä¸²ç±»å‹ï¼šStringï¼ˆJdk 7+ å¼€å§‹æ”¯æŒï¼‰\nä¸ºä»€ä¹ˆä¸æ”¯æŒlongã€floatã€doubleæ•°æ®ç±»å‹ï¼Ÿ\nswitch åº•å±‚æ˜¯ä½¿ç”¨ int å‹ æ¥è¿›è¡Œåˆ¤æ–­çš„ï¼Œå³ä½¿æ˜¯æšä¸¾ã€Stringç±»å‹ï¼Œæœ€ç»ˆä¹Ÿæ˜¯è½¬å˜æˆ int å‹ã€‚ç”±äº longã€floatã€double å‹è¡¨ç¤ºèŒƒå›´å¤§äº int å‹ï¼Œå› æ­¤ä¸æ”¯æŒ longã€floatã€double ç±»å‹ã€‚ ï¼ˆStringç±»å‹æœ€ç»ˆæ˜¯è½¬æˆäº†intç±»å‹çš„hashCodeï¼›æšä¸¾æœ€ç»ˆè½¬æˆäº†æšä¸¾å¯¹è±¡çš„å®šä¹‰é¡ºåºï¼Œå³ ordinalå€¼ï¼‰\nä¸‹é¢ä¸¾ä¸€ä¸ªä½¿ç”¨åŒ…è£…ç±»å‹å’Œæšä¸¾çš„ï¼Œå…¶å®ä¹Ÿä¸éš¾ï¼Œæ³¨æ„åªèƒ½ç”¨åœ¨ switch å—é‡Œé¢\n// ä½¿ç”¨åŒ…è£…ç±»å‹ Integer value = 5; switch (value) { case 3: System.out.println(\u0026#34;3\u0026#34;); break; case 5: System.out.println(\u0026#34;5\u0026#34;); break; default: System.out.println(\u0026#34;default\u0026#34;); } // ä½¿ç”¨æšä¸¾ç±»å‹ Status status = Status.PROCESSING; switch (status) { case OPEN: System.out.println(\u0026#34;open\u0026#34;); break; case PROCESSING: System.out.println(\u0026#34;processing\u0026#34;); break; case CLOSE: System.out.println(\u0026#34;close\u0026#34;); break; default: System.out.println(\u0026#34;default\u0026#34;); } ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/java-switch%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/","series":["Manual"],"tags":["Java"],"title":"Java switchè¡¨è¾¾å¼æ”¯æŒçš„æ•°æ®ç±»å‹"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‚è€ƒ ä¸ºä»€ä¹ˆ Java åšæŒå¤šçº¿ç¨‹ä¸é€‰æ‹©åç¨‹ï¼Ÿ\rKotlin åç¨‹çœŸçš„æ¯” Java çº¿ç¨‹æ›´é«˜æ•ˆå—ï¼Ÿ\rç¡¬æ ¸ç³»åˆ— | æ·±å…¥å‰–æ Java åç¨‹\rGolang çš„ åç¨‹è°ƒåº¦æœºåˆ¶ ä¸ GOMAXPROCS æ€§èƒ½è°ƒä¼˜\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/java%E5%8D%8F%E7%A8%8B/","series":["Manual"],"tags":["Java"],"title":"Javaåç¨‹"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"åå°„å¯ä»¥åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€çš„æ„é€ ç±»ã€è·å–ç±»çš„å…¨éƒ¨ä¿¡æ¯ã€è°ƒç”¨ç±»å‹æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿™ä¹ˆåšå‘¢ï¼Ÿéœ€è¦æ„é€ ç±»ï¼Œnewå°±å¥½äº†ï¼Œéœ€è¦è®¿é—®ç±»æˆå‘˜å˜é‡ã€è°ƒç”¨æ–¹æ³•ï¼Œç›´æ¥è®¿é—®ã€è°ƒç”¨å°±å¥½äº†ï¼Œä¸ºä»€ä¹ˆè¦é€šè¿‡ä¸€å¤§å †åå°„ä»£ç å»å®ç°å‘¢ï¼Ÿ\né€šå¸¸ï¼Œclassåœ¨ç¼–è¯‘æœŸé—´å°±ç¡®å®šï¼ŒJVMåœ¨è¿è¡Œæ—¶é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½ç¡®å®šçš„classã€‚å¦‚æœåœ¨è¿è¡Œæ—¶æ‰ç¡®å®šéœ€è¦åŠ è½½ä»€ä¹ˆç±»ï¼Œå°±éœ€è¦åˆ©ç”¨javaåå°„ã€‚javaåå°„ä½¿å¾—ç¨‹åºæ›´åŠ çµæ´»ï¼Œç±»ä¼¼springçš„æ¡†æ¶å°†ç±»ä»¥å…¨é™å®šåçš„å½¢æˆé…ç½®åœ¨é…ç½®æ–‡ä»¶ï¼Œç„¶åå†é€šè¿‡åå°„å®ä¾‹åŒ–ã€‚\nå‚è€ƒï¼š\nhttps://blog.csdn.net/Appleyk/article/details/77879073\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/java%E5%8F%8D%E5%B0%84/","series":["Manual"],"tags":["Java"],"title":"Javaåå°„"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‰æ®µæ—¶é—´åœ¨åšä¸€ä¸ªå®æ—¶äººè„¸æŠ“æ‹é¡¹ç›®çš„æ—¶å€™ï¼Œé‡åˆ°äº†ä¸€ä¸ªå †å¤–å†…å­˜OOMçš„é—®é¢˜ï¼Œç°åœ¨æŠŠæ€è·¯å¥½å¥½æ•´ç†ä¸€ä¸‹ã€‚\né¡¹ç›®ä¸­ç”¨opencvé€šè¿‡rtspåè®®ï¼Œå®æ—¶çš„è¯»å–é€šç”¨ç½‘ç»œæ‘„åƒå¤´çš„è§†é¢‘å¸§ã€‚å› ä¸ºé¡¹ç›®ä¸­å¤šå¤„ç”¨åˆ°äº†org.opencv.core.Matè¿™ä¸ªå¯¹è±¡ï¼Œè€ŒMatå¯¹è±¡çš„æ„é€ æ˜¯é€šè¿‡è°ƒç”¨nativeæ–¹æ³•å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ„é€ Matå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šåœ¨å †å¤–åˆ†é…å†…å­˜ï¼š\n//  // C++: Mat::Mat()  //  // javadoc: Mat::Mat()  public Mat() { nativeObj = n_Mat(); return; } // C++: Mat::Mat()  private static native long n_Mat(); å †å¤–åˆ†é…çš„å†…å­˜ä¸å—JVMçš„å†…å­˜ç®¡ç†ã€‚ç”±äºåˆæ²¡æœ‰ä¸»åŠ¨è°ƒç”¨Mat.realse()å»é‡Šæ”¾å †å¤–å†…å­˜ï¼Œå¯¼è‡´å †å¤–å†…å­˜OOMã€‚\nå…¶å®è§£å†³çš„åŠæ³•å¾ˆç®€å•ï¼Œå¯ä»¥åœ¨Matå¯¹è±¡ä½¿ç”¨å®Œæ¯•åç›´æ¥è°ƒç”¨Mat.realse()é‡Šæ”¾å †å¤–å†…å­˜ã€‚ï¼ˆæ²¡æœ‰è¯•è¿‡ï¼Œæœ¬äººä½¿ç”¨çš„ä¸‹é¢çš„æ–¹å¼ï¼‰\nä½†æ˜¯ï¼ŒMatå¯¹è±¡å……æ–¥ç€æ•´ä¸ªé¡¹ç›®ï¼Œè¦è·Ÿè¸ªMatå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¾å¾—æœ‰ç‚¹å¤æ‚ï¼Œè€Œä¸”å› ä¸ºå¤ªå¤šåœ°æ–¹ä½¿ç”¨äº†Matå¯¹è±¡ï¼Œå¾ˆæœ‰å¯èƒ½é—æ¼è°ƒç”¨Mat.realse()é‡Šæ”¾å†…å­˜ã€‚å› æ­¤ï¼Œè¿˜æ˜¯æƒ³æŠŠè¿™éƒ¨åˆ†å†…å­˜çš„é‡Šæ”¾äº¤ç”±JVMæ¥åšï¼Œå…·ä½“çš„æ–¹å¼æ˜¯ï¼šå®šæœŸçš„è°ƒç”¨System.gc()æ‰§è¡Œåƒåœ¾å›æ”¶ï¼ˆå¾ˆå¤šäººè¯´System.gc()åªæ˜¯å»ºè®®JVMæ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œå¹¶ä¸æ˜¯å‘½ä»¤ï¼Œæ˜¯å¦æ‰§è¡Œå–å†³å»JVMè‡ªå·±ï¼Œä½†æ˜¯ï¼Œç»æˆ‘å®æµ‹ï¼Œæ¯æ¬¡è°ƒç”¨System.gc()éƒ½ä¼šè§¦å‘åƒåœ¾å›æ”¶ã€‚ï¼‰ï¼ŒJVMåœ¨åƒåœ¾å›æ”¶å‰ä¼šæ‰§è¡Œæ¯ä¸ª**ç©ºjavaå¯¹è±¡ï¼ˆnullï¼‰**çš„finalize()æ–¹æ³•ï¼Œè€ŒMatå¯¹è±¡çš„finalize()æ–¹æ³•æ­£å¥½å®ç°äº†é‡Šæ”¾å†…å­˜çš„é€»è¾‘ï¼š\n@Override protected void finalize() throws Throwable { n_delete(nativeObj); super.finalize(); } // native support for java finalize()  private static native void n_delete(long nativeObj); å› ä¸ºä¼šå®šæ—¶çš„è°ƒç”¨System.gc()è§¦å‘Full GC, è€ŒFull GCçš„ä¹‹å‰ä¼šè°ƒç”¨é‚£äº›ä¸å†è¢«å¼•ç”¨çš„Matå¯¹è±¡çš„finalize()æ–¹æ³•é‡Šæ”¾å®ƒçš„å †å¤–å†…å­˜ï¼Œæ‰€ä»¥é—´æ¥çš„å®ç°äº†ç”±JVMé‡Šæ”¾å †å¤–å†…å­˜çš„ç›®çš„ã€‚\nä½†æ˜¯ï¼Œè¿™ç§åšæ³•å¹¶ä¸å¥½ï¼Œå› ä¸ºé€šè¿‡System.gc()å¼ºåˆ¶å®šæœŸæ‰§è¡ŒFull GCï¼ŒåŠ¿å¿…ä¼šå½±å“javaåº”ç”¨æœ¬èº«ã€‚\nä¸ºä½•ä¸€å®šè¦å¤åˆ¶åˆ°DirectByteBufferæ¥è¯»å†™ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Ÿ\nGCä¼šå›æ”¶æ— ç”¨å¯¹è±¡ï¼ŒåŒæ—¶è¿˜ä¼šè¿›è¡Œç¢ç‰‡æ•´ç†ï¼Œç§»åŠ¨å¯¹è±¡åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œæ¥å‡å°‘å†…å­˜ç¢ç‰‡ã€‚DirectByteBufferä¸å—GCæ§åˆ¶ã€‚å¦‚æœä¸ç”¨DirectByteBufferè€Œæ˜¯ç”¨HeapByteBufferï¼Œå¦‚æœåœ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå‘ç”Ÿäº†GCï¼Œå¯¼è‡´HeapByteBufferå†…å­˜ä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ˜¯å†…æ ¸æ€å¹¶ä¸èƒ½æ„ŸçŸ¥åˆ°è¿™ä¸ªå˜åŒ–å¯¼è‡´ç³»ç»Ÿè°ƒç”¨è¯»å–æˆ–è€…å†™å…¥é”™è¯¯çš„æ•°æ®ã€‚æ‰€ä»¥ä¸€å®šè¦é€šè¿‡ä¸å—GCå½±å“çš„DirectByteBufferæ¥è¿›è¡ŒIOç³»ç»Ÿè°ƒç”¨ã€‚\nå‡è®¾æˆ‘ä»¬è¦ä»ç½‘ç»œä¸­è¯»å…¥ä¸€æ®µæ•°æ®ï¼Œå†æŠŠè¿™æ®µæ•°æ®å‘é€å‡ºå»çš„è¯ï¼Œé‡‡ç”¨Non-direct ByteBufferçš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š\nç½‘ç»œ â€“\u0026gt; ä¸´æ—¶çš„DirectByteBuffer â€“\u0026gt; åº”ç”¨ Non-direct ByteBuffer â€“\u0026gt; ä¸´æ—¶çš„Direct ByteBuffer â€“\u0026gt; ç½‘ç»œ\nè¿™ç§æ–¹å¼æ˜¯ç›´æ¥åœ¨å †å¤–åˆ†é…ä¸€ä¸ªå†…å­˜(å³ï¼Œnative memory)æ¥å­˜å‚¨æ•°æ®ï¼Œ ç¨‹åºé€šè¿‡JNIç›´æ¥å°†æ•°æ®è¯»/å†™åˆ°å †å¤–å†…å­˜ä¸­ã€‚å› ä¸ºæ•°æ®ç›´æ¥å†™å…¥åˆ°äº†å †å¤–å†…å­˜ä¸­ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼å°±ä¸ä¼šå†åœ¨JVMç®¡æ§çš„å †å†…å†åˆ†é…å†…å­˜æ¥å­˜å‚¨æ•°æ®äº†ï¼Œä¹Ÿå°±ä¸å­˜åœ¨å †å†…å†…å­˜å’Œå †å¤–å†…å­˜æ•°æ®æ‹·è´çš„æ“ä½œäº†ã€‚è¿™æ ·åœ¨è¿›è¡ŒI/Oæ“ä½œæ—¶ï¼Œåªéœ€è¦å°†è¿™ä¸ªå †å¤–å†…å­˜åœ°å€ä¼ ç»™JNIçš„I/Oçš„å‡½æ•°å°±å¥½äº†ã€‚\né‡‡ç”¨Direct ByteBufferçš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š\nç½‘ç»œ â€“\u0026gt; åº”ç”¨ Direct ByteBuffer â€“\u0026gt; ç½‘ç»œ\nå‚è€ƒï¼š https://blog.csdn.net/zhxdick/article/details/81084672\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/java%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/","series":["Manual"],"tags":["Java"],"title":"Javaå †å¤–å†…å­˜æº¢å‡º"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ä¸çŸ¥é“ä½ æ˜¯å•¥æ„Ÿè§‰ï¼Œä½†æ˜¯æˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘æ˜¯æ‡µé€¼çš„ã€‚\nè€Œä¸”å®ƒè¿˜æ˜¯ä¸€ä¸ªé¢è¯•é¢˜ã€‚\næˆ‘æ‡µé€¼å€’ä¸æ˜¯å› ä¸ºæˆ‘ä¸çŸ¥é“ç­”æ¡ˆï¼Œè€Œæ˜¯æ°å¥½æˆ‘ä¹‹å‰åœ¨éå¸¸æœºç¼˜å·§åˆçš„æƒ…å†µä¸‹çŸ¥é“äº†ç­”æ¡ˆã€‚\næˆ‘æ„Ÿè§‰éå¸¸çš„å†·é—¨ï¼Œä½œä¸ºä¸€ä¸ªè€ƒå¯Ÿå€™é€‰è€…çš„çŸ¥è¯†ç‚¹å‡ºç°åœ¨é¢è¯•ç¯èŠ‚ä¸­ä¸å¤ªåˆé€‚ï¼Œé™¤éæ˜¯å€™é€‰è€…ä¸»åŠ¨æèµ·åšè¿‡è¿™æ ·çš„ä¼˜åŒ–ã€‚\nè€Œä¸”æ€•å°±æ€•é¢è¯•å®˜ä¹Ÿæ˜¯æ°å·§åœ¨æŸä¸ªä¹¦ä¸Šæˆ–è€…åšå®¢ä¸­çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œç¨å¾®çš„çœ‹äº†ä¸€ä¸‹ï¼Œä»¥ä¸ºè‡ªå·±å­¦åˆ°äº†ç»ä¸–æ­¦åŠŸï¼Œç„¶åæ‹¿å‡ºå»è€ƒåˆ«äººã€‚\nè¿™æ ·ä¸åˆé€‚ã€‚\nè¯´å›è¿™ä¸ªé¢˜ç›®ã€‚\næ­£å¸¸æ¥è¯´ï¼Œå…¶å®åº”è¯¥æ˜¯å±äºè€ƒå¯Ÿæ“ä½œç³»ç»Ÿçš„çŸ¥è¯†ç‚¹èŒƒç•´ã€‚\nä½†æ˜¯é¢è¯•å®˜å‘¢åˆç‰¹å®šçš„åŠ äº†â€œåœ¨ Java ä¸­å¦‚ä½•å®ç°â€ã€‚\né‚£æˆ‘ä»¬å°±èŠèŠè¿™ä¸ªé—®é¢˜ã€‚\nJavaçº¿ç¨‹ åœ¨èŠå¦‚ä½•ç»‘å®šä¹‹å‰ï¼Œå…ˆé“ºå«ä¸€ä¸ªç›¸å…³çš„èƒŒæ™¯çŸ¥è¯†ï¼šJavaçº¿ç¨‹çš„å®ç°ã€‚\nå…¶å®æˆ‘ä»¬éƒ½çŸ¥é“ Thread ç±»çš„å¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯ native æ–¹æ³•ï¼š\nåœ¨ Java ä¸­ä¸€ä¸ªæ–¹æ³•è¢«å£°æ˜ä¸º native æ–¹æ³•ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹è¯´æ˜è¿™ä¸ªæ–¹æ³•æ²¡æœ‰æˆ–è€…ä¸èƒ½ä½¿ç”¨å¹³å°æ— å…³çš„æ‰‹æ®µæ¥å®ç°ã€‚\nè¯´æ˜éœ€è¦æ“ä½œçš„æ˜¯å¾ˆåº•å±‚çš„ä¸œè¥¿äº†ï¼Œå·²ç»è„±ç¦»äº† Java è¯­è¨€å±‚é¢çš„èŒƒç•´ã€‚\næŠ›å¼€ Java è¯­è¨€è¿™ä¸ªå¤§å‰æï¼Œå®ç°çº¿ç¨‹ä¸»è¦æ˜¯æœ‰ä¸‰ç§æ–¹å¼ï¼š\n 1.ä½¿ç”¨å†…æ ¸çº¿ç¨‹å®ç°ï¼ˆ1:1å®ç°ï¼‰ 2.ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°ï¼ˆ1:Nå®ç°ï¼‰ 3.ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹åŠ è½»é‡çº§è¿›ç¨‹æ··åˆå®ç°ï¼ˆN:Må®ç°ï¼‰\n è¿™ä¸‰ç§å®ç°æ–¹æ¡ˆï¼Œåœ¨ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹çš„ 12.4 å°èŠ‚æœ‰è¯¦ç»†çš„æè¿°ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»ä»”ç»†çš„ç¿»é˜…ä¸€ä¸‹ã€‚\næ€»ä¹‹ï¼Œä½ è¦çŸ¥é“çš„æ˜¯è™½ç„¶æœ‰è¿™ä¸‰ç§ä¸åŒçš„çº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯ Java ä½œä¸ºä¸Šå±‚åº”ç”¨ï¼Œå…¶å®æ˜¯æ„ŸçŸ¥ä¸åˆ°è¿™ä¸‰ç§æ¨¡å‹ä¹‹é—´çš„åŒºåˆ«çš„ã€‚\nJVM è§„èŒƒé‡Œé¢ä¹Ÿæ²¡æœ‰è§„å®šï¼Œå¿…é¡»ä½¿ç”¨å“ªä¸€ç§æ¨¡å‹ã€‚\nå› ä¸ºæ“ä½œç³»ç»Ÿæ”¯æŒæ˜¯æ€æ ·çš„çº¿ç¨‹æ¨¡å‹ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šäº†è¿è¡Œåœ¨ä¸Šé¢çš„ Java è™šæ‹Ÿæœºçš„çº¿ç¨‹æ€æ ·å»æ˜ å°„ï¼Œä½†æ˜¯è¿™ä¸€ç‚¹åœ¨ä¸åŒçš„å¹³å°ä¸Šå¾ˆéš¾è¾¾æˆä¸€è‡´ã€‚\næ‰€ä»¥JVM è§„èŒƒé‡Œé¢æ²¡æœ‰ã€ä¹Ÿä¸å¥½å»è§„å®š Java çº¿ç¨‹éœ€è¦ä½¿ç”¨å“ªç§çº¿ç¨‹æ¨¡å‹æ¥å®ç°ã€‚\nåŒæ—¶å…³äºæœ¬æ–‡è¦è®¨è®ºçš„è¯é¢˜ï¼Œæˆ‘åœ¨çŸ¥ä¹ä¸Šä¹Ÿæ‰¾åˆ°äº†ç±»ä¼¼çš„é—®é¢˜ï¼š\n https://www.zhihu.com/question/64072646/answer/216184631\r è¿™é‡Œé¢æœ‰ä¸€ä¸ªRå¤§çš„å›ç­”ï¼Œå¤§å®¶å¯ä»¥çœ‹çœ‹ä¸€ä¸‹ã€‚\nä»–ä¹Ÿæ˜¯å…ˆä»çº¿ç¨‹æ¨¡å‹çš„è§’åº¦é“ºå«äº†ä¸€ä¸‹ã€‚\næˆ‘è¿™é‡Œä¸»è¦è¯´ä¸€ä¸‹ä½¿ç”¨å†…æ ¸çº¿ç¨‹å®ç°ï¼ˆ1:1å®ç°ï¼‰çš„è¿™ä¸ªæ¨¡å‹ã€‚\nå› ä¸ºæˆ‘ä»¬ç”¨çš„æœ€å¤šçš„ HotSpot è™šæ‹Ÿæœºï¼Œå°±æ˜¯é‡‡ç”¨ 1:1 æ¨¡å‹æ¥å®ç° Java çº¿ç¨‹çš„ã€‚\nè¿™æ˜¯ä¸ªå•¥æ„æ€å‘¢ï¼Ÿ\nè¯´äººè¯å°±æ˜¯ä¸€ä¸ª Java çº¿ç¨‹æ˜¯ç›´æ¥æ˜ å°„ä¸ºä¸€ä¸ªæ“ä½œç³»ç»ŸåŸç”Ÿçº¿ç¨‹çš„ï¼Œä¸­é—´æ²¡æœ‰é¢å¤–çš„é—´æ¥ç»“æ„ã€‚HotSpot è™šæ‹Ÿæœºä¹Ÿä¸å¹²æ¶‰çº¿ç¨‹çš„è°ƒåº¦ï¼Œè¿™äº‹å…¨æƒäº¤ç»™åº•ä¸‹çš„æ“ä½œç³»ç»Ÿå»åšã€‚\né¡¶å¤šå°±æ˜¯è®¾ç½®ä¸€ä¸ªçº¿ç¨‹ä¼˜å…ˆçº§ï¼Œæ“ä½œç³»ç»Ÿæ¥è°ƒåº¦çš„æ—¶å€™ç»™ä¸ªå»ºè®®ã€‚\nä½†æ˜¯ä½•æ—¶æŒ‚èµ·ã€å”¤é†’ã€åˆ†é…æ—¶é—´ç‰‡ã€è®©é‚£ä¸ªå¤„ç†å™¨æ ¸å¿ƒå»æ‰§è¡Œç­‰ç­‰è¿™äº›å…³äºçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸã€æ‰§è¡Œçš„ä¸œè¥¿éƒ½æ˜¯æ“ä½œç³»ç»Ÿå¹²çš„ã€‚\nè¿™è¯ä¸æ˜¯æˆ‘è¯´çš„ï¼Œæ˜¯Rå¤§å’Œå‘¨ä½¬éƒ½è¯´è¿‡è¿™æ ·çš„è¯ã€‚\n https://www.zhihu.com/question/64072646/answer/216184631\r å…³äº 1:1 çš„çº¿ç¨‹æ¨¡å‹ï¼Œå¤§å®¶è®°ä½ä¹¦ä¸Šçš„è¿™å¹…å›¾å°±è¡Œï¼š\n LWPï¼šLight Weight Process è½»é‡çº§è¿›ç¨‹\nKLTï¼šKernal-Level Thread å†…æ ¸çº¿ç¨‹\nUTï¼šUser Thread ç”¨æˆ·çº¿ç¨‹\n å†…æ ¸çº¿ç¨‹å°±æ˜¯ç›´æ¥ç”±æ“ä½œç³»ç»Ÿå†…æ ¸æ”¯æŒçš„çº¿ç¨‹ï¼Œè¿™ç§çº¿ç¨‹ç”±å†…æ ¸æ¥å®Œæˆçº¿ç¨‹åˆ‡æ¢ï¼Œå†…æ ¸é€šè¿‡æ“çºµè°ƒåº¦å™¨å¯¹çº¿ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œå¹¶è´Ÿè´£å°†çº¿ç¨‹çš„ä»»åŠ¡æ˜ å°„åˆ°å„ä¸ªå¤„ç†å™¨ä¸Šã€‚\nç„¶åä½ çœ‹ä¸Šé¢çš„å›¾ç‰‡ï¼ŒKLT çº¿ç¨‹ä¸Šé¢éƒ½æœ‰ä¸€ä¸ª LWP ä¸ä¹‹å¯¹åº”ã€‚\nå•¥æ˜¯ LWP å‘¢ï¼Ÿ\nç¨‹åºä¸€èˆ¬æ¥è¯´ä¸ä¼šç›´æ¥ä½¿ç”¨å†…æ ¸çº¿ç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨å†…æ ¸çº¿ç¨‹çš„ä¸€ç§é«˜çº§æ¥å£ï¼Œå³è½»é‡çº§è¿›ç¨‹ï¼ˆLWPï¼‰ï¼Œè½»é‡çº§è¿›ç¨‹å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šè¯´çš„çº¿ç¨‹ã€‚\nç„¶åå¤§å®¶è®°ä½ä¹¦ä¸Šçš„ä¸‹é¢è¿™æ®µè¯ï¼Œå¯ä»¥è¯´æ˜¯ Java å¤šçº¿ç¨‹å®ç°çš„åŸºçŸ³ç†è®ºä¹‹ä¸€ï¼š\nç”±äºå†…æ ¸çº¿ç¨‹çš„æ”¯æŒï¼Œæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„è°ƒåº¦å•å…ƒï¼Œå³ä½¿å…¶ä¸­æŸä¸€ä¸ªè½»é‡çº§è¿›ç¨‹åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­è¢«é˜»å¡äº†ï¼Œä¹Ÿä¸ä¼šå½±å“æ•´ä¸ªè¿›ç¨‹ç»§ç»­å·¥ä½œã€‚\nä½†æ˜¯ï¼Œè½»é‡çº§è¿›ç¨‹ä¹Ÿå…·æœ‰å®ƒçš„å±€é™æ€§ã€‚\né¦–å…ˆï¼Œç”±äºæ˜¯åŸºäºå†…æ ¸çº¿ç¨‹å®ç°çš„ï¼Œæ‰€ä»¥å„ç§çº¿ç¨‹æ“ä½œï¼Œå¦‚åˆ›å»ºã€ææ„åŠåŒæ­¥ï¼Œéƒ½éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚è€Œç³»ç»Ÿè°ƒç”¨çš„ä»£ä»·ç›¸å¯¹è¾ƒé«˜ï¼Œéœ€è¦åœ¨ç”¨æˆ·æ€ï¼ˆUser Modeï¼‰å’Œå†…æ ¸æ€ï¼ˆKernel Modeï¼‰ä¸­æ¥å›åˆ‡æ¢ã€‚\nå…¶æ¬¡ï¼Œæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½éœ€è¦ä¸€ä¸ªå†…æ ¸çº¿ç¨‹çš„æ”¯æŒï¼Œå› æ­¤è½»é‡çº§è¿›ç¨‹è¦æ¶ˆè€—ä¸€å®šçš„å†…æ ¸èµ„æºï¼ˆå¦‚å†…æ ¸çº¿ç¨‹çš„æ ˆç©ºé—´ï¼‰ï¼Œå› æ­¤ä¸€ä¸ªç³»ç»Ÿæ”¯æŒè½»é‡çº§è¿›ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ã€‚\nå¥½çš„ï¼Œç»ˆäºé“ºå«å®Œæˆäº†ã€‚\nå‰é¢è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®å°±æ˜¯ä¸ºäº†è¡¨è¾¾ä¸€ä¸ªè§‚ç‚¹ï¼š\n ä¸è®ºä»ä»€ä¹ˆè§’åº¦æ¥è¯´ï¼Œç»‘å®šçº¿ç¨‹åˆ°æŸä¸ª CPU ä¸Šå»æ‰§è¡Œéƒ½åƒæ˜¯æ“ä½œç³»ç»Ÿå±‚é¢å¹²çš„äº‹å„¿ã€‚Java ä½œä¸ºé«˜çº§å¼€å‘è¯­è¨€ï¼Œè‚¯å®šæ˜¯ç›´æ¥å¹²ä¸äº†çš„ã€‚éœ€è¦æ›´åŠ åº•å±‚çš„å¼€å‘è¯­è¨€ï¼ŒJava é€šè¿‡ JNA æŠ€æœ¯å»è°ƒç”¨ã€‚\n åœ¨Rå¤§çš„å›ç­”ä¸­ä¹Ÿæåˆ°äº†è§£å†³æ–¹æ¡ˆï¼š\n åœ¨Linuxä¸Šçš„è¯ï¼Œå¯ä»¥ç”¨tasksetæ¥æŠŠçº¿ç¨‹ç»‘åœ¨æŸä¸ªæŒ‡å®šçš„æ ¸ä¸Šã€‚\nåœ¨Javaå±‚é¢ä¸Šï¼Œæœ‰å¤§å¤§å†™äº†ä¸ªç°æˆçš„åº“æ¥åˆ©ç”¨tasksetç»‘æ ¸ï¼š OpenHFT/Java-Thread-Affinity æœ‰å…´è¶£çš„è¯å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚\n Java-Thread-Affinity è¿™ä¸ªå¼€æºé¡¹ç›®å…¶å®å°±æ˜¯é¢è¯•é¢˜çš„ç­”æ¡ˆã€‚\n https://github.com/OpenHFT/Java-Thread-Affinity\r é¡¹ç›®é‡Œé¢æœ‰ä¸ªé—®ç­”ï¼Œè§£ç­”äº†å¦‚ä½•ä½¿ç”¨å®ƒå»åšç»‘æ ¸çš„æ“ä½œï¼š\nè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šæ•ˆæœæ¼”ç¤ºå§ã€‚\nå…ˆæŠŠä¾èµ–æåˆ°é¡¹ç›®é‡Œé¢å»ï¼š\n\u0026lt;dependency\u0026gt;\r\u0026lt;groupId\u0026gt;net.openhft\u0026lt;/groupId\u0026gt;\r\u0026lt;artifactId\u0026gt;affinity\u0026lt;/artifactId\u0026gt;\r\u0026lt;version\u0026gt;3.2.3\u0026lt;/version\u0026gt;\r\u0026lt;/dependency\u0026gt;\rç„¶åæ¥ä¸ª main æ–¹æ³•ï¼š\npublic static void main(String[] args) {\rtry (AffinityLock affinityLock = AffinityLock.acquireLock(5)) {\r// do some work while locked to a CPU.\rwhile(true) {}\r}\r}\ræŒ‰ç…§ git ä¸Šçš„æè¿°ï¼Œæˆ‘åœ¨æ–¹æ³•é‡Œé¢å†™äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¸ºçš„æ˜¯æ›´å¥½çš„æ¼”ç¤ºæ•ˆæœã€‚\nä¸Šé¢çš„æ„æ€å°±æ˜¯æˆ‘è¦åœ¨ç¬¬ 5 ä¸ª CPU çº¿ç¨‹æ‰§è¡Œæ­»å¾ªç¯ï¼ŒæŠŠ CPU åˆ©ç”¨ç‡æ‰“åˆ° 100%ã€‚\næ¥çœ‹ä¸€ä¸‹æ•ˆæœã€‚\nè¿™æ˜¯æ²¡æœ‰ç¨‹åºå¯åŠ¨ä¹‹å‰ï¼š\nè¿™æ˜¯å¯åŠ¨èµ·æ¥ä¹‹åï¼š\nç«‹ç«¿è§å½±ï¼ŒCUP 5 é©¬ä¸Šå°±è¢«æ‰“æ»¡äº†ã€‚\nåŒæ—¶è¿˜æœ‰ä¸¤è¡Œæ—¥å¿—è¾“å‡ºï¼Œæˆ‘æˆªå‡ºæ¥ç»™ä½ çœ‹ä¸€ä¸‹ï¼š\nå¦å¤–ï¼Œè¯´æ˜ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®å¯¹åº”çš„ Maven ç‰ˆæœ¬è¿˜æ˜¯æœ‰å¥½å¤šä¸ªçš„ï¼š\nåœ¨æˆ‘çš„æœºå™¨ä¸Šï¼Œå¦‚æœç”¨é«˜äº 3.2.3 çš„ç‰ˆæœ¬å°±ä¼šå‡ºç°è¿™æ ·çš„å¼‚å¸¸ä¿¡æ¯ï¼š\næ„Ÿè§‰æ˜¯ç‰ˆæœ¬å†²çªäº†ï¼Œåæ­£æ²¡å»æ·±ç©¶ï¼Œå¦‚æœä½ ä¹Ÿæƒ³è·‘ä¸€ä¸‹ï¼Œæˆ‘å°±æé†’ä¸€ä¸‹è€Œå·²ã€‚\næ•ˆæœæˆ‘ä»¬ç°åœ¨æ˜¯çœ‹åˆ°äº†ï¼Œå¯ä»¥è¯´è¿™ä¸ªé¡¹ç›®éå¸¸çš„æºœï¼Œå¯ä»¥å®ç°æŠŠçº¿ç¨‹ç»‘å®šåˆ°æŒ‡å®šæ ¸å¿ƒä¸Šå»ã€‚\nè¯¥åŠŸèƒ½ä¹Ÿæ˜¯æœ‰å®é™…åº”ç”¨åœºæ™¯çš„ï¼Œå±äºä¸€ç›´éå¸¸æè‡´çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µå§ã€‚\nç»‘å®šæ ¸å¿ƒä¹‹åå°±å¯ä»¥æ›´å¥½çš„åˆ©ç”¨ç¼“å­˜ä»¥åŠå‡å°‘çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\nè¯´åˆ°è¿™å°±ä¸å¾—ä¸æèµ·æˆ‘ç¬¬ä¸€æ¬¡çŸ¥é“â€œç»‘æ ¸â€è¿™ä¸ªéªšæ“ä½œçš„åœºæ™¯äº†ã€‚\né‚£æ˜¯ä¸¾è¡Œäº 2018 å¹´çš„é¦–å±Šæ•°æ®åº“æ€§èƒ½å¤§èµ›ï¼Œæˆ–è€…æ›´åŠ å‡ºåä¸€ç‚¹çš„åå­—å«åšå¤©æ± å¤§èµ›ã€‚\né‚£ä¸€å±Šæ¯”èµ›ï¼Œæˆ‘å»æ‰“äº†ä¸ªé…±æ²¹ï¼Œæˆç»©éå¸¸æ‹‰èƒ¯å°±ä¸æäº†ã€‚\nä½†æ˜¯æˆ‘å»ä»”ç»†çš„çœ‹äº†å‰å‡ åçš„èµ›ååˆ†äº«ï¼Œå¤§å®¶çš„æ€è·¯éƒ½æ˜¯å¤§åŒå°å¼‚çš„ã€‚\næˆ‘åˆä¸å¾—ä¸å°å£°çš„å¨å¨ä¸€å¥ï¼šé‚£ä¸€å±Šæ¯”èµ›æ‰“åˆ°æœ€åå·²ç»å˜æˆäº†å¼€å‘è¯­è¨€å±‚é¢ä¸Šã€å‚æ•°é…ç½®ä¸Šçš„å·®è·äº†ã€‚C++ å¤©ç„¶ä¼˜åŠ¿ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°æ’åœ¨å‰é¢çš„æ¸…ä¸€è‰²çš„ C++ é€‰æ‰‹ã€‚\nå¾ˆå¤šæ”¯é˜Ÿä¼éƒ½æåˆ°äº†ä¸€ä¸ªå°ç»†èŠ‚ï¼Œé‚£å°±æ˜¯ç»‘æ ¸ã€‚\nè€Œæˆ‘ç¬¬ä¸€æ¬¡çŸ¥é“è¿™ä¸ªå¼€æºé¡¹ç›®ï¼Œå°±æ˜¯é€šè¿‡è¿™ç¯‡æ–‡ç« ã€ŠPolarDBæ•°æ®åº“æ€§èƒ½å¤§èµ›Javaé€‰æ‰‹åˆ†äº«ã€‹\nå½“æ—¶æŠŠä»–çš„å‚èµ›ä»£ç æ‹‰ä¸‹æ¥çœ‹äº†ä¸€ä¸‹ï¼Œå¯¹äºç»‘æ ¸æ“ä½œæœ‰äº†ä¸€ä¸ªåŸºç¡€è®¤è¯†ï¼Œä½†æ˜¯å…¶å®ä¹Ÿæ²¡æœ‰æ·±ç©¶å®ç°ã€‚\nåªæ˜¯è¿™æ ·å†™å°±å¯¹äº†ï¼Œå°±èƒ½ç»‘ä¸Šå°±å®Œäº‹äº†ã€‚\nå†åæ¥ï¼Œæˆ‘çœ‹ disruptor è¿™ä¸ªæ¡†æ¶çš„æ—¶å€™ï¼Œçœ‹åˆ°å®ƒæœ‰ä¸€ä¸ªè¿™æ ·çš„ç­‰å¾…ç­–ç•¥ï¼š\n com.lmax.disruptor.BusySpinWaitStrategy\n è¿™ä¸ªç­–ç•¥ä¸Šæœ‰è¿™æ ·çš„ä¸€ä¸ªæ³¨é‡Šï¼š\n It is best used when threads can be bound to specific CPU cores.\n å¦‚æœä½ è¦ç”¨è¿™ä¸ªç­–ç•¥ï¼Œæœ€å¥½æ˜¯çº¿ç¨‹å¯ä»¥è¢«ç»‘å®šåˆ°ç‰¹å®šçš„ CPU æ ¸å¿ƒä¸Šã€‚\nå°±è¿™æ ·ï¼Œå¥‡æ€ªçš„çŸ¥è¯†åˆè¢«å”¤é†’äº†ã€‚\næˆ‘çŸ¥é“æ€ä¹ˆç»‘å®šå•Šï¼ŒJava-Thread-Affinity è¿™ä¸ªå¼€æºé¡¹ç›®å°±åšäº†ã€‚\näºæ˜¯é—®é¢˜å°±å˜æˆäº†ï¼šå®ƒæ˜¯æ€ä¹ˆåšå‘¢ï¼Ÿ\næ€ä¹ˆåšçš„ å…·ä½“æ€ä¹ˆåšçš„ï¼Œåªå†™å‡ ä¸ªå…³é”®çš„ç‚¹ï¼Œç®€å•çš„åˆ†æä¸€ä¸‹ï¼Œå¤§å®¶æœ‰å…´è¶£çš„å¯ä»¥æŠŠæºç æ‹‰ä¸‹çœ‹ã€‚\né¦–å…ˆç¬¬ä¸€ä¸ªç‚¹ï¼šJNA å¯¹äº Java-Thread-Affinity éå¸¸é‡è¦ï¼š\nå¯ä»¥è¯´å…¶å® Java-Thread-Affinity å°±æ˜¯å¥—äº†ä¸ª Java çš®ï¼Œè¿™ç§åº”è¯¥è®©æ“ä½œç³»ç»Ÿæ¥åšçš„äº‹ï¼Œå…¶å®ç¼–å†™æ›´åŠ åº•å±‚çš„ C++ æˆ–è€… C è¯­è¨€æ¥å®ç°çš„ã€‚\næ‰€ä»¥è¿™ä¸ªé¡¹ç›®å®è´¨ä¸Šæ˜¯åŸºäº JNA è°ƒç”¨äº† DLL æ–‡ä»¶ï¼Œä»è€Œå®ç°ç»‘æ ¸çš„éœ€æ±‚ã€‚\nå…·ä½“å¯¹åº”çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š\n net.openhft.affinity.Affinity\n é¦–å…ˆåœ¨è¿™ä¸ªç±»çš„é™æ€ä»£ç å—åˆ¤æ–­æ“ä½œç³»ç»Ÿçš„ç±»å‹ï¼š\næˆ‘è¿™é‡Œæ˜¯ win æ“ä½œç³»ç»Ÿã€‚\n net.openhft.affinity.IAffinity\n æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰å„ä¸ªå¹³å°çš„çº¿ç¨‹äº²å’Œæ€§å®ç°ï¼š\næ¯”å¦‚ï¼Œåœ¨å®ç°ç±» WindowsJNAAffinity é‡Œé¢ï¼Œä½ å¯ä»¥çœ‹åˆ°åœ¨å®ƒçš„é™æ€ä»£ç å—é‡Œé¢è°ƒç”¨äº†è¿™æ ·çš„é€»è¾‘ï¼š\n net.openhft.affinity.impl.WindowsJNAAffinity.CLibrary\n è¿™é‡Œå°±æ˜¯é€šè¿‡å‰é¢è¯´çš„ï¼Œé€šè¿‡ JNA è°ƒç”¨ kernel32.dll æ–‡ä»¶ã€‚\nåœ¨ windows å¹³å°ä¸Šèƒ½ä½¿ç”¨è¯¥åŠŸèƒ½çš„ä¸€äº›çš„åŸºçŸ³å°±æ˜¯åœ¨æ­¤ã€‚\nç¬¬äºŒä¸ªç‚¹ï¼šæ€ä¹ˆç»‘å®šåˆ°æŒ‡å®šæ ¸å¿ƒä¸Šï¼Ÿ\nåœ¨å…¶æ ¸å¿ƒç±»é‡Œé¢æœ‰è¿™æ ·çš„ä¸€ä¸ªæ–¹æ³•ï¼š\n net.openhft.affinity.AffinityLock#acquireLock(int)\n è¿™é‡Œçš„å…¥å‚ï¼Œå°±æ˜¯ç¬¬å‡ ä¸ª CPU çš„æ„æ€ï¼Œè®°å¾— CPU ç¼–å·æ˜¯ä» 0 å¼€å§‹ã€‚\nä½† 0 ä¸å»ºè®®ä½¿ç”¨ï¼š\næ‰€ä»¥ç¨‹åºé‡Œé¢ä¹Ÿæ§åˆ¶äº†ä¸èƒ½ç»‘å®šåˆ° 0 å· CPU ä¸Šã€‚\næœ€ç»ˆä¼šèµ°åˆ°è¿™ä¸ªæ–¹æ³•ä¸­ï¼š\n net.openhft.affinity.AffinityLock#bind(boolean)\n è¿™é‡Œé‡‡ç”¨çš„æ˜¯ BitSetï¼Œæƒ³ç»‘å®šåˆ°ç¬¬å‡ ä¸ª CPU å°±æŠŠç¬¬å‡ ä¸ª CPU çš„ä½ç½®è®¾ç½®ä¸º trueã€‚\nåœ¨ win å¹³å°ä¸Šä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼š\n net.openhft.affinity.impl.WindowsJNAAffinity.CLibrary#SetThreadAffinityMask\n è¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯é™åˆ¶çº¿ç¨‹åœ¨å“ªä¸ª CPU ä¸Šè¿è¡Œçš„ APIã€‚\n https://docs.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask?redirectedfrom=MSDN\r ç¬¬ä¸‰ä¸ªç‚¹ï¼šSolaris å¹³å°æ€ä¹ˆå®ç°çš„ï¼Ÿ\nå› ä¸ºæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ Solaris å¹³å°ä¸Šçš„ HotSpot è™šæ‹Ÿæœºï¼ŒåŒæ—¶æ”¯æŒ 1:1 å’Œ N:M çš„çº¿ç¨‹æ¨¡å‹ã€‚\né‚£ä¹ˆæŒ‰ç†æ¥è¯´å¾—æä¾›ä¸¤å¥—ç»‘å®šæ–¹æ¡ˆï¼Œäºæ˜¯æˆ‘ç‚¹è¿›å»ä¸€çœ‹ï¼Œå¥½å®¶ä¼™ï¼š\nå¤§é“è‡³ç®€ï¼Œç›´æ¥æ¥ä¸€ä¸ªä¸å®ç°ã€‚\nç¬¬å››ä¸ªç‚¹ï¼šæœ‰è°ç”¨äº†ï¼Ÿ\nNetty é‡Œé¢ç”¨åˆ°äº†è¿™ä¸ªåº“ï¼š\n https://ifeve.com/thread-affinity/\r SOFAJRaft é‡Œé¢ä¹Ÿä¾èµ–äº†è¿™ä¸ªåŒ…ï¼š\n https://github.com/sofastack/sofa-jraft/blob/master/README_zh_CN.md\r ç„¶åæˆ‘å‰é¢è¯´åˆ°çš„æ¯”èµ›ä¸­ä¹Ÿæœ‰è¿™æ ·çš„ä½¿ç”¨åœºæ™¯ï¼Œåœ¨çŸ¥ä¹ä¹Ÿçœ‹åˆ°äº†è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ï¼š\nå¥½äº†ï¼Œæ–‡ç« å†™åˆ°è¿™é‡Œä¹Ÿå°±å¯ä»¥æ”¶å°¾äº†ã€‚\nä½ å†æƒ³æƒ³è¿™ä¸ªé¢è¯•é¢˜ï¼Œå¦‚æœé¢è¯•å®˜æƒ³è¦çš„çœŸçš„æ˜¯è¿™ä¸ªå›ç­”ï¼Œä½ è¯´åˆé€‚å—ï¼Ÿ\nè€Œä¸”ä½ è¯´ä½ é—®è¿™å¹²å•¥ï¼Œè‡ªå·±å®¶å•¥ä¸šåŠ¡åœºæ™¯å•Šï¼Œæ‚é‡æ‚é‡ï¼Œéœ€è¦ä¼˜åŒ–åˆ°è¿™ä¸ªçº§åˆ«ï¼Ÿ\néš¾é“æ˜¯é«˜é¢‘äº¤æ˜“ï¼Ÿ\näººæ‹›è¿›æ¥åï¼Œå¯èƒ½çº¿ç¨‹æ± éƒ½çœ‹ä¸åˆ°å‡ ä¸ªï¼Œä½ è¯´æ˜¯å§ï¼Ÿ\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/java%E5%A6%82%E4%BD%95%E7%BB%91%E5%AE%9A%E7%BA%BF%E7%A8%8B%E5%88%B0%E6%8C%87%E5%AE%9Acpu%E4%B8%8A%E6%89%A7%E8%A1%8C/","series":["Manual"],"tags":["Java"],"title":"Javaå¦‚ä½•ç»‘å®šçº¿ç¨‹åˆ°æŒ‡å®šCPUä¸Šæ‰§è¡Œ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. ä¸‹è½½JDK è¿›å…¥Oracle å®˜æ–¹ç½‘ç«™\rä¸‹è½½åˆé€‚çš„ JDK ç‰ˆæœ¬ï¼Œå‡†å¤‡å®‰è£…ã€‚\n2. åˆ›å»ºç›®å½• æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œåœ¨ /usr/ ç›®å½•ä¸‹åˆ›å»º java ç›®å½•ã€‚\nmkdir /usr/java cd /usr/java å°†ä¸‹è½½çš„æ–‡ä»¶ jdk-8u151-linux-x64.tar.gz å¤åˆ¶åˆ° /usr/java/ ç›®å½•ä¸‹ã€‚\n3. è§£å‹ JDK tar -zxvf jdk-8u151-linux-x64.tar.gz 4. è®¾ç½®ç¯å¢ƒå˜é‡ set java environment JAVA_HOME=/usr/java/jdk1.8.0_151 JRE_HOME=/usr/java/jdk1.8.0_151/jre CLASS_PATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin export JAVA_HOME JRE_HOME CLASS_PATH PATH ä½¿ä¿®æ”¹ç”Ÿæ•ˆï¼š\nsource /etc/profile 5. æµ‹è¯• æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯•ã€‚\njava -version è‹¥æ˜¾ç¤º Java ç‰ˆæœ¬ä¿¡æ¯ï¼Œåˆ™è¯´æ˜ JDK å®‰è£…æˆåŠŸï¼š\njava version \u0026#34;1.8.0_151\u0026#34; Java(TM) SE Runtime Environment (build 1.8.0_151-b12) Java HotSpot(TM) 64-Bit Server VM (build 25.151-b12, mixed mode) ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/java%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/","series":["Manual"],"tags":["Java"],"title":"Javaå®‰è£…æŒ‡å—"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"javaä¸­çš„Objectç±»çš„hashCodeæ–¹æ³•æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼ŒæŸ¥çœ‹nativeæºç è¿‡äºå›°éš¾ï¼Œæ‰€ä»¥æš‚ä¸”è®¤ä¸º Objectç±»çš„hashCodeç”Ÿæˆè§„åˆ™æ˜¯ï¼šhash(å¯¹è±¡çš„å†…å­˜åœ°å€+ä¸€äº›å…¶ä»–ä¿¡æ¯)\njavaä¸­Stringç±»çš„ hashCodeæ–¹æ³• æ¯”è¾ƒç›´è§‚ï¼Œæºç å¦‚ä¸‹ï¼š\npublic int hashCode() { int h = hash; if (h == 0 \u0026amp;\u0026amp; value.length \u0026gt; 0) { char val[] = value; for (int i = 0; i \u0026lt; value.length; i++) { h = 31 * h + val[i]; } hash = h; } return h; } ç”Ÿæˆè§„åˆ™ï¼šs[0]*31^(n-1) + s[1]*31^(n-2) + \u0026hellip; + s[n-1]\nä¸ºä»€ä¹ˆæ˜¯ç´ æ•°31ï¼Ÿ\nç´ æ•°ï¼šæ ¹æ®ç´ æ•°çš„ç‰¹ç‚¹ï¼Œä¸€ä¸ªæ•°ä¸ç´ æ•°ç›¸ä¹˜ï¼Œå¾—åˆ°ç»“æœåªèƒ½è¢«1ã€è¿™ä¸ªæ•°ã€ç´ æ•°æœ¬èº«æ•´é™¤ã€‚å› æ­¤ï¼ŒæŒ‰ç…§ s[0]*31^(n-1) + s[1]*31^(n-2) + \u0026hellip; + s[n-1] ç”Ÿæˆçš„hashCodeè¶Šä¸å®¹æ˜“å‘ç”Ÿç¢°æ’ã€‚\n31ï¼šå“ˆå¸Œè®¡ç®—é€Ÿåº¦å¿«ã€‚å¯ç”¨ç§»ä½å’Œå‡æ³•æ¥ä»£æ›¿ä¹˜æ³•ã€‚ç°ä»£çš„VMå¯ä»¥è‡ªåŠ¨å®Œæˆè¿™ç§ä¼˜åŒ–ï¼Œå¦‚31 * i = (i \u0026laquo; 5) - iã€‚\nå‚è€ƒï¼š\nhttps://juejin.im/post/5ba75d165188255c6a043b96\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/java%E5%AF%B9%E8%B1%A1%E7%9A%84hashcode%E6%96%B9%E6%B3%95/","series":["Manual"],"tags":["Java"],"title":"Javaå¯¹è±¡çš„hashCodeæ–¹æ³•"},{"categories":["äº‘åŸç”Ÿ"],"content":"javaåº”ç”¨ä»nfsåŠ è½½é…ç½®æ–‡ä»¶\nèƒŒæ™¯ é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œæ— éœ€é‡æ–°æ„å»ºé•œåƒéƒ¨ç½²ã€‚\n1. å‡†å¤‡nfs 1ã€å‡†å¤‡å¥½nfsæœåŠ¡å™¨ã€‚å‚è€ƒï¼šnfså®‰è£…\rçš„nfsæœåŠ¡ç«¯é…ç½®ã€‚ 2ã€k8s nodeèŠ‚ç‚¹å¯ä»¥ä¸å¯ç”¨rpcbindæœåŠ¡ï¼Œä½†æ˜¯å¿…é¡»å®‰è£…nfs-utilsï¼ˆyum install nfs-utilsï¼‰ï¼Œå¦åˆ™nfs-client-provisioner podæ— æ³•å¯åŠ¨ï¼Œå› ä¸ºnfs-client.yamlé‡Œé¢æœ‰nfsçš„ç›¸å…³é…ç½®ï¼Œè€Œè¿™äº›nfsé…ç½®è¦ç”Ÿæ•ˆéœ€ä¾èµ–nfs-utilsã€‚å‚è€ƒï¼šnfså®‰è£…\rçš„nfså®¢æˆ·ç«¯é…ç½®ã€‚\n2. åˆ›å»ºStorageClasså¯¹è±¡ ç†è®ºéƒ¨åˆ†å‚è€ƒï¼šStorageClass\r2.1 nfs-client.yaml kind: Deployment apiVersion: apps/v1 metadata: name: nfs-client-provisioner spec: replicas: 1 strategy: type: Recreate selector: matchLabels: app: nfs-client-provisioner template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner image: quay.io/external_storage/nfs-client-provisioner:latest volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME value: fuseim.pri/ifs - name: NFS_SERVER value: nfs - name: NFS_PATH value: /mnt/nfs/k8s volumes: - name: nfs-client-root nfs: server: nfs path: /mnt/nfs/k8s [v_warn]k8s nodeèŠ‚ç‚¹å¯ä»¥ä¸å¯ç”¨rpcbindæœåŠ¡ï¼Œä½†å¿…é¡»å®‰è£…nfs-utilsã€‚[/v_warn]\n2.2 nfs-client-sa.yaml apiVersion: v1 kind: ServiceAccount metadata: name: nfs-client-provisioner --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: nfs-client-provisioner-runner rules: - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;persistentvolumes\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;create\u0026#34;, \u0026#34;delete\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;persistentvolumeclaims\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;update\u0026#34;] - apiGroups: [\u0026#34;storage.k8s.io\u0026#34;] resources: [\u0026#34;storageclasses\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;events\u0026#34;] verbs: [\u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;create\u0026#34;, \u0026#34;update\u0026#34;, \u0026#34;patch\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;endpoints\u0026#34;] verbs: [\u0026#34;create\u0026#34;, \u0026#34;delete\u0026#34;, \u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;patch\u0026#34;, \u0026#34;update\u0026#34;] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: run-nfs-client-provisioner subjects: - kind: ServiceAccount name: nfs-client-provisioner namespace: default roleRef: kind: ClusterRole name: nfs-client-provisioner-runner apiGroup: rbac.authorization.k8s.io 2.3 nfs-client-class.yaml apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: nfs-storage provisioner: fuseim.pri/ifs # or choose another name, must match deployment\u0026#39;s env PROVISIONER_NAME\u0026#39; ç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºè¿™äº›èµ„æºå¯¹è±¡å§ï¼š\n$ kubectl create -f nfs-client.yaml $ kubectl create -f nfs-client-sa.yaml $ kubectl create -f nfs-client-class.yaml åˆ›å»ºå®ŒæˆåæŸ¥çœ‹ä¸‹èµ„æºçŠ¶æ€ï¼š\n$ kubectl get pods NAME READY STATUS RESTARTS AGE ... nfs-client-provisioner-7648b664bc-7f9pk 1/1 Running 0 7h ... $ kubectl get storageclass NAME PROVISIONER AGE course-nfs-storage fuseim.pri/ifs 11s 3. åˆ›å»ºPVCå¯¹è±¡ kind: PersistentVolumeClaim apiVersion: v1 metadata: name: ceres-admin-server-nfs-pvc annotations: volume.beta.kubernetes.io/storage-class: \u0026#34;nfs-storage\u0026#34; spec: accessModes: - ReadWriteMany resources: requests: storage: 32Mi æŸ¥çœ‹pvcï¼š\n[root@k8s-master StorageClass]# kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE ceres-admin-server-nfs-pvc Bound pvc-fec62c86-451e-4125-9e00-be60394f40d9 32Mi RWX nfs-storage 3h13m ceres-app-server-nfs-pvc Bound pvc-6367fbb5-bc9c-4a75-a5a4-0a555172a6fd 32Mi RWX nfs-storage 53m è‡ªåŠ¨ç”Ÿæˆäº†ä¸€ä¸ªå…³è”çš„ PV å¯¹è±¡ï¼Œè®¿é—®æ¨¡å¼æ˜¯ RWXï¼Œå›æ”¶ç­–ç•¥æ˜¯ Deleteï¼Œè¿™ä¸ª PV å¯¹è±¡å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºçš„å§ï¼Œè¿™æ˜¯é€šè¿‡æˆ‘ä»¬ä¸Šé¢çš„ StorageClass å¯¹è±¡è‡ªåŠ¨åˆ›å»ºçš„ï¼š\n[root@k8s-master StorageClass]# kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-6367fbb5-bc9c-4a75-a5a4-0a555172a6fd 32Mi RWX Delete Bound default/ceres-app-server-nfs-pvc nfs-storage 55m pvc-fec62c86-451e-4125-9e00-be60394f40d9 32Mi RWX Delete Bound default/ceres-admin-server-nfs-pvc nfs-storage 3h14m 4. æ‹·è´é…ç½®æ–‡ä»¶åˆ°nfså…±äº«ç›®å½• åˆ›å»ºpvcä¹‹åå°±èƒ½åœ¨nfsçœ‹åˆ°å·²ç»ç”Ÿæˆç›¸åº”çš„å…±äº«ç›®å½•ã€‚\nå…±äº«ç›®å½•å‘½åè§„åˆ™å¦‚ä¸‹ï¼š\n è‡ªåŠ¨åˆ›å»ºçš„ PV ä»¥${namespace}-${pvcName}-${pvName}è¿™æ ·çš„å‘½åæ ¼å¼åˆ›å»ºåœ¨ NFS æœåŠ¡å™¨ä¸Šçš„å…±äº«æ•°æ®ç›®å½•ä¸­ è€Œå½“è¿™ä¸ª PV è¢«å›æ”¶åä¼šä»¥archieved-${namespace}-${pvcName}-${pvName}è¿™æ ·çš„å‘½åæ ¼å¼å­˜åœ¨ NFS æœåŠ¡å™¨ä¸Šã€‚  å½¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š 5. ä½¿ç”¨PVC apiVersion: apps/v1 kind: Deployment metadata: labels: app: ceres-admin-server name: ceres-admin-server-deployment spec: replicas: 1 selector: matchLabels: app: ceres-admin-server template: metadata: labels: app: ceres-admin-server spec: containers: - command: - java - \u0026#39;-jar\u0026#39; - /root/app.jar - \u0026#39;--spring.config.location=/root/config/\u0026#39; - \u0026#39;--spring.profiles.active=prod\u0026#39; image: anaham-docker.pkg.coding.net/cereshop/ceres/ceres-admin-server name: ceres-admin-server ports: - containerPort: 9000 volumeMounts: - mountPath: /root/config/ name: ceres-admin-server-nfs-pvc workingDir: /root imagePullSecrets: - name: coding-regcred volumes: - name: ceres-admin-server-nfs-pvc persistentVolumeClaim: claimName: ceres-admin-server-nfs-pvc æ›´æ–°é…ç½®æ–‡ä»¶ååˆ é™¤podï¼Œè®©k8sé‡æ–°åˆ›å»ºpodå³å¯è®©ä¿®æ”¹é…ç½®ç”Ÿæ•ˆï¼Œä»è€Œé¿å…é‡æ–°æ„å»ºé•œåƒã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/java%E5%BA%94%E7%94%A8%E4%BB%8Enfs%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"javaåº”ç”¨ä»nfsåŠ è½½é…ç½®æ–‡ä»¶"},{"categories":["æŒç»­é›†æˆéƒ¨ç½²"],"content":"jenkins+docker+è…¾è®¯äº‘å®¹å™¨ä»“åº“+githubæ­å»ºCI/CDç¯å¢ƒ\næŒç»­é›†æˆ/æŒç»­éƒ¨ç½²çš„é‡è¦æ€§ä¸å¿…å¤šè¨€ï¼Œéƒ½ä»€ä¹ˆå¹´ä»£äº†ï¼Œæ²¡æœ‰å“ªä¸ªæ­£ç´§é¡¹ç›®è¿˜åœ¨äººå·¥æ„å»º/æµ‹è¯•/éƒ¨ç½²ã€‚æœ¬æ–‡æ‰‹æŠŠæ‰‹æ•™ä½ æ­å»ºjenkins+docker+è…¾è®¯äº‘å®¹å™¨ä»“åº“+githubçš„CI/CDç¯å¢ƒã€‚å¦¥å¦¥çš„å¹²æ´»ï¼Œç»å¯¹æ˜¯è§£æ”¾ç”Ÿäº§åŠ›çš„åˆ©å™¨ã€‚æ¶æ„å›¾å¦‚ä¸‹ï¼š\n\rstep1: ç¨‹åºçŒ¿git pushä»£ç åˆ°github step2: jenkinsé€šè¿‡github webhooksè§¦å‘ä»»åŠ¡ï¼ˆ jenkinsæ„å»ºé¡¹ç›®ï¼Œå¹¶åˆ¶ä½œdockeré•œåƒï¼‰ step3: æ¨é€é•œåƒåˆ°å®¹å™¨ä»“åº“ step4: åº”ç”¨æœåŠ¡å™¨æ‹‰å»é•œåƒåˆ°æœ¬åœ°è¿è¡Œ\nä¸ºäº†ä¸è®©æ–‡ç« ç¯‡å¹…è¿‡é•¿ï¼Œæœ¬ç³»åˆ—tonyå¾è€å¸ˆå°†æ–‡ç« åˆ†æˆä¸¤ä¸ªå°ç« èŠ‚ï¼š\ngithub webhooks+jenkinsæ­å»ºæŒç»­é›†æˆç¯å¢ƒ\r æœ¬æ–‡æ˜¯jenkins+docker+è…¾è®¯äº‘å®¹å™¨ä»“åº“+githubæ­å»ºCI/CDç¯å¢ƒ\rçš„ç¬¬ä¸€å­ç« èŠ‚ã€‚æ„åœ¨æ•™æ‚¨é€šè¿‡github webhooks+jenkinsæ­å»ºæŒç»­é›†æˆç¯å¢ƒï¼Œå¦‚æœæ‚¨å·²ç»å®Œæˆwebhooks+jenkinsçš„é…ç½®ï¼Œå¯ä»¥ç›´æ¥è°ƒæ•´åˆ°ç¬¬äºŒå­ç« èŠ‚jenkins+è…¾è®¯äº‘å®¹å™¨ä»“åº“+dockeræŒç»­éƒ¨ç½²\r\r1. githubé…ç½®Personal access tokens æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼ŒæŒ‰å›¾æ“ä½œï¼š \r\rè®°ä¸‹ç”Ÿæˆçš„tokenï¼Œå¾…ä¼šå„¿è¦ç”¨çš„ã€‚\n2. githubé…ç½®webhooks å»åˆ°ä½ çš„githubé¡¹ç›®ä»“åº“ï¼ŒæŒ‰å›¾æ“ä½œï¼š \r\rè¿™é‡Œçš„Payload URL = ä½ çš„jenkinsåœ°å€+/github-webhook/\nè‡³æ­¤ï¼Œgithubä¸Šçš„é…ç½®å…¨éƒ¨å®Œæˆã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é…ç½®jenkinsã€‚\n 3. jenkinsé…ç½®å‡­æ® \r\rè¿™é‡Œçš„Secretå°±æ˜¯åœ¨ç¬¬1èŠ‚é…ç½®çš„Personal access tokens\n\r æ·»åŠ ä¸€ä¸ªgithubç™»é™†å‡­æ®ï¼Œusernameå’Œpasswordå¯¹åº”githubçš„ç™»é™†è´¦å·å¯†ç ã€‚ æ·»åŠ ä¸€ä¸ªå®¿ä¸»æœºç™»é™†å‡­æ®ï¼Œusernameå’Œpasswordå¯¹åº”ç™»é™†çš„è´¦å·å¯†ç ï¼ˆå› ä¸ºå°ç¼–çš„jenkinsæ˜¯å®¹å™¨çš„æ–¹å¼è¿è¡Œçš„ï¼Œå› æ­¤åé¢éœ€è¦è¿™ä¸ªå‡­æ®sshåˆ°å®¿ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤ï¼‰ã€‚  4. é…ç½®ssh sites æ¥ä¸‹æ¥é…ç½®ä¸€ä¸ªssh sitesï¼Œç”¨äºåé¢éœ€è¦sshåˆ°å®¿ä¸»æœºã€‚ \r5. é…ç½®jenkinsè¿è¡Œç¯å¢ƒ è¿™é‡Œçš„ç¯å¢ƒå–å†³ä¸ä½ çš„é¡¹ç›®éœ€è¦çš„ç¯å¢ƒã€‚ \rå¦‚æœä½ çš„jenkinsæ˜¯ç›´æ¥è¿è¡Œåœ¨æœºå™¨ä¸Šï¼Œé‚£ä¹ˆæŒ‡å®šå¯¹åº”ç¯å¢ƒçš„è·¯å¾„å³å¯ã€‚å¦‚æœæ˜¯è¿è¡Œåœ¨å®¹å™¨é‡Œé¢ï¼Œå®¹å™¨å¯åŠ¨çš„æ—¶å€™æŠŠå®¿ä¸»æœºçš„ç¯å¢ƒæ˜ å°„åˆ°å®¹å™¨å³å¯ã€‚\n6. æ–°å»ºä¸€ä¸ªmavené¡¹ç›® æœ¬å°èŠ‚ä»¥ä¸€ä¸ªmavené¡¹ç›®ä¸ºä¾‹å­ï¼Œä¸‹ä¸€ä¸ªå°èŠ‚æˆ‘è¿˜è¡¥å……äº†vueé¡¹ç›®çš„ä¾‹å­ã€‚ \rè¯·æŒ‰å›¾æ“ä½œï¼š \rè¯·æŒ‰å›¾æ“ä½œï¼š \rè¯·æŒ‰å›¾æ“ä½œï¼š \rè¿™é‡Œå¯¹ä¸Šå›¾è§£é‡Šä¸€ä¸‹ï¼šä¸Šå›¾çš„å«ä¹‰æ˜¯ï¼Œå½“mavenæ„å»ºå®Œé¡¹ç›®ä¹‹åï¼Œåˆ¶ä½œdockeré•œåƒï¼Œå¹¶æ¨é€åˆ°è¿œç¨‹å®¹å™¨ä»“åº“ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æ„å»ºå®Œé¡¹ç›®ä¹‹åï¼Œç›´æ¥java -jaræœ¬åœ°è¿è¡Œï¼Œè¿™ä¸€åˆ‡å–å†³äºä½ çš„éœ€æ±‚ï¼ï¼ï¼\n7. æ–°å»ºä¸€ä¸ªvueé¡¹ç›® ä½ çš„å‰ç«¯å¯èƒ½æ˜¯é€šè¿‡vueå®ç°å‰åç«¯åˆ†ç¦»çš„ï¼Œé‚£ä¹ˆä½ è‚¯å®šä¹Ÿå­˜åœ¨å¯¹vueç¼–è¯‘æ„å»ºçš„éœ€æ±‚ã€‚\n\rè¿™é‡Œå¤§éƒ¨åˆ†é…ç½®å’Œç¬¬5å°èŠ‚æ˜¯ä¸€æ ·çš„ï¼Œä¸å†èµ˜è¿°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š\n\rä¸Šå›¾ä¸­commandçš„å«ä¹‰æ˜¯: 1. æ„å»ºé¡¹ç›® 2. è¿è¡Œé¡¹ç›® 3. åˆ¶ä½œé•œåƒ 4ï¼Œæ¨é€é•œåƒåˆ°ä»“åº“ã€‚åŒç¬¬5èŠ‚çš„mavené¡¹ç›®ä¸€æ ·ï¼Œéœ€è¦å“ªäº›æ­¥éª¤å–å†³äºä½ çš„éœ€æ±‚ã€‚\né€šè¿‡æœ¬æ–‡ï¼Œæ‚¨å·²ç»æŒæ¡äº†å½“å¼€å‘äººå‘˜æäº¤ä»£ç åˆ°githubä¹‹åï¼Œjenkinsè‡ªåŠ¨æ„å»ºé¡¹ç›®/è¿è¡Œé¡¹ç›®çš„æŒç»­é›†æˆæ–¹æ³•ã€‚\næœ¬ç³»åˆ—æ–‡ç« çš„jenkins+è…¾è®¯äº‘å®¹å™¨ä»“åº“+dockeræŒç»­éƒ¨ç½²\rå°†æ•™ä½ å°†æ„å»ºå¥½çš„é¡¹ç›®åˆ¶ä½œæˆdockeré•œåƒï¼Œå¹¶ç”±çœŸæ­£çš„åº”ç”¨æœåŠ¡å™¨å»è¿è¡Œé¡¹ç›®ï¼ŒçœŸæ­£å®ç°CI/CDï¼Œè§£æ”¾ç”Ÿäº§åŠ›ã€‚\njenkins+è…¾è®¯äº‘å®¹å™¨ä»“åº“+dockeræŒç»­éƒ¨ç½²\r æœ¬æ–‡æ˜¯jenkins+docker+è…¾è®¯äº‘å®¹å™¨ä»“åº“+githubæ­å»ºCI/CDç¯å¢ƒ\rçš„ç¬¬äºŒå­ç« èŠ‚ã€‚æ„åœ¨æ•™æ‚¨é€šè¿‡jenkins+è…¾è®¯äº‘å®¹å™¨ä»“åº“+dockeræ­å»ºæŒç»­éƒ¨ç½²ç¯å¢ƒï¼Œå¦‚æœæ‚¨è¿˜æ²¡æœ‰å®Œæˆwebhooks+jenkinsçš„é…ç½®ï¼Œè¯·å®Œæˆç¬¬ä¸€ç« èŠ‚çš„å­¦ä¹ github webhooks+jenkinsæ­å»ºæŒç»­é›†æˆç¯å¢ƒ\r\r1. å‡†å¤‡ åœ¨ä¸Šä¸€ä¸ªç« èŠ‚çš„åŸºç¡€ä¸Šï¼Œæ‚¨é¦–å…ˆè¦ï¼š\n jenkinsæ·»åŠ æ‚¨åº”ç”¨æœåŠ¡å™¨çš„ç™»é™†å‡­è¯ï¼ˆå‚ç…§github webhooks+jenkinsæ­å»ºæŒç»­é›†æˆç¯å¢ƒ\rç¬¬3å°èŠ‚ï¼‰ jenkinsæ·»åŠ æ‚¨åº”ç”¨æœåŠ¡å™¨çš„ssh sitesï¼ˆå‚ç…§github webhooks+jenkinsæ­å»ºæŒç»­é›†æˆç¯å¢ƒ\rç¬¬4å°èŠ‚ï¼‰ å¼€é€šè…¾è®¯äº‘å®¹å™¨æœåŠ¡ï¼ˆå…è´¹å¼€é€šé•œåƒä»“åº“åŸºæœ¬æ•™ç¨‹\rï¼‰ æœ¬ç« çš„é¡¹ç›®æºç æ¥è‡ªyshopæ„è±¡å•†åŸç³»ç»Ÿ\r  2. é¡¹ç›®å¢åŠ dockeré…ç½® 2.1 h5é¡¹ç›®æ–°å¢dockeré…ç½® æ–°å¢å¦‚ä¸‹3ä¸ªé…ç½®ï¼šæ„å»ºé•œåƒè„šæœ¬build-image.shã€é•œåƒå®šä¹‰Dockerfile-h5ã€æ¨é€åˆ°å®¹å™¨ä»“åº“è„šæœ¬push.sh \r[v_notice]æ–‡ç« æœ«å°¾è·å–é…ç½®æ–‡ä»¶ï¼[/v_notice]\n2.2 åå°ç®¡ç†å‰ç«¯é¡¹ç›®æ–°å¢dockeré…ç½® æ–°å¢å¦‚ä¸‹3ä¸ªé…ç½®ï¼š \r[v_notice]æ–‡ç« æœ«å°¾è·å–é…ç½®æ–‡ä»¶ï¼[/v_notice]\n2.3 åå°é¡¹ç›®æ–°å¢dockeré…ç½® æ–°å¢å¦‚ä¸‹10ä¸ªé…ç½®ï¼š \r[v_notice]æ–‡ç« æœ«å°¾è·å–é…ç½®æ–‡ä»¶ï¼[/v_notice]\n3. ä¿®æ”¹é¡¹ç›®é…ç½®æ–‡ä»¶ ä¿®æ”¹mysqlçš„åœ°å€ä¸ºâ€œdbâ€,redisçš„åœ°å€ä¸ºâ€œredisâ€,mysqlé“¾æ¥æ–°å¢ allowPublicKeyRetrieval=true\u0026amp;useSSL=falseå‚æ•° \r\r4. jenkinsé…ç½® å¦‚æœæ‚¨å·²ç»å®Œæˆäº†github webhooks+jenkinsæ­å»ºæŒç»­é›†æˆç¯å¢ƒ\rä¸­çš„é…ç½®ï¼Œé‚£æ‚¨åªéœ€è¦æ–°å¢ä¸€å°éƒ¨åˆ†é…ç½®å³å¯ã€‚\n4.1 æ–°å¢h5é¡¹ç›®çš„Execute shell script on remote host using ssh \r jenkinså®¿ä¸»æœºæ„å»ºé•œåƒå¹¶pushåˆ°å®¹å™¨ä»“åº“ sshåˆ°åº”ç”¨æœåŠ¡å™¨ä¸‹è½½é•œåƒå¹¶å¯åŠ¨é¡¹ç›®  4.2 æ–°å¢å‰ç«¯é¡¹ç›®çš„Execute shell script on remote host using ssh \r jenkinså®¿ä¸»æœºæ„å»ºé•œåƒå¹¶pushåˆ°å®¹å™¨ä»“åº“ sshåˆ°åº”ç”¨æœåŠ¡å™¨ä¸‹è½½é•œåƒå¹¶å¯åŠ¨é¡¹ç›®  4.3 æ–°å¢åå°é¡¹ç›®çš„Execute shell script on remote host using ssh \r jenkinså®¿ä¸»æœºæ„å»ºé•œåƒå¹¶pushåˆ°å®¹å™¨ä»“åº“ sshåˆ°åº”ç”¨æœåŠ¡å™¨ä¸‹è½½é•œåƒå¹¶å¯åŠ¨é¡¹ç›®  5. å¯åŠ¨ 5.1 ä¿®æ”¹docker-compose-env.ymlä¸­mysqlçš„å¯†ç  5.2 å¯åŠ¨é¡¹ç›® #å¯åŠ¨è¿è¡Œç¯å¢ƒ docker-compose -f docker-compose-env.yml up \u0026amp; #å»ºæ•°æ®åº“ cp ~/repository/yshop/sql/yshop2.0.sql /data/mysql/log docker exec -it mysql bash cd /var/log/mysql mysql -uroot -proot create database yshop; use yshop; source yshop2.0.sql exit; #å¯åŠ¨ system/api/h5/admin docker-compose -f docker-compose-app.yml up \u0026amp; 5.3 nginxé…ç½® å°†app.confæ–‡ä»¶æ”¾åˆ°/data/nginx/vhostç›®å½•\ndocker-compose restart -f docker-compose-env.yml nginx  æ³¨æ„âš ï¸ï¼š\néœ€è¦æ›¿æ¢server_nameæˆä½ è‡ªå·±åŸŸå é¡¹ç›®æºç ä¸­çš„apié»˜è®¤æ˜¯httpsçš„ï¼Œå¦‚æœä½ æ²¡æœ‰sslè¯ä¹¦ï¼Œæˆ–è€…å«Œéº»çƒ¦ï¼Œè¯·è‡ªè¡Œæ”¹æˆhttpã€‚\n è‡³æ­¤ï¼Œæ‚¨å·²ç»å®Œæˆå…¨éƒ¨é…ç½®ï¼Œæäº¤ä»£ç å³å¯è‡ªåŠ¨å®Œæˆæ„å»º/éƒ¨ç½²/è¿è¡Œï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨jenkinsä¸Šæ‰‹åŠ¨ç‚¹å‡»æ„å»ºã€‚\n6. é…ç½®æ–‡ä»¶ é…ç½®æ–‡ä»¶ä¸‹è½½ï¼š\nhttps://pan.baidu.com/s/1KQT3vRgYXby3FHPViejzhQ\ræå–ç ï¼šhrqs\n\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/cicd/jenkins+docker+%E8%85%BE%E8%AE%AF%E4%BA%91%E5%AE%B9%E5%99%A8%E4%BB%93%E5%BA%93+github%E6%90%AD%E5%BB%BAci_cd%E7%8E%AF%E5%A2%83/","series":null,"tags":["Jenkins","docker"],"title":"jenkins+docker+è…¾è®¯äº‘å®¹å™¨ä»“åº“+githubæ­å»ºCI/CDç¯å¢ƒ"},{"categories":["æŒç»­é›†æˆéƒ¨ç½²"],"content":"Jenkinsä½¿ç”¨ä½¿ç”¨æ³¨æ„äº‹é¡¹\n1. æ— æ³•é€šè¿‡execute shellå¯åŠ¨è¿›ç¨‹ è¿™æ˜¯å› ä¸ºJenkinsé»˜è®¤ä¼šåœ¨Buildç»“æŸåKillæ‰æ‰€æœ‰çš„è¡ç”Ÿè¿›ç¨‹ã€‚\nåœ¨æ‰§è¡Œshellå‰éœ€è¦è®¾ç½®BUILD_ID=dontKillMe\nBUILD_ID=dontKillMe cd /data/wwwroot/yxshop chmod +x ./*.sh nohup ./restart.sh \u0026gt;/data/wwwroot/yxshop/nohup.out 2\u0026gt;\u0026amp;1 \u0026amp; 2. githubå‘jenkins deliverå¤±è´¥ ä¸€å¼€å§‹å¡«å†™çš„Payload URLå½¢å¦‚ï¼Œ\nPayload URL = https://xxx.com/github-webhook\ræ— è®ºæ€ä¹ˆä¿®æ”¹å†redeliveréƒ½å¤±è´¥ï¼Œåæ¥ä¿®æ”¹ä¸ºå½¢å¦‚ï¼Œ\nPayload URL = https://xxx.com/github-webhook/\rä»…ä»…æ˜¯åœ¨åé¢åŠ äº†â€œ/â€ã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/cicd/jenkins%E4%BD%BF%E7%94%A8%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/","series":null,"tags":["Jenkins"],"title":"Jenkinsä½¿ç”¨ä½¿ç”¨æ³¨æ„äº‹é¡¹"},{"categories":["æŒç»­é›†æˆéƒ¨ç½²"],"content":"Jenkinså®‰è£…æ’ä»¶æé€Ÿ\nå›½å†…å®‰è£…Jenkinsæ’ä»¶ç¼“æ…¢ï¼Œè¿™æ˜¯æˆ‘è§åˆ°æœ€å®Œç¾çš„è§£å†³æ–¹æ¡ˆã€‚ é€šè¿‡ã€æ’ä»¶\u0026ndash;\u0026gt;é«˜çº§\u0026ndash;\u0026gt;æ›´æ–°ç½‘ç«™ã€‘æ›¿æ¢æˆæ¸…åçš„æ•°æ®æºï¼ˆhttps://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.jsonï¼‰å¹¶ä¸å¥½ä½¿\néœ€è¦æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ“ä½œï¼š\nè¿›å…¥åˆ°å·¥ä½œç›®å½• $ cd {ä½ çš„Jenkinså·¥ä½œç›®å½•}/updates #è¿›å…¥æ›´æ–°é…ç½®ä½ç½® ä¿®æ”¹default.json æ–¹æ³•1 $ vim default.json æ›¿æ¢æ‰€æœ‰æ’ä»¶ä¸‹è½½çš„url\n:1,$s/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g æ›¿æ¢è¿æ¥æµ‹è¯•url\n:1,$s/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g è¿›å…¥vimå…ˆè¾“å…¥ï¼šç„¶åå†ç²˜è´´ä¸Šè¾¹çš„ï¼šåè¾¹çš„å‘½ä»¤ï¼Œæ³¨æ„ä¸è¦å†™ä¸¤ä¸ªå†’å·ï¼\nä¿®æ”¹å®Œæˆä¿å­˜é€€å‡º:wq\næ–¹æ³•2 ä½¿ç”¨sed\n$ sed -i \u0026#39;s/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g\u0026#39; default.json \u0026amp;\u0026amp; sed -i \u0026#39;s/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g\u0026#39; default.json è¿™æ˜¯ç›´æ¥ä¿®æ”¹çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚æœå‰è¾¹Jenkinsç”¨sudoå¯åŠ¨çš„è¯ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ä¸¤ä¸ªsedå‰å‡éœ€è¦åŠ ä¸Šsudo\né‡å¯Jenkinsï¼Œå®‰è£…æ’ä»¶è¯•è¯•ï¼Œç®€ç›´è¶…é€Ÿï¼ï¼\nhttps://www.cnblogs.com/hellxz/p/jenkins_install_plugins_faster.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/cicd/jenkins%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6%E6%8F%90%E9%80%9F/","series":null,"tags":["Jenkins"],"title":"Jenkinså®‰è£…æ’ä»¶æé€Ÿ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. ç¼–è¯‘å™¨ä¸è§£é‡Šå™¨ ä¸åšç‰¹åˆ«è¯´æ˜çš„è¯ï¼Œæˆ‘ä»¬è®²çš„ï¼Œ\nç¼–è¯‘å™¨ï¼šç¨‹åºè¿è¡Œå‰å°†å…¶ç¼–è¯‘æˆæœºå™¨ç çš„ç¨‹åº\nè§£é‡Šå™¨ï¼šç¨‹åºè¿ä½œä¸­é€è¡Œè§£é‡Šæºç å¾—åˆ°ç»“æœçš„ç¨‹åº\n ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè§£é‡Šå™¨ä¹Ÿæ˜¯ä¸€ä¸ªç¨‹åºï¼Œè¾“å…¥æºç ï¼Œè¾“å‡ºç»“æœï¼Œå¹¶æ²¡æœ‰æ˜¾ç¤ºçš„å°†æºç è½¬æ¢æˆæœºå™¨ç çš„è¿‡ç¨‹ è§£é‡Šå™¨ä¸ JIT\r æ— è®ºæ˜¯ç¼–è¯‘å™¨è¿˜æ˜¯è§£é‡Šå™¨ï¼Œä» æºç  åˆ°ç»“æœéƒ½éœ€è¦å°†æºç ç»è¿‡ï¼šè¯æ³•åˆ†æ -\u0026gt; è¯­æ³•åˆ†æ -\u0026gt; è¯­ä¹‰åˆ†æ å¤„ç†ï¼Œ\nä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ç¼–è¯‘å™¨çš„å¤„ç†æ­¥éª¤çœ‹èµ·æ¥ï¼š\nç¼–è¯‘æµç¨‹ï¼š\ræºç  [å­—ç¬¦æµ]\r- è¯æ³•åˆ†æ -\u0026gt; å•è¯ï¼ˆtokenï¼‰æµ\r- è¯­æ³•åˆ†æ -\u0026gt; è¯­æ³•æ ‘ / æŠ½è±¡è¯­æ³•æ ‘\r- è¯­ä¹‰åˆ†æ -\u0026gt; æ ‡æ³¨äº†å±æ€§çš„æŠ½è±¡è¯­æ³•æ ‘\r- ä»£ç ç”Ÿæˆ -\u0026gt; ç›®æ ‡ä»£ç \ræ‰§è¡Œæµç¨‹ï¼š\rç›®æ ‡ä»£ç \r- æ“ä½œç³»ç»Ÿ/ç¡¬ä»¶ -\u0026gt; æ‰§è¡Œç»“æœ\rç‹­ä¹‰çš„è§£é‡Šå™¨å¤„ç†æ­¥éª¤çœ‹èµ·æ¥ï¼š\nè§£é‡Šæ‰§è¡Œæµç¨‹ï¼š\ræºç  [å­—ç¬¦æµ]\r- éœ€è¦åšè¯æ³•åˆ†æ+è¯­æ³•åˆ†æ+ç±»å‹æ£€æŸ¥çš„å­—ç¬¦æµè§£é‡Šå™¨ -\u0026gt; æ‰§è¡Œç»“æœ\r ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè§£é‡Šå™¨çœŸæ­£çš„è¾“å…¥å¾€å¾€å¹¶ç›´æ¥æ˜¯æºç ï¼Œä½¿ç”¨è§£é‡Šå™¨å®ç°çš„ç¼–ç¨‹è¯­è¨€å®ç°é‡Œï¼Œé€šå¸¸ï¼š\n è‡³å°‘ä¼šåœ¨è§£é‡Šæ‰§è¡Œå‰åšå®Œè¯­æ³•åˆ†æï¼Œç„¶åé€šè¿‡æ ‘è§£é‡Šå™¨æ¥å®ç°è§£é‡Šæ‰§è¡Œï¼› å…¼é¡¾æ˜“äºå®ç°ã€è·¨å¹³å°ã€æ‰§è¡Œæ•ˆç‡è¿™å‡ ç‚¹ï¼Œä¼šé€‰æ‹©ä½¿ç”¨å­—èŠ‚ç è§£é‡Šå™¨å®ç°è§£é‡Šæ‰§è¡Œã€‚  ä¸ºä»€ä¹ˆå¤§å¤šæ•°è§£é‡Šå™¨éƒ½å°†ASTè½¬åŒ–æˆå­—èŠ‚ç å†ç”¨è™šæ‹Ÿæœºæ‰§è¡Œï¼Œè€Œä¸æ˜¯ç›´æ¥è§£é‡ŠASTï¼Ÿ\r 2. è§£é‡Šå‹è¯­è¨€ å¾ˆå¤šèµ„æ–™ä¼šè¯´ï¼ŒPythonã€Rubyã€JavaScriptéƒ½æ˜¯â€œè§£é‡Šå‹è¯­è¨€â€ï¼Œæ˜¯é€šè¿‡è§£é‡Šå™¨æ¥å®ç°çš„ã€‚è¿™ä¹ˆè¯´å…¶å®å¾ˆå®¹æ˜“å¼•èµ·è¯¯è§£ï¼šè¯­è¨€ä¸€èˆ¬åªä¼šå®šä¹‰å…¶æŠ½è±¡è¯­ä¹‰ï¼Œè€Œä¸ä¼šå¼ºåˆ¶æ€§è¦æ±‚é‡‡ç”¨æŸç§å®ç°æ–¹å¼ã€‚\nä¾‹å¦‚è¯´Cä¸€èˆ¬è¢«è®¤ä¸ºæ˜¯â€œç¼–è¯‘å‹è¯­è¨€â€ï¼Œä½†Cçš„è§£é‡Šå™¨ä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œä¾‹å¦‚Ch\rã€‚åŒæ ·ï¼ŒC++ä¹Ÿæœ‰è§£é‡Šå™¨ç‰ˆæœ¬çš„å®ç°ï¼Œä¾‹å¦‚Cint\rã€‚\nä¸€èˆ¬è¢«ç§°ä¸ºâ€œè§£é‡Šå‹è¯­è¨€â€çš„æ˜¯ä¸»æµå®ç°ä¸ºè§£é‡Šå™¨çš„è¯­è¨€ï¼Œä½†å¹¶ä¸æ˜¯è¯´å®ƒå°±æ— æ³•ç¼–è¯‘ã€‚ä¾‹å¦‚è¯´ç»å¸¸è¢«è®¤ä¸ºæ˜¯â€œè§£é‡Šå‹è¯­è¨€â€çš„Scheme\rå°±æœ‰å¥½å‡ ç§ç¼–è¯‘å™¨å®ç°ï¼Œå…¶ä¸­ç‡å…ˆæ”¯æŒR6RS\rè§„èŒƒçš„å¤§éƒ¨åˆ†å†…å®¹çš„æ˜¯Ikarus\rï¼Œæ”¯æŒåœ¨x86ä¸Šç¼–è¯‘Schemeï¼›å®ƒæœ€ç»ˆä¸æ˜¯ç”ŸæˆæŸç§è™šæ‹Ÿæœºçš„å­—èŠ‚ç ï¼Œè€Œæ˜¯ç›´æ¥ç”Ÿæˆx86æœºå™¨ç ã€‚\nè™šæ‹Ÿæœºéšè°ˆï¼ˆä¸€ï¼‰ï¼šè§£é‡Šå™¨ï¼Œæ ‘éå†è§£é‡Šå™¨ï¼ŒåŸºäºæ ˆä¸åŸºäºå¯„å­˜å™¨ï¼Œå¤§æ‚çƒ©\r3. JVMæ˜¯å¦JITå…¨ç¨‹ç¼–è¯‘ï¼Ÿ  HotSpot VMã€J9 VMï¼šä¸æ˜¯ï¼Œè¿™ä¸¤ä¸ªJVMé»˜è®¤ç”¨æ··åˆæ¨¡å¼æ‰§è¡Œå¼•æ“ï¼Œä»¥è§£é‡Šä¸ºåŸºç¡€ï¼Œç„¶åå¯¹çƒ­ç‚¹åšç¼–è¯‘ï¼›è¿™ä¸¤è€…åŒæ—¶è¿˜æ”¯æŒAOTç¼–è¯‘æ‰§è¡Œã€‚J9 VMå¯¹AOTç¼–è¯‘çš„æ”¯æŒæ—©å°±æœ‰äº†ï¼›HotSpot VMçš„å°†åœ¨JDK9çš„æŸä¸ªæ›´æ–°ç‰ˆä¸­å‘å¸ƒï¼Œè¯·å‚è€ƒJava Goes AOT\rï¼ˆæ‰“ä¸å¼€è¯·è‡ªå¤‡å·¥å…·â€¦ï¼‰ JRockit VMï¼šæ˜¯ï¼ŒJRockit VMæ²¡æœ‰è§£é‡Šå™¨ï¼Œåªèƒ½å¯¹æ‰€æœ‰Javaæ–¹æ³•éƒ½åšJITç¼–è¯‘ï¼› Jikes RVM\rã€Maxine VM\rã€Jato VM\rç­‰ï¼šæ˜¯ï¼Œè·ŸJRockitç±»ä¼¼ï¼Œåªæœ‰JITç¼–è¯‘å™¨è€Œæ²¡æœ‰è§£é‡Šå™¨ï¼Œå› è€Œåªèƒ½JITç¼–è¯‘æ‰§è¡Œï¼› Excelsior JET\rï¼šä¸æ˜¯ï¼Œå¯é…ç½®ä¸ºç”¨çº¯AOTç¼–è¯‘ï¼Œæˆ–è€…AOT+JITç¼–è¯‘æ‰§è¡Œã€‚  4. ä¸ºä»€ä¹ˆæœ‰äº›JVMä¼šé€‰æ‹©ä¸æ€»æ˜¯åšJITç¼–è¯‘ï¼Œè€Œæ˜¯é€‰æ‹©ç”¨è§£é‡Šå™¨+JITç¼–è¯‘å™¨çš„æ··åˆæ‰§è¡Œå¼•æ“ 1. ç¼–è¯‘çš„æ—¶é—´å¼€é”€ è§£é‡Šå™¨çš„æ‰§è¡Œï¼ŒæŠ½è±¡çš„çœ‹æ˜¯è¿™æ ·çš„ï¼š\nè¾“å…¥çš„ä»£ç  -\u0026gt; [ è§£é‡Šå™¨ è§£é‡Šæ‰§è¡Œ ] -\u0026gt; æ‰§è¡Œç»“æœ è€Œè¦JITç¼–è¯‘ç„¶åå†æ‰§è¡Œçš„è¯ï¼ŒæŠ½è±¡çš„çœ‹åˆ™æ˜¯ï¼š\nè¾“å…¥çš„ä»£ç  -\u0026gt; [ ç¼–è¯‘å™¨ ç¼–è¯‘ ] -\u0026gt; ç¼–è¯‘åçš„ä»£ç  -\u0026gt; [ æ‰§è¡Œ ] -\u0026gt; æ‰§è¡Œç»“æœ è¯´JITæ¯”è§£é‡Šå¿«ï¼Œå…¶å®è¯´çš„æ˜¯â€œæ‰§è¡Œç¼–è¯‘åçš„ä»£ç â€æ¯”â€œè§£é‡Šå™¨è§£é‡Šæ‰§è¡Œâ€è¦å¿«ï¼Œå¹¶ä¸æ˜¯è¯´â€œç¼–è¯‘â€è¿™ä¸ªåŠ¨ä½œæ¯”â€œè§£é‡Šâ€è¿™ä¸ªåŠ¨ä½œå¿«ã€‚\nç„¶è€Œè¿™JITç¼–è¯‘å†æ€ä¹ˆå¿«ï¼Œè‡³å°‘ä¹Ÿæ¯”è§£é‡Šæ‰§è¡Œä¸€æ¬¡ç•¥æ…¢ä¸€äº›ï¼Œè€Œè¦å¾—åˆ°æœ€åçš„æ‰§è¡Œç»“æœè¿˜å¾—å†ç»è¿‡ä¸€ä¸ªâ€œæ‰§è¡Œç¼–è¯‘åçš„ä»£ç â€çš„è¿‡ç¨‹ã€‚\næ‰€ä»¥ï¼Œå¯¹â€œåªæ‰§è¡Œä¸€æ¬¡â€çš„ä»£ç è€Œè¨€ï¼Œè§£é‡Šæ‰§è¡Œå…¶å®æ€»æ˜¯æ¯”JITç¼–è¯‘æ‰§è¡Œè¦å¿«ã€‚ æ€ä¹ˆç®—æ˜¯â€œåªæ‰§è¡Œä¸€æ¬¡çš„ä»£ç â€å‘¢ï¼Ÿç²—ç•¥è¯´ï¼Œä¸‹é¢ä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶å°±æ˜¯ä¸¥æ ¼çš„â€œåªæ‰§è¡Œä¸€æ¬¡â€\n åªè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¾‹å¦‚ç±»çš„åˆå§‹åŒ–å™¨ï¼ˆclass initializerï¼Œ()Vï¼‰ æ²¡æœ‰å¾ªç¯  å¯¹åªæ‰§è¡Œä¸€æ¬¡çš„ä»£ç åšJITç¼–è¯‘å†æ‰§è¡Œï¼Œå¯ä»¥è¯´æ˜¯å¾—ä¸å¿å¤±ã€‚ å¯¹åªæ‰§è¡Œå°‘é‡æ¬¡æ•°çš„ä»£ç ï¼ŒJITç¼–è¯‘å¸¦æ¥çš„æ‰§è¡Œé€Ÿåº¦çš„æå‡ä¹Ÿæœªå¿…èƒ½æŠµæ¶ˆæ‰æœ€åˆç¼–è¯‘å¸¦æ¥çš„å¼€é”€ã€‚ åªæœ‰å¯¹é¢‘ç¹æ‰§è¡Œçš„ä»£ç ï¼ŒJITç¼–è¯‘æ‰èƒ½ä¿è¯æœ‰æ­£é¢çš„æ”¶ç›Šã€‚\nå†µä¸”ï¼Œå¹¶ä¸æ˜¯è¯´JITç¼–è¯‘äº†çš„ä»£ç å°±ä¸€å®šä¼šæ¯”è§£é‡Šæ‰§è¡Œå¿«ã€‚åˆ‡ä¸å¯ç›²ç›®è®¤ä¸ºæœ‰äº†JITå°±å¯ä»¥é„™è§†è§£é‡Šå™¨äº†ï¼Œè¿˜æ˜¯å¾—çœ‹å®ç°ç»†èŠ‚å¦‚ä½•ã€‚ æœ‰ä¸ªå¾ˆç»å…¸çš„ä¾‹å­ï¼šLuaJIT 2é‡Œæœ‰ä¸€ä¸ªå®ç°å¾—éå¸¸ä¼˜åŒ–çš„è§£é‡Šå™¨ï¼Œå®ƒè§£é‡Šæ‰§è¡Œçš„é€Ÿåº¦ç”šè‡³æ¯”LuaJIT 1çš„JITç¼–è¯‘åçš„ä»£ç çš„é€Ÿåº¦è¿˜è¦å¿«ã€‚\n2. ç¼–è¯‘çš„ç©ºé—´å¼€é”€ ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼š\npublic static int foo() { return 42; } å…¶å­—èŠ‚ç å¤§å°åªæœ‰3å­—èŠ‚ï¼š\npublic static int foo(); Code: stack=1, locals=0, args_size=0 0: bipush 42 2: ireturn è€Œç”±Linux/x86-64ä¸Šçš„HotSpot VMçš„Server Compilerå°†å…¶ç¼–è¯‘ä¸ºæœºå™¨ç åï¼Œåˆ™è†¨èƒ€åˆ°äº†56å­—èŠ‚ï¼š\n# {method} \u0026#39;foo\u0026#39; \u0026#39;()I\u0026#39; in \u0026#39;XX\u0026#39; # [sp+0x20] (sp of caller) 0x00000001017b8200: sub $0x18,%rsp 0x00000001017b8207: mov %rbp,0x10(%rsp) ;*synchronization entry ; - XX::foo@-1 (line 3) 0x00000001017b820c: mov $0x2a,%eax 0x00000001017b8211: add $0x10,%rsp 0x00000001017b8215: pop %rbp 0x00000001017b8216: test %eax,-0x146021c(%rip) # 0x0000000100358000 ; {poll_return} 0x00000001017b821c: retq 0x00000001017b821d: hlt 0x00000001017b821e: hlt 0x00000001017b821f: hlt [Exception Handler] [Stub Code] 0x00000001017b8220: jmpq 0x00000001017b50a0 ; {no_reloc} [Deopt Handler Code] 0x00000001017b8225: callq 0x00000001017b822a 0x00000001017b822a: subq $0x5,(%rsp) 0x00000001017b822f: jmpq 0x000000010178eb00 ; {runtime_call} 0x00000001017b8234: hlt 0x00000001017b8235: hlt 0x00000001017b8236: hlt 0x00000001017b8237: hlt å¯¹ä¸€èˆ¬çš„Javaæ–¹æ³•è€Œè¨€ï¼Œç¼–è¯‘åä»£ç çš„å¤§å°ç›¸å¯¹äºå­—èŠ‚ç çš„å¤§å°ï¼Œè†¨èƒ€æ¯”è¾¾åˆ°10xæ˜¯å¾ˆæ­£å¸¸çš„ã€‚ä¸Šé¢çš„ä¾‹å­æ¯”è¾ƒæç«¯ä¸€äº›ï¼Œä½†è¿˜æ˜¯å¾ˆèƒ½åæ˜ ç°å®çŠ¶å†µçš„ã€‚\nåŒä¸Šé¢è¯´çš„æ—¶é—´å¼€é”€ä¸€æ ·ï¼Œè¿™é‡Œçš„ç©ºé—´å¼€é”€ä¹Ÿæ˜¯ï¼Œåªæœ‰å¯¹æ‰§è¡Œé¢‘ç¹çš„ä»£ç æ‰å€¼å¾—ç¼–è¯‘ï¼Œå¦‚æœæŠŠæ‰€æœ‰ä»£ç éƒ½ç¼–è¯‘åˆ™ä¼šæ˜¾è‘—å¢åŠ ä»£ç æ‰€å ç©ºé—´ï¼Œå¯¼è‡´â€œä»£ç çˆ†ç‚¸â€ï¼ˆcode size explosionï¼‰ã€‚\n3. ç¼–è¯‘æ—¶æœºå¯¹ä¼˜åŒ–çš„å½±å“ æœ‰äº›JITç¼–è¯‘å™¨éå¸¸ç®€å•ï¼ŒåŸºæœ¬ä¸Šä¸åšå•¥ä¼˜åŒ–ï¼Œä¹Ÿå€’ä¹Ÿæ²¡å•¥å½±å“ã€‚\nä½†ç°ä»£åšä¼˜åŒ–çš„JITç¼–è¯‘å™¨éƒ½éå¸¸æ³¨é‡ä½¿ç”¨profileä¿¡æ¯ï¼Œè€Œprofileæ˜¯éœ€è¦é€šè¿‡æ‰§è¡Œç”¨æˆ·ç¨‹åºæ¥è·å–çš„ã€‚\nè¿™æ ·ï¼Œç¼–è¯‘å¾—å¤ªæ—©çš„è¯ï¼Œå°±æ¥ä¸åŠæ”¶é›†è¶³å¤Ÿprofileä¿¡æ¯ï¼Œè¿›è€Œä¼šå½±å“ä¼˜åŒ–çš„æ•ˆæœï¼›è€Œç¼–è¯‘å¤ªè¿Ÿçš„è¯ï¼Œå³ä¾¿æ”¶é›†äº†å¾ˆå¤šé«˜è´¨é‡çš„profileï¼Œä½†å´ä¹Ÿå·²ç»ä»˜å‡ºäº†profileçš„é¢å¤–å¼€é”€ï¼Œç¼–è¯‘å‡ºæ¥çš„ä»£ç å†å¿«æˆ–è®¸ä¹Ÿå¼¥è¡¥ä¸è¿‡æ¥äº†ã€‚\nåœ¨è§£é‡Šå™¨é‡Œå®ç°æ”¶é›†profileçš„åŠŸèƒ½ï¼Œç­‰è§£é‡Šæ‰§è¡Œä¸€æ®µæ—¶é—´åå†è§¦å‘JITç¼–è¯‘ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆå¥½çš„å¹³è¡¡æ”¶é›†profileä¸ç¼–è¯‘ä¼˜åŒ–è¿™ä¸¤æ–¹é¢ã€‚\nå½“ç„¶ï¼Œæ”¶é›†profileä¹Ÿå¯ä»¥åœ¨JITç¼–è¯‘å™¨é‡Œåšï¼šä¸€å¼€å§‹å…ˆJITç¼–è¯‘ç”Ÿæˆæ”¶é›†profileçš„ç‰ˆæœ¬çš„ä»£ç ï¼Œç­‰æ”¶é›†äº†åˆ°è¶³å¤Ÿprofileåè§¦å‘é‡æ–°ç¼–è¯‘ï¼Œå†ç”Ÿæˆå‡ºä¼˜åŒ–çš„ã€ä¸å¸¦profileçš„ç‰ˆæœ¬ã€‚JRockitåŸºæœ¬ä¸Šå°±æ˜¯è¿™æ ·åšçš„ã€‚\nä¸ºä»€ä¹ˆ JVM ä¸ç”¨ JIT å…¨ç¨‹ç¼–è¯‘ï¼Ÿ\r5. Javaçš„æ‰§è¡Œè¿‡ç¨‹ Javaçš„æ‰§è¡Œè¿‡ç¨‹æ•´ä½“å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€æ­¥ç”±javacå°†æºç ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šè¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æï¼Œç¼–è¯‘åŸç†ä¸­è¿™éƒ¨åˆ†çš„ç¼–è¯‘ç§°ä¸ºå‰ç«¯ç¼–è¯‘ã€‚æ¥ä¸‹æ¥æ— éœ€ç¼–è¯‘ç›´æ¥é€æ¡å°†å­—èŠ‚ç è§£é‡Šæ‰§è¡Œï¼Œåœ¨è§£é‡Šæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œè™šæ‹ŸæœºåŒæ—¶å¯¹ç¨‹åºè¿è¡Œçš„ä¿¡æ¯è¿›è¡Œæ”¶é›†ï¼Œåœ¨è¿™äº›ä¿¡æ¯çš„åŸºç¡€ä¸Šï¼Œç¼–è¯‘å™¨ä¼šé€æ¸å‘æŒ¥ä½œç”¨ï¼Œå®ƒä¼šè¿›è¡Œåç«¯ç¼–è¯‘â€”â€”æŠŠå­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„ä»£ç éƒ½ä¼šè¢«ç¼–è¯‘ï¼Œåªæœ‰è¢«JVMè®¤å®šä¸ºçš„çƒ­ç‚¹ä»£ç ï¼Œæ‰å¯èƒ½è¢«ç¼–è¯‘ã€‚\næ€ä¹ˆæ ·æ‰ä¼šè¢«è®¤ä¸ºæ˜¯çƒ­ç‚¹ä»£ç å‘¢ï¼ŸJVMä¸­ä¼šè®¾ç½®ä¸€ä¸ªé˜ˆå€¼ï¼Œå½“æ–¹æ³•æˆ–è€…ä»£ç å—çš„åœ¨ä¸€å®šæ—¶é—´å†…çš„è°ƒç”¨æ¬¡æ•°è¶…è¿‡è¿™ä¸ªé˜ˆå€¼æ—¶å°±ä¼šè¢«ç¼–è¯‘ï¼Œå­˜å…¥codeCacheä¸­ã€‚å½“ä¸‹æ¬¡æ‰§è¡Œæ—¶ï¼Œå†é‡åˆ°è¿™æ®µä»£ç ï¼Œå°±ä¼šä»codeCacheä¸­è¯»å–æœºå™¨ç ï¼Œç›´æ¥æ‰§è¡Œï¼Œä»¥æ­¤æ¥æå‡ç¨‹åºè¿è¡Œçš„æ€§èƒ½ã€‚æ•´ä½“çš„æ‰§è¡Œè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n6. JVM Client æ¨¡å¼å’Œ Serveræ¨¡å¼çš„åŒºåˆ« é€šè¿‡ java -version å¯æŸ¥çœ‹ JVM æ‰€å¤„çš„æ¨¡å¼ï¼Œå¹¶å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œé‚£å®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ\nServerï¼š-Server æ¨¡å¼å¯åŠ¨æ—¶ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼Œä½†æ˜¯å¯åŠ¨ä¹‹åï¼Œæ€§èƒ½æ›´é«˜ï¼Œé€‚åˆè¿è¡ŒæœåŠ¡å™¨åå°ç¨‹åº\nClientï¼š-Client æ¨¡å¼å¯åŠ¨æ—¶ï¼Œé€Ÿåº¦è¾ƒå¿«ï¼Œå¯åŠ¨ä¹‹åä¸å¦‚ Serverï¼Œé€‚åˆç”¨äºæ¡Œé¢ç­‰æœ‰ç•Œé¢çš„ç¨‹åº\n7. å³æ—¶ç¼–è¯‘å™¨çš„åˆ†ç±»  Client Compiler - C1ç¼–è¯‘å™¨ Server Compiler - C2ç¼–è¯‘å™¨ã€Graal Compiler  ç›®å‰ä¸»æµçš„ HotSpot è™šæ‹Ÿæœºï¼ˆJDK1.7 åŠä¹‹å‰ç‰ˆæœ¬çš„è™šæ‹Ÿæœºï¼‰é»˜è®¤é‡‡ç”¨ä¸€ä¸ªè§£é‡Šå™¨å’Œå…¶ä¸­ä¸€ä¸ªç¼–è¯‘å™¨ç›´æ¥é…åˆçš„æ–¹å¼å·¥ä½œï¼Œç¨‹åºä½¿ç”¨å“ªä¸ªç¼–è¯‘å™¨ï¼Œå–å†³äºè™šæ‹Ÿæœºè¿è¡Œçš„æ¨¡å¼ï¼Œå°±æ˜¯æ–‡ç« å¼€å¤´æåˆ°çš„ä¸¤ç§æ¨¡å¼ã€‚\nåœ¨ HotSpot ä¸­ï¼Œè§£é‡Šå™¨å’Œ JIT å³æ—¶ç¼–è¯‘å™¨æ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œä»–ä»¬æ˜¯ JVM çš„ä¸¤ä¸ªç»„ä»¶ã€‚å¯¹äºä¸åŒç±»å‹çš„åº”ç”¨ç¨‹åºï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªèº«çš„ç‰¹ç‚¹å’Œéœ€æ±‚ï¼Œçµæ´»é€‰æ‹©æ˜¯åŸºäºè§£é‡Šå™¨è¿è¡Œè¿˜æ˜¯åŸºäº JIT ç¼–è¯‘å™¨è¿è¡Œã€‚HotSpot ä¸ºç”¨æˆ·æä¾›äº†å‡ ç§è¿è¡Œæ¨¡å¼ä¾›é€‰æ‹©ï¼Œå¯é€šè¿‡å‚æ•°è®¾å®šï¼Œåˆ†åˆ«ä¸ºï¼šè§£é‡Šæ¨¡å¼ã€ç¼–è¯‘æ¨¡å¼ã€æ··åˆæ¨¡å¼ï¼ŒHotSpot é»˜è®¤æ˜¯æ··åˆæ¨¡å¼ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¼–è¯‘æ¨¡å¼å¹¶ä¸æ˜¯å®Œå…¨é€šè¿‡ JIT è¿›è¡Œç¼–è¯‘ï¼Œåªæ˜¯ä¼˜å…ˆé‡‡ç”¨ç¼–è¯‘æ–¹å¼æ‰§è¡Œç¨‹åºï¼Œä½†æ˜¯è§£é‡Šå™¨ä»ç„¶è¦åœ¨ç¼–è¯‘æ— æ³•è¿›è¡Œçš„æƒ…å†µä¸‹ä»‹å…¥æ‰§è¡Œè¿‡ç¨‹ã€‚\n8. åˆ†å±‚ç¼–è¯‘ äº§ç”Ÿçš„åŸå› ï¼šç”±äºå³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æœ¬åœ°ä»£ç éœ€è¦å ç”¨ç¨‹åºè¿è¡Œæ—¶é—´ï¼Œè¦ç¼–è¯‘å‡ºä¼˜åŒ–ç¨‹åº¦æ›´é«˜çš„ä»£ç ï¼Œæ‰€èŠ±è´¹çš„æ—¶é—´å¯èƒ½æ›´é•¿ï¼›è€Œä¸”è¦æƒ³ç¼–è¯‘å‡ºä¼˜åŒ–ç¨‹åº¦æ›´é«˜çš„ä»£ç ï¼Œè§£é‡Šå™¨å¯èƒ½è¿˜è¦æ›¿ç¼–è¯‘å™¨æ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯ï¼Œè¿™å¯¹è§£é‡Šæ‰§è¡Œçš„é€Ÿåº¦ä¹Ÿæœ‰å½±å“ã€‚ä¸ºäº†åœ¨ç¨‹åºå¯åŠ¨å“åº”é€Ÿåº¦ä¸è¿è¡Œæ•ˆç‡ä¹‹é—´è¾¾åˆ°æœ€ä½³å¹³è¡¡ï¼ŒHotSpot è™šæ‹Ÿæœºå¯ç”¨åˆ†å±‚ç¼–è¯‘çš„ç­–ç•¥\nåˆ†å±‚ç¼–è¯‘æ ¹æ®ç¼–è¯‘å™¨ç¼–è¯‘ã€ä¼˜åŒ–çš„è§„æ¨¡ä¸è€—æ—¶ï¼Œåˆ’åˆ†å‡ºä¸åŒçš„ç¼–è¯‘å±‚æ¬¡ï¼š\n ç¬¬ 0 å±‚ï¼šç¨‹åºè§£é‡Šæ‰§è¡Œï¼Œè§£é‡Šå™¨ä¸å¼€å¯æ€§èƒ½ç›‘æ§åŠŸèƒ½ï¼Œå¯è§¦å‘ç¬¬ 1 å±‚ç¼–è¯‘ã€‚ ç¬¬ 1 å±‚ï¼šä¹Ÿç§°ä¸º C1 ç¼–è¯‘ï¼Œå°†å­—èŠ‚ç ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç ï¼Œè¿›è¡Œç®€å•ï¼Œå¯é çš„ä¼˜åŒ–ï¼Œå¦‚æœ‰å¿…è¦å°†åŠ å…¥æ€§èƒ½ç›‘æ§çš„é€»è¾‘ã€‚ ç¬¬ 2 å±‚ï¼ˆæˆ– 2 å±‚ä»¥ä¸Šï¼‰ï¼šä¹Ÿç§°ä¸º C2 ç¼–è¯‘ï¼Œä¹Ÿæ˜¯å°†å­—èŠ‚ç ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç ï¼Œä½†æ˜¯ä¼šå¯ç”¨ä¸€äº›ç¼–è¯‘è€—æ—¶è¾ƒé•¿çš„ä¼˜åŒ–ï¼Œç”šè‡³ä¼šæ ¹æ®æ€§èƒ½ç›‘æ§ä¿¡æ¯è¿›è¡Œä¸€äº›ä¸å¯é çš„æ¿€è¿›ä¼˜åŒ–ã€‚  å®æ–½åˆ†å±‚ç¼–è¯‘åï¼ŒClient Compiler å’Œ Server Compiler å°†ä¼šåŒæ—¶å·¥ä½œï¼Œè®¸å¤šä»£ç éƒ½å¯èƒ½ä¼šè¢«å¤šæ¬¡ç¼–è¯‘çœ‹ï¼Œç”¨ Client Compiler è·å–æ›´é«˜çš„ç¼–è¯‘é€Ÿåº¦ï¼Œç”¨ Server Compiler è·å–æ›´å¥½çš„ç¼–è¯‘è´¨é‡ï¼Œåœ¨è§£é‡Šæ‰§è¡Œçš„æ—¶å€™ä¹Ÿæ— é¡»å†æ‰¿æ‹…æ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯çš„ä»»åŠ¡\n9. çƒ­ç‚¹ä»£ç  1. çƒ­ç‚¹ä»£ç çš„åˆ†ç±»  è¢«å¤šæ¬¡è°ƒç”¨çš„æ–¹æ³•  ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨å¾—å¤šäº†ï¼Œæ–¹æ³•ä½“å†…ä»£ç æ‰§è¡Œçš„æ¬¡æ•°è‡ªç„¶å°±å¤šï¼Œæˆä¸ºâ€œçƒ­ç‚¹ä»£ç â€æ˜¯ç†æ‰€å½“ç„¶çš„ã€‚\n è¢«å¤šæ¬¡æ‰§è¡Œçš„å¾ªç¯ä½“  ä¸€ä¸ªæ–¹æ³•åªè¢«è°ƒç”¨è¿‡ä¸€æ¬¡æˆ–å°‘é‡çš„å‡ æ¬¡ï¼Œä½†æ˜¯æ–¹æ³•ä½“å†…éƒ¨å­˜åœ¨å¾ªç¯æ¬¡æ•°è¾ƒå¤šçš„å¾ªç¯ä½“ï¼Œè¿™æ ·å¾ªç¯ä½“çš„ä»£ç ä¹Ÿè¢«é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå› æ­¤è¿™äº›ä»£ç ä¹Ÿåº”è¯¥è®¤ä¸ºæ˜¯â€œçƒ­ç‚¹ä»£ç â€ã€‚\n2. å¦‚ä½•æ£€æµ‹çƒ­ç‚¹ä»£ç  åˆ¤æ–­ä¸€æ®µä»£ç æ˜¯å¦æ˜¯çƒ­ç‚¹ä»£ç ï¼Œæ˜¯å¦éœ€è¦è§¦å‘å³ä½¿ç¼–è¯‘ï¼Œè¿™æ ·çš„è¡Œä¸ºç§°ä¸ºçƒ­ç‚¹æ¢æµ‹ï¼Œçƒ­ç‚¹æ¢æµ‹å¹¶ä¸ä¸€å®šçŸ¥é“æ–¹æ³•å…·ä½“è¢«è°ƒç”¨äº†å¤šå°‘æ¬¡ï¼Œç›®å‰ä¸»è¦çš„çƒ­ç‚¹æ¢æµ‹åˆ¤å®šæ–¹å¼æœ‰ä¸¤ç§ï¼š\n åŸºäºé‡‡æ ·çš„çƒ­ç‚¹æ¢æµ‹ï¼šé‡‡ç”¨è¿™ç§æ–¹æ³•çš„è™šæ‹Ÿæœºä¼šå‘¨æœŸæ€§åœ°æ£€æŸ¥å„ä¸ªçº¿ç¨‹çš„æ ˆé¡¶å¦‚æœå‘ç°æŸä¸ªï¼ˆæˆ–æŸäº›ï¼‰æ–¹æ³•ç»å¸¸å‡ºç°åœ¨æ ˆé¡¶ï¼Œé‚£è¿™ä¸ªæ–¹æ³•å°±æ˜¯â€œçƒ­ç‚¹æ–¹æ³•â€   ä¼˜ç‚¹ï¼šå®ç°ç®€å•é«˜æ•ˆï¼Œå®¹æ˜“è·å–æ–¹æ³•è°ƒç”¨å…³ç³»ï¼ˆå°†è°ƒç”¨å †æ ˆå±•å¼€å³å¯ï¼‰\nç¼ºç‚¹ï¼šä¸ç²¾ç¡®ï¼Œå®¹æ˜“å› ä¸ºå› ä¸ºå—åˆ°çº¿ç¨‹é˜»å¡æˆ–åˆ«çš„å¤–ç•Œå› ç´ çš„å½±å“è€Œæ‰°ä¹±çƒ­ç‚¹æ¢æµ‹\n  åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ï¼šé‡‡ç”¨è¿™ç§æ–¹æ³•çš„è™šæ‹Ÿæœºä¼šä¸ºæ¯ä¸ªæ–¹æ³•ï¼ˆç”šè‡³æ˜¯ä»£ç å—ï¼‰å»ºç«‹è®¡æ•°å™¨ï¼Œç»Ÿè®¡æ–¹æ³•çš„æ‰§è¡Œæ¬¡æ•°ï¼Œå¦‚æœæ¬¡æ•°è¶…è¿‡ä¸€å®šçš„é˜ˆå€¼å°±è®¤ä¸ºå®ƒæ˜¯â€œçƒ­ç‚¹æ–¹æ³•â€   ä¼˜ç‚¹ï¼šç»Ÿè®¡ç»“æœç²¾ç¡®ä¸¥è°¨\nç¼ºç‚¹ï¼šå®ç°éº»çƒ¦ï¼Œéœ€è¦ä¸ºæ¯ä¸ªæ–¹æ³•å»ºç«‹å¹¶ç»´æŠ¤è®¡æ•°å™¨ï¼Œä¸èƒ½ç›´æ¥è·å–åˆ°æ–¹æ³•çš„è°ƒç”¨å…³ç³»\n HotSpotä½¿ç”¨ç¬¬äºŒç§ - åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹æ–¹æ³•ã€‚\nç¡®å®šäº†æ£€æµ‹çƒ­ç‚¹ä»£ç çš„æ–¹å¼ï¼Œå¦‚ä½•è®¡ç®—å…·ä½“çš„æ¬¡æ•°å‘¢ï¼Ÿ\n3. è®¡æ•°å™¨çš„ç§ç±»ï¼ˆä¸¤ç§å…±åŒåä½œï¼‰  æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼šè¿™ä¸ªè®¡æ•°å™¨ç”¨äºç»Ÿè®¡æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚é»˜è®¤é˜ˆå€¼åœ¨ Client æ¨¡å¼ä¸‹æ˜¯ 1500 æ¬¡ï¼Œåœ¨ Server æ¨¡å¼ä¸‹æ˜¯ 10000 æ¬¡ å›è¾¹è®¡æ•°å™¨ï¼šç»Ÿè®¡ä¸€ä¸ªæ–¹æ³•ä¸­å¾ªç¯ä½“ä»£ç æ‰§è¡Œçš„æ¬¡æ•°  äº†è§£äº†çƒ­ç‚¹ä»£ç å’Œè®¡æ•°å™¨æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿè¾¾åˆ°è®¡æ•°å™¨çš„é˜ˆå€¼ä¼šè§¦å‘åæ–‡è®²è§£çš„å³æ—¶ç¼–è¯‘ï¼Œä¹Ÿå°±æ˜¯è¯´å³æ—¶ç¼–è¯‘æ˜¯éœ€è¦è¾¾åˆ°æŸç§æ¡ä»¶æ‰ä¼šè§¦å‘çš„ã€‚\n10. ç¼–è¯‘ä¼˜åŒ–æŠ€æœ¯ 1. è¯­è¨€æ— å…³çš„ç»å…¸ä¼˜åŒ–æŠ€æœ¯ä¹‹ä¸€ï¼šå…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤ å¦‚æœä¸€ä¸ªè¡¨è¾¾å¼ E å·²ç»è®¡ç®—è¿‡äº†ï¼Œå¹¶ä¸”ä»å…ˆå‰çš„è®¡ç®—åˆ°ç°åœ¨ E ä¸­æ‰€æœ‰å˜é‡çš„å€¼éƒ½æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆ E çš„è¿™æ¬¡å‡ºç°å°±æˆä¸ºäº†å…¬å…±å­è¡¨è¾¾å¼ã€‚å¯¹äºè¿™ç§è¡¨è¾¾å¼ï¼Œæ²¡å¿…è¦èŠ±æ—¶é—´å†å¯¹å®ƒè¿›è¡Œè®¡ç®—ï¼Œåªéœ€è¦ç›´æ¥ä½¿ç”¨å‰é¢è®¡ç®—è¿‡çš„è¡¨è¾¾å¼ç»“æœä»£æ›¿ E å°±å¯ä»¥äº†ã€‚ä¾‹å­ï¼šint d = (c*b) * 12 + a + (a+ b * c) -\u0026gt; int d = E * 12 + a + (a+ E)\n2. è¯­è¨€ç›¸å…³çš„ç»å…¸ä¼˜åŒ–æŠ€æœ¯ä¹‹ä¸€ï¼šæ•°ç»„èŒƒå›´æ£€æŸ¥æ¶ˆé™¤ åœ¨ Java è¯­è¨€ä¸­è®¿é—®æ•°ç»„å…ƒç´ çš„æ—¶å€™ç³»ç»Ÿå°†ä¼šè‡ªåŠ¨è¿›è¡Œä¸Šä¸‹ç•Œçš„èŒƒå›´æ£€æŸ¥ï¼Œè¶…å‡ºè¾¹ç•Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å¯¹äºè™šæ‹Ÿæœºçš„æ‰§è¡Œå­ç³»ç»Ÿæ¥è¯´ï¼Œæ¯æ¬¡æ•°ç»„å…ƒç´ çš„è¯»å†™éƒ½å¸¦æœ‰ä¸€æ¬¡éšå«çš„æ¡ä»¶åˆ¤å®šæ“ä½œï¼Œå¯¹äºæ‹¥æœ‰å¤§é‡æ•°ç»„è®¿é—®çš„ç¨‹åºä»£ç ï¼Œè¿™æ— ç–‘æ˜¯ä¸€ç§æ€§èƒ½è´Ÿæ‹…ã€‚Java åœ¨ç¼–è¯‘æœŸæ ¹æ®æ•°æ®æµåˆ†æå¯ä»¥åˆ¤å®šèŒƒå›´è¿›è€Œæ¶ˆé™¤ä¸Šä¸‹ç•Œæ£€æŸ¥ï¼ŒèŠ‚çœå¤šæ¬¡çš„æ¡ä»¶åˆ¤æ–­æ“ä½œã€‚\n3. æœ€é‡è¦çš„ä¼˜åŒ–æŠ€æœ¯ä¹‹ä¸€ï¼šæ–¹æ³•å†…è” ç®€å•çš„ç†è§£ä¸ºæŠŠç›®æ ‡æ–¹æ³•çš„ä»£ç â€œå¤åˆ¶â€åˆ°å‘èµ·è°ƒç”¨çš„æ–¹æ³•ä¸­ï¼Œæ¶ˆé™¤ä¸€äº›æ— ç”¨çš„ä»£ç ã€‚\næ–¹æ³•å†…è”ï¼Œæ˜¯æŒ‡åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­é‡åˆ°æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå°†ç›®æ ‡æ–¹æ³•çš„æ–¹æ³•ä½“çº³å…¥ç¼–è¯‘èŒƒå›´ä¹‹ä¸­ï¼Œå¹¶å–ä»£åŸæ–¹æ³•è°ƒç”¨çš„ä¼˜åŒ–æ‰‹æ®µã€‚JITå¤§éƒ¨åˆ†çš„ä¼˜åŒ–éƒ½æ˜¯åœ¨å†…è”çš„åŸºç¡€ä¸Šè¿›è¡Œçš„ï¼Œæ–¹æ³•å†…è”æ˜¯å³æ—¶ç¼–è¯‘å™¨ä¸­éå¸¸é‡è¦çš„ä¸€ç¯ã€‚\nJavaæœåŠ¡ä¸­å­˜åœ¨å¤§é‡getter/setteræ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰æ–¹æ³•å†…è”ï¼Œåœ¨è°ƒç”¨getter/setteræ—¶ï¼Œç¨‹åºæ‰§è¡Œæ—¶éœ€è¦ä¿å­˜å½“å‰æ–¹æ³•çš„æ‰§è¡Œä½ç½®ï¼Œåˆ›å»ºå¹¶å‹å…¥ç”¨äºgetter/setterçš„æ ˆå¸§ã€è®¿é—®å­—æ®µã€å¼¹å‡ºæ ˆå¸§ï¼Œæœ€åå†æ¢å¤å½“å‰æ–¹æ³•çš„æ‰§è¡Œã€‚å†…è”äº†å¯¹ getter/setterçš„æ–¹æ³•è°ƒç”¨åï¼Œä¸Šè¿°æ“ä½œä»…å‰©å­—æ®µè®¿é—®ã€‚åœ¨C2ç¼–è¯‘å™¨ ä¸­ï¼Œæ–¹æ³•å†…è”åœ¨è§£æå­—èŠ‚ç çš„è¿‡ç¨‹ä¸­å®Œæˆã€‚å½“é‡åˆ°æ–¹æ³•è°ƒç”¨å­—èŠ‚ç æ—¶ï¼Œç¼–è¯‘å™¨å°†æ ¹æ®ä¸€äº›é˜ˆå€¼å‚æ•°å†³å®šæ˜¯å¦éœ€è¦å†…è”å½“å‰æ–¹æ³•çš„è°ƒç”¨ã€‚å¦‚æœéœ€è¦å†…è”ï¼Œåˆ™å¼€å§‹è§£æç›®æ ‡æ–¹æ³•çš„å­—èŠ‚ç ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ï¼ˆæ¥æºäºç½‘ç»œï¼‰ï¼š\næ–¹æ³•å†…è”çš„è¿‡ç¨‹\npublic static boolean flag = true; public static int value0 = 0; public static int value1 = 1; public static int foo(int value) { int result = bar(flag); if (result != 0) { return result; } else { return value; } } public static int bar(boolean flag) { return flag ? value0 : value1; } baræ–¹æ³•çš„IRå›¾ï¼š\nå†…è”åçš„IRå›¾ï¼š\n4. æœ€å‰æ²¿çš„ä¼˜åŒ–æŠ€æœ¯ä¹‹ä¸€ï¼šé€ƒé€¸åˆ†æ é€ƒé€¸åˆ†æçš„åŸºæœ¬è¡Œä¸ºå°±æ˜¯åˆ†æå¯¹è±¡åŠ¨æ€ä½œç”¨åŸŸï¼šå½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­æ¯å®šä¹‰åï¼Œå®ƒå¯èƒ½è¢«å¤–éƒ¨æ–¹æ³•æ‰€å¼•ç”¨ï¼Œä¾‹å¦‚ä½œä¸ºè°ƒç”¨å‚æ•°ä¼ é€’åˆ°å…¶ä»–æ–¹æ³•ä¸­ï¼Œç§°ä¸ºæ–¹æ³•é€ƒé€¸ã€‚ç”šè‡³å¯èƒ½è¢«å¤–éƒ¨çº¿ç¨‹è®¿é—®åˆ°ï¼Œè­¬å¦‚èµ‹å€¼ç»™ç±»å˜é‡æˆ–å¯ä»¥åœ¨å…¶ä»–çº¿ç¨‹ä¸­è®¿é—®çš„å®ä¾‹å˜é‡ï¼Œç§°ä¸ºçº¿ç¨‹é€ƒé€¸ã€‚\nå¦‚æœèƒ½è¯æ˜ä¸€ä¸ªå¯¹è±¡ä¸ä¼šé€ƒé€¸åˆ°æ–¹æ³•æˆ–çº¿ç¨‹ä¹‹å¤–ï¼Œä¹Ÿå°±æ˜¯åˆ«çš„æ–¹æ³•æˆ–çº¿ç¨‹æ— æ³•é€šè¿‡ä»»ä½•é€”å¾„è®¿é—®åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œåˆ™å¯ä»¥ä¸ºè¿™ä¸ªå˜é‡è¿›è¡Œä¸€äº›é«˜æ•ˆçš„ä¼˜åŒ–ï¼š\n æ ˆä¸Šåˆ†é…ï¼šå°†ä¸ä¼šé€ƒé€¸çš„å±€éƒ¨å¯¹è±¡åˆ†é…åˆ°æ ˆä¸Šï¼Œé‚£å¯¹è±¡å°±ä¼šéšç€æ–¹æ³•çš„ç»“æŸè€Œè‡ªåŠ¨é”€æ¯ï¼Œå‡å°‘åƒåœ¾æ”¶é›†ç³»ç»Ÿçš„å‹åŠ›ã€‚ åŒæ­¥æ¶ˆé™¤ï¼šå¦‚æœè¯¥å˜é‡ä¸ä¼šå‘ç”Ÿçº¿ç¨‹é€ƒé€¸ï¼Œä¹Ÿå°±æ˜¯æ— æ³•è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ï¼Œé‚£ä¹ˆå¯¹è¿™ä¸ªå˜é‡çš„è¯»å†™å°±ä¸å­˜åœ¨ç«äº‰ï¼Œå¯ä»¥å°†åŒæ­¥æªæ–½æ¶ˆé™¤æ‰ï¼ˆåŒæ­¥æ˜¯éœ€è¦ä»˜å‡ºä»£ä»·çš„ï¼‰ æ ‡é‡æ›¿æ¢ï¼šæ ‡é‡æ˜¯æŒ‡æ— æ³•åœ¨åˆ†è§£çš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚åŸå§‹æ•°æ®ç±»å‹ä»¥åŠreferenceç±»å‹ã€‚è€Œèšåˆé‡å°±æ˜¯å¯ç»§ç»­åˆ†è§£çš„ï¼Œæ¯”å¦‚ Java ä¸­çš„å¯¹è±¡ã€‚æ ‡é‡æ›¿æ¢å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–éƒ¨è®¿é—®ï¼Œå¹¶ä¸”å¯¹è±¡å¯ä»¥è¢«æ‹†æ•£çš„è¯ï¼ŒçœŸæ­£æ‰§è¡Œæ—¶å¯èƒ½ä¸åˆ›å»ºè¿™ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥åˆ›å»ºå®ƒçš„è‹¥å¹²ä¸ªè¢«è¿™ä¸ªæ–¹æ³•ä½¿ç”¨åˆ°çš„æˆå‘˜å˜é‡æ¥ä»£æ›¿ã€‚è¿™ç§æ–¹å¼ä¸ä»…å¯ä»¥è®©å¯¹è±¡çš„æˆå‘˜å˜é‡åœ¨æ ˆä¸Šåˆ†é…å’Œè¯»å†™ï¼Œè¿˜å¯ä»¥ä¸ºååç»­è¿›ä¸€æ­¥çš„ä¼˜åŒ–æ‰‹æ®µåˆ›å»ºæ¡ä»¶ã€‚  ä¸‹é¢æ˜¯ä¸€ä¸ªæ ‡é‡æ›¿æ¢çš„ä¾‹å­ï¼š\npublic class Example{ @AllArgsConstructor class Cat{ int age; int weight; } public static void example(){ Cat cat = new Cat(1,10); addAgeAndWeight(cat.age,Cat.weight); } } ç»è¿‡é€ƒé€¸åˆ†æï¼Œcatå¯¹è±¡æœªé€ƒé€¸å‡ºexample()çš„è°ƒç”¨ï¼Œå› æ­¤å¯ä»¥å¯¹èšåˆé‡catè¿›è¡Œåˆ†è§£ï¼Œå¾—åˆ°ä¸¤ä¸ªæ ‡é‡ageå’Œweightï¼Œè¿›è¡Œæ ‡é‡æ›¿æ¢åçš„ä¼ªä»£ç ï¼š\npublic class Example{ @AllArgsConstructor class Cat{ int age; int weight; } public static void example(){ int age = 1; int weight = 10; addAgeAndWeight(age,weight); } } 5. Loop Transformations C2ç¼–è¯‘å™¨åœ¨æ„å»ºIdeal Graphåä¼šè¿›è¡Œå¾ˆå¤šçš„å…¨å±€ä¼˜åŒ–ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å¯¹å¾ªç¯çš„è½¬æ¢ï¼Œæœ€é‡è¦çš„ä¸¤ç§è½¬æ¢å°±æ˜¯å¾ªç¯å±•å¼€å’Œå¾ªç¯åˆ†ç¦»ã€‚\n1. å¾ªç¯å±•å¼€ å¾ªç¯å±•å¼€æ˜¯ä¸€ç§å¾ªç¯è½¬æ¢æŠ€æœ¯ï¼Œå®ƒè¯•å›¾ä»¥ç‰ºç‰²ç¨‹åºäºŒè¿›åˆ¶ç å¤§å°ä¸ºä»£ä»·æ¥ä¼˜åŒ–ç¨‹åºçš„æ‰§è¡Œé€Ÿåº¦ï¼Œæ˜¯ä¸€ç§ç”¨ç©ºé—´æ¢æ—¶é—´çš„ä¼˜åŒ–æ‰‹æ®µã€‚\nå¾ªç¯å±•å¼€é€šè¿‡å‡å°‘æˆ–æ¶ˆé™¤æ§åˆ¶ç¨‹åºå¾ªç¯çš„æŒ‡ä»¤ï¼Œæ¥å‡å°‘è®¡ç®—å¼€é”€ï¼Œè¿™ç§å¼€é”€åŒ…æ‹¬å¢åŠ æŒ‡å‘æ•°ç»„ä¸­ä¸‹ä¸€ä¸ªç´¢å¼•æˆ–è€…æŒ‡ä»¤çš„æŒ‡é’ˆç®—æ•°ç­‰ã€‚å¦‚æœç¼–è¯‘å™¨å¯ä»¥æå‰è®¡ç®—è¿™äº›ç´¢å¼•ï¼Œå¹¶ä¸”æ„å»ºåˆ°æœºå™¨ä»£ç æŒ‡ä»¤ä¸­ï¼Œé‚£ä¹ˆç¨‹åºè¿è¡Œæ—¶å°±å¯ä»¥ä¸å¿…è¿›è¡Œè¿™ç§è®¡ç®—ã€‚ä¹Ÿå°±æ˜¯è¯´æœ‰äº›å¾ªç¯å¯ä»¥å†™æˆä¸€äº›é‡å¤ç‹¬ç«‹çš„ä»£ç ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªå¾ªç¯ï¼š\npublic void loopRolling(){ for(int i = 0;i\u0026lt;200;i++){ delete(i); } } ä¸Šé¢çš„ä»£ç éœ€è¦å¾ªç¯åˆ é™¤200æ¬¡ï¼Œé€šè¿‡å¾ªç¯å±•å¼€å¯ä»¥å¾—åˆ°ä¸‹é¢è¿™æ®µä»£ç ï¼š\npublic void loopRolling(){ for(int i = 0;i\u0026lt;200;i+=5){ delete(i); delete(i+1); delete(i+2); delete(i+3); delete(i+4); } } è¿™æ ·å±•å¼€å°±å¯ä»¥å‡å°‘å¾ªç¯çš„æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å†…çš„è®¡ç®—ä¹Ÿå¯ä»¥åˆ©ç”¨CPUçš„æµæ°´çº¿æå‡æ•ˆç‡ã€‚å½“ç„¶è¿™åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå®é™…è¿›è¡Œå±•å¼€æ—¶ï¼ŒJVMä¼šå»è¯„ä¼°å±•å¼€å¸¦æ¥çš„æ”¶ç›Šï¼Œå†å†³å®šæ˜¯å¦è¿›è¡Œå±•å¼€ã€‚\n2. å¾ªç¯åˆ†ç¦» å¾ªç¯åˆ†ç¦»ä¹Ÿæ˜¯å¾ªç¯è½¬æ¢çš„ä¸€ç§æ‰‹æ®µã€‚å®ƒæŠŠå¾ªç¯ä¸­ä¸€æ¬¡æˆ–å¤šæ¬¡çš„ç‰¹æ®Šè¿­ä»£åˆ†ç¦»å‡ºæ¥ï¼Œåœ¨å¾ªç¯å¤–æ‰§è¡Œã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢è¿™æ®µä»£ç ï¼š\nint a = 10; for(int i = 0;i\u0026lt;10;i++){ b[i] = x[i] + x[a]; a = i; } å¯ä»¥çœ‹å‡ºè¿™æ®µä»£ç é™¤äº†ç¬¬ä¸€æ¬¡å¾ªç¯a = 10ä»¥å¤–ï¼Œå…¶ä»–çš„æƒ…å†µaéƒ½ç­‰äºi-1ã€‚æ‰€ä»¥å¯ä»¥æŠŠç‰¹æ®Šæƒ…å†µåˆ†ç¦»å‡ºå»ï¼Œå˜æˆä¸‹é¢è¿™æ®µä»£ç ï¼š\nb[0] = x[0] + 10; for(int i = 1;i\u0026lt;10;i++){ b[i] = x[i] + x[i-1]; } è¿™ç§ç­‰æ•ˆçš„è½¬æ¢æ¶ˆé™¤äº†åœ¨å¾ªç¯ä¸­å¯¹aå˜é‡çš„éœ€æ±‚ï¼Œä»è€Œå‡å°‘äº†å¼€é”€ã€‚\n6. çª¥å­”ä¼˜åŒ–ä¸å¯„å­˜å™¨åˆ†é… å‰æ–‡æåˆ°çš„çª¥å­”ä¼˜åŒ–æ˜¯ä¼˜åŒ–çš„æœ€åä¸€æ­¥ï¼Œè¿™ä¹‹åå°±ä¼šç¨‹åºå°±ä¼šè½¬æ¢æˆæœºå™¨ç ï¼Œçª¥å­”ä¼˜åŒ–å°±æ˜¯å°†ç¼–è¯‘å™¨æ‰€ç”Ÿæˆçš„ä¸­é—´ä»£ç ï¼ˆæˆ–ç›®æ ‡ä»£ç ï¼‰ä¸­ç›¸é‚»æŒ‡ä»¤ï¼Œå°†å…¶ä¸­çš„æŸäº›ç»„åˆæ›¿æ¢ä¸ºæ•ˆç‡æ›´é«˜çš„æŒ‡ä»¤ç»„ï¼Œå¸¸è§çš„æ¯”å¦‚å¼ºåº¦å‰Šå‡ã€å¸¸æ•°åˆå¹¶ç­‰ï¼Œçœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜¯ä¸€ä¸ªå¼ºåº¦å‰Šå‡çš„ä¾‹å­ï¼š\nå¼ºåº¦å‰Šå‡\ny1=x1*3 ç»è¿‡å¼ºåº¦å‰Šå‡åå¾—åˆ° y1=(x1\u0026lt;\u0026lt;1)+x1\rç¼–è¯‘å™¨ä½¿ç”¨ç§»ä½å’ŒåŠ æ³•å‰Šå‡ä¹˜æ³•çš„å¼ºåº¦ï¼Œä½¿ç”¨æ›´é«˜æ•ˆç‡çš„æŒ‡ä»¤ç»„ã€‚\nå¯„å­˜å™¨åˆ†é…ä¹Ÿæ˜¯ä¸€ç§ç¼–è¯‘çš„ä¼˜åŒ–æ‰‹æ®µï¼Œåœ¨C2ç¼–è¯‘å™¨ä¸­æ™®éçš„ä½¿ç”¨ã€‚å®ƒæ˜¯é€šè¿‡æŠŠé¢‘ç¹ä½¿ç”¨çš„å˜é‡ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­ï¼ŒCPUè®¿é—®å¯„å­˜å™¨çš„é€Ÿåº¦æ¯”å†…å­˜å¿«å¾—å¤šï¼Œå¯ä»¥æå‡ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ã€‚\nå¯„å­˜å™¨åˆ†é…å’Œçª¥å­”ä¼˜åŒ–æ˜¯ç¨‹åºä¼˜åŒ–çš„æœ€åä¸€æ­¥ã€‚ç»è¿‡å¯„å­˜å™¨åˆ†é…å’Œçª¥å­”ä¼˜åŒ–ä¹‹åï¼Œç¨‹åºå°±ä¼šè¢«è½¬æ¢æˆæœºå™¨ç ä¿å­˜åœ¨codeCacheä¸­ã€‚\nå‚è€ƒï¼š åŸºæœ¬åŠŸ | Javaå³æ—¶ç¼–è¯‘å™¨åŸç†è§£æåŠå®è·µ\rä½ äº†è§£JVMä¸­çš„ JIT å³æ—¶ç¼–è¯‘åŠä¼˜åŒ–æŠ€æœ¯å—ï¼Ÿ\rè™šæ‹Ÿæœºéšè°ˆï¼ˆä¸€ï¼‰ï¼šè§£é‡Šå™¨ï¼Œæ ‘éå†è§£é‡Šå™¨ï¼ŒåŸºäºæ ˆä¸åŸºäºå¯„å­˜å™¨ï¼Œå¤§æ‚çƒ©\rJavaä¸ºä»€ä¹ˆè§£é‡Šæ‰§è¡Œæ—¶ä¸ç›´æ¥è§£é‡Šæºç ï¼Ÿ\rä¸ºä»€ä¹ˆå¤§å¤šæ•°è§£é‡Šå™¨éƒ½å°†ASTè½¬åŒ–æˆå­—èŠ‚ç å†ç”¨è™šæ‹Ÿæœºæ‰§è¡Œï¼Œè€Œä¸æ˜¯ç›´æ¥è§£é‡ŠASTï¼Ÿ\rä¸ºä»€ä¹ˆ JVM ä¸ç”¨ JIT å…¨ç¨‹ç¼–è¯‘ï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/jit%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91/","series":["Manual"],"tags":["Java"],"title":"JITå³æ—¶ç¼–è¯‘"},{"categories":["äº‘åŸç”Ÿ"],"content":"k8séƒ¨ç½²åº”ç”¨(å‰ç«¯é™æ€)\n0. å‡†å¤‡æ¡ä»¶  éƒ¨ç½²å¥½äº†k8sé›†ç¾¤ï¼Œéƒ¨ç½²å¯ä»¥å‚è€ƒKubernetes: ä»é›¶æ­å»ºK8S\r     åç§° æ•°é‡ IP å¤‡æ³¨     master 1 172.17.0.14 æ“ä½œç³»ç»Ÿ: Linux(centos7, å…¶å®ƒæ“ä½œç³»ç»Ÿä¹Ÿå¯, å®‰è£…è¿‡ç¨‹ç±»ä¼¼, å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£) æœºå™¨é…ç½®: 4C8G   node1 1 172.18.0.7 åŒä¸Š   node2 1 172.19.0.5 åŒä¸Š     åº”ç”¨å·²ç»å®¹å™¨åŒ–ï¼Œå¹¶ä¸Šä¼ åˆ°äº†è¿œç¨‹ä»“åº“ï¼Œç¬”è€…æ˜¯è…¾è®¯äº‘å®¹å™¨ä»“åº“ï¼š   ç†è§£k8såŸºç¡€æ¦‚å¿µï¼Œå¯ä»¥å‚è€ƒKubernetes: åŸºç¡€æ¦‚å¿µä»‹ç»\r  1. æ§åˆ¶å™¨ç®¡ç†Pod 1.1 ç”Ÿæˆdeploymenté…ç½®æ–‡ä»¶ kubectl create deployment yshop-h5 --image=ccr.ccs.tencentyun.com/yshop/h5 --dry-run -o yaml \u0026gt; yshop-h5.yaml è¿™ä¸ªæ—¶å€™k8sè¿˜ä¸èƒ½æ‹‰å–é•œåƒï¼Œéœ€è¦ç”Ÿæˆæ‹‰å–é•œåƒçš„å¯†é’¥ã€‚\n1.2 ç”Ÿæˆæ‹‰å–é•œåƒçš„å¯†é’¥ kubectl create secret docker-registry registry-secret-tencent --docker-server=ccr.ccs.tencentyun.com --docker-username=è…¾è®¯äº‘è´¦æˆ·ID --docker-password=è…¾è®¯äº‘å®¹å™¨ä»“åº“å¯†ç  \u0026ndash;docker-server: ä»“åº“åœ°å€ \u0026ndash;docker-username: ä»“åº“ç™»é™†è´¦å· \u0026ndash;docker-password: ä»“åº“ç™»é™†å¯†ç  \u0026ndash;docker-email: é‚®ä»¶åœ°å€(é€‰å¡«) -n å‘½åç©ºé—´(é€‰å¡«)\nå¯ä»¥è¿è¡Œï¼škubectl get secret registry-secret-tencent --output=yaml æŸ¥çœ‹ç”Ÿæˆçš„å¯†é’¥\n1.3 é…ç½®å¯†é’¥ vi yshop-h5.yaml 1.4 è¿è¡Œdeployment kubectl apply -f yshop-h5.yaml æŸ¥çœ‹å¯åŠ¨çš„podsï¼škubectl get pods\næŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼škubectl logs yshop-h5-cd4dc8c5b-562g5\n2. æš´éœ²åº”ç”¨ 2.1 ç”Ÿæˆserviceé…ç½®æ–‡ä»¶ kubectl expose deployment yshop-h5 --port=80 --target-port=80 --type=NodePort -o yaml --dry-run \u0026gt; yshop-h5-svc.yaml yshop-h5 æŒ‡å®šåç§°\n\u0026ndash;port æŒ‡å®šé›†ç¾¤å†…éƒ¨è®¿é—®çš„ç«¯å£\n\u0026ndash;target-port æŒ‡å®šå®¹å™¨å†…è·‘æœåŠ¡çš„ç«¯å£\n\u0026ndash;type=NodePort æŒ‡å®šç±»å‹ é›†ç¾¤å¤–éƒ¨è®¿é—®\n2.2 è¿è¡Œservice kubectl apply -f yshop-h5-svc.yaml æŸ¥çœ‹podså’Œsvcï¼škubectl get pods,svc\næŸ¥çœ‹podsåˆ†å¸ƒçš„èŠ‚ç‚¹ï¼š kubectl get pods -o wide\n3. è®¿é—®åº”ç”¨ 3.1 å¤–éƒ¨è®¿é—® http://{masterçš„å…¬ç½‘ip/node1çš„å…¬ç½‘ip/node2çš„å…¬ç½‘ip}:32585 3.2 å†…éƒ¨è®¿é—® é€šè¿‡service ip:\ncurl http://10.108.253.217 é€šè¿‡èŠ‚ç‚¹ip:\ncurl http://{masterçš„å†…ç½‘ip/node1çš„å†…ç½‘ip/node2çš„å†…ç½‘ip}:32585 ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/k8s%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8%E5%89%8D%E7%AB%AF%E9%9D%99%E6%80%81/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"k8séƒ¨ç½²åº”ç”¨(å‰ç«¯é™æ€)"},{"categories":["å…¶ä»–"],"content":"Linuxé…ç½®gitè´¦å·å¯†ç \n1. åœ¨~/ä¸‹ï¼Œ touchåˆ›å»ºæ–‡ä»¶ .git-credentials, ç”¨vimç¼–è¾‘æ­¤æ–‡ä»¶ touch .git-credentials vim .git-credentials åœ¨é‡Œé¢æŒ‰â€œiâ€ç„¶åè¾“å…¥ï¼š https://{username}:{password}@github.com æ¯”å¦‚ https://account:password@github.com 2. åœ¨ç»ˆç«¯ä¸‹æ‰§è¡Œ git config --global credential.helper store 3. å¯ä»¥çœ‹åˆ°~/.gitconfigæ–‡ä»¶ï¼Œä¼šå¤šäº†ä¸€é¡¹ [credential] helper = store ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/linux%E9%85%8D%E7%BD%AEgit%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/","series":["Manual"],"tags":["Other"],"title":"Linuxé…ç½®gitè´¦å·å¯†ç "},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"LRUå’ŒLFUéƒ½æ˜¯å†…å­˜ç®¡ç†çš„é¡µé¢ç½®æ¢ç®—æ³•ã€‚\nLRUï¼Œå³ï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨æ·˜æ±°ç®—æ³•ï¼ˆLeast Recently Usedï¼‰ã€‚LRUæ˜¯æ·˜æ±°æœ€é•¿æ—¶é—´æ²¡æœ‰è¢«ä½¿ç”¨çš„é¡µé¢ã€‚\nLFUï¼Œå³ï¼šæœ€ä¸ç»å¸¸ä½¿ç”¨æ·˜æ±°ç®—æ³•ï¼ˆLeast Frequently Usedï¼‰ã€‚LFUæ˜¯æ·˜æ±°ä¸€æ®µæ—¶é—´å†…ï¼Œä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„é¡µé¢ã€‚\næ¡ˆä¾‹ï¼š\nå‡è®¾LFUæ–¹æ³•çš„æ—¶æœŸTä¸º10åˆ†é’Ÿï¼Œè®¿é—®å¦‚ä¸‹é¡µé¢æ‰€èŠ±çš„æ—¶é—´æ­£å¥½ä¸º10åˆ†é’Ÿï¼Œå†…å­˜å—å¤§å°ä¸º3ã€‚\nè‹¥æ‰€éœ€é¡µé¢é¡ºåºä¾æ¬¡å¦‚ä¸‹ï¼š\n2 1 2 1 2 3 4\n\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;-\u0026gt;\nå½“éœ€è¦ä½¿ç”¨é¡µé¢4æ—¶ï¼Œå†…å­˜å—ä¸­å­˜å‚¨ç€1ã€2ã€3ï¼Œå†…å­˜å—ä¸­æ²¡æœ‰é¡µé¢4ï¼Œå°±ä¼šå‘ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œè€Œä¸”æ­¤æ—¶å†…å­˜å—å·²æ»¡ï¼Œéœ€è¦è¿›è¡Œé¡µé¢ç½®æ¢ã€‚\nè‹¥æŒ‰LRUç®—æ³•ï¼Œåº”æ›¿æ¢æ‰é¡µé¢1ã€‚å› ä¸ºé¡µé¢1æ˜¯æœ€é•¿æ—¶é—´æ²¡æœ‰è¢«ä½¿ç”¨çš„äº†ï¼Œé¡µé¢2å’Œ3éƒ½åœ¨å®ƒåé¢è¢«ä½¿ç”¨è¿‡ã€‚\nè‹¥æŒ‰LFUç®—æ³•ï¼Œåº”æ¢é¡µé¢3ã€‚å› ä¸ºåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œé¡µé¢1è¢«è®¿é—®äº†2æ¬¡ï¼Œé¡µé¢2è¢«è®¿é—®äº†3æ¬¡ï¼Œè€Œé¡µé¢3åªè¢«è®¿é—®äº†1æ¬¡ï¼Œä¸€æ®µæ—¶é—´å†…è¢«è®¿é—®çš„æ¬¡æ•°æœ€å°‘ã€‚\nå¯è§LRUå…³é”®æ˜¯çœ‹é¡µé¢æœ€åä¸€æ¬¡è¢«ä½¿ç”¨åˆ°å‘ç”Ÿè°ƒåº¦çš„æ—¶é—´é•¿çŸ­ï¼Œè€ŒLFUå…³é”®æ˜¯çœ‹ä¸€å®šæ—¶é—´æ®µå†…é¡µé¢è¢«ä½¿ç”¨çš„é¢‘ç‡!\nå‚è€ƒé“¾æ¥ï¼š LRUå’ŒLFUçš„åŒºåˆ«\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/lru%E5%92%8Clfu/","series":["Manual"],"tags":["CS"],"title":"LRUå’ŒLFU"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. é—®é¢˜ é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°jarå†²çªï¼Œç„¶åmavenæ ¹æ®è‡ªå·±çš„è§„åˆ™è¿›è¡Œå†²çªè§£å†³ï¼Œå¯¼è‡´é¡¹ç›®åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­æŠ¥é”™ã€‚\n1ã€mavenè‡ªåŠ¨è§£å†³ä¾èµ–å†²çªçš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ\n2ã€å¦‚ä½•æŸ¥çœ‹å½“å‰é¡¹ç›®çš„mavençš„ä¾èµ–æ ‘ï¼Ÿ\n3ã€å¦‚ä½•ä»ä¾èµ–æ ‘ä¸­æ‰¾åˆ°è‡ªå·±é¢„æœŸçš„ç‰ˆæœ¬ï¼Œæ˜¯è¢«é‚£ä¸ªjarç»™è¦†ç›–äº†ï¼Ÿ\n4ã€å¦‚ä½•äººå·¥è¿›è¡Œä¾èµ–å†²çªè§£å†³ï¼Œè¾¾åˆ°ä½¿ç”¨ç›®çš„ï¼Ÿ\n2. è§£å†³é—®é¢˜ 2.1 mavenè‡ªåŠ¨è§£å†³ä¾èµ–å†²çªçš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ 2.1.1 ç¬¬ä¸€åŸåˆ™ï¼šè·¯å¾„æœ€è¿‘è€…ä¼˜å…ˆ é¡¹ç›®Aæœ‰å¦‚ä¸‹çš„ä¾èµ–å…³ç³»ï¼š\nA-\u0026gt;B-\u0026gt;C-\u0026gt;X(1.0)\nA-\u0026gt;D-\u0026gt;X(2.0)\nåˆ™è¯¥ä¾‹å­ä¸­ï¼ŒXçš„ç‰ˆæœ¬æ˜¯2.0\n2.1.2 ç¬¬äºŒåŸåˆ™ï¼šè·¯å¾„ç›¸ç­‰ï¼Œå…ˆå£°æ˜è€…ä¼˜å…ˆ é¡¹ç›®Aæœ‰å¦‚ä¸‹çš„ä¾èµ–å…³ç³»ï¼š\nA-\u0026gt;B-\u0026gt;Y(1.0)\nA-\u0026gt;C-\u0026gt;Y(2.0)\nè‹¥pomæ–‡ä»¶ä¸­Bçš„ä¾èµ–åæ ‡å…ˆäºCè¿›è¡Œå£°æ˜ï¼Œåˆ™æœ€ç»ˆYçš„ç‰ˆæœ¬ä¸º1.0\n2.2 å¦‚ä½•æŸ¥çœ‹å½“å‰é¡¹ç›®çš„mavenä¾èµ–æ ‘ï¼Ÿ //è¿›å…¥é¡¹ç›®çš„pom.xmlæ–‡ä»¶çš„ç›®å½•ä¸‹ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤\r//è¿™ä¸ªæ˜¯æ­£å¸¸ä¾èµ–çš„æ ‘\rmvn dependency:tree\r//è¿™ä¸ªå‘½ä»¤æ˜¯æŸ¥çœ‹mavenæ˜¯å¦‚ä½•è§£å†³ä¾èµ–å†²çªçš„ä¾èµ–æ ‘\rmvn -Dverbose dependency:tree\r//å¦‚æœæƒ³å°†ä¾èµ–æ ‘æ‰“å°åˆ°æŒ‡å®šæ–‡ä»¶ä¸­ï¼Œåˆ™å‘½ä»¤å¦‚ä¸‹\rmvn -Dverbose dependency:tree -Doutput=/Users/shangxiaofei/sxfoutput.txt\r3. å¦‚ä½•ä»ä¾èµ–æ ‘ä¸­æ‰¾åˆ°è‡ªå·±é¢„æœŸçš„ç‰ˆæœ¬ï¼Œæ˜¯è¢«é‚£ä¸ªjarç»™è¦†ç›–äº†ï¼Ÿ ä¾‹å­ï¼š\né€’å½’ä¾èµ–çš„å…³ç³»åˆ—çš„ç®—æ˜¯æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œæ¯è¡Œéƒ½æ˜¯ä¸€ä¸ªjaråŒ…ï¼Œæ ¹æ®ç¼©è¿›å¯ä»¥çœ‹åˆ°ä¾èµ–çš„å…³ç³»ã€‚\næœ€åå†™ç€compileçš„å°±æ˜¯ç¼–è¯‘æˆåŠŸçš„ã€‚\næœ€åå†™ç€omitted for duplicateçš„å°±æ˜¯æœ‰jaråŒ…è¢«é‡å¤ä¾èµ–äº†ï¼Œä½†æ˜¯jaråŒ…çš„ç‰ˆæœ¬æ˜¯ä¸€æ ·çš„ã€‚\næœ€åå†™ç€omitted for conflict with xxxxçš„ï¼Œè¯´æ˜å’Œåˆ«çš„jaråŒ…ç‰ˆæœ¬å†²çªäº†ï¼Œè€Œè¯¥è¡Œçš„jaråŒ…ä¸ä¼šè¢«å¼•å…¥ã€‚æ¯”å¦‚ä¸Šé¢æœ‰ä¸€è¡Œæœ€åå†™ç€omitted for conflict with 3.4.6ï¼Œé‚£ä¹ˆè¯¥è¡Œçš„zookeeper:jar:3.4.8ä¸ä¼šè¢«å¼•å…¥ï¼Œä¼šå¼•å…¥3.4.6ç‰ˆæœ¬\næœ€åå†™ç€version managed from 2.3 ;omitted for duplicate ,è¡¨ç¤ºæœ€ç»ˆä½¿ç”¨commons-pool2æœ€ç»ˆä¼šä½¿ç”¨2.4.2ï¼Œæ‹’ç»ä½¿ç”¨ä¸­å£°æ˜çš„2.3ç‰ˆæœ¬\næœ€åå†™ç€version managed from 1.16.8 ;è¡¨ç¤ºæœ€ç»ˆä½¿ç”¨lombok:jar:1.16.22ç‰ˆæœ¬\n4. å¦‚ä½•äººå·¥è¿›è¡Œä¾èµ–å†²çªè§£å†³ï¼Œè¾¾åˆ°ä½¿ç”¨ç›®çš„ï¼Ÿ è§£å†³é‡å¤ä¾èµ–å’Œå†²çªçš„æ–¹æ³•ï¼š\n1ï¼Œä¿®æ”¹pomæ–‡ä»¶ä¸­ä¸¤ä¸ªdependencyå…ƒç´ çš„ä½ç½®ã€‚å¦‚æœä¸¤ä¸ªdependencyéƒ½å¼•ç”¨äº†ä¸€ä¸ªjaråŒ…ï¼Œä½†æ˜¯ç‰ˆæœ¬ä¸åŒï¼Œclassloaderåªä¼šåŠ è½½jaråŒ…åœ¨pomæ–‡ä»¶ä¸­å‡ºç°çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œä»¥åå‡ºç°çš„å…¶ä»–ç‰ˆæœ¬çš„jaråŒ…ä¼šè¢«å¿½ç•¥ã€‚\nä¸å»ºè®®ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œå› ä¸ºå¼•ç”¨ä¸åŒç‰ˆæœ¬çš„jaråŒ…æœ¬èº«å°±æ˜¯å¾ˆå±é™©çš„ã€‚\n2ï¼Œä½¿ç”¨æ ‡ç­¾æ¥å»æ‰æŸä¸ªdependencyä¾èµ–ä¸­çš„æŸä¸€ä¸ªjaråŒ…æˆ–ä¸€å †jaråŒ…ï¼Œä¸­çš„jaråŒ…æˆ–è€…ä¾èµ–çš„ç›¸å…³jaråŒ…éƒ½ä¼šè¢«å¿½ç•¥ï¼Œä»è€Œåœ¨ä¸¤ä¸ªdependencyéƒ½ä¾èµ–æŸä¸ªjaråŒ…æ—¶ï¼Œå¯ä»¥ä¿è¯åªä½¿ç”¨å…¶ä¸­çš„ä¸€ä¸ªã€‚\nå¯ä»¥è¿™ä¹ˆå†™ï¼š\n\u0026lt;dependency\u0026gt;\r\u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt;\r\u0026lt;artifactId\u0026gt;dubbo\u0026lt;/artifactId\u0026gt;\r\u0026lt;version\u0026gt;2.8.3.2\u0026lt;/version\u0026gt;\r\u0026lt;exclusions\u0026gt;\r\u0026lt;exclusion\u0026gt;\r\u0026lt;artifactId\u0026gt;guava\u0026lt;/artifactId\u0026gt;\r\u0026lt;groupId\u0026gt;com.google.guava\u0026lt;/groupId\u0026gt;\r\u0026lt;/exclusion\u0026gt;\r\u0026lt;exclusion\u0026gt;\r\u0026lt;artifactId\u0026gt;spring\u0026lt;/artifactId\u0026gt;\r\u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt;\r\u0026lt;/exclusion\u0026gt; \u0026lt;/exclusions\u0026gt;\r\u0026lt;/dependency\u0026gt;\r3. æ·±å…¥å­¦ä¹  3.1 mavençš„ä¾èµ–åŸºç¡€ \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba.share\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;test\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.4\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ä¾èµ–åº“å‘½åè§„åˆ™ï¼š ${groupId.part1}/${groupId.part2}/${version} ä¾‹ï¼šcom/alibaba/share/1.4 ä¾èµ–åº“æ–‡ä»¶å‘½åè§„åˆ™ï¼š ${artifactId}-${version}-${classifier}.${type} ä¾‹ï¼štest-1.4-source.jar æ³¨ï¼šclassfierå³åˆ†ç±»å™¨ï¼Œå¤šæ•°çš„æ—¶å€™æ˜¯ç”¨ä¸åˆ°çš„ï¼Œä¸è¿‡æœ‰å†™æƒ…å†µéœ€è¦ï¼Œä¾‹ï¼š TestNGå¼ºåˆ¶éœ€è¦ä½ æä¾›åˆ†ç±»å™¨ï¼Œä»¥åŒºåˆ«jdk14å’Œjdk15 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.testng\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;testng\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.7\u0026lt;/version\u0026gt; \u0026lt;classifier\u0026gt;jdk15\u0026lt;/classifier\u0026gt; \u0026lt;/dependency\u0026gt; 3.2 mavenä¾èµ–èŒƒå›´ \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;junit\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;junit\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.8.1\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; ä¸Šé¢çš„scopeå³çº¦å®šä¾èµ–èŒƒå›´ã€‚ compileï¼šé»˜è®¤å€¼ï¼Œä¸€ç›´å¯ç”¨ï¼Œæœ€åä¼šè¢«æ‰“åŒ… providedï¼šç¼–è¯‘æœŸé—´å¯ç”¨ï¼Œä¸ä¼šè¢«ä¼ é€’ä¾èµ–ï¼Œä¸ä¼šè¢«æ‰“åŒ…ã€‚ä¾‹ï¼šä¾èµ–äºwebå®¹å™¨ä¸­çš„æä¾›çš„ä¸€ä¸ªjaråŒ…ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™éœ€è¦åŠ å…¥ä¾èµ–ï¼ˆwebå®¹å™¨è¿˜æ²¡æœ‰ä»‹å…¥ï¼‰ï¼Œè¿è¡Œçš„æ—¶å€™ç”±webå®¹å™¨æ¥æä¾›ã€‚ testï¼šæ‰§è¡Œå•å…ƒæµ‹è¯•æ—¶å¯ç”¨ï¼Œä¸ä¼šè¢«æ‰“åŒ…ï¼Œä¸ä¼šè¢«ä¼ é€’ä¾èµ– runtimeï¼šè¿è¡Œå’Œæµ‹è¯•æ—¶éœ€è¦ï¼Œä½†ç¼–è¯‘æ—¶ä¸éœ€è¦ systemï¼šä¸æ¨èä½¿ç”¨\n3.3 mavenä¾èµ–ç®¡ç† é¿å…ä¸åŒå­æ¨¡å—ä¸­ä¾èµ–ç‰ˆæœ¬å†²çª åœ¨çˆ¶pomä¸­é…ç½®ä¾èµ–\n\u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.1.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ... \u0026lt;dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; åœ¨å­pomä¸­æ·»åŠ ä¾èµ–\n\u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; dependencyManagementå®é™…ä¸Šä¸ä¼šçœŸæ­£å¼•å…¥ä»»ä½•ä¾èµ–ï¼Œåœ¨å­pomä¸­æ·»åŠ ä¹‹åæ‰ä¼šã€‚åœ¨çˆ¶pomä¸­é…ç½®äº†ä¹‹åï¼Œå­æ¨¡å—åªéœ€ä½¿ç”¨ç®€å•groupIdå’ŒartifactIdå°±èƒ½è‡ªåŠ¨ç»§æ‰¿ç›¸åº”çš„çˆ¶æ¨¡å—ä¾èµ–é…ç½®ã€‚å¦‚æœå­pomä¸­å®šä¹‰äº†versionï¼Œåˆ™è¦†ç›–managementä¸­çš„ã€‚\n3.4 å¯é€‰ä¾èµ– \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.5\u0026lt;/version\u0026gt; \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; \u0026lt;/dependency\u0026gt; mavenå¯é€‰ä¾èµ–ï¼ˆOptional Dependenciesï¼‰å’Œä¾èµ–æ’é™¤ï¼ˆDependency Exclusionsï¼‰\r3.5 ä¾èµ–ç‰ˆæœ¬ç•Œé™ è¦æ±‚çš„ä¾èµ–ç‰ˆæœ¬\u0026gt;=3.8ä¸”\u0026lt;4.0\n\u0026lt;version\u0026gt;[3.8,4.0)\u0026lt;/version\u0026gt; è¦æ±‚çš„ä¾èµ–ç‰ˆæœ¬\u0026lt;=3.8.1\n\u0026lt;version\u0026gt;[,3.8.1]\u0026lt;/version\u0026gt; è¦æ±‚å¿…é¡»æ˜¯3.8.1ç‰ˆæœ¬ï¼Œå¦‚æœä¸æ˜¯çš„è¯ä¼šæ„å»ºå¤±è´¥ï¼Œæç¤ºç‰ˆæœ¬å†²çªã€‚åŸæ¥çš„å†™æ³•3.8.1çš„æ„æ€æ˜¯æ‰€æœ‰ç‰ˆæœ¬éƒ½å¯ä»¥ï¼Œä½†æœ€å¥½æ˜¯3.8.1\n\u0026lt;version\u0026gt;[3.8.1]\u0026lt;/version\u0026gt; 3.6 æ’é™¤ä¾èµ– ä¾èµ–project-aä½†æ˜¯æ’é™¤æ‰å¯¹project-aä¸­å¼•å…¥çš„project-bçš„ä¾èµ–\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.sonatype.mavenbook\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;project-a\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.0\u0026lt;/version\u0026gt; \u0026lt;exclusions\u0026gt; \u0026lt;exclusion\u0026gt; \u0026lt;groupId\u0026gt;org.sonatype.mavenbook\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;project-b\u0026lt;/artifactId\u0026gt; \u0026lt;/exclusion\u0026gt; \u0026lt;/exclusions\u0026gt; \u0026lt;/dependency\u0026gt; æ›¿æ¢ä¾èµ– ç›´æ¥ä½¿ç”¨ä¸Šä¸€æ­¥ä¸­çš„æ’é™¤æ‰ï¼Œç„¶åæ·»åŠ è¦æ›¿æ¢è¿›æ¥çš„ä¾èµ–å°±å¯ä»¥äº†ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„æ ‡å¿—æ¥æ ‡å¿—è¿™ä¸ªæ˜¯æ›¿æ¢è¿›æ¥çš„ã€‚\n3.7 ç‰ˆæœ¬å†²çªä»²è£ ç‰ˆæœ¬ä»²è£è§„åˆ™(åœ¨maven 2.2.1ç‰ˆæœ¬ä¸Šæµ‹è¯•éªŒè¯) â€¢ æŒ‰ç…§é¡¹ç›®æ€»POMçš„DependencyManagerç‰ˆæœ¬å£°æ˜è¿›è¡Œä»²è£(è¦†ç›–),ä½†æ— è­¦å‘Šã€‚ â€¢ å¦‚æ— ä»²è£å£°æ˜,åˆ™æŒ‰ç…§ä¾èµ–æœ€çŸ­è·¯å¾„ç¡®å®šç‰ˆæœ¬ã€‚ â€¢ è‹¥ç›¸åŒè·¯å¾„,æœ‰ä¸¥æ ¼åŒºé—´é™å®šçš„ç‰ˆæœ¬ä¼˜å…ˆã€‚ â€¢ è‹¥ç›¸åŒè·¯å¾„,æ— ç‰ˆæœ¬åŒºé—´,åˆ™æŒ‰ç…§å…ˆå…¥ä¸ºä¸»åŸåˆ™ã€‚ 3.8 ä¾èµ–å†²çªè§£å†³åŠæ³• 3.8.1 å®šä½å†²çª æŸ¥çœ‹é‚£äº›jaråŒ…ä¾èµ–äº†å†²çªåŒ…çš„å‘½ä»¤\nmvn dependency:tree -Dverbose -Dincludes=è¢«ä¾èµ–çš„åŒ…\råˆšæ‰å¹å˜˜dependency:treeæ—¶ï¼Œæˆ‘ç”¨åˆ°äº†â€œæ— å¤„éå½¢â€ï¼Œå…¶å®æœ‰æ—¶ä½ ä¼šå‘ç°ç®€å•åœ°ç”¨dependency:treeå¾€å¾€å¹¶ä¸èƒ½æŸ¥çœ‹åˆ°æ‰€æœ‰çš„ä¼ é€’ä¾èµ–ã€‚ä¸è¿‡å¦‚æœä½ çœŸçš„æƒ³è¦çœ‹æ‰€æœ‰çš„ï¼Œå¿…é¡»å¾—åŠ ä¸€ä¸ª-Dverboseå‚æ•°ï¼Œè¿™æ—¶å°±å¿…å®šæ˜¯æœ€å…¨çš„äº†ã€‚å…¨æ˜¯å…¨äº†ï¼Œä½†æ˜¾ç¤ºå‡ºæ¥çš„ä¸œè¥¿å¤ªå¤šï¼Œå¤´æ™•ç›®çœ©ï¼Œæœ‰æ²¡æœ‰å¥½æ³•å‘¢ï¼Ÿå½“ç„¶æœ‰äº†ï¼ŒåŠ ä¸ŠDincludesæˆ–è€…Dexcludesè¯´å‡ºä½ å–œæ¬¢æˆ–è®¨åŒï¼Œdependency:treeå°±ä¼šå¸®ä½ è¿‡æ»¤å‡ºæ¥ï¼š\n Dincludes=org.springframework:spring-tx\nè¿‡æ»¤ä¸²ä½¿ç”¨groupId:artifactId:versionçš„æ–¹å¼è¿›è¡Œè¿‡æ»¤ï¼Œå¯ä»¥ä¸å†™å…¨å•¦ï¼Œå¦‚ï¼š\nmvn dependency:tree -Dverbose -Dincludes=asm:asm\n å°±ä¼šå‡ºæ¥asmä¾èµ–åŒ…çš„åˆ†æä¿¡æ¯ï¼š\n[INFO] --- maven-dependency-plugin:2.1:tree (default-cli) @ ridge-test ---\r[INFO] com.ridge:ridge-test:jar:1.0.2-SNAPSHOT\r[INFO] +- asm:asm:jar:3.2:compile\r[INFO] \\- org.unitils:unitils-dbmaintainer:jar:3.3:compile\r[INFO] \\- org.hibernate:hibernate:jar:3.2.5.ga:compile\r[INFO] +- cglib:cglib:jar:2.1_3:compile\r[INFO] | \\- (asm:asm:jar:1.5.3:compile - omitted for conflict with 3.2)\r[INFO] \\- (asm:asm:jar:1.5.3:compile - omitted for conflict with 3.2)\r[INFO] ------------------------------------------------------------------------\rå¯¹asmæœ‰ä¾èµ–æœ‰ä¸€ä¸ªç›´æ¥çš„ä¾èµ–(asm:asm:jar:3.2)è¿˜æœ‰ä¸€ä¸ªä¼ é€’è¿›å…¥çš„ä¾èµ–(asm:asm:jar:1.5.3)\n3.8.2 å°†ä¸æƒ³è¦çš„ä¼ é€’ä¾èµ–å‰ªé™¤æ‰ æ‰¿ä¸Šï¼Œå‡è®¾æˆ‘ä»¬ä¸å¸Œæœ›asm:asm:jar:1.5.3å‡ºç°ï¼Œæ ¹æ®åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“å®ƒæ˜¯ç»ç”±org.unitils:unitils-dbmaintainer:jar:3.3å¼•å…¥çš„ï¼Œé‚£ä¹ˆåœ¨pom.xmlä¸­æ‰¾åˆ°è¿™ä¸ªä¾èµ–ï¼Œåšå…¶å®ƒçš„è°ƒæ•´ï¼š\n \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.unitils\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;unitils-dbmaintainer\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${unitils.version}\u0026lt;/version\u0026gt; \u0026lt;exclusions\u0026gt; \u0026lt;exclusion\u0026gt; \u0026lt;artifactId\u0026gt;dbunit\u0026lt;/artifactId\u0026gt; \u0026lt;groupId\u0026gt;org.dbunit\u0026lt;/groupId\u0026gt; \u0026lt;/exclusion\u0026gt; \u0026lt;!-- è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬è¦åŠ çš„ç‰‡æ–­ --\u0026gt; \u0026lt;exclusion\u0026gt; \u0026lt;artifactId\u0026gt;asm\u0026lt;/artifactId\u0026gt; \u0026lt;groupId\u0026gt;asm\u0026lt;/groupId\u0026gt; \u0026lt;/exclusion\u0026gt; \u0026lt;/exclusions\u0026gt; \u0026lt;/dependency\u0026gt; å†åˆ†æä¸€ä¸‹ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¼ é€’ä¾èµ–æ²¡æœ‰äº†ï¼š\n [INFO] [INFO] --- maven-dependency-plugin:2.1:tree (default-cli) @ ridge-test --- [INFO] com.ridge:ridge-test:jar:1.0.2-SNAPSHOT [INFO] \\- asm:asm:jar:3.2:compile [INFO] ------------------------------------------------------------------------ [INFO] BUILD SUCCESS 4. F\u0026amp;Q 4.1 runtime è¿è¡Œæ—¶ä¾èµ–èŒƒå›´ã€‚ä½¿ç”¨è¯¥èŒƒå›´çš„ä¾èµ–ï¼Œåªå¯¹æµ‹è¯•å’Œè¿è¡Œçš„ classpath æœ‰æ•ˆï¼Œä½†åœ¨ç¼–è¯‘ä¸»ä»£ç æ—¶æ˜¯æ— æ•ˆçš„ã€‚æ¯”å¦‚ JDBC é©±åŠ¨å®ç°ç±»ï¼Œå°±éœ€è¦åœ¨è¿è¡Œæµ‹è¯•å’Œè¿è¡Œä¸»ä»£ç æ—¶å€™ä½¿ç”¨ï¼Œç¼–è¯‘çš„æ—¶å€™ï¼Œåªéœ€ JDBC æ¥å£å°±è¡Œã€‚\nç®€å•æ¥è¯´ï¼Œcompileã€runtimeå’Œprovidedçš„åŒºåˆ«ï¼Œéœ€è¦åœ¨æ‰§è¡Œmvn packageå‘½ä»¤ï¼Œä¸”æ‰“åŒ…æ ¼å¼æ˜¯warä¹‹ç±»ï¼ˆè€Œä¸æ˜¯é»˜è®¤çš„jarï¼‰çš„æ—¶å€™æ‰èƒ½çœ‹å‡ºæ¥ã€‚\né€šè¿‡compileå’Œprovidedå¼•å…¥çš„jaråŒ…ï¼Œé‡Œé¢çš„ç±»ï¼Œä½ åœ¨é¡¹ç›®ä¸­å¯ä»¥ç›´æ¥importè¿›æ¥ç”¨ï¼Œç¼–è¯‘æ²¡é—®é¢˜ï¼Œä½†æ˜¯runtimeå¼•å…¥çš„jaråŒ…ä¸­çš„ç±»ï¼Œé¡¹ç›®ä»£ç é‡Œä¸èƒ½ç›´æ¥ç”¨ï¼Œç”¨äº†æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œåªèƒ½é€šè¿‡åå°„ä¹‹ç±»çš„æ–¹å¼æ¥ç”¨ã€‚\né€šè¿‡compileå’Œruntimeå¼•å…¥çš„jaråŒ…ï¼Œä¼šå‡ºç°åœ¨ä½ çš„é¡¹ç›®waråŒ…é‡Œï¼Œè€Œprovidedå¼•å…¥çš„jaråŒ…åˆ™ä¸ä¼šã€‚\nmavençš„scopeå€¼runtimeæ˜¯å¹²å˜›ç”¨çš„?\rMavenä¾èµ–é…ç½®å’Œä¾èµ–èŒƒå›´\r4.2 optional Hibernateç­‰DAOå±‚æ¡†æ¶\nMaven ä¸­trueå’Œprovidedä¹‹é—´çš„åŒºåˆ«\rMavenä¾èµ–é…ç½®å’Œä¾èµ–èŒƒå›´\r4.3 maven è§£å†³å•ç»§æ‰¿ ä½¿ç”¨import scopeè§£å†³mavenç»§æ‰¿ï¼ˆå•ï¼‰é—®é¢˜\rå‚è€ƒ mavenæŸ¥çœ‹é¡¹ç›®ä¾èµ–å¹¶è§£å†³ä¾èµ–å†²çªçš„é—®é¢˜\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/maven/maven%E5%9F%BA%E7%A1%80/","series":["Manual"],"tags":["Maven"],"title":"mavenåŸºç¡€"},{"categories":["åŒºå—é“¾"],"content":"åŒºå—é“¾ä¸€ä¸ªé‡è¦çš„äº®ç‚¹å°±æ˜¯é˜²ç¯¡æ”¹ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆåšåˆ°é˜²ç¯¡æ”¹çš„å‘¢ï¼Ÿå…¶ä¸­ä¸€ä¸ªé‡è¦çš„çŸ¥è¯†ç‚¹å°±æ˜¯Merkle Patricia Tree(MPT)ï¼Œæœ¬ç¯‡å°±æ¥è§£æä¸‹ä½•ä¸ºMPTã€‚\nMPTæ˜¯ä¸€ç§åŠ å¯†è®¤è¯çš„æ•°æ®ç»“æ„ï¼Œå®ƒèåˆäº†Merkleæ ‘å’ŒPatricia Trieæ ‘(åŸºæ•°æ ‘/å‹ç¼©å‰ç¼€æ ‘)ä¸¤ç§æ•°æ®ç±»å‹çš„ä¼˜ç‚¹ã€‚\nåˆ™åœ¨ä»‹ç»MPTæ ‘ä¹‹å‰å…ˆä»‹ç»ä¸‹Merkleæ ‘(é»˜å…‹å°”æ ‘)ã€Trieæ ‘(å‰ç¼€æ ‘)å’ŒPatricia Trie(åŸºæ•°æ ‘/å‹ç¼©å‰ç¼€æ ‘)ï¼Œä»‹ç»Trieæ ‘æ˜¯å› ä¸ºPatricia Trieæ˜¯åŸºäºTrieæ ‘è¡åŒ–æ¥çš„ã€‚\nTrieæ ‘ Trieæ ‘åˆç§°å‰ç¼€æ ‘æˆ–å­—å…¸æ ‘ï¼Œæ˜¯ä¸€ç§æ£€ç´¢æ ‘ï¼Œä½¿ç”¨ä¸€ä¸ªæœ‰åºçš„æ ‘ç»“æ„å­˜å‚¨ä¸€ä¸ªåŠ¨æ€æ•°æ®é›†æˆ–è€…å…³è”æ•°ç»„ï¼Œå…¶ä¸­çš„é”®é€šå¸¸æ˜¯å­—ç¬¦ä¸²ã€‚ä¸äºŒå‰æŸ¥æ‰¾æ ‘ä¸åŒï¼Œé”®ä¸æ˜¯ç›´æ¥ä¿å­˜åœ¨èŠ‚ç‚¹ä¸­ï¼Œè€Œæ˜¯ç”±èŠ‚ç‚¹åœ¨æ ‘ä¸­çš„ä½ç½®å†³å®šã€‚ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­å­™ç›¸å¯¹äºå½“å‰èŠ‚ç‚¹éƒ½æœ‰ç›¸åŒçš„å‰ç¼€ï¼Œè€Œæ ¹èŠ‚ç‚¹ä¸ºç©ºå­—ç¬¦ä¸²ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸æ˜¯æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æœ‰å¯¹åº”çš„å€¼ï¼Œåªæœ‰å¶å­èŠ‚ç‚¹å’Œéƒ¨åˆ†å†…éƒ¨èŠ‚ç‚¹æ‰€å¯¹åº”çš„é”®æ‰æœ‰ç›¸å…³çš„å€¼ã€‚\nTrieæ ‘ä¸­ï¼Œkeyæ˜¯ä»æ ‘æ ¹åˆ°å¯¹åº”valueå¾—çœŸå®çš„è·¯å¾„ã€‚å³ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œkeyä¸­çš„æ¯ä¸ªå­—ç¬¦ä¼šæ ‡è¯†èµ°é‚£ä¸ªå­èŠ‚ç‚¹ä»è€Œåˆ°è¾¾ç›¸åº”valueã€‚Valueè¢«å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œæ˜¯æ¯æ¡è·¯å¾„çš„ç»ˆæ­¢ã€‚å‡å¦‚keyæ¥è‡ªä¸€ä¸ªåŒ…å«Nä¸ªå­—ç¬¦çš„å­—æ¯è¡¨ï¼Œé‚£ä¹ˆæ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½ä¼šæœ‰å¤šè¾¾Nä¸ªå­©å­ï¼Œæ ‘çš„æœ€å¤§æ·±åº¦æ˜¯keyçš„æœ€å¤§é•¿åº¦ã€‚çœ‹ä¸ªä¾‹å­ç”»ä¸ªå›¾å°±äº†ç„¶äº†ã€‚ ä¾‹å­ï¼šå…³é”®å­—é›†åˆ{â€œaâ€, â€œtoâ€, â€œteaâ€, â€œtedâ€, â€œiâ€, â€œinâ€, â€œinnâ€}ï¼Œæ­¤é›†åˆè½¬ä¸ºTrieæ ‘ä¸º\nTrieæ ‘\nä¸ç†æƒ³æƒ…å†µä¸‹ï¼Œæ•°æ®é›†ä¸­å­˜åœ¨ä¸€ä¸ªå¾ˆé•¿çš„keyï¼Œè€Œè¿™ä¸ªkeyä¸å…¶å®ƒkeyåˆæ²¡æœ‰å¤ªå¤šçš„å…¬å…±å‰ç¼€ï¼Œè¿™å°±é€ æˆæ•´ä¸ªæ ‘çš„æ·±åº¦ä¼šåŠ å¤§ï¼Œéœ€è¦å­˜å‚¨å¤šä¸ªèŠ‚ç‚¹ï¼Œå­˜å‚¨æ¯”è¾ƒç¨€ç–è€Œä¸”æä¸å¹³è¡¡ã€‚ ä¾‹å­ï¼šå…³é”®å­—é›†åˆ{â€œalgoriâ€, â€œtoâ€, â€œteaâ€, â€œtedâ€, â€œiâ€, â€œinâ€, â€œinnâ€}ï¼Œæ­¤é›†åˆè½¬ä¸ºTrieæ ‘ä¸º\nç¨€ç–Trieæ ‘\nPatricia Trieæ ‘ æ—¢ç„¶Trieæ ‘åœ¨æŸäº›æƒ…å†µä¸‹å­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡ä¸é«˜ï¼Œé‚£å°±ç»™å‹ç¼©ä¸‹ï¼Œç„¶åå°±å‡ºç°äº†Patricia Trieæ ‘ã€‚\nPatricia Trieæ ‘æ˜¯ä¸€ç§ç©ºé—´ä½¿ç”¨ç‡ç»è¿‡ä¼˜åŒ–çš„Trieæ ‘ã€‚ä¸Trieæ ‘ä¸åŒçš„æ˜¯ï¼ŒPatricia Trie é‡Œå¦‚æœå­˜åœ¨ä¸€ä¸ªçˆ¶èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªçˆ¶èŠ‚ç‚¹å°†ä¸å…¶å­èŠ‚ç‚¹åˆå¹¶ã€‚è¿™æ ·å‹ç¼©å­˜å‚¨å¯ä»¥å‡å°‘Trieæ ‘ä¸­ä¸å¿…è¦çš„æ·±åº¦ï¼Œå¤§å¤§åŠ å¿«æœç´¢èŠ‚ç‚¹é€Ÿåº¦ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤º\nPatricia Trieæ ‘\nMerkleæ ‘ Merkleæ ‘æ˜¯ç”±è®¡ç®—æœºç§‘å­¦å®¶Ralph Merkleåœ¨å¾ˆå¤šå¹´å‰æå‡ºçš„ï¼Œå¹¶ä»¥ä»–æœ¬äººçš„åå­—æ¥å‘½åï¼Œæ˜¯ä¸€ç§æ ‘å½¢æ•°æ®ç»“æ„ï¼Œå¯ä»¥æ˜¯äºŒå‰æ ‘ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šå‰æ ‘ã€‚ å®ƒç”±è‹¥å¹²å¶èŠ‚ç‚¹ã€ä¸­é—´èŠ‚ç‚¹å’Œä¸€ä¸ªæ ¹èŠ‚ç‚¹æ„æˆã€‚æœ€ä¸‹é¢çš„å¶èŠ‚ç‚¹åŒ…å«åŸºç¡€æ•°æ®ï¼Œæ¯ä¸ªä¸­é—´èŠ‚ç‚¹æ˜¯å®ƒå­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œæ ¹èŠ‚ç‚¹æ˜¯å®ƒçš„å­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œä»£è¡¨äº†Merkleæ ‘çš„æ ¹éƒ¨ã€‚\nç”±äºMerkleæ ‘æ˜¯è‡ªåº•å‘ä¸Šæ„å»ºçš„ï¼Œè€Œä¸”é™¤å¶å­ç»“ç‚¹ä¹‹å¤–çš„å…¶å®ƒèŠ‚ç‚¹éƒ½æ˜¯å…¶å­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹çš„å€¼å‘ç”Ÿå˜åŒ–éƒ½ä¼šä¸€å±‚ä¸€å±‚çš„å‘ä¸Šåæ˜ ï¼Œæœ€ç»ˆåœ¨æ ¹èŠ‚ç‚¹ä¸Šè¡¨ç°å‡ºæ¥ã€‚ä¹Ÿå°±æ˜¯è¯´åªè¦å¯¹æ¯”ä¸¤ä¸ªMerkleæ ‘çš„æ ¹èŠ‚ç‚¹æ˜¯å¦ç›¸ç­‰å°±èƒ½å¾—åˆ°ä¸¤ä»½æ•°æ®é›†æ˜¯å¦ä¸€æ ·ï¼Œè€Œä¸”è¿˜å¯ä»¥éªŒè¯Merkleæ ‘çš„æŸä¸ªåˆ†æ”¯ã€‚\næ¯”ç‰¹å¸ä½¿ç”¨Merkleæ ‘å­˜å‚¨ä¸€ä¸ªåŒºå—ä¸­çš„æ‰€æœ‰äº¤æ˜“ä¿¡æ¯ï¼Œä¸€æ˜¯ä¸ºäº†é˜²ç¯¡æ”¹ï¼Œå› ä¸ºæ•£åˆ—æ˜¯å‘ä¸Šçš„ï¼Œä¼ªé€ ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šå¼•èµ·ä¸Šå±‚èŠ‚ç‚¹çš„æ”¹åŠ¨ï¼Œæœ€ç»ˆå¯¼è‡´æ ¹èŠ‚ç‚¹çš„å˜åŒ–ã€‚äºŒæ˜¯ä¸ºäº†å…è®¸åŒºå—çš„æ•°æ®å¯ä»¥é›¶æ•£çš„ä¼ é€ï¼Œå³èŠ‚ç‚¹å¯ä»¥ä»ä¸€ä¸ªèŠ‚ç‚¹ä¸‹è½½åŒºå—å¤´ï¼Œä»å¦å¤–çš„æºä¸‹è½½ä¸å…¶ç›¸å…³çš„æ ‘çš„å…¶ä»–éƒ¨åˆ†ï¼Œè€Œä¾ç„¶èƒ½å¤Ÿç¡®è®¤æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯æ­£ç¡®çš„ã€‚\nçœ‹ä¸‹å›¾çš„ä¾‹å­ï¼Œé¦–å…ˆå°†L1-L4å››ä¸ªå•å…ƒæ•°æ®æ•£åˆ—åŒ–ï¼Œç„¶åå°†æ•£åˆ—å€¼å­˜å‚¨è‡³ç›¸åº”çš„å¶å­èŠ‚ç‚¹ã€‚è¿™äº›èŠ‚ç‚¹æ˜¯Hash0-0, Hash0-1, Hash1-0, Hash1-1ï¼Œç„¶åå°†ç›¸é‚»ä¸¤ä¸ªèŠ‚ç‚¹çš„æ•£åˆ—å€¼åˆå¹¶æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åè®¡ç®—è¿™ä¸ªå­—ç¬¦ä¸²çš„æ•£åˆ—ï¼Œå¾—åˆ°çš„å°±æ˜¯è¿™ä¸¤ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„æ•£åˆ—å€¼ã€‚\nMerkleæ ‘\nåœ¨æ¯”ç‰¹å¸ç½‘ç»œä¸­ï¼Œmerkleæ ‘è¢«ç”¨æ¥å½’çº³ä¸€ä¸ªåŒºå—ä¸­çš„æ‰€æœ‰äº¤æ˜“ï¼ŒåŒæ—¶ç”Ÿæˆæ•´ä¸ªäº¤æ˜“é›†åˆçš„æ•°å­—æŒ‡çº¹ã€‚æ­¤å¤–ï¼Œç”±äºmerkleæ ‘çš„å­˜åœ¨ï¼Œä½¿å¾—åœ¨æ¯”ç‰¹å¸è¿™ç§å…¬é“¾çš„åœºæ™¯ä¸‹ï¼Œæ‰©å±•ä¸€ç§â€œè½»èŠ‚ç‚¹â€å®ç°ç®€å•æ”¯ä»˜éªŒè¯å˜æˆå¯èƒ½ã€‚\nçŸ¥é“äº†Merkleæ ‘åœ¨æ¯”ç‰¹å¸ä¸­çš„åº”ç”¨ï¼Œé‚£ä¹ˆä»–æ˜¯æ€ä¹ˆæ„æˆå‘¢ï¼Ÿç°åœ¨å°±ç®€å•çœ‹ä¸‹å…¶æ„æˆã€‚å®ƒç”±ä¸€ç»„å¶èŠ‚ç‚¹ã€ä¸€ç»„ä¸­é—´èŠ‚ç‚¹å’Œä¸€ä¸ªæ ¹èŠ‚ç‚¹æ„æˆã€‚æœ€ä¸‹é¢çš„å¶èŠ‚ç‚¹åŒ…å«åŸºç¡€æ•°æ®ï¼Œæ¯ä¸ªä¸­é—´èŠ‚ç‚¹æ˜¯å®ƒçš„å­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œæ ¹èŠ‚ç‚¹æ˜¯å®ƒçš„å­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œä»£è¡¨äº†Merkleæ ‘çš„æ ¹éƒ¨ ã€‚\nMerkleæ ‘å…·æœ‰ä¸‹åˆ—ç‰¹æ€§:\n æ¯ä¸ªæ•°æ®é›†å¯¹åº”ä¸€ä¸ªå”¯ä¸€åˆæ³•çš„æ ¹æ•£åˆ—å€¼ã€‚ å¾ˆå®¹æ˜“æ›´æ–°ã€æ·»åŠ æˆ–è€…åˆ é™¤æ ‘èŠ‚ç‚¹ï¼Œä»¥åŠç”Ÿæˆæ–°çš„æ ¹æ•£åˆ—å€¼ ã€‚ ä¸æ”¹å˜æ ¹æ•£åˆ—å€¼çš„è¯å°±æ²¡æœ‰åŠæ³•ä¿®æ”¹æ ‘çš„ä»»ä½•éƒ¨åˆ†ï¼Œæ‰€ä»¥å¦‚æœæ ¹æ•£åˆ—å€¼è¢«åŒ…æ‹¬åœ¨ç­¾åçš„æ–‡æ¡£æˆ–æœ‰æ•ˆåŒºå—ä¸­ï¼Œå°±å¯ä»¥ä¿è¯è¿™æ£µæ ‘çš„æ­£ç¡®æ€§ã€‚ ä»»ä½•äººå¯ä»¥åªæä¾›ä¸€ä¸ªåˆ°ç‰¹å®šèŠ‚ç‚¹çš„åˆ†æ”¯ï¼Œå¹¶é€šè¿‡å¯†ç å­¦æ–¹æ³•è¯æ˜æ‹¥æœ‰å¯¹åº”å†…å®¹çš„èŠ‚ç‚¹ç¡®å®åœ¨æ ‘é‡Œ ã€‚  Merkle Patricia Tree å¨å¨äº†é‚£ä¹ˆå¤šï¼Œæœ¬ç¯‡çš„ä¸»è§’ç»ˆäºå‡ºæ¥äº†ã€‚ Merkle Patricia Treeç»“åˆäº†Merkleæ ‘å’ŒPatriciaæ ‘çš„ç‰¹ç‚¹ï¼Œå¹¶é’ˆå¯¹ä»¥å¤ªåŠçš„ä½¿ç”¨åœºæ™¯è¿›è¡Œäº†ä¸€äº›æ”¹è¿›ã€‚\né¦–å…ˆï¼Œä¸ºäº†ä¿è¯æ ‘çš„åŠ å¯†å®‰å…¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹é€šè¿‡å®ƒçš„æ•£åˆ—å€¼è¢«å¼•ç”¨ï¼Œåˆ™æ ¹èŠ‚ç‚¹æ˜¯ä¸€å±‚ä¸€å±‚æ•£åˆ—å‘ä¸Šæ”¶æ•›è€Œå¾—ï¼Œè¢«ç§°ä¸ºæ•´æ£µæ ‘çš„åŠ å¯†ç­¾åï¼Œå¦‚æœä¸€æ£µç»™å®š Trieæ ‘çš„æ ¹æ•£åˆ—å€¼æ˜¯å…¬å¼€çš„ï¼Œé‚£ä¹ˆæ‰€æœ‰äººéƒ½å¯ä»¥æä¾›ä¸€ç§è¯æ˜ï¼Œå³é€šè¿‡æä¾›æ¯æ­¥å‘ä¸Šçš„è·¯å¾„è¯æ˜ç‰¹å®šçš„keyæ˜¯å¦å«æœ‰ç‰¹å®šçš„å€¼ã€‚åœ¨å½“å‰çš„ä»¥å¤ªåŠç‰ˆæœ¬ä¸­ï¼ŒMPTå­˜å‚¨åœ¨LevelDBæ•°æ®åº“ä¸­ã€‚\nå…¶æ¬¡ï¼ŒMPTæ ‘å¼•äººäº†å¾ˆå¤šèŠ‚ç‚¹ç±»å‹æ¥æé«˜æ•ˆç‡ã€‚åŒ…æ‹¬ä»¥ä¸‹4ç§:\n ç©ºèŠ‚ç‚¹(NULL) â€“ represented as the empty string  ç®€å•çš„è¡¨ç¤ºç©ºï¼Œåœ¨ä»£ç ä¸­æ˜¯ä¸€ä¸ªç©ºä¸²ã€‚\n å¶å­èŠ‚ç‚¹(leaf) â€“ a 2-item node [encodedPath, value]  è¡¨ç¤ºä¸º[key,value]çš„ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå…¶ä¸­keyæ˜¯keyçš„ä¸€ç§ç‰¹æ®Šåå…­è¿›åˆ¶ç¼–ç (MPç¼–ç )ï¼Œ valueæ˜¯valueçš„RLPç¼–ç ã€‚\n åˆ†æ”¯èŠ‚ç‚¹(branch) â€“ a 17-item node [v0 â€¦ v15, vt]  å› ä¸ºMPTæ ‘ä¸­çš„keyè¢«ç¼–ç æˆä¸€ç§ç‰¹æ®Šçš„16è¿›åˆ¶çš„è¡¨ç¤ºï¼Œå†åŠ ä¸Šæœ€åçš„valueï¼Œæ‰€ä»¥åˆ†æ”¯èŠ‚ç‚¹æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º17çš„listï¼Œå‰16ä¸ªå…ƒç´ å¯¹åº”ç€keyä¸­çš„16ä¸ªå¯èƒ½çš„åå…­è¿›åˆ¶å­—ç¬¦ï¼Œå¦‚æœæœ‰ä¸€ä¸ª[key,value]å¯¹åœ¨è¿™ä¸ªåˆ†æ”¯èŠ‚ç‚¹ç»ˆæ­¢ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä»£è¡¨è¿™ä¸ªå€¼valueï¼Œå³åˆ†æ”¯èŠ‚ç‚¹æ—¢å¯ä»¥æ˜¯æœç´¢è·¯å¾„çš„ç»ˆæ­¢ä¹Ÿå¯ä»¥æ˜¯è·¯å¾„çš„ä¸­é—´èŠ‚ç‚¹ã€‚\n æ‰©å±•èŠ‚ç‚¹(extension) â€“ a 2-item node [encodedPath, key]  ä¹Ÿæ˜¯[keyï¼Œvalue]çš„ä¸€ä¸ªé”®å€¼å¯¹ï¼Œä½†æ˜¯è¿™é‡Œçš„valueæ˜¯å…¶ä»–èŠ‚ç‚¹çš„hashå€¼ï¼Œè¿™ä¸ªhashå¯ä»¥è¢«ç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­çš„èŠ‚ç‚¹ã€‚ä¹Ÿå°±æ˜¯è¯´é€šè¿‡hashé“¾æ¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚\nä¸‹é¢çœ‹ä¸ªä»¥å¤ªåŠä¸­MPTæ ‘çš„å®˜æ–¹ç¤ºä¾‹\nç¤ºä¾‹ çœ‹åˆ°è¿™é‡Œä½ è‚¯å®šä¾ç„¶æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œ(ä¸è¦é—®æˆ‘æˆ‘æ˜¯æ€ä¹ˆçŸ¥é“çš„ã€‚ã€‚ã€‚ã€‚)ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ ¹æ®ä¸€æ‰¹æ•°æ®æ„é€ ä¸€ä¸ªMPTæ ‘ï¼Œè¿™æ ·ä½ ä¼šç†è§£ä¸€äº›ã€‚ ä½†æ˜¯åœ¨è®²ä¾‹å­ä¹‹å‰ï¼Œè¿˜å¾—å…ˆä»‹ç»å‡ ç§ç¼–ç æ–¹å¼ï¼Œè¦ä¸çœ‹ä¾‹å­çš„æ—¶å€™å¯¹keyçš„å–å€¼ä¼šæ¯”è¾ƒæ‡µã€‚\nkeyç¼–ç  åœ¨ä»¥å¤ªåŠä¸­ï¼ŒMPTæ ‘çš„keyå€¼å…±æœ‰ä¸‰ç§ä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œåˆ†åˆ«ä¸º:\n Rawç¼–ç (åŸç”Ÿçš„å­—ç¬¦) Hexç¼–ç (æ‰©å±•çš„16è¿›åˆ¶ç¼–ç ) Hex-Prefixç¼–ç (16è¿›åˆ¶å‰ç¼€ç¼–ç )  Rawç¼–ç \rRawç¼–ç å°±æ˜¯åŸç”Ÿçš„keyå€¼ï¼Œä¸åšä»»ä½•æ”¹å˜ã€‚è¿™ç§ç¼–ç æ–¹å¼çš„keyï¼Œæ˜¯MPTå¯¹å¤–æä¾›æ¥å£çš„é»˜è®¤ç¼–ç æ–¹å¼ã€‚\rä¾‹å¦‚keyä¸ºâ€dogâ€ï¼Œvalueä¸ºâ€puppyâ€çš„æ•°æ®é¡¹ï¼Œå…¶keyçš„Rawç¼–ç å°±æ˜¯[â€˜dâ€™, â€˜oâ€™, â€˜gâ€™]ï¼Œæ¢æˆASCIIè¡¨ç¤ºæ–¹å¼å°±æ˜¯[64, 6f, 67] : dog =\u0026gt; â€˜puppyâ€™\rHexç¼–ç \rHexç¼–ç å°±æ˜¯æŠŠä¸€ä¸ª8ä½çš„å­—èŠ‚æ•°æ®æ ¹æ®é«˜4ä½å’Œä½4ä½æ‹†è§£ä¸ºä¸¤ä¸ª4ä½çš„æ•°å­—ï¼Œç„¶åä¸¤ä¸ªæ•°å­—çš„é«˜4ä½éƒ½è¡¥0ï¼Œæœ€åå°†è¡¥å®Œä¹‹åçš„ä¸¤ä¸ªå­—èŠ‚ç¼–ç ä¸º16è¿›åˆ¶ã€‚\rè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯keyå¯¹åº”çš„å€¼ä¸ºçœŸå®çš„æ•°æ®é¡¹ï¼Œå³æ˜¯ä¸€ä¸ªæœ‰æ„ä¹‰çš„kvå¯¹ï¼Œæ¯”å¦‚dog-\u0026gt;puppy(ä¹Ÿå°±æ˜¯å¶å­ç»“ç‚¹)ï¼Œè€Œä¸æ˜¯key-\u0026gt;èŠ‚ç‚¹hash(ä¹Ÿå°±æ˜¯åˆ†æ”¯èŠ‚ç‚¹)ï¼Œåˆ™åœ¨æœ«å°¾æ·»åŠ ä¸€ä¸ªASCIIå€¼ä¸º16(åå…­è¿›åˆ¶ä¸º0x10)çš„å­—ç¬¦ä¸²ä½œä¸ºterminatorã€‚å¦‚æœæ˜¯åˆ†æ”¯èŠ‚ç‚¹åˆ™ä¸åŠ ä»»ä½•å­—ç¬¦ã€‚\rä¾‹å¦‚keyä¸ºâ€dogâ€ï¼Œvalueä¸ºâ€puppyâ€çš„æ•°æ®é¡¹ï¼Œå…¶keyä¸­d(100)çš„äºŒè¿›åˆ¶ç¼–ç ä¸º01100100ï¼Œæ‹†è§£ä¸ºä¸¤ä¸ª4ä½çš„æ•°å­—ä¸º0110å’Œ0100ï¼Œé«˜ä½è¡¥0ä¹‹åçš„äºŒè¿›åˆ¶ä¸º00000110å’Œ00000100ï¼Œ16è¿›åˆ¶ä¸º6å’Œ4ï¼Œä¾æ¬¡ç¼–ç oå’Œgã€‚åˆå› ä¸ºdogå¯¹åº”çš„valueæ˜¯çœŸå®çš„æ•°æ®é¡¹ï¼Œåˆ™åœ¨æœ«å°¾æ·»åŠ 16ã€‚æœ€åæœ€ç»ˆçš„Hexç¼–ç ä¸º[ 6, 4, 6, 15, 6, 7, 16 ] : dog =\u0026gt; â€˜puppyâ€™\rHex-Prefixç¼–ç \ré¦–å…ˆæ ¹æ®åå­—å¾—çŸ¥è¿™æ˜¯ä¸€ä¸ªå‰ç¼€ç¼–ç ï¼Œæ˜¯åœ¨åŸkeyçš„åŸºç¡€ä¸ŠåŠ ä¸Šä¸€äº›æ ‡è¯†ä½œä¸ºå‰ç¼€ï¼Œå…¶æ¬¡æˆ‘ä»¬çœ‹ä¸‹è¿™ç§ç¼–ç æ–¹å¼çš„ç›®çš„ï¼š\r1. åŒºåˆ†leafå’Œextension\r2. æŠŠå¥‡æ•°è·¯å¾„å˜æˆå¶æ•°è·¯å¾„\råˆ™è¿™ä¸ªå‰ç¼€çš„ç”Ÿæˆè‚¯å®šä¸leafã€extensionå’Œkeyçš„å¥‡å¶ç›¸å…³äº†ï¼Œä¸‹é¢çœ‹ä¸‹ç¼–ç æ­¥éª¤ä¸º:\r1. å…ˆæŒ‰Hexå¯¹keyè¿›è¡Œç¼–ç \r2. keyçš„ç»“å°¾å¦‚æœæ˜¯0x10(ä¹Ÿå°±æ˜¯16)ï¼Œåˆ™å»æ‰è¿™ä¸ªç»ˆæ­¢ç¬¦\r3. keyä¹‹å‰è¡¥ä¸€ä¸ªå››å…ƒç»„ï¼Œè¿™ä¸ªå››å…ƒç»„ç¬¬0ä½åŒºåˆ†å¥‡å¶ä¿¡æ¯ï¼Œç¬¬1ä½åŒºåˆ†èŠ‚ç‚¹ç±»å‹ï¼Œè¡¨æ ¼è¡¨ç¤ºå¦‚ä¸‹\r   node type path length prefix hexchar     extension even 0000 0x0   extension odd 0001 0x1   leaf even 0010 0x2   leaf odd 0011 0x3    4. å¦‚æœè¾“å…¥keyçš„é•¿åº¦æ˜¯å¶æ•°ï¼Œåˆ™åœ¨ä¹‹å‰çš„å››å…ƒç»„åå†æ·»åŠ ä¸€ä¸ªå››å…ƒç»„0x0\r5. å°†åŸæ¥çš„keyå†…å®¹å‹ç¼©ï¼Œå°†åˆ†ç¦»çš„ä¸¤ä¸ªbyteä»¥é«˜å››ä½ä½å››ä½è¿›è¡Œåˆå¹¶\rè¿™é‡Œæœ‰ä¸ªåè¯è§£é‡Šä¸‹ï¼Œå››å…ƒç»„æ˜¯å››ä¸ªbitä½çš„ç»„åˆ(ä¾‹å¦‚äºŒè¿›åˆ¶è¡¨è¾¾çš„0010å°±æ˜¯ä¸€ä¸ªå››å…ƒç»„)ï¼Œå…¶ä¸­Nibbleå°±æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼Œæ˜¯keyçš„åŸºæœ¬å•å…ƒã€‚\nä¾‹å¦‚keyä¸ºâ€dogâ€ï¼Œvalueä¸ºâ€puppyâ€çš„æ•°æ®é¡¹ï¼Œåˆ™é¦–å…ˆå¯¹dogè¿›è¡ŒHexç¼–ç [ 6, 4, 6, 15, 6, 7, 16 ]ï¼Œç„¶åæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤è¿›è¡Œç¼–ç ï¼Œdogçš„Hexç¼–ç æœ«å°¾æ˜¯16ï¼Œå»æ‰ç»ˆæ­¢ç¬¦ä¸º[ 6, 4, 6, 15, 6, 7 ]ï¼Œå‡†å¤‡åœ¨keyå‰è¡¥å››å…ƒç»„ï¼Œdogä¸ºå¶å­èŠ‚ç‚¹å¹¶ä¸”ç¼–ç ä¹‹åçš„é•¿åº¦ä¸º6æ˜¯å¶æ•°ï¼Œæ‰€ä»¥å››å…ƒç»„ä¸º0010(0x2)ï¼Œæ­¤æ—¶åˆ°äº†ç¬¬4æ­¥ï¼Œkeyç¼–ç ä¹‹åçš„é•¿åº¦æ˜¯å¶æ•°ï¼Œåˆ™åœ¨å‰ä¸€ä¸ªå››å…ƒç»„(0x2)ä¹‹åå†æ·»åŠ ä¸€ä¸ªå››å…ƒç»„0x0ï¼Œæœ€ç»ˆçš„å‰ç¼€ä¸º0x20ã€‚æœ€åå°†åŸæ¥çš„keyå†…å®¹è¿›è¡Œé«˜ä½å››ä½åˆå¹¶ï¼Œæœ€ç»ˆçš„Hex-Prefixç¼–ç æ˜¯[ 0x20, 0x64, 0x6f, 0x67 ]\rä»¥ä¸Šä¸‰ç§ç¼–ç æ–¹å¼çš„è½¬æ¢å…³ç³»ä¸ºï¼š\nRawç¼–ç : åŸç”Ÿçš„keyç¼–ç ï¼Œæ˜¯MPTå¯¹å¤–æä¾›æ¥å£ä¸­ä½¿ç”¨çš„ç¼–ç æ–¹å¼ï¼Œå½“æ•°æ®é¡¹è¢«æ’å…¥åˆ°æ ‘ä¸­æ—¶ï¼ŒRawç¼–ç è¢«è½¬æ¢æˆHexç¼–ç \rHexç¼–ç : 16è¿›åˆ¶æ‰©å±•ç¼–ç ï¼Œç”¨äºå¯¹å†…å­˜ä¸­æ ‘èŠ‚ç‚¹keyè¿›è¡Œç¼–ç ï¼Œå½“æ ‘èŠ‚ç‚¹è¢«æŒä¹…åŒ–åˆ°æ•°æ®åº“æ—¶ï¼ŒHexç¼–ç è¢«è½¬æ¢æˆHPç¼–ç \rHPç¼–ç : 16è¿›åˆ¶å‰ç¼€ç¼–ç ï¼Œç”¨äºå¯¹æ•°æ®åº“ä¸­æ ‘èŠ‚ç‚¹keyè¿›è¡Œç¼–ç ï¼Œå½“æ ‘èŠ‚ç‚¹è¢«åŠ è½½åˆ°å†…å­˜æ—¶ï¼ŒHPç¼–ç è¢«è½¬æ¢æˆHexç¼–ç \ræ„é€ è¿‡ç¨‹ æ¥ä¸‹æ¥æˆ‘ä»¬å°±å®é™…æ“ä½œä¸‹ï¼š å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ ‘æœ‰è¿™æ ·ä¸€äº›kvå¯¹(â€˜dogâ€™, â€˜puppyâ€™), (â€˜horseâ€™, â€˜stallionâ€™), (â€˜doâ€™, â€˜verbâ€™), (â€˜dogeâ€™, â€˜coinâ€™)ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å°†keyè½¬æˆHexç¼–ç ï¼Œå¦‚ä¸‹ï¼š\n# 64 6f\r[ 6, 4, 6, 15, 16 ] : do =\u0026gt; 'verb'\r#64 6f 67\r[ 6, 4, 6, 15, 6, 7, 16 ] : dog =\u0026gt; 'puppy'\r#64 6f 67 65\r[ 6, 4, 6, 15, 6, 7, 6, 5, 16 ] : doge =\u0026gt; 'coin'\r#68 6f 72 73 65\r[ 6, 8, 6, 15, 7, 2, 7, 3, 6, 5, 16 ] : horse =\u0026gt; 'stallion'\rå…¶æ„é€ MPTæ ‘å¦‚å›¾ï¼š\nMPT\nrootHash: [ \u0026lt;16\u0026gt;, hashA ]\rhashA: [ \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, hashB, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, hashC, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt; ]\rhashC: [ \u0026lt;20 6f 72 73 65\u0026gt;, 'stallion' ]\rhashB: [ \u0026lt;00 6f\u0026gt;, hashD ]\rhashD: [ \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, hashE, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, 'verb' ]\rhashE: [ \u0026lt;17\u0026gt;, hashF ]\rhashF: [ \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, hashG, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, \u0026lt;\u0026gt;, 'puppy' ]\rhashG: [ \u0026lt;35\u0026gt;, 'coin' ]\ræ„é€ è¿‡ç¨‹ä¸º å‡è®¾æ’å…¥ç¬¬ä¸€ä¸ªkvå¯¹æ˜¯do-\u0026gt;verbï¼Œkeyæ ¹æ®Hex-Prefixç¼–ç ä¸º[â€˜0x20â€™, â€˜0x64â€™, â€˜0x6fâ€™]ï¼ŒMPTæ ‘ä¸ºï¼š\n å‡è®¾æ’å…¥ç¬¬ä¸€ä¸ªkvå¯¹æ˜¯do-\u0026gt;verbï¼Œkeyæ ¹æ®Hex-Prefixç¼–ç ä¸º[â€˜0x20â€™, â€˜0x64â€™, â€˜0x6fâ€™]ï¼ŒMPTæ ‘ä¸ºï¼š  å¶å­èŠ‚ç‚¹\næ¥ç€æ’å…¥ç¬¬äºŒä¸ªkvå¯¹dog-\u0026gt;puppyï¼Œdogå’Œdoçš„å…¬å…±å‰ç¼€ä¸º[â€˜64â€™, â€˜6fâ€™]ï¼Œdoæ˜¯å¶å­ç»“ç‚¹Aï¼Œå°†å¶å­ç»“ç‚¹æ›¿æ¢æˆæ‰©å±•èŠ‚ç‚¹Aï¼Œå¹¶å°†æ–°keyä¸å¶å­èŠ‚ç‚¹Açš„å…¬å…±å‰ç¼€(646f)ä½œä¸ºæ‰©å±•èŠ‚ç‚¹çš„keyï¼Œæ‰©å±•èŠ‚ç‚¹çš„valueæ˜¯æ–°åˆ†æ”¯èŠ‚ç‚¹Bçš„hashå€¼ï¼Œç„¶åå°†doå’Œdogå‰©ä½™çš„keyæ’å…¥åˆ°åˆ†æ”¯èŠ‚ç‚¹ä¸­ï¼Œç”±äºdoæ²¡æœ‰å‰©ä½™çš„keyï¼Œåˆ™å°†å¯¹åº”çš„valueå†™å…¥åˆ†æ”¯èŠ‚ç‚¹Bçš„valueä¸­ï¼Œdogå‰©ä½™çš„keyä¸º67ï¼Œåˆ™åˆ†æ”¯èŠ‚ç‚¹Bä¸­çš„è·¯å¾„ä¸º6ï¼ŒæŒ‡å‘å¶å­ç»“ç‚¹Cã€‚7ä¸ºdogå‰©ä¸‹çš„æœ€åä¸€ä¸ªkeyå€¼ï¼Œæ˜¯å¥‡æ•°å¶å­ç»“ç‚¹åˆ™å‰ç¼€ä¸º3ï¼Œæ‰€æœ‰æœ€ç»ˆçš„MPTæ ‘ä¸ºï¼š  å¶å­èŠ‚ç‚¹æ’å…¥\nå†æ’å…¥ç¬¬ä¸‰ä¸ªkvå¯¹doge-\u0026gt;coinï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤ç”Ÿæˆçš„MPTæ ‘æ˜¯ï¼š  æœ€åæ’å…¥ç¬¬å››ä¸ªkvå¯¹horse-\u0026gt;stallionï¼Œhorseä¸å…¶å®ƒkeyçš„å…¬å…±å‰ç¼€åªæœ‰6ï¼Œåˆ™å°†æ‰©å±•èŠ‚ç‚¹Aæ–°å¢ä¸€ä¸ªåˆ†æ”¯èŠ‚ç‚¹Fä½œä¸ºå…¶å­©å­èŠ‚ç‚¹ï¼Œå°†æ–°keyä¸æ‰©å±•èŠ‚ç‚¹Açš„å…¬å…±å‰ç¼€6ä½œä¸ºæ‰©å±•èŠ‚ç‚¹Açš„keyï¼ŒAæ˜¯æ‰©å±•èŠ‚ç‚¹å¹¶ä¸”keyä¸ºå¥‡æ•°ï¼Œæ‰€ä»¥å‰ç¼€ä¸º1ï¼Œvalueä¸ºæ–°å¢åˆ†æ”¯èŠ‚ç‚¹Fçš„hashã€‚åŸæ‰©å±•èŠ‚ç‚¹Aå˜æˆæ–°æ‰©å±•èŠ‚ç‚¹ä¹‹åå‰©ä½™çš„keyï¼Œä¸æ–°keyå‰©ä¸‹çš„keyï¼Œæ’å…¥åˆ°åˆ†æ”¯èŠ‚ç‚¹Fä¸­ï¼Œåˆ†åˆ«æ”¾å…¥4å’Œ8ä¸­ï¼Œ4æŒ‡å‘æ–°çš„æ‰©å±•èŠ‚ç‚¹Gï¼Œ8æŒ‡å‘å¶å­èŠ‚ç‚¹Hã€‚æœ€ç»ˆçš„MPTæ ‘ä¸ºï¼š  MPTåœ¨ä»¥å¤ªåŠä¸­çš„åº”ç”¨ Merkleæ•°æ®ç»“æ„åœ¨åŒºå—é“¾é¢†åŸŸä¸­ä½¿ç”¨æ¯”è¾ƒå¹¿æ³›ï¼Œæ¯”ç‰¹å¸å’Œä»¥å¤ªåŠéƒ½æ˜¯ç”¨äº†Merkleæ ‘ï¼Œå…¶ä¸­ä»¥å¤ªåŠä¸­ä¿ç•™äº†ä¸‰é¢—MPTï¼Œåˆ†åˆ«æ˜¯çŠ¶æ€æ ‘ã€äº¤æ˜“æ ‘å’Œæ”¶æ®æ ‘ï¼Œè¿™ä¸‰ç§æ ‘å¯ä»¥å¸®åŠ©ä»¥å¤ªåŠå®¢æˆ·ç«¯åšä¸€äº›ç®€æ˜“çš„æŸ¥è¯¢ï¼Œå¦‚æŸ¥è¯¢æŸä¸ªè´¦æˆ·çš„ä½™é¢ã€æŸç¬”äº¤æ˜“æ˜¯å¦è¢«åŒ…å«åœ¨åŒºå—ä¸­ç­‰ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯åœ¨ä»¥å¤ªåŠä¸­å¯¹MPTå†è¿›è¡Œäº†ä¸€æ¬¡å°è£…ï¼Œå¯¹æ•°æ®é¡¹çš„keyè¿›è¡Œäº†ä¸€æ¬¡å“ˆå¸Œè®¡ç®—sha3(key)ï¼Œvalueè¿›è¡Œäº†RLP(Recursive length prefix encoding,é€’å½’é•¿åº¦å‰ç¼€ç¼–ç )ç¼–ç ï¼Œæ•°æ®åº“ä¸­å­˜å‚¨é¢å¤–çš„sha3(key)ä¸keyä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚\nåŸæ–‡é“¾æ¥ï¼š http://bigdatadecode.club/Merkle-Patricia-Tree.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%8C%BA%E5%9D%97%E9%93%BE/merkle-patricia-treempt/","series":["Manual"],"tags":["BlockChain"],"title":"Merkle Patricia Tree"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"MongoDBç»¼è¿° å‚è€ƒ é¡¹ç›®å®æˆ˜ MongoDBå¿«é€Ÿå…¥é—¨ï¼ŒæŒæ¡è¿™äº›åˆšåˆšå¥½ï¼\rmallæ•´åˆMongodbå®ç°æ–‡æ¡£æ“ä½œ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mongodb/mongodb%E7%BB%BC%E8%BF%B0/","series":["Manual"],"tags":["MongoDB"],"title":"MongoDBç»¼è¿°"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"éšç€åˆ†å¸ƒå¼æœåŠ¡æ¶æ„çš„æµè¡Œä¸æ™®åŠï¼ŒåŸæ¥åœ¨å•ä½“åº”ç”¨ä¸­æ‰§è¡Œçš„å¤šä¸ªé€»è¾‘æ“ä½œï¼Œç°åœ¨è¢«æ‹†åˆ†æˆäº†å¤šä¸ªæœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨ã€‚è™½ç„¶æœåŠ¡åŒ–ä¸ºæˆ‘ä»¬çš„ç³»ç»Ÿå¸¦æ¥äº†æ°´å¹³ä¼¸ç¼©çš„èƒ½åŠ›ï¼Œç„¶è€Œéšä¹‹è€Œæ¥æŒ‘æˆ˜å°±æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œå¤šä¸ªæœåŠ¡ä¹‹é—´ä½¿ç”¨è‡ªå·±å•ç‹¬ç»´æŠ¤çš„æ•°æ®åº“ï¼Œå®ƒä»¬å½¼æ­¤ä¹‹é—´ä¸åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå‡å¦‚Aæ‰§è¡ŒæˆåŠŸäº†ï¼ŒBæ‰§è¡Œå´å¤±è´¥äº†ï¼Œè€ŒAçš„äº‹åŠ¡æ­¤æ—¶å·²ç»æäº¤ï¼Œæ— æ³•å›æ»šï¼Œé‚£ä¹ˆæœ€ç»ˆå°±ä¼šå¯¼è‡´ä¸¤è¾¹æ•°æ®ä¸ä¸€è‡´æ€§çš„é—®é¢˜ï¼›å°½ç®¡å¾ˆæ—©ä¹‹å‰å°±æœ‰åŸºäºä¸¤é˜¶æ®µæäº¤çš„XAåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä½†æ˜¯è¿™ç±»æ–¹æ¡ˆå› ä¸ºéœ€è¦èµ„æºçš„å…¨å±€é”å®šï¼Œå¯¼è‡´æ€§èƒ½æå·®ï¼›å› æ­¤åé¢å°±é€æ¸è¡ç”Ÿå‡ºäº†æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§ã€TCCç­‰æŸ”æ€§äº‹åŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆï¼Œæœ¬æ–‡ä¸»è¦åˆ†æçš„æ˜¯åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆã€‚\n0. ç®€å•RPCå¤„ç†å­˜åœ¨çš„ä¸€è‡´æ€§é—®é¢˜ åœ¨æ­£å¼å¼€å§‹è®²è¿°æ­£é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼Œä¸ä¾èµ–ä»»ä½•åˆ†å¸ƒå¼äº‹åŠ¡æ‰‹æ®µï¼Œå•çº¯å°†æœ¬åœ°ä¸šåŠ¡é€»è¾‘å’Œè¿œç¨‹è°ƒç”¨é€»è¾‘æ”¾åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚\næˆ‘ä»¬ä»¥è®¢å•åˆ›å»ºä¸ºä¾‹ï¼Œè®¢å•ç³»ç»Ÿå…ˆåˆ›å»ºè®¢å•(æœ¬åœ°äº‹åŠ¡)ï¼Œç„¶åRPCè°ƒç”¨åº“å­˜æ‰£å‡æœåŠ¡ã€‚\n@Transactionnal public void processOrder() { try{ // è®¢å•å¤„ç†(ä¸šåŠ¡æ“ä½œ)  orderService.process(); // åº“å­˜æ‰£å‡ï¼ˆRPCè¿œç¨‹è°ƒç”¨ï¼‰  storageService.deduction(); }catch(Exception e){ äº‹åŠ¡å›æ»š; } } å¦‚æœåº“å­˜æœåŠ¡ç”±äºDBæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œå¯¼è‡´å¤„ç†è¶…æ—¶ï¼Œè®¢å•æœåŠ¡åœ¨å‡ºç°è¶…æ—¶å¼‚å¸¸åï¼Œç›´æ¥å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œä»è€Œå¯¼è‡´è®¢å•æœåŠ¡è¿™è¾¹æ²¡æ•°æ®ï¼Œè€Œåº“å­˜æœåŠ¡é‚£è¾¹æ•°æ®å´å·²ç»å†™å…¥äº†ï¼Œæœ€ç»ˆå¯¼è‡´ä¸¤è¾¹ä¸šåŠ¡æ•°æ®çš„ä¸ä¸€è‡´ã€‚\nå³ä½¿ä¸å­˜åœ¨ â€œDBæ•°æ®é‡æ¯”è¾ƒå¤§â€ è¿™ç§ç‰¹æ®Šæƒ…å†µï¼Œä¹Ÿä¸€å®šä¼šå­˜åœ¨å› ä¸ºç½‘ç»œæŠ–åŠ¨ï¼Œè®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡è¶…æ—¶è€Œæœ¬åœ°å›æ»šï¼Œä½†æ˜¯åº“å­˜æœåŠ¡å®é™…æ“ä½œæˆåŠŸçš„æƒ…å†µã€‚\nå…¶æ ¹æœ¬çš„åŸå› å°±åœ¨äºï¼šè¿œç¨‹è°ƒç”¨ï¼Œç»“æœæœ€ç»ˆå¯èƒ½ä¸ºæˆåŠŸã€å¤±è´¥ã€è¶…æ—¶ï¼›è€Œå¯¹äºè¶…æ—¶çš„æƒ…å†µï¼Œå¤„ç†æ–¹æœ€ç»ˆçš„ç»“æœå¯èƒ½æ˜¯æˆåŠŸï¼Œä¹Ÿå¯èƒ½æ˜¯å¤±è´¥ï¼Œè°ƒç”¨æ–¹æ˜¯æ— æ³•çŸ¥æ™“çš„ã€‚\n1. æ™®é€šæ¶ˆæ¯çš„å¤„ç†æµç¨‹  æ¶ˆæ¯ç”Ÿæˆè€…å‘é€æ¶ˆæ¯ MQæ”¶åˆ°æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–ï¼Œåœ¨å­˜å‚¨ä¸­æ–°å¢ä¸€æ¡è®°å½• è¿”å›ACKç»™ç”Ÿäº§è€… MQ push æ¶ˆæ¯ç»™å¯¹åº”çš„æ¶ˆè´¹è€…ï¼Œç„¶åç­‰å¾…æ¶ˆè´¹è€…è¿”å›ACK å¦‚æœæ¶ˆæ¯æ¶ˆè´¹è€…åœ¨æŒ‡å®šæ—¶é—´å†…æˆåŠŸè¿”å›ackï¼Œé‚£ä¹ˆMQè®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹æˆåŠŸï¼Œåœ¨å­˜å‚¨ä¸­åˆ é™¤æ¶ˆæ¯ï¼Œå³æ‰§è¡Œç¬¬6æ­¥ï¼›å¦‚æœMQåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ACKï¼Œåˆ™è®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼Œä¼šå°è¯•é‡æ–°pushæ¶ˆæ¯,é‡å¤æ‰§è¡Œ4ã€5ã€6æ­¥éª¤ MQåˆ é™¤æ¶ˆæ¯  1.2 æ™®é€šæ¶ˆæ¯å¤„ç†å­˜åœ¨çš„ä¸€è‡´æ€§é—®é¢˜ æˆ‘ä»¬è¿˜æ˜¯ä»¥è®¢å•åˆ›å»ºä¸ºä¾‹ï¼Œè®¢å•ç³»ç»Ÿå…ˆåˆ›å»ºè®¢å•(æœ¬åœ°äº‹åŠ¡)ï¼Œå†å‘é€æ¶ˆæ¯ç»™ä¸‹æ¸¸å¤„ç†ï¼›å¦‚æœè®¢å•åˆ›å»ºæˆåŠŸï¼Œç„¶è€Œæ¶ˆæ¯æ²¡æœ‰å‘é€å‡ºå»ï¼Œé‚£ä¹ˆä¸‹æ¸¸æ‰€æœ‰ç³»ç»Ÿéƒ½æ— æ³•æ„ŸçŸ¥åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œä¼šå‡ºç°è„æ•°æ®ï¼›\npublic void processOrder() { // è®¢å•å¤„ç†(ä¸šåŠ¡æ“ä½œ)  orderService.process(); // å‘é€è®¢å•å¤„ç†æˆåŠŸæ¶ˆæ¯(å‘é€æ¶ˆæ¯)  sendBizMsg (); } å¦‚æœå…ˆå‘é€è®¢å•æ¶ˆæ¯ï¼Œå†åˆ›å»ºè®¢å•ï¼›é‚£ä¹ˆå°±æœ‰å¯èƒ½æ¶ˆæ¯å‘é€æˆåŠŸï¼Œä½†æ˜¯åœ¨è®¢å•åˆ›å»ºçš„æ—¶å€™å´å¤±è´¥äº†ï¼Œæ­¤æ—¶ä¸‹æ¸¸ç³»ç»Ÿå´è®¤ä¸ºè¿™ä¸ªè®¢å•å·²ç»åˆ›å»ºï¼Œä¹Ÿä¼šå‡ºç°è„æ•°æ®ã€‚\npublic void processOrder() { // å‘é€è®¢å•å¤„ç†æˆåŠŸæ¶ˆæ¯(å‘é€æ¶ˆæ¯)  sendBizMsg (); // è®¢å•å¤„ç†(ä¸šåŠ¡æ“ä½œ)  orderService.process(); } 1.3 ä¸€ä¸ªé”™è¯¯çš„æƒ³æ³• æ­¤æ—¶å¯èƒ½æœ‰åŒå­¦ä¼šæƒ³ï¼Œæˆ‘ä»¬å¯å¦å°†æ¶ˆæ¯å‘é€å’Œä¸šåŠ¡å¤„ç†æ”¾åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æ¥è¿›è¡Œå¤„ç†ï¼Œå¦‚æœä¸šåŠ¡æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œé‚£ä¹ˆæœ¬åœ°äº‹åŠ¡å°±å›æ»šï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å°±èƒ½è§£å†³æ¶ˆæ¯å‘é€çš„ä¸€è‡´æ€§é—®é¢˜å‘¢?\n@Transactionnal public void processOrder() { try{ // è®¢å•å¤„ç†(ä¸šåŠ¡æ“ä½œ)  orderService.process(); // å‘é€è®¢å•å¤„ç†æˆåŠŸæ¶ˆæ¯(å‘é€æ¶ˆæ¯)  sendBizMsg (); }catch(Exception e){ äº‹åŠ¡å›æ»š; } } è¿™ç§åšæ³•çš„é”™è¯¯åœ¨äºï¼Œå¦‚æœè®¢å•å¤„ç†æˆåŠŸï¼Œæ¶ˆæ¯æˆåŠŸå­˜å‚¨åˆ°MQï¼Œä½†æ˜¯MQå¤„ç†è¶…æ—¶ï¼Œä»è€ŒACKç¡®è®¤å¤±è´¥ï¼Œå¯¼è‡´å‘é€æ–¹æœ¬åœ°äº‹åŠ¡å›æ»šã€‚ åŠ¿å¿…é€ æˆæ¶ˆæ¯ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ•°æ®çŠ¶æ€ä¸ä¸€è‡´ã€‚\n2. äº‹åŠ¡æ¶ˆæ¯ ç”±äºä¼ ç»Ÿçš„å¤„ç†æ–¹å¼æ— æ³•è§£å†³æ¶ˆæ¯ç”Ÿæˆè€…æœ¬åœ°äº‹åŠ¡å¤„ç†æˆåŠŸä¸æ¶ˆæ¯å‘é€æˆåŠŸä¸¤è€…çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤äº‹åŠ¡æ¶ˆæ¯å°±è¯ç”Ÿäº†ï¼Œå®ƒå®ç°äº†æ¶ˆæ¯ç”Ÿæˆè€…æœ¬åœ°äº‹åŠ¡ä¸æ¶ˆæ¯å‘é€çš„åŸå­æ€§ï¼Œä¿è¯äº†æ¶ˆæ¯ç”Ÿæˆè€…æœ¬åœ°äº‹åŠ¡å¤„ç†æˆåŠŸä¸æ¶ˆæ¯å‘é€æˆåŠŸçš„æœ€ç»ˆä¸€è‡´æ€§é—®é¢˜ã€‚\n2.1 äº‹åŠ¡æ¶ˆæ¯å¤„ç†çš„æµç¨‹  äº‹åŠ¡æ¶ˆæ¯ä¸æ™®é€šæ¶ˆæ¯çš„åŒºåˆ«å°±åœ¨äºæ¶ˆæ¯ç”Ÿäº§ç¯èŠ‚ï¼Œç”Ÿäº§è€…é¦–å…ˆé¢„å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°MQ(è¿™ä¹Ÿè¢«ç§°ä¸ºå‘é€halfæ¶ˆæ¯) MQæ¥å—åˆ°æ¶ˆæ¯åï¼Œå…ˆè¿›è¡ŒæŒä¹…åŒ–ï¼Œåˆ™å­˜å‚¨ä¸­ä¼šæ–°å¢ä¸€æ¡çŠ¶æ€ä¸ºå¾…å‘é€çš„æ¶ˆæ¯ ç„¶åè¿”å›ACKç»™æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œæ­¤æ—¶MQä¸ä¼šè§¦å‘æ¶ˆæ¯æ¨é€äº‹ä»¶ ç”Ÿäº§è€…é¢„å‘é€æ¶ˆæ¯æˆåŠŸåï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåï¼Œå‘é€æ‰§è¡Œç»“æœç»™MQ MQä¼šæ ¹æ®ç»“æœåˆ é™¤æˆ–è€…æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå¯å‘é€ å¦‚æœæ¶ˆæ¯çŠ¶æ€æ›´æ–°ä¸ºå¯å‘é€ï¼Œåˆ™MQä¼špushæ¶ˆæ¯ç»™æ¶ˆè´¹è€…ï¼Œåé¢æ¶ˆæ¯çš„æ¶ˆè´¹å’Œæ™®é€šæ¶ˆæ¯æ˜¯ä¸€æ ·çš„  æ³¨æ„ç‚¹ï¼šç”±äºMQé€šå¸¸éƒ½ä¼šä¿è¯æ¶ˆæ¯èƒ½å¤ŸæŠ•é€’æˆåŠŸï¼Œå› æ­¤ï¼Œå¦‚æœä¸šåŠ¡æ²¡æœ‰åŠæ—¶è¿”å›ACKç»“æœï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½é€ æˆMQçš„é‡å¤æ¶ˆæ¯æŠ•é€’é—®é¢˜ã€‚å› æ­¤ï¼Œå¯¹äºæ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§çš„æ–¹æ¡ˆï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹è€…å¿…é¡»è¦å¯¹æ¶ˆæ¯çš„æ¶ˆè´¹æ”¯æŒå¹‚ç­‰ï¼Œä¸èƒ½é€ æˆåŒä¸€æ¡æ¶ˆæ¯çš„é‡å¤æ¶ˆè´¹çš„æƒ…å†µã€‚\n2.2 æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„MQ ç°åœ¨ç›®å‰è¾ƒä¸ºä¸»æµçš„MQï¼Œæ¯”å¦‚ActiveMQã€RabbitMQã€Kafkaã€RocketMQç­‰ï¼Œåªæœ‰RocketMQæ”¯æŒäº‹åŠ¡æ¶ˆæ¯ã€‚æ®ç¬”è€…äº†è§£ï¼Œæ—©å¹´é˜¿é‡Œå¯¹MQå¢åŠ äº‹åŠ¡æ¶ˆæ¯ä¹Ÿæ˜¯å› ä¸ºæ”¯ä»˜å®é‚£è¾¹å› ä¸ºä¸šåŠ¡ä¸Šçš„éœ€æ±‚è€Œäº§ç”Ÿçš„ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›å¼ºä¾èµ–ä¸€ä¸ªMQçš„äº‹åŠ¡æ¶ˆæ¯æ¥åšåˆ°æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§çš„è¯ï¼Œåœ¨ç›®å‰çš„æƒ…å†µä¸‹ï¼ŒæŠ€æœ¯é€‰å‹ä¸Šåªèƒ½å»é€‰æ‹©RocketMQæ¥è§£å†³ã€‚ä¸Šé¢æˆ‘ä»¬ä¹Ÿåˆ†æäº†äº‹åŠ¡æ¶ˆæ¯æ‰€å­˜åœ¨çš„å¼‚å¸¸æƒ…å†µï¼Œå³MQå­˜å‚¨äº†å¾…å‘é€çš„æ¶ˆæ¯ï¼Œä½†æ˜¯MQæ— æ³•æ„ŸçŸ¥åˆ°ä¸Šæ¸¸å¤„ç†çš„æœ€ç»ˆç»“æœã€‚å¯¹äºRocketMQè€Œè¨€ï¼Œå®ƒçš„è§£å†³æ–¹æ¡ˆéå¸¸çš„ç®€å•ï¼Œå°±æ˜¯å…¶å†…éƒ¨å®ç°ä¼šæœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå»è½®è®­çŠ¶æ€ä¸ºå¾…å‘é€çš„æ¶ˆæ¯ï¼Œç„¶åç»™producerå‘é€checkè¯·æ±‚ï¼Œè€Œproducerå¿…é¡»å®ç°ä¸€ä¸ªcheckç›‘å¬å™¨ï¼Œç›‘å¬å™¨çš„å†…å®¹é€šå¸¸å°±æ˜¯å»æ£€æŸ¥ä¸ä¹‹å¯¹åº”çš„æœ¬åœ°äº‹åŠ¡æ˜¯å¦æˆåŠŸ(ä¸€èˆ¬å°±æ˜¯æŸ¥è¯¢DB)ï¼Œå¦‚æœæˆåŠŸäº†ï¼Œåˆ™MQä¼šå°†æ¶ˆæ¯è®¾ç½®ä¸ºå¯å‘é€ï¼Œå¦åˆ™å°±åˆ é™¤æ¶ˆæ¯ã€‚\nç”±äºå¹¶éæ‰€æœ‰çš„MQéƒ½æ”¯æŒäº‹åŠ¡æ¶ˆæ¯ï¼Œå‡å¦‚æˆ‘ä»¬ä¸é€‰æ‹©RocketMQæ¥ä½œä¸ºç³»ç»Ÿçš„MQï¼Œæ˜¯å¦èƒ½å¤Ÿåšåˆ°æ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚\n3. åŸºäºæœ¬åœ°æ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§ åŸºäºæœ¬åœ°æ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆçš„æœ€æ ¸å¿ƒåšæ³•å°±æ˜¯åœ¨æ‰§è¡Œä¸šåŠ¡æ“ä½œçš„æ—¶å€™ï¼Œè®°å½•ä¸€æ¡æ¶ˆæ¯æ•°æ®åˆ°DBï¼Œå¹¶ä¸”æ¶ˆæ¯æ•°æ®çš„è®°å½•ä¸ä¸šåŠ¡æ•°æ®çš„è®°å½•å¿…é¡»åœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…å®Œæˆï¼Œè¿™æ˜¯è¯¥æ–¹æ¡ˆçš„å‰ææ ¸å¿ƒä¿éšœã€‚åœ¨è®°å½•å®Œæˆåæ¶ˆæ¯æ•°æ®åï¼Œåé¢æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡åˆ°DBä¸­å»è½®è®­çŠ¶æ€ä¸ºå¾…å‘é€çš„æ¶ˆæ¯ï¼Œç„¶åå°†æ¶ˆæ¯æŠ•é€’ç»™MQã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨æ¶ˆæ¯æŠ•é€’å¤±è´¥çš„å¯èƒ½ï¼Œæ­¤æ—¶å°±ä¾é é‡è¯•æœºåˆ¶æ¥ä¿è¯ï¼Œç›´åˆ°æˆåŠŸæ”¶åˆ°MQçš„ACKç¡®è®¤ä¹‹åï¼Œå†å°†æ¶ˆæ¯çŠ¶æ€æ›´æ–°æˆ–è€…æ¶ˆæ¯æ¸…é™¤ï¼›è€Œåé¢æ¶ˆæ¯çš„æ¶ˆè´¹å¤±è´¥çš„è¯ï¼Œåˆ™ä¾èµ–MQæœ¬èº«çš„é‡è¯•æ¥å®Œæˆï¼Œå…¶æœ€ååšåˆ°ä¸¤è¾¹ç³»ç»Ÿæ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚åŸºäºæœ¬åœ°æ¶ˆæ¯æœåŠ¡çš„æ–¹æ¡ˆè™½ç„¶å¯ä»¥åšåˆ°æ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„å¼Šç«¯ï¼Œæ¯ä¸ªä¸šåŠ¡ç³»ç»Ÿåœ¨ä½¿ç”¨è¯¥æ–¹æ¡ˆæ—¶ï¼Œéƒ½éœ€è¦åœ¨å¯¹åº”çš„ä¸šåŠ¡åº“åˆ›å»ºä¸€å¼ æ¶ˆæ¯è¡¨æ¥å­˜å‚¨æ¶ˆæ¯ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥åŠŸèƒ½å•ç‹¬æå–å‡ºæ¥ï¼Œåšæˆä¸€ä¸ªæ¶ˆæ¯æœåŠ¡æ¥ç»Ÿä¸€å¤„ç†ï¼Œå› è€Œå°±è¡ç”Ÿå‡ºäº†æˆ‘ä»¬ä¸‹é¢å°†è¦è®¨è®ºçš„æ–¹æ¡ˆã€‚\n4. ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡æœ€ç»ˆä¸€è‡´æ€§ä¸æœ¬åœ°æ¶ˆæ¯æœåŠ¡æœ€ç»ˆä¸€è‡´æ€§æœ€å¤§çš„å·®å¼‚å°±åœ¨äºå°†æ¶ˆæ¯çš„å­˜å‚¨å•ç‹¬åœ°åšæˆäº†ä¸€ä¸ªRPCçš„æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯æ¨¡æ‹Ÿäº†äº‹åŠ¡æ¶ˆæ¯çš„æ¶ˆæ¯é¢„å‘é€è¿‡ç¨‹ï¼Œå¦‚æœé¢„å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œé‚£ä¹ˆç”Ÿäº§è€…ä¸šåŠ¡å°±ä¸ä¼šå»æ‰§è¡Œï¼Œå› æ­¤å¯¹äºç”Ÿäº§è€…çš„ä¸šåŠ¡è€Œè¨€ï¼Œå®ƒæ˜¯å¼ºä¾èµ–äºè¯¥æ¶ˆæ¯æœåŠ¡çš„ã€‚ä¸è¿‡å¥½åœ¨ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡æ”¯æŒæ°´å¹³æ‰©å®¹ï¼Œå› æ­¤åªè¦éƒ¨ç½²å¤šå°ï¼ŒåšæˆHAçš„é›†ç¾¤æ¨¡å¼ï¼Œå°±èƒ½å¤Ÿä¿è¯å…¶å¯é æ€§ã€‚åœ¨æ¶ˆæ¯æœåŠ¡ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå•ç‹¬åœ°å®šæ—¶ä»»åŠ¡ï¼Œå®ƒä¼šå®šæœŸè½®è®­é•¿æ—¶é—´å¤„äºå¾…å‘é€çŠ¶æ€çš„æ¶ˆæ¯ï¼Œé€šè¿‡ä¸€ä¸ªcheckè¡¥å¿æœºåˆ¶æ¥ç¡®è®¤è¯¥æ¶ˆæ¯å¯¹åº”çš„ä¸šåŠ¡æ˜¯å¦æˆåŠŸï¼Œå¦‚æœå¯¹åº”çš„ä¸šåŠ¡å¤„ç†æˆåŠŸï¼Œåˆ™å°†æ¶ˆæ¯ä¿®æ”¹ä¸ºå¯å‘é€ï¼Œç„¶åå°†å…¶æŠ•é€’ç»™MQï¼›å¦‚æœä¸šåŠ¡å¤„ç†å¤±è´¥ï¼Œåˆ™å°†å¯¹åº”çš„æ¶ˆæ¯æ›´æ–°æˆ–è€…åˆ é™¤å³å¯ã€‚å› æ­¤åœ¨ä½¿ç”¨è¯¥æ–¹æ¡ˆæ—¶ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…å¿…é¡»åŒæ—¶å®ç°ä¸€ä¸ªcheckæœåŠ¡ï¼Œæ¥ä¾›æ¶ˆæ¯æœåŠ¡åšæ¶ˆæ¯çš„ç¡®è®¤ã€‚å¯¹äºæ¶ˆæ¯çš„æ¶ˆè´¹ï¼Œè¯¥æ–¹æ¡ˆä¸ä¸Šé¢çš„å¤„ç†æ˜¯ä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡MQè‡ªèº«çš„é‡å‘æœºåˆ¶æ¥ä¿è¯æ¶ˆæ¯è¢«æ¶ˆè´¹ã€‚\nå‚è€ƒ MQæ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mq/mq%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/","series":["Manual"],"tags":["MQ"],"title":"MQæ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. æ¦‚å¿µ  Broker Producer Consumer Topic Queue Message  2. æ¨¡å¼ 2.1. ç‚¹å¯¹ç‚¹ PTP ç‚¹å¯¹ç‚¹: ä½¿ç”¨ Queue ä½œä¸ºé€šä¿¡è½½ä½“\næ¶ˆæ¯ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å‘é€åˆ° Queue ä¸­ï¼Œç„¶åæ¶ˆæ¯æ¶ˆè´¹è€…ä» Queue ä¸­å–å‡ºå¹¶ä¸”æ¶ˆè´¹æ¶ˆæ¯ã€‚æ¶ˆæ¯è¢«æ¶ˆè´¹ä»¥åï¼ŒQueue ä¸­ä¸å†å­˜å‚¨ï¼Œæ‰€ä»¥æ¶ˆæ¯æ¶ˆè´¹è€…ä¸å¯èƒ½æ¶ˆè´¹åˆ°å·²ç»è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚Queue æ”¯æŒå­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¯¹ä¸€ä¸ªæ¶ˆæ¯è€Œè¨€ï¼Œåªä¼šæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹\n2.2. å‘å¸ƒ/è®¢é˜… Pub/Sub å‘å¸ƒè®¢é˜…(å¹¿æ’­): ä½¿ç”¨ Topic ä½œä¸ºé€šä¿¡è½½ä½“\næ¶ˆæ¯ç”Ÿäº§è€…(å‘å¸ƒ)å°†æ¶ˆæ¯å‘å¸ƒåˆ° Topic ä¸­ï¼ŒåŒæ—¶æœ‰å¤šä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…(è®¢é˜…)æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚å’Œç‚¹å¯¹ç‚¹æ–¹å¼ä¸åŒï¼Œå‘å¸ƒåˆ° Topic çš„æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰è®¢é˜…è€…æ¶ˆè´¹\næ€»ç»“ Queue å®ç°äº†è´Ÿè½½å‡è¡¡ï¼Œå°† Producer ç”Ÿäº§çš„æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç”±å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ä½†ä¸€ä¸ªæ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¥å—ï¼Œå½“æ²¡æœ‰æ¶ˆè´¹è€…å¯ç”¨æ—¶ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¼šè¢«ä¿å­˜ç›´åˆ°æœ‰ä¸€ä¸ªå¯ç”¨çš„æ¶ˆè´¹è€…\nTopic å®ç°äº†å‘å¸ƒå’Œè®¢é˜…ï¼Œå½“ä½ å‘å¸ƒä¸€ä¸ªæ¶ˆæ¯ï¼Œæ‰€æœ‰è®¢é˜…è¿™ä¸ª Topic çš„æœåŠ¡éƒ½èƒ½å¾—åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œæ‰€ä»¥ä»1åˆ°Nä¸ªè®¢é˜…è€…éƒ½èƒ½å¾—åˆ°ä¸€ä¸ªæ¶ˆæ¯çš„æ‹·è´\n3. åè®® 3.1. AMQPåè®® AMQP å³ Advanced Message Queuing Protocol ï¼Œä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ï¼Œä¸åŒå¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚å…¼å®¹ JMSã€‚RabbitMQ å°±æ˜¯åŸºäº AMQP åè®®å®ç°çš„ã€‚\nä¼˜ç‚¹ï¼šå¯é ã€é€šç”¨\n JMSï¼ˆJAVA Message Service,java æ¶ˆæ¯æœåŠ¡ï¼‰æ˜¯ java çš„æ¶ˆæ¯æœåŠ¡ï¼ŒJMS çš„å®¢æˆ·ç«¯ä¹‹é—´å¯ä»¥é€šè¿‡ JMS æœåŠ¡è¿›è¡Œå¼‚æ­¥çš„æ¶ˆæ¯ä¼ è¾“ã€‚JMSï¼ˆJAVA Message Serviceï¼ŒJava æ¶ˆæ¯æœåŠ¡ï¼‰API æ˜¯ä¸€ä¸ªæ¶ˆæ¯æœåŠ¡çš„æ ‡å‡†æˆ–è€…è¯´æ˜¯è§„èŒƒï¼Œå…è®¸åº”ç”¨ç¨‹åºç»„ä»¶åŸºäº JavaEE å¹³å°åˆ›å»ºã€å‘é€ã€æ¥æ”¶å’Œè¯»å–æ¶ˆæ¯ã€‚å®ƒä½¿åˆ†å¸ƒå¼é€šä¿¡è€¦åˆåº¦æ›´ä½ï¼Œæ¶ˆæ¯æœåŠ¡æ›´åŠ å¯é ä»¥åŠå¼‚æ­¥æ€§ã€‚\nActiveMQ å°±æ˜¯åŸºäº JMS è§„èŒƒå®ç°çš„ã€‚\nJMS vs AMQP    å¯¹æ¯”æ–¹å‘ JMS AMQP     å®šä¹‰ Java API åè®®   è·¨è¯­è¨€ å¦ æ˜¯   è·¨å¹³å° å¦ æ˜¯   æ”¯æŒæ¶ˆæ¯ç±»å‹ æä¾›ä¸¤ç§æ¶ˆæ¯æ¨¡å‹ï¼šâ‘ Peer-2-Peer;â‘¡Pub/sub æä¾›äº†äº”ç§æ¶ˆæ¯æ¨¡å‹ï¼šâ‘ direct exchangeï¼›â‘¡fanout exchangeï¼›â‘¢topic changeï¼›â‘£headers exchangeï¼›â‘¤system exchangeã€‚æœ¬è´¨æ¥è®²ï¼Œåå››ç§å’Œ JMS çš„ pub/sub æ¨¡å‹æ²¡æœ‰å¤ªå¤§å·®åˆ«ï¼Œä»…æ˜¯åœ¨è·¯ç”±æœºåˆ¶ä¸Šåšäº†æ›´è¯¦ç»†çš„åˆ’åˆ†ï¼›   æ”¯æŒæ¶ˆæ¯ç±»å‹ æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢æåˆ°è¿‡ byte[]ï¼ˆäºŒè¿›åˆ¶ï¼‰     3.2. MQTTåè®® MQTTï¼ˆMessage Queuing Telemetry Transportï¼Œæ¶ˆæ¯é˜Ÿåˆ—é¥æµ‹ä¼ è¾“ï¼‰æ˜¯ IBM å¼€å‘çš„ä¸€ä¸ªå³æ—¶é€šè®¯åè®®ï¼Œæœ‰å¯èƒ½æˆä¸ºç‰©è”ç½‘çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚è¯¥åè®®æ”¯æŒæ‰€æœ‰å¹³å°ï¼Œå‡ ä¹å¯ä»¥æŠŠæ‰€æœ‰è”ç½‘ç‰©å“å’Œå¤–éƒ¨è¿æ¥èµ·æ¥ï¼Œè¢«ç”¨æ¥å½“åšä¼ æ„Ÿå™¨å’Œè‡´åŠ¨å™¨ï¼ˆæ¯”å¦‚é€šè¿‡ Twitter è®©æˆ¿å±‹è”ç½‘ï¼‰çš„é€šä¿¡åè®®ã€‚\nä¼˜ç‚¹ï¼šæ ¼å¼ç®€æ´ã€å ç”¨å¸¦å®½å°ã€ç§»åŠ¨ç«¯é€šä¿¡ã€PUSHã€åµŒå…¥å¼ç³»ç»Ÿ\n3.3. STOMPåè®® STOMPï¼ˆStreaming Text Orientated Message Protocolï¼‰æ˜¯æµæ–‡æœ¬å®šå‘æ¶ˆæ¯åè®®ï¼Œæ˜¯ä¸€ç§ä¸º MOMï¼ˆMessage Oriented Middlewareï¼Œé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼‰è®¾è®¡çš„ç®€å•æ–‡æœ¬åè®®ã€‚STOMP æä¾›ä¸€ä¸ªå¯äº’æ“ä½œçš„è¿æ¥æ ¼å¼ï¼Œå…è®¸å®¢æˆ·ç«¯ä¸ä»»æ„ STOMP æ¶ˆæ¯ä»£ç†ï¼ˆBrokerï¼‰è¿›è¡Œäº¤äº’ã€‚\nä¼˜ç‚¹ï¼šå‘½ä»¤æ¨¡å¼ï¼ˆé Topic\\Queue æ¨¡å¼ï¼‰\n3.4. XMPPåè®® XMPPï¼ˆå¯æ‰©å±•æ¶ˆæ¯å¤„ç†ç°åœºåè®®ï¼ŒExtensible Messaging and Presence Protocolï¼‰æ˜¯åŸºäºå¯æ‰©å±•æ ‡è®°è¯­è¨€ï¼ˆXMLï¼‰çš„åè®®ï¼Œå¤šç”¨äºå³æ—¶æ¶ˆæ¯ï¼ˆIMï¼‰ä»¥åŠåœ¨çº¿ç°åœºæ¢æµ‹ã€‚é€‚ç”¨äºæœåŠ¡å™¨ä¹‹é—´çš„å‡†å³æ—¶æ“ä½œã€‚æ ¸å¿ƒæ˜¯åŸºäºXMLæµä¼ è¾“ï¼Œè¿™ä¸ªåè®®å¯èƒ½æœ€ç»ˆå…è®¸å› ç‰¹ç½‘ç”¨æˆ·å‘å› ç‰¹ç½‘ä¸Šçš„å…¶ä»–ä»»ä½•äººå‘é€å³æ—¶æ¶ˆæ¯ï¼Œå³ä½¿å…¶æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨ä¸åŒã€‚\nä¼˜ç‚¹ï¼šé€šç”¨å…¬å¼€ã€å…¼å®¹æ€§å¼ºã€å¯æ‰©å±•ã€å®‰å…¨æ€§é«˜ï¼Œä½† XML ç¼–ç æ ¼å¼å ç”¨å¸¦å®½å¤§\n3.5. åŸºäºTCP/IPè‡ªå®šä¹‰çš„åè®® æœ‰äº›ç‰¹æ®Šæ¡†æ¶ï¼ˆå¦‚ï¼šRedisã€Kafkaã€ZeroMqç­‰ï¼‰æ ¹æ®è‡ªèº«éœ€è¦æœªä¸¥æ ¼éµå¾ª MQ è§„èŒƒï¼Œè€Œæ˜¯åŸºäº TCP\\IP è‡ªè¡Œå°è£…äº†ä¸€å¥—åè®®ï¼Œé€šè¿‡ç½‘ç»œ Socket æ¥å£è¿›è¡Œä¼ è¾“ï¼Œå®ç°äº† MQ çš„åŠŸèƒ½\n4. ä¼˜ç‚¹ 4.1. è§£è€¦ 4.2. å¼‚æ­¥ 4.3. å‰Šå³° 5. ç¼ºç‚¹  ç³»ç»Ÿå¯ç”¨æ€§é™ä½ã€‚åœ¨ç³»ç»Ÿä¸­å¼•å…¥ MQï¼Œé‚£ä¹ˆä¸‡ä¸€ MQ æŒ‚äº†æ€ä¹ˆåŠå‘¢ï¼Ÿä¸€èˆ¬è€Œè¨€ï¼Œå¼•å…¥çš„å¤–éƒ¨ä¾èµ–è¶Šå¤šï¼Œç³»ç»Ÿè¶Šè„†å¼±ï¼Œæ¯ä¸€ä¸ªä¾èµ–å‡ºé—®é¢˜éƒ½ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„å´©æºƒ ç³»ç»Ÿå¤æ‚åº¦æé«˜ã€‚éœ€è¦è€ƒè™‘ MQ çš„å„ç§æƒ…å†µï¼Œæ¯”å¦‚ï¼šæ¶ˆæ¯çš„é‡å¤æ¶ˆè´¹ã€æ¶ˆæ¯ä¸¢å¤±ã€ä¿è¯æ¶ˆæ¯ä¼ é€’çš„é¡ºåºæ€§ç­‰ç­‰ æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚æ¯”å¦‚ A ç³»ç»Ÿå·²ç»ç»™å®¢æˆ·è¿”å›æ“ä½œæˆåŠŸï¼Œè¿™æ—¶å€™æ“ä½œ BC éƒ½æˆåŠŸäº†ï¼Œæ“ä½œ D å´å¤±è´¥äº†ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´  6. F\u0026amp;Q 6.1 å¦‚ä½•ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨ï¼Ÿ 6.1.1 RabbitMQ çš„é«˜å¯ç”¨æ€§ RabbitMQ æœ‰ä¸‰ç§æ¨¡å¼ï¼šå•æœºæ¨¡å¼ã€æ™®é€šé›†ç¾¤æ¨¡å¼ã€é•œåƒé›†ç¾¤æ¨¡å¼ã€‚\n1. å•æœºæ¨¡å¼ æ— é«˜å¯ç”¨ã€‚\n2. æ™®é€šé›†ç¾¤æ¨¡å¼ æ— é«˜å¯ç”¨æ€§ã€‚\næ™®é€šé›†ç¾¤æ¨¡å¼ï¼Œæ„æ€å°±æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ª RabbitMQ å®ä¾‹ï¼Œæ¯ä¸ªæœºå™¨å¯åŠ¨ä¸€ä¸ªã€‚ä½ åˆ›å»ºçš„ queueï¼Œåªä¼šæ”¾åœ¨ä¸€ä¸ª RabbitMQ å®ä¾‹ä¸Šï¼Œä½†æ˜¯æ¯ä¸ªå®ä¾‹éƒ½åŒæ­¥ queue çš„å…ƒæ•°æ®ï¼ˆå…ƒæ•°æ®å¯ä»¥è®¤ä¸ºæ˜¯ queue çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ° queue æ‰€åœ¨å®ä¾‹ï¼‰ã€‚ä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œå®é™…ä¸Šå¦‚æœè¿æ¥åˆ°äº†å¦å¤–ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆé‚£ä¸ªå®ä¾‹ä¼šä» queue æ‰€åœ¨å®ä¾‹ä¸Šæ‹‰å–æ•°æ®è¿‡æ¥ã€‚\nè¿™ç§æ–¹å¼ç¡®å®å¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸æ€ä¹ˆå¥½ï¼Œæ²¡åšåˆ°æ‰€è°“çš„åˆ†å¸ƒå¼ï¼Œå°±æ˜¯ä¸ªæ™®é€šé›†ç¾¤ã€‚å› ä¸ºè¿™å¯¼è‡´ä½ è¦ä¹ˆæ¶ˆè´¹è€…æ¯æ¬¡éšæœºè¿æ¥ä¸€ä¸ªå®ä¾‹ç„¶åæ‹‰å–æ•°æ®ï¼Œè¦ä¹ˆå›ºå®šè¿æ¥é‚£ä¸ª queue æ‰€åœ¨å®ä¾‹æ¶ˆè´¹æ•°æ®ï¼Œå‰è€…æœ‰æ•°æ®æ‹‰å–çš„å¼€é”€ï¼Œåè€…å¯¼è‡´å•å®ä¾‹æ€§èƒ½ç“¶é¢ˆã€‚\nè€Œä¸”å¦‚æœé‚£ä¸ªæ”¾ queue çš„å®ä¾‹å®•æœºäº†ï¼Œä¼šå¯¼è‡´æ¥ä¸‹æ¥å…¶ä»–å®ä¾‹å°±æ— æ³•ä»é‚£ä¸ªå®ä¾‹æ‹‰å–ï¼Œå¦‚æœä½ å¼€å¯äº†æ¶ˆæ¯æŒä¹…åŒ–ï¼Œè®© RabbitMQ è½åœ°å­˜å‚¨æ¶ˆæ¯çš„è¯ï¼Œæ¶ˆæ¯ä¸ä¸€å®šä¼šä¸¢ï¼Œå¾—ç­‰è¿™ä¸ªå®ä¾‹æ¢å¤äº†ï¼Œç„¶åæ‰å¯ä»¥ç»§ç»­ä»è¿™ä¸ª queue æ‹‰å–æ•°æ®ã€‚\næ‰€ä»¥è¿™ä¸ªäº‹å„¿å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œè¿™å°±æ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„é«˜å¯ç”¨æ€§ï¼Œè¿™æ–¹æ¡ˆä¸»è¦æ˜¯æé«˜ååé‡çš„ï¼Œå°±æ˜¯è¯´è®©é›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹æ¥æœåŠ¡æŸä¸ª queue çš„è¯»å†™æ“ä½œã€‚\n3. é•œåƒé›†ç¾¤æ¨¡å¼ æœ‰é«˜å¯ç”¨æ€§ã€‚\nè¿™ç§æ¨¡å¼ï¼Œæ‰æ˜¯æ‰€è°“çš„ RabbitMQ çš„é«˜å¯ç”¨æ¨¡å¼ã€‚è·Ÿæ™®é€šé›†ç¾¤æ¨¡å¼ä¸ä¸€æ ·çš„æ˜¯ï¼Œåœ¨é•œåƒé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä½ åˆ›å»ºçš„ queueï¼Œæ— è®ºå…ƒæ•°æ®è¿˜æ˜¯ queue é‡Œçš„æ¶ˆæ¯éƒ½ä¼šå­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Šï¼Œå°±æ˜¯è¯´ï¼Œæ¯ä¸ª RabbitMQ èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ª queue çš„ä¸€ä¸ªå®Œæ•´é•œåƒï¼ŒåŒ…å« queue çš„å…¨éƒ¨æ•°æ®çš„æ„æ€ã€‚ç„¶åæ¯æ¬¡ä½ å†™æ¶ˆæ¯åˆ° queue çš„æ—¶å€™ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠæ¶ˆæ¯åŒæ­¥åˆ°å¤šä¸ªå®ä¾‹çš„ queue ä¸Šã€‚\nè¿™æ ·çš„è¯ï¼Œå¥½å¤„åœ¨äºï¼Œä½ ä»»ä½•ä¸€ä¸ªæœºå™¨å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œå…¶å®ƒæœºå™¨ï¼ˆèŠ‚ç‚¹ï¼‰è¿˜åŒ…å«äº†è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ï¼Œåˆ«çš„ consumer éƒ½å¯ä»¥åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šå»æ¶ˆè´¹æ•°æ®ã€‚åå¤„åœ¨äºï¼Œç¬¬ä¸€ï¼Œè¿™ä¸ªæ€§èƒ½å¼€é”€ä¹Ÿå¤ªå¤§äº†å§ï¼Œæ¶ˆæ¯éœ€è¦åŒæ­¥åˆ°æ‰€æœ‰æœºå™¨ä¸Šï¼Œå¯¼è‡´ç½‘ç»œå¸¦å®½å‹åŠ›å’Œæ¶ˆè€—å¾ˆé‡ï¼ç¬¬äºŒï¼Œè¿™ä¹ˆç©å„¿ï¼Œä¸æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå°±æ²¡æœ‰æ‰©å±•æ€§å¯è¨€äº†ï¼Œå¦‚æœæŸä¸ª queue è´Ÿè½½å¾ˆé‡ï¼Œä½ åŠ æœºå™¨ï¼Œæ–°å¢çš„æœºå™¨ä¹ŸåŒ…å«äº†è¿™ä¸ª queue çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶æ²¡æœ‰åŠæ³•çº¿æ€§æ‰©å±•ä½ çš„ queueã€‚ä½ æƒ³ï¼Œå¦‚æœè¿™ä¸ª queue çš„æ•°æ®é‡å¾ˆå¤§ï¼Œå¤§åˆ°è¿™ä¸ªæœºå™¨ä¸Šçš„å®¹é‡æ— æ³•å®¹çº³äº†ï¼Œæ­¤æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\n6.1.2 Kafka çš„é«˜å¯ç”¨æ€§ Kafkaæœ‰partitionçš„æ¦‚å¿µï¼Œæ¯ä¸ªtopicå¯ä»¥åˆ’åˆ†ä¸ºå¤šä¸ªpartitionã€‚æ¯ä¸ª partition çš„æ•°æ®éƒ½ä¼šåŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„å…¶å®ƒæœºå™¨ä¸Šï¼Œå½¢æˆè‡ªå·±çš„å¤šä¸ª replica å‰¯æœ¬ã€‚\næ‰€æœ‰ replica ä¼šé€‰ä¸¾ä¸€ä¸ª leader å‡ºæ¥ï¼Œé‚£ä¹ˆç”Ÿäº§å’Œæ¶ˆè´¹éƒ½è·Ÿè¿™ä¸ª leader æ‰“äº¤é“ï¼Œç„¶åå…¶ä»– replica å°±æ˜¯ followerã€‚å†™çš„æ—¶å€™ï¼Œleader ä¼šè´Ÿè´£æŠŠæ•°æ®åŒæ­¥åˆ°æ‰€æœ‰ follower ä¸Šå»ï¼Œè¯»çš„æ—¶å€™å°±ç›´æ¥è¯» leader ä¸Šçš„æ•°æ®å³å¯ã€‚åªèƒ½è¯»å†™ leaderï¼Ÿå¾ˆç®€å•ï¼Œè¦æ˜¯ä½ å¯ä»¥éšæ„è¯»å†™æ¯ä¸ª followerï¼Œé‚£ä¹ˆå°±è¦ care æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œç³»ç»Ÿå¤æ‚åº¦å¤ªé«˜ï¼Œå¾ˆå®¹æ˜“å‡ºé—®é¢˜ã€‚\nå¦‚æœè¿™ä¸ªå®•æœºçš„ broker ä¸Šé¢æœ‰æŸä¸ª partition çš„ leaderï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šä» follower ä¸­é‡æ–°é€‰ä¸¾ä¸€ä¸ªæ–°çš„ leader å‡ºæ¥ï¼Œå¤§å®¶ç»§ç»­è¯»å†™é‚£ä¸ªæ–°çš„ leader å³å¯ã€‚è¿™å°±æœ‰æ‰€è°“çš„é«˜å¯ç”¨æ€§äº†ã€‚\nå†™æ•°æ®çš„æ—¶å€™ï¼Œç”Ÿäº§è€…å°±å†™ leaderï¼Œç„¶å leader å°†æ•°æ®è½åœ°å†™æœ¬åœ°ç£ç›˜ï¼Œæ¥ç€å…¶ä»– follower è‡ªå·±ä¸»åŠ¨ä» leader æ¥ pull æ•°æ®ã€‚ä¸€æ—¦æ‰€æœ‰ follower åŒæ­¥å¥½æ•°æ®äº†ï¼Œå°±ä¼šå‘é€ ack ç»™ leaderï¼Œleader æ”¶åˆ°æ‰€æœ‰ follower çš„ ack ä¹‹åï¼Œå°±ä¼šè¿”å›å†™æˆåŠŸçš„æ¶ˆæ¯ç»™ç”Ÿäº§è€…ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™åªæ˜¯å…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œè¿˜å¯ä»¥é€‚å½“è°ƒæ•´è¿™ä¸ªè¡Œä¸ºï¼‰\næ¶ˆè´¹çš„æ—¶å€™ï¼Œåªä¼šä» leader å»è¯»ï¼Œä½†æ˜¯åªæœ‰å½“ä¸€ä¸ªæ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰ follower éƒ½åŒæ­¥æˆåŠŸè¿”å› ack çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯æ‰ä¼šè¢«æ¶ˆè´¹è€…è¯»åˆ°ã€‚\n6.2 å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿ å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿæˆ–è€…è¯´ï¼Œå¦‚ä½•ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„å¹‚ç­‰æ€§ï¼Ÿ\nä¾‹å¦‚ï¼škafkaæœ‰offsetçš„æ¦‚å¿µï¼Œå¦‚æœæ¶ˆè´¹è€…å·²ç»æ¶ˆè´¹äº†æ¶ˆæ¯ï¼Œä½†æ˜¯è¿˜æ²¡æäº¤å¯¹åº”ä½ç½®offsetçš„æ—¶å€™åº”ç”¨å‘ç”Ÿé‡å¯ï¼Œé‡å¯ä¹‹åç»§ç»­æ¶ˆè´¹å°±æœ‰å¯èƒ½å‘ç”Ÿé‡å¤æ¶ˆè´¹ã€‚\nå†ä¾‹å¦‚ï¼šä¹Ÿæœ‰å¯èƒ½æ˜¯ç”Ÿäº§è€…é‡å¤å‘é€æ¶ˆæ¯å¯¼è‡´é‡å¤æ¶ˆè´¹ï¼Œä¾‹å¦‚ï¼šRabbitMQç”Ÿäº§è€…ä¸ºäº†ä¿è¯æ¶ˆæ¯ä¸è¢«ä¸¢å¤±è€Œå¼€å¯äº†comfirmæ¨¡å¼ï¼Œå¦‚æœç”Ÿäº§è€…æˆåŠŸå‘é€æ¶ˆæ¯ ğŸ‘‰ RabbitMQæˆåŠŸå¤„ç†ä¿å­˜äº†æ¶ˆæ¯ ğŸ‘‰ ä½†æ˜¯å› ä¸ºç½‘ç»œæŠ–åŠ¨ç”Ÿäº§è€…æ²¡æœ‰æ”¶åˆ°RabbitMQçš„å›å¤ack ğŸ‘‰ ç”Ÿäº§è€…é‡å‘æ¶ˆæ¯ ğŸ‘‰ æœ€ç»ˆè¯¥æ¶ˆæ¯å‘äº†ä¸¤æ¬¡ğŸ˜”\nè§£å†³é—®é¢˜çš„æ–¹å¼æœ‰å¦‚ä¸‹ä¸‰ç§æ€è·¯\n å¦‚æœæ¶ˆæ¯æ˜¯åšæ•°æ®åº“çš„æ’å…¥æ“ä½œï¼Œç»™è¿™ä¸ªæ¶ˆæ¯åšä¸€ä¸ªå”¯ä¸€ä¸»é”®ï¼Œé‚£ä¹ˆå°±ç®—å‡ºç°é‡å¤æ¶ˆè´¹çš„æƒ…å†µï¼Œå°±ä¼šå¯¼è‡´ä¸»é”®å†²çªï¼Œé¿å…æ•°æ®åº“å‡ºç°è„æ•°æ® å¦‚æœä½ æ‹¿åˆ°è¿™ä¸ªæ¶ˆæ¯åš Redis çš„ Set çš„æ“ä½œï¼Œä¸ç”¨è§£å†³ï¼Œå› ä¸ºä½ æ— è®º Set å‡ æ¬¡ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼ŒSet æ“ä½œæœ¬æ¥å°±ç®—å¹‚ç­‰æ“ä½œ å¦‚æœä¸Šé¢ä¸¤ç§æƒ…å†µè¿˜ä¸è¡Œï¼Œå‡†å¤‡ä¸€ä¸ªç¬¬ä¸‰æœåŠ¡æ–¹æ¥åšæ¶ˆè´¹è®°å½•ã€‚ä»¥ Redis ä¸ºä¾‹ï¼Œç»™æ¶ˆæ¯åˆ†é…ä¸€ä¸ªå…¨å±€ IDï¼Œåªè¦æ¶ˆè´¹è¿‡è¯¥æ¶ˆæ¯ï¼Œå°† \u0026lt;Id,Message\u0026gt; ä»¥ K-V å½¢å¼å†™å…¥ Redisã€‚é‚£æ¶ˆè´¹è€…å¼€å§‹æ¶ˆè´¹å‰ï¼Œå…ˆå» Redis ä¸­æŸ¥è¯¢æœ‰æ²¡æ¶ˆè´¹è®°å½•å³å¯  6.3 å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿ å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿæˆ–è€…è¯´ï¼Œå¦‚ä½•å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼Ÿ\n6.3.1 RabbitMQ 1. ç”Ÿäº§è€…å¼„ä¸¢äº†æ•°æ® äº‹åŠ¡ æˆ–è€… confirmæœºåˆ¶\n2. RabbitMQ å¼„ä¸¢äº†æ•°æ® å¼€å¯ RabbitMQ çš„æŒä¹…åŒ–ï¼ŒæŒä¹…åŒ–å¯ä»¥è·Ÿç”Ÿäº§è€…é‚£è¾¹çš„ confirm æœºåˆ¶é…åˆèµ·æ¥ï¼Œåªæœ‰æ¶ˆæ¯è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹åï¼Œæ‰ä¼šé€šçŸ¥ç”Ÿäº§è€… ack äº†ï¼Œæ‰€ä»¥å“ªæ€•æ˜¯åœ¨æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹å‰ï¼ŒRabbitMQ æŒ‚äº†ï¼Œæ•°æ®ä¸¢äº†ï¼Œç”Ÿäº§è€…æ”¶ä¸åˆ° ack ï¼Œä½ ä¹Ÿæ˜¯å¯ä»¥è‡ªå·±é‡å‘çš„ã€‚\n3. æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ® å…³é—­ RabbitMQ çš„è‡ªåŠ¨ ack ï¼Œç„¶åæ¯æ¬¡ä½ è‡ªå·±ä»£ç é‡Œç¡®ä¿å¤„ç†å®Œçš„æ—¶å€™ï¼Œå†åœ¨ç¨‹åºé‡Œ ack ä¸€æŠŠã€‚è¿™æ ·çš„è¯ï¼Œå¦‚æœä½ è¿˜æ²¡å¤„ç†å®Œï¼Œä¸å°±æ²¡æœ‰ ack äº†ï¼Ÿé‚£ RabbitMQ å°±è®¤ä¸ºä½ è¿˜æ²¡å¤„ç†å®Œï¼Œè¿™ä¸ªæ—¶å€™ RabbitMQ ä¼šæŠŠè¿™ä¸ªæ¶ˆè´¹åˆ†é…ç»™åˆ«çš„ consumer å»å¤„ç†ï¼Œæ¶ˆæ¯æ˜¯ä¸ä¼šä¸¢çš„ã€‚\n6.3.2 Kafka 1. æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ® è·ŸRabbitMQ å·®ä¸å¤šï¼Œå…³é—­è‡ªåŠ¨æäº¤offsetã€‚\n2. Kafka å¼„ä¸¢äº†æ•°æ® partition follower è¿˜æœ‰äº›æ•°æ®æ²¡æœ‰åŒæ­¥ï¼Œç»“æœæ­¤æ—¶ leader æŒ‚äº†ï¼Œç„¶åé€‰ä¸¾æŸä¸ª follower æˆ leader ä¹‹åï¼Œä¸å°±å°‘äº†ä¸€äº›æ•°æ®ï¼Ÿ\næ­¤æ—¶ä¸€èˆ¬æ˜¯è¦æ±‚èµ·ç è®¾ç½®å¦‚ä¸‹ 4 ä¸ªå‚æ•°ï¼š\n ç»™ topic è®¾ç½® replication.factor å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¦æ±‚æ¯ä¸ª partition å¿…é¡»æœ‰è‡³å°‘ 2 ä¸ªå‰¯æœ¬ã€‚ åœ¨ Kafka æœåŠ¡ç«¯è®¾ç½® min.insync.replicas å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¿™ä¸ªæ˜¯è¦æ±‚ä¸€ä¸ª leader è‡³å°‘æ„ŸçŸ¥åˆ°æœ‰è‡³å°‘ä¸€ä¸ª follower è¿˜è·Ÿè‡ªå·±ä¿æŒè”ç³»ï¼Œæ²¡æ‰é˜Ÿï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ leader æŒ‚äº†è¿˜æœ‰ä¸€ä¸ª follower å§ã€‚ åœ¨ producer ç«¯è®¾ç½® acks=all ï¼šè¿™ä¸ªæ˜¯è¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯å†™å…¥æ‰€æœ‰ replica ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºæ˜¯å†™æˆåŠŸäº†ã€‚ åœ¨ producer ç«¯è®¾ç½® retries=MAX ï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ï¼šè¿™ä¸ªæ˜¯è¦æ±‚ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚  3. ç”Ÿäº§è€…ä¼šä¸ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ å¦‚æœæŒ‰ç…§ä¸Šè¿°çš„æ€è·¯è®¾ç½®äº† acks=all ï¼Œä¸€å®šä¸ä¼šä¸¢ï¼Œè¦æ±‚æ˜¯ï¼Œä½ çš„ leader æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€æœ‰çš„ follower éƒ½åŒæ­¥åˆ°äº†æ¶ˆæ¯ä¹‹åï¼Œæ‰è®¤ä¸ºæœ¬æ¬¡å†™æˆåŠŸäº†ã€‚å¦‚æœæ²¡æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç”Ÿäº§è€…ä¼šè‡ªåŠ¨ä¸æ–­çš„é‡è¯•ï¼Œé‡è¯•æ— é™æ¬¡ã€‚\n6.4 å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ Rabbitmqï¼š\n ä¸€ä¸ª Queueï¼Œä¸€ä¸ª Consumerï¼Œå†…éƒ¨å•çº¿ç¨‹æ¶ˆè´¹ï¼Œå•çº¿ç¨‹ååé‡å¤ªä½ï¼Œä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªï¼› æ‹†åˆ†å¤šä¸ª Queueï¼Œç”Ÿäº§è€…æŠŠç›¸åŒçš„keyæ¶ˆæ¯æ”¾å…¥åŒä¸€ä¸ªQueueï¼Œæ¯ä¸ª Queueä¸€ä¸ª Consumerï¼Œå°±æ˜¯å¤šä¸€äº› Queue è€Œå·²ï¼Œç¡®å®æ˜¯éº»çƒ¦ç‚¹ï¼› æˆ–è€…å°±ä¸€ä¸ª Queue ä½†æ˜¯å¯¹åº”ä¸€ä¸ª Consumerï¼ŒConsumeræŠŠç›¸åŒçš„keyæ¶ˆæ¯æ”¾å…¥å†…å­˜ queueï¼Œæ¯ä¸ªå†…å­˜ queueå¯¹åº”ä¸€ä¸ªWorkerçº¿ç¨‹ ç¬¬2ç¬¬3ç»“åˆä½¿ç”¨  Kafkaï¼š\n  ä¸€ä¸ª Topicï¼Œä¸€ä¸ª Partitionï¼Œä¸€ä¸ª Consumerï¼Œå†…éƒ¨å•çº¿ç¨‹æ¶ˆè´¹ï¼Œå•çº¿ç¨‹ååé‡å¤ªä½ï¼Œä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªï¼›\n  ç”Ÿäº§è€…æŠŠç›¸åŒçš„keyæ¶ˆæ¯æ”¾å…¥åŒä¸€ä¸ªKafka Partitionï¼Œæ¯ä¸ªPartitionå¯¹åº”ä¸€ä¸ªConsumerï¼ŒConsumeræŠŠç›¸åŒçš„keyæ¶ˆæ¯æ”¾å…¥å†…å­˜ queueï¼Œæ¯ä¸ªå†…å­˜ queueå¯¹åº”ä¸€ä¸ªWorkerçº¿ç¨‹\n  6.5 å¦‚ä½•è®¾è®¡æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ  æ”¯æŒå¯ä¼¸ç¼©æ€§ï¼Œå‚ç…§ä¸€ä¸‹ kafka çš„è®¾è®¡ç†å¿µï¼Œbroker -\u0026gt; topic -\u0026gt; partitionï¼Œæ¯ä¸ª partition æ”¾ä¸€ä¸ªæœºå™¨ï¼Œå°±å­˜ä¸€éƒ¨åˆ†æ•°æ®ã€‚å¦‚æœç°åœ¨èµ„æºä¸å¤Ÿäº†ï¼Œç®€å•å•Šï¼Œç»™ topic å¢åŠ  partitionï¼Œç„¶ååšæ•°æ®è¿ç§»ï¼Œå¢åŠ æœºå™¨ï¼Œä¸å°±å¯ä»¥å­˜æ”¾æ›´å¤šæ•°æ®ï¼Œæä¾›æ›´é«˜çš„ååé‡äº†ï¼Ÿ ä¿è¯æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼ŒæŒä¹…åŒ–ã€é¡ºåºå†™ï¼›ä¸ç”Ÿäº§è€…é…åˆï¼Œæ”¯æŒæ¶ˆæ¯å‘ç”Ÿ äº‹åŠ¡ æˆ– comfirm æœºåˆ¶ï¼Œè¾¾åˆ°æ•°æ® 0 ä¸¢å¤±ã€‚ é«˜å¯ç”¨ï¼Œé›†ç¾¤æ¨¡å¼ï¼Œå°‘æ•°brokeræŒ‚æ‰äº†ï¼ŒMQè¿˜èƒ½ç»§ç»­å·¥ä½œã€‚å‚è€ƒkafka çš„é«˜å¯ç”¨ä¿éšœæœºåˆ¶ï¼Œå¤šå‰¯æœ¬ -\u0026gt; leader \u0026amp; follower -\u0026gt; broker æŒ‚äº†é‡æ–°é€‰ä¸¾ leader å³å¯å¯¹å¤–æœåŠ¡ã€‚  6.6 æ•°æ®æ˜¯é€šè¿‡ Push è¿˜æ˜¯ Pull æ–¹å¼ç»™åˆ°æ¶ˆè´¹ç«¯ï¼Œå„è‡ªæœ‰ä»€ä¹ˆå¼Šç«¯  Push æ¨¡å‹å®æ—¶æ€§å¥½ï¼Œä½†æ˜¯å› ä¸ºçŠ¶æ€ç»´æŠ¤ç­‰é—®é¢˜ï¼Œéš¾ä»¥åº”ç”¨åˆ°æ¶ˆæ¯ä¸­é—´ä»¶çš„å®è·µä¸­ï¼Œå› ä¸ºåœ¨ Broker ç«¯éœ€è¦ç»´æŠ¤ Consumer çš„çŠ¶æ€ï¼Œä¸å¥½é€‚ç”¨äº Broker å»æ”¯æŒå¤§é‡çš„ Consumer çš„åœºæ™¯ Consumer çš„æ¶ˆè´¹é€Ÿåº¦æ˜¯ä¸ä¸€è‡´çš„ï¼ŒBroker è¿›è¡Œæ¨é€éš¾ä»¥å¤„ç†ä¸åŒçš„ Consumer çš„çŠ¶å†µï¼ŒBroker éš¾ä»¥åº”å¯¹ Consumer æ— æ³•æ¶ˆè´¹æ¶ˆæ¯çš„æƒ…å†µï¼Œå› ä¸ºä¸çŸ¥é“ Consumer çš„å®•æœºæ˜¯çŸ­æš‚çš„è¿˜æ˜¯æ°¸ä¹…çš„ï¼Œå¦å¤–æ¨é€æ¶ˆæ¯ï¼ˆé‡å¯èƒ½ä¼šå¾ˆå¤§ï¼‰ä¹Ÿä¼šåŠ é‡ Consumer çš„è´Ÿè½½æˆ–è€…å‹å® Consumerï¼Œå¦‚æœå¯¹åº”åªæœ‰ 1 ä¸ª Consumerï¼Œç”¨ Push æ¯” Pull å¥½ Pull æ¨¡å¼å®ç°èµ·æ¥ä¼šç›¸å¯¹ç®€å•ä¸€äº›ï¼Œä½†æ˜¯å®æ—¶æ€§å–å†³äºè½®è®­çš„é¢‘ç‡ï¼Œåœ¨å¯¹å®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ä¸é€‚åˆä½¿ç”¨  7. å¯¹æ¯”    ç‰¹æ€§ ActiveMQ RabbitMQ RocketMQ Kafka     å•æœºååé‡ ä¸‡çº§ï¼Œååé‡æ¯”RocketMQå’ŒKafkaè¦ä½ä¸€ä¸ªæ•°é‡çº§ ä¸‡çº§ï¼Œååé‡æ¯”RocketMQå’ŒKafkaè¦ä½ä¸€ä¸ªæ•°é‡çº§ åä¸‡çº§ï¼ŒRocketMQä¹Ÿæ˜¯å¯ä»¥æ”¯æ’‘é«˜ååçš„ä¸€ç§MQ åä¸‡çº§åˆ«ï¼ŒKafkaæœ€å¤§ä¼˜ç‚¹å°±æ˜¯ååé‡å¤§ï¼Œä¸€èˆ¬é…åˆå¤§æ•°æ®ç±»çš„ç³»ç»Ÿæ¥è¿›è¡Œå®æ—¶æ•°æ®è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯   Topicæ•°é‡å¯¹ååé‡çš„å½±å“ - - Topicå¯ä»¥è¾¾åˆ°å‡ ç™¾ã€å‡ åƒä¸ªçš„çº§åˆ«ï¼Œååé‡ä¼šæœ‰å°å¹…åº¦çš„ä¸‹é™ã€‚è¿™æ˜¯RocketMQçš„ä¸€å¤§ä¼˜åŠ¿ï¼Œå¯åœ¨åŒç­‰æ•°é‡æœºå™¨ä¸‹æ”¯æ’‘å¤§é‡çš„Topic Topicä»å‡ åä¸ªåˆ°å‡ ç™¾ä¸ªçš„æ—¶å€™ï¼Œååé‡ä¼šå¤§å¹…ä¸‹é™ã€‚æ‰€ä»¥åœ¨åŒç­‰æœºå™¨æ•°é‡ä¸‹ï¼ŒKafkaå°½é‡ä¿è¯Topicæ•°é‡ä¸è¦è¿‡å¤šã€‚å¦‚æœæ”¯æ’‘å¤§è§„æ¨¡Topicéœ€è¦å¢åŠ æ›´å¤šçš„æœºå™¨   æ—¶æ•ˆæ€§ msçº§ å¾®ç§’çº§ï¼Œè¿™æ˜¯rabbitmqçš„ä¸€å¤§ç‰¹ç‚¹ï¼Œå»¶è¿Ÿæ˜¯æœ€ä½çš„ msçº§ å»¶è¿Ÿåœ¨msçº§ä»¥å†…   å¯ç”¨æ€§ é«˜ï¼ŒåŸºäºä¸»ä»æ¶æ„å®ç°å¯ç”¨æ€§ é«˜ï¼ŒåŸºäºä¸»ä»æ¶æ„å®ç°å¯ç”¨æ€§ éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼æ¶æ„ éå¸¸é«˜ï¼ŒKafkaæ˜¯åˆ†å¸ƒå¼çš„ï¼Œä¸€ä¸ªæ•°æ®å¤šä¸ªå‰¯æœ¬ï¼Œå°‘æ•°æœºå™¨å®•æœºï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œä¸ä¼šå¯¼è‡´ä¸å¯ç”¨   æ¶ˆæ¯å¯é æ€§ æœ‰è¾ƒä½çš„æ¦‚ç‡ä¸¢å¤±æ•°æ® - ç»è¿‡å‚æ•°ä¼˜åŒ–é…ç½®ï¼Œå¯ä»¥åšåˆ°é›¶ä¸¢å¤± ç»è¿‡å‚æ•°é…ç½®ï¼Œæ¶ˆæ¯å¯ä»¥åšåˆ°é›¶ä¸¢å¤±   åŠŸèƒ½æ”¯æŒ MQé¢†åŸŸçš„åŠŸèƒ½åŠå…¶å®Œå¤‡ åŸºäºerlangå¼€å‘ï¼Œæ‰€ä»¥å¹¶å‘æ€§èƒ½æå¼ºï¼Œæ€§èƒ½æå¥½ï¼Œå»¶æ—¶ä½ MQåŠŸèƒ½è¾ƒä¸ºå®Œå¤‡ï¼Œåˆ†å¸ƒå¼æ‰©å±•æ€§å¥½ åŠŸèƒ½è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ”¯æŒåŠ å•MQåŠŸèƒ½   ä¼˜åŠ¿ éå¸¸æˆç†Ÿï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œåœ¨ä¸šå†…å¤§é‡å…¬å¸å’Œé¡¹ç›®ä¸­éƒ½æœ‰åº”ç”¨ erlangè¯­è¨€å¼€å‘ï¼Œæ€§èƒ½æå¥½ã€å»¶æ—¶å¾ˆä½ï¼Œååé‡ä¸‡çº§ã€MQåŠŸèƒ½å®Œå¤‡ï¼Œç®¡ç†ç•Œé¢éå¸¸å¥½ï¼Œç¤¾åŒºæ´»è·ƒï¼›äº’è”ç½‘å…¬å¸ä½¿ç”¨è¾ƒå¤š æ¥å£ç®€å•æ˜“ç”¨ï¼Œé˜¿é‡Œå‡ºå“æœ‰ä¿éšœï¼Œååé‡å¤§ï¼Œåˆ†å¸ƒå¼æ‰©å±•æ–¹ä¾¿ã€ç¤¾åŒºæ¯”è¾ƒæ´»è·ƒï¼Œæ”¯æŒå¤§è§„æ¨¡çš„Topicã€æ”¯æŒå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥åŸºäºæºç è¿›è¡Œå®šåˆ¶å¼€å‘ è¶…é«˜ååé‡ï¼Œmsçº§çš„æ—¶å»¶ï¼Œæé«˜çš„å¯ç”¨æ€§å’Œå¯é æ€§ï¼Œåˆ†å¸ƒå¼æ‰©å±•æ–¹ä¾¿   åŠ£åŠ¿ å¶å°”æœ‰è¾ƒä½æ¦‚ç‡ä¸¢å¤±æ¶ˆæ¯ï¼Œç¤¾åŒºæ´»è·ƒåº¦ä¸é«˜ ååé‡è¾ƒä½ï¼Œerlangè¯­éŸ³å¼€å‘ä¸å®¹æ˜“è¿›è¡Œå®šåˆ¶å¼€å‘ï¼Œé›†ç¾¤åŠ¨æ€æ‰©å±•éº»çƒ¦ æ¥å£ä¸æ˜¯æŒ‰ç…§æ ‡å‡†JMSè§„èŒƒèµ°çš„ï¼Œæœ‰çš„ç³»ç»Ÿè¿ç§»è¦ä¿®æ”¹å¤§é‡çš„ä»£ç ï¼ŒæŠ€æœ¯æœ‰è¢«æŠ›å¼ƒçš„é£é™© æœ‰å¯èƒ½è¿›è¡Œæ¶ˆæ¯çš„é‡å¤æ¶ˆè´¹   åº”ç”¨ ä¸»è¦ç”¨äºè§£è€¦å’Œå¼‚æ­¥ï¼Œè¾ƒå°‘ç”¨åœ¨å¤§è§„æ¨¡ååçš„åœºæ™¯ä¸­ éƒ½æœ‰ä½¿ç”¨ ç”¨äºå¤§è§„æ¨¡ååã€å¤æ‚ä¸šåŠ¡ä¸­ åœ¨å¤§æ•°æ®çš„å®æ—¶è®¡ç®—å’Œæ—¥å¿—é‡‡é›†ä¸­è¢«å¤§è§„æ¨¡ä½¿ç”¨ï¼Œæ˜¯ä¸šç•Œçš„æ ‡å‡†    å‚è€ƒ MQäº†è§£åŠå¯¹æ¯”é€‰å‹\radvanced-java\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mq/mq%E7%BB%BC%E8%BF%B0/","series":["Manual"],"tags":["MQ"],"title":"MQç»¼è¿°"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1.ä»‹ç» Integerç±»å‹ï¼Œå³æ•´æ•°ç±»å‹ï¼ŒMySQLæ”¯æŒçš„æ•´æ•°ç±»å‹æœ‰TINYINTã€SMALLINTã€MEDIUMINTã€INTã€BIGINTã€‚\n1.1 ç©ºé—´å’ŒèŒƒå›´ æ¯ç§æ•´æ•°ç±»å‹æ‰€éœ€çš„å­˜å‚¨ç©ºé—´å’ŒèŒƒå›´å¦‚ä¸‹ï¼š\n   ç±»å‹ å­—èŠ‚ æœ€å°å€¼(æœ‰ç¬¦å·) æœ€å¤§å€¼(æœ‰ç¬¦å·) æœ€å°å€¼(æ— ç¬¦å·) æœ€å¤§å€¼(æ— ç¬¦å·)     TINYINT 1 -128 127 0 255   SMALLINT 2 -32768 32767 0 65535   MEDIUMINT 3 -8388608 8388607 0 16777215   INT 4 -2147483648 2147483647 0 4294967295   BIGINT 8 $-2^{63}$(-9223372036854775808) $2^{63}-1$(9223372036854775807) 0 $2^{64}-1$(18446744073709551615)    2. INT(11) 2.1 æ•°å­—æ˜¯å¦é™åˆ¶é•¿åº¦ï¼Ÿ id INT(11) NOT NULL AUTO_INCREMENT, åœ¨ä¸€äº›å»ºè¡¨è¯­å¥ä¼šå‡ºç°ä¸Šé¢ int(11) çš„ç±»å‹ï¼Œé‚£ä¹ˆå…¶ä»£è¡¨ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\nå¯¹äºIntegerç±»å‹æ‹¬å·ä¸­çš„æ•°å­—ç§°ä¸ºå­—æ®µçš„æ˜¾ç¤ºå®½åº¦ã€‚è¿™ä¸å…¶ä»–ç±»å‹å­—æ®µçš„å«ä¹‰ä¸åŒã€‚å¯¹äºDECIMALç±»å‹ï¼Œè¡¨ç¤ºæ•°å­—çš„æ€»æ•°ã€‚å¯¹äºå­—ç¬¦å­—æ®µï¼Œè¿™æ˜¯å¯ä»¥å­˜å‚¨çš„æœ€å¤§å­—ç¬¦æ•°ï¼Œä¾‹å¦‚VARCHARï¼ˆ20ï¼‰å¯ä»¥å­˜å‚¨20ä¸ªå­—ç¬¦ã€‚\næ˜¾ç¤ºå®½åº¦å¹¶ä¸å½±å“å¯ä»¥å­˜å‚¨åœ¨è¯¥åˆ—ä¸­çš„æœ€å¤§å€¼ã€‚INT(5) å’Œ INT(11)å¯ä»¥å­˜å‚¨ç›¸åŒçš„æœ€å¤§å€¼ã€‚å“ªæ€•è®¾ç½®æˆ INT(20) å¹¶ä¸æ„å‘³ç€å°†èƒ½å¤Ÿå­˜å‚¨20ä½æ•°å­—(BIGINT)ï¼Œè¯¥åˆ—è¿˜æ˜¯åªèƒ½å­˜å‚¨INTçš„æœ€å¤§å€¼ã€‚\nç¤ºä¾‹ åˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ï¼š\nCREATE TEMPORARY TABLE demo_a ( id INT(11) NOT NULL AUTO_INCREMENT, a INT(1) NOT NULL, b INT(5) NOT NULL, PRIMARY KEY (`id`) ) æ’å…¥è¶…è¿‡\u0026quot;é•¿åº¦\u0026quot;çš„æ•°å­—ï¼š\nINSERT INTO demo_a(a,b) VALUES(255, 88888888); æŸ¥çœ‹ç»“æœï¼šå‘ç°æ•°å­—å¹¶ä¸æ˜¯è®¾ç½®é•¿åº¦\nmysql\u0026gt; SELECT * FROM demo_a; +----+-----+----------+ | id | a | b | +----+-----+----------+ | 1 | 255 | 88888888 | +----+-----+----------+ 1 row in set (0.03 sec) 2.2 æ•°å­—è¡¨è¾¾ä»€ä¹ˆæ„æ€ï¼Ÿ å½“åˆ—è®¾ç½®ä¸ºUNSIGNED ZEROFILLæ—¶ï¼ŒINT(11)æ‰æœ‰æ„ä¹‰ï¼Œå…¶è¡¨ç¤ºçš„æ„æ€ä¸ºå¦‚æœè¦å­˜å‚¨çš„æ•°å­—å°‘äº11ä¸ªå­—ç¬¦ï¼Œåˆ™è¿™äº›æ•°å­—å°†åœ¨å·¦ä¾§è¡¥é›¶ã€‚\næ³¨æ„ï¼šZEROFILLé»˜è®¤çš„åˆ—ä¸ºæ— ç¬¦å·ï¼Œå› æ­¤ä¸èƒ½å­˜å‚¨è´Ÿæ•°ã€‚\nç¤ºä¾‹ åˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ï¼šbåˆ—è®¾ç½®ä¸ºUNSIGNED ZEROFILL\nCREATE TEMPORARY TABLE demo_a ( id INT(11) NOT NULL AUTO_INCREMENT, a INT(11) NOT NULL, b INT(11) UNSIGNED ZEROFILL NOT NULL, PRIMARY KEY (`id`) ); æ’å…¥æ•°å€¼ï¼š\nINSERT INTO demo_a(a,b) VALUES(1, 1); ç»“æœï¼šbåˆ—çš„å·¦ä¾§ä½¿ç”¨äº†0å¡«å……é•¿åº¦\nmysql\u0026gt; SELECT * FROM demo_a; +----+---+-------------+ | id | a | b | +----+---+-------------+ | 1 | 1 | 00000000001 | +----+---+-------------+ 1 row in set (0.18 sec) å‚è€ƒé“¾æ¥ğŸ”— MySQL Integerç±»å‹ä¸INT(11)\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mysql/mysql-integer%E7%B1%BB%E5%9E%8B%E4%B8%8Eint11/","series":["Manual"],"tags":["MySQL"],"title":"MySQL Integerç±»å‹ä¸INT(11)"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‚è€ƒ MySQL å‰ç¼€ç´¢å¼•\rå‰ç¼€ç´¢å¼•ï¼Œä¸€ç§ä¼˜åŒ–ç´¢å¼•å¤§å°çš„è§£å†³æ–¹æ¡ˆ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mysql/mysql%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95/","series":["Manual"],"tags":["MySQL"],"title":"MySQLå‰ç¼€ç´¢å¼•"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"æ—¥å¿—æ˜¯mysqlæ•°æ®åº“çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè®°å½•ç€æ•°æ®åº“è¿è¡ŒæœŸé—´å„ç§çŠ¶æ€ä¿¡æ¯ã€‚mysqlæ—¥å¿—ä¸»è¦åŒ…æ‹¬é”™è¯¯æ—¥å¿—ã€æŸ¥è¯¢æ—¥å¿—ã€æ…¢æŸ¥è¯¢æ—¥å¿—ã€äº‹åŠ¡æ—¥å¿—ã€äºŒè¿›åˆ¶æ—¥å¿—å‡ å¤§ç±»ã€‚ä½œä¸ºå¼€å‘ï¼Œæˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯äºŒè¿›åˆ¶æ—¥å¿—(binlog)å’Œäº‹åŠ¡æ—¥å¿—(åŒ…æ‹¬redo logå’Œundo log)ï¼Œæœ¬æ–‡æ¥ä¸‹æ¥ä¼šè¯¦ç»†ä»‹ç»è¿™ä¸‰ç§æ—¥å¿—ã€‚å…¶ä»–å‡ ç§æ—¥å¿—è§ ğŸ‘‰ [ç©è½¬MySQLä¹‹å…«]MySQLæ—¥å¿—åˆ†ç±»åŠç®€ä»‹\r1. binlog binlogç”¨äºè®°å½•æ•°æ®åº“æ‰§è¡Œçš„å†™å…¥æ€§æ“ä½œ(ä¸åŒ…æ‹¬æŸ¥è¯¢)ä¿¡æ¯ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼ä¿å­˜åœ¨ç£ç›˜ä¸­ã€‚binlogæ˜¯mysqlçš„é€»è¾‘æ—¥å¿—ï¼Œå¹¶ä¸”ç”±Serverå±‚è¿›è¡Œè®°å½•ï¼Œä½¿ç”¨ä»»ä½•å­˜å‚¨å¼•æ“çš„mysqlæ•°æ®åº“éƒ½ä¼šè®°å½•binlogæ—¥å¿—ã€‚\n é€»è¾‘æ—¥å¿—ï¼šå¯ä»¥ç®€å•ç†è§£ä¸ºè®°å½•çš„å°±æ˜¯sqlè¯­å¥ã€‚\n  ç‰©ç†æ—¥å¿—ï¼šå› ä¸ºmysqlæ•°æ®æœ€ç»ˆæ˜¯ä¿å­˜åœ¨æ•°æ®é¡µä¸­çš„ï¼Œç‰©ç†æ—¥å¿—è®°å½•çš„å°±æ˜¯æ•°æ®é¡µå˜æ›´ã€‚\n binlogæ˜¯é€šè¿‡è¿½åŠ çš„æ–¹å¼è¿›è¡Œå†™å…¥çš„ï¼Œå¯ä»¥é€šè¿‡max_binlog_sizeå‚æ•°è®¾ç½®æ¯ä¸ªbinlogæ–‡ä»¶çš„å¤§å°ï¼Œå½“æ–‡ä»¶å¤§å°è¾¾åˆ°ç»™å®šå€¼ä¹‹åï¼Œä¼šç”Ÿæˆæ–°çš„æ–‡ä»¶æ¥ä¿å­˜æ—¥å¿—ã€‚\n1.1 binlogä½¿ç”¨åœºæ™¯ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œbinlogçš„ä¸»è¦ä½¿ç”¨åœºæ™¯æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ä¸»ä»å¤åˆ¶å’Œæ•°æ®æ¢å¤ã€‚\n ä¸»ä»å¤åˆ¶ï¼šåœ¨Masterç«¯å¼€å¯binlogï¼Œç„¶åå°†binlogå‘é€åˆ°å„ä¸ªSlaveç«¯ï¼ŒSlaveç«¯é‡æ”¾binlogä»è€Œè¾¾åˆ°ä¸»ä»æ•°æ®ä¸€è‡´ã€‚ æ•°æ®æ¢å¤ï¼šé€šè¿‡ä½¿ç”¨mysqlbinlogå·¥å…·æ¥æ¢å¤æ•°æ®ã€‚  1.2 binlogåˆ·ç›˜æ—¶æœº å¯¹äºInnoDBå­˜å‚¨å¼•æ“è€Œè¨€ï¼Œåªæœ‰åœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šè®°å½•biglogï¼Œæ­¤æ—¶è®°å½•è¿˜åœ¨å†…å­˜ä¸­ï¼Œé‚£ä¹ˆbiglogæ˜¯ä»€ä¹ˆæ—¶å€™åˆ·åˆ°ç£ç›˜ä¸­çš„å‘¢ï¼Ÿmysqlé€šè¿‡sync_binlogå‚æ•°æ§åˆ¶biglogçš„åˆ·ç›˜æ—¶æœºï¼Œå–å€¼èŒƒå›´æ˜¯0-Nï¼š\n 0ï¼šä¸å»å¼ºåˆ¶è¦æ±‚ï¼Œç”±ç³»ç»Ÿè‡ªè¡Œåˆ¤æ–­ä½•æ—¶å†™å…¥ç£ç›˜ï¼› 1ï¼šæ¯æ¬¡commitçš„æ—¶å€™éƒ½è¦å°†binlogå†™å…¥ç£ç›˜ï¼› Nï¼šæ¯Nä¸ªäº‹åŠ¡ï¼Œæ‰ä¼šå°†binlogå†™å…¥ç£ç›˜ã€‚  ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œsync_binlogæœ€å®‰å…¨çš„æ˜¯è®¾ç½®æ˜¯1ï¼Œè¿™ä¹Ÿæ˜¯MySQL 5.7.7ä¹‹åç‰ˆæœ¬çš„é»˜è®¤å€¼ã€‚ä½†æ˜¯è®¾ç½®ä¸€ä¸ªå¤§ä¸€äº›çš„å€¼å¯ä»¥æå‡æ•°æ®åº“æ€§èƒ½ï¼Œå› æ­¤å®é™…æƒ…å†µä¸‹ä¹Ÿå¯ä»¥å°†å€¼é€‚å½“è°ƒå¤§ï¼Œç‰ºç‰²ä¸€å®šçš„ä¸€è‡´æ€§æ¥è·å–æ›´å¥½çš„æ€§èƒ½ã€‚\n1.3 binlogæ—¥å¿—æ ¼å¼ binlogæ—¥å¿—æœ‰ä¸‰ç§æ ¼å¼ï¼Œåˆ†åˆ«ä¸ºSTATMENTã€ROWå’ŒMIXEDã€‚\n åœ¨ MySQL 5.7.7ä¹‹å‰ï¼Œé»˜è®¤çš„æ ¼å¼æ˜¯STATEMENTï¼ŒMySQL 5.7.7ä¹‹åï¼Œé»˜è®¤å€¼æ˜¯ROWã€‚æ—¥å¿—æ ¼å¼é€šè¿‡binlog-formatæŒ‡å®šã€‚\n  STATMENT åŸºäºSQLè¯­å¥çš„å¤åˆ¶(statement-based replication, SBR)ï¼Œæ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqlè¯­å¥ä¼šè®°å½•åˆ°binlogä¸­ã€‚ ä¼˜ç‚¹ï¼šä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº†binlogæ—¥å¿—é‡ï¼ŒèŠ‚çº¦äº†IO, ä»è€Œæé«˜äº†æ€§èƒ½ï¼› ç¼ºç‚¹ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ¯”å¦‚æ‰§è¡Œsysdate()ã€slepp()ç­‰ã€‚ ROW åŸºäºè¡Œçš„å¤åˆ¶(row-based replication, RBR)ï¼Œä¸è®°å½•æ¯æ¡sqlè¯­å¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»…éœ€è®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹äº†ã€‚ ä¼˜ç‚¹ï¼šä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹çš„å­˜å‚¨è¿‡ç¨‹ã€æˆ–functionã€æˆ–triggerçš„è°ƒç”¨å’Œè§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜ï¼› ç¼ºç‚¹ï¼šä¼šäº§ç”Ÿå¤§é‡çš„æ—¥å¿—ï¼Œå°¤å…¶æ˜¯alter tableçš„æ—¶å€™ä¼šè®©æ—¥å¿—æš´æ¶¨ MIXED åŸºäºSTATMENTå’ŒROWä¸¤ç§æ¨¡å¼çš„æ··åˆå¤åˆ¶(mixed-based replication, MBR)ï¼Œä¸€èˆ¬çš„å¤åˆ¶ä½¿ç”¨STATEMENTæ¨¡å¼ä¿å­˜binlogï¼Œå¯¹äºSTATEMENTæ¨¡å¼æ— æ³•å¤åˆ¶çš„æ“ä½œä½¿ç”¨ROWæ¨¡å¼ä¿å­˜binlog  2. redo log 2.1 ä¸ºä»€ä¹ˆéœ€è¦redo log æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œäº‹åŠ¡çš„å››å¤§ç‰¹æ€§é‡Œé¢æœ‰ä¸€ä¸ªæ˜¯æŒä¹…æ€§ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯åªè¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“åšçš„ä¿®æ”¹å°±è¢«æ°¸ä¹…ä¿å­˜ä¸‹æ¥äº†ï¼Œä¸å¯èƒ½å› ä¸ºä»»ä½•åŸå› å†å›åˆ°åŸæ¥çš„çŠ¶æ€ã€‚é‚£ä¹ˆmysqlæ˜¯å¦‚ä½•ä¿è¯æŒä¹…æ€§çš„å‘¢ï¼Ÿæœ€ç®€å•çš„åšæ³•æ˜¯åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°†è¯¥äº‹åŠ¡æ¶‰åŠä¿®æ”¹çš„æ•°æ®é¡µå…¨éƒ¨åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯è¿™ä¹ˆåšä¼šæœ‰ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š\n å› ä¸ºInnodbæ˜¯ä»¥é¡µä¸ºå•ä½è¿›è¡Œç£ç›˜äº¤äº’çš„ï¼Œè€Œä¸€ä¸ªäº‹åŠ¡å¾ˆå¯èƒ½åªä¿®æ”¹ä¸€ä¸ªæ•°æ®é¡µé‡Œé¢çš„å‡ ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªæ—¶å€™å°†å®Œæ•´çš„æ•°æ®é¡µåˆ·åˆ°ç£ç›˜çš„è¯ï¼Œå¤ªæµªè´¹èµ„æºäº†ï¼ ä¸€ä¸ªäº‹åŠ¡å¯èƒ½æ¶‰åŠä¿®æ”¹å¤šä¸ªæ•°æ®é¡µï¼Œå¹¶ä¸”è¿™äº›æ•°æ®é¡µåœ¨ç‰©ç†ä¸Šå¹¶ä¸è¿ç»­ï¼Œä½¿ç”¨éšæœºIOå†™å…¥æ€§èƒ½å¤ªå·®ï¼  å› æ­¤mysqlè®¾è®¡äº†redo logï¼Œå…·ä½“æ¥è¯´å°±æ˜¯åªè®°å½•äº‹åŠ¡å¯¹æ•°æ®é¡µåšäº†å“ªäº›ä¿®æ”¹ï¼Œè¿™æ ·å°±èƒ½å®Œç¾åœ°è§£å†³æ€§èƒ½é—®é¢˜äº†(ç›¸å¯¹è€Œè¨€æ–‡ä»¶æ›´å°å¹¶ä¸”æ˜¯é¡ºåºIO)ã€‚MySQLå®æˆ˜45è®²\rä¸­å°†redo logæ¯”ä½œä¸´æ—¶è®°è´¦çš„ç²‰æ¿ï¼Œå®é™…æ•°æ®é¡µæ¯”ä½œè´¦æœ¬ã€‚\n2.2 redo logåŸºæœ¬æ¦‚å¿µ redo logåŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªæ˜¯å†…å­˜ä¸­çš„æ—¥å¿—ç¼“å†²(redo log buffer)ï¼Œå¦ä¸€ä¸ªæ˜¯ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶(redo log file)ã€‚mysqlæ¯æ‰§è¡Œä¸€æ¡DMLè¯­å¥ï¼Œå…ˆå°†è®°å½•å†™å…¥redo log bufferï¼Œåç»­æŸä¸ªæ—¶é—´ç‚¹å†ä¸€æ¬¡æ€§å°†å¤šä¸ªæ“ä½œè®°å½•å†™åˆ°redo log fileã€‚è¿™ç§å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜çš„æŠ€æœ¯å°±æ˜¯MySQLé‡Œç»å¸¸è¯´åˆ°çš„WAL(Write-Ahead Logging) æŠ€æœ¯ã€‚\nåœ¨è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ç©ºé—´(user space)ä¸‹çš„ç¼“å†²åŒºæ•°æ®ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ— æ³•ç›´æ¥å†™å…¥ç£ç›˜çš„ï¼Œä¸­é—´å¿…é¡»ç»è¿‡æ“ä½œç³»ç»Ÿå†…æ ¸ç©ºé—´(kernel space)ç¼“å†²åŒº(OS Buffer)ã€‚å› æ­¤ï¼Œredo log bufferå†™å…¥redo log fileå®é™…ä¸Šæ˜¯å…ˆå†™å…¥OS Bufferï¼Œç„¶åå†é€šè¿‡ç³»ç»Ÿè°ƒç”¨fsync()å°†å…¶åˆ·åˆ°redo log fileä¸­ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š\nmysqlæ”¯æŒä¸‰ç§å°†redo log bufferå†™å…¥redo log fileçš„æ—¶æœºï¼Œå¯ä»¥é€šè¿‡innodb_flush_log_at_trx_commitå‚æ•°é…ç½®ï¼Œå„å‚æ•°å€¼å«ä¹‰å¦‚ä¸‹ï¼š\n   å‚æ•°å€¼ å«ä¹‰     0ï¼ˆå»¶è¿Ÿå†™ï¼‰ äº‹åŠ¡æäº¤æ—¶ä¸ä¼šå°†redo log bufferä¸­æ—¥å¿—å†™å…¥åˆ°os bufferï¼Œè€Œæ˜¯æ¯ç§’å†™å…¥os bufferå¹¶è°ƒç”¨fsync()å†™å…¥åˆ°redo log fileä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´è®¾ç½®ä¸º0æ—¶æ˜¯(å¤§çº¦)æ¯ç§’åˆ·æ–°å†™å…¥åˆ°ç£ç›˜ä¸­çš„ï¼Œå½“ç³»ç»Ÿå´©æºƒï¼Œä¼šä¸¢å¤±1ç§’é’Ÿçš„æ•°æ®ã€‚   1ï¼ˆå®æ—¶å†™ï¼Œå®æ—¶åˆ·ï¼‰ äº‹åŠ¡æ¯æ¬¡æäº¤éƒ½ä¼šå°†redo log bufferä¸­çš„æ—¥å¿—å†™å…¥os bufferå¹¶è°ƒç”¨fsync()åˆ·åˆ°redo log fileä¸­ã€‚è¿™ç§æ–¹å¼å³ä½¿ç³»ç»Ÿå´©æºƒä¹Ÿä¸ä¼šä¸¢å¤±ä»»ä½•æ•°æ®ï¼Œä½†æ˜¯å› ä¸ºæ¯æ¬¡æäº¤éƒ½å†™å…¥ç£ç›˜ï¼ŒIOçš„æ€§èƒ½è¾ƒå·®ã€‚   2ï¼ˆå®æ—¶å†™ï¼Œå»¶è¿Ÿåˆ·ï¼‰ æ¯æ¬¡æäº¤éƒ½ä»…å†™å…¥åˆ°os bufferï¼Œç„¶åæ˜¯æ¯ç§’è°ƒç”¨fsync()å°†os bufferä¸­çš„æ—¥å¿—å†™å…¥åˆ°redo log fileã€‚    2.3 redo logè®°å½•å½¢å¼ å‰é¢è¯´è¿‡ï¼Œredo logå®é™…ä¸Šè®°å½•æ•°æ®é¡µçš„å˜æ›´ï¼Œè€Œè¿™ç§å˜æ›´è®°å½•æ˜¯æ²¡å¿…è¦å…¨éƒ¨ä¿å­˜ï¼Œå› æ­¤redo logå®ç°ä¸Šé‡‡ç”¨äº†å¤§å°å›ºå®šï¼Œå¾ªç¯å†™å…¥çš„æ–¹å¼ï¼Œå½“å†™åˆ°ç»“å°¾æ—¶ï¼Œä¼šå›åˆ°å¼€å¤´å¾ªç¯å†™æ—¥å¿—ã€‚å¦‚ä¸‹å›¾ï¼š\nåŒæ—¶æˆ‘ä»¬å¾ˆå®¹æ˜“å¾—çŸ¥ï¼Œåœ¨innodbä¸­ï¼Œæ—¢æœ‰redo logéœ€è¦åˆ·ç›˜ï¼Œè¿˜æœ‰æ•°æ®é¡µä¹Ÿéœ€è¦åˆ·ç›˜ï¼Œredo logå­˜åœ¨çš„æ„ä¹‰ä¸»è¦å°±æ˜¯é™ä½å¯¹æ•°æ®é¡µåˆ·ç›˜çš„è¦æ±‚ã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œwrite posè¡¨ç¤ºredo logå½“å‰è®°å½•çš„LSN(é€»è¾‘åºåˆ—å·)ä½ç½®ï¼Œcheck pointè¡¨ç¤ºæ•°æ®é¡µæ›´æ”¹è®°å½•åˆ·ç›˜åå¯¹åº”redo logæ‰€å¤„çš„LSN(é€»è¾‘åºåˆ—å·)ä½ç½®ã€‚write posåˆ°check pointä¹‹é—´çš„éƒ¨åˆ†æ˜¯redo logç©ºç€çš„éƒ¨åˆ†ï¼Œç”¨äºè®°å½•æ–°çš„è®°å½•ï¼›check pointåˆ°write posä¹‹é—´æ˜¯redo logå¾…è½ç›˜çš„æ•°æ®é¡µæ›´æ”¹è®°å½•ã€‚å½“write posè¿½ä¸Šcheck pointæ—¶ï¼Œä¼šå…ˆæ¨åŠ¨check pointå‘å‰ç§»åŠ¨ï¼Œç©ºå‡ºä½ç½®å†è®°å½•æ–°çš„æ—¥å¿—ã€‚\nå¯åŠ¨innodbçš„æ—¶å€™ï¼Œä¸ç®¡ä¸Šæ¬¡æ˜¯æ­£å¸¸å…³é—­è¿˜æ˜¯å¼‚å¸¸å…³é—­ï¼Œæ€»æ˜¯ä¼šè¿›è¡Œæ¢å¤æ“ä½œã€‚å› ä¸ºredo logè®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ï¼Œå› æ­¤æ¢å¤çš„æ—¶å€™é€Ÿåº¦æ¯”é€»è¾‘æ—¥å¿—(å¦‚binlog)è¦å¿«å¾ˆå¤šã€‚ é‡å¯innodbæ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ç£ç›˜ä¸­æ•°æ®é¡µçš„LSNï¼Œå¦‚æœæ•°æ®é¡µçš„LSNå°äºæ—¥å¿—ä¸­çš„LSNï¼Œåˆ™ä¼šä»checkpointå¼€å§‹æ¢å¤ã€‚ è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œåœ¨å®•æœºå‰æ­£å¤„äºcheckpointçš„åˆ·ç›˜è¿‡ç¨‹ï¼Œä¸”æ•°æ®é¡µçš„åˆ·ç›˜è¿›åº¦è¶…è¿‡äº†æ—¥å¿—é¡µçš„åˆ·ç›˜è¿›åº¦ï¼Œæ­¤æ—¶ä¼šå‡ºç°æ•°æ®é¡µä¸­è®°å½•çš„LSNå¤§äºæ—¥å¿—ä¸­çš„LSNï¼Œè¿™æ—¶è¶…å‡ºæ—¥å¿—è¿›åº¦çš„éƒ¨åˆ†å°†ä¸ä¼šé‡åšï¼Œå› ä¸ºè¿™æœ¬èº«å°±è¡¨ç¤ºå·²ç»åšè¿‡çš„äº‹æƒ…ï¼Œæ— éœ€å†é‡åšã€‚\n2.4 redo logä¸binlogåŒºåˆ«     redo log binlog     æ–‡ä»¶å¤§å° redo logçš„å¤§å°æ˜¯å›ºå®šçš„ã€‚ binlogå¯é€šè¿‡é…ç½®å‚æ•°max_binlog_sizeè®¾ç½®æ¯ä¸ªbinlogæ–‡ä»¶çš„å¤§å°ã€‚   å®ç°æ–¹å¼ redo logæ˜¯InnoDBå¼•æ“å±‚å®ç°çš„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰å¼•æ“éƒ½æœ‰ã€‚ binlogæ˜¯Serverå±‚å®ç°çš„ï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ binlogæ—¥å¿—   è®°å½•æ–¹å¼ redo log é‡‡ç”¨å¾ªç¯å†™çš„æ–¹å¼è®°å½•ï¼Œå½“å†™åˆ°ç»“å°¾æ—¶ï¼Œä¼šå›åˆ°å¼€å¤´å¾ªç¯å†™æ—¥å¿—ã€‚ binlog é€šè¿‡è¿½åŠ çš„æ–¹å¼è®°å½•ï¼Œå½“æ–‡ä»¶å¤§å°å¤§äºç»™å®šå€¼åï¼Œåç»­çš„æ—¥å¿—ä¼šè®°å½•åˆ°æ–°çš„æ–‡ä»¶ä¸Š   é€‚ç”¨åœºæ™¯ redo logé€‚ç”¨äºå´©æºƒæ¢å¤(crash-safe) binlogé€‚ç”¨äºä¸»ä»å¤åˆ¶å’Œæ•°æ®æ¢å¤    ç”±binlogå’Œredo logçš„åŒºåˆ«å¯çŸ¥ï¼šbinlogæ—¥å¿—åªç”¨äºå½’æ¡£ï¼Œåªä¾é binlogæ˜¯æ²¡æœ‰crash-safeèƒ½åŠ›çš„ã€‚ä½†åªæœ‰redo logä¹Ÿä¸è¡Œï¼Œå› ä¸ºredo logæ˜¯InnoDBç‰¹æœ‰çš„ï¼Œä¸”æ—¥å¿—ä¸Šçš„è®°å½•è½ç›˜åä¼šè¢«è¦†ç›–æ‰ã€‚å› æ­¤éœ€è¦binlogå’Œredo logäºŒè€…åŒæ—¶è®°å½•ï¼Œæ‰èƒ½ä¿è¯å½“æ•°æ®åº“å‘ç”Ÿå®•æœºé‡å¯æ—¶ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚\n é—®ï¼šbinlogä¸ºä»€ä¹ˆæ²¡æœ‰crash_safeçš„èƒ½åŠ›å‘¢ï¼Ÿbinlogæ—¥å¿—ä¹Ÿè®°å½•äº†æ‰€æœ‰çš„æ“ä½œã€‚\nç­”ï¼šä¸è€ƒè™‘mysqlç°æœ‰çš„å®ç°ï¼Œå‡å¦‚ç°åœ¨é‡æ–°è®¾è®¡mysqlï¼Œåªç”¨ä¸€ä¸ªbinlogæ˜¯å¦å¯ä»¥å®ç°cash_safeèƒ½åŠ›å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œåªä¸è¿‡binlogä¸­ä¹Ÿè¦åŠ å…¥checkpointï¼Œæ•°æ®åº“æ•…éšœé‡å¯åï¼Œbinlog checkpointä¹‹åçš„sqléƒ½é‡æ”¾ä¸€éã€‚ä½†æ˜¯è¿™æ ·åšè®©binlogè€¦åˆçš„åŠŸèƒ½å¤ªå¤šã€‚\n 3. undo log æ•°æ®åº“äº‹åŠ¡å››å¤§ç‰¹æ€§ä¸­æœ‰ä¸€ä¸ªæ˜¯åŸå­æ€§ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ åŸå­æ€§æ˜¯æŒ‡å¯¹æ•°æ®åº“çš„ä¸€ç³»åˆ—æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å¯èƒ½å‡ºç°éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µã€‚å®é™…ä¸Šï¼ŒåŸå­æ€§åº•å±‚å°±æ˜¯é€šè¿‡undo logå®ç°çš„ã€‚undo logä¸»è¦è®°å½•äº†æ•°æ®çš„é€»è¾‘å˜åŒ–ï¼Œæ¯”å¦‚ä¸€æ¡INSERTè¯­å¥ï¼Œå¯¹åº”ä¸€æ¡DELETEçš„undo logï¼Œå¯¹äºæ¯ä¸ªUPDATEè¯­å¥ï¼Œå¯¹åº”ä¸€æ¡ç›¸åçš„UPDATEçš„undo logï¼Œè¿™æ ·åœ¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå°±èƒ½å›æ»šåˆ°äº‹åŠ¡ä¹‹å‰çš„æ•°æ®çŠ¶æ€ã€‚åŒæ—¶ï¼Œundo logä¹Ÿæ˜¯MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)å®ç°çš„å…³é”®ï¼Œè¿™éƒ¨åˆ†å†…å®¹åœ¨é¢è¯•ä¸­çš„è€å¤§éš¾-mysqläº‹åŠ¡å’Œé”ï¼Œä¸€æ¬¡æ€§è®²æ¸…æ¥šï¼\rä¸­æœ‰ä»‹ç»ï¼Œä¸å†èµ˜è¿°ã€‚\né™„ä»¶ MySQL çš„é€»è¾‘æ¶æ„å›¾ï¼š mysql8.0ä¹‹ååˆ é™¤äº†æŸ¥è¯¢ç¼“å­˜æ¨¡å—\nupdate è¯­å¥æ‰§è¡Œæµç¨‹ï¼š redo logçš„å†™å…¥åˆ†æˆä¸¤ä¸ªæ­¥éª¤prepareå’Œcommitï¼Œè¿™å°±æ˜¯ä¸¤é˜¶æ®µæäº¤\n é—®ï¼šä¸¤é˜¶æ®µæäº¤ä¸­ï¼ŒMySQLå¼‚å¸¸é‡å¯ï¼ˆcrashï¼‰ï¼Œæ˜¯å¦‚ä½•ä¿è¯æ•°æ®å®Œæ•´æ€§çš„ï¼Ÿ\nç­”ï¼š\n åœ¨ä¸Šå›¾æ—¶åˆ»Aä¸­ï¼Œä¹Ÿå°±æ˜¯å†™å…¥redo logå¤„äºprepareé˜¶æ®µä»¥åã€å†™binlogä¹‹å‰ï¼Œå‘ç”Ÿäº†å´©æºƒï¼ˆcrashï¼‰ï¼šç”±äºæ­¤æ—¶binlogè¿˜æ²¡å†™ï¼Œredo logä¹Ÿè¿˜æ²¡æäº¤ï¼ˆcommitï¼‰ï¼Œæ‰€ä»¥å´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œè¿™ä¸ªäº‹åŠ¡ä¼šå›æ»šã€‚è¿™æ—¶å€™ï¼Œbinlogè¿˜æ²¡å†™ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šä¼ åˆ°å¤‡åº“ï¼Œæ•°æ®ä¸€è‡´ï¼› åœ¨ä¸Šå›¾æ—¶åˆ»Bä¸­ï¼Œä¹Ÿå°±æ˜¯å†™å®Œbinlogä¹‹åï¼Œå‘ç”Ÿcrashï¼šå¦‚æœredo logé‡Œé¢çš„äº‹åŠ¡æœ‰commitæ ‡è¯†ï¼ˆäº‹åŠ¡æ˜¯å®Œæ•´çš„ï¼‰åˆ™ç›´æ¥æäº¤ï¼›å¦‚æœredo logé‡Œé¢çš„äº‹åŠ¡åªæœ‰prepareæ²¡æœ‰commitï¼Œåˆ™åˆ¤æ–­å¯¹åº”çš„äº‹åŠ¡åœ¨binlogæ˜¯å¦å­˜åœ¨å¹¶å®Œæ•´ï¼Œå®Œæ•´åˆ™æäº¤äº‹åŠ¡ï¼Œå¦åˆ™å›æ»šäº‹åŠ¡ï¼› MySQLæ€ä¹ˆçŸ¥é“binlogæ˜¯å®Œæ•´çš„ï¼šä¸€ä¸ªäº‹åŠ¡çš„binlogæ˜¯æœ‰å®Œæ•´æ ¼å¼çš„ï¼Œstatementæ ¼å¼ï¼ˆè®°å½•sqlè¯­å¥ï¼‰ï¼Œæœ€åä¼šæœ‰ä¸ªCOMMIT; rowæ ¼å¼ï¼ˆè®°å½•è¡Œçš„å†…å®¹ï¼Œè®°ä¸¤æ¡ï¼Œæ›´æ–°å‰å’Œæ›´æ–°åéƒ½æœ‰ï¼‰ï¼Œæœ€åä¼šæœ‰ä¸ªXID event redo logå’Œbinlogæ˜¯æ€ä¹ˆå…³è”èµ·æ¥çš„ï¼šä»–ä»¬æœ‰ä¸€ä¸ªå…±åŒçš„æ•°æ®å­—æ®µXIDã€‚å´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œä¼šæŒ‰é¡ºåºæ‰«æredo logï¼›ä¸Šè¿°ç¬¬äºŒç‚¹ä¸­çš„å´©æºƒæ¢å¤åœºæ™¯ï¼ˆredo logé‡Œé¢çš„äº‹åŠ¡åªæœ‰å®Œæ•´çš„prepareè€Œæ²¡æœ‰commitï¼‰ï¼Œé‚£ä¹ˆmysqlå°±ä¼šæ‹¿ç€XIDå»binlogæ‰¾æ˜¯å¦å­˜åœ¨å¯¹åº”çš„å®Œæ•´äº‹åŠ¡ï¼›   å‚è€ƒ å¿…é¡»äº†è§£çš„mysqlä¸‰å¤§æ—¥å¿—-binlogã€redo logå’Œundo log\r[ç©è½¬MySQLä¹‹å…«]MySQLæ—¥å¿—åˆ†ç±»åŠç®€ä»‹\r01 | åŸºç¡€æ¶æ„ï¼šä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ\r02 | æ—¥å¿—ç³»ç»Ÿï¼šä¸€æ¡SQLæ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ\rä¸ºä»€ä¹ˆæœ‰binlogè¿˜è¦redo log\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mysql/mysql%E6%97%A5%E5%BF%97/","series":["Manual"],"tags":["MySQL"],"title":"MySQLæ—¥å¿—"},{"categories":["å…¶ä»–"],"content":"navicatè¿œç¨‹è¿æ¥mysqlï¼Œ2003 can\u0026rsquo;t connect to mysql server on 10038\né¦–å…ˆæˆ‘ä»¬é€šè¿‡\nâ‘ ï¼šnetstat -an|grep 3306\næ¥æŸ¥çœ‹mysqlé»˜è®¤çš„ç«¯å£3306æ˜¯å¦å¼€å¯ï¼Œå…è®¸å“ªä¸ªipä½¿ç”¨ï¼Œå¦‚æœä½ å‘ç°ï¼Œå‰é¢æœ‰127.0.0.1ï¼Œå°±è¯´æ˜ï¼Œ3306ç«¯å£åªèƒ½æœ¬æœºipä½¿ç”¨\næ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦\nâ‘¡ï¼šæ‰“å¼€mysqlé…ç½®æ–‡ä»¶vi /etc/mysql/mysql.conf.d/mysqld.cnf\nå°†bind-address = 127.0.0.1æ³¨é”€\nâ‘¢ï¼šè¿›å…¥mysqlï¼Œå¯¹è¿œç¨‹ç”¨æˆ·è¿›è¡Œæˆæƒï¼Œ\ngrant all privileges on . to \u0026lsquo;root\u0026rsquo;@'%' identified by \u0026lsquo;xxxxxx\u0026rsquo;;\nè¿™é‡Œçš„root æ˜¯ä½ è¿œç¨‹ç™»å½•çš„ç”¨æˆ·ï¼Œxxxxxxæ˜¯ä½ ç™»å½•ä½¿ç”¨çš„å¯†ç ï¼Œç„¶åå¯ä»¥åœ¨mysqlæ•°æ® è¡¨ä¸­æŸ¥çœ‹åˆ°ä½ è¿™ä¸ªç”¨æˆ·å·²ç»è¢«æ·»åŠ åˆ°userè¡¨ä¸­\nâ‘£ï¼šservice mysql restart\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/navicat%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5mysql2003-can_t-connect-to-mysql-serve/","series":["Manual"],"tags":["Other"],"title":"navicatè¿œç¨‹è¿æ¥mysqlï¼Œ2003 can't connect to mysql server on 10038"},{"categories":["å…¶ä»–"],"content":"net::ERR_CONTENT_LENGTH_MISMATCH 200 (OK)\nåŠ è½½é™æ€èµ„æºæ—¶æŠ¥é”™ï¼šnet::ERR_CONTENT_LENGTH_MISMATCH 200 (OK)\nè§£å†³åŠæ³•ï¼šè°ƒæ•´ç¼“å†²åŒºå¤§å° proxy_buffer_size 64k; proxy_buffers 4 32k; proxy_busy_buffers_size 64k;\nserver { listen 80; server_name tkaid.com www.tkaid.com; location / { proxy_buffer_size 64k; proxy_buffers 4 32k; proxy_busy_buffers_size 64k; proxy_pass http://k8s_tkb-web-svc; } } å¦‚æœä»ç„¶æŠ¥è¿™ä¸ªé”™ï¼Œå¯ä»¥å†å°†å€¼è®¾ç½®å¾—å¤§ä¸€ç‚¹ã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/net__err_content_length_mismatch-200-ok/","series":["Manual"],"tags":["Other"],"title":"net::ERR_CONTENT_LENGTH_MISMATCH 200 (OK)"},{"categories":["äº‘åŸç”Ÿ"],"content":"nfså®‰è£…\n1. ç¯å¢ƒè¯´æ˜    è§’è‰² ip os     NFS æœåŠ¡ç«¯ 172.31.0.12 CentOS 7.6   NFS å®¢æˆ·ç«¯ 172.18.0.7 CentOS 7.6    2. NFS æœåŠ¡ç«¯ 2.1 å®‰è£… nfs-utils # rpcbind ä½œä¸ºä¾èµ–ä¼šè‡ªåŠ¨å®‰è£…ã€‚ \u0026gt; yum install nfs-utils 2.2 é…ç½®å¹¶å¯åŠ¨æœåŠ¡ å…è®¸rpcbind.serviceã€nfs.serviceå¼€æœºè‡ªå¯ï¼š\n# å¯åŠ¨ç›¸å…³æœåŠ¡ \u0026gt; systemctl start rpcbind \u0026gt; systemctl start nfs é˜²ç«å¢™å…è®¸æœåŠ¡é€šè¿‡ï¼š\n# é˜²ç«å¢™å…è®¸æœåŠ¡é€šè¿‡ \u0026gt; firewall-cmd --zone=public --permanent --add-service={rpc-bind,mountd,nfs} success \u0026gt; firewall-cmd --reload success æˆ–è€…ç›´æ¥å…³é—­é˜²ç«å¢™ï¼šsystemctl stop firewalld\n2.3 é…ç½®å…±äº«ç›®å½• ä¾‹å¦‚éœ€è¦å…±äº«çš„ç›®å½•ä¸º/mnt/nfs/ï¼š\n# åˆ›å»º /mnt/kvm å¹¶ä¿®æ”¹æƒé™ \u0026gt; cd /mnt /mnt \u0026gt; mkdir nfs /mnt \u0026gt; chmod 755 nfs # éªŒè¯ç›®å½•æƒé™ /mnt \u0026gt; ls -l total 0 drwxr-xr-x 2 root root 59 Oct 17 17:49 nfs ä¹‹åä¿®æ”¹/etc/exportsï¼Œå°†/mnt/nfs/æ·»åŠ è¿›å»ï¼š\n\u0026gt; cat /etc/exports # 1. åªå…è®¸ abelsu7-ubuntu è®¿é—® /mnt/nfs/ abelsu7-ubuntu(rw,sync,no_root_squash,no_all_squash) # 2. æ ¹æ® IP åœ°å€èŒƒå›´é™åˆ¶è®¿é—® /mnt/nfs/ 172.0.0.0/8(rw,sync,no_root_squash,no_all_squash) # 3. ä½¿ç”¨ * è¡¨ç¤ºè®¿é—®ä¸åŠ é™åˆ¶ /mnt/nfs/ *(rw,sync,no_root_squash,no_all_squash) å…³äº/etc/exportsä¸­çš„å‚æ•°å«ä¹‰ï¼š\n /mnt/kvm/ï¼šéœ€è¦å…±äº«çš„ç›®å½• 172.0.0.0/8ï¼šå®¢æˆ·ç«¯ IP èŒƒå›´ï¼Œ*è¡¨ç¤ºæ— é™åˆ¶ rwï¼šæƒé™è®¾ç½®ï¼Œå¯è¯»å¯å†™ syncï¼šè¡¨ç¤ºæ–‡ä»¶åŒæ—¶å†™å…¥ç¡¬ç›˜å’Œå†…å­˜ no_root_squashï¼šå½“ç™»å½• NFS ä¸»æœºä½¿ç”¨å…±äº«ç›®å½•çš„ä½¿ç”¨è€…æ˜¯ root æ—¶ï¼Œå…¶æƒé™å°†è¢«è½¬æ¢æˆä¸ºåŒ¿åä½¿ç”¨è€…ï¼Œé€šå¸¸å®ƒçš„ UID ä¸ GIDï¼Œéƒ½ä¼šå˜æˆ nobody èº«ä»½ no_all_squashï¼šå¯ä»¥ä½¿ç”¨æ™®é€šç”¨æˆ·æˆæƒï¼ˆï¼Ÿï¼Ÿï¼‰  ä¿å­˜ä¹‹åï¼Œé‡å¯nfsæœåŠ¡ï¼š\n\u0026gt; systemctl restart nfs 2.4 æŸ¥çœ‹å…±äº«ç›®å½•åˆ—è¡¨ [root@VM-0-12-centos mnt]# showmount -e localhost Export list for localhost: /mnt/nfs 172.0.0.0/8 3. NFS å®¢æˆ·ç«¯ 3.1 å®‰è£… nfs-utils # CentOS/Fedora, etc. \u0026gt; yum install nfs-utils # Ubuntu/Debian, etc. \u0026gt; apt install nfs-common å¿…é¡»è¦å®‰è£…nfs-utilsï¼Œå®‰è£…è¿‡ç¨‹ä¼šä¸‹è½½å…³é”®å‘½ä»¤åˆ°æœ¬æœºï¼Œä¾‹å¦‚showmountç­‰ç­‰ã€‚\n3.2 é…ç½®å¹¶å¯åŠ¨æœåŠ¡ï¼ˆéå¿…é¡»æ­¥éª¤ï¼‰ [v_warn]å¼€å¯rpcbindæœåŠ¡ä¸æ˜¯å¿…é¡»çš„ï¼Œç»è¿‡å®æµ‹åªè¦å®‰è£…äº†nfs-utilsåˆ°æœ¬æœºï¼Œå°±å¯ä»¥å®ç°æŒ‚è½½ã€‚[/v_warn]\nè®¾ç½®rpcbindæœåŠ¡å¼€æœºå¯åŠ¨ï¼š\n\u0026gt; systemctl enable rpcbind å¯åŠ¨rpcbindï¼š\n\u0026gt; systemctl start rpcbind å®¢æˆ·ç«¯ä¸éœ€è¦æ‰“å¼€é˜²ç«å¢™ï¼Œä¹Ÿä¸éœ€è¦å¼€å¯ NFS æœåŠ¡\n3.3 æŒ‚è½½å…±äº«ç›®å½• å…ˆæŸ¥çœ‹æœåŠ¡ç«¯çš„å…±äº«ç›®å½•ï¼š\n[root@k8s-node1 mnt]# showmount -e 172.31.0.12 Export list for 172.31.0.12: /mnt/nfs 172.0.0.0/8 åœ¨å®¢æˆ·ç«¯åˆ›å»ºå¹¶æŒ‚è½½å¯¹åº”ç›®å½•ï¼š\n\u0026gt; mkdir -p /mnt/nfs \u0026gt; mount -t nfs 172.31.0.12:/mnt/nfs /mnt/nfs æœ€åæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æŒ‚è½½æˆåŠŸï¼š\n[root@k8s-node1 mnt]# df -hT /mnt/nfs Filesystem Type Size Used Avail Use% Mounted on 172.31.0.12:/mnt/nfs nfs4 493G 72M 467G 1% /mnt/nfs [root@k8s-node1 mnt]# mount | grep /mnt/nfs 172.31.0.12:/mnt/nfs on /mnt/nfs type nfs4 (rw,relatime,vers=4.1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=sys,clientaddr=172.18.0.7,local_lock=none,addr=172.31.0.12) 3.4 é…ç½®è‡ªåŠ¨æŒ‚è½½ åœ¨å®¢æˆ·ç«¯ç¼–è¾‘/etc/fstabï¼ŒåŠ å…¥å¦‚ä¸‹é…ç½®ï¼š\n172.31.0.12:/mnt/nfs /mnt/nfs nfs defaults 0 0 æœ€åé‡æ–°åŠ è½½systemctlï¼Œå³å¯å®ç°é‡å¯åè‡ªåŠ¨æŒ‚è½½\n\u0026gt; systemctl daemon-reload 4. NFS è¯»å†™é€Ÿåº¦æµ‹è¯• å†™é€Ÿåº¦ï¼š\n[root@k8s-node1 mnt]# time dd if=/dev/zero of=/mnt/nfs/jenkins.war bs=8k count=1024 1024+0 records in 1024+0 records out 8388608 bytes (8.4 MB) copied, 0.122319 s, 68.6 MB/s real\t0m0.138s user\t0m0.000s sys\t0m0.008s è¯»é€Ÿåº¦ï¼š\n[root@k8s-node1 mnt]# time dd if=/mnt/nfs/jenkins.war of=/dev/null bs=8k count=1024 1024+0 records in 1024+0 records out 8388608 bytes (8.4 MB) copied, 0.0020144 s, 4.2 GB/s real\t0m0.004s user\t0m0.000s sys\t0m0.002s å‚è€ƒè¿æ¥ CentOS 7 å®‰è£…é…ç½® NFS\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/nfs%E5%AE%89%E8%A3%85/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"nfså®‰è£…"},{"categories":["å…¶ä»–"],"content":"nginx è®¿é—® .phpæ–‡ä»¶å˜æˆä¸‹è½½(chrome) æˆ–è€…ç›´æ¥æ˜¾ç¤ºæºç (edge)\nåŸå› ï¼šè¿™æ˜¯å› ä¸ºnginxæ²¡æœ‰è®¾ç½®å¥½ç¢°åˆ°phpæ–‡ä»¶æ—¶ï¼Œè¦ä¼ é€’åˆ°åæ–¹çš„phpè§£é‡Šå™¨ã€‚\néœ€è¦åœ¨nginx.confçš„server{}æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\nlocation ~ [^/]\\.php(/|$) { #fastcgi_pass remote_php_ip:9000; fastcgi_pass unix:/dev/shm/php-cgi.sock; fastcgi_index index.php; include fastcgi.conf; } ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/wordpress/nginx-%E8%AE%BF%E9%97%AE-.php%E6%96%87%E4%BB%B6%E5%8F%98%E6%88%90%E4%B8%8B%E8%BD%BDchrome-%E6%88%96%E8%80%85%E7%9B%B4%E6%8E%A5%E6%98%BE%E7%A4%BA%E6%BA%90%E7%A0%81edge/","series":["Manual"],"tags":["WordPress"],"title":"nginx è®¿é—® .phpæ–‡ä»¶å˜æˆä¸‹è½½(chrome) æˆ–è€…ç›´æ¥æ˜¾ç¤ºæºç (edge)"},{"categories":["å…¶ä»–"],"content":"nginxåå‘ä»£ç†kibanaæŠ¥ï¼šKibana did not load properly.Check the server output for more information.\nå¦‚é¢˜æ‰€è¿°ï¼Œç›´æ¥è®¿é—®5601ç«¯å£ä¸ä¼šæŠ¥é”™ï¼Œä¸€æ—¦ç”¨ngnixåå‘ä»£ç†å°±æŠ¥é”™ã€‚\nåŸå› ï¼šåº”è¯¥æ˜¯kibanaçš„å¯åŠ¨ç”¨æˆ·æ²¡æœ‰è®¿é—®nginx/proxy_tempæ–‡ä»¶å¤¹çš„æƒé™ï¼Œå¯¼è‡´éƒ¨åˆ†é™æ€èµ„æºæ— æ³•åŠ è½½ã€‚\n å¥‡æ€ªçš„æ˜¯ï¼š1. æˆ‘çš„proxy_tempæ–‡ä»¶ä¸‹ä¸€ä¸ªæ–‡ä»¶éƒ½æ²¡æœ‰ 2. æˆ‘çš„nginx error.logæ—¥å¿—ä¹Ÿæ²¡æœ‰æŠ¥ç±»ä¼¼Permission deniedçš„é”™è¯¯ã€‚ è¿™é‡Œæš‚ä¸”ä¸ç®¡ã€‚ã€‚ã€‚\n è§£å†³åŠæ³•:\nchmod -R 777 proxy_temp\rhttps://www.cnblogs.com/operationhome/p/9901580.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86kibana%E6%8A%A5kibana-did-not-load-properly.chec/","series":["Manual"],"tags":["Other"],"title":"nginxåå‘ä»£ç†kibanaæŠ¥ï¼šKibana did not load properly.Check the server output for more information."},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"åœ¨ç»™nginxåŠ ä¸Šæˆæƒæ¨¡å—åï¼Œå†è®¿é—®åº”ç”¨æŠ¥403è®¿é—®ç¦æ­¢çš„é”™è¯¯ã€‚\nä¸€å¼€å§‹æ˜¯è¿™æ ·ï¼š\n1. ç”Ÿæˆå¯†ç æ–‡ä»¶ printf \u0026#34;yourusername:$(openssl passwd -apr1)\u0026#34; \u0026gt; /etc/nginx/passwords 2. nginxé…ç½® server { # ... auth_basic \u0026#34;Protected\u0026#34;; auth_basic_user_file passwords; # ... } [v_error]auth_basic_user_file åé¢è·Ÿçš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè¿™æ ·é…ç½®å¾ˆå®¹æ˜“å¯¼è‡´nginxæ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œå› æ­¤æ”¹æˆç»å¯¹è·¯å¾„å°±ä¸‡äº‹å¤§å‰äº†ï¼š[/v_error]\nserver{\tlisten 443 ssl; server_name netdata.6and.ltd; #listen [::]:81 default_server ipv6only=on; #ssl on; ssl_certificate httpssl/1_netdata.6and.ltd_bundle.crt; ssl_certificate_key httpssl/2_netdata.6and.ltd.key; ssl_session_timeout 5m; ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_prefer_server_ciphers on; #index index.html index.htm index.php; #root /home/wwwroot/; #error_page 404 /404.html; #include enable-php.conf; auth_basic \u0026#34;Protected\u0026#34;; auth_basic_user_file /usr/local/nginx/passwords; location / { proxy_pass http://127.0.0.1:19999; } access_log /data/wwwlogs/netdata.log; } server { listen 80; server_name netdata.6and.ltd; #æŠŠhttpçš„åŸŸåè¯·æ±‚è½¬æˆhttps return 301 https://$host$request_uri; } ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/nginx/nginx%E6%8E%88%E6%9D%83%E7%99%BB%E9%99%86%E6%8A%A5403%E9%97%AE%E9%A2%98/","series":["Manual"],"tags":["nginx"],"title":"nginxæˆæƒç™»é™†æŠ¥403é—®é¢˜"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"OAuthï¼ˆå¼€æ”¾æˆæƒï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå…è®¸ç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹ç§»åŠ¨åº”ç”¨è®¿é—®ä»–ä»¬å­˜å‚¨åœ¨å¦å¤–çš„æœåŠ¡æä¾›è€…ä¸Šçš„ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹ç§»åŠ¨åº”ç”¨æˆ–åˆ†äº«ä»–ä»¬æ•°æ®çš„æ‰€æœ‰å†…å®¹ï¼ŒOAuth2.0æ˜¯OAuthåè®®çš„å»¶ç»­ç‰ˆæœ¬ï¼Œä½†ä¸å‘åå…¼å®¹OAuth 1.0å³å®Œå…¨åºŸæ­¢äº†OAuth1.0ã€‚\nå®¢æˆ·ç«¯å¿…é¡»å¾—åˆ°ç”¨æˆ·çš„æˆæƒï¼ˆauthorization grantï¼‰ï¼Œæ‰èƒ½è·å¾—ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚OAuth 2.0å®šä¹‰äº†å››ç§æˆæƒæ–¹å¼ã€‚\n æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰ ç®€åŒ–æ¨¡å¼ï¼ˆimplicitï¼‰ å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰ å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰  1ã€åè¯å®šä¹‰ åœ¨è¯¦ç»†è®²è§£OAuth 2.0ä¹‹å‰ï¼Œéœ€è¦äº†è§£å‡ ä¸ªä¸“ç”¨åè¯ã€‚\nï¼ˆ1ï¼‰ Third-party applicationï¼šç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼Œæœ¬æ–‡ä¸­åˆç§°\u0026quot;å®¢æˆ·ç«¯\u0026quot;ï¼ˆclientï¼‰ï¼Œå³ä¸Šä¸€èŠ‚ä¾‹å­ä¸­çš„\u0026quot;äº‘å†²å°\u0026quot;ã€‚\nï¼ˆ2ï¼‰HTTP serviceï¼šHTTPæœåŠ¡æä¾›å•†ï¼Œæœ¬æ–‡ä¸­ç®€ç§°\u0026quot;æœåŠ¡æä¾›å•†\u0026quot;ï¼Œå³ä¸Šä¸€èŠ‚ä¾‹å­ä¸­çš„Googleã€‚\nï¼ˆ3ï¼‰Resource Ownerï¼šèµ„æºæ‰€æœ‰è€…ï¼Œæœ¬æ–‡ä¸­åˆç§°\u0026quot;ç”¨æˆ·\u0026quot;ï¼ˆuserï¼‰ã€‚\nï¼ˆ4ï¼‰User Agentï¼šç”¨æˆ·ä»£ç†ï¼Œæœ¬æ–‡ä¸­å°±æ˜¯æŒ‡æµè§ˆå™¨ã€‚\nï¼ˆ5ï¼‰Authorization serverï¼šè®¤è¯æœåŠ¡å™¨ï¼Œå³æœåŠ¡æä¾›å•†ä¸“é—¨ç”¨æ¥å¤„ç†è®¤è¯çš„æœåŠ¡å™¨ã€‚\nï¼ˆ6ï¼‰Resource serverï¼šèµ„æºæœåŠ¡å™¨ï¼Œå³æœåŠ¡æä¾›å•†å­˜æ”¾ç”¨æˆ·ç”Ÿæˆçš„èµ„æºçš„æœåŠ¡å™¨ã€‚å®ƒä¸è®¤è¯æœåŠ¡å™¨ï¼Œå¯ä»¥æ˜¯åŒä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„æœåŠ¡å™¨ã€‚\nçŸ¥é“äº†ä¸Šé¢è¿™äº›åè¯ï¼Œå°±ä¸éš¾ç†è§£ï¼ŒOAuthçš„ä½œç”¨å°±æ˜¯è®©\u0026quot;å®¢æˆ·ç«¯\u0026quot;å®‰å…¨å¯æ§åœ°è·å–\u0026quot;ç”¨æˆ·\u0026quot;çš„æˆæƒï¼Œä¸\u0026quot;æœåŠ¡å•†æä¾›å•†\u0026quot;è¿›è¡Œäº’åŠ¨ã€‚\n2ã€4ç§æ¨¡å¼åŒºåˆ« æˆæƒç æ¨¡å¼æ²¡ä»€ä¹ˆå¥½è®²çš„ï¼Œåº”ç”¨æœ€å¹¿æ³›ï¼Œæ˜¯æ ‡å‡†çš„OAuth2æ¨¡å¼ï¼›\nç®€åŒ–æ¨¡å¼é€‚åˆæ²¡æœ‰åç«¯çš„åº”ç”¨ï¼Œä¹Ÿå°±æ— æ³•å®‰å…¨çš„å­˜å‚¨client id å’Œ client secret ä¾‹å¦‚åªæœ‰ä¸€ä¸ªé¡µé¢çš„h5è°ƒæŸ¥é—®å·ç­‰ç­‰ï¼›\nå¯†ç æ¨¡å¼æ˜¯ç”¨æˆ·æŠŠè´¦å·å¯†ç ç›´æ¥å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œéå¸¸ä¸å®‰å…¨ï¼Œé€‚ç”¨äºé—ç•™é¡¹ç›®å‡çº§ä¸ºoauth2çš„é€‚é…æ–¹æ¡ˆã€å®¢æˆ·ç«¯æ˜¯è‡ªå®¶çš„åº”ç”¨ï¼›\nå®¢æˆ·ç«¯æ¨¡å¼ç›´æ¥æ ¹æ®clientçš„idå’Œå¯†é’¥å³å¯è·å–tokenï¼Œæ— éœ€ç”¨æˆ·å‚ä¸ï¼Œé€‚ç”¨äºåç«¯æœåŠ¡è°ƒåç«¯æœåŠ¡ï¼›\nå‚è€ƒé“¾æ¥ï¼š ç†è§£OAuth 2.0\roauth2å››ç§æˆæƒæ–¹å¼å°ç»“\r[ç®€æ˜“å›¾è§£]ã€ OAuth2.0ã€ ã€è¿›é˜¶ã€ æˆæƒæ¨¡å¼æ€»ç»“\rOAuth2.0çš„å››ç§æˆæƒæ¨¡å¼\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/oauth2/","series":["Manual"],"tags":["CS"],"title":"OAuth2"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"æ‰€è°“ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œå®è´¨å°±æ˜¯ OAuth æˆæƒã€‚ç”¨æˆ·æƒ³è¦ç™»å½• A ç½‘ç«™ï¼ŒA ç½‘ç«™è®©ç”¨æˆ·æä¾›ç¬¬ä¸‰æ–¹ç½‘ç«™çš„æ•°æ®ï¼Œè¯æ˜è‡ªå·±çš„èº«ä»½ã€‚è·å–ç¬¬ä¸‰æ–¹ç½‘ç«™çš„èº«ä»½æ•°æ®ï¼Œå°±éœ€è¦ OAuth æˆæƒã€‚\nä¸¾ä¾‹æ¥è¯´ï¼ŒA ç½‘ç«™å…è®¸ GitHub ç™»å½•ï¼ŒèƒŒåå°±æ˜¯ä¸‹é¢çš„æµç¨‹ã€‚\n  A ç½‘ç«™è®©ç”¨æˆ·è·³è½¬åˆ° GitHubã€‚ GitHub è¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œç„¶åè¯¢é—®\u0026quot;A ç½‘ç«™è¦æ±‚è·å¾— xx æƒé™ï¼Œä½ æ˜¯å¦åŒæ„ï¼Ÿ\u0026quot; ç”¨æˆ·åŒæ„ï¼ŒGitHub å°±ä¼šé‡å®šå‘å› A ç½‘ç«™ï¼ŒåŒæ—¶å‘å›ä¸€ä¸ªæˆæƒç ã€‚ A ç½‘ç«™ä½¿ç”¨æˆæƒç ï¼Œå‘ GitHub è¯·æ±‚ä»¤ç‰Œã€‚ GitHub è¿”å›ä»¤ç‰Œ. A ç½‘ç«™ä½¿ç”¨ä»¤ç‰Œï¼Œå‘ GitHub è¯·æ±‚ç”¨æˆ·æ•°æ®ã€‚   é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥è¿”å›tokenï¼Ÿè€Œè¦ä¸­é—´ç»è¿‡codeå†å€’è…¾ä¸€éå‘¢ï¼ŸçŸ¥ä¹ä¸Šæœ‰ä½å¤§å“¥å›ç­”å¾—æŒºå¥½ã€‚\né—®é¢˜ï¼š\n ä¸ºä»€ä¹ˆoauth2ä¸­çš„æˆæƒç æ¨¡å¼ åœ¨è·å–tokenä¹‹å‰éè¦å…ˆåˆ°èµ„æºæœåŠ¡å™¨è·å–ä¸€ä¸ªcode ç„¶åæ‰ä½¿ç”¨èµ„æºæœåŠ¡å™¨çš„codeå»èµ„æºæœåŠ¡å™¨å»ç”³è¯·token?\nçœ‹äº†å¾ˆå¤šèµ„æ–™è¯´æ˜¯å› ä¸º ç”¨æˆ·åœ¨ç¡®è®¤æˆæƒä¹‹å èµ„æºæœåŠ¡å™¨ä¼šè·³è½¬åˆ°æˆ‘ä»¬æŒ‡å®šçš„ä¸€ä¸ªå›è°ƒurl, å¦‚æœç›´æ¥è¿”å›tokençš„è¯ï¼Œè°éƒ½å¯ä»¥åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°è¿™ä¸ªtoken é‚£å°±æ²¡æœ‰å®‰å…¨æ€§å¯è¨€äº†\nä½†æ˜¯æˆ‘æœ‰ä¸ªæƒ³æ³•ä¸çŸ¥æ˜¯å¦å¯è¡Œ é‚£å°±æ˜¯ä¸ºä»€ä¹ˆ èµ„æºæœåŠ¡å™¨éè¦è·³è½¬åˆ°ç¬¬ä¸‰æ–¹ç«™ç‚¹ç»™çš„å›è°ƒurlå‘¢ï¼Ÿ æˆ‘çš„urlå¦‚æœæ˜¯ä¸ªæ¥å£ èµ„æºæœåŠ¡å™¨å®Œå…¨å¯ä»¥ä¸é€šè¿‡æµè§ˆå™¨è·³è½¬ è€Œæ˜¯ç›´æ¥å›è°ƒæˆ‘çš„æ¥å£ ç›´æ¥å§tokenç»™æˆ‘çš„æœåŠ¡å™¨ï¼Œ ç„¶åæˆ‘çš„æœåŠ¡å™¨å­˜å‚¨å¥½tokenä¹‹å è‡ªå·±å†³å®šå¦‚ä½•è·³è½¬ä¸å°±è¡Œäº†ï¼Ÿ è¿™æ ·å²‚ä¸æ˜¯æ¯”æˆæƒæ¨¡å¼ç®€å•ä¹Ÿæ¯”éšå¼æ¨¡å¼å®‰å…¨\n å›ç­”ï¼š\n é¦–å…ˆï¼Œä»äº§å“äº¤äº’ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æµè§ˆå™¨è·³è½¬åˆ°â€œè®¤è¯æœåŠ¡å™¨â€ï¼Œè®©ç”¨æˆ·æ˜ç¡®è¡¨æ€åŒä¸åŒæ„â€œç¬¬ä¸‰æ–¹ç«™ç‚¹â€çš„æˆæƒè¯·æ±‚ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæµè§ˆå™¨è®¿é—®çš„åœ°å€å·²ç»åˆ°â€œè®¤è¯æœåŠ¡å™¨â€å»äº†ï¼Œä¸è·³è½¬å›æ¥çš„è¯ï¼Œç½‘é¡µä¸åœ¨â€œç¬¬ä¸‰æ–¹ç«™ç‚¹â€çš„æ§åˆ¶ä¸­ï¼Œæ€ä¹ˆè¿›è¡ŒæˆæƒæˆåŠŸåçš„ä¸‹ä¸€æ­¥äº¤äº’å‘¢ï¼Ÿ\næˆæƒç æ¨¡å¼çš„å®‰å…¨è€ƒé‡ï¼Œæ˜¯åŸºäºäº§å“äº¤äº’èƒ½å®Œæˆçš„å‰æä¸‹ï¼Œè€ƒè™‘å¦‚ä½•ä¸åœ¨æµè§ˆå™¨è¿™ç§æš´éœ² url çš„ç¯å¢ƒé‡Œåšåˆ°å®‰å…¨çš„ã€‚\nå¦‚æœä½ æƒ³è¡¨è¾¾çš„æ˜¯â€œè®¤è¯æœåŠ¡å™¨â€è·³è½¬å›æ¥ï¼Œä½†æ˜¯ä¸å¸¦ codeï¼Œè€Œæ˜¯é€šè¿‡ Server å¯¹ Server å°† token ç›´æ¥ç»™â€œç¬¬ä¸‰æ–¹æœåŠ¡å™¨â€ã€‚\nè¿™æ ·ä¼šé€ æˆä¸€ç³»åˆ—é—®é¢˜ï¼š\n  Http åè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œâ€œç¬¬ä¸‰æ–¹æœåŠ¡å™¨â€æ— æ³•ä»ä¸€ä¸ª Server å¯¹ Server çš„è¯·æ±‚è½»æ˜“åŒºåˆ†è¿™ä¸ª token å¯¹ç€è‡ªå·±å½“å‰å“ªä¸ª Sessionã€‚\n  å¦‚æœä¾èµ–ç¬¬ä¸€æ­¥é‡Œï¼Œâ€œç¬¬ä¸‰æ–¹æœåŠ¡å™¨â€è·³è½¬åˆ°â€œè®¤è¯æœåŠ¡å™¨â€æ—¶ä¼ é€’çš„ GET å‚æ•°æ¥ä½œä¸º Session èº«ä»½åŒºåˆ†ï¼Œåˆæ¶‰åŠåˆ°è·³è½¬æœ¬èº«å°±æ˜¯æ˜æ–‡ï¼Œå¯èƒ½è¢«ç¯¡æ”¹çš„é—®é¢˜ï¼Œéœ€è¦åå®šå¤æ‚çš„ç­¾ååè®®æ¥ä¿è¯å®‰å…¨ï¼Œè¿™å’Œ OAuth2 å¸Œæœ›è®¾è®¡ç®€æ´éªŒè¯æ¨¡å¼çš„åˆè¡·è¿èƒŒã€‚\n  å‡è®¾å®‰å…¨é—®é¢˜è§£å†³äº†ï¼Œå·²è·³è½¬å›æ¥çš„â€œç¬¬ä¸‰æ–¹æœåŠ¡å™¨â€ç½‘é¡µéœ€è¦ç­‰å¾…ä¸€ä¸ªä¸çŸ¥é“ä½•æ—¶æ‰ä¼šè¿‡æ¥çš„â€œè®¤è¯æœåŠ¡å™¨â€ Server å›è°ƒï¼Œæ‰èƒ½å‘Šè¯‰ç”¨æˆ·åˆ°åº•æˆæƒæˆåŠŸæ²¡æœ‰ã€‚è¿œä¸å¦‚åŒæ­¥ä¸»åŠ¨å»è¯·æ±‚â€œè®¤è¯æœåŠ¡å™¨â€è·å–æ–¹ä¾¿ã€‚\n   æ€»ç»“ï¼š1. githubé‡å®šå‘å›æ¥çš„å‚æ•°æ˜¯æ˜æ–‡çš„ã€‚2. è¿™æ ·è®¾è®¡æ›´æ–¹ä¾¿\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/oauth2%E7%9A%84%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%94%E5%9B%9Etoken%E4%B9%8B%E5%89%8D%E5%85%88%E8%BF%94%E5%9B%9Ecode%E8%80%8C%E4%B8%8D%E6%98%AF%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9Etoken/","series":["Manual"],"tags":["CS"],"title":"Oauth2çš„æˆæƒç æ¨¡å¼ä¸ºä»€ä¹ˆè¿”å›tokenä¹‹å‰å…ˆè¿”å›codeï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›tokenï¼Ÿ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­å°†OOMåˆ’åˆ†ä¸º: Javaå †æº¢å‡ºã€è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡ºã€æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡ºã€æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º\n1. Javaå †æº¢å‡º /** * JDK1.6/JDK1.8 * * Javaå †å†…å­˜æº¢å‡ºå¼‚å¸¸æµ‹è¯• * * VM Args: -Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError * * @author xuzhijun.online * @date 2019å¹´4æœˆ22æ—¥ */ public class HeapOOM { static class OOMObject{ } public static void main(String[] args) { List\u0026lt;OOMObject\u0026gt; list = new ArrayList\u0026lt;OOMObject\u0026gt;(); while(true) { list.add(new OOMObject()); } } } è¿è¡Œç»“æœï¼š\njava.lang.OutOfMemoryError: Java heap space Dumping heap to java_pid3404.hprof ... Heap dump file created [22045981 bytes in 0.663 secs] å¤„ç†æ–¹æ³•ï¼š\n é¦–å…ˆé€šè¿‡å†…å­˜æ˜ åƒåˆ†æå·¥å…·ï¼ˆå¦‚Eclipse Memory Analyzerï¼‰ å¯¹Dumpå‡ºæ¥çš„å †è½¬å‚¨å¿«ç…§è¿›è¡Œåˆ†æã€‚ åˆ†æ¸…æ¥šåˆ°åº•æ˜¯å‡ºç°äº†å†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰ è¿˜æ˜¯å†…å­˜æº¢å‡ºï¼ˆMemory Overflowï¼‰ ã€‚ å¦‚æœæ˜¯å†…å­˜æ³„æ¼ï¼Œ å¯è¿›ä¸€æ­¥é€šè¿‡å·¥å…·æŸ¥çœ‹æ³„æ¼å¯¹è±¡åˆ°GC Rootsçš„å¼•ç”¨é“¾ï¼Œ æ‰¾åˆ°æ³„æ¼å¯¹è±¡æ˜¯é€šè¿‡æ€æ ·çš„å¼•ç”¨è·¯å¾„ã€ ä¸å“ªäº›GC Rootsç›¸å…³è”ï¼Œ æ‰å¯¼è‡´åƒåœ¾æ”¶é›†å™¨æ— æ³•å›æ”¶å®ƒä»¬ï¼Œ æ ¹æ®æ³„æ¼å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ä»¥åŠå®ƒåˆ°GC Rootså¼•ç”¨é“¾çš„ä¿¡æ¯ï¼Œ ä¸€èˆ¬å¯ä»¥æ¯”è¾ƒå‡†ç¡®åœ°å®šä½åˆ°è¿™äº›å¯¹è±¡åˆ›å»ºçš„ä½ç½®ï¼Œ è¿›è€Œæ‰¾å‡ºäº§ç”Ÿå†…å­˜æ³„æ¼çš„ä»£ç çš„å…·ä½“ä½ç½®ã€‚ å¦‚æœæ˜¯å†…å­˜æº¢å‡ºï¼Œ æ¢å¥è¯è¯´å°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡ç¡®å®éƒ½æ˜¯å¿…é¡»å­˜æ´»çš„ï¼Œ é‚£å°±åº”å½“æ£€æŸ¥Javaè™šæ‹Ÿæœºçš„å †å‚æ•°ï¼ˆ-Xmxä¸-Xmsï¼‰ è®¾ç½®ï¼Œ ä¸æœºå™¨çš„å†…å­˜å¯¹æ¯”ï¼Œ çœ‹çœ‹æ˜¯å¦è¿˜æœ‰å‘ä¸Šè°ƒæ•´çš„ç©ºé—´ã€‚ å†ä»ä»£ç ä¸Šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸäº›å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ã€ æŒæœ‰çŠ¶æ€æ—¶é—´è¿‡é•¿ã€ å­˜å‚¨ç»“æ„è®¾è®¡ä¸åˆç†ç­‰æƒ…å†µï¼Œ å°½é‡å‡å°‘ç¨‹åºè¿è¡ŒæœŸçš„å†…å­˜æ¶ˆè€—ã€‚  2. è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º ç”±äºHotSpotè™šæ‹Ÿæœºä¸­å¹¶ä¸åŒºåˆ†è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œ å› æ­¤å¯¹äºHotSpotæ¥è¯´ï¼Œ -Xosså‚æ•°ï¼ˆè®¾ç½®æœ¬åœ°æ–¹æ³•æ ˆå¤§å°ï¼‰ è™½ç„¶å­˜åœ¨ï¼Œ ä½†å®é™…ä¸Šæ˜¯æ²¡æœ‰ä»»ä½•æ•ˆæœçš„ï¼Œ æ ˆå®¹é‡åªèƒ½ç”±-Xsså‚æ•°æ¥è®¾å®šã€‚ å…³äºè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œ åœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ ä¸­æè¿°äº†ä¸¤ç§å¼‚å¸¸ï¼š\n1ï¼‰ å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦ï¼Œ å°†æŠ›å‡ºStackOverflowErrorå¼‚å¸¸ã€‚\n2ï¼‰ å¦‚æœè™šæ‹Ÿæœºçš„æ ˆå†…å­˜å…è®¸åŠ¨æ€æ‰©å±•ï¼Œ å½“æ‰©å±•æ ˆå®¹é‡æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜æ—¶ï¼Œ å°†æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚\nã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ æ˜ç¡®å…è®¸Javaè™šæ‹Ÿæœºå®ç°è‡ªè¡Œé€‰æ‹©æ˜¯å¦æ”¯æŒæ ˆçš„åŠ¨æ€æ‰©å±•ï¼Œ è€ŒHotSpotè™šæ‹Ÿæœºçš„é€‰æ‹©æ˜¯ä¸æ”¯æŒæ‰©å±•ï¼Œ æ‰€ä»¥é™¤éåœ¨åˆ›å»ºçº¿ç¨‹ç”³è¯·å†…å­˜æ—¶å°±å› æ— æ³•è·å¾—è¶³å¤Ÿå†…å­˜è€Œå‡ºç°OutOfMemoryErrorå¼‚å¸¸ï¼Œ å¦åˆ™åœ¨çº¿ç¨‹è¿è¡Œæ—¶æ˜¯ä¸ä¼šå› ä¸ºæ‰©å±•è€Œå¯¼è‡´å†…å­˜æº¢å‡ºçš„ï¼Œ åªä¼šå› ä¸ºæ ˆå®¹é‡æ— æ³•å®¹çº³æ–°çš„æ ˆå¸§è€Œå¯¼è‡´StackOverflowErrorå¼‚å¸¸ã€‚\næ— æ³•å®¹çº³æ–°çš„æ ˆå¸§æœ‰ä¸¤ç§æƒ…å†µï¼š1. æ ˆå¸§å¤ªæ·± 2. å•ä¸ªæ ˆå¸§å¤ªå¤§ã€‚åˆ†åˆ«æµ‹è¯•å¦‚ä¸‹ï¼š\n2.1 æ ˆå¸§å¤ªæ·± /** * JDK1.8/JDK1.6 * * è™šæ‹Ÿæœºæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆOOMæµ‹è¯•(å‡å°æ ˆå†…å­˜ï¼Œæ¨¡æ‹ŸStackOverflowError) * * VM Args: -Xss128k * * @author 106.55.152.92:30989 * @date 2019å¹´4æœˆ23æ—¥ */ public class JavaVMStackSOF { private int stackLength = 1; public void stackLeak() { stackLength++; stackLeak(); } public static void main(String[] args) throws Throwable { JavaVMStackSOF oom = new JavaVMStackSOF(); try { oom.stackLeak(); } catch (Throwable e) { System.out.println(\u0026#34;stack length: \u0026#34;+oom.stackLength); throw e; } } } è¿è¡Œç»“æœï¼š\nstack length:2402 Exception in thread \u0026#34;main\u0026#34; java.lang.StackOverflowError at org.fenixsoft.oom. JavaVMStackSOF.leak(JavaVMStackSOF.java:20) at org.fenixsoft.oom. JavaVMStackSOF.leak(JavaVMStackSOF.java:21) at org.fenixsoft.oom. JavaVMStackSOF.leak(JavaVMStackSOF.java:21) â€¦â€¦åç»­å¼‚å¸¸å †æ ˆä¿¡æ¯çœç•¥ 2.2 å•ä¸ªæ ˆå¸§å¤ªå¤§ public class JavaVMStackSOF { private static int stackLength = 0; public static void test() { long unused1, unused2, unused3, unused4, unused5, unused6, unused7, unused8, unused9, unused10, unused11, unused12, unused13, unused14, unused15, unused16, unused17, unused18, unused19, unused20, unused21, unused22, unused23, unused24, unused25, unused26, unused27, unused28, unused29, unused30, unused31, unused32, unused33, unused34, unused35, unused36, unused37, unused38, unused39, unused40, unused41, unused42, unused43, unused44, unused45, unused46, unused47, unused48, unused49, unused50, unused51, unused52, unused53, unused54, unused55, unused56, unused57, unused58, unused59, unused60, unused61, unused62, unused63, unused64, unused65, unused66, unused67, unused68, unused69, unused70, unused71, unused72, unused73, unused74, unused75, unused76, unused77, unused78, unused79, unused80, unused81, unused82, unused83, unused84, unused85, unused86, unused87, unused88, unused89, unused90, unused91, unused92, unused93, unused94, unused95, unused96, unused97, unused98, unused99, unused100; stackLength++; test(); unused1 = unused2 = unused3 = unused4 = unused5 = unused6 = unused7 = unused8 = unused9 = unused10 = unused11 = unused12 = unused13 = unused14 = unused15 = unused16 = unused17 = unused18 = unused19 = unused20 = unused21 = unused22 = unused23 = unused24 = unused25 = unused26 = unused27 = unused28 = unused29 = unused30 = unused31 = unused32 = unused33 = unused34 = unused35 = unused36 = unused37 = unused38 = unused39 = unused40 = unused41 = unused42 = unused43 = unused44 = unused45 = unused46 = unused47 = unused48 = unused49 = unused50 = unused51 = unused52 = unused53 = unused54 = unused55 = unused56 = unused57 = unused58 = unused59 = unused60 = unused61 = unused62 = unused63 = unused64 = unused65 = unused66 = unused67 = unused68 = unused69 = unused70 = unused71 = unused72 = unused73 = unused74 = unused75 = unused76 = unused77 = unused78 = unused79 = unused80 = unused81 = unused82 = unused83 = unused84 = unused85 = unused86 = unused87 = unused88 = unused89 = unused90 = unused91 = unused92 = unused93 = unused94 = unused95 = unused96 = unused97 = unused98 = unused99 = unused100 = 0; } public static void main(String[] args) { try { test(); } catch (Error e) { System.out.println(\u0026#34;stack length:\u0026#34; + stackLength); throw e; } } } è¿è¡Œç»“æœ:\nstack length:5675 Exception in thread \u0026#34;main\u0026#34; java.lang.StackOverflowError at org.fenixsoft.oom. JavaVMStackSOF.leak(JavaVMStackSOF.java:27) at org.fenixsoft.oom. JavaVMStackSOF.leak(JavaVMStackSOF.java:28) at org.fenixsoft.oom. JavaVMStackSOF.leak(JavaVMStackSOF.java:28) â€¦â€¦åç»­å¼‚å¸¸å †æ ˆä¿¡æ¯çœç•¥ å®éªŒç»“æœè¡¨æ˜ï¼š æ— è®ºæ˜¯ç”±äºæ ˆå¸§å¤ªå¤§è¿˜æ˜¯è™šæ‹Ÿæœºæ ˆå®¹é‡å¤ªå°ï¼Œ å½“æ–°çš„æ ˆå¸§å†…å­˜æ— æ³•åˆ†é…çš„æ—¶å€™ï¼ŒHotSpotè™šæ‹ŸæœºæŠ›å‡ºçš„éƒ½æ˜¯StackOverflowErrorå¼‚å¸¸ã€‚ å¯æ˜¯å¦‚æœåœ¨å…è®¸åŠ¨æ€æ‰©å±•æ ˆå®¹é‡å¤§å°çš„è™šæ‹Ÿæœºä¸Šï¼Œ ç›¸åŒä»£ç åˆ™ä¼šå¯¼è‡´ä¸ä¸€æ ·çš„æƒ…å†µã€‚ è­¬å¦‚è¿œå¤æ—¶ä»£çš„Classicè™šæ‹Ÿæœºï¼Œ è¿™æ¬¾è™šæ‹Ÿæœºå¯ä»¥æ”¯æŒåŠ¨æ€æ‰©å±•æ ˆå†…å­˜çš„å®¹é‡ï¼Œ åœ¨Windowsä¸Šçš„JDK 1.0.2è¿è¡Œä¸Šè¿°ä»£ç ï¼ˆ2.2 å•ä¸ªæ ˆå¸§å¤ªå¤§çš„ä»£ç ï¼‰çš„è¯ï¼ˆå¦‚æœè¿™æ—¶å€™è¦è°ƒæ•´æ ˆå®¹é‡å°±åº”è¯¥æ”¹ç”¨-osså‚æ•°äº†ï¼‰ ï¼Œ å¾—åˆ°çš„ç»“æœæ˜¯ï¼š\nstack length:3716 java.lang.OutOfMemoryError at org.fenixsoft.oom. JavaVMStackSOF.leak(JavaVMStackSOF.java:27) at org.fenixsoft.oom. JavaVMStackSOF.leak(JavaVMStackSOF.java:28) at org.fenixsoft.oom. JavaVMStackSOF.leak(JavaVMStackSOF.java:28) â€¦â€¦åç»­å¼‚å¸¸å †æ ˆä¿¡æ¯çœç•¥ 2.3 ä¸æ–­çš„åˆ›å»ºçº¿ç¨‹ å¦‚æœæµ‹è¯•æ—¶ä¸é™äºå•çº¿ç¨‹ï¼Œ é€šè¿‡ä¸æ–­å»ºç«‹çº¿ç¨‹çš„æ–¹å¼ï¼Œ åœ¨HotSpotä¸Šä¹Ÿæ˜¯å¯ä»¥äº§ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸çš„ã€‚ ä½†æ˜¯è¿™æ ·äº§ç”Ÿçš„å†…å­˜æº¢å‡ºå¼‚å¸¸å’Œæ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿå¹¶ä¸å­˜åœ¨ä»»ä½•ç›´æ¥çš„å…³ç³»ï¼Œ ä¸»è¦å–å†³äºæ“ä½œç³»ç»Ÿæœ¬èº«çš„å†…å­˜ä½¿ç”¨çŠ¶æ€ã€‚ ç”šè‡³å¯ä»¥è¯´ï¼Œ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ ç»™æ¯ä¸ªçº¿ç¨‹çš„æ ˆåˆ†é…çš„å†…å­˜è¶Šå¤§ï¼Œ åè€Œè¶Šå®¹æ˜“äº§ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚åŸå› å…¶å®ä¸éš¾ç†è§£ï¼Œ æ“ä½œç³»ç»Ÿåˆ†é…ç»™æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜æ˜¯æœ‰é™åˆ¶çš„ï¼Œ è­¬å¦‚32ä½Windowsçš„å•ä¸ªè¿›ç¨‹æœ€å¤§å†…å­˜é™åˆ¶ä¸º2GBã€‚ HotSpotè™šæ‹Ÿæœºæä¾›äº†å‚æ•°å¯ä»¥æ§åˆ¶Javaå †å’Œæ–¹æ³•åŒºè¿™ä¸¤éƒ¨åˆ†çš„å†…å­˜çš„æœ€å¤§å€¼ï¼Œé‚£å‰©ä½™çš„å†…å­˜å³ä¸º2GBï¼ˆæ“ä½œç³»ç»Ÿé™åˆ¶ï¼‰ å‡å»æœ€å¤§å †å®¹é‡ï¼Œ å†å‡å»æœ€å¤§æ–¹æ³•åŒºå®¹é‡ï¼Œ ç”±äºç¨‹åºè®¡æ•°å™¨æ¶ˆè€—å†…å­˜å¾ˆå°ï¼Œ å¯ä»¥å¿½ç•¥æ‰ï¼Œ å¦‚æœæŠŠç›´æ¥å†…å­˜å’Œè™šæ‹Ÿæœºè¿›ç¨‹æœ¬èº«è€—è´¹çš„å†…å­˜ä¹Ÿå»æ‰çš„è¯ï¼Œ å‰©ä¸‹çš„å†…å­˜å°±ç”±è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæ¥åˆ†é…äº†ã€‚ å› æ­¤ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…åˆ°çš„æ ˆå†…å­˜è¶Šå¤§ï¼Œ å¯ä»¥å»ºç«‹çš„çº¿ç¨‹æ•°é‡è‡ªç„¶å°±è¶Šå°‘ï¼Œ å»ºç«‹çº¿ç¨‹æ—¶å°±è¶Šå®¹æ˜“æŠŠå‰©ä¸‹çš„å†…å­˜è€—å°½ã€‚\n/** * JDK1.8/JDK1.6(windowæ“ä½œç³»ç»Ÿå‡æ­»ï¼Œæœªèƒ½è§‚æµ‹åˆ°å¼‚å¸¸) * * åˆ›å»ºçº¿ç¨‹å¯¼è‡´å†…å­˜æº¢å‡ºå¼‚å¸¸ * * VM Args: -Xss2M * * @author 106.55.152.92:30989 * @date 2019å¹´4æœˆ23æ—¥ */ public class JavaVMStackOOM { private void dontStop() { while(true) { } } public void stackLeakByThread() { while(true) { Thread thread = new Thread(new Runnable() { @Override public void run() { dontStop(); } }); thread.start(); } } public static void main(String[] args) { JavaVMStackOOM oom = new JavaVMStackOOM(); oom.stackLeakByThread(); } } [v_error]é‡ç‚¹æç¤ºä¸€ä¸‹ï¼Œ å¦‚æœè¯»è€…è¦å°è¯•è¿è¡Œä¸Šé¢è¿™æ®µä»£ç ï¼Œ è®°å¾—è¦å…ˆä¿å­˜å½“å‰çš„å·¥ä½œï¼Œ ç”±äºåœ¨Windowså¹³å°çš„è™šæ‹Ÿæœºä¸­ï¼Œ Javaçš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„å†…æ ¸çº¿ç¨‹ä¸Š[1]ï¼Œ æ— é™åˆ¶åœ°åˆ›å»ºçº¿ç¨‹ä¼šå¯¹æ“ä½œç³»ç»Ÿå¸¦æ¥å¾ˆå¤§å‹åŠ›ï¼Œ ä¸Šè¿°ä»£ç æ‰§è¡Œæ—¶æœ‰å¾ˆé«˜çš„é£é™©ï¼Œ å¯èƒ½ä¼šç”±äºåˆ›å»ºçº¿ç¨‹æ•°é‡è¿‡å¤šè€Œå¯¼è‡´æ“ä½œç³»ç»Ÿå‡æ­»ã€‚[/v_error] è¿è¡Œç»“æœ:\nException in thread \u0026#34;main\u0026#34; java.lang.OutOfMemoryError: unable to create native thread å¤„ç†æ–¹æ³•ï¼š\n å¦‚æœä½¿ç”¨HotSpotè™šæ‹Ÿæœºé»˜è®¤å‚æ•°ï¼Œ æ ˆæ·±åº¦åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åˆ°è¾¾1000~2000æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œ å¯¹äºæ­£å¸¸çš„æ–¹æ³•è°ƒç”¨ ï¼Œ è¿™ä¸ªæ·±åº¦åº”è¯¥å®Œå…¨å¤Ÿç”¨äº†ï¼Œ å‡ºç°StackOverflowErrorå¼‚å¸¸æ—¶æ£€æŸ¥ä¸šåŠ¡é€»è¾‘æ˜¯å¦åˆç†ã€‚ å¦‚æœæ˜¯å»ºç«‹è¿‡å¤šçº¿ç¨‹å¯¼è‡´çš„å†…å­˜æº¢å‡ºï¼Œ åœ¨ä¸èƒ½å‡å°‘çº¿ç¨‹æ•°é‡æˆ–è€…æ›´æ¢64ä½è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹ï¼Œ å°±åªèƒ½é€šè¿‡å‡å°‘æœ€å¤§å †å’Œå‡å°‘æ ˆå®¹é‡æ¥æ¢å–æ›´å¤šçš„çº¿ç¨‹ã€‚  3. æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º ç”±äºè¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œ æ‰€ä»¥è¿™ä¸¤ä¸ªåŒºåŸŸçš„æº¢å‡ºæµ‹è¯•å¯ä»¥æ”¾åˆ°ä¸€èµ·è¿›è¡Œã€‚\n3.1 è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º [v_tips]String::intern()æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œ å®ƒçš„ä½œç”¨æ˜¯å¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤Stringå¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œ åˆ™è¿”å›ä»£è¡¨æ± ä¸­è¿™ä¸ªå­—ç¬¦ä¸²çš„Stringå¯¹è±¡çš„å¼•ç”¨ï¼› å¦åˆ™ï¼Œ ä¼šå°†æ­¤Stringå¯¹è±¡åŒ…å«çš„å­—ç¬¦ä¸²æ·»åŠ åˆ°å¸¸é‡æ± ä¸­ï¼Œ å¹¶ä¸”è¿”å›æ­¤Stringå¯¹è±¡çš„å¼•ç”¨ã€‚ [/v_tips]\nåœ¨JDK 6æˆ–æ›´æ—©ä¹‹å‰çš„HotSpotè™šæ‹Ÿæœºä¸­ï¼Œ å¸¸é‡æ± éƒ½æ˜¯åˆ†é…åœ¨æ°¸ä¹…ä»£ä¸­ï¼Œ æˆ‘ä»¬å¯ä»¥é€šè¿‡-XXï¼š PermSizeå’Œ-XXï¼š MaxPermSizeé™åˆ¶æ°¸ä¹…ä»£çš„å¤§å°ï¼Œ å³å¯é—´æ¥é™åˆ¶å…¶ä¸­å¸¸é‡æ± çš„å®¹é‡ã€‚\n/** * JDK1.6 * * è¿è¡Œæ—¶å¸¸é‡æ± å¯¼è‡´çš„å†…å­˜æº¢å‡ºå¼‚å¸¸(JDK1.8ä¹‹åå»é™¤äº†æ–¹æ³•åŒº, å¸¸é‡æ± ç§»å…¥å †å†…å­˜ï¼Œå› æ­¤æœ¬å®éªŒåªèƒ½åœ¨JDK1.6ä¸Šæµ‹è¯•) * * VM Args: -XX:PermSize=10M -XX:MaxPermSize=10M * * @author 106.55.152.92:30989 * @date 2019å¹´4æœˆ23æ—¥ */ public class RuntimeConstantPoolOOM { public static void main(String[] args) { //ä½¿ç”¨Listä¿æŒç€å¸¸é‡æ± çš„å¼•ç”¨ï¼Œé¿å…Full GCå›æ”¶å¸¸é‡æ± è¡Œä¸º  List\u0026lt;String\u0026gt; list = new ArrayList\u0026lt;String\u0026gt;(); //10Mçš„PermSizeåœ¨integerèŒƒå›´å†…è¶³å¤Ÿäº§ç”ŸOOMäº†  int i = 0; while(true) { list.add(String.valueOf(i++).intern()); } } } è¿è¡Œç»“æœï¼š\nException in thread \u0026#34;main\u0026#34; java.lang.OutOfMemoryError: PermGen space at java.lang.String.intern(Native Method) at org.fenixsoft.oom.RuntimeConstantPoolOOM.main(RuntimeConstantPoolOOM.java: 18) å› ä¸ºè‡ªJDK 7èµ·ï¼Œ åŸæœ¬å­˜æ”¾åœ¨æ°¸ä¹…ä»£çš„å­—ç¬¦ä¸²å¸¸é‡æ± è¢«ç§»è‡³Javaå †ä¹‹ä¸­ï¼Œ æ‰€ä»¥åœ¨JDK 7åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œ é™åˆ¶æ–¹æ³•åŒºçš„å®¹é‡å¯¹è¯¥æµ‹è¯•ç”¨ä¾‹æ¥è¯´æ˜¯æ¯«æ— æ„ä¹‰çš„ã€‚ è¿™æ—¶å€™ä½¿ç”¨-Xmxå‚æ•°é™åˆ¶æœ€å¤§å †åˆ°6MBå°±èƒ½å¤Ÿçœ‹åˆ°ä»¥ä¸‹ä¸¤ç§è¿è¡Œç»“æœä¹‹ä¸€ï¼Œ å…·ä½“å–å†³äºå“ªé‡Œçš„å¯¹è±¡åˆ†é…æ—¶äº§ç”Ÿäº†æº¢å‡ºï¼š\n// OOMå¼‚å¸¸ä¸€ï¼š Exception in thread \u0026#34;main\u0026#34; java.lang.OutOfMemoryError: Java heap space at java.base/java.lang.Integer.toString(Integer.java:440) at java.base/java.lang.String.valueOf(String.java:3058) at RuntimeConstantPoolOOM.main(RuntimeConstantPoolOOM.java:12) // OOMå¼‚å¸¸äºŒï¼š Exception in thread \u0026#34;main\u0026#34; java.lang.OutOfMemoryError: Java heap space at java.base/java.util.HashMap.resize(HashMap.java:699) at java.base/java.util.HashMap.putVal(HashMap.java:658) at java.base/java.util.HashMap.put(HashMap.java:607) at java.base/java.util.HashSet.add(HashSet.java:220) at RuntimeConstantPoolOOM.main(RuntimeConstantPoolOOM.java from InputFile-Object:14) å…³äºè¿™ä¸ªå­—ç¬¦ä¸²å¸¸é‡æ± çš„å®ç°åœ¨å“ªé‡Œå‡ºç°é—®é¢˜ï¼Œ è¿˜å¯ä»¥å¼•ç”³å‡ºä¸€äº›æ›´æœ‰æ„æ€çš„å½±å“:\n/** * * JDK1.8(true,false)/JDK1.6(false,false) * * JDK1.8ç§»é™¤æ–¹æ³•åŒºï¼Œå¸¸é‡æ± åŠ å…¥åˆ°å †å†…å­˜ï¼Œæ‰€ä»¥newå¯¹è±¡çš„åœ°å€å’Œintern()è¿”å›çš„å¸¸é‡æ± ä¸­çš„åœ°å€æ˜¯ç›¸åŒçš„(è¯¦æƒ…è§ã€ŠJVMè™šæ‹ŸæœºP57ã€‹) * * String.intern()è¿”å›å¼•ç”¨æµ‹è¯• * * @author 106.55.152.92:30989 * @author 2019å¹´4æœˆ23æ—¥ * */ public class RuntimeConstantPoolOOM2 { public static void main(String[] args) { String str1 = new StringBuilder(\u0026#34;è®¡ç®—æœº\u0026#34;).append(\u0026#34;è½¯ä»¶\u0026#34;).toString(); System.out.println(str1.intern() == str1); String str2 = new StringBuilder(\u0026#34;ja\u0026#34;).append(\u0026#34;va\u0026#34;).toString(); System.out.println(str2.intern() == str2); } } JDK 7 åŠå…¶ä»¥ä¸Šç‰ˆæœ¬ä¼šå¾—åˆ°(true,false)ï¼Œè€ŒJDK6ä¼šå¾—åˆ°(false,false)ç»“æœã€‚\n[v_tips]å¯¹str2æ¯”è¾ƒè¿”å›falseï¼Œ è¿™æ˜¯å› ä¸ºâ€œjavaâ€[2]è¿™ä¸ªå­—ç¬¦ä¸²åœ¨æ‰§è¡ŒString-Builder.toString()ä¹‹å‰å°±å·²ç»å‡ºç°è¿‡äº†ï¼Œå®ƒæ˜¯åŠ è½½sun.misc.Vesionçš„æ—¶å€™åŠ å…¥å¸¸é‡æ± çš„ï¼Œ å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»æœ‰å®ƒçš„å¼•ç”¨ï¼Œ ä¸ç¬¦åˆintern()æ–¹æ³•è¦æ±‚â€œé¦–æ¬¡é‡åˆ°â€çš„åŸåˆ™ï¼Œ â€œè®¡ç®—æœºè½¯ä»¶â€è¿™ä¸ªå­—ç¬¦ä¸²åˆ™æ˜¯é¦–æ¬¡å‡ºç°çš„ï¼Œå› æ­¤ç»“æœè¿”å›trueã€‚[/v_tips]\n3.2 æ–¹æ³•åŒºæº¢å‡º æˆ‘ä»¬å†æ¥çœ‹çœ‹æ–¹æ³•åŒºçš„å…¶ä»–éƒ¨åˆ†çš„å†…å®¹ï¼Œ æ–¹æ³•åŒºçš„ä¸»è¦èŒè´£æ˜¯ç”¨äºå­˜æ”¾ç±»å‹çš„ç›¸å…³ä¿¡æ¯ï¼Œ å¦‚ç±»åã€ è®¿é—®ä¿®é¥°ç¬¦ã€ å¸¸é‡æ± ã€ å­—æ®µæè¿°ã€ æ–¹æ³•æè¿°ç­‰ã€‚ å¯¹äºè¿™éƒ¨åˆ†åŒºåŸŸçš„æµ‹è¯•ï¼Œ åŸºæœ¬çš„æ€è·¯æ˜¯è¿è¡Œæ—¶äº§ç”Ÿå¤§é‡çš„ç±»å»å¡«æ»¡æ–¹æ³•åŒºï¼Œ ç›´åˆ°æº¢å‡ºä¸ºæ­¢ã€‚ä¸‹é¢ä»£ç ä¸­ç¬”è€…å€ŸåŠ©äº†CGLibç›´æ¥æ“ä½œå­—èŠ‚ç è¿è¡Œæ—¶ç”Ÿæˆäº†å¤§é‡çš„åŠ¨æ€ç±»ã€‚\nimport net.sf.cglib.proxy.Enhancer; import net.sf.cglib.proxy.MethodInterceptor; import net.sf.cglib.proxy.MethodProxy; import java.lang.reflect.Method; /** * * JDK1.6 * * å€ŸåŠ©CGLibä½¿æ–¹æ³•åŒºå‡ºç°å†…å­˜æº¢å‡ºå¼‚å¸¸ * * * VM Args: -XX:PermSize=10M -XX:MaxPermSize=10M (JDK1.8ä¹‹åå»é™¤äº†æ–¹æ³•åŒº, ç±»æ•°æ®æ”¾å…¥MetaSpaceç›´æ¥å†…å­˜åŒºåŸŸï¼Œè¯¥å‚æ•°æ— æ•ˆ) * * @author 106.55.152.92:30989 * @author 2019å¹´4æœˆ23æ—¥ * */ public class JavaMethodAreaOOM { static class OOMObject { } public static void main(String[] args) { while(true) { Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(OOMObject.class); enhancer.setUseCache(false); enhancer.setCallback(new MethodInterceptor() { @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable { return proxy.invokeSuper(obj, args); } }); enhancer.create(); } } } åœ¨JDK 7ä»¥åŠä»¥å‰ç‰ˆæœ¬ä¸­çš„è¿è¡Œç»“æœï¼š\nCaused by: java.lang.OutOfMemoryError: PermGen space at java.lang.ClassLoader.defineClass1(Native Method) at java.lang.ClassLoader.defineClassCond(ClassLoader.java:632) at java.lang.ClassLoader.defineClass(ClassLoader.java:616) ... 8 more åœ¨JDK 8ä»¥åï¼Œ æ°¸ä¹…ä»£ä¾¿å®Œå…¨é€€å‡ºäº†å†å²èˆå°ï¼Œ å…ƒç©ºé—´ä½œä¸ºå…¶æ›¿ä»£è€…ç™»åœºã€‚ åœ¨é»˜è®¤è®¾ç½®ä¸‹ï¼Œ å‰é¢åˆ—ä¸¾çš„é‚£äº›æ­£å¸¸çš„åŠ¨æ€åˆ›å»ºæ–°ç±»å‹çš„æµ‹è¯•ç”¨ä¾‹å·²ç»å¾ˆéš¾å†è¿«ä½¿è™šæ‹Ÿæœºäº§ç”Ÿæ–¹æ³•åŒºçš„æº¢å‡ºå¼‚å¸¸äº†ã€‚ ä¸è¿‡ä¸ºäº†è®©ä½¿ç”¨è€…æœ‰é¢„é˜²å®é™…åº”ç”¨é‡Œå‡ºç°ç±»ä¼¼äºä¸Šè¿°ä»£ç é‚£æ ·çš„ç ´åæ€§çš„æ“ä½œï¼Œ HotSpotè¿˜æ˜¯æä¾›äº†ä¸€äº›å‚æ•°ä½œä¸ºå…ƒç©ºé—´çš„é˜²å¾¡æªæ–½ï¼Œ ä¸»è¦åŒ…æ‹¬ -XXï¼šMaxMetaspaceSize  -XXï¼šMetaspaceSize -XXï¼šMinMetaspaceFreeRatio\nimport javassist.CtClass; /** * Create by xuzhijun.online on 2019/5/7. */ public class MetaspaceOOM { /** * JVMå‚æ•°:-XX:MetaspaceSize=10m -XX:MaxMetaspaceSize=10m */ static javassist.ClassPool cp = javassist.ClassPool.getDefault(); public static void main(String[] args) throws Exception{ for (int i = 0; ; i++) { CtClass c = cp.makeClass(\u0026#34;com.xzj.TreeNode\u0026#34; + i); if (c.isFrozen()){ c.defrost(); } Class cc = c.toClass(); System.out.println(cc +\u0026#34; \u0026#34; +i); } } } æµ‹è¯•ç»“æœï¼š\nD:\\app\\jdk1.8.0_251\\bin\\java.exe æŠ¥Compressed class space OOM\nclass com.xzj.TreeNode3078 3078 Exception in thread \u0026#34;main\u0026#34; javassist.CannotCompileException: by java.lang.OutOfMemoryError: Compressed class space at javassist.ClassPool.toClass(ClassPool.java:1085) at javassist.ClassPool.toClass(ClassPool.java:1028) at javassist.ClassPool.toClass(ClassPool.java:986) at javassist.CtClass.toClass(CtClass.java:1079) at com.xzj.MetaspaceOOM.main(MetaspaceOOM.java:28) Caused by: java.lang.OutOfMemoryError: Compressed class space at java.lang.ClassLoader.defineClass1(Native Method) at java.lang.ClassLoader.defineClass(ClassLoader.java:756) at java.lang.ClassLoader.defineClass(ClassLoader.java:635) at sun.reflect.GeneratedMethodAccessor1.invoke(Unknown Source) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498) at javassist.ClassPool.toClass2(ClassPool.java:1098) at javassist.ClassPool.toClass(ClassPool.java:1079) ... 4 more æµ‹è¯•ç»“æœï¼š\nD:\\app\\jdk1.8.0_71\\bin\\java.exe å’Œ D:\\app\\jdk1.8.0_20\\bin\\java.exe éƒ½æ˜¯æŠ¥Metaspace OOM\nclass com.xzj.TreeNode5681 5681 Exception in thread \u0026#34;main\u0026#34; javassist.CannotCompileException: by java.lang.OutOfMemoryError: Metaspace at javassist.ClassPool.toClass(ClassPool.java:1085) at javassist.ClassPool.toClass(ClassPool.java:1028) at javassist.ClassPool.toClass(ClassPool.java:986) at javassist.CtClass.toClass(CtClass.java:1079) at com.xzj.MetaspaceOOM.main(MetaspaceOOM.java:20) Caused by: java.lang.OutOfMemoryError: Metaspace at java.lang.ClassLoader.defineClass1(Native Method) at java.lang.ClassLoader.defineClass(ClassLoader.java:760) at java.lang.ClassLoader.defineClass(ClassLoader.java:642) at sun.reflect.GeneratedMethodAccessor1.invoke(Unknown Source) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:497) at javassist.ClassPool.toClass2(ClassPool.java:1098) at javassist.ClassPool.toClass(ClassPool.java:1079) ... 4 more 4. æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ çš„å®¹é‡å¤§å°å¯é€šè¿‡-XXï¼š MaxDirectMemorySizeå‚æ•°æ¥æŒ‡å®šï¼Œ å¦‚æœä¸å»æŒ‡å®šï¼Œ åˆ™é»˜è®¤ä¸Javaå †æœ€å¤§å€¼ï¼ˆç”±-XmxæŒ‡å®šï¼‰ ä¸€è‡´ï¼Œ ä¸‹é¢ä»£ç è¶Šè¿‡äº†DirectByteBufferç±»ç›´æ¥é€šè¿‡åå°„è·å–Unsafeå®ä¾‹è¿›è¡Œå†…å­˜åˆ†é…ã€‚\n/** * VM Argsï¼š -Xmx20M -XX:MaxDirectMemorySize=10M * * @author zzm */ public class DirectMemoryOOM { private static final int _1MB = 1024 * 1024; public static void main(String[] args) throws Exception { Field unsafeField = Unsafe.class.getDeclaredFields()[0]; unsafeField.setAccessible(true); Unsafe unsafe = (Unsafe) unsafeField.get(null); while (true) { unsafe.allocateMemory(_1MB); } } } è¿è¡Œç»“æœï¼š\nException in thread \u0026#34;main\u0026#34; java.lang.OutOfMemoryError at sun.misc.Unsafe.allocateMemory(Native Method) at org.fenixsoft.oom.DMOOM.main(DMOOM.java:20) å¤„ç†æ–¹æ³•ï¼š ä¸€ä¸ªæ˜æ˜¾çš„ç‰¹å¾æ˜¯åœ¨Heap Dumpæ–‡ä»¶ä¸­ä¸ä¼šçœ‹è§æœ‰ä»€ä¹ˆæ˜æ˜¾çš„å¼‚å¸¸æƒ…å†µï¼Œ å¦‚æœè¯»è€…å‘ç°å†…å­˜æº¢å‡ºä¹‹åäº§ç”Ÿçš„Dumpæ–‡ä»¶å¾ˆå°ï¼Œ è€Œç¨‹åºä¸­åˆç›´æ¥æˆ–é—´æ¥ä½¿ç”¨äº†DirectMemoryï¼ˆå…¸å‹çš„é—´æ¥ä½¿ç”¨å°±æ˜¯NIOï¼‰ ï¼Œ é‚£å°±å¯ä»¥è€ƒè™‘é‡ç‚¹æ£€æŸ¥ä¸€ä¸‹ç›´æ¥å†…å­˜æ–¹é¢çš„åŸå› äº†ã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/oom%E5%AE%9E%E6%88%98/","series":["Manual"],"tags":["Java"],"title":"OOMå®æˆ˜"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"æ¨èå…ˆé˜…è¯»ä¸‹é¢æ–‡ç« ï¼Œä»¥å‚¨å¤‡åŸºç¡€çŸ¥è¯†ã€‚\næ–¹å¿—æœ‹openrestyç³»åˆ—ï¼šopenrestyæœ€ä½³æ¡ˆä¾‹æ¡ˆä¾‹-æ±‡æ€»\ré»‘é©¬ç¨‹åºå‘˜ï¼šjavaè‡ªå­¦è¿›é˜¶é«˜æ€§èƒ½webå¹³å°openrestyç®€ä»‹\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/openresty/openresty%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/","series":["Manual"],"tags":["openresty"],"title":"openrestyæœ€ä½³å®è·µ"},{"categories":["äº‘åŸç”Ÿ"],"content":"operatorå®æˆ˜ 1âƒ£ï¸ éœ€æ±‚ æˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ª crd ï¼Œspec åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š\nReplicas\t# å‰¯æœ¬æ•°\rImage\t# é•œåƒ\rResources\t# èµ„æºé™åˆ¶\rEnvs\t# ç¯å¢ƒå˜é‡\rPorts\t# æœåŠ¡ç«¯å£\r2âƒ£ï¸ ç¼–ç  åˆå§‹åŒ–é¡¹ç›®ç›®å½•ï¼š\ntony@192 k8s % pwd /Users/tony/workspace/k8s tony@192 k8s % mkdir -p app-operator/src/github.com/xuzhijvn/app cd app-operator/src/github.com/xuzhijvn/app åˆå§‹åŒ–operatoré¡¹ç›®ç»“æ„ï¼Œå¹¶åˆ›å»ºapiï¼š\noperator-sdk init --domain=huolala.cn --repo=github.com/xuzhijvn/app operator-sdk create api --group app --version v1 --kind App --resource=true --controller=true ä¿®æ”¹ CRD ç±»å‹å®šä¹‰ä»£ç  api/v1/app_types.go:\n/* Copyright 2021. Licensed under the Apache License, Version 2.0 (the \u0026#34;License\u0026#34;); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \u0026#34;AS IS\u0026#34; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. */ package v1 import ( appsv1 \u0026#34;k8s.io/api/apps/v1\u0026#34; corev1 \u0026#34;k8s.io/api/core/v1\u0026#34; metav1 \u0026#34;k8s.io/apimachinery/pkg/apis/meta/v1\u0026#34; ) // EDIT THIS FILE! THIS IS SCAFFOLDING FOR YOU TO OWN! // NOTE: json tags are required. Any new fields you add must have json tags for the fields to be serialized.  // AppSpec defines the desired state of App type AppSpec struct { // INSERT ADDITIONAL SPEC FIELDS - desired state of cluster \t// Important: Run \u0026#34;make\u0026#34; to regenerate code after modifying this file  // Foo is an example field of App. Edit app_types.go to remove/update \t//Foo string `json:\u0026#34;foo,omitempty\u0026#34;` \tReplicas *int32 `json:\u0026#34;replicas\u0026#34;` // å‰¯æœ¬æ•° \tImage string `json:\u0026#34;image\u0026#34;` // é•œåƒ \tResources corev1.ResourceRequirements `json:\u0026#34;resources,omitempty\u0026#34;` // èµ„æºé™åˆ¶ \tEnvs []corev1.EnvVar `json:\u0026#34;envs,omitempty\u0026#34;` // ç¯å¢ƒå˜é‡ \tPorts []corev1.ServicePort `json:\u0026#34;ports,omitempty\u0026#34;` // æœåŠ¡ç«¯å£ } // AppStatus defines the observed state of App type AppStatus struct { // INSERT ADDITIONAL STATUS FIELD - define observed state of cluster \t// Important: Run \u0026#34;make\u0026#34; to regenerate code after modifying this file \tappsv1.DeploymentStatus `json:\u0026#34;,inline\u0026#34;` // ç›´æ¥å¼•ç”¨ DeploymentStatus } //+kubebuilder:object:root=true //+kubebuilder:subresource:status  // App is the Schema for the apps API type App struct { metav1.TypeMeta `json:\u0026#34;,inline\u0026#34;` metav1.ObjectMeta `json:\u0026#34;metadata,omitempty\u0026#34;` Spec AppSpec `json:\u0026#34;spec,omitempty\u0026#34;` Status AppStatus `json:\u0026#34;status,omitempty\u0026#34;` } //+kubebuilder:object:root=true  // AppList contains a list of App type AppList struct { metav1.TypeMeta `json:\u0026#34;,inline\u0026#34;` metav1.ListMeta `json:\u0026#34;metadata,omitempty\u0026#34;` Items []App `json:\u0026#34;items\u0026#34;` } func init() { SchemeBuilder.Register(\u0026amp;App{}, \u0026amp;AppList{}) } æ–°å¢ resource/deployment/deployment.goï¼š\npackage deployment import ( appv1 \u0026#34;github.com/xuzhijvn/app/api/v1\u0026#34; appsv1 \u0026#34;k8s.io/api/apps/v1\u0026#34; corev1 \u0026#34;k8s.io/api/core/v1\u0026#34; metav1 \u0026#34;k8s.io/apimachinery/pkg/apis/meta/v1\u0026#34; \u0026#34;k8s.io/apimachinery/pkg/runtime/schema\u0026#34; ) func New(app *appv1.App) *appsv1.Deployment { labels := map[string]string{\u0026#34;app.example.com/v1\u0026#34;: app.Name} selector := \u0026amp;metav1.LabelSelector{MatchLabels: labels} return \u0026amp;appsv1.Deployment{ TypeMeta: metav1.TypeMeta{ APIVersion: \u0026#34;apps/v1\u0026#34;, Kind: \u0026#34;Deployment\u0026#34;, }, ObjectMeta: metav1.ObjectMeta{ Name: app.Name, Namespace: app.Namespace, OwnerReferences: []metav1.OwnerReference{ *metav1.NewControllerRef(app, schema.GroupVersionKind{ Group: appv1.GroupVersion.Group, Version: appv1.GroupVersion.Version, Kind: \u0026#34;App\u0026#34;, }), }, }, Spec: appsv1.DeploymentSpec{ Replicas: app.Spec.Replicas, Selector: selector, Template: corev1.PodTemplateSpec{ ObjectMeta: metav1.ObjectMeta{ Labels: labels, }, Spec: corev1.PodSpec{ Containers: newContainers(app), }, }, }, } } func newContainers(app *appv1.App) []corev1.Container { var containerPorts []corev1.ContainerPort for _, servicePort := range app.Spec.Ports { var cport corev1.ContainerPort cport.ContainerPort = servicePort.TargetPort.IntVal containerPorts = append(containerPorts, cport) } return []corev1.Container{ { Name: app.Name, Image: app.Spec.Image, Ports: containerPorts, Env: app.Spec.Envs, Resources: app.Spec.Resources, ImagePullPolicy: corev1.PullIfNotPresent, }, } } æ–°å¢ resource/service/service.go\npackage service import ( appv1 \u0026#34;github.com/xuzhijvn/app-operator/api/v1\u0026#34; corev1 \u0026#34;k8s.io/api/core/v1\u0026#34; metav1 \u0026#34;k8s.io/apimachinery/pkg/apis/meta/v1\u0026#34; \u0026#34;k8s.io/apimachinery/pkg/runtime/schema\u0026#34; ) func New(app *appv1.App) *corev1.Service { return \u0026amp;corev1.Service{ TypeMeta: metav1.TypeMeta{ Kind: \u0026#34;Service\u0026#34;, APIVersion: \u0026#34;v1\u0026#34;, }, ObjectMeta: metav1.ObjectMeta{ Name: app.Name, Namespace: app.Namespace, OwnerReferences: []metav1.OwnerReference{ *metav1.NewControllerRef(app, schema.GroupVersionKind{ Group: appv1.GroupVersion.Group, Version: appv1.GroupVersion.Version, Kind: \u0026#34;App\u0026#34;, }), }, }, Spec: corev1.ServiceSpec{ Ports: app.Spec.Ports, Selector: map[string]string{ \u0026#34;app.example.com/v1\u0026#34;: app.Name, }, }, } } ä¿®æ”¹ controller ä»£ç  controllers/app_controller.go\n/* Copyright 2021. Licensed under the Apache License, Version 2.0 (the \u0026#34;License\u0026#34;); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \u0026#34;AS IS\u0026#34; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. */ package controllers import ( \u0026#34;context\u0026#34; \u0026#34;encoding/json\u0026#34; \u0026#34;github.com/xuzhijvn/app/resource/deployment\u0026#34; \u0026#34;github.com/xuzhijvn/app/resource/service\u0026#34; appsv1 \u0026#34;k8s.io/api/apps/v1\u0026#34; corev1 \u0026#34;k8s.io/api/core/v1\u0026#34; \u0026#34;k8s.io/apimachinery/pkg/api/errors\u0026#34; \u0026#34;reflect\u0026#34; \u0026#34;github.com/go-logr/logr\u0026#34; \u0026#34;k8s.io/apimachinery/pkg/runtime\u0026#34; ctrl \u0026#34;sigs.k8s.io/controller-runtime\u0026#34; \u0026#34;sigs.k8s.io/controller-runtime/pkg/client\u0026#34; appv1 \u0026#34;github.com/xuzhijvn/app-operator/api/v1\u0026#34; ) // AppReconciler reconciles a App object type AppReconciler struct { client.Client Log logr.Logger Scheme *runtime.Scheme } //+kubebuilder:rbac:groups=app.huolala.cn,resources=apps,verbs=get;list;watch;create;update;patch;delete //+kubebuilder:rbac:groups=app.huolala.cn,resources=apps/status,verbs=get;update;patch //+kubebuilder:rbac:groups=app.huolala.cn,resources=apps/finalizers,verbs=update  // Reconcile is part of the main kubernetes reconciliation loop which aims to // move the current state of the cluster closer to the desired state. // TODO(user): Modify the Reconcile function to compare the state specified by // the App object against the actual cluster state, and then // perform operations to make the cluster state reflect the state specified by // the user. // // For more details, check Reconcile and its Result here: // - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.8.3/pkg/reconcile func (r *AppReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) { _ = r.Log.WithValues(\u0026#34;app\u0026#34;, req.NamespacedName) // your logic here  // è·å– crd èµ„æº \tinstance := \u0026amp;appv1.App{} if err := r.Client.Get(ctx, req.NamespacedName, instance); err != nil { if errors.IsNotFound(err) { return ctrl.Result{}, nil } return ctrl.Result{}, err } // crd èµ„æºå·²ç»æ ‡è®°ä¸ºåˆ é™¤ \tif instance.DeletionTimestamp != nil { return ctrl.Result{}, nil } oldDeploy := \u0026amp;appsv1.Deployment{} if err := r.Client.Get(ctx, req.NamespacedName, oldDeploy); err != nil { // deployment ä¸å­˜åœ¨ï¼Œåˆ›å»º \tif errors.IsNotFound(err) { // åˆ›å»ºdeployment \tif err := r.Client.Create(ctx, deployment.New(instance)); err != nil { return ctrl.Result{}, err } // åˆ›å»ºservice \tif err := r.Client.Create(ctx, service.New(instance)); err != nil { return ctrl.Result{}, err } // æ›´æ–° crd èµ„æºçš„ Annotations \tdata, _ := json.Marshal(instance.Spec) if instance.Annotations != nil { instance.Annotations[\u0026#34;spec\u0026#34;] = string(data) } else { instance.Annotations = map[string]string{\u0026#34;spec\u0026#34;: string(data)} } if err := r.Client.Update(ctx, instance); err != nil { return ctrl.Result{}, err } } else { return ctrl.Result{}, err } } else { // deployment å­˜åœ¨ï¼Œæ›´æ–° \toldSpec := appv1.AppSpec{} if err := json.Unmarshal([]byte(instance.Annotations[\u0026#34;spec\u0026#34;]), \u0026amp;oldSpec); err != nil { return ctrl.Result{}, err } if !reflect.DeepEqual(instance.Spec, oldSpec) { // æ›´æ–°deployment \tnewDeploy := deployment.New(instance) oldDeploy.Spec = newDeploy.Spec if err := r.Client.Update(ctx, oldDeploy); err != nil { return ctrl.Result{}, err } // æ›´æ–°service \tnewService := service.New(instance) oldService := \u0026amp;corev1.Service{} if err := r.Client.Get(ctx, req.NamespacedName, oldService); err != nil { return ctrl.Result{}, err } clusterIP := oldService.Spec.ClusterIP // æ›´æ–° service å¿…é¡»è®¾ç½®è€çš„ clusterIP \toldService.Spec = newService.Spec oldService.Spec.ClusterIP = clusterIP if err := r.Client.Update(ctx, oldService); err != nil { return ctrl.Result{}, err } // æ›´æ–° crd èµ„æºçš„ Annotations \tdata, _ := json.Marshal(instance.Spec) if instance.Annotations != nil { instance.Annotations[\u0026#34;spec\u0026#34;] = string(data) } else { instance.Annotations = map[string]string{\u0026#34;spec\u0026#34;: string(data)} } if err := r.Client.Update(ctx, instance); err != nil { return ctrl.Result{}, err } } } return ctrl.Result{}, nil } // SetupWithManager sets up the controller with the Manager. func (r *AppReconciler) SetupWithManager(mgr ctrl.Manager) error { return ctrl.NewControllerManagedBy(mgr). For(\u0026amp;appv1.App{}). Complete(r) } ä¿®æ”¹ CRD èµ„æºå®šä¹‰ config/samples/app_v1_app.yaml\napiVersion: app.huolala.cn/v1 kind: App metadata: name: nginx-app namespace: default spec: # Add fields here replicas: 2 image: nginx:1.16.1 ports: - targetPort: 80 port: 8080 envs: - name: DEMO value: app - name: GOPATH value: gopath resources: limits: cpu: 500m memory: 500Mi requests: cpu: 100m memory: 100Mi ä¿®æ”¹ Dockerfile\n# Build the manager binaryFROMgolang:1.15 as builderWORKDIR/workspace# Copy the Go Modules manifestsCOPY go.mod go.modCOPY go.sum go.sum# cache deps before building and copying source so that we don\u0026#39;t need to re-download as much# and so that source changes don\u0026#39;t invalidate our downloaded layerENV GOPROXY https://goproxy.cn,directRUN go mod download# Copy the go sourceCOPY main.go main.goCOPY api/ api/COPY controllers/ controllers/COPY resource/ resource/# BuildRUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 GO111MODULE=on go build -a -o manager main.go# Use distroless as minimal base image to package the manager binary# Refer to https://github.com/GoogleContainerTools/distroless for more details#FROM gcr.io/distroless/static:nonrootFROMkubeimages/distroless-static:latestWORKDIR/COPY --from=builder /workspace/manager .USER65532:65532ENTRYPOINT [\u0026#34;/manager\u0026#34;] æ·»åŠ äº† goproxy ç¯å¢ƒå˜é‡ æ–°å¢ COPY è‡ªå®šä¹‰çš„æ–‡ä»¶å¤¹ resource gcr.io/distroless/static:nonroot å˜æ›´ä¸º kubeimages/distroless-static:latest  3âƒ£ï¸ éƒ¨ç½² xuzhijvn é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼š\nå®‰è£…crdåˆ°é›†ç¾¤ make generate \u0026amp;\u0026amp; make manifests \u0026amp;\u0026amp; make install ç»“æœç¡®è®¤\n[root@k8s-master ~]# kubectl get crd | grep huolala apps.app.huolala.cn 2021-06-27T13:42:09Z æ„å»ºé•œåƒ make docker-build IMG=ccr.ccs.tencentyun.com/huolala.cn/app:v1 ==ç‰¹åˆ«æ³¨æ„==â˜¢ï¸\nâš ï¸ 1. å› ä¸ºdocker-buildä¼šæ‰§è¡Œæµ‹è¯•ï¼Œæµ‹è¯•çš„æ—¶å€™éœ€è¦è¿æ¥githubä¸‹è½½è„šæœ¬è¿è¡Œï¼Œæ­¤æ—¶ææœ‰å¯èƒ½ä¼šæŠ¥443çš„è¿æ¥é”™è¯¯ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠtestæ³¨é‡Šæ‰ã€‚\nâš ï¸ 2. ä¸‹å›¾ä½ç½®é»˜è®¤çš„é•œåƒåœ°å€æ˜¯gcr.io/kubebuilder/kube-rbac-proxy:v0.8.0 è¿™ä¸ªåœ°å€å›½å†…æ— æ³•æ‹‰å–åˆ°é•œåƒï¼Œæ‰€ä»¥éœ€è¦æ›¿æ¢æˆè‡ªå·±çš„é•œåƒåœ°å€ï¼ˆå¯ä»¥å…ˆæ‰¾å°å›½å¤–çš„æœåŠ¡å™¨æ‹‰å–ä¸‹æ¥ï¼Œé‡æ–°æ‰“tagåæ¨é€åˆ°è‡ªå·±çš„é•œåƒä»“åº“ï¼‰ï¼Œå¦‚æœä¸ä¿®æ”¹ï¼Œå®¹å™¨ccr.ccs.tencentyun.com/huolala.cn/app:v1æ— æ³•å¯åŠ¨ã€‚\nâš ï¸ 3. å°† controller éƒ¨ç½²åˆ° k8s é›†ç¾¤çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç° RBAC æƒé™é”™è¯¯ï¼Œè§£å†³æ–¹æ³•æ˜¯ä¿®æ”¹éƒ¨ç½²æ—¶çš„æƒé™é…ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æœ€ç®€å•çš„æ–¹æ³•æ˜¯ç›´æ¥ç»™ controller ç»‘å®šåˆ° cluster-admin é›†ç¾¤ç®¡ç†å‘˜å³å¯\nå¦‚æœä¸ä¿®æ”¹ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š\næ¨é€é•œåƒåˆ°ä»“åº“ è¿™é‡Œç›´æ¥ä½¿ç”¨docker pushï¼Œå› ä¸ºmake docker-pushä¹Ÿåªä½¿ç”¨äº†docker push\ndocker push ccr.ccs.tencentyun.com/huolala.cn/app:v1 éƒ¨ç½² make deploy IMG=ccr.ccs.tencentyun.com/huolala.cn/app:v1 ç»“æœç¡®è®¤\n[root@k8s-master ~]# kubectl get svc -n app-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE app-controller-manager-metrics-service ClusterIP 10.107.174.87 \u0026lt;none\u0026gt; 8443/TCP 12s [root@k8s-master ~]# kubectl get pod -n app-system NAME READY STATUS RESTARTS AGE app-controller-manager-c49568d65-86tpj 2/2 Running 0 22s [root@k8s-master ~]# kubectl get deployment -n app-system NAME READY UP-TO-DATE AVAILABLE AGE app-controller-manager 1/1 1 1 24s åˆ›å»ºè‡ªå®šä¹‰èµ„æº $ kubectl apply -f config/samples/app_v1_app.yaml app.app.example.com/app-sample created ç»“æœç¡®è®¤\n[root@k8s-master ~]# kubectl get svc | grep nginx nginx-app ClusterIP 10.103.202.0 \u0026lt;none\u0026gt; 8080/TCP 73m [root@k8s-master ~]# kubectl get pod | grep nginx nginx-app-57d9d68fb7-8rpc6 2/2 Running 0 73m nginx-app-57d9d68fb7-cwnv9 2/2 Running 0 73m [root@k8s-master ~]# curl http://10.103.202.0:8080 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;For online documentation and support please refer to \u0026lt;a href=\u0026#34;http://nginx.org/\u0026#34;\u0026gt;nginx.org\u0026lt;/a\u0026gt;.\u0026lt;br/\u0026gt; Commercial support is available at \u0026lt;a href=\u0026#34;http://nginx.com/\u0026#34;\u0026gt;nginx.com\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;em\u0026gt;Thank you for using nginx.\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; [root@k8s-master ~]#  å‚è€ƒé“¾æ¥ğŸ”— Kubernetes Operator å¿«é€Ÿå…¥é—¨æ•™ç¨‹\roperator-sdk å®æˆ˜å¼€å‘\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/operator%E5%AE%9E%E6%88%98/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"operatorå®æˆ˜"},{"categories":["åŒºå—é“¾"],"content":"1999å¹´Castroå’ŒLiskovåœ¨ã€Šæ“ä½œç³»ç»Ÿè®¾è®¡ä¸å®ç°ã€‹ä¸Šå‘è¡¨è®ºæ–‡Practical Byzantine Fault Tolerance\rã€‚ä¹‹åCastroå’ŒLiskovä¿®æ”¹äº†ä¹‹å‰è®ºæ–‡çš„éƒ¨åˆ†ç»†èŠ‚ï¼Œ2001å¹´å°†ä¿®æ”¹åçš„è®ºæ–‡Practical Byzantine Fault Tolerance and Proactive Recovery\rå‘è¡¨äºã€ŠACM Transactions on Computer Systems (TOCS)ã€‹ã€‚ä¹‹åå‘è¡¨çš„è¿™ç¯‡è®ºæ–‡å¯¹ä¹‹å‰çš„è®ºæ–‡è¿›è¡Œäº†éƒ¨åˆ†ä¼˜åŒ–ï¼Œpre-prepareæ¶ˆæ¯ä¸å†åŒ…å«è¯·æ±‚æ¶ˆæ¯ï¼ˆåªåŒ…å«æ¶ˆæ¯æ‘˜è¦ï¼‰ï¼Œclientä¸åªæŠŠè¯·æ±‚å‘ç»™ä¸»èŠ‚ç‚¹ï¼ˆä¹Ÿå‘ç»™ä»èŠ‚ç‚¹ï¼‰ç­‰ã€‚fabricä¸­çš„pbftå®ç°ä¹Ÿæ˜¯åŸºäº2001å¹´çš„è®ºæ–‡ï¼Œå› æ­¤å»ºè®®å¤§å®¶ç›´æ¥çœ‹2001å¹´å‘è¡¨çš„è®ºæ–‡ã€‚ä½†æ˜¯å› ä¸ºï¼Œç½‘ä¸Šå¯¹1999å¹´çš„è®ºæ–‡è®²è§£æ¯”è¾ƒå¤šï¼Œæœ¬æ–‡ä¹Ÿä»¥1999å¹´çš„è®ºæ–‡å½¢æˆæ€»ç»“ã€‚\n0. èƒŒæ™¯ æ‹œå åº­é—®é¢˜ï¼ˆByzantine Problemï¼‰ åˆå«æ‹œå åº­å°†å†›ï¼ˆByzantine Generals Problemï¼‰ é—®é¢˜ï¼Œè®¨è®ºçš„æ˜¯å…è®¸å­˜åœ¨å°‘æ•°èŠ‚ç‚¹ä½œæ¶ï¼ˆæ¶ˆæ¯å¯èƒ½è¢«ä¼ªé€ ï¼‰ åœºæ™¯ä¸‹çš„å¦‚ä½•è¾¾æˆå…±è¯†é—®é¢˜ã€‚æ‹œå åº­å®¹é”™ï¼ˆByzantine Fault Tolerantï¼ŒBFTï¼‰è®¨è®ºçš„æ˜¯å®¹å¿æ‹œå åº­é”™è¯¯çš„å…±è¯†ç®—æ³•ã€‚\n ä¸¤å°†å†›é—®é¢˜  æ‹œå åº­é—®é¢˜ä¹‹å‰ï¼Œå­¦æœ¯ç•Œå°±å·²ç»å­˜åœ¨ä¸¤å°†å†›é—®é¢˜çš„è®¨è®ºï¼ˆã€ŠSome constraints and tradeofis in the design of network communicationsã€‹ ï¼Œ1975å¹´ï¼‰ï¼šä¸¤ä¸ªå°†å†›è¦é€šè¿‡ä¿¡ä½¿æ¥è¾¾æˆè¿›æ”»è¿˜æ˜¯æ’¤é€€çš„çº¦å®šï¼Œä½†ä¿¡ä½¿å¯èƒ½è¿·è·¯æˆ–è¢«æ•Œå†›é˜»æ‹¦ï¼ˆæ¶ˆæ¯ä¸¢å¤±æˆ–ä¼ªé€ ï¼‰ï¼Œå¦‚ä½•è¾¾æˆä¸€è‡´ï¼Ÿæ ¹æ®FLPä¸å¯èƒ½åŸç†ï¼Œè¿™ä¸ªé—®é¢˜æ— é€šç”¨è§£ã€‚\n æ‹œå åº­é—®é¢˜  æ‹œå åº­é—®é¢˜æœ€æ—©ç”± Leslie Lamport ç­‰å­¦è€…äº 1982 å¹´åœ¨è®ºæ–‡ã€ŠThe Byzantine Generals Problemã€‹ä¸­æ­£å¼æå‡ºï¼Œæ˜¯ç”¨æ¥è§£é‡Šå¼‚æ­¥ç³»ç»Ÿä¸­å…±è¯†é—®é¢˜çš„ä¸€ä¸ªè™šæ„æ¨¡å‹ã€‚å®ƒæ˜¯åˆ†å¸ƒå¼é¢†åŸŸä¸­æœ€å¤æ‚ã€æœ€ä¸¥æ ¼çš„å®¹é”™æ¨¡å‹ã€‚åœ¨è¯¥æ¨¡å‹ä¸‹ï¼Œç³»ç»Ÿä¸ä¼šå¯¹é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åšä»»ä½•çš„é™åˆ¶ï¼Œå®ƒä»¬å¯ä»¥å‘å…¶ä»–èŠ‚ç‚¹å‘é€éšæœºæ•°æ®ã€é”™è¯¯æ•°æ®ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä¸å“åº”å…¶ä»–èŠ‚ç‚¹çš„è¯·æ±‚ï¼Œè¿™äº›æ— æ³•é¢„æµ‹çš„è¡Œä¸ºä½¿å¾—å®¹é”™è¿™ä¸€é—®é¢˜å˜å¾—æ›´åŠ å¤æ‚ã€‚\næ‹œå åº­æ˜¯å¤ä»£ä¸œç½—é©¬å¸å›½çš„é¦–éƒ½ï¼Œç”±äºåœ°åŸŸå®½å¹¿ï¼Œå‡è®¾å…¶å®ˆå«è¾¹å¢ƒçš„å¤šä¸ªå°†å†›ï¼ˆç³»ç»Ÿä¸­çš„å¤šä¸ªèŠ‚ç‚¹ï¼‰ éœ€è¦é€šè¿‡ä¿¡ä½¿æ¥ä¼ é€’æ¶ˆæ¯ï¼Œè¾¾æˆæŸäº›ä¸€è‡´å†³å®šã€‚ä½†ç”±äºå°†å†›ä¸­å¯èƒ½å­˜åœ¨å›å¾’ï¼ˆç³»ç»Ÿä¸­èŠ‚ç‚¹å‡ºé”™ï¼‰ï¼Œè¿™äº›å›å¾’å°†å‘ä¸åŒçš„å°†å†›å‘é€ä¸åŒçš„æ¶ˆæ¯ï¼Œè¯•å›¾å¹²æ‰°å…±è¯†çš„è¾¾æˆã€‚æ‹œå åº­é—®é¢˜å³è®¨è®ºåœ¨æ­¤æƒ…å†µä¸‹ï¼Œå¦‚ä½•è®©å¿ è¯šçš„å°†å†›ä»¬èƒ½è¾¾æˆè¡ŒåŠ¨çš„ä¸€è‡´ã€‚\nåœ¨å¤§å¤šæ•°çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ‹œå åº­çš„åœºæ™¯å¹¶ä¸å¤šè§ã€‚ç„¶è€Œåœ¨ç‰¹å®šåœºæ™¯ä¸‹å­˜åœ¨æ„ä¹‰ï¼Œä¾‹å¦‚å…è®¸åŒ¿åå‚ä¸çš„ç³»ç»Ÿï¼ˆå¦‚æ¯”ç‰¹å¸ï¼‰ ï¼Œæˆ–æ˜¯å‡ºç°æ¬ºè¯ˆå¯èƒ½é€ æˆå·¨å¤§æŸå¤±çš„æƒ…å†µã€‚\n æ‹œå åº­å®¹é”™ç®—æ³•  æ‹œå åº­å®¹é”™ç®—æ³•ï¼ˆByzantine Fault Tolerantï¼‰æ˜¯é¢å‘æ‹œå åº­é—®é¢˜çš„å®¹é”™ç®—æ³•ï¼Œè§£å†³çš„æ˜¯åœ¨ç½‘ç»œé€šä¿¡å¯é ï¼Œä½†èŠ‚ç‚¹å¯èƒ½æ•…éšœå’Œä½œæ¶æƒ…å†µä¸‹å¦‚ä½•è¾¾æˆå…±è¯†ã€‚\næ‹œå åº­å®¹é”™ç®—æ³•æœ€æ—©çš„è®¨è®ºå¯ä»¥è¿½æº¯åˆ°Leslie Lamportç­‰äºº1982å¹´å‘è¡¨çš„è®ºæ–‡ã€ŠThe Byzantine Generals Problemã€‹ï¼Œä¹‹åå‡ºç°äº†å¤§é‡çš„æ”¹è¿›å·¥ä½œï¼Œä»£è¡¨æ€§æˆæœåŒ…æ‹¬ã€ŠOptimal Asynchronous Byzantine Agreementã€‹ï¼ˆ1992å¹´ï¼‰ã€ã€ŠFully Polynomial Byzantine Agreement for n\u0026gt;3t Processors in t+1 Roundsã€‹ï¼ˆ1998å¹´ï¼‰ç­‰ã€‚é•¿æœŸä»¥æ¥ï¼Œæ‹œå åº­é—®é¢˜çš„è§£å†³æ–¹æ¡ˆéƒ½å­˜åœ¨è¿è¡Œè¿‡æ…¢ï¼Œæˆ–å¤æ‚åº¦è¿‡é«˜çš„é—®é¢˜ï¼Œç›´åˆ°â€œå®ç”¨æ‹œå åº­å®¹é”™ç®—æ³•â€ï¼ˆPractical Byzantine Fault Toleranceï¼ŒPBFTï¼‰ç®—æ³•çš„æå‡ºã€‚\n1999å¹´ï¼Œè¿™ä¸€ç®—æ³•ç”±Castroå’ŒLiskoväºè®ºæ–‡ã€ŠPractical Byzantine Fault Toleranceã€‹ä¸­æå‡ºã€‚è¯¥ç®—æ³•åŸºäºå‰äººå·¥ä½œï¼ˆç‰¹åˆ«æ˜¯Paxosç›¸å…³ç®—æ³•ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸ºByzantine Paxosï¼‰è¿›è¡Œäº†ä¼˜åŒ–ï¼Œé¦–æ¬¡å°†æ‹œå åº­å®¹é”™ç®—æ³•å¤æ‚åº¦ä»æŒ‡æ•°çº§é™ä½åˆ°äº†å¤šé¡¹å¼çº§ï¼Œç›®å‰å·²å¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚å…¶å¯ä»¥åœ¨æ¶æ„èŠ‚ç‚¹ä¸è¶…è¿‡æ€»æ•°1/3çš„æƒ…å†µä¸‹åŒæ—¶ä¿è¯Safetyå’ŒLivenessã€‚\nPBFTç®—æ³•é‡‡ç”¨å¯†ç å­¦ç›¸å…³æŠ€æœ¯ï¼ˆRSAç­¾åç®—æ³•ã€æ¶ˆæ¯éªŒè¯ç¼–ç å’Œæ‘˜è¦ï¼‰ç¡®ä¿æ¶ˆæ¯ä¼ é€’è¿‡ç¨‹æ— æ³•è¢«ç¯¡æ”¹å’Œç ´åã€‚\nç®—æ³•æ•´ä½“çš„åŸºæœ¬è¿‡ç¨‹å¦‚ä¸‹ï¼š\n  é¦–å…ˆï¼Œé€šè¿‡è½®æ¢æˆ–éšæœºç®—æ³•é€‰å‡ºæŸä¸ªèŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ï¼Œæ­¤ååªè¦ä¸»èŠ‚ç‚¹ä¸åˆ‡æ¢ï¼Œåˆ™ç§°ä¸ºä¸€ä¸ªè§†å›¾ï¼ˆViewï¼‰ ã€‚\n  åœ¨æŸä¸ªè§†å›¾ä¸­ï¼Œå®¢æˆ·ç«¯å°†è¯·æ±‚\u0026lt;REQUEST,operation,timestamp,client\u0026gt; å‘é€ç»™ä¸»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹è´Ÿè´£å¹¿æ’­è¯·æ±‚åˆ°æ‰€æœ‰å…¶å®ƒå‰¯æœ¬èŠ‚ç‚¹ã€‚\n  æ‰€æœ‰èŠ‚ç‚¹å¤„ç†å®Œæˆè¯·æ±‚ï¼Œå°†å¤„ç†ç»“æœ \u0026lt;REPLY,view,timestamp,client,id_node,response\u0026gt;è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯æ£€æŸ¥æ˜¯å¦æ”¶åˆ°äº†è‡³å°‘ f+1 ä¸ªæ¥è‡ªä¸åŒèŠ‚ç‚¹çš„ç›¸åŒç»“æœï¼Œä½œä¸ºæœ€ç»ˆç»“æœã€‚\n  ä¸»èŠ‚ç‚¹å¹¿æ’­è¿‡ç¨‹åŒ…æ‹¬ä¸‰ä¸ªé˜¶æ®µçš„å¤„ç†ï¼šé¢„å‡†å¤‡ï¼ˆPre-Prepareï¼‰ã€å‡†å¤‡ï¼ˆPrepareï¼‰å’Œæäº¤ï¼ˆCommitï¼‰ã€‚é¢„å‡†å¤‡å’Œå‡†å¤‡é˜¶æ®µç¡®ä¿åœ¨åŒä¸€ä¸ªè§†å›¾å†…è¯·æ±‚å‘é€çš„é¡ºåºæ­£ç¡®ï¼›å‡†å¤‡å’Œæäº¤é˜¶æ®µåˆ™ç¡®ä¿åœ¨ä¸åŒè§†å›¾ä¹‹é—´çš„ç¡®è®¤è¯·æ±‚æ˜¯ä¿åºçš„ã€‚æ¥ä¸‹æ¥è¯¦ç»†è§£é‡Špbftç®—æ³•æµç¨‹ã€‚\n1. pbft 1.1 ç®—æ³•æµç¨‹ pbftç®—æ³•é€šè¿‡ä¸‰é˜¶æ®µå¹¿æ’­åè®®æ¥ä½¿æ‰€æœ‰æ­£å¸¸èŠ‚ç‚¹æŒ‰ç›¸åŒçš„é¡ºåºæ‰§è¡Œè¯·æ±‚ï¼Œä¸‰é˜¶æ®µåˆ†åˆ«ä¸ºpre-prepareã€prepareå’Œcommitã€‚pre-prepareé˜¶æ®µå’Œprepareé˜¶æ®µç¡®ä¿äº†åœ¨åŒä¸€ä¸ªviewä¸‹ï¼Œæ­£å¸¸èŠ‚ç‚¹å¯¹äºæ¶ˆæ¯mè¾¾æˆäº†å…¨å±€ä¸€è‡´çš„é¡ºåºï¼Œç”¨(Order\u0026lt;v, m, n\u0026gt;)è¡¨ç¤ºï¼Œåœ¨view = vä¸‹ï¼Œæ­£å¸¸èŠ‚ç‚¹éƒ½ä¼šå¯¹æ¶ˆæ¯mï¼Œç¡®è®¤ä¸€ä¸ªåºå·nã€‚æ¥ä¸‹æ¥çš„commitæŠ•ç¥¨ï¼Œå†é…åˆä¸Šviewchangeçš„è®¾è®¡ï¼Œå®ç°äº†å³ä½¿viewåˆ‡æ¢ï¼Œä¹Ÿå¯ä»¥ä¿è¯å¯¹äºmçš„å…¨å±€ä¸€è‡´é¡ºåºï¼Œå³(Order\u0026lt;v+1, m, n\u0026gt;)ï¼Œè§†å›¾åˆ‡æ¢åˆ°v+1, ä¾ç„¶ä¼šå¯¹æ¶ˆæ¯mï¼Œç¡®è®¤åºå·nã€‚\nä¸‰é˜¶æ®µåè®®\nä¸‰é˜¶æ®µåè®®æ•°æ®ç»“æ„\n- pre-prepare  pre-prepareé˜¶æ®µçš„æ¶ˆæ¯æ ¼å¼(\u0026laquo;PRE-PREPARE, v, n, d\u0026gt;sigma(p), m\u0026gt;)ï¼Œå…¶ä¸­vè¡¨ç¤ºå½“å‰viewç¼–å·ï¼Œnè¡¨ç¤ºç»™måˆ†é…çš„åºå·ï¼Œdä¸ºmçš„å“ˆå¸Œï¼Œä»¥åŠmçš„åŸæ–‡ã€‚\n èŠ‚ç‚¹æ”¶åˆ°è¯·æ±‚mæ—¶ï¼Œä¼šåšä¸¤ä»¶äº‹ï¼Œé¦–å…ˆï¼Œå¹¿æ’­pre-prepareæ¶ˆæ¯ç»™å…¶ä»–èŠ‚ç‚¹ã€‚ç„¶åï¼Œå°†æ¶ˆæ¯ä¿å­˜åœ¨æœ¬åœ°logä¸­ã€‚\nå…¶ä»–ä»èŠ‚ç‚¹æ”¶åˆ°pre-prepareæ¶ˆæ¯æ—¶ï¼Œä¼šä¾æ¬¡éªŒè¯ï¼š\n ç­¾åéªŒè¯ æ£€æµ‹væ˜¯å¦åˆæ³• æ£€æµ‹næ˜¯å¦åˆæ³•ï¼ˆç›¸åŒã€é—´éš”ã€æ˜¯å¦åœ¨æ°´çº¿\u0026lt;h, H\u0026gt;ä¹‹å†…ï¼‰   æ€»ç»“ï¼š\n ä¸»èŠ‚ç‚¹å‘å‡ºpre-prepareæ¶ˆæ¯ï¼Œä»èŠ‚ç‚¹éªŒè¯æ¶ˆæ¯çš„æ­£ç¡®æ€§ï¼ˆå®¢æˆ·ç«¯ç­¾åã€è§†å›¾ã€è¯·æ±‚ç¼–å·ï¼‰ï¼›ä¸€æ—¦æ¶ˆæ¯éªŒè¯æ­£ç¡®ï¼Œåˆ™pre-prepareé˜¶æ®µå®Œæˆï¼Œä»èŠ‚ç‚¹å¹¿æ’­prepareæ¶ˆæ¯ï¼Œè¿›å…¥prepareé˜¶æ®µï¼›ä¹‹åï¼ŒèŠ‚ç‚¹å°†æ¶ˆæ¯åŠ å…¥åˆ°æœ¬åœ°çš„logä¸­ã€‚\n- prepare  prepareé˜¶æ®µçš„æ¶ˆæ¯æ ¼å¼(\u0026lt;PREPARE, v, n, d, i\u0026gt;sigma(i))ï¼Œå…¶ä¸­vè¡¨ç¤ºå½“å‰viewç¼–å·ï¼Œnè¡¨ç¤ºç»™måˆ†é…çš„åºå·ï¼Œdä¸ºmçš„å“ˆå¸Œã€‚\n æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°prepareæ¶ˆæ¯æ—¶ï¼Œä¼šä¾æ¬¡éªŒè¯ï¼š\n ç­¾åéªŒè¯ æ£€æµ‹væ˜¯å¦åˆæ³• æ£€æµ‹næ˜¯å¦åˆæ³•ï¼ˆç›¸åŒã€é—´éš”ã€æ˜¯å¦åœ¨æ°´çº¿\u0026lt;h, H\u0026gt;ä¹‹å†…ï¼‰  èŠ‚ç‚¹æ”¶åˆ°2f+1ä¸ªè¯¥æ¶ˆæ¯ç¼–å·çš„prepareæ¶ˆæ¯ï¼Œåˆ™è¡¨æ˜prepareé˜¶æ®µå®Œæˆï¼ŒèŠ‚ç‚¹è¾¾æˆäº†preparedçŠ¶æ€ï¼Œè®°ä¸ºprepared(m,v,n,i)ï¼ŒèŠ‚ç‚¹å¹¿æ’­commitæ¶ˆæ¯ï¼ŒåŒæ—¶è¿›å…¥commité˜¶æ®µï¼›\nè‡³æ­¤ï¼Œå¯ä»¥ç¡®ä¿åœ¨viewä¸å‘ç”Ÿåˆ‡æ¢çš„æƒ…å†µä¸‹ï¼Œå¯¹äºæ¶ˆæ¯mæœ‰å…¨å±€ä¸€è‡´çš„é¡ºåºã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨viewä¸å˜çš„æƒ…å†µçš„ä¸‹:\n(1) ä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹iï¼Œä¸èƒ½å¯¹ä¸¤ä¸ªåŠä»¥ä¸Šçš„ä¸åŒæ¶ˆæ¯ï¼Œè¾¾æˆç›¸åŒåºå·nçš„preparedçŠ¶æ€ã€‚å³ä¸èƒ½åŒæ—¶å­˜åœ¨prepared(m,v,n,i)å’Œprepared(m',v,n,i)\n(2) ä¸¤ä¸ªæ­£å¸¸èŠ‚ç‚¹iã€jï¼Œå¿…é¡»å¯¹ç›¸åŒçš„æ¶ˆæ¯mï¼Œè¾¾æˆç›¸åŒåºå·nçš„preparedçŠ¶æ€ã€‚prepared(m,v,n,i) \u0026amp;\u0026amp; prepared(m,v,n,j)\n è¯æ˜ï¼š\n (1) å‡å¦‚æ­£å¸¸èŠ‚ç‚¹i, å¯¹äºæ¶ˆæ¯mè¾¾æˆäº†prepared(m,v,n,i)ï¼ŒåŒæ—¶å­˜åœ¨ä¸€ä¸ªm'ï¼Œä¹Ÿè¾¾æˆäº†prepared(m',v,n,i)ã€‚\né¦–å…ˆå¯¹äºprepared(m,v,n,i)ï¼Œè‚¯å®šæœ‰2m+1ä¸ªèŠ‚ç‚¹å‘å‡ºäº†\u0026lt;prepare,m,v,n\u0026gt;æ¶ˆæ¯ã€‚\nå¯¹äºprepared(m',v,n,i)ï¼Œè‚¯å®šä¹Ÿæœ‰2m+1ä¸ªèŠ‚ç‚¹å‘å‡ºäº†\u0026lt;prepare,m',v,n\u0026gt;ã€‚\n2*(2f+1) - (3f+1) = f+1\næ‰€ä»¥è‡³å°‘æœ‰f+1ä¸ªèŠ‚ç‚¹ï¼Œæ—¢å‘å‡ºäº†\u0026lt;prepare,m,v,n\u0026gt;ï¼Œåˆå‘å‡ºäº†\u0026lt;prepare,m',v,n\u0026gt;ï¼Œè¿™æ˜æ˜¾æ˜¯æ‹œå åº­è¡Œä¸ºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‡³å°‘æœ‰f+1ä¸ªæ‹œå åº­èŠ‚ç‚¹ï¼Œè€Œè¿™ä¸å®¹é”™æ¡ä»¶ç›¸çŸ›ç›¾ã€‚\n(2) å‡å¦‚ä¸¤ä¸ªæ­£å¸¸èŠ‚ç‚¹iã€jï¼Œåˆ†åˆ«å¯¹ä¸åŒçš„æ¶ˆæ¯mã€m'ï¼Œè¾¾æˆåºå·nçš„preparedçŠ¶æ€ï¼Œprepared(m,v,n,i)å’Œprepared(m',v,n,j)\né¦–å…ˆå¯¹äºprepared(m,v,n,i)ï¼Œè‚¯å®šæœ‰2m+1ä¸ªèŠ‚ç‚¹å‘å‡ºäº†\u0026lt;prepare,m,v,n\u0026gt;æ¶ˆæ¯ã€‚\nå¯¹äºprepared(m',v,n,j)ï¼Œè‚¯å®šä¹Ÿæœ‰2m+1ä¸ªèŠ‚ç‚¹å‘å‡ºäº†\u0026lt;prepare,m',v,n\u0026gt;ã€‚\n2*(2f+1) - (3f+1) = f+1\næ‰€ä»¥è‡³å°‘æœ‰f+1ä¸ªèŠ‚ç‚¹ï¼Œæ—¢å‘å‡ºäº†\u0026lt;prepare,m,v,n\u0026gt;ï¼Œåˆå‘å‡ºäº†\u0026lt;prepare,m',v,n\u0026gt;ï¼Œè¿™æ˜æ˜¾æ˜¯æ‹œå åº­è¡Œä¸ºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‡³å°‘æœ‰f+1ä¸ªæ‹œå åº­èŠ‚ç‚¹ï¼Œè€Œè¿™ä¸å®¹é”™æ¡ä»¶ç›¸çŸ›ç›¾ã€‚\npreparedçŠ¶æ€æ˜¯ååˆ†é‡è¦çš„ï¼Œå½“æ¶‰åŠåˆ°viewè½¬æ¢æ—¶ï¼Œä¸ºäº†ä¿è¯viewåˆ‡æ¢å‰åçš„safetyç‰¹æ€§ï¼Œéœ€è¦å°†ä¸Šä¸€è½®viewçš„ä¿¡æ¯ä¼ é€’åˆ°æ–°çš„viewï¼Œè€Œåœ¨pbftä¸­å°±æ˜¯å°†preparedçŠ¶æ€ä¿¡æ¯ä¼ é€’åˆ°æ–°çš„viewã€‚å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œæ–°çš„viewä¸­éœ€è¦åœ¨ä¸Šä¸€è½®viewçš„preparedä¿¡æ¯åŸºç¡€ä¸Šï¼Œç»§ç»­è¿›è¡Œå…±è¯†ã€‚\n æ€»ç»“ï¼š\n èŠ‚ç‚¹æ”¶åˆ°prepareæ¶ˆæ¯ï¼ŒèŠ‚ç‚¹éªŒè¯æ¶ˆæ¯çš„æ­£ç¡®æ€§ï¼ˆç­¾åã€è§†å›¾ã€è¯·æ±‚ç¼–å·ï¼‰ï¼›ä¸€æ—¦2f+1ä¸ªprepareæ¶ˆæ¯éªŒè¯æ­£ç¡®ï¼Œåˆ™prepareé˜¶æ®µå®Œæˆï¼ŒèŠ‚ç‚¹å¹¿æ’­commitæ¶ˆæ¯ï¼ŒåŒæ—¶è¿›å…¥commité˜¶æ®µï¼›ä¹‹åï¼ŒèŠ‚ç‚¹å°†æ¶ˆæ¯åŠ å…¥åˆ°æœ¬åœ°çš„logä¸­ã€‚\n- commit  commité˜¶æ®µçš„æ¶ˆæ¯æ ¼å¼(\u0026lt;COMMIT, v, n, d, i\u0026gt;sigma(i))ï¼Œå…¶ä¸­vè¡¨ç¤ºå½“å‰viewç¼–å·ï¼Œnè¡¨ç¤ºç»™måˆ†é…çš„åºå·ï¼Œdä¸ºmçš„å“ˆå¸Œã€‚\n å…¶ä»–ä»èŠ‚ç‚¹æ”¶åˆ°commitæ¶ˆæ¯æ—¶ï¼Œä¼šä¾æ¬¡éªŒè¯ï¼š\n ç­¾åéªŒè¯ æ£€æµ‹væ˜¯å¦åˆæ³• æ£€æµ‹næ˜¯å¦åˆæ³•ï¼ˆç›¸åŒã€é—´éš”ã€æ˜¯å¦åœ¨æ°´çº¿\u0026lt;h, H\u0026gt;ä¹‹å†…ï¼‰  èŠ‚ç‚¹æ¥æ”¶commitæ¶ˆæ¯åï¼Œä¼šåƒæ”¶åˆ°prepareæ¶ˆæ¯ä¸€æ ·è¿›è¡Œå‡ æ­¥éªŒè¯å·²ç¡®å®šæ˜¯å¦æ¥å—è¯¥æ¶ˆæ¯ã€‚\nå½“èŠ‚ç‚¹iï¼Œè¾¾æˆäº†prepared(m,v,n,i)çŠ¶æ€ï¼Œå¹¶ä¸”æ”¶åˆ°äº†(2f+1)ä¸ªcommit(v,n,d,i)æ¶ˆæ¯ï¼Œåˆ™è¯¥èŠ‚ç‚¹è¾¾æˆäº†commit-local(m,v,n,i)çŠ¶æ€ã€‚\nè¾¾æˆcommit-localä¹‹åï¼ŒèŠ‚ç‚¹å¯¹äºæ¶ˆæ¯må°±æœ‰äº†ä¸€ä¸ªå…¨å±€ä¸€è‡´çš„é¡ºåºï¼Œå¯ä»¥æ‰§è¡Œè¯¥æ¶ˆæ¯å¹¶reply toå®¢æˆ·ç«¯äº†ã€‚\ncommit-localçŠ¶æ€è¯´æ˜æœ‰2f+1ä¸ªèŠ‚ç‚¹è¾¾æˆäº†preparedçŠ¶æ€.\n æ€»ç»“ï¼š\n èŠ‚ç‚¹æ”¶åˆ°2f+1ä¸ªè¯¥æ¶ˆæ¯ç¼–å·çš„commitæ¶ˆæ¯ï¼Œåˆ™commité˜¶æ®µå®Œæˆï¼ŒèŠ‚ç‚¹æ‰§è¡Œå®¢æˆ·ç«¯è¯·æ±‚æ“ä½œã€‚\n1.2 åƒåœ¾å›æ”¶ ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œç³»ç»Ÿéœ€è¦ä¸€ç§å°†æ—¥å¿—ä¸­çš„æ— å¼‚è®®æ¶ˆæ¯è®°å½•åˆ é™¤çš„æœºåˆ¶ã€‚ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œå‰¯æœ¬èŠ‚ç‚¹åœ¨åˆ é™¤è‡ªå·±çš„æ¶ˆæ¯æ—¥å¿—å‰ï¼Œéœ€è¦ç¡®ä¿è‡³å°‘f+1ä¸ªæ­£å¸¸å‰¯æœ¬èŠ‚ç‚¹æ‰§è¡Œäº†æ¶ˆæ¯å¯¹åº”çš„è¯·æ±‚ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è§†å›¾å˜æ›´æ—¶å‘å…¶ä»–å‰¯æœ¬èŠ‚ç‚¹è¯æ˜ã€‚å¦å¤–ï¼Œå¦‚æœä¸€äº›å‰¯æœ¬èŠ‚ç‚¹é”™è¿‡éƒ¨åˆ†æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™äº›æ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰æ­£å¸¸å‰¯æœ¬èŠ‚ç‚¹åˆ é™¤äº†ï¼Œè¿™å°±éœ€è¦é€šè¿‡ä¼ è¾“éƒ¨åˆ†æˆ–è€…å…¨éƒ¨æœåŠ¡çŠ¶æ€å®ç°è¯¥å‰¯æœ¬èŠ‚ç‚¹çš„åŒæ­¥ã€‚å› æ­¤ï¼Œå‰¯æœ¬èŠ‚ç‚¹åŒæ ·éœ€è¦è¯æ˜çŠ¶æ€çš„æ­£ç¡®æ€§ã€‚\nåœ¨æ¯ä¸€ä¸ªæ“ä½œæ‰§è¡Œåéƒ½ç”Ÿæˆè¿™æ ·çš„è¯æ˜æ˜¯éå¸¸æ¶ˆè€—èµ„æºçš„ã€‚å› æ­¤ï¼Œè¯æ˜è¿‡ç¨‹åªæœ‰åœ¨è¯·æ±‚åºå·å¯ä»¥è¢«æŸä¸ªå¸¸æ•°ï¼ˆæ¯”å¦‚100ï¼‰æ•´é™¤çš„æ—¶å€™æ‰ä¼šå‘¨æœŸæ€§åœ°è¿›è¡Œã€‚æˆ‘ä»¬å°†è¿™äº›è¯·æ±‚æ‰§è¡Œåå¾—åˆ°çš„çŠ¶æ€ç§°ä½œæ£€æŸ¥ç‚¹ï¼ˆcheckpointï¼‰ï¼Œå¹¶ä¸”å°†å…·æœ‰è¯æ˜çš„æ£€æŸ¥ç‚¹ç§°ä½œç¨³å®šæ£€æŸ¥ç‚¹ï¼ˆstable checkpointï¼‰ã€‚\nå‰¯æœ¬èŠ‚ç‚¹ä¿å­˜äº†æœåŠ¡çŠ¶æ€çš„å¤šä¸ªé€»è¾‘æ‹·è´ï¼ŒåŒ…æ‹¬æœ€æ–°çš„ç¨³å®šæ£€æŸ¥ç‚¹ï¼Œé›¶ä¸ªæˆ–è€…å¤šä¸ªéç¨³å®šçš„æ£€æŸ¥ç‚¹ï¼Œä»¥åŠä¸€ä¸ªå½“å‰çŠ¶æ€ã€‚å†™æ—¶å¤åˆ¶æŠ€æœ¯å¯ä»¥è¢«ç”¨æ¥å‡å°‘å­˜å‚¨é¢å¤–çŠ¶æ€æ‹·è´çš„ç©ºé—´å¼€é”€ã€‚\næ£€æŸ¥ç‚¹çš„æ­£ç¡®æ€§è¯æ˜çš„ç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹ï¼šå½“å‰¯æœ¬èŠ‚ç‚¹iç”Ÿæˆä¸€ä¸ªæ£€æŸ¥ç‚¹åï¼Œå‘å…¶ä»–å‰¯æœ¬èŠ‚ç‚¹å¹¿æ’­æ£€æŸ¥ç‚¹æ¶ˆæ¯\u0026lt;CHECKPOINT,n,d,i\u0026gt;ï¼Œè¿™é‡Œnæ˜¯æœ€è¿‘ä¸€ä¸ªå½±å“çŠ¶æ€çš„è¯·æ±‚åºå·ï¼Œdæ˜¯çŠ¶æ€çš„æ‘˜è¦ã€‚æ¯ä¸ªå‰¯æœ¬èŠ‚ç‚¹éƒ½é»˜é»˜åœ°åœ¨å„è‡ªçš„æ—¥å¿—ä¸­æ”¶é›†å¹¶è®°å½•å…¶ä»–èŠ‚ç‚¹å‘è¿‡æ¥çš„æ£€æŸ¥ç‚¹æ¶ˆæ¯ï¼Œç›´åˆ°æ”¶åˆ°æ¥è‡ª2f+1ä¸ªä¸åŒå‰¯æœ¬èŠ‚ç‚¹çš„å…·æœ‰ç›¸åŒåºå·nå’Œæ‘˜è¦dçš„æ£€æŸ¥ç‚¹æ¶ˆæ¯ã€‚è¿™2f+1ä¸ªæ¶ˆæ¯å°±æ˜¯è¿™ä¸ªæ£€æŸ¥ç‚¹çš„æ­£ç¡®æ€§è¯æ˜ã€‚\nå…·æœ‰è¯æ˜çš„æ£€æŸ¥ç‚¹æˆä¸ºç¨³å®šæ£€æŸ¥ç‚¹ï¼Œç„¶åå‰¯æœ¬èŠ‚ç‚¹å°±å¯ä»¥å°†æ‰€æœ‰åºå·å°äºç­‰äºnçš„é¢„å‡†å¤‡ã€å‡†å¤‡å’Œç¡®è®¤æ¶ˆæ¯ä»æ—¥å¿—ä¸­åˆ é™¤ã€‚åŒæ—¶ä¹Ÿå¯ä»¥å°†ä¹‹å‰çš„æ£€æŸ¥ç‚¹å’Œæ£€æŸ¥ç‚¹æ¶ˆæ¯ä¸€å¹¶åˆ é™¤ã€‚\næ£€æŸ¥ç‚¹åè®®å¯ä»¥ç”¨æ¥æ›´æ–°æ°´çº¿ï¼ˆwatermarkï¼‰çš„é«˜ä½å€¼ï¼ˆhå’ŒHï¼‰ï¼Œè¿™ä¸¤ä¸ªé«˜ä½å€¼é™å®šäº†å¯ä»¥è¢«æ¥å—çš„æ¶ˆæ¯ã€‚æ°´çº¿çš„ä½å€¼hä¸æœ€è¿‘ç¨³å®šæ£€æŸ¥ç‚¹çš„åºåˆ—å·ç›¸åŒï¼Œè€Œæ°´çº¿çš„é«˜å€¼H=h+kï¼Œkéœ€è¦è¶³å¤Ÿå¤§æ‰èƒ½ä½¿å‰¯æœ¬ä¸è‡³äºä¸ºäº†ç­‰å¾…ç¨³å®šæ£€æŸ¥ç‚¹è€Œåœé¡¿ã€‚åŠ å…¥æ£€æŸ¥ç‚¹æ¯100ä¸ªè¯·æ±‚äº§ç”Ÿä¸€æ¬¡ï¼Œkçš„å–å€¼å¯ä»¥æ˜¯200ã€‚\n ä¸¾ä¾‹ï¼š\n stable checkpoint å°±æ˜¯å¤§éƒ¨åˆ†èŠ‚ç‚¹ ï¼ˆ2f+1ï¼‰ å·²ç»å…±è¯†å®Œæˆçš„æœ€å¤§è¯·æ±‚åºå·ã€‚æ¯”å¦‚ç³»ç»Ÿæœ‰ 4 ä¸ªèŠ‚ç‚¹ï¼Œä¸‰ä¸ªèŠ‚ç‚¹éƒ½å·²ç»å…±è¯†å®Œäº†çš„è¯·æ±‚ç¼–å·æ˜¯ 100 ï¼Œé‚£ä¹ˆè¿™ä¸ª 100 å°±æ˜¯ stable checkpoint äº†ã€‚é‚£è®¾ç½®è¿™ä¸ª stable checkpoint æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿæœ€å¤§çš„ç›®çš„å°±æ˜¯å‡å°‘å†…å­˜çš„å ç”¨ã€‚å› ä¸ºæ¯ä¸ªèŠ‚ç‚¹åº”è¯¥è®°å½•ä¸‹ä¹‹å‰æ›¾ç»å…±è¯†è¿‡ä»€ä¹ˆè¯·æ±‚ï¼Œä½†å¦‚æœä¸€ç›´è®°å½•ä¸‹å»ï¼Œæ•°æ®ä¼šè¶Šæ¥è¶Šå¤§ï¼Œæ‰€ä»¥åº”è¯¥æœ‰ä¸€ä¸ªæœºåˆ¶æ¥å®ç°å¯¹æ•°æ®çš„åˆ é™¤ã€‚é‚£æ€ä¹ˆåˆ å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œæ¯”å¦‚ç°åœ¨çš„ç¨³å®šæ£€æŸ¥ç‚¹æ˜¯ 100 ï¼Œé‚£ä¹ˆä»£è¡¨ 100 å·ä¹‹å‰çš„è®°å½•å·²ç»å…±è¯†è¿‡çš„äº†ï¼Œæ‰€ä»¥ä¹‹å‰çš„è®°å½•å°±å¯ä»¥åˆ æ‰äº†ã€‚\n1.3 è§†å›¾å˜æ›´ å¦‚æœä¸»èŠ‚ç‚¹ä½œæ¶ï¼Œå®ƒå¯èƒ½ä¼šç»™ä¸åŒçš„è¯·æ±‚ç¼–ä¸Šç›¸åŒçš„åºå·ï¼Œæˆ–è€…ä¸å»åˆ†é…åºå·ï¼Œæˆ–è€…è®©ç›¸é‚»çš„åºå·ä¸è¿ç»­ã€‚å¤‡ä»½èŠ‚ç‚¹åº”å½“æœ‰èŒè´£æ¥ä¸»åŠ¨æ£€æŸ¥è¿™äº›åºå·çš„åˆæ³•æ€§ã€‚å¦‚æœä¸»èŠ‚ç‚¹æ‰çº¿æˆ–è€…ä½œæ¶ä¸å¹¿æ’­å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå®¢æˆ·ç«¯è®¾ç½®è¶…æ—¶æœºåˆ¶ï¼Œè¶…æ—¶çš„è¯ï¼Œå‘æ‰€æœ‰å‰¯æœ¬èŠ‚ç‚¹å¹¿æ’­è¯·æ±‚æ¶ˆæ¯ã€‚å‰¯æœ¬èŠ‚ç‚¹æ£€æµ‹å‡ºä¸»èŠ‚ç‚¹ä½œæ¶æˆ–è€…ä¸‹çº¿ï¼Œå‘èµ·View Changeæ¶ˆæ¯ã€‚\nVIEW-CHANGE\n \u0026lt;VIEW-CHANGE, v+1, n, C, P, i\u0026gt;sigma(i)æ¶ˆæ¯ã€‚næ˜¯æœ€æ–°çš„stable checkpointçš„ç¼–å·ï¼ŒCæ˜¯2f+1éªŒè¯è¿‡çš„CheckPointæ¶ˆæ¯é›†åˆï¼ŒPæ˜¯å½“å‰å‰¯æœ¬èŠ‚ç‚¹æœªå®Œæˆçš„è¯·æ±‚çš„PRE-PREPAREå’ŒPREPAREæ¶ˆæ¯é›†åˆã€‚\n NEW-VIEW\n \u0026lt;NEW-VIEW, v+1, V, O\u0026gt;sigma(p)æ¶ˆæ¯ã€‚Væ˜¯æœ‰æ•ˆçš„VIEW-CHANGEæ¶ˆæ¯é›†åˆã€‚Oæ˜¯ä¸»èŠ‚ç‚¹é‡æ–°å‘èµ·çš„æœªç»å®Œæˆçš„PRE-PREPAREæ¶ˆæ¯é›†åˆã€‚PRE-PREPAREæ¶ˆæ¯é›†åˆçš„é€‰å–è§„åˆ™ï¼š\n  é€‰å–Vä¸­æœ€å°çš„stable checkpointç¼–å·min-sï¼Œé€‰å–Vä¸­prepareæ¶ˆæ¯çš„æœ€å¤§ç¼–å·max-sã€‚ åœ¨min-så’Œmax-sä¹‹é—´ï¼Œå¦‚æœå­˜åœ¨Pæ¶ˆæ¯é›†åˆï¼Œåˆ™åˆ›å»º\u0026laquo;PRE-PREPARE, v+1, n, d\u0026gt;, m\u0026gt;æ¶ˆæ¯ã€‚å¦åˆ™åˆ›å»ºä¸€ä¸ªç©ºçš„PRE-PREPAREæ¶ˆæ¯ï¼Œå³ï¼š\u0026laquo;PRE-PREPARE, v+1, n, d(null)\u0026gt;, m(null)\u0026gt;, m(null)ç©ºæ¶ˆæ¯ï¼Œd(null)ç©ºæ¶ˆæ¯æ‘˜è¦ã€‚  å½“ä¸»èŠ‚ç‚¹p = v + 1 mod |R|æ”¶åˆ°2fä¸ªæœ‰æ•ˆçš„VIEW-CHANGEæ¶ˆæ¯åï¼Œå‘å…¶ä»–èŠ‚ç‚¹å¹¿æ’­\u0026lt;NEW-VIEW, v+1, V, O\u0026gt;sigma(p)æ¶ˆæ¯ï¼Œå‰¯æœ¬èŠ‚ç‚¹æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„NEW-VIEWæ¶ˆæ¯ï¼ŒéªŒè¯æœ‰æ•ˆæ€§ï¼Œæœ‰æ•ˆçš„è¯ï¼Œè¿›å…¥v+1çŠ¶æ€ï¼Œå¹¶ä¸”å¼€å§‹Oä¸­çš„PRE-PREPAREæ¶ˆæ¯å¤„ç†æµç¨‹ã€‚\n æ€»ç»“ï¼š\n å¯ä»¥è¿™æ ·ç†è§£ï¼Œåœ¨æ–°çš„viewä¸­ï¼ŒèŠ‚ç‚¹æ˜¯åœ¨ä¸Šä¸€è½®viewä¸­å„ä¸ªèŠ‚ç‚¹çš„preparedçŠ¶æ€åŸºç¡€ä¸Šè¿›è¡Œå…±è¯†æµç¨‹çš„ã€‚\n Notesï¼š\n å‘ç”Ÿviewè½¬æ¢æ—¶ï¼Œéœ€è¦çš„ä¿è¯çš„æ˜¯ï¼šå¦‚æœè§†å›¾è½¬æ¢ä¹‹å‰çš„æ¶ˆæ¯mè¢«åˆ†é…äº†åºå·n, å¹¶ä¸”è¾¾åˆ°äº†preparedçŠ¶æ€ï¼Œé‚£ä¹ˆåœ¨è§†å›¾è½¬æ¢ä¹‹åï¼Œè¯¥æ¶ˆæ¯ä¹Ÿå¿…é¡»è¢«åˆ†é…åºå·n(safetyç‰¹æ€§)ã€‚å› ä¸ºè¾¾åˆ°preparedçŠ¶æ€ä»¥åï¼Œå°±æœ‰å¯èƒ½å­˜åœ¨æŸä¸ªèŠ‚ç‚¹commit-localã€‚è¦ä¿è¯å¯¹äºmçš„commit-localï¼Œåœ¨è§†å›¾è½¬æ¢ä¹‹åï¼Œå…¶ä»–èŠ‚ç‚¹çš„commit-localä¾ç„¶æ˜¯ä¸€æ ·çš„åºå·ã€‚\n1.4 pbftä¼˜åŒ–  å‡å°‘é€šä¿¡  æŒ‡å®šä¸€ä¸ªèŠ‚ç‚¹å›å¤clientå®Œæ•´çš„æ‰§è¡Œç»“æœï¼Œå…¶ä»–èŠ‚ç‚¹åªå›å¤ç»“æœæ‘˜è¦ï¼›å¦‚æœå¯¹æ¯”æ‘˜è¦ä¸ä¸€è‡´ï¼Œé‡æ–°å‘é€è¯¥è¯·æ±‚ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰èŠ‚ç‚¹çš„å®Œæ•´ç»“æœã€‚èŠ‚çœäº†å¸¦å®½ èŠ‚ç‚¹åˆ°è¾¾preparedçŠ¶æ€å°±æ‰§è¡Œè¯·æ±‚ï¼ŒèŠ‚ç‚¹å°†è¿™ä¸ªä¸´æ—¶æ‰§è¡Œç»“æœå›å¤ç»™clientç«¯ã€‚å¦‚æœclientæ”¶åˆ°2f+1ä¸ªä¸´æ—¶å›å¤ï¼Œå°±èƒ½ä¿è¯è¯¥è¯·æ±‚æœ€ç»ˆä¹Ÿæ˜¯ä»¥è¿™ä¸ªç»“æœæäº¤çš„ã€‚å¦åˆ™ï¼Œèµ°ä¸‰é˜¶æ®µå¸¸è§„æµç¨‹ï¼Œç­‰å¾…f+1ä¸ªä¸€è‡´å›å¤ã€‚ çœç•¥äº†comimité˜¶æ®µ å¯¹äºåªè¯»æ“ä½œï¼Œclientå°†è¯·æ±‚å¹¿æ’­ç»™æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¹‹åçš„æµç¨‹åŒä¸Šã€‚çœç•¥äº†pre-prepareé˜¶æ®µ   åªåœ¨view-changeå’Œnew-viewæ—¶æ‰é‡‡ç”¨æ•°å­—ç­¾åï¼Œå…¶ä»–æ‰€æœ‰æ¶ˆæ¯é‡‡ç”¨æ¶ˆæ¯éªŒè¯ç ï¼ˆMACsï¼‰è®¤è¯ã€‚  2. æ–°çš„è§£å†³æ€è·¯ æ‹œå åº­é—®é¢˜ä¹‹æ‰€ä»¥éš¾è§£ï¼Œåœ¨äºä»»ä½•æ—¶å€™ç³»ç»Ÿä¸­éƒ½å¯èƒ½å­˜åœ¨å¤šä¸ªææ¡ˆï¼ˆå› ä¸ºææ¡ˆæˆæœ¬å¾ˆä½ï¼‰ï¼Œå¹¶ä¸”åœ¨å¤§è§„æ¨¡åœºæ™¯ä¸‹è¦å®Œæˆæœ€ç»ˆç¡®è®¤çš„è¿‡ç¨‹å®¹æ˜“å—å¹²æ‰°ï¼Œéš¾ä»¥è¾¾æˆå…±è¯†ã€‚\n2014 å¹´ï¼Œæ–¯å¦ç¦çš„ Christopher Copeland å’Œ Hongxia Zhong åœ¨è®ºæ–‡ã€ŠTangaroa: a byzantine fault tolerant raftã€‹ ä¸­æå‡ºåœ¨ Raft ç®—æ³•åŸºç¡€ä¸Šå€Ÿé‰´ PBFT ç®—æ³•çš„ä¸€äº›ç‰¹æ€§ï¼ˆåŒ…æ‹¬ç­¾åã€æ¶æ„é¢†å¯¼æ¢æµ‹ã€é€‰ä¸¾æ ¡éªŒç­‰ï¼‰ æ¥å®ç°æ‹œå åº­å®¹é”™æ€§ï¼Œå…¼é¡¾å¯å®ç°æ€§å’Œé²æ£’æ€§ã€‚è¯¥è®ºæ–‡ä¹Ÿå¯å‘äº†Kadena ç­‰é¡¹ç›®çš„å‡ºç°ï¼Œå®ç°æ›´å¥½æ€§èƒ½çš„æ‹œå åº­ç®—æ³•ã€‚\n2017å¹´ï¼ŒMITè®¡ç®—æœºç§‘å­¦ä¸äººå·¥æ™ºèƒ½å®éªŒå®¤ï¼ˆCSAILï¼‰çš„Yossi Giladå’ŒSilvio Micaliç­‰äººåœ¨è®ºæ–‡ã€ŠAlgorand: Scaling Byzantine Agreements for Cryptocurrenciesã€‹ ä¸­é’ˆå¯¹PBFTç®—æ³•åœ¨å¾ˆå¤šèŠ‚ç‚¹æƒ…å†µä¸‹æ€§èƒ½ä¸ä½³çš„é—®é¢˜ï¼Œæå‡ºå…ˆé€‰å‡ºå°‘é‡è®°è´¦èŠ‚ç‚¹ï¼Œç„¶åå†åˆ©ç”¨å¯éªŒè¯éšæœºå‡½æ•°ï¼ˆVerifiable Random Functionï¼ŒVRFï¼‰æ¥éšæœºé€‰å–é¢†å¯¼èŠ‚ç‚¹ï¼Œé¿å…å…¨ç½‘ç›´æ¥åšå…±è¯†ï¼Œå°†æ‹œå åº­ç®—æ³•æ‰©å±•åˆ°äº†æ”¯æŒè¾ƒå¤§è§„æ¨¡çš„åº”ç”¨åœºæ™¯ï¼ŒåŒæ—¶ä¿æŒè¾ƒå¥½çš„æ€§èƒ½ï¼ˆ1000+ tpsï¼‰ã€‚\næ­¤å¤–ï¼Œåº·å¥ˆå°”å¤§å­¦çš„Rafael Passå’ŒElaine Shiåœ¨è®ºæ–‡ã€ŠThe Sleepy Model of Consensusã€‹ä¸­è¿˜æ¢è®¨äº†åœ¨åŠ¨æ€åœºæ™¯ï¼ˆå¤§é‡èŠ‚ç‚¹ç¦»çº¿æƒ…å†µï¼‰ä¸‹å¦‚ä½•ä¿éšœå…±è¯†çš„å®‰å…¨æ€§ï¼Œæ‰€æå‡ºçš„Sleepy Consensusç®—æ³•å¯ä»¥åœ¨æ´»è·ƒè¯šå®èŠ‚ç‚¹è¾¾åˆ°ä¸€åŠä»¥ä¸Šæ—¶ç¡®ä¿å®Œæˆæ‹œå åº­å…±è¯†ã€‚\n2018å¹´ï¼Œæ¸…åå¤§å­¦çš„Chenxing Liç­‰åœ¨è®ºæ–‡ã€ŠScaling Nakamoto Consensus to Thousands of Transactions per Secondã€‹ä¸­æå‡ºäº†Confluxå…±è¯†åè®®ã€‚è¯¥åè®®åœ¨ GHOSTç®—æ³•åŸºç¡€ä¸Šæ”¹å–„äº†å®‰å…¨æ€§ï¼Œé¢å‘å…¬æœ‰åŒºå—é“¾åœºæ™¯ä¸‹ï¼Œç†è®ºä¸Šèƒ½è¾¾åˆ°6000+ tpsã€‚\næ¯”ç‰¹å¸ç½‘ç»œåœ¨è®¾è®¡æ—¶ä½¿ç”¨äº†PoWï¼ˆProof of Workï¼‰çš„æ¦‚ç‡å‹ç®—æ³•æ€è·¯ï¼Œä»å¦‚ä¸‹ä¸¤ä¸ªè§’åº¦è§£å†³å¤§è§„æ¨¡åœºæ™¯ä¸‹çš„æ‹œå åº­å®¹é”™é—®é¢˜ã€‚\né¦–å…ˆï¼Œé™åˆ¶ä¸€æ®µæ—¶é—´å†…æ•´ä¸ªç½‘ç»œä¸­å‡ºç°ææ¡ˆçš„ä¸ªæ•°ï¼ˆé€šè¿‡å·¥ä½œé‡è¯æ˜æ¥å¢åŠ ææ¡ˆæˆæœ¬ï¼‰ï¼›å…¶æ¬¡æ˜¯ä¸¢æ‰æœ€ç»ˆç¡®è®¤çš„çº¦æ•°ï¼Œçº¦å®šå¥½å§‹ç»ˆæ²¿ç€å·²çŸ¥æœ€é•¿çš„é“¾è¿›è¡Œæ‹“å±•ã€‚å…±è¯†çš„æœ€ç»ˆç¡®è®¤æ˜¯æ¦‚ç‡æ„ä¹‰ä¸Šçš„å­˜åœ¨ã€‚è¿™æ ·ï¼Œå³ä¾¿æœ‰äººè¯•å›¾æ¶æ„ç ´åï¼Œä¹Ÿä¼šä»˜å‡ºç›¸åº”çš„ç»æµä»£ä»·ï¼ˆè¶…è¿‡æ•´ä½“ç³»ç»Ÿä¸€åŠçš„å·¥ä½œé‡ï¼‰ ã€‚\nåæ¥çš„å„ç§ PoX ç³»åˆ—ç®—æ³•ï¼Œä¹Ÿéƒ½æ˜¯æ²¿ç€è¿™ä¸ªæ€è·¯è¿›è¡Œæ”¹è¿›ï¼Œé‡‡ç”¨ç»æµåšå¼ˆæ¥åˆ¶çº¦æ”»å‡»è€…ã€‚\nå‚è€ƒæ–‡çŒ® Practical Byzantine Fault Tolerance\rPractical Byzantine Fault Tolerance and Proactive Recovery\råŒºå—é“¾æŠ€æœ¯æŒ‡å—\rpbftæµç¨‹æ·±å±‚åˆ†æå’Œè§£é‡Š\rPBFTå®ç”¨æ‹œå åº­å®¹é”™ç®—æ³•æ·±å…¥è¯¦è§£\rå¯¹PBFTç®—æ³•çš„ç†è§£\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%8C%BA%E5%9D%97%E9%93%BE/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95/pbft/","series":["Manual"],"tags":["BlockChain"],"title":"pbft"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"RFCæ ‡å‡†åŒºåˆ« æ ¹æ®RFCå®šä¹‰çš„httpæ ‡å‡†ï¼ŒåŒºåˆ«å¦‚ä¸‹ï¼š\n GET ç”¨äºè·å–ä¿¡æ¯ï¼Œæ˜¯æ— å‰¯ä½œç”¨çš„ï¼Œæ˜¯å¹‚ç­‰çš„ï¼Œä¸”å¯ç¼“å­˜ POST ç”¨äºä¿®æ”¹æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼Œæœ‰å‰¯ä½œç”¨ï¼Œéå¹‚ç­‰ï¼Œä¸å¯ç¼“å­˜  å®é™…åŒºåˆ« GET å’Œ POST æ–¹æ³•æ²¡æœ‰å®è´¨åŒºåˆ«ï¼Œåªæ˜¯æŠ¥æ–‡æ ¼å¼ä¸åŒã€‚\nGET å’Œ POST åªæ˜¯ HTTP åè®®ä¸­ä¸¤ç§è¯·æ±‚æ–¹å¼ï¼Œè€Œ HTTP åè®®æ˜¯åŸºäº TCP/IP çš„åº”ç”¨å±‚åè®®ï¼Œæ— è®º GET è¿˜æ˜¯ POSTï¼Œç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªä¼ è¾“å±‚åè®®ï¼Œæ‰€ä»¥åœ¨ä¼ è¾“ä¸Šï¼Œæ²¡æœ‰åŒºåˆ«ã€‚\nä½ å¯ä»¥åœ¨GETè¯·æ±‚çš„bodyé‡Œé¢å‘å‚æ•°ï¼Œä¹Ÿå¯ä»¥åœ¨POSTè¯·æ±‚çš„urlåé¢è·Ÿå‚æ•°ã€‚\nç°å®ä¸­ï¼Œä¹‹æ‰€ä»¥ä¼šæœ‰è¯¸å¦‚ï¼šGETè¯·æ±‚æœ‰é•¿åº¦é™åˆ¶è¿™æ ·çš„å·®å¼‚ï¼Œæ˜¯ä¸æµè§ˆå™¨å’ŒæœåŠ¡ç«¯å®ç°ç»†èŠ‚æœ‰å…³ï¼Œä¸httpåè®®æœ¬èº«æ— å…³ï¼Œä¸æ˜¯httpåè®®è§„å®šçš„è¿™äº›å·®å¼‚ã€‚\nå…¶ä»–åŒºåˆ« æœ‰äº›æ–‡ç« ä¸­æåˆ°ï¼Œpost ä¼šå°† header å’Œ body åˆ†å¼€å‘é€ï¼Œå…ˆå‘é€ headerï¼ŒæœåŠ¡ç«¯è¿”å› 100 çŠ¶æ€ç å†å‘é€ bodyã€‚\nHTTP åè®®ä¸­æ²¡æœ‰æ˜ç¡®è¯´æ˜ POST ä¼šäº§ç”Ÿä¸¤ä¸ª TCP æ•°æ®åŒ…ï¼Œè€Œä¸”å®é™…æµ‹è¯•(Chrome)å‘ç°ï¼Œheader å’Œ body ä¸ä¼šåˆ†å¼€å‘é€ã€‚\næ‰€ä»¥ï¼Œheader å’Œ body åˆ†å¼€å‘é€æ˜¯éƒ¨åˆ†æµè§ˆå™¨æˆ–æ¡†æ¶çš„è¯·æ±‚æ–¹æ³•ï¼Œä¸å±äº post å¿…ç„¶è¡Œä¸ºã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/http/post%E5%92%8Cget/","series":["Manual"],"tags":["CS"],"title":"postå’Œget"},{"categories":["äº‘åŸç”Ÿ"],"content":"pvcä¸ä¼šä¸»åŠ¨å›æ”¶é—®é¢˜\nä½¿ç”¨k8séƒ¨ç½²nacosçš„æ—¶å€™å‘ç°ï¼Œé€šè¿‡volumeClaimTemplatesé…ç½®çš„pvcä¸ä¼šéšç€ä½¿ç”¨kubectl delete -f xxx.yaml åˆ é™¤StatefulSetçš„æ—¶å€™ä¸€åŒè¢«åˆ é™¤ã€‚nacos-pvc-nfs.yamlæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š\n--- apiVersion: v1 kind: Service metadata: name: nacos-headless labels: app: nacos annotations: service.alpha.kubernetes.io/tolerate-unready-endpoints: \u0026#34;true\u0026#34; spec: ports: - port: 8848 name: server targetPort: 8848 - port: 7848 name: rpc targetPort: 7848 clusterIP: None selector: app: nacos --- apiVersion: v1 kind: ConfigMap metadata: name: nacos-cm data: mysql.db.name: \u0026#34;nacos_devtest\u0026#34; mysql.port: \u0026#34;3306\u0026#34; mysql.user: \u0026#34;nacos\u0026#34; mysql.password: \u0026#34;nacos\u0026#34; --- apiVersion: apps/v1 kind: StatefulSet metadata: name: nacos spec: serviceName: nacos-headless replicas: 3 template: metadata: labels: app: nacos annotations: pod.alpha.kubernetes.io/initialized: \u0026#34;true\u0026#34; spec: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: \u0026#34;app\u0026#34; operator: In values: - nacos topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; serviceAccountName: nfs-client-provisioner initContainers: - name: peer-finder-plugin-install image: nacos/nacos-peer-finder-plugin:1.0 imagePullPolicy: Always volumeMounts: - mountPath: \u0026#34;/home/nacos/plugins/peer-finder\u0026#34; name: nacos-plugindir containers: - name: nacos imagePullPolicy: Always image: nacos/nacos-server:latest resources: requests: memory: \u0026#34;2Gi\u0026#34; cpu: \u0026#34;500m\u0026#34; ports: - containerPort: 8848 name: client-port - containerPort: 7848 name: rpc env: - name: NACOS_REPLICAS value: \u0026#34;3\u0026#34; - name: SERVICE_NAME value: \u0026#34;nacos-headless\u0026#34; - name: DOMAIN_NAME value: \u0026#34;cluster.local\u0026#34; - name: POD_NAMESPACE valueFrom: fieldRef: apiVersion: v1 fieldPath: metadata.namespace - name: MYSQL_SERVICE_DB_NAME valueFrom: configMapKeyRef: name: nacos-cm key: mysql.db.name - name: MYSQL_SERVICE_PORT valueFrom: configMapKeyRef: name: nacos-cm key: mysql.port - name: MYSQL_SERVICE_USER valueFrom: configMapKeyRef: name: nacos-cm key: mysql.user - name: MYSQL_SERVICE_PASSWORD valueFrom: configMapKeyRef: name: nacos-cm key: mysql.password - name: NACOS_SERVER_PORT value: \u0026#34;8848\u0026#34; - name: NACOS_APPLICATION_PORT value: \u0026#34;8848\u0026#34; - name: PREFER_HOST_MODE value: \u0026#34;hostname\u0026#34; volumeMounts: - name: nacos-plugindir mountPath: /home/nacos/plugins/peer-finder - name: nacos-datadir mountPath: /home/nacos/data - name: nacos-logdir mountPath: /home/nacos/logs volumeClaimTemplates: - metadata: name: nacos-plugindir annotations: volume.beta.kubernetes.io/storage-class: \u0026#34;managed-nfs-storage\u0026#34; spec: accessModes: [ \u0026#34;ReadWriteMany\u0026#34; ] resources: requests: storage: 5Gi - metadata: name: nacos-datadir annotations: volume.beta.kubernetes.io/storage-class: \u0026#34;managed-nfs-storage\u0026#34; spec: accessModes: [ \u0026#34;ReadWriteMany\u0026#34; ] resources: requests: storage: 5Gi - metadata: name: nacos-logdir annotations: volume.beta.kubernetes.io/storage-class: \u0026#34;managed-nfs-storage\u0026#34; spec: accessModes: [ \u0026#34;ReadWriteMany\u0026#34; ] resources: requests: storage: 5Gi selector: matchLabels: app: nacos ä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„storageclassä¸ºmanaged-nfs-storageï¼Œè¿™ä¸ªåä¸ºmanaged-nfs-storageæ˜¯ä¸å­˜åœ¨çš„ï¼Œæˆ‘åˆ›å»ºçš„storageclassçš„åç§°æ˜¯nfs-storageã€‚\nå› æ­¤ï¼Œå½“ä½¿ç”¨kubectl create -f nacos-k8s/deploy/nacos/nacos-pvc-nfs.yamlåˆ›å»ºçš„æ—¶å€™ï¼Œpvcå°†å¤„äºpendingçŠ¶æ€ã€‚\n[root@k8s-master nacos-k8s]# kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE nacos-datadir-nacos-0 Pending managed-nfs-storage 149m nacos-logdir-nacos-0 Pending managed-nfs-storage 149m nacos-plugindir-nacos-0 Pending managed-nfs-storage 149m è¿™æ—¶æ­£å¸¸äººéƒ½ä¼šæƒ³åˆ°kubectl delete -f nacos-k8s/deploy/nacos/nacos-pvc-nfs.yamlåˆ é™¤èµ„æºï¼Œä¿®æ”¹storageclassæˆæ­£ç¡®çš„ä¹‹åå†é‡æ–°createã€‚ä½†æ˜¯è¿™æ ·åšçš„ç»“æœå°±æ˜¯nacosæ— æ³•å¯åŠ¨ï¼Œä¹Ÿä¸€ç›´pendingï¼Œé€šè¿‡kubectl describe pod nacos-oå¯ä»¥çœ‹åˆ°æœ‰running \u0026quot;VolumeBinding\u0026quot; filter plugin for pod \u0026quot;nacos-0\u0026quot;: pod has unbound immediate PersistentVolumeClaimsçš„é”™è¯¯æç¤ºï¼ŒæŸ¥çœ‹podçŠ¶æ€å¦‚ä¸‹ï¼š\n[root@k8s-master nacos-k8s]# kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES mysql-59szx 1/1 Running 0 40m 10.109.131.62 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; nacos-0 0/1 Pending 0 6m10s \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; nfs-client-provisioner-6965c6967-z597p 1/1 Running 0 13m 10.111.218.68 k8s-node3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; é—®é¢˜çš„å…³é”®åœ¨äºåä¸ºnacos-datadir-nacos-0 nacos-logdir-nacos-0 nacos-plugindir-nacos-0 çš„pvcå¹¶æ²¡æœ‰è¢«åˆ é™¤ï¼Œä¸€ç›´pendingï¼Œæ‰€ä»¥podä¹Ÿè·Ÿç€pendingï¼Œè§£å†³åŠæ³•å³æ‰‹åŠ¨åˆ é™¤è¿™äº›pendingçš„pvcã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/pvc%E4%B8%8D%E4%BC%9A%E4%B8%BB%E5%8A%A8%E5%9B%9E%E6%94%B6%E9%97%AE%E9%A2%98/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"pvcä¸ä¼šä¸»åŠ¨å›æ”¶é—®é¢˜"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å†™åœ¨å‰é¢ åœ¨äº†è§£åˆ†å¸ƒå¼é”å…·ä½“å®ç°æ–¹æ¡ˆä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆæ€è€ƒä¸€ä¸‹ä½¿ç”¨åˆ†å¸ƒå¼é”å¿…é¡»è¦è€ƒè™‘çš„ä¸€äº›é—®é¢˜ã€‚\n äº’æ–¥æ€§ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹æŒæœ‰é”ã€‚ é˜²æ­»é”ï¼šå³ä½¿æœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨æŒæœ‰é”çš„æœŸé—´å´©æºƒè€Œæœªèƒ½ä¸»åŠ¨é‡Šæ”¾é”ï¼Œè¦æœ‰å…¶ä»–æ–¹å¼å»é‡Šæ”¾é”ä»è€Œä¿è¯å…¶ä»–è¿›ç¨‹èƒ½è·å–åˆ°é”ã€‚ åŠ é”å’Œè§£é”çš„å¿…é¡»æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ã€‚ é”çš„ç»­æœŸé—®é¢˜ã€‚  å¸¸è§çš„åˆ†å¸ƒå¼é”å®ç°æ–¹æ¡ˆ  åŸºäº Redis å®ç°åˆ†å¸ƒå¼é” åŸºäº Zookeeper å®ç°åˆ†å¸ƒå¼é”  æœ¬æ–‡é‡‡ç”¨ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯åŸºäº Redis çš„åˆ†å¸ƒå¼é”å®ç°æ–¹æ¡ˆã€‚\nRedis å®ç°åˆ†å¸ƒå¼é”ä¸»è¦æ­¥éª¤  æŒ‡å®šä¸€ä¸ª key ä½œä¸ºé”æ ‡è®°ï¼Œå­˜å…¥ Redis ä¸­ï¼ŒæŒ‡å®šä¸€ä¸ª å”¯ä¸€çš„ç”¨æˆ·æ ‡è¯† ä½œä¸º valueã€‚ å½“ key ä¸å­˜åœ¨æ—¶æ‰èƒ½è®¾ç½®å€¼ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è·å¾—é”ï¼Œæ»¡è¶³ äº’æ–¥æ€§ ç‰¹æ€§ã€‚ è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢å› ç³»ç»Ÿå¼‚å¸¸å¯¼è‡´æ²¡èƒ½åˆ é™¤è¿™ä¸ª keyï¼Œæ»¡è¶³ é˜²æ­»é” ç‰¹æ€§ã€‚ å½“å¤„ç†å®Œä¸šåŠ¡ä¹‹åéœ€è¦æ¸…é™¤è¿™ä¸ª key æ¥é‡Šæ”¾é”ï¼Œæ¸…é™¤ key æ—¶éœ€è¦æ ¡éªŒ value å€¼ï¼Œéœ€è¦æ»¡è¶³ åªæœ‰åŠ é”çš„äººæ‰èƒ½é‡Šæ”¾é” ã€‚   ç‰¹åˆ«æ³¨æ„ï¼šä»¥ä¸Šå®ç°æ­¥éª¤è€ƒè™‘åˆ°äº†ä½¿ç”¨åˆ†å¸ƒå¼é”éœ€è¦è€ƒè™‘çš„äº’æ–¥æ€§ã€é˜²æ­»é”ã€åŠ é”å’Œè§£é”å¿…é¡»ä¸ºåŒä¸€ä¸ªè¿›ç¨‹ç­‰é—®é¢˜ï¼Œä½†æ˜¯é”çš„ç»­æœŸæ— æ³•å®ç°ã€‚æ‰€ä»¥ï¼Œåšä¸»é‡‡ç”¨ Redisson å®ç° Redis çš„åˆ†å¸ƒå¼é”ï¼Œå€ŸåŠ© Redisson çš„ WatchDog æœºåˆ¶ èƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³é”ç»­æœŸçš„é—®é¢˜ï¼ŒåŒæ · Redisson ä¹Ÿæ˜¯ Redis å®˜æ–¹æ¨èåˆ†å¸ƒå¼é”å®ç°æ–¹æ¡ˆï¼Œå®ç°èµ·æ¥è¾ƒä¸ºç®€å•ã€‚\n Redisson å®ç°åˆ†å¸ƒå¼é”  å…·ä½“å®ç°ä»£ç å·²ç»ä¸Šä¼ åˆ°åšä¸»çš„ä»“åº“ï¼Œéœ€è¦çš„æœ‹å‹å¯ä»¥åœ¨å…¬ä¼—å·å†…å›å¤ ã€åˆ†å¸ƒå¼é”ä»£ç ã€‘ è·å–ç äº‘æˆ– GitHub é¡¹ç›®ä¸‹è½½åœ°å€ã€‚\n ä¸‹é¢ä»åŠ é”æœºåˆ¶ã€é”äº’æ–¥æœºåˆ¶ã€Watch dog æœºåˆ¶ã€å¯é‡å…¥åŠ é”æœºåˆ¶ã€é”é‡Šæ”¾æœºåˆ¶ã€ç­‰äº”ä¸ªæ–¹é¢å¯¹ Redisson å®ç°åˆ†å¸ƒå¼é”çš„åº•å±‚åŸç†è¿›è¡Œåˆ†æã€‚\nåŠ é”åŸç† åŠ é”å…¶å®æ˜¯é€šè¿‡ä¸€æ®µ lua è„šæœ¬å®ç°çš„ï¼Œå¦‚ä¸‹ï¼š\næˆ‘ä»¬æŠŠè¿™ä¸€æ®µ lua è„šæœ¬æŠ½å‡ºæ¥çœ‹ï¼š\nif (redis.call(\u0026#39;exists\u0026#39;, KEYS[1]) == 0) then \u0026#34; + \u0026#34;redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[2], 1); \u0026#34; + \u0026#34;redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); \u0026#34; + \u0026#34;return nil; \u0026#34; + \u0026#34;end; \u0026#34; + \u0026#34;if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[2]) == 1) then \u0026#34; + \u0026#34;redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[2], 1); \u0026#34; + \u0026#34;redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); \u0026#34; + \u0026#34;return nil; \u0026#34; + \u0026#34;end; \u0026#34; + \u0026#34;return redis.call(\u0026#39;pttl\u0026#39;, KEYS[1]);\u0026#34; è¿™é‡Œ KEYS[1] ä»£è¡¨çš„æ˜¯ä½ åŠ é”çš„ keyï¼Œæ¯”å¦‚ä½ è‡ªå·±è®¾ç½®äº†åŠ é”çš„é‚£ä¸ªé” key å°±æ˜¯ â€œmyLockâ€ã€‚\n// create a lock RLock lock = redisson.getLock(\u0026#34;myLock\u0026#34;); è¿™é‡Œ ARGV[1] ä»£è¡¨çš„æ˜¯é” key çš„é»˜è®¤ç”Ÿå­˜æ—¶é—´ï¼Œé»˜è®¤ 30 ç§’ã€‚ARGV[2] ä»£è¡¨çš„æ˜¯åŠ é”çš„å®¢æˆ·ç«¯çš„ IDï¼Œç±»ä¼¼äºä¸‹é¢è¿™æ ·ï¼š285475da-9152-4c83-822a-67ee2f116a79:52ã€‚è‡³äºæœ€åé¢çš„ä¸€ä¸ª 1 æ˜¯ä¸ºäº†åé¢å¯é‡å…¥åšçš„è®¡æ•°ç»Ÿè®¡ï¼Œåé¢ä¼šæœ‰è®²è§£åˆ°ã€‚\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨ Redis ä¸­çš„å­˜å‚¨ç»“æ„ï¼š\n127.0.0.1:6379\u0026gt; HGETALL myLock 1) \u0026#34;285475da-9152-4c83-822a-67ee2f116a79:52\u0026#34; 2) \u0026#34;1\u0026#34; ä¸Šé¢è¿™ä¸€æ®µåŠ é”çš„ lua è„šæœ¬çš„ä½œç”¨æ˜¯ï¼šç¬¬ä¸€æ®µ if åˆ¤æ–­è¯­å¥ï¼Œå°±æ˜¯ç”¨ exists myLock å‘½ä»¤åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœä½ è¦åŠ é”çš„é‚£ä¸ªé” key ä¸å­˜åœ¨çš„è¯ï¼Œä½ å°±è¿›è¡ŒåŠ é”ã€‚å¦‚ä½•åŠ é”å‘¢ï¼Ÿä½¿ç”¨ hincrby å‘½ä»¤è®¾ç½®ä¸€ä¸ª hash ç»“æ„ï¼Œç±»ä¼¼äºåœ¨ Redis ä¸­ä½¿ç”¨ä¸‹é¢çš„æ“ä½œï¼š\n127.0.0.1:6379\u0026gt; HINCRBY myLock 285475da-9152-4c83-822a-67ee2f116a79:52 1 (integer) 1 æ¥ç€ä¼šæ‰§è¡Œ pexpire myLock 30000 å‘½ä»¤ï¼Œè®¾ç½® myLock è¿™ä¸ªé” key çš„ç”Ÿå­˜æ—¶é—´æ˜¯ 30 ç§’ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼ŒåŠ é”å®Œæˆã€‚\næœ‰çš„å°ä¼™ä¼´å¯èƒ½æ­¤æ—¶å°±æœ‰ç–‘é—®äº†ï¼Œå¦‚æœæ­¤æ—¶æœ‰ç¬¬äºŒä¸ªå®¢æˆ·ç«¯è¯·æ±‚åŠ é”å‘¢ï¼Ÿ è¿™å°±æ˜¯ä¸‹é¢è¦è¯´çš„é”äº’æ–¥æœºåˆ¶ã€‚\né”äº’æ–¥æœºåˆ¶ æ­¤æ—¶ï¼Œå¦‚æœå®¢æˆ·ç«¯ 2 æ¥å°è¯•åŠ é”ï¼Œä¼šå¦‚ä½•å‘¢ï¼Ÿé¦–å…ˆï¼Œç¬¬ä¸€ä¸ª if åˆ¤æ–­ä¼šæ‰§è¡Œ exists myLockï¼Œå‘ç° myLock è¿™ä¸ªé” key å·²ç»å­˜åœ¨äº†ã€‚æ¥ç€ç¬¬äºŒä¸ª if åˆ¤æ–­ï¼Œåˆ¤æ–­ä¸€ä¸‹ï¼ŒmyLock é” key çš„ hash æ•°æ®ç»“æ„ä¸­ï¼Œæ˜¯å¦åŒ…å«å®¢æˆ·ç«¯ 2 çš„ IDï¼Œè¿™é‡Œæ˜æ˜¾ä¸æ˜¯ï¼Œå› ä¸ºé‚£é‡ŒåŒ…å«çš„æ˜¯å®¢æˆ·ç«¯ 1 çš„ IDã€‚æ‰€ä»¥ï¼Œå®¢æˆ·ç«¯ 2 ä¼šæ‰§è¡Œï¼š\nreturn redis.call(\u0026#39;pttl\u0026#39;, KEYS[1]); è¿”å›çš„ä¸€ä¸ªæ•°å­—ï¼Œè¿™ä¸ªæ•°å­—ä»£è¡¨äº† myLock è¿™ä¸ªé” key çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ Redissson tryLock çš„ä¸»æµç¨‹ï¼š\n@Override public boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) throws InterruptedException { long time = unit.toMillis(waitTime); long current = System.currentTimeMillis(); long threadId = Thread.currentThread().getId(); // 1.å°è¯•è·å–é”  Long ttl = tryAcquire(leaseTime, unit, threadId); // lock acquired  if (ttl == null) { return true; } // ç”³è¯·é”çš„è€—æ—¶å¦‚æœå¤§äºç­‰äºæœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œåˆ™ç”³è¯·é”å¤±è´¥.  time -= System.currentTimeMillis() - current; if (time \u0026lt;= 0) { acquireFailed(threadId); return false; } current = System.currentTimeMillis(); /** * 2.è®¢é˜…é”é‡Šæ”¾äº‹ä»¶ï¼š * åŸºäºä¿¡æ¯é‡ï¼Œå½“é”è¢«å…¶å®ƒèµ„æºå ç”¨æ—¶ï¼Œå½“å‰çº¿ç¨‹é€šè¿‡ Redis çš„ channel è®¢é˜…é”çš„é‡Šæ”¾äº‹ä»¶ï¼Œä¸€æ—¦é”é‡Šæ”¾ä¼šå‘æ¶ˆæ¯é€šçŸ¥å¾…ç­‰å¾…çš„çº¿ç¨‹è¿›è¡Œç«äº‰. */ // è®¢é˜…ç›‘å¬redisæ¶ˆæ¯ï¼Œå¹¶ä¸”åˆ›å»ºRedissonLockEntryï¼Œå…¶ä¸­RedissonLockEntryä¸­æ¯”è¾ƒå…³é”®çš„æ˜¯ä¸€ä¸ª Semaphoreå±æ€§å¯¹è±¡,ç”¨æ¥æ§åˆ¶æœ¬åœ°çš„é”è¯·æ±‚çš„ä¿¡å·é‡åŒæ­¥ï¼Œè¿”å›çš„æ˜¯nettyæ¡†æ¶çš„Futureå®ç°ã€‚  RFuture\u0026lt;RedissonLockEntry\u0026gt; subscribeFuture = subscribe(threadId); // é˜»å¡ç­‰å¾…subscribeçš„futureçš„ç»“æœå¯¹è±¡ï¼Œå¦‚æœsubscribeæ–¹æ³•è°ƒç”¨è¶…è¿‡äº†timeï¼Œè¯´æ˜å·²ç»è¶…è¿‡äº†å®¢æˆ·ç«¯è®¾ç½®çš„æœ€å¤§wait timeï¼Œåˆ™ç›´æ¥è¿”å›falseï¼Œå–æ¶ˆè®¢é˜…ï¼Œä¸å†ç»§ç»­ç”³è¯·é”äº†ã€‚  // åªæœ‰awaitè¿”å›trueï¼Œæ‰è¿›å…¥å¾ªç¯å°è¯•è·å–é”  if (!subscribeFuture.await(time, TimeUnit.MILLISECONDS)) { if (!subscribeFuture.cancel(false)) { subscribeFuture.onComplete((res, e) -\u0026gt; { if (e == null) { unsubscribe(subscribeFuture, threadId); } }); } acquireFailed(threadId); return false; } try { // è®¡ç®—è·å–é”çš„æ€»è€—æ—¶ï¼Œå¦‚æœå¤§äºç­‰äºæœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œåˆ™è·å–é”å¤±è´¥.  time -= System.currentTimeMillis() - current; if (time \u0026lt;= 0) { acquireFailed(threadId); return false; } /** * 3.æ”¶åˆ°é”é‡Šæ”¾çš„ä¿¡å·åï¼Œåœ¨æœ€å¤§ç­‰å¾…æ—¶é—´ä¹‹å†…ï¼Œå¾ªç¯ä¸€æ¬¡æ¥ç€ä¸€æ¬¡çš„å°è¯•è·å–é” * è·å–é”æˆåŠŸï¼Œåˆ™ç«‹é©¬è¿”å› trueï¼Œ * è‹¥åœ¨æœ€å¤§ç­‰å¾…æ—¶é—´ä¹‹å†…è¿˜æ²¡è·å–åˆ°é”ï¼Œåˆ™è®¤ä¸ºè·å–é”å¤±è´¥ï¼Œè¿”å› false ç»“æŸå¾ªç¯ */ while (true) { long currentTime = System.currentTimeMillis(); // å†æ¬¡å°è¯•è·å–é”  ttl = tryAcquire(leaseTime, unit, threadId); // lock acquired  if (ttl == null) { return true; } // è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´åˆ™è¿”å› false ç»“æŸå¾ªç¯ï¼Œè·å–é”å¤±è´¥  time -= System.currentTimeMillis() - currentTime; if (time \u0026lt;= 0) { acquireFailed(threadId); return false; } /** * 6.é˜»å¡ç­‰å¾…é”ï¼ˆé€šè¿‡ä¿¡å·é‡(å…±äº«é”)é˜»å¡,ç­‰å¾…è§£é”æ¶ˆæ¯ï¼‰ï¼š */ currentTime = System.currentTimeMillis(); if (ttl \u0026gt;= 0 \u0026amp;\u0026amp; ttl \u0026lt; time) { //å¦‚æœå‰©ä½™æ—¶é—´(ttl)å°äºwait time ,å°±åœ¨ ttl æ—¶é—´å†…ï¼Œä»Entryçš„ä¿¡å·é‡è·å–ä¸€ä¸ªè®¸å¯(é™¤éè¢«ä¸­æ–­æˆ–è€…ä¸€ç›´æ²¡æœ‰å¯ç”¨çš„è®¸å¯)ã€‚  getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS); } else { //åˆ™å°±åœ¨wait time æ—¶é—´èŒƒå›´å†…ç­‰å¾…å¯ä»¥é€šè¿‡ä¿¡å·é‡  getEntry(threadId).getLatch().tryAcquire(time, TimeUnit.MILLISECONDS); } // æ›´æ–°å‰©ä½™çš„ç­‰å¾…æ—¶é—´(æœ€å¤§ç­‰å¾…æ—¶é—´-å·²ç»æ¶ˆè€—çš„é˜»å¡æ—¶é—´)  time -= System.currentTimeMillis() - currentTime; if (time \u0026lt;= 0) { acquireFailed(threadId); return false; } } } finally { // 7.æ— è®ºæ˜¯å¦è·å¾—é”,éƒ½è¦å–æ¶ˆè®¢é˜…è§£é”æ¶ˆæ¯  unsubscribe(subscribeFuture, threadId); } // return get(tryLockAsync(waitTime, leaseTime, unit));  } æµç¨‹åˆ†æï¼š\n å°è¯•è·å–é”ï¼Œè¿”å› null åˆ™è¯´æ˜åŠ é”æˆåŠŸï¼Œè¿”å›ä¸€ä¸ªæ•°å€¼ï¼Œåˆ™è¯´æ˜å·²ç»å­˜åœ¨è¯¥é”ï¼Œttl ä¸ºé”çš„å‰©ä½™å­˜æ´»æ—¶é—´ã€‚ å¦‚æœæ­¤æ—¶å®¢æˆ·ç«¯ 2 è¿›ç¨‹è·å–é”å¤±è´¥ï¼Œé‚£ä¹ˆä½¿ç”¨å®¢æˆ·ç«¯ 2 çš„çº¿ç¨‹ idï¼ˆå…¶å®æœ¬è´¨ä¸Šå°±æ˜¯è¿›ç¨‹ idï¼‰é€šè¿‡ Redis çš„ channel è®¢é˜…é”é‡Šæ”¾çš„äº‹ä»¶ï¼Œã€‚å¦‚æœç­‰å¾…çš„è¿‡ç¨‹ä¸­ä¸€ç›´æœªç­‰åˆ°é”çš„é‡Šæ”¾äº‹ä»¶é€šçŸ¥ï¼Œå½“è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´åˆ™è·å–é”å¤±è´¥ï¼Œè¿”å› falseï¼Œä¹Ÿå°±æ˜¯ç¬¬ 39 è¡Œä»£ç ã€‚å¦‚æœç­‰åˆ°äº†é”çš„é‡Šæ”¾äº‹ä»¶çš„é€šçŸ¥ï¼Œåˆ™å¼€å§‹è¿›å…¥ä¸€ä¸ªä¸æ–­é‡è¯•è·å–é”çš„å¾ªç¯ã€‚ å¾ªç¯ä¸­æ¯æ¬¡éƒ½å…ˆè¯•ç€è·å–é”ï¼Œå¹¶å¾—åˆ°å·²å­˜åœ¨çš„é”çš„å‰©ä½™å­˜æ´»æ—¶é—´ã€‚å¦‚æœåœ¨é‡è¯•ä¸­æ‹¿åˆ°äº†é”ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚å¦‚æœé”å½“å‰è¿˜æ˜¯è¢«å ç”¨çš„ï¼Œé‚£ä¹ˆç­‰å¾…é‡Šæ”¾é”çš„æ¶ˆæ¯ï¼Œå…·ä½“å®ç°ä½¿ç”¨äº† JDK çš„ä¿¡å·é‡ Semaphore æ¥é˜»å¡çº¿ç¨‹ï¼Œå½“é”é‡Šæ”¾å¹¶å‘å¸ƒé‡Šæ”¾é”çš„æ¶ˆæ¯åï¼Œä¿¡å·é‡çš„ release() æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œæ­¤æ—¶è¢«ä¿¡å·é‡é˜»å¡çš„ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥ç»§ç»­å°è¯•è·å–é”äº†ã€‚   ç‰¹åˆ«æ³¨æ„ï¼šä»¥ä¸Šè¿‡ç¨‹å­˜åœ¨ä¸€ä¸ªç»†èŠ‚ï¼Œè¿™é‡Œæœ‰å¿…è¦è¯´æ˜ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯åˆ†å¸ƒå¼é”çš„ä¸€ä¸ªå…³é”®ç‚¹ï¼šå½“é”æ­£åœ¨è¢«å ç”¨æ—¶ï¼Œç­‰å¾…è·å–é”çš„è¿›ç¨‹å¹¶ä¸æ˜¯é€šè¿‡ä¸€ä¸ª while(true) æ­»å¾ªç¯å»è·å–é”ï¼Œè€Œæ˜¯åˆ©ç”¨äº† Redis çš„å‘å¸ƒè®¢é˜…æœºåˆ¶,é€šè¿‡ Semaphoreçš„tryAcquireæ–¹æ³•é˜»å¡ç­‰å¾…é”çš„è¿›ç¨‹ï¼Œæœ‰æ•ˆçš„è§£å†³äº†æ— æ•ˆçš„é”ç”³è¯·æµªè´¹èµ„æºçš„é—®é¢˜ã€‚\n é”çš„ç»­æœŸæœºåˆ¶ å®¢æˆ·ç«¯ 1 åŠ é”çš„é” key é»˜è®¤ç”Ÿå­˜æ—¶é—´æ‰ 30 ç§’ï¼Œå¦‚æœè¶…è¿‡äº† 30 ç§’ï¼Œå®¢æˆ·ç«¯ 1 è¿˜æƒ³ä¸€ç›´æŒæœ‰è¿™æŠŠé”ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ\nRedisson æä¾›äº†ä¸€ä¸ªç»­æœŸæœºåˆ¶ï¼Œ åªè¦å®¢æˆ·ç«¯ 1 ä¸€æ—¦åŠ é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ª Watch Dogã€‚\nprivate \u0026lt;T\u0026gt; RFuture\u0026lt;Long\u0026gt; tryAcquireAsync(long leaseTime, TimeUnit unit, long threadId) { if (leaseTime != -1) { return tryLockInnerAsync(leaseTime, unit, threadId, RedisCommands.EVAL_LONG); } RFuture\u0026lt;Long\u0026gt; ttlRemainingFuture = tryLockInnerAsync(commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout(), TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG); ttlRemainingFuture.onComplete((ttlRemaining, e) -\u0026gt; { if (e != null) { return; } // lock acquired  if (ttlRemaining == null) { scheduleExpirationRenewal(threadId); } }); return ttlRemainingFuture; }  æ³¨æ„ï¼šä»ä»¥ä¸Šæºç æˆ‘ä»¬çœ‹åˆ° leaseTime å¿…é¡»æ˜¯ -1 æ‰ä¼šå¼€å¯ Watch Dog æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å¦‚æœä½ æƒ³å¼€å¯ Watch Dog æœºåˆ¶å¿…é¡»ä½¿ç”¨é»˜è®¤çš„åŠ é”æ—¶é—´ä¸º 30sã€‚å¦‚æœä½ è‡ªå·±è‡ªå®šä¹‰æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œé”å°±ä¼šè‡ªå®šé‡Šæ”¾ï¼Œå¹¶ä¸ä¼šå»¶é•¿ã€‚\n private void scheduleExpirationRenewal(long threadId) { ExpirationEntry entry = new ExpirationEntry(); ExpirationEntry oldEntry = EXPIRATION_RENEWAL_MAP.putIfAbsent(getEntryName(), entry); if (oldEntry != null) { oldEntry.addThreadId(threadId); } else { entry.addThreadId(threadId); renewExpiration(); } } protected RFuture\u0026lt;Boolean\u0026gt; renewExpirationAsync(long threadId) { return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN, \u0026#34;if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[2]) == 1) then \u0026#34; + \u0026#34;redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); \u0026#34; + \u0026#34;return 1; \u0026#34; + \u0026#34;end; \u0026#34; + \u0026#34;return 0;\u0026#34;, Collections.\u0026lt;Object\u0026gt;singletonList(getName()), internalLockLeaseTime, getLockName(threadId)); } Watch Dog æœºåˆ¶å…¶å®å°±æ˜¯ä¸€ä¸ªåå°å®šæ—¶ä»»åŠ¡çº¿ç¨‹ï¼Œè·å–é”æˆåŠŸä¹‹åï¼Œä¼šå°†æŒæœ‰é”çš„çº¿ç¨‹æ”¾å…¥åˆ°ä¸€ä¸ª RedissonLock.EXPIRATION_RENEWAL_MAPé‡Œé¢ï¼Œç„¶åæ¯éš” 10 ç§’ ï¼ˆinternalLockLeaseTime / 3ï¼‰ æ£€æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœå®¢æˆ·ç«¯ 1 è¿˜æŒæœ‰é” keyï¼ˆåˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦è¿˜æŒæœ‰ keyï¼Œå…¶å®å°±æ˜¯éå† EXPIRATION_RENEWAL_MAP é‡Œé¢çº¿ç¨‹ id ç„¶åæ ¹æ®çº¿ç¨‹ id å» Redis ä¸­æŸ¥ï¼Œå¦‚æœå­˜åœ¨å°±ä¼šå»¶é•¿ key çš„æ—¶é—´ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–­çš„å»¶é•¿é” key çš„ç”Ÿå­˜æ—¶é—´ã€‚\n æ³¨æ„ï¼šè¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚é—®é¢˜ï¼Œå¦‚æœæœåŠ¡å®•æœºäº†ï¼ŒWatch Dog æœºåˆ¶çº¿ç¨‹ä¹Ÿå°±æ²¡æœ‰äº†ï¼Œæ­¤æ—¶å°±ä¸ä¼šå»¶é•¿ key çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ°äº† 30s ä¹‹åå°±ä¼šè‡ªåŠ¨è¿‡æœŸäº†ï¼Œå…¶ä»–çº¿ç¨‹å°±å¯ä»¥è·å–åˆ°é”ã€‚\n å¯é‡å…¥åŠ é”æœºåˆ¶ Redisson ä¹Ÿæ˜¯æ”¯æŒå¯é‡å…¥é”çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ç§ä»£ç ï¼š\n@Override public void lock() { RLock lock = redissonSingle.getLock(\u0026#34;myLock\u0026#34;); try { lock.lock(); // æ‰§è¡Œä¸šåŠ¡  doBusiness(); lock.lock(); } catch (Exception e) { e.printStackTrace(); } finally { // é‡Šæ”¾é”  lock.unlock(); lock.unlock(); logger.info(\u0026#34;ä»»åŠ¡æ‰§è¡Œå®Œæ¯•, é‡Šæ”¾é”!\u0026#34;); } } æˆ‘ä»¬å†åˆ†æä¸€ä¸‹åŠ é”é‚£æ®µ lua ä»£ç ï¼š\nif (redis.call(\u0026#39;exists\u0026#39;, KEYS[1]) == 0) then \u0026#34; + \u0026#34;redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[2], 1); \u0026#34; + \u0026#34;redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); \u0026#34; + \u0026#34;return nil; \u0026#34; + \u0026#34;end; \u0026#34; + \u0026#34;if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[2]) == 1) then \u0026#34; + \u0026#34;redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[2], 1); \u0026#34; + \u0026#34;redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); \u0026#34; + \u0026#34;return nil; \u0026#34; + \u0026#34;end; \u0026#34; + \u0026#34;return redis.call(\u0026#39;pttl\u0026#39;, KEYS[1]);\u0026#34; ç¬¬ä¸€ä¸ª if åˆ¤æ–­è‚¯å®šä¸æˆç«‹ï¼Œexists myLock ä¼šæ˜¾ç¤ºé” key å·²ç»å­˜åœ¨ã€‚ç¬¬äºŒä¸ª if åˆ¤æ–­ä¼šæˆç«‹ï¼Œå› ä¸º myLock çš„ hash æ•°æ®ç»“æ„ä¸­åŒ…å«çš„é‚£ä¸ª ID å³å®¢æˆ·ç«¯ 1 çš„ IDï¼Œæ­¤æ—¶å°±ä¼šæ‰§è¡Œå¯é‡å…¥åŠ é”çš„é€»è¾‘ï¼Œä½¿ç”¨ï¼šhincrby myLock 285475da-9152-4c83-822a-67ee2f116a79:52 1 å¯¹å®¢æˆ·ç«¯ 1 çš„åŠ é”æ¬¡æ•°åŠ  1ã€‚æ­¤æ—¶ myLock æ•°æ®ç»“æ„å˜ä¸ºä¸‹é¢è¿™æ ·ï¼š\n127.0.0.1:6379\u0026gt; HGETALL myLock 1) \u0026#34;285475da-9152-4c83-822a-67ee2f116a79:52\u0026#34; 2) \u0026#34;2\u0026#34; åˆ°è¿™é‡Œï¼Œå°ä¼™ä¼´æœ¬å°±éƒ½æ˜ç™½äº† hash ç»“æ„çš„ key æ˜¯é”çš„åç§°ï¼Œfield æ˜¯å®¢æˆ·ç«¯ IDï¼Œvalue æ˜¯è¯¥å®¢æˆ·ç«¯åŠ é”çš„æ¬¡æ•°ã€‚\nè¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå¦‚æœåŠ é”æ”¯æŒå¯é‡å…¥é”ï¼Œé‚£ä¹ˆè§£é”å‘¢ï¼Ÿ\né‡Šæ”¾é”æœºåˆ¶ æ‰§è¡Œ\nlock.unlock() å°±å¯ä»¥é‡Šæ”¾åˆ†å¸ƒå¼é”ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é‡Šæ”¾é”çš„æµç¨‹ä»£ç ï¼š\n@Override public RFuture\u0026lt;Void\u0026gt; unlockAsync(long threadId) { RPromise\u0026lt;Void\u0026gt; result = new RedissonPromise\u0026lt;Void\u0026gt;(); // 1. å¼‚æ­¥é‡Šæ”¾é”  RFuture\u0026lt;Boolean\u0026gt; future = unlockInnerAsync(threadId); // å–æ¶ˆ Watch Dog æœºåˆ¶  future.onComplete((opStatus, e) -\u0026gt; { cancelExpirationRenewal(threadId); if (e != null) { result.tryFailure(e); return; } if (opStatus == null) { IllegalMonitorStateException cause = new IllegalMonitorStateException(\u0026#34;attempt to unlock lock, not locked by current thread by node id: \u0026#34; + id + \u0026#34; thread-id: \u0026#34; + threadId); result.tryFailure(cause); return; } result.trySuccess(null); }); return result; } protected RFuture\u0026lt;Boolean\u0026gt; unlockInnerAsync(long threadId) { return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN, // åˆ¤æ–­é” key æ˜¯å¦å­˜åœ¨  \u0026#34;if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[3]) == 0) then \u0026#34; + \u0026#34;return nil;\u0026#34; + \u0026#34;end; \u0026#34; + // å°†è¯¥å®¢æˆ·ç«¯å¯¹åº”çš„é”çš„ hash ç»“æ„çš„ value å€¼é€’å‡ä¸º 0 åå†è¿›è¡Œåˆ é™¤  // ç„¶åå†å‘é€šé“åä¸º redisson_lock__channel publish ä¸€æ¡ UNLOCK_MESSAGE ä¿¡æ¯  \u0026#34;local counter = redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[3], -1); \u0026#34; + \u0026#34;if (counter \u0026gt; 0) then \u0026#34; + \u0026#34;redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[2]); \u0026#34; + \u0026#34;return 0; \u0026#34; + \u0026#34;else \u0026#34; + \u0026#34;redis.call(\u0026#39;del\u0026#39;, KEYS[1]); \u0026#34; + \u0026#34;redis.call(\u0026#39;publish\u0026#39;, KEYS[2], ARGV[1]); \u0026#34; + \u0026#34;return 1; \u0026#34;+ \u0026#34;end; \u0026#34; + \u0026#34;return nil;\u0026#34;, Arrays.\u0026lt;Object\u0026gt;asList(getName(), getChannelName()), LockPubSub.UNLOCK_MESSAGE, internalLockLeaseTime, getLockName(threadId)); } ä»ä»¥ä¸Šä»£ç æ¥çœ‹ï¼Œé‡Šæ”¾é”çš„æ­¥éª¤ä¸»è¦åˆ†ä¸‰æ­¥ï¼š\n åˆ é™¤é”ï¼ˆè¿™é‡Œæ³¨æ„å¯é‡å…¥é”ï¼Œåœ¨ä¸Šé¢çš„è„šæœ¬ä¸­æœ‰è¯¦ç»†åˆ†æï¼‰ã€‚ å¹¿æ’­é‡Šæ”¾é”çš„æ¶ˆæ¯ï¼Œé€šçŸ¥é˜»å¡ç­‰å¾…çš„è¿›ç¨‹ï¼ˆå‘é€šé“åä¸º redisson_lock__channel publish ä¸€æ¡ UNLOCK_MESSAGE ä¿¡æ¯ï¼‰ã€‚ å–æ¶ˆ Watch Dog æœºåˆ¶ï¼Œå³å°† RedissonLock.EXPIRATION_RENEWAL_MAP é‡Œé¢çš„çº¿ç¨‹ id åˆ é™¤ï¼Œå¹¶ä¸” cancel æ‰ Netty çš„é‚£ä¸ªå®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€‚  æ–¹æ¡ˆä¼˜ç‚¹  Redisson é€šè¿‡ Watch Dog æœºåˆ¶å¾ˆå¥½çš„è§£å†³äº†é”çš„ç»­æœŸé—®é¢˜ã€‚ å’Œ Zookeeper ç›¸æ¯”è¾ƒï¼ŒRedisson åŸºäº Redis æ€§èƒ½æ›´é«˜ï¼Œé€‚åˆå¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ã€‚ é€šè¿‡ Redisson å®ç°åˆ†å¸ƒå¼å¯é‡å…¥é”ï¼Œæ¯”åŸç”Ÿçš„ SET mylock userId NX PX milliseconds + lua å®ç°çš„æ•ˆæœæ›´å¥½äº›ï¼Œè™½ç„¶åŸºæœ¬åŸç†éƒ½ä¸€æ ·ï¼Œä½†æ˜¯å®ƒå¸®æˆ‘ä»¬å±è”½äº†å†…éƒ¨çš„æ‰§è¡Œç»†èŠ‚ã€‚ åœ¨ç­‰å¾…ç”³è¯·é”èµ„æºçš„è¿›ç¨‹ç­‰å¾…ç”³è¯·é”çš„å®ç°ä¸Šä¹Ÿåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œå‡å°‘äº†æ— æ•ˆçš„é”ç”³è¯·ï¼Œæå‡äº†èµ„æºçš„åˆ©ç”¨ç‡ã€‚  æ–¹æ¡ˆç¼ºç‚¹  ä½¿ç”¨ Redisson å®ç°åˆ†å¸ƒå¼é”æ–¹æ¡ˆæœ€å¤§çš„é—®é¢˜å°±æ˜¯å¦‚æœä½ å¯¹æŸä¸ª Redis Master å®ä¾‹å®Œæˆäº†åŠ é”ï¼Œæ­¤æ—¶ Master ä¼šå¼‚æ­¥å¤åˆ¶ç»™å…¶å¯¹åº”çš„ slave å®ä¾‹ã€‚ä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸€æ—¦ Master å®•æœºï¼Œä¸»å¤‡åˆ‡æ¢ï¼Œslave å˜ä¸ºäº† Masterã€‚æ¥ç€å°±ä¼šå¯¼è‡´ï¼Œå®¢æˆ·ç«¯ 2 æ¥å°è¯•åŠ é”çš„æ—¶å€™ï¼Œåœ¨æ–°çš„ Master ä¸Šå®Œæˆäº†åŠ é”ï¼Œè€Œå®¢æˆ·ç«¯ 1 ä¹Ÿä»¥ä¸ºè‡ªå·±æˆåŠŸåŠ äº†é”ï¼Œæ­¤æ—¶å°±ä¼šå¯¼è‡´å¤šä¸ªå®¢æˆ·ç«¯å¯¹ä¸€ä¸ªåˆ†å¸ƒå¼é”å®Œæˆäº†åŠ é”ï¼Œè¿™æ—¶ç³»ç»Ÿåœ¨ä¸šåŠ¡è¯­ä¹‰ä¸Šä¸€å®šä¼šå‡ºç°é—®é¢˜ï¼Œå¯¼è‡´å„ç§è„æ•°æ®çš„äº§ç”Ÿã€‚æ‰€ä»¥è¿™ä¸ªå°±æ˜¯ Redis Cluster æˆ–è€…è¯´æ˜¯ Redis Master-Slave æ¶æ„çš„ä¸»ä»å¼‚æ­¥å¤åˆ¶å¯¼è‡´çš„ Redis åˆ†å¸ƒå¼é”çš„æœ€å¤§ç¼ºé™·ï¼ˆåœ¨ Redis Master å®ä¾‹å®•æœºçš„æ—¶å€™ï¼Œå¯èƒ½å¯¼è‡´å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶å®ŒæˆåŠ é”ï¼‰ã€‚ æœ‰ä¸ªåˆ«è§‚ç‚¹è¯´ä½¿ç”¨ Watch Dog æœºåˆ¶å¼€å¯ä¸€ä¸ªå®šæ—¶çº¿ç¨‹å»ä¸æ–­å»¶é•¿é”çš„æ—¶é—´å¯¹ç³»ç»Ÿæœ‰æ‰€æŸè€—ï¼ˆè¿™é‡Œåªæ˜¯ç½‘ç»œä¸Šçš„ä¸€ç§è¯´æ³•ï¼Œåšä¸»æŸ¥äº†å¾ˆå¤šèµ„æ–™å¹¶ä¸”ç»“åˆå®é™…ç”Ÿäº§å¹¶ä¸è®¤ä¸ºæœ‰å¾ˆå¤§ç³»ç»ŸæŸè€—ï¼Œè¿™ä¸ªä»…ä¾›å¤§å®¶å‚è€ƒï¼‰ã€‚  æ€»ç»“ ä»¥ä¸Šå°±æ˜¯åŸºäº Redis ä½¿ç”¨ Redisson å®ç°åˆ†å¸ƒå¼é”çš„æ‰€æœ‰åŸç†åˆ†æï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©å°ä¼™ä¼´ä»¬å¯¹åˆ†å¸ƒå¼é”çš„ç†è§£æœ‰æ‰€åŠ æ·±ã€‚å…¶å®åˆ†æå®Œæºç åå‘ç°åŸºäº Redis è‡ªå·±æ‰‹åŠ¨å®ç°ä¸€ä¸ªç®€ç‰ˆçš„åˆ†å¸ƒå¼é”å·¥å…·ä¹Ÿå¹¶ä¸æ˜¯å¾ˆéš¾ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è¯•è¯•ã€‚\nå‚è€ƒ Redisson å®ç°åˆ†å¸ƒå¼é”åŸç†åˆ†æ\rRedissonå®ç°åˆ†å¸ƒå¼é”åŸç†\rå·¥ä½œä¸‰å¹´ï¼Œå°èƒ–å±…ç„¶é—®æˆ‘ Redisson åŸç†ï¼ŸçœŸçš„è¿‡ä»½ï¼\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/redis/redisson%E5%8E%9F%E7%90%86/","series":["Manual"],"tags":["Redis"],"title":"RedissonåŸç†"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"redis åˆ†å¸ƒå¼é”å’Œ zk åˆ†å¸ƒå¼é”çš„å¯¹æ¯”  redis åˆ†å¸ƒå¼é”ï¼Œå…¶å®éœ€è¦è‡ªå·±ä¸æ–­å»å°è¯•è·å–é”ï¼Œæ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ã€‚ zk åˆ†å¸ƒå¼é”ï¼Œè·å–ä¸åˆ°é”ï¼Œæ³¨å†Œä¸ªç›‘å¬å™¨å³å¯ï¼Œä¸éœ€è¦ä¸æ–­ä¸»åŠ¨å°è¯•è·å–é”ï¼Œæ€§èƒ½å¼€é”€è¾ƒå°ã€‚  å¦å¤–ä¸€ç‚¹å°±æ˜¯ï¼Œå¦‚æœæ˜¯ Redis è·å–é”çš„é‚£ä¸ªå®¢æˆ·ç«¯ å‡ºç° bug æŒ‚äº†ï¼Œé‚£ä¹ˆåªèƒ½ç­‰å¾…è¶…æ—¶æ—¶é—´ä¹‹åæ‰èƒ½é‡Šæ”¾é”ï¼›è€Œ zk çš„è¯ï¼Œå› ä¸ºåˆ›å»ºçš„æ˜¯ä¸´æ—¶ znodeï¼Œåªè¦å®¢æˆ·ç«¯æŒ‚äº†ï¼Œznode å°±æ²¡äº†ï¼Œæ­¤æ—¶å°±è‡ªåŠ¨é‡Šæ”¾é”ã€‚\nRedis åˆ†å¸ƒå¼é”å¤§å®¶æ²¡å‘ç°å¥½éº»çƒ¦å—ï¼Ÿéå†ä¸Šé”ï¼Œè®¡ç®—æ—¶é—´ç­‰ç­‰\u0026hellip;\u0026hellip;zk çš„åˆ†å¸ƒå¼é”è¯­ä¹‰æ¸…æ™°å®ç°ç®€å•ã€‚\næ‰€ä»¥å…ˆä¸åˆ†æå¤ªå¤šçš„ä¸œè¥¿ï¼Œå°±è¯´è¿™ä¸¤ç‚¹ï¼Œæˆ‘ä¸ªäººå®è·µè®¤ä¸º zk çš„åˆ†å¸ƒå¼é”æ¯” Redis çš„åˆ†å¸ƒå¼é”ç‰¢é ã€è€Œä¸”æ¨¡å‹ç®€å•æ˜“ç”¨ã€‚\nå‚è€ƒ ä¸€èˆ¬å®ç°åˆ†å¸ƒå¼é”éƒ½æœ‰å“ªäº›æ–¹å¼ï¼Ÿä½¿ç”¨ Redis å¦‚ä½•è®¾è®¡åˆ†å¸ƒå¼é”ï¼Ÿä½¿ç”¨ zk æ¥è®¾è®¡åˆ†å¸ƒå¼é”å¯ä»¥å—ï¼Ÿè¿™ä¸¤ç§åˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼å“ªç§æ•ˆç‡æ¯”è¾ƒé«˜ï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/zookeeper/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8Czk%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AF%B9%E6%AF%94/","series":["Manual"],"tags":["ZK","Redis"],"title":"redisåˆ†å¸ƒå¼é”å’Œzkåˆ†å¸ƒå¼é”çš„å¯¹æ¯”"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. å®‰è£… $ wget http://download.redis.io/releases/redis-5.0.8.tar.gz $ tar xzf redis-5.0.8.tar.gz $ cd redis-5.0.8 $ make 2.é…ç½®  æ³¨é‡Šæ‰bind 127.0.0.1 protected-mode yes requirepass xxxpassword daemonize yes  3. å¯åŠ¨ cd src ./redis-server æˆ–è€…\ncd src ./redis-server ../redis.conf 4. åœæ­¢ cd src ./redis-cli auth xxxpassword shutdown exit 5. å¸è½½ find / -name \u0026#34;redis*\u0026#34; | xargs rm -rf 6.è¿œç¨‹è¿æ¥ windowè¿æ¥è¿œç¨‹redis:\nredis-cli -h 193.112.37.xxx -p 6379 -a xxxpassword ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/redis/redis%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97/","series":["Manual"],"tags":["Redis"],"title":"Redisé…ç½®æŒ‡å—"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å½“æˆ‘ç¬¬ä¸€æ¬¡ç™»å½•æ—¶æˆ‘ä¼šå¾—åˆ°{\u0026quot; timestamp\u0026quot;ï¼š1481719982036ï¼Œ\u0026quot; status\u0026quot;ï¼š999ï¼Œ\u0026quot; error\u0026quot;ï¼š\u0026quot; None\u0026quot;ï¼Œ\u0026quot; message\u0026quot;ï¼š\u0026quot;æ— å¯ç”¨æ¶ˆæ¯\u0026quot;}ï¼Œä½†ç¬¬äºŒæ¬¡è¿˜å¯ä»¥ã€‚\nè§£å†³åŠæ³•ï¼šå¡«å†™å¦‚ä¸‹é…ç½®åˆ°application.properties\nspring.autoconfigure.exclude=org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration\rå‚è€ƒé“¾æ¥ï¼šjava:Spring Securityç¬¬ä¸€æ¬¡ç™»å½•å¤±è´¥ï¼Œç¬¬äºŒæ¬¡ç™»å½•æˆåŠŸ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/exception/spring-security%E7%AC%AC%E4%B8%80%E6%AC%A1%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E7%AC%AC%E4%BA%8C%E6%AC%A1%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F/","series":["Manual"],"tags":["spring"],"title":"Spring Securityç¬¬ä¸€æ¬¡ç™»å½•å¤±è´¥ï¼Œç¬¬äºŒæ¬¡ç™»å½•æˆåŠŸ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‡è®¾ä¸€ä¸ªæ¥å£é‡Œé¢æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š\npackage demo.long; public interface CustomerService { public void doSomething1(); public void doSomething2(); } æ¥å£å®ç°ç±»å¦‚ä¸‹ï¼š\npackage demo.long.impl; import demo.long.CustomerService; public class CustomerServiceImpl implements CustomerService { public void doSomething1() { System.out.println(\u0026#34;CustomerServiceImpl.doSomething1()\u0026#34;); doSomething2(); } public void doSomething2() { System.out.println(\u0026#34;CustomerServiceImpl.doSomething2()\u0026#34;); } } ç°åœ¨æˆ‘éœ€è¦åœ¨CustomerServiceæ¥å£çš„æ¯ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶éƒ½åœ¨æ–¹æ³•å‰æ‰§è¡Œä¸€äº›é€»è¾‘ï¼Œæ‰€ä»¥éœ€è¦é…ç½®ä¸€ä¸ªæ‹¦æˆªå™¨ï¼š\npackage demo.long; import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.Before; @Aspect public class CustomerServiceInterceptor { @Before(\u0026#34;execution(* demo.long..*.*(..))\u0026#34;) public void doBefore() { System.out.println(\u0026#34;do some important things before...\u0026#34;); } } æŠŠBeanåŠ åˆ°Springé…ç½®ä¸­\n\u0026lt;aop:aspectj-autoproxy /\u0026gt; \u0026lt;bean id=\u0026#34;customerService\u0026#34; class=\u0026#34;demo.long.impl.CustomerServiceImpl\u0026#34; /\u0026gt; \u0026lt;bean id=\u0026#34;customerServiceInterceptor\u0026#34; class=\u0026#34;demo.long.CustomerServiceInterceptor\u0026#34; /\u0026gt; å¦‚æœç°åœ¨å¤–éƒ¨å¯¹è±¡è°ƒç”¨CustomerServiceçš„doSomething1()æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå‘ç°åªæœ‰doSomething1()æ–¹æ³•æ‰§è¡Œå‰æ‰“å°äº†â€œdo some important things before\u0026hellip;â€ï¼Œè€ŒdoSomething1()å†…éƒ¨è°ƒç”¨doSomething2()æ—¶å¹¶æ²¡æœ‰æ‰“å°ä¸Šè¿°å†…å®¹ï¼›å¤–éƒ¨å¯¹è±¡å•ç‹¬è°ƒç”¨doSomething2()æ—¶ä¼šæ‰“å°ä¸Šè¿°å†…å®¹ã€‚\npublic class CustomerServiceTest { @Autowired ICustomerService customerService; @Test public void testAOP() { customerService.doSomething1(); } } åŸå› åˆ†æ æ‹¦æˆªå™¨çš„å®ç°åŸç†å°±æ˜¯åŠ¨æ€ä»£ç†ï¼Œå®ç°AOPæœºåˆ¶ã€‚Spring çš„ä»£ç†å®ç°æœ‰ä¸¤ç§ï¼šä¸€æ˜¯åŸºäº JDK Dynamic Proxy æŠ€æœ¯è€Œå®ç°çš„ï¼›äºŒæ˜¯åŸºäº CGLIB æŠ€æœ¯è€Œå®ç°çš„ã€‚å¦‚æœç›®æ ‡å¯¹è±¡å®ç°äº†æ¥å£ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹Springä¼šé‡‡ç”¨JDKçš„åŠ¨æ€ä»£ç†å®ç°AOPï¼ŒCustomerServerImplæ­£æ˜¯è¿™ç§æƒ…å†µã€‚\nJDKåŠ¨æ€ä»£ç†ç”Ÿæˆçš„CustomerServiceImplçš„ä»£ç†ç±»å¤§è‡´å¦‚ä¸‹ï¼š\npublic class CustomerServiceProxy implements CustomerService { private CustomerService customerService; public void setCustomerService(CustomerService customerService) { this.customerService = customerService; } public void doSomething1() { doBefore(); customerService.doSomething1(); } public void doSomething2() { doBefore(); customerService.doSomething2(); } private void doBefore() { // ä¾‹å¦‚ï¼Œå¯ä»¥åœ¨æ­¤å¤„å¼€å¯äº‹åŠ¡æˆ–è®°å½•æ—¥å¿—  System.out.println(\u0026#34;do some important things before...\u0026#34;); } } å®¢æˆ·ç«¯ç¨‹åºä½¿ç”¨ä»£ç†ç±»å¯¹è±¡å»è°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼š\npublic class TestProxy { public static void main(String[] args) { // åˆ›å»ºä»£ç†ç›®æ ‡å¯¹è±¡  // å¯¹äºSpringæ¥è¯´ï¼Œè¿™ä¸€å·¥ä½œæ˜¯ç”±Springå®¹å™¨å®Œæˆçš„ã€‚  CustomerService serviceProxyTarget = new CustomerServiceImpl(); // åˆ›å»ºä»£ç†å¯¹è±¡  // å¯¹äºSpringæ¥è¯´ï¼Œè¿™ä¸€å·¥ä½œä¹Ÿæ˜¯ç”±Springå®¹å™¨å®Œæˆçš„ã€‚  CustomerServiceProxy serviceProxy = new CustomerServiceProxy(); serviceProxy.setCustomerService(serviceProxyTarget); CustomerService serviceBean = (CustomerService) serviceProxy; // è°ƒç”¨ä¸šåŠ¡é€»è¾‘æ“ä½œ  serviceBean.doSomething1(); } } æ‰§è¡Œmainæ–¹æ³•ï¼Œå‘ç°doSomething1()ä¸­è°ƒç”¨doSomething2()æ–¹æ³•çš„æ—¶å€™å¹¶æœªå»æ‰§è¡ŒCustomerServiceProxyç±»çš„doBefore()æ–¹æ³•ã€‚å…¶å®doSomething2()ç­‰åŒäºthis.doSomething2()ï¼Œåœ¨CustomerServiceImplç±»ä¸­thiså…³é”®å­—è¡¨ç¤ºçš„æ˜¯å½“å‰è¿™ä¸ªCustomerServiceImplç±»çš„å®ä¾‹ï¼Œæ‰€ä»¥ç¨‹åºä¼šå»æ‰§è¡ŒCustomerServiceImplå¯¹è±¡ä¸­çš„doSomething2()æ–¹æ³•ï¼Œè€Œä¸ä¼šå»æ‰§è¡ŒCustomerServiceProxyç±»å¯¹è±¡ä¸­çš„ doSomething2()æ–¹æ³•ã€‚\nåœ¨ä½¿ç”¨Spring AOPçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä»IOCå®¹å™¨ä¸­è·å–çš„Beanå¯¹è±¡å…¶å®éƒ½æ˜¯ä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯é‚£äº›Beanå¯¹è±¡æœ¬èº«ï¼Œç”±äºthiså…³é”®å­—å¼•ç”¨çš„å¹¶ä¸æ˜¯è¯¥Service Beanå¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯å…¶æœ¬èº«ï¼Œå› æ­¤Spring AOPæ˜¯ä¸èƒ½æ‹¦æˆªåˆ°è¿™äº›è¢«åµŒå¥—è°ƒç”¨çš„æ–¹æ³•çš„ã€‚\nè§£å†³æ–¹æ¡ˆ  ä¿®æ”¹ç±»ï¼Œä¸è¦å‡ºç°â€œè‡ªè°ƒç”¨â€çš„æƒ…å†µï¼šè¿™æ˜¯Springæ–‡æ¡£ä¸­æ¨èçš„â€œæœ€ä½³â€æ–¹æ¡ˆï¼› è‹¥ä¸€å®šè¦ä½¿ç”¨â€œè‡ªè°ƒç”¨â€ï¼Œé‚£ä¹ˆthis.doSomething2()æ›¿æ¢ä¸ºï¼š((CustomerService) AopContext.currentProxy()).doSomething2()ï¼›æ­¤æ—¶éœ€è¦ä¿®æ”¹springçš„aopé…ç½®ï¼š  xml:\n\u0026lt;aop:aspectj-autoproxy expose-proxy=\u0026#34;true\u0026#34; /\u0026gt; æ³¨è§£ï¼š\n@EnableAspectJAutoProxy(exposeProxy = true) å‚è€ƒé“¾æ¥ï¼š https://www.jianshu.com/p/6534945eb3b5\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/springaop%E6%96%B9%E6%B3%95%E5%86%85%E9%83%A8%E8%B0%83%E7%94%A8%E4%B8%8D%E7%94%9F%E6%95%88/","series":["Manual"],"tags":["Spring"],"title":"SpringAOPæ–¹æ³•å†…éƒ¨è°ƒç”¨ä¸ç”Ÿæ•ˆ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ä½¿ç”¨SpringBoot Admin é…ç½®QQé‚®ç®±å»å‘é€é‚®ä»¶æ—¶æŠ¥é”™ï¼šcom.sun.mail.smtp.SMTPSenderFailedException: 501 mail from address must be same as authorization userï¼Œæˆ‘çš„é…ç½®å¦‚ä¸‹ï¼š\nspring.mail.host: smtp.qq.com\rspring.mail.username: å‘é€è´¦å·\rspring.mail.password: qqæˆæƒç \rspring.boot.admin.notify.mail.to: æ¥æ”¶è´¦å·\råæ¥åœ¨ç½‘ä¸ŠæŸ¥åˆ°æ˜¯å°‘äº†spring.boot.admin.notify.mail.fromçš„é…ç½®ï¼Œè²Œä¼¼åªæœ‰QQé‚®ç®±æ‰éœ€è¦é¢å¤–åŠ ä¸Šè¿™ä¸ªè®¾ç½®ï¼ˆæœ¬äººæ²¡æœ‰æµ‹è¯•è¿‡ç”¨å…¶ä»–é‚®ç®±å‘é€é‚®ä»¶ï¼‰ã€‚æ‰€ä»¥æœ€ç»ˆé…ç½®å¦‚ä¸‹ï¼š\nspring.mail.host: smtp.qq.com\rspring.mail.username: å‘é€è´¦å·\rspring.mail.password: qqæˆæƒç \rspring.boot.admin.notify.mail.to: æ¥æ”¶è´¦å·\rspring.boot.admin.notify.mail.from: å‘é€è´¦å·\rå‚è€ƒï¼š Springboot admin å‘é€é‚®ä»¶å¤±è´¥ï¼šcom.sun.mail.smtp.SMTPSenderFailedException: 553 Mail from must equal authorized user\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/springboot/springboot%E4%BD%BF%E7%94%A8qq%E9%82%AE%E7%AE%B1%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6%E9%85%8D%E7%BD%AE/","series":["Manual"],"tags":["SpringBoot"],"title":"SpringBootä½¿ç”¨QQé‚®ç®±å‘é€é‚®ä»¶é…ç½®"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"SpringMVCæ‰§è¡Œæµç¨‹  ç”¨æˆ·å‘é€è¯·æ±‚è‡³å‰ç«¯æ§åˆ¶å™¨DispatcherServlet DispatcherServletæ”¶åˆ°è¯·æ±‚è°ƒç”¨å¤„ç†å™¨æ˜ å°„å™¨HandlerMappingã€‚ å¤„ç†å™¨æ˜ å°„å™¨æ ¹æ®è¯·æ±‚urlæ‰¾åˆ°å…·ä½“çš„å¤„ç†å™¨ï¼Œç”Ÿæˆå¤„ç†å™¨æ‰§è¡Œé“¾HandlerExecutionChain(åŒ…æ‹¬å¤„ç†å™¨å¯¹è±¡å’Œå¤„ç†å™¨æ‹¦æˆªå™¨)ä¸€å¹¶è¿”å›ç»™DispatcherServletã€‚ DispatcherServletæ ¹æ®å¤„ç†å™¨Handlerè·å–å¤„ç†å™¨é€‚é…å™¨HandlerAdapteræ‰§è¡ŒHandlerAdapterå¤„ç†ä¸€ç³»åˆ—çš„æ“ä½œï¼Œå¦‚ï¼šå‚æ•°å°è£…ï¼Œæ•°æ®æ ¼å¼è½¬æ¢ï¼Œæ•°æ®éªŒè¯ç­‰æ“ä½œ æ‰§è¡Œå¤„ç†å™¨Handler(Controllerï¼Œä¹Ÿå«é¡µé¢æ§åˆ¶å™¨)ã€‚ Handleræ‰§è¡Œå®Œæˆè¿”å›ModelAndView HandlerAdapterå°†Handleræ‰§è¡Œç»“æœModelAndViewè¿”å›åˆ°DispatcherServlet DispatcherServletå°†ModelAndViewä¼ ç»™ViewResloverè§†å›¾è§£æå™¨ ViewResloverè§£æåè¿”å›å…·ä½“View DispatcherServletå¯¹Viewè¿›è¡Œæ¸²æŸ“è§†å›¾ï¼ˆå³å°†æ¨¡å‹æ•°æ®modelå¡«å……è‡³è§†å›¾ä¸­ï¼‰ã€‚ DispatcherServletå“åº”ç”¨æˆ·ã€‚  ç»„ä»¶è¯´æ˜  DispatcherServletï¼šå‰ç«¯æ§åˆ¶å™¨ã€‚ç”¨æˆ·è¯·æ±‚åˆ°è¾¾å‰ç«¯æ§åˆ¶å™¨ï¼Œå®ƒå°±ç›¸å½“äºmvcæ¨¡å¼ä¸­çš„cï¼ŒdispatcherServletæ˜¯æ•´ä¸ªæµç¨‹æ§åˆ¶çš„ä¸­å¿ƒï¼Œç”±å®ƒè°ƒç”¨å…¶å®ƒç»„ä»¶å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼ŒdispatcherServletçš„å­˜åœ¨é™ä½äº†ç»„ä»¶ä¹‹é—´çš„è€¦åˆæ€§,ç³»ç»Ÿæ‰©å±•æ€§æé«˜ã€‚ç”±æ¡†æ¶å®ç° HandlerMappingï¼šå¤„ç†å™¨æ˜ å°„å™¨ã€‚HandlerMappingè´Ÿè´£æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„urlæ‰¾åˆ°Handlerå³å¤„ç†å™¨ï¼Œspringmvcæä¾›äº†ä¸åŒçš„æ˜ å°„å™¨å®ç°ä¸åŒçš„æ˜ å°„æ–¹å¼ï¼Œæ ¹æ®ä¸€å®šçš„è§„åˆ™å»æŸ¥æ‰¾,ä¾‹å¦‚ï¼šxmlé…ç½®æ–¹å¼ï¼Œå®ç°æ¥å£æ–¹å¼ï¼Œæ³¨è§£æ–¹å¼ç­‰ã€‚ç”±æ¡†æ¶å®ç° Handlerï¼šå¤„ç†å™¨ã€‚Handler æ˜¯ç»§DispatcherServletå‰ç«¯æ§åˆ¶å™¨çš„åç«¯æ§åˆ¶å™¨ï¼Œåœ¨DispatcherServletçš„æ§åˆ¶ä¸‹Handlerå¯¹å…·ä½“çš„ç”¨æˆ·è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚ç”±äºHandleræ¶‰åŠåˆ°å…·ä½“çš„ç”¨æˆ·ä¸šåŠ¡è¯·æ±‚ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µéœ€è¦ç¨‹åºå‘˜æ ¹æ®ä¸šåŠ¡éœ€æ±‚å¼€å‘Handlerã€‚ HandlAdapterï¼šå¤„ç†å™¨é€‚é…å™¨ã€‚é€šè¿‡HandlerAdapterå¯¹å¤„ç†å™¨è¿›è¡Œæ‰§è¡Œï¼Œè¿™æ˜¯é€‚é…å™¨æ¨¡å¼çš„åº”ç”¨ï¼Œé€šè¿‡æ‰©å±•é€‚é…å™¨å¯ä»¥å¯¹æ›´å¤šç±»å‹çš„å¤„ç†å™¨è¿›è¡Œæ‰§è¡Œã€‚ç”±æ¡†æ¶å®ç°ã€‚ ModelAndViewæ˜¯springmvcçš„å°è£…å¯¹è±¡ï¼Œå°†modelå’Œviewå°è£…åœ¨ä¸€èµ·ã€‚ ViewResolverï¼šè§†å›¾è§£æå™¨ã€‚ViewResolverè´Ÿè´£å°†å¤„ç†ç»“æœç”ŸæˆViewè§†å›¾ï¼ŒViewResolveré¦–å…ˆæ ¹æ®é€»è¾‘è§†å›¾åè§£ææˆç‰©ç†è§†å›¾åå³å…·ä½“çš„é¡µé¢åœ°å€ï¼Œå†ç”ŸæˆViewè§†å›¾å¯¹è±¡ï¼Œæœ€åå¯¹Viewè¿›è¡Œæ¸²æŸ“å°†å¤„ç†ç»“æœé€šè¿‡é¡µé¢å±•ç¤ºç»™ç”¨æˆ·ã€‚ View: æ˜¯springmvcçš„å°è£…å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªæ¥å£, springmvcæ¡†æ¶æä¾›äº†å¾ˆå¤šçš„Viewè§†å›¾ç±»å‹ï¼ŒåŒ…æ‹¬ï¼šjspviewï¼Œpdfview,jstlViewã€freemarkerViewã€pdfViewç­‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦é€šè¿‡é¡µé¢æ ‡ç­¾æˆ–é¡µé¢æ¨¡ç‰ˆæŠ€æœ¯å°†æ¨¡å‹æ•°æ®é€šè¿‡é¡µé¢å±•ç¤ºç»™ç”¨æˆ·ï¼Œéœ€è¦ç”±ç¨‹åºå‘˜æ ¹æ®ä¸šåŠ¡éœ€æ±‚å¼€å‘å…·ä½“çš„é¡µé¢ã€‚  å‚è€ƒé“¾æ¥ï¼š SpringMVCæ‰§è¡Œæµç¨‹åŠå·¥ä½œåŸç†\rSpring MVCã€å…¥é—¨ã€‘å°±è¿™ä¸€ç¯‡ï¼\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/springmvc/","series":["Manual"],"tags":["Spring"],"title":"SpringMVC"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‚è€ƒé“¾æ¥ï¼š å¯èƒ½æ˜¯æœ€æ¼‚äº®çš„Springäº‹åŠ¡ç®¡ç†è¯¦è§£\rspring äº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶çœ‹è¿™ç¯‡å°±å¤Ÿäº†\rSpring äº‹åŠ¡ç®¡ç†\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/spring%E4%BA%8B%E5%8A%A1/","series":["Manual"],"tags":["Spring"],"title":"Springäº‹åŠ¡"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"SpringBootçš„WEBå¼‚å¸¸æ•è·ï¼Œå¦‚æœæ˜¯WEBé¡¹ç›®çš„è¯ï¼Œå¯ä»¥ç›´æ¥å¤„ç†Controllerä¸­çš„å¼‚å¸¸ã€‚å¦‚æœä¸æ˜¯WEBé¡¹ç›®çš„è¯ï¼Œå°±éœ€è¦ä½¿ç”¨AspectJæ¥åšåˆ‡é¢ã€‚\n1. webé¡¹ç›® package com.test.handler; import lombok.extern.log4j.Log4j2; import org.springframework.ui.Model; import org.springframework.web.bind.annotation.ControllerAdvice; import org.springframework.web.bind.annotation.ExceptionHandler; @ControllerAdvice @Log4j2 public class GlobalExceptionHandler { @ExceptionHandler(value = Exception.class) public String exception(Exception e, Model model){ log.error(\u0026#34;find exception:e={}\u0026#34;,e.getMessage()); model.addAttribute(\u0026#34;mes\u0026#34;,e.getMessage()); return \u0026#34;pages/500\u0026#34;; } } å‚è€ƒé“¾æ¥ï¼š\nSpringBootWEBé¡¹ç›®å’ŒéWebé¡¹ç›®çš„å…¨å±€å¼‚å¸¸æ•è·\rSpringBoot å¤„ç†å¼‚å¸¸çš„å‡ ç§å¸¸è§å§¿åŠ¿\rä½¿ç”¨æšä¸¾ç®€å•å°è£…ä¸€ä¸ªä¼˜é›…çš„ Spring Boot å…¨å±€å¼‚å¸¸å¤„ç†ï¼\r2. éwebé¡¹ç›® package com.test.syncbackend.handler; import lombok.extern.log4j.Log4j2; import org.aspectj.lang.ProceedingJoinPoint; import org.aspectj.lang.annotation.Around; import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.Pointcut; import org.springframework.stereotype.Component; @Component @Aspect @Log4j2 public class GlobalExceptionHandler { @Pointcut(\u0026#34;execution(* com.test.syncbackend.scheduleds.*.*(..))\u0026#34;) public void pointCut() { } @Around(\u0026#34;pointCut()\u0026#34;) public Object handlerException(ProceedingJoinPoint proceedingJoinPoint) { try { return proceedingJoinPoint.proceed(); } catch (Throwable ex) { log.error(\u0026#34;execute scheduled occur exception.\u0026#34;, ex); } return null; } } ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/spring%E4%BC%98%E9%9B%85%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/","series":["Manual"],"tags":["Spring"],"title":"Springä¼˜é›…çš„å¼‚å¸¸å¤„ç†"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"å‚è€ƒé“¾æ¥\nhttp://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/ssl-tls%E5%8D%8F%E8%AE%AE/","series":["Manual"],"tags":["CS"],"title":"SSL/TLSåè®®"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"ç®€ä»‹ æ•°æ®åœ¨TCPå±‚ç§°ä¸ºæµï¼ˆStreamï¼‰ï¼Œæ•°æ®åˆ†ç»„ç§°ä¸ºåˆ†æ®µï¼ˆSegmentï¼‰ã€‚ä½œä¸ºæ¯”è¾ƒï¼Œæ•°æ®åœ¨IPå±‚ç§°ä¸ºDatagramï¼Œæ•°æ®åˆ†ç»„ç§°ä¸ºåˆ†ç‰‡ï¼ˆFragmentï¼‰ã€‚ UDP ä¸­åˆ†ç»„ç§°ä¸ºMessageã€‚\nTCP æ•°æ®åŒ…çš„å¤§å° ä»¥å¤ªç½‘æ•°æ®åŒ…ï¼ˆpacketï¼‰çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œæœ€åˆæ˜¯1518å­—èŠ‚ï¼Œåæ¥å¢åŠ åˆ°1522å­—èŠ‚ã€‚å…¶ä¸­ï¼Œ 1500 å­—èŠ‚æ˜¯è´Ÿè½½ï¼ˆpayloadï¼‰ï¼Œ22å­—èŠ‚æ˜¯å¤´ä¿¡æ¯ï¼ˆheadï¼‰ã€‚ IP æ•°æ®åŒ…åœ¨ä»¥å¤ªç½‘æ•°æ®åŒ…çš„è´Ÿè½½é‡Œé¢ï¼Œå®ƒä¹Ÿæœ‰è‡ªå·±çš„å¤´ä¿¡æ¯ï¼Œæœ€å°‘éœ€è¦20å­—èŠ‚ï¼Œæ‰€ä»¥ IP æ•°æ®åŒ…çš„è´Ÿè½½æœ€å¤šä¸º1480å­—èŠ‚ã€‚\nï¼ˆå›¾ç‰‡è¯´æ˜ï¼šIP æ•°æ®åŒ…åœ¨ä»¥å¤ªç½‘æ•°æ®åŒ…é‡Œé¢ï¼ŒTCP æ•°æ®åŒ…åœ¨ IP æ•°æ®åŒ…é‡Œé¢ã€‚ï¼‰\nTCP æ•°æ®åŒ…åœ¨ IP æ•°æ®åŒ…çš„è´Ÿè½½é‡Œé¢ã€‚å®ƒçš„å¤´ä¿¡æ¯æœ€å°‘ä¹Ÿéœ€è¦20å­—èŠ‚ï¼Œå› æ­¤ TCP æ•°æ®åŒ…çš„æœ€å¤§è´Ÿè½½æ˜¯ 1480 - 20 = 1460 å­—èŠ‚ã€‚ç”±äº IP å’Œ TCP åè®®å¾€å¾€æœ‰é¢å¤–çš„å¤´ä¿¡æ¯ï¼Œæ‰€ä»¥ TCP è´Ÿè½½å®é™…ä¸º1400å­—èŠ‚å·¦å³ã€‚\nå› æ­¤ï¼Œä¸€æ¡1500å­—èŠ‚çš„ä¿¡æ¯éœ€è¦ä¸¤ä¸ª TCP æ•°æ®åŒ…ã€‚HTTP/2 åè®®çš„ä¸€å¤§æ”¹è¿›ï¼Œ å°±æ˜¯å‹ç¼© HTTP åè®®çš„å¤´ä¿¡æ¯ï¼Œä½¿å¾—ä¸€ä¸ª HTTP è¯·æ±‚å¯ä»¥æ”¾åœ¨ä¸€ä¸ª TCP æ•°æ®åŒ…é‡Œé¢ï¼Œè€Œä¸æ˜¯åˆ†æˆå¤šä¸ªï¼Œè¿™æ ·å°±æé«˜äº†é€Ÿåº¦ã€‚\nåˆ›å»ºè¿æ¥ TCPç”¨ä¸‰æ¬¡æ¡æ‰‹ï¼ˆæˆ–ç§°ä¸‰è·¯æ¡æ‰‹ï¼Œthree-way handshakeï¼‰è¿‡ç¨‹åˆ›å»ºä¸€ä¸ªè¿æ¥ã€‚åœ¨è¿æ¥åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå¾ˆå¤šå‚æ•°è¦è¢«åˆå§‹åŒ–ï¼Œä¾‹å¦‚åºå·è¢«åˆå§‹åŒ–ä»¥ä¿è¯æŒ‰åºä¼ è¾“å’Œè¿æ¥çš„å¼ºå£®æ€§ã€‚ ä¸€å¯¹ç»ˆç«¯åŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªå®ƒä»¬ä¹‹é—´çš„è¿æ¥æ˜¯å¯èƒ½çš„ã€‚ä½†é€šå¸¸æ˜¯ç”±ä¸€ç«¯æ‰“å¼€ä¸€ä¸ªå¥—æ¥å­—\rï¼ˆsocket\rï¼‰ç„¶åç›‘å¬æ¥è‡ªå¦ä¸€æ–¹çš„è¿æ¥ï¼Œè¿™å°±æ˜¯é€šå¸¸æ‰€æŒ‡çš„è¢«åŠ¨æ‰“å¼€ï¼ˆpassive openï¼‰ã€‚æœåŠ¡å™¨ç«¯è¢«è¢«åŠ¨æ‰“å¼€ä»¥åï¼Œç”¨æˆ·ç«¯å°±èƒ½å¼€å§‹åˆ›å»ºä¸»åŠ¨æ‰“å¼€ï¼ˆactive openï¼‰ã€‚\n å®¢æˆ·ç«¯é€šè¿‡å‘æœåŠ¡å™¨ç«¯å‘é€ä¸€ä¸ªSYNæ¥åˆ›å»ºä¸€ä¸ªä¸»åŠ¨æ‰“å¼€ï¼Œä½œä¸ºä¸‰æ¬¡æ¡æ‰‹çš„ä¸€éƒ¨åˆ†ã€‚å®¢æˆ·ç«¯æŠŠè¿™æ®µè¿æ¥çš„åºå·è®¾å®šä¸ºéšæœºæ•°Aã€‚ æœåŠ¡å™¨ç«¯åº”å½“ä¸ºä¸€ä¸ªåˆæ³•çš„SYNå›é€ä¸€ä¸ªSYN/ACKã€‚ACKçš„ç¡®è®¤ç åº”ä¸ºA+1ï¼ŒSYN/ACKåŒ…æœ¬èº«åˆæœ‰ä¸€ä¸ªéšæœºäº§ç”Ÿçš„åºå·Bã€‚ æœ€åï¼Œå®¢æˆ·ç«¯å†å‘é€ä¸€ä¸ªACKã€‚æ­¤æ—¶åŒ…çš„åºå·è¢«è®¾å®šä¸ºA+1ï¼Œè€ŒACKçš„ç¡®è®¤ç åˆ™ä¸ºB+1ã€‚å½“æœåŠ¡ç«¯æ”¶åˆ°è¿™ä¸ªACKçš„æ—¶å€™ï¼Œå°±å®Œæˆäº†ä¸‰æ¬¡æ¡æ‰‹ï¼Œå¹¶è¿›å…¥äº†è¿æ¥åˆ›å»ºçŠ¶æ€ã€‚  æ³¨æ„ï¼šä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥çš„æ—¶å€™ï¼Œ SYN/ACK æ˜¯ä¸€ä¸ªæ•°æ®åŒ…å‘é€å‡ºå»çš„\næ³¨æ„ï¼šä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥çš„æ—¶å€™ï¼Œ SYN/ACK æ˜¯ä¸€ä¸ªæ•°æ®åŒ…å‘é€å‡ºå»çš„\nå¦‚æœæœåŠ¡å™¨ç«¯æ¥åˆ°äº†å®¢æˆ·ç«¯å‘çš„SYNåå›äº†SYN-ACKåå®¢æˆ·ç«¯æ‰çº¿äº†ï¼ŒæœåŠ¡å™¨ç«¯æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯å›æ¥çš„ACKï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªè¿æ¥å¤„äºä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œå³æ²¡æˆåŠŸï¼Œä¹Ÿæ²¡å¤±è´¥ã€‚äºæ˜¯ï¼ŒæœåŠ¡å™¨ç«¯å¦‚æœåœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°çš„TCPä¼šé‡å‘SYN-ACKã€‚åœ¨Linuxä¸‹ï¼Œé»˜è®¤é‡è¯•æ¬¡æ•°ä¸º5æ¬¡ï¼Œé‡è¯•çš„é—´éš”æ—¶é—´ä»1så¼€å§‹æ¯æ¬¡éƒ½ç¿»å€ï¼Œ5æ¬¡çš„é‡è¯•æ—¶é—´é—´éš”ä¸º1s, 2s, 4s, 8s, 16sï¼Œæ€»å…±31sï¼Œç¬¬5æ¬¡å‘å‡ºåè¿˜è¦ç­‰32sæ‰çŸ¥é“ç¬¬5æ¬¡ä¹Ÿè¶…æ—¶äº†ï¼Œæ‰€ä»¥ï¼Œæ€»å…±éœ€è¦ 1s + 2s + 4s+ 8s+ 16s + 32s = 63sï¼ŒTCPæ‰ä¼šæ–­å¼€è¿™ä¸ªè¿æ¥ã€‚ä½¿ç”¨ä¸‰ä¸ªTCPå‚æ•°æ¥è°ƒæ•´è¡Œä¸ºï¼štcp_synack_retries å‡å°‘é‡è¯•æ¬¡æ•°ï¼›tcp_max_syn_backlogï¼Œå¢å¤§SYNè¿æ¥æ•°ï¼›tcp_abort_on_overflowå†³å®šè¶…å‡ºèƒ½åŠ›æ—¶çš„è¡Œä¸ºã€‚\næ•°æ®ä¼ è¾“  å‘é€æ–¹é¦–å…ˆå‘é€ç¬¬ä¸€ä¸ªåŒ…å«åºåˆ—å·ä¸º1ï¼ˆå¯å˜åŒ–ï¼‰å’Œ1460å­—èŠ‚æ•°æ®çš„TCPæŠ¥æ–‡æ®µç»™æ¥æ”¶æ–¹ã€‚æ¥æ”¶æ–¹ä»¥ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„TCPæŠ¥æ–‡æ®µæ¥å›å¤ï¼ˆåªå«æŠ¥å¤´ï¼‰ï¼Œç”¨ç¡®è®¤å·1461æ¥è¡¨ç¤ºå·²å®Œå…¨æ”¶åˆ°å¹¶è¯·æ±‚ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µã€‚ å‘é€æ–¹ç„¶åå‘é€ç¬¬äºŒä¸ªåŒ…å«åºåˆ—å·ä¸º1461ï¼Œé•¿åº¦ä¸º1460å­—èŠ‚çš„æ•°æ®çš„TCPæŠ¥æ–‡æ®µç»™æ¥æ”¶æ–¹ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¥æ”¶æ–¹ä»¥ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„TCPæŠ¥æ–‡æ®µæ¥å›å¤ï¼Œç”¨ç¡®è®¤å·2921ï¼ˆ1461+1460ï¼‰æ¥è¡¨ç¤ºå·²å®Œå…¨æ”¶åˆ°å¹¶è¯·æ±‚ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µã€‚å‘é€æ¥æ”¶è¿™æ ·ç»§ç»­ä¸‹å»ã€‚ ç„¶è€Œå½“è¿™äº›æ•°æ®åŒ…éƒ½æ˜¯ç›¸è¿çš„æƒ…å†µä¸‹ï¼Œæ¥æ”¶æ–¹æ²¡æœ‰å¿…è¦æ¯ä¸€æ¬¡éƒ½å›åº”ã€‚æ¯”å¦‚ï¼Œä»–æ”¶åˆ°ç¬¬1åˆ°5æ¡TCPæŠ¥æ–‡æ®µï¼Œåªéœ€å›åº”ç¬¬äº”æ¡å°±è¡Œäº†ã€‚åœ¨ä¾‹å­ä¸­ç¬¬3æ¡TCPæŠ¥æ–‡æ®µè¢«ä¸¢å¤±äº†ï¼Œæ‰€ä»¥å°½ç®¡ä»–æ”¶åˆ°äº†ç¬¬4å’Œ5æ¡ï¼Œç„¶è€Œä»–åªèƒ½å›åº”ç¬¬2æ¡ã€‚ å‘é€æ–¹åœ¨å‘é€äº†ç¬¬ä¸‰æ¡ä»¥åï¼Œæ²¡èƒ½æ”¶åˆ°å›åº”ï¼Œå› æ­¤å½“æ—¶é’Ÿï¼ˆtimerï¼‰è¿‡æ—¶ï¼ˆexpireï¼‰æ—¶ï¼Œä»–é‡å‘ç¬¬ä¸‰æ¡ã€‚ï¼ˆæ¯æ¬¡å‘é€è€…å‘é€ä¸€æ¡TCPæŠ¥æ–‡æ®µåï¼Œéƒ½ä¼šå†æ¬¡å¯åŠ¨ä¸€æ¬¡æ—¶é’Ÿï¼šRTTï¼‰ã€‚ è¿™æ¬¡ç¬¬ä¸‰æ¡è¢«æˆåŠŸæ¥æ”¶ï¼Œæ¥æ”¶æ–¹å¯ä»¥ç›´æ¥ç¡®è®¤ç¬¬5æ¡ï¼Œå› ä¸º4ï¼Œ5ä¸¤æ¡å·²æ”¶åˆ°ã€‚  ä¸Šå›¾åªè€ƒè™‘äº†ä¸€æ–¹å‘é€æ•°æ®ä¸€æ–¹æ¥æ”¶æ•°æ®çš„æƒ…å½¢ï¼Œå¦‚æœæ˜¯åŒæ–¹éƒ½æ”¶å‘æ•°æ®çš„æƒ…å½¢åˆ™å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä¸Šå›¾ä¸€å…±4æ¬¡é€šä¿¡ã€‚ç¬¬ä¸€æ¬¡é€šä¿¡ï¼ŒA ä¸»æœºå‘ç»™B ä¸»æœºçš„æ•°æ®åŒ…ç¼–å·æ˜¯1ï¼Œé•¿åº¦æ˜¯100å­—èŠ‚ï¼Œå› æ­¤ç¬¬äºŒæ¬¡é€šä¿¡ B ä¸»æœºçš„ ACK ç¼–å·æ˜¯ 1 + 100 = 101ï¼Œç¬¬ä¸‰æ¬¡é€šä¿¡ A ä¸»æœºçš„æ•°æ®åŒ…ç¼–å·ä¹Ÿæ˜¯ 101ã€‚åŒç†ï¼Œç¬¬äºŒæ¬¡é€šä¿¡ B ä¸»æœºå‘ç»™ A ä¸»æœºçš„æ•°æ®åŒ…ç¼–å·æ˜¯1ï¼Œé•¿åº¦æ˜¯200å­—èŠ‚ï¼Œå› æ­¤ç¬¬ä¸‰æ¬¡é€šä¿¡ A ä¸»æœºçš„ ACK æ˜¯201ï¼Œç¬¬å››æ¬¡é€šä¿¡ B ä¸»æœºçš„æ•°æ®åŒ…ç¼–å·ä¹Ÿæ˜¯201ã€‚\næ–­å¼€è¿æ¥ æ‰€è°“å››æ¬¡æŒ¥æ‰‹ï¼ˆFour-Way Wavehandï¼‰å³ç»ˆæ­¢TCPè¿æ¥ï¼Œå°±æ˜¯æŒ‡æ–­å¼€ä¸€ä¸ªTCPè¿æ¥æ—¶ï¼Œéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ€»å…±å‘é€4ä¸ªåŒ…ä»¥ç¡®è®¤è¿æ¥çš„æ–­å¼€ã€‚åœ¨socketç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯ä»»ä¸€æ–¹æ‰§è¡Œcloseæ¥è§¦å‘ï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næ³¨æ„ï¼šå››æ¬¡åˆ†æ‰‹æ–­å¼€è¿æ¥çš„æ—¶å€™ï¼ŒACKå’ŒFINä¿¡å·æ˜¯åˆ†æˆä¸¤æ¬¡å‘é€çš„\nç”±äºTCPè¿æ¥æ˜¯å…¨åŒå·¥çš„ï¼Œå› æ­¤ï¼Œæ¯ä¸ªæ–¹å‘éƒ½å¿…é¡»è¦å•ç‹¬è¿›è¡Œå…³é—­ã€‚è¿™ä¸€åŸåˆ™æ˜¯å½“ä¸€æ–¹å®Œæˆæ•°æ®å‘é€ä»»åŠ¡åï¼Œå‘é€ä¸€ä¸ªFINæ¥ç»ˆæ­¢è¿™ä¸€æ–¹å‘çš„è¿æ¥ï¼Œæ”¶åˆ°ä¸€ä¸ªFINåªæ˜¯æ„å‘³ç€è¿™ä¸€æ–¹å‘ä¸Šæ²¡æœ‰æ•°æ®æµåŠ¨äº†ï¼Œå³ä¸ä¼šå†æ”¶åˆ°æ•°æ®äº†ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªTCPè¿æ¥ä¸Šä»ç„¶èƒ½å¤Ÿå‘é€æ•°æ®ï¼Œç›´åˆ°è¿™ä¸€æ–¹å‘ä¹Ÿå‘é€äº†FINã€‚é¦–å…ˆè¿›è¡Œå…³é—­çš„ä¸€æ–¹å°†æ‰§è¡Œä¸»åŠ¨å…³é—­ï¼Œè€Œå¦ä¸€æ–¹åˆ™æ‰§è¡Œè¢«åŠ¨å…³é—­ã€‚\n ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šClientå‘é€ä¸€ä¸ªFINï¼Œç”¨æ¥å…³é—­Clientåˆ°Serverçš„æ•°æ®ä¼ é€ï¼ŒClientè¿›å…¥FIN_WAIT_1çŠ¶æ€ã€‚ ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šServeræ”¶åˆ°FINåï¼Œå‘é€ä¸€ä¸ªACKç»™Clientï¼Œç¡®è®¤åºå·ä¸ºæ”¶åˆ°åºå·+1ï¼ˆä¸SYNç›¸åŒï¼Œä¸€ä¸ªFINå ç”¨ä¸€ä¸ªåºå·ï¼‰ï¼ŒServerè¿›å…¥CLOSE_WAITçŠ¶æ€ã€‚ ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šServerå‘é€ä¸€ä¸ªFINï¼Œç”¨æ¥å…³é—­Serveråˆ°Clientçš„æ•°æ®ä¼ é€ï¼ŒServerè¿›å…¥LAST_ACKçŠ¶æ€ã€‚ ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šClientæ”¶åˆ°FINåï¼ŒClientè¿›å…¥TIME_WAITçŠ¶æ€ï¼Œæ¥ç€å‘é€ä¸€ä¸ªACKç»™Serverï¼Œç¡®è®¤åºå·ä¸ºæ”¶åˆ°åºå·+1ï¼ŒServerè¿›å…¥CLOSEDçŠ¶æ€ï¼Œå®Œæˆå››æ¬¡æŒ¥æ‰‹ã€‚ ä¸»åŠ¨å…³é—­ç«¯æ¥æ”¶åˆ°FINåï¼Œå°±å‘é€ACKåŒ…ï¼Œç­‰å¾…è¶³å¤Ÿæ—¶é—´ä»¥ç¡®ä¿è¢«åŠ¨å…³é—­ç«¯æ”¶åˆ°äº†ç»ˆæ­¢è¯·æ±‚çš„ç¡®è®¤åŒ…ã€‚ã€æŒ‰ç…§RFC 793ï¼Œä¸€ä¸ªè¿æ¥å¯ä»¥åœ¨TIME-WAITä¿è¯æœ€å¤§å››åˆ†é’Ÿï¼Œå³æœ€å¤§åˆ†æ®µå¯¿å‘½\rï¼ˆmaximum segment lifetimeï¼‰çš„2å€ã€‘  ä¸ºä»€ä¹ˆå»ºç«‹è¿æ¥æ˜¯3æ¬¡åˆ†æ‰‹æ˜¯4æ¬¡ï¼Ÿ\ré¦–å…ˆï¼Œå› ä¸ºtcpæ˜¯å…¨åŒå·¥é€šä¿¡ï¼Œå³åŒæ–¹éƒ½éœ€è¦æ”¶å‘æ•°æ®ï¼Œå› æ­¤åŒæ–¹éƒ½è¦é€šè¿‡å‘é€synæŒ‡ä»¤æ¥éšæœºåˆå§‹åŒ–ä¸€ä¸ªåŒ…åºåˆ—seqï¼Œå› ä¸ºackå’Œsynçš„åŒ…ä¸å¤§ï¼Œè¢«åŠ¨æ‰“å¼€çš„ä¸€æ–¹ä¸€æ¬¡æ€§å‘é€äº†ackå’ŒsynæŒ‡ä»¤ç»™ä¸»åŠ¨æ‰“å¼€çš„ä¸€æ–¹ï¼Œä¸»åŠ¨æ‰“å¼€æ–¹å†å›å¤ä¸€ä¸ªackï¼Œæ‰€ä»¥æ€»å…±3æ¬¡ã€‚\rè€Œåˆ†æ‰‹çš„æ—¶å€™ï¼Œå­˜åœ¨ç±»å•åŒå·¥çš„æƒ…å½¢ï¼ˆå³åªæœ‰ä¸€æ–¹å‘æ•°æ®ï¼Œå¦å¤–ä¸€æ–¹æ”¶æ•°æ®ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½åœ¨å›å¤finçš„æ—¶å€™åŒæ—¶å‘é€finï¼Œå³éœ€è¦åˆ†å¼€å‘é€ackå’Œfinï¼Œæ‰€ä»¥ä¸€å…±4æ¬¡é€šä¿¡ã€‚\rèµ„æºä½¿ç”¨ ä¸»æœºæ”¶åˆ°ä¸€ä¸ªTCPåŒ…æ—¶ï¼Œç”¨ä¸¤ç«¯çš„IPåœ°å€ä¸ç«¯å£å·æ¥æ ‡è¯†è¿™ä¸ªTCPåŒ…å±äºå“ªä¸ªsessionã€‚ä½¿ç”¨ä¸€å¼ è¡¨æ¥å­˜å‚¨æ‰€æœ‰çš„sessionï¼Œè¡¨ä¸­çš„æ¯æ¡ç§°ä½œTransmission Control Blockï¼ˆTCBï¼‰ï¼Œtcbç»“æ„çš„å®šä¹‰åŒ…æ‹¬è¿æ¥ä½¿ç”¨çš„æºç«¯å£ã€ç›®çš„ç«¯å£ã€ç›®çš„ipã€åºå·ã€åº”ç­”åºå·ã€å¯¹æ–¹çª—å£å¤§å°ã€å·±æ–¹çª—å£å¤§å°ã€tcpçŠ¶æ€ã€tcpè¾“å…¥/è¾“å‡ºé˜Ÿåˆ—ã€åº”ç”¨å±‚è¾“å‡ºé˜Ÿåˆ—ã€tcpçš„é‡ä¼ æœ‰å…³å˜é‡ç­‰ã€‚\næœåŠ¡å™¨ç«¯çš„è¿æ¥æ•°é‡æ˜¯æ— é™çš„ï¼Œåªå—å†…å­˜çš„é™åˆ¶ã€‚å®¢æˆ·ç«¯çš„è¿æ¥æ•°é‡ï¼Œè¿‡å»ç”±äºåœ¨å‘é€ç¬¬ä¸€ä¸ªSYNåˆ°æœåŠ¡å™¨ä¹‹å‰éœ€è¦å…ˆåˆ†é…ä¸€ä¸ªéšæœºç©ºé—²çš„ç«¯å£ï¼Œè¿™é™åˆ¶äº†å®¢æˆ·ç«¯IPåœ°å€çš„å¯¹å¤–å‘å‡ºè¿æ¥çš„æ•°é‡ä¸Šé™ã€‚ä»Linux 4.2å¼€å§‹ï¼Œæœ‰äº†socketé€‰é¡¹IP_BIND_ADDRESS_NO_PORTï¼Œå®ƒé€šçŸ¥Linuxå†…æ ¸ä¸ä¿ç•™usingbindä½¿ç”¨ç«¯å£å·ä¸º0æ—¶å†…éƒ¨ä½¿ç”¨çš„ä¸´æ—¶ç«¯å£ï¼ˆephemeral portï¼‰ï¼Œåœ¨connectæ—¶ä¼šè‡ªåŠ¨é€‰æ‹©ç«¯å£ä»¥ç»„æˆç‹¬ä¸€æ— äºŒçš„å››å…ƒç»„ï¼ˆåŒä¸€ä¸ªå®¢æˆ·ç«¯ç«¯å£å¯ç”¨äºè¿æ¥ä¸åŒçš„æœåŠ¡å™¨å¥—æ¥å­—\rï¼›åŒä¸€ä¸ªæœåŠ¡å™¨ç«¯å£å¯ç”¨äºæ¥å—ä¸åŒå®¢æˆ·ç«¯å¥—æ¥å­—çš„è¿æ¥ï¼‰ã€‚å¯¹äºä¸èƒ½ç¡®è®¤çš„åŒ…ã€æ¥æ”¶ä½†è¿˜æ²¡è¯»å–çš„æ•°æ®ï¼Œéƒ½ä¼šå ç”¨æ“ä½œç³»ç»Ÿçš„èµ„æºã€‚\nå‚è€ƒè¿æ¥ ä¼ è¾“æ§åˆ¶åè®®\rTCP åè®®ç®€ä»‹\rå›¾è§£TCPä¼ è¾“è¿‡ç¨‹ï¼ˆä¸‰æ¬¡æ¡æ‰‹ã€æ•°æ®ä¼ è¾“ã€å››æ¬¡æŒ¥æ‰‹ï¼‰\rTCPåè®®è¯¦è§£\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/tcp/tcp%E5%8D%8F%E8%AE%AE/","series":["Manual"],"tags":["CS"],"title":"TCPåè®®"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ThreadLocal æ˜¯ä¸€ä¸ªçº¿ç¨‹çš„æœ¬åœ°å˜é‡ï¼Œä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªå˜é‡æ˜¯çº¿ç¨‹ç‹¬æœ‰çš„ï¼Œæ˜¯ä¸èƒ½ä¸å…¶ä»–çº¿ç¨‹å…±äº«çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…èµ„æºç«äº‰å¸¦æ¥çš„å¤šçº¿ç¨‹çš„é—®é¢˜ï¼Œè¿™ç§è§£å†³å¤šçº¿ç¨‹çš„å®‰å…¨é—®é¢˜å’Œlock(è¿™é‡Œçš„lock æŒ‡é€šè¿‡synchronized æˆ–è€…Lock ç­‰å®ç°çš„é”) æ˜¯æœ‰æœ¬è´¨çš„åŒºåˆ«çš„:\n lock çš„èµ„æºæ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œæ‰€ä»¥è®¿é—®çš„æ—¶å€™éœ€è¦åŠ é”ã€‚ ThreadLocal æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œæ˜¯ä¸éœ€è¦åŠ é”çš„ã€‚ lock æ˜¯é€šè¿‡æ—¶é—´æ¢ç©ºé—´çš„åšæ³•ã€‚ ThreadLocal æ˜¯å…¸å‹çš„é€šè¿‡ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ã€‚  å½“ç„¶ä»–ä»¬çš„ä½¿ç”¨åœºæ™¯ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œå…³é”®çœ‹ä½ çš„èµ„æºæ˜¯éœ€è¦å¤šçº¿ç¨‹ä¹‹é—´å…±äº«çš„è¿˜æ˜¯å•çº¿ç¨‹å†…éƒ¨å…±äº«çš„ã€‚\nThreadLocal çš„ä½¿ç”¨æ˜¯éå¸¸ç®€å•çš„ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ï¼š\npublic class Test { public static void main(String[] args) { ThreadLocal\u0026lt;String\u0026gt; local = new ThreadLocal\u0026lt;\u0026gt;(); //è®¾ç½®å€¼  local.set(\u0026#34;hello word\u0026#34;); //è·å–åˆšåˆšè®¾ç½®çš„å€¼  System.out.println(local.get()); } } ThreadLocalçš„æ•°æ®ç»“æ„ ä¸ºä»€ä¹ˆThreadLocalMap é‡‡ç”¨å¼€æ”¾åœ°å€æ³•æ¥è§£å†³å“ˆå¸Œå†²çª? ThreadLocal å¾€å¾€å­˜æ”¾çš„æ•°æ®é‡ä¸ä¼šç‰¹åˆ«å¤§ï¼Œè¿™ä¸ªæ—¶å€™å¼€æ”¾åœ°å€æ³•ç®€å•çš„ç»“æ„ä¼šæ˜¾å¾—æ›´çœç©ºé—´ï¼ˆé“¾åœ°å€æ³•éœ€è¦é¢å¤–çš„æŒ‡é’ˆç©ºé—´ï¼‰\nThreadLocalåº”ç”¨åœºæ™¯ ä¼ é€’å‚æ•° ThreadLocalç”¨äºä¼ é€’å‚æ•°åŠä¼˜åŠ¿\rä¿è¯çº¿ç¨‹å®‰å…¨ SimpleDateFormatæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œä¾‹å¦‚ä¸‹é¢çš„å†™æ³•ä¼šæŠ¥é”™ï¼š\næ—¥æœŸè½¬æ¢çš„ä¸€ä¸ªå·¥å…·ç±»\npublic class DateUtil {\rprivate static final SimpleDateFormat sdf = new SimpleDateFormat(\u0026quot;yyyy-MM-dd HH:mm:ss\u0026quot;);\rpublic static Date parse(String dateStr) {\rDate date = null;\rtry {\rdate = sdf.parse(dateStr);\r} catch (ParseException e) {\re.printStackTrace();\r}\rreturn date;\r}\r}\rç„¶åå°†è¿™ä¸ªå·¥å…·ç±»ç”¨åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹\npublic static void main(String[] args) {\rExecutorService service = Executors.newFixedThreadPool(20);\rfor (int i = 0; i \u0026lt; 20; i++) {\rservice.execute(()-\u0026gt;{\rSystem.out.println(DateUtil.parse(\u0026quot;2019-06-01 16:34:30\u0026quot;));\r});\r}\rservice.shutdown();\r}\rç»“æœæŠ¥å¼‚å¸¸äº†ï¼š\nException in thread \u0026#34;pool-1-thread-3\u0026#34; Exception in thread \u0026#34;pool-1-thread-12\u0026#34; Exception in thread \u0026#34;pool-1-thread-7\u0026#34; Exception in thread \u0026#34;pool-1-thread-1\u0026#34; Exception in thread \u0026#34;pool-1-thread-11\u0026#34; Exception in thread \u0026#34;pool-1-thread-5\u0026#34; java.lang.NumberFormatException: For input string: \u0026#34;\u0026#34; at java.lang.NumberFormatException.forInputString(NumberFormatException.java:65) at java.lang.Long.parseLong(Long.java:601) at java.lang.Long.parseLong(Long.java:631) at java.text.DigitList.getLong(DigitList.java:195) at java.text.DecimalFormat.parse(DecimalFormat.java:2084) at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:1869) at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514) at java.text.DateFormat.parse(DateFormat.java:364) at Test.parse(Test.java:15) at Test.lambda$main$0(Test.java:27) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) java.lang.NumberFormatException: multiple points at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1890) at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:110) at java.lang.Double.parseDouble(Double.java:538) at java.text.DigitList.getDouble(DigitList.java:169) at java.text.DecimalFormat.parse(DecimalFormat.java:2089) at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:1869) at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514) at java.text.DateFormat.parse(DateFormat.java:364) at Test.parse(Test.java:15) at Test.lambda$main$0(Test.java:27) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) java.lang.NumberFormatException: multiple points at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1890) at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:110) at java.lang.Double.parseDouble(Double.java:538) at java.text.DigitList.getDouble(DigitList.java:169) at java.text.DecimalFormat.parse(DecimalFormat.java:2089) at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:2162) at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514) at java.text.DateFormat.parse(DateFormat.java:364) at Test.parse(Test.java:15) at Test.lambda$main$0(Test.java:27) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) java.lang.NumberFormatException: multiple points at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1890) at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:110) at java.lang.Double.parseDouble(Double.java:538) Sat Jun 01 16:34:30 CST 2019 Sat Jun 01 16:34:30 CST 2019 Tue Jun 01 16:34:30 CST 1 Sat Jun 01 16:34:30 CST 2019 Sat Jun 01 16:34:30 CST 2019 Sat Jun 01 16:34:30 CST 2019 Tue Jun 01 16:34:30 CST 1 Sat Jun 01 16:34:30 CST 2019 Sat Jun 01 16:34:30 CST 2019 Sat Jun 01 16:34:30 CST 2019 Sat Jun 01 16:34:30 CST 2019 Sat Jun 01 16:34:30 CST 2019 Sat Jun 01 16:34:30 CST 2019 Sat Jun 01 16:34:30 CST 2019 at java.text.DigitList.getDouble(DigitList.java:169) at java.text.DecimalFormat.parse(DecimalFormat.java:2089) at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:1869) at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514) at java.text.DateFormat.parse(DateFormat.java:364) at Test.parse(Test.java:15) at Test.lambda$main$0(Test.java:27) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) java.lang.NumberFormatException: multiple points at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1890) at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:110) at java.lang.Double.parseDouble(Double.java:538) at java.text.DigitList.getDouble(DigitList.java:169) at java.text.DecimalFormat.parse(DecimalFormat.java:2089) at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:2162) at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514) at java.text.DateFormat.parse(DateFormat.java:364) at Test.parse(Test.java:15) at Test.lambda$main$0(Test.java:27) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) java.lang.NumberFormatException: For input string: \u0026#34;2019.\u0026#34; at java.lang.NumberFormatException.forInputString(NumberFormatException.java:65) at java.lang.Long.parseLong(Long.java:589) at java.lang.Long.parseLong(Long.java:631) at java.text.DigitList.getLong(DigitList.java:195) at java.text.DecimalFormat.parse(DecimalFormat.java:2084) at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:1869) at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514) at java.text.DateFormat.parse(DateFormat.java:364) at Test.parse(Test.java:15) at Test.lambda$main$0(Test.java:27) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) Process finished with exit code 0 è§£å†³æ–¹æ¡ˆ4ï¼šç”¨ThreadLocalï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªSimpleDateFormatå¯¹è±¡\npublic class DateUtil { private static ThreadLocal\u0026lt;DateFormat\u0026gt; threadLocal = ThreadLocal.withInitial( ()-\u0026gt; new SimpleDateFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;)); public static Date parse(String dateStr) { Date date = null; try { date = threadLocal.get().parse(dateStr); } catch (ParseException e) { e.printStackTrace(); } return date; } } é…åˆçº¿ç¨‹æ± ä½¿ç”¨ï¼Œæ—¢ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œåˆä¸è‡³äºåƒ è§£å†³æ–¹æ¡ˆ1\råˆ›å»ºå¤ªå¤šçš„SimpleDateFormatå¯¹è±¡ã€‚\n[v_tips]ThreadLocal ä¿è¯çš„æ˜¯å•ä¸ªçº¿ç¨‹å†…éƒ¨è®¿é—®çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œä¸åŒçº¿ç¨‹è®¿é—®çš„ä¸æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚è¯¦è§ï¼šThreadLocalçº¿ç¨‹å•ä¾‹\r[/v_tips]\nå‚è€ƒé“¾æ¥ï¼š Javaé¢è¯•å¿…é—®ï¼šThreadLocalç»ˆæç¯‡ æ·¦ï¼\rè¢«å¤§å‚é¢è¯•å®˜è¿ç¯ç‚®è½°ç‚¸çš„ThreadLocal ï¼ˆåƒé€æºç çš„æ¯ä¸€ä¸ªç»†èŠ‚å’Œè®¾è®¡åŸç†ï¼‰\rä¸‡å­—è¯¦è§£ThreadLocalå…³é”®å­—\ré¢è¯•å®˜ï¼šThreadLocalçš„åº”ç”¨åœºæ™¯å’Œæ³¨æ„äº‹é¡¹æœ‰å“ªäº›ï¼Ÿ\ré¢è¯•å®˜ï¼šThreadLocalçš„åº”ç”¨åœºæ™¯å’Œæ³¨æ„äº‹é¡¹æœ‰å“ªäº›ï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/threadlocal/","series":["Manual"],"tags":["Java"],"title":"ThreadLocal"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ThreadLocal ä¿è¯çš„æ˜¯å•ä¸ªçº¿ç¨‹å†…éƒ¨è®¿é—®çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œä¸åŒçº¿ç¨‹è®¿é—®çš„ä¸æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚\npackage test; public class Singleton { private static final ThreadLocal\u0026lt;Singleton\u0026gt; singleton = new ThreadLocal\u0026lt;Singleton\u0026gt;() { @Override protected Singleton initialValue() { return new Singleton(); } }; public static Singleton getInstance() { return singleton.get(); } private Singleton() { } } package test; public class T implements Runnable { @Override public void run() { Singleton instance = Singleton.getInstance(); System.out.println(instance); } } æµ‹è¯•ç±»ï¼š\npackage test; public class Test { public static void main(String[] args){ System.out.println(\u0026#34;main thread \u0026#34;+Singleton.getInstance()); System.out.println(\u0026#34;main thread \u0026#34;+Singleton.getInstance()); System.out.println(\u0026#34;main thread \u0026#34;+Singleton.getInstance()); Thread thread0 = new Thread(new T()); Thread thread1 = new Thread(new T()); thread0.start(); thread1.start(); } } ç»“æœï¼š\nä¸¤ä¸ªçº¿ç¨‹ï¼ˆçº¿ç¨‹0å’Œçº¿ç¨‹1ï¼‰æ‹¿åˆ°çš„å¯¹è±¡å¹¶ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯åŒä¸€çº¿ç¨‹èƒ½ä¿è¯æ‹¿åˆ°çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå³çº¿ç¨‹å•ä¾‹ã€‚ ThreadLocalæ˜¯åŸºäºThreadLocalMapæ¥å®ç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è°ƒç”¨getæ–¹æ³•çš„æ—¶å€™ï¼Œé»˜è®¤èµ°çš„å°±æ˜¯è¿™ä¸ªmapï¼Œä¸ç”¨æŒ‡å®škeyï¼Œå®ƒç»´æŒäº†çº¿ç¨‹é—´çš„éš”ç¦»ã€‚ ThreadLocaléš”ç¦»äº†å¤šä¸ªçº¿ç¨‹å¯¹æ•°æ®çš„è®¿é—®å†²çªã€‚å¯¹å¤šçº¿ç¨‹èµ„æºå…±äº«çš„é—®é¢˜ï¼Œå‡å¦‚ä½¿ç”¨çš„æ˜¯åŒæ­¥é”ï¼Œé‚£ä¹ˆå°±æ˜¯ä»¥æ—¶é—´æ¢ç©ºé—´çš„æ–¹å¼ï¼›é‚£å‡å¦‚ä½¿ç”¨ThreadLocalï¼Œé‚£å°±æ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´çš„æ–¹å¼ã€‚\nå‚è€ƒé“¾æ¥ï¼š â€œå•ä¾‹â€æ¨¡å¼-ThreadLocalçº¿ç¨‹å•ä¾‹\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/threadlocal%E7%BA%BF%E7%A8%8B%E5%8D%95%E4%BE%8B/","series":["Manual"],"tags":["Java"],"title":"ThreadLocalçº¿ç¨‹å•ä¾‹"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"æ„é€ æ–¹æ³• public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue\u0026lt;Runnable\u0026gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) { if (corePoolSize \u0026lt; 0 || maximumPoolSize \u0026lt;= 0 || maximumPoolSize \u0026lt; corePoolSize || keepAliveTime \u0026lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this.acc = System.getSecurityManager() == null ? null : AccessController.getContext(); this.corePoolSize = corePoolSize; this.maximumPoolSize = maximumPoolSize; this.workQueue = workQueue; this.keepAliveTime = unit.toNanos(keepAliveTime); this.threadFactory = threadFactory; this.handler = handler; } æ„é€ å‡½æ•°çš„å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š\ncorePoolSizeï¼šæŒ‡å®šäº†çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œå®ƒçš„æ•°é‡å†³å®šäº†æ·»åŠ çš„ä»»åŠ¡æ˜¯å¼€è¾Ÿæ–°çš„çº¿ç¨‹å»æ‰§è¡Œï¼Œè¿˜æ˜¯æ”¾åˆ°workQueueä»»åŠ¡é˜Ÿåˆ—ä¸­å»ï¼›\nmaximumPoolSizeï¼šæŒ‡å®šäº†çº¿ç¨‹æ± ä¸­çš„æœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œè¿™ä¸ªå‚æ•°ä¼šæ ¹æ®ä½ ä½¿ç”¨çš„workQueueä»»åŠ¡é˜Ÿåˆ—çš„ç±»å‹ï¼Œå†³å®šçº¿ç¨‹æ± ä¼šå¼€è¾Ÿçš„æœ€å¤§çº¿ç¨‹æ•°é‡ï¼›\nkeepAliveTimeï¼šå½“çº¿ç¨‹æ± ä¸­ç©ºé—²çº¿ç¨‹æ•°é‡è¶…è¿‡corePoolSizeæ—¶ï¼Œå¤šä½™çš„çº¿ç¨‹ä¼šåœ¨å¤šé•¿æ—¶é—´å†…è¢«é”€æ¯ï¼›\nunitï¼škeepAliveTimeçš„å•ä½\nworkQueueï¼šä»»åŠ¡é˜Ÿåˆ—ï¼Œè¢«æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­ï¼Œä½†å°šæœªè¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼›å®ƒä¸€èˆ¬åˆ†ä¸ºç›´æ¥æäº¤é˜Ÿåˆ—ã€æœ‰ç•Œä»»åŠ¡é˜Ÿåˆ—ã€æ— ç•Œä»»åŠ¡é˜Ÿåˆ—ã€ä¼˜å…ˆä»»åŠ¡é˜Ÿåˆ—å‡ ç§ï¼›\nthreadFactoryï¼šçº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬ç”¨é»˜è®¤å³å¯ï¼›\nhandlerï¼šæ‹’ç»ç­–ç•¥ï¼›å½“ä»»åŠ¡å¤ªå¤šæ¥ä¸åŠå¤„ç†æ—¶ï¼Œå¦‚ä½•æ‹’ç»ä»»åŠ¡ï¼›\né˜»å¡é˜Ÿåˆ— é˜»å¡é˜Ÿåˆ—(BlockingQueue)æ˜¯ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„é˜Ÿåˆ—ã€‚è¿™ä¸¤ä¸ªé™„åŠ çš„æ“ä½œæ˜¯ï¼šåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©ºã€‚å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå­˜å‚¨å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å¯ç”¨ã€‚é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å¾€é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…å­˜æ”¾å…ƒç´ çš„å®¹å™¨ï¼Œè€Œæ¶ˆè´¹è€…ä¹Ÿåªä»å®¹å™¨é‡Œæ‹¿å…ƒç´ ã€‚\nä¸‹å›¾ä¸­å±•ç¤ºäº†çº¿ç¨‹1å¾€é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ï¼Œè€Œçº¿ç¨‹2ä»é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤å…ƒç´ ï¼š\nä½¿ç”¨ä¸åŒçš„é˜Ÿåˆ—å¯ä»¥å®ç°ä¸ä¸€æ ·çš„ä»»åŠ¡å­˜å–ç­–ç•¥ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å†ä»‹ç»ä¸‹é˜»å¡é˜Ÿåˆ—çš„æˆå‘˜ï¼š\næ‹’ç»ç­–ç•¥ ç”¨æˆ·å¯ä»¥é€šè¿‡å®ç°RejectedExecutionHandler æ¥å£å»å®šåˆ¶æ‹’ç»ç­–ç•¥ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©JDKæä¾›çš„å››ç§å·²æœ‰æ‹’ç»ç­–ç•¥ï¼Œå…¶ç‰¹ç‚¹å¦‚ä¸‹ï¼š\nå‚è€ƒé“¾æ¥ï¼š Javaçº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µ\rjavaçº¿ç¨‹æ± ThreadPoolExecutorç±»ä½¿ç”¨è¯¦è§£\rJavaå¤šçº¿ç¨‹-çº¿ç¨‹æ± ThreadPoolExecutoræ„é€ æ–¹æ³•å’Œè§„åˆ™\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/threadpoolexecutor/","series":["Manual"],"tags":["Java"],"title":"ThreadPoolExecutor"},{"categories":["å…¶ä»–"],"content":"Ubuntuä¿®æ”¹ip\næ–¹å¼ä¸€ è¿™ç§æ–¹å¼å¯ä»¥ä¿®æ”¹ipåœ°å€ï¼Œä¸èƒ½è®¿é—®äº’è”ç½‘ï¼›è™šæ‹Ÿæœº100å¿…é¡»ä»¥è¿™ç§æ–¹å¼é…ç½®ï¼ˆ101ã€102ã€103æ˜¯å¤åˆ¶100è€Œæ¥ï¼‰\n1ã€sudo vi /etc/netplan/50-cloud-init.yaml\nnetwork: ethernets: enp0s3: addresses: [10.0.2.15/24] dhcp4: true enp0s8: addresses: [192.168.56.100/24] dhcp4: false version: 2 2ã€é‡å¯è™šæ‹Ÿæœº\næ–¹å¼äºŒ è¿™ç§æ–¹å¼å¯ä»¥ä¿®æ”¹ipåœ°å€ï¼Œèƒ½è®¿é—®äº’è”ç½‘ï¼›è™šæ‹Ÿæœº101ã€102ã€103ä»¥è¿™ç§æ–¹å¼é…ç½®\n1ã€æ³¨é‡Š50-cloud-init.yamlé‡Œé¢çš„ä¿®æ”¹\n2ã€sudo vim /etc/network/interfaces\n# This file describes the network interfaces available on your system # and how to activate them. For more information, see interfaces(5). source /etc/network/interfaces.d/* # The loopback network interface auto lo iface lo inet loopback # The primary network interface(NAT) auto enp0s3 iface enp0s3 inet dhcp # å¢åŠ çš„Host-onlyé™æ€IPè®¾ç½® (enp0s8 æ˜¯æ ¹æ®æ‹“æ‰‘å…³ç³»æ˜ å°„çš„ç½‘å¡åç§°ï¼ˆæ—§è§„åˆ™æ˜¯eth0,eth1ï¼‰) # å¯ä»¥é€šè¿‡ ```ls /sys/class/net```æŸ¥çœ‹ï¼Œæ˜¯å¦ä¸ºenp0s8 auto enp0s8 iface enp0s8 inet static address 192.168.56.101 netmask 255.255.255.0 ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/ubuntu%E4%BF%AE%E6%94%B9ip/","series":["Manual"],"tags":["Other"],"title":"Ubuntuä¿®æ”¹ip"},{"categories":["å…¶ä»–"],"content":"1ã€vim /etc/resolv.conf\nnameserver 8.8.8.8 nameserver 114.114.114.114 nameserver 1.2.4.8 2ã€vim /etc/network/interfaces\ndns-nameserver 8.8.8.8 dns-nameserver 114.114.114.114 dns-nameserver 1.2.4.8 3ã€/etc/init.d/networking restart\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/ubuntu%E4%BF%AE%E6%94%B9%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/","series":["Manual"],"tags":["Other"],"title":"Ubuntuä¿®æ”¹åŸŸåè§£æ"},{"categories":["å…¶ä»–"],"content":"woocommerce_rest_authentication_error\nnginxé…ç½®é”™è¯¯å¯¼è‡´woocommerce REST APIä¸å¯ç”¨\nIt was a bad configuration of try_files in nginx:\nWRONG\ntry_files $uri $uri/ /index.php?q=$uri\u0026amp;$args; CORRECT\ntry_files $uri $uri/ /index.php$is_args$args; After changing that everything works perfectly ^^\nå‚è€ƒï¼š woocommerce_rest_authentication_error on localhost\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/wordpress/woocommerce_rest_authentication_error/","series":["Manual"],"tags":["WordPress"],"title":"woocommerce_rest_authentication_error"},{"categories":["å…¶ä»–"],"content":"WordPress å®‰è£…æ’ä»¶ cURL error 77è§£å†³\nç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œå‘½ä»¤\nyum install ca-certificates ç¬¬äºŒæ­¥ï¼šé‡å¯php-fpm\n/etc/init.d/php-fpm restart ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/wordpress/wordpress-%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6-curl-error-77%E8%A7%A3%E5%86%B3/","series":["Manual"],"tags":["WordPress"],"title":"WordPress å®‰è£…æ’ä»¶ cURL error 77è§£å†³"},{"categories":["å…¶ä»–"],"content":"WordPressæ”¹é€ æˆhttpsçš„æ³¨æ„äº‹é¡¹\nWordPressåŠ å…¥sslåå¯èƒ½å‡ºç°çš„ç½‘ç«™è®¿é—®ç¼“æ…¢ã€æ ·å¼æ— æ³•è¢«åŠ è½½ï¼Œæ˜¯ç”±äºç«™ç‚¹è™½ç„¶è¢«æ”¹é€ æˆäº†httpsè®¿é—®ï¼Œä½†æ˜¯ WordPress ä»£ç å±‚é¢å¯¹äºä¸€äº›cssã€jsã€å›¾ç‰‡ç­‰é™æ€èµ„æºçš„è®¿é—®è¿˜æ˜¯httpçš„ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚è§£å†³çš„åŠæ³•å¯ä»¥æ”¹é€ ä»£ç ï¼Œä¹Ÿå¯ä»¥å®‰è£…WordPressæ’ä»¶ã€‚ä¸‹é¢ä»‹ç»åè€…çš„æ­¥éª¤ï¼š\n1ã€ç”³è¯·è¯ä¹¦ã€ä¸Šä¼ è¯ä¹¦åˆ°æœåŠ¡å™¨ã€é…ç½®æœåŠ¡å™¨ï¼ˆé˜¿é‡Œäº‘æœ‰å…è´¹çš„è¯ä¹¦ï¼Œå¹¶æœ‰è¯¦ç»†çš„æ“ä½œæ­¥éª¤ï¼‰\n2ã€å®‰è£… Really Simple SSLæ’ä»¶ï¼Œå®ƒä¼šå°†httpçš„è¯·æ±‚å…¨éƒ½è½¬æˆhttpsï¼ˆæ„Ÿè°¢ä½œè€…å§ï¼‰\n3ã€ åå°ä¿®æ”¹wordpressåœ°å€å’Œç«™ç‚¹åœ°å€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå‚è€ƒé“¾æ¥ï¼šhttps://www.rogoso.info/wordpress-ssl/\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/wordpress/wordpress%E6%94%B9%E9%80%A0%E6%88%90https%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/","series":["Manual"],"tags":["WordPress"],"title":"WordPressæ”¹é€ æˆhttpsçš„æ³¨æ„äº‹é¡¹"},{"categories":["å…¶ä»–"],"content":"wordpressæ–‡ç« å‘å¸ƒåï¼ŒnginxæŠ¥404è§£å†³æ–¹æ³•\nä¿®æ”¹nginx.confæ–‡ä»¶ï¼Œåœ¨location /èŠ‚ç‚¹ä¸‹æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š\nlocation / { try_files $uri $uri/ /index.php?q=$uri\u0026amp;$args; } ç„¶åé‡å¯nginxå³å¯è§£å†³ã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/wordpress/wordpress%E6%96%87%E7%AB%A0%E5%8F%91%E5%B8%83%E5%90%8Enginx%E6%8A%A5404%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/","series":["Manual"],"tags":["WordPress"],"title":"wordpressæ–‡ç« å‘å¸ƒåï¼ŒnginxæŠ¥404è§£å†³æ–¹æ³•"},{"categories":["å…¶ä»–"],"content":"WordPressæ›´æ¢åŸŸå\nåœ¨æ›´æ¢çš„åŸŸåè¿‡ç¨‹ä¸­é‡åˆ°å¾ˆå¤šå‘ï¼Œä¸»è¦è¿˜æ˜¯æˆ‘çš„æ¶æ„æ¯”è¾ƒç‰¹æ®Šçš„åŸå› ï¼Œå¯¼è‡´è·Ÿä»¥å¾€é…ç½®ä¸å¤ªä¸€æ ·ï¼Œæ¶æ„å¦‚ä¸‹ï¼š\n\r1. æ— æ³•é€šè¿‡nginxè½¬å‘è¯·æ±‚åˆ°å®¹å™¨ç«¯å£ åŸå› ï¼šnginxé…ç½®ä¸æ­£ç¡®\nè§£å†³ï¼šè¡¥å……ç¼ºå¤±çš„å¦‚ä¸‹é…ç½®\nadd_header X-Frame-Options SAMEORIGIN; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_hide_header X-Frame-Options; æœ€ç»ˆç±»ä¼¼ï¼š\nserver { listen 443 ssl; listen [::]:443 ssl; include snippets/ssl-params.conf; server_name wptest.your-awesome-domain.com; # domainç•¶ç„¶è¦ç”¨è‡ªå·±çš„ï¼Œsubdomainè«‹éš¨è‡ªå·±å–œå¥½ location / { add_header X-Frame-Options SAMEORIGIN; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_hide_header X-Frame-Options; proxy_pass http://localhost:8000; # æ³¨æ„é€™é‚Šè·Ÿä¸Šé¢docker-composeè¨­å®šçš„portç›¸åŒ } } 2. æç¤ºâ€œé‡å®šå‘æ¬¡æ•°è¿‡å¤šâ€ ä¿®æ”¹wordpressæ ¹ç›®å½•ä¸‹çš„wp-config.phpï¼š\n$_SERVER[\u0026#39;HTTPS\u0026#39;] = \u0026#39;on\u0026#39;; define(\u0026#39;FORCE_SSL_LOGIN\u0026#39;, true); define(\u0026#39;FORCE_SSL_ADMIN\u0026#39;, true); å‚è€ƒé“¾æ¥ï¼š https://softman.blog/2019/07/26/nginx-reverse-proxy-to-dockerized-wordpress-the-basic/\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/wordpress/wordpress%E6%9B%B4%E6%8D%A2%E5%9F%9F%E5%90%8D/","series":["Manual"],"tags":["WordPress"],"title":"WordPressæ›´æ¢åŸŸå"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"Zookeeperåº”ç”¨åœºæ™¯\nzookeeperåº”ç”¨åœºæ™¯ å¤§è‡´æ¥è¯´ï¼Œzookeeper çš„ä½¿ç”¨åœºæ™¯å¦‚ä¸‹ï¼Œæˆ‘å°±ä¸¾å‡ ä¸ªç®€å•çš„ï¼Œå¤§å®¶èƒ½è¯´å‡ ä¸ªå°±å¥½äº†ï¼š\n åˆ†å¸ƒå¼åè°ƒ åˆ†å¸ƒå¼é” å…ƒæ•°æ®/é…ç½®ä¿¡æ¯ç®¡ç† HA é«˜å¯ç”¨æ€§  åˆ†å¸ƒå¼åè°ƒ è¿™ä¸ªå…¶å®æ˜¯ zookeeper å¾ˆç»å…¸çš„ä¸€ä¸ªç”¨æ³•ï¼Œç®€å•æ¥è¯´ï¼Œå°±å¥½æ¯”ï¼Œä½  A ç³»ç»Ÿå‘é€ä¸ªè¯·æ±‚åˆ° mqï¼Œç„¶å B ç³»ç»Ÿæ¶ˆæ¯æ¶ˆè´¹ä¹‹åå¤„ç†äº†ã€‚é‚£ A ç³»ç»Ÿå¦‚ä½•çŸ¥é“ B ç³»ç»Ÿçš„å¤„ç†ç»“æœï¼Ÿç”¨ zookeeper å°±å¯ä»¥å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´çš„åè°ƒå·¥ä½œã€‚A ç³»ç»Ÿå‘é€è¯·æ±‚ä¹‹åå¯ä»¥åœ¨ zookeeper ä¸Šå¯¹æŸä¸ªèŠ‚ç‚¹çš„å€¼æ³¨å†Œä¸ªç›‘å¬å™¨ï¼Œä¸€æ—¦ B ç³»ç»Ÿå¤„ç†å®Œäº†å°±ä¿®æ”¹ zookeeper é‚£ä¸ªèŠ‚ç‚¹çš„å€¼ï¼ŒA ç³»ç»Ÿç«‹é©¬å°±å¯ä»¥æ”¶åˆ°é€šçŸ¥ï¼Œå®Œç¾è§£å†³ã€‚\nåˆ†å¸ƒå¼é” ä¸¾ä¸ªæ —å­ã€‚å¯¹æŸä¸€ä¸ªæ•°æ®è¿ç»­å‘å‡ºä¸¤ä¸ªä¿®æ”¹æ“ä½œï¼Œä¸¤å°æœºå™¨åŒæ—¶æ”¶åˆ°äº†è¯·æ±‚ï¼Œä½†æ˜¯åªèƒ½ä¸€å°æœºå™¨å…ˆæ‰§è¡Œå®Œå¦å¤–ä¸€ä¸ªæœºå™¨å†æ‰§è¡Œã€‚é‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ zookeeper åˆ†å¸ƒå¼é”ï¼Œä¸€ä¸ªæœºå™¨æ¥æ”¶åˆ°äº†è¯·æ±‚ä¹‹åå…ˆè·å– zookeeper ä¸Šçš„ä¸€æŠŠåˆ†å¸ƒå¼é”ï¼Œå°±æ˜¯å¯ä»¥å»åˆ›å»ºä¸€ä¸ª znodeï¼Œæ¥ç€æ‰§è¡Œæ“ä½œï¼›ç„¶åå¦å¤–ä¸€ä¸ªæœºå™¨ä¹Ÿå°è¯•å»åˆ›å»ºé‚£ä¸ª znodeï¼Œç»“æœå‘ç°è‡ªå·±åˆ›å»ºä¸äº†ï¼Œå› ä¸ºè¢«åˆ«äººåˆ›å»ºäº†ï¼Œé‚£åªèƒ½ç­‰ç€ï¼Œç­‰ç¬¬ä¸€ä¸ªæœºå™¨æ‰§è¡Œå®Œäº†è‡ªå·±å†æ‰§è¡Œã€‚\nå…ƒæ•°æ®/é…ç½®ä¿¡æ¯ç®¡ç† zookeeper å¯ä»¥ç”¨ä½œå¾ˆå¤šç³»ç»Ÿçš„é…ç½®ä¿¡æ¯çš„ç®¡ç†ï¼Œæ¯”å¦‚ kafkaã€storm ç­‰ç­‰å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿéƒ½ä¼šé€‰ç”¨ zookeeper æ¥åšä¸€äº›å…ƒæ•°æ®ã€é…ç½®ä¿¡æ¯çš„ç®¡ç†ï¼ŒåŒ…æ‹¬ dubbo æ³¨å†Œä¸­å¿ƒä¸ä¹Ÿæ”¯æŒ zookeeper ä¹ˆï¼Ÿ\nHA é«˜å¯ç”¨æ€§ è¿™ä¸ªåº”è¯¥æ˜¯å¾ˆå¸¸è§çš„ï¼Œæ¯”å¦‚ hadoopã€hdfsã€yarn ç­‰å¾ˆå¤šå¤§æ•°æ®ç³»ç»Ÿï¼Œéƒ½é€‰æ‹©åŸºäº zookeeper æ¥å¼€å‘ HA é«˜å¯ç”¨æœºåˆ¶ï¼Œå°±æ˜¯ä¸€ä¸ªé‡è¦è¿›ç¨‹ä¸€èˆ¬ä¼šåšä¸»å¤‡ä¸¤ä¸ªï¼Œä¸»è¿›ç¨‹æŒ‚äº†ç«‹é©¬é€šè¿‡ zookeeper æ„ŸçŸ¥åˆ°åˆ‡æ¢åˆ°å¤‡ç”¨è¿›ç¨‹ã€‚\nå‚è€ƒ zookeeper éƒ½æœ‰å“ªäº›ä½¿ç”¨åœºæ™¯ï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/zookeeper/zookeeper%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/","series":["Manual"],"tags":["ZK"],"title":"Zookeeperåº”ç”¨åœºæ™¯"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ZookeeperæœåŠ¡æ³¨å†Œå‘ç°åŸç† RPCæ¡†æ¶ä¸­æœ‰3ä¸ªé‡è¦çš„è§’è‰²ï¼š\n æ³¨å†Œä¸­å¿ƒ ï¼šä¿å­˜æ‰€æœ‰æœåŠ¡çš„åå­—ï¼ŒæœåŠ¡æä¾›è€…çš„ipåˆ—è¡¨ï¼ŒæœåŠ¡æ¶ˆè´¹è€…çš„IPåˆ—è¡¨ æœåŠ¡æä¾›è€…ï¼š æä¾›è·¨è¿›ç¨‹æœåŠ¡ æœåŠ¡æ¶ˆè´¹è€…ï¼š å¯»æ‰¾åˆ°æŒ‡å®šå‘½åçš„æœåŠ¡å¹¶æ¶ˆè´¹ã€‚  Zookeeperç”¨ä½œæ³¨å†Œä¸­å¿ƒ ç®€å•æ¥è®²ï¼Œzookeeperå¯ä»¥å……å½“ä¸€ä¸ªæœåŠ¡æ³¨å†Œè¡¨ï¼ˆService Registryï¼‰ï¼Œè®©å¤šä¸ªæœåŠ¡æä¾›è€…å½¢æˆä¸€ä¸ªé›†ç¾¤ï¼Œè®©æœåŠ¡æ¶ˆè´¹è€…é€šè¿‡æœåŠ¡æ³¨å†Œè¡¨è·å–å…·ä½“çš„æœåŠ¡è®¿é—®åœ°å€ï¼ˆip+ç«¯å£ï¼‰å»è®¿é—®å…·ä½“çš„æœåŠ¡æä¾›è€…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå…·ä½“æ¥è¯´ï¼Œzookeeperå°±æ˜¯ä¸ªåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯å½“ä¸€ä¸ªæœåŠ¡æä¾›è€…éƒ¨ç½²åéƒ½è¦å°†è‡ªå·±çš„æœåŠ¡æ³¨å†Œåˆ°zookeeperçš„æŸä¸€è·¯å¾„ä¸Š: /{service}/{version}/{ip:port}, æ¯”å¦‚æˆ‘ä»¬çš„HelloWorldServiceéƒ¨ç½²åˆ°ä¸¤å°æœºå™¨ï¼Œé‚£ä¹ˆzookeeperä¸Šå°±ä¼šåˆ›å»ºä¸¤æ¡ç›®å½•ï¼šåˆ†åˆ«ä¸º/HelloWorldService/1.0.0/100.19.20.01:16888 /HelloWorldService/1.0.0/100.19.20.02:16888ã€‚\nè¿™ä¹ˆæè¿°æœ‰ç‚¹ä¸å¥½ç†è§£ï¼Œä¸‹å›¾æ›´ç›´è§‚ï¼Œ\nåœ¨zookeeperä¸­ï¼Œè¿›è¡ŒæœåŠ¡æ³¨å†Œï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨zookeeperä¸­åˆ›å»ºäº†ä¸€ä¸ªznodeèŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹å­˜å‚¨äº†è¯¥æœåŠ¡çš„IPã€ç«¯å£ã€è°ƒç”¨æ–¹å¼(åè®®ã€åºåˆ—åŒ–æ–¹å¼)ç­‰ã€‚è¯¥èŠ‚ç‚¹æ‰¿æ‹…ç€æœ€é‡è¦çš„èŒè´£ï¼Œå®ƒç”±æœåŠ¡æä¾›è€…(å‘å¸ƒæœåŠ¡æ—¶)åˆ›å»ºï¼Œä»¥ä¾›æœåŠ¡æ¶ˆè´¹è€…è·å–èŠ‚ç‚¹ä¸­çš„ä¿¡æ¯ï¼Œä»è€Œå®šä½åˆ°æœåŠ¡æä¾›è€…çœŸæ­£ç½‘ç»œæ‹“æ‰‘ä½ç½®ä»¥åŠå¾—çŸ¥å¦‚ä½•è°ƒç”¨ã€‚RPCæœåŠ¡æ³¨å†Œã€å‘ç°è¿‡ç¨‹ç®€è¿°å¦‚ä¸‹ï¼š\n æœåŠ¡æä¾›è€…å¯åŠ¨æ—¶ï¼Œä¼šå°†å…¶æœåŠ¡åç§°ï¼Œipåœ°å€æ³¨å†Œåˆ°é…ç½®ä¸­å¿ƒã€‚ æœåŠ¡æ¶ˆè´¹è€…åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æœåŠ¡æ—¶ï¼Œä¼šé€šè¿‡æ³¨å†Œä¸­å¿ƒæ‰¾åˆ°ç›¸åº”çš„æœåŠ¡çš„IPåœ°å€åˆ—è¡¨ï¼Œå¹¶ç¼“å­˜åˆ°æœ¬åœ°ï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚å½“æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡æ—¶ï¼Œä¸ä¼šå†å»è¯·æ±‚æ³¨å†Œä¸­å¿ƒï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•ä»IPåˆ—è¡¨ä¸­å–ä¸€ä¸ªæœåŠ¡æä¾›è€…çš„æœåŠ¡å™¨è°ƒç”¨æœåŠ¡ã€‚ å½“æœåŠ¡æä¾›è€…çš„æŸå°æœåŠ¡å™¨å®•æœºæˆ–ä¸‹çº¿æ—¶ï¼Œç›¸åº”çš„ipä¼šä»æœåŠ¡æä¾›è€…IPåˆ—è¡¨ä¸­ç§»é™¤ã€‚åŒæ—¶ï¼Œæ³¨å†Œä¸­å¿ƒä¼šå°†æ–°çš„æœåŠ¡IPåœ°å€åˆ—è¡¨å‘é€ç»™æœåŠ¡æ¶ˆè´¹è€…æœºå™¨ï¼Œç¼“å­˜åœ¨æ¶ˆè´¹è€…æœ¬æœºã€‚ å½“æŸä¸ªæœåŠ¡çš„æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸‹çº¿äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡ä¹Ÿå°±ä¸‹çº¿äº†ã€‚ åŒæ ·ï¼Œå½“æœåŠ¡æä¾›è€…çš„æŸå°æœåŠ¡å™¨ä¸Šçº¿æ—¶ï¼Œæ³¨å†Œä¸­å¿ƒä¼šå°†æ–°çš„æœåŠ¡IPåœ°å€åˆ—è¡¨å‘é€ç»™æœåŠ¡æ¶ˆè´¹è€…æœºå™¨ï¼Œç¼“å­˜åœ¨æ¶ˆè´¹è€…æœ¬æœºã€‚ æœåŠ¡æä¾›æ–¹å¯ä»¥æ ¹æ®æœåŠ¡æ¶ˆè´¹è€…çš„æ•°é‡æ¥ä½œä¸ºæœåŠ¡ä¸‹çº¿çš„ä¾æ®ã€‚  æ„ŸçŸ¥æœåŠ¡çš„ä¸‹çº¿\u0026amp;ä¸Šçº¿ zookeeperæä¾›äº†â€œå¿ƒè·³æ£€æµ‹â€åŠŸèƒ½ï¼Œå®ƒä¼šå®šæ—¶å‘å„ä¸ªæœåŠ¡æä¾›è€…å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ˆå®é™…ä¸Šå»ºç«‹çš„æ˜¯ä¸€ä¸ª socket é•¿è¿æ¥ï¼‰ï¼Œå¦‚æœé•¿æœŸæ²¡æœ‰å“åº”ï¼ŒæœåŠ¡ä¸­å¿ƒå°±è®¤ä¸ºè¯¥æœåŠ¡æä¾›è€…å·²ç»â€œæŒ‚äº†â€ï¼Œå¹¶å°†å…¶å‰”é™¤ï¼Œæ¯”å¦‚100.19.20.02è¿™å°æœºå™¨å¦‚æœå®•æœºäº†ï¼Œé‚£ä¹ˆzookeeperä¸Šçš„è·¯å¾„å°±ä¼šåªå‰©/HelloWorldService/1.0.0/100.19.20.01:16888ã€‚\næœåŠ¡æ¶ˆè´¹è€…ä¼šå»ç›‘å¬ç›¸åº”è·¯å¾„ï¼ˆ/HelloWorldService/1.0.0ï¼‰ï¼Œä¸€æ—¦è·¯å¾„ä¸Šçš„æ•°æ®æœ‰ä»»åŠ¡å˜åŒ–ï¼ˆå¢åŠ æˆ–å‡å°‘ï¼‰ï¼Œzookeeperéƒ½ä¼šé€šçŸ¥æœåŠ¡æ¶ˆè´¹æ–¹æœåŠ¡æä¾›è€…åœ°å€åˆ—è¡¨å·²ç»å‘ç”Ÿæ”¹å˜ï¼Œä»è€Œè¿›è¡Œæ›´æ–°ã€‚\næ›´ä¸ºé‡è¦çš„æ˜¯zookeeper ä¸ç”Ÿä¿±æ¥çš„å®¹é”™å®¹ç¾èƒ½åŠ›ï¼ˆæ¯”å¦‚leaderé€‰ä¸¾ï¼‰ï¼Œå¯ä»¥ç¡®ä¿æœåŠ¡æ³¨å†Œè¡¨çš„é«˜å¯ç”¨æ€§ã€‚\nä½¿ç”¨ zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒæ—¶ï¼Œå®¢æˆ·ç«¯è®¢é˜…æœåŠ¡æ—¶ä¼šå‘ zookeeper æ³¨å†Œè‡ªèº«ï¼›ä¸»è¦æ˜¯æ–¹ä¾¿å¯¹è°ƒç”¨æ–¹è¿›è¡Œç»Ÿè®¡ã€ç®¡ç†ã€‚ä½†è®¢é˜…æ—¶æ˜¯å¦æ³¨å†Œ client ä¸æ˜¯å¿…è¦è¡Œä¸ºï¼Œå’Œä¸åŒçš„æ³¨å†Œä¸­å¿ƒå®ç°æœ‰å…³ï¼Œä¾‹å¦‚ä½¿ç”¨ consul æ—¶ä¾¿æ²¡æœ‰æ³¨å†Œã€‚\nå‚è€ƒ Zookeeperç”¨ä½œæ³¨å†Œä¸­å¿ƒçš„åŸç†\r8ã€ZookeeperæœåŠ¡æ³¨å†Œä¸å‘ç°åŸç†æµ…æ\rå¾®æœåŠ¡ä¸­Zookeeperçš„åº”ç”¨åŠåŸç†\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/zookeeper/zookeeper%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0%E5%8E%9F%E7%90%86/","series":["Manual"],"tags":["ZK"],"title":"ZookeeperæœåŠ¡æ³¨å†Œå‘ç°åŸç†"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"Zookeeperæ ¸å¿ƒè®¾è®¡ç†è§£ä¸å®æˆ˜ ä¸€ã€å‰è¨€ æƒ³èµ·å¾ˆä¹…ä»¥å‰åœ¨æŸä¸ªå®¢æˆ·ç°åœºï¼Œå¾®æœåŠ¡ B çªç„¶æ— æ³•è°ƒç”¨åˆ°å¾®æœåŠ¡ Aï¼Œä¸ºäº†ä½¿æœåŠ¡å°½å¿«æ­£å¸¸æ¢å¤ï¼Œé‡å¯äº†å¾®æœåŠ¡ B ã€‚\nä½†å®¢æˆ·ä¸ä¾ä¸é¥¶è¯¢é—®è¿™ä¸ªé—®é¢˜å‡ºç°çš„åŸå› ï¼Œäºæ˜¯æˆ‘è¿˜å¤§è€è¿œä»æ­å·é£åˆ°æ·±åœ³ï¼Œç°åœºæ’æŸ¥é—®é¢˜ã€‚\næœ€åçš„ç»“è®ºæ˜¯ï¼Œzk åœ¨æŸæ—¶åˆ»å‡ºç°ä¸»å¤‡åˆ‡æ¢ï¼Œæ­¤æ—¶å¾®æœåŠ¡ Aï¼ˆåŸºäº dubboï¼‰éœ€è¦é‡æ–°å¾€ zkä¸Šæ³¨å†Œï¼Œä½†æ˜¯ç«¯å£å·å˜äº†ã€‚\nä½†æ˜¯å¾®æœåŠ¡ B æœ¬åœ°æœ‰å¾®æœåŠ¡ A rpc æ¥å£çš„ç¼“å­˜ï¼Œç¼“å­˜é‡Œé¢è¿˜æ˜¯æ—§çš„ç«¯å£ï¼Œæ‰€ä»¥è°ƒç”¨ä¸åˆ°ã€‚\nè§£å†³æ–¹æ³•å°±æ˜¯ï¼ŒæŠŠå¾®æœåŠ¡çš„ rpc ç«¯å£å·æ”¹æˆå›ºå®šçš„ã€‚\nè™½è¯´åŸå› æ‰¾åˆ°äº†ï¼Œä½†å¯¹äº Zookeeper çš„ç†è§£è¿˜æ˜¯ä¸å¤Ÿæ·±åˆ»ï¼Œäºæ˜¯é‡æ–°å­¦ä¹ äº† Zookeeper çš„æ ¸å¿ƒè®¾è®¡ï¼Œå¹¶è®°å½•äºæ­¤æ–‡å…±å‹‰ã€‚\näºŒã€Zookeeper æ ¸å¿ƒæ¶æ„è®¾è®¡ 1ã€Zookeeper ç‰¹ç‚¹ ï¼ˆ1ï¼‰Zookeeper æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œæ˜¯ä¸ºäº†è§£å†³å¤šä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå……å½“ä¸­é—´æœºæ„æ¥è°ƒåœã€‚å¦‚æœå‡ºç°äº†ä¸ä¸€è‡´ï¼Œåˆ™æŠŠè¿™ä¸ªä¸ä¸€è‡´çš„æƒ…å†µå†™å…¥åˆ° Zookeeper ä¸­ï¼ŒZookeeper ä¼šè¿”å›å“åº”ï¼Œå“åº”æˆåŠŸï¼Œåˆ™è¡¨ç¤ºå¸®ä½ è¾¾æˆäº†ä¸€è‡´ã€‚\næ¯”å¦‚ï¼ŒAã€Bã€C èŠ‚ç‚¹åœ¨é›†ç¾¤å¯åŠ¨æ—¶ï¼Œéœ€è¦æ¨ä¸¾å‡ºä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒAã€Bã€C åªè¦åŒæ—¶å¾€ Zookeeper ä¸Šæ³¨å†Œä¸´æ—¶èŠ‚ç‚¹ï¼Œè°å…ˆæ³¨å†ŒæˆåŠŸï¼Œè°å°±æ˜¯ä¸»èŠ‚ç‚¹ã€‚\nï¼ˆ2ï¼‰Zookeeper è™½ç„¶æ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œä½†æ˜¯æ•°æ®å¹¶ä¸æ˜¯åˆ†æ•£å­˜å‚¨åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šçš„ï¼Œè€Œæ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜äº†é›†ç¾¤æ‰€æœ‰çš„æ•°æ®ã€‚\nå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œæä¾›åˆ†å¸ƒå¼äº‹åŠ¡çš„å†™æœåŠ¡ï¼Œå…¶ä»–èŠ‚ç‚¹å’Œè¿™ä¸ªèŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼Œä¿æŒå’Œä¸»èŠ‚ç‚¹çŠ¶æ€ä¸€è‡´ã€‚\nï¼ˆ3ï¼‰Zookeeper æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®çŠ¶æ€é€šè¿‡ Zab åè®®ä¿æŒä¸€è‡´ã€‚å½“é›†ç¾¤ä¸­æ²¡æœ‰ Leader èŠ‚ç‚¹æ—¶ï¼Œå†…éƒ¨ä¼šæ‰§è¡Œé€‰ä¸¾ï¼Œé€‰ä¸¾ç»“æŸï¼ŒFollower å’Œ Leader æ‰§è¡ŒçŠ¶æ€åŒæ­¥ï¼›å½“æœ‰ Leader èŠ‚ç‚¹æ—¶ï¼ŒLeader é€šè¿‡ ZAB åè®®ä¸»å¯¼åˆ†å¸ƒå¼äº‹åŠ¡çš„æ‰§è¡Œï¼Œå¹¶ä¸”æ‰€æœ‰çš„äº‹åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚\nï¼ˆ4ï¼‰Zookeeper çš„èŠ‚ç‚¹ä¸ªæ•°æ˜¯ä¸èƒ½çº¿æ€§æ‰©å±•çš„ï¼ŒèŠ‚ç‚¹è¶Šå¤šï¼ŒåŒæ­¥æ•°æ®çš„å‹åŠ›è¶Šå¤§ï¼Œæ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½è¶Šå·®ã€‚æ¨è3ã€5ã€7 è¿™æ ·çš„æ•°ç›®ã€‚\n2ã€Zookeeper è§’è‰²çš„ç†è§£ Zookeeper å¹¶æ²¡æœ‰æ²¿ç”¨ Master/Slave æ¦‚å¿µï¼Œè€Œæ˜¯å¼•å…¥äº† Leaderï¼ŒFollowerï¼ŒObserver ä¸‰ç§è§’è‰²ã€‚\né€šè¿‡ Leader é€‰ä¸¾ç®—æ³•æ¥é€‰å®šä¸€å°æœåŠ¡å™¨å……å½“ Leader èŠ‚ç‚¹ï¼ŒLeader æœåŠ¡å™¨ä¸ºå®¢æˆ·ç«¯æä¾›è¯»ã€å†™æœåŠ¡ã€‚\nFollower èŠ‚ç‚¹å¯ä»¥å‚åŠ é€‰ä¸¾ï¼Œä¹Ÿå¯ä»¥æ¥å—å®¢æˆ·ç«¯çš„è¯»è¯·æ±‚ï¼Œä½†æ˜¯æ¥å—åˆ°å®¢æˆ·ç«¯çš„å†™è¯·æ±‚æ—¶ï¼Œä¼šè½¬å‘åˆ° Leader æœåŠ¡å™¨å»å¤„ç†ã€‚\nObserver è§’è‰²åªèƒ½æä¾›è¯»æœåŠ¡ï¼Œä¸èƒ½é€‰ä¸¾å’Œè¢«é€‰ä¸¾ï¼Œæ‰€ä»¥å®ƒå­˜åœ¨çš„æ„ä¹‰æ˜¯åœ¨ä¸å½±å“å†™æ€§èƒ½çš„å‰æä¸‹ï¼Œæå‡é›†ç¾¤çš„è¯»æ€§èƒ½ã€‚\n3ã€Zookeeper åŒæ—¶æ»¡è¶³äº† CAP å—ï¼Ÿ ç­”æ¡ˆæ˜¯å¦ï¼ŒCAP åªèƒ½åŒæ—¶æ»¡è¶³å…¶äºŒã€‚\nZookeeper æ˜¯æœ‰å–èˆçš„ï¼Œå®ƒå®ç°äº† A å¯ç”¨æ€§ã€P åˆ†åŒºå®¹é”™æ€§ã€C çš„å†™å…¥ä¸€è‡´æ€§ï¼Œç‰ºç‰²çš„æ˜¯ Cçš„è¯»ä¸€è‡´æ€§ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼ŒZookeeper å¹¶ä¸ä¿è¯è¯»å–çš„ä¸€å®šæ˜¯æœ€æ–°çš„æ•°æ®ã€‚å¦‚æœä¸€å®šè¦æœ€æ–°ï¼Œéœ€è¦ä½¿ç”¨ sync å›è°ƒå¤„ç†ã€‚\nâš ï¸âš ï¸âš ï¸\n å¤§éƒ¨åˆ†æ–‡ç« æŒ‡å‡ºZookeeperä¿è¯çš„æ˜¯CPï¼Œç‰ºç‰²æ‰å¯ç”¨æ€§ï¼š\nä¸èƒ½ä¿è¯æ¯æ¬¡æœåŠ¡è¯·æ±‚çš„å¯ç”¨æ€§ã€‚ä»»ä½•æ—¶åˆ»å¯¹ZooKeeperçš„è®¿é—®è¯·æ±‚èƒ½å¾—åˆ°ä¸€è‡´çš„æ•°æ®ç»“æœï¼ŒåŒæ—¶ç³»ç»Ÿå¯¹ç½‘ç»œåˆ†å‰²å…·å¤‡å®¹é”™æ€§ï¼›ä½†æ˜¯å®ƒä¸èƒ½ä¿è¯æ¯æ¬¡æœåŠ¡è¯·æ±‚çš„å¯ç”¨æ€§ï¼ˆæ³¨ï¼šä¹Ÿå°±æ˜¯åœ¨æç«¯ç¯å¢ƒä¸‹ï¼ŒZooKeeperå¯èƒ½ä¼šä¸¢å¼ƒä¸€äº›è¯·æ±‚ï¼Œæ¶ˆè´¹è€…ç¨‹åºéœ€è¦é‡æ–°è¯·æ±‚æ‰èƒ½è·å¾—ç»“æœï¼‰ã€‚æ‰€ä»¥è¯´ï¼ŒZooKeeperä¸èƒ½ä¿è¯æœåŠ¡å¯ç”¨æ€§ã€‚\nè¿›è¡Œleaderé€‰ä¸¾æ—¶é›†ç¾¤éƒ½æ˜¯ä¸å¯ç”¨ã€‚åœ¨ä½¿ç”¨ZooKeeperè·å–æœåŠ¡åˆ—è¡¨æ—¶ï¼Œå½“masterèŠ‚ç‚¹å› ä¸ºç½‘ç»œæ•…éšœä¸å…¶ä»–èŠ‚ç‚¹å¤±å»è”ç³»æ—¶ï¼Œå‰©ä½™èŠ‚ç‚¹ä¼šé‡æ–°è¿›è¡Œleaderé€‰ä¸¾ã€‚é—®é¢˜åœ¨äºï¼Œé€‰ä¸¾leaderçš„æ—¶é—´å¤ªé•¿ï¼Œ30 ~ 120s, ä¸”é€‰ä¸¾æœŸé—´æ•´ä¸ªzké›†ç¾¤éƒ½æ˜¯ä¸å¯ç”¨çš„ï¼Œè¿™å°±å¯¼è‡´åœ¨é€‰ä¸¾æœŸé—´æ³¨å†ŒæœåŠ¡ç˜«ç—ªï¼Œè™½ç„¶æœåŠ¡èƒ½å¤Ÿæœ€ç»ˆæ¢å¤ï¼Œä½†æ˜¯æ¼«é•¿çš„é€‰ä¸¾æ—¶é—´å¯¼è‡´çš„æ³¨å†Œé•¿æœŸä¸å¯ç”¨æ˜¯ä¸èƒ½å®¹å¿çš„ã€‚æ‰€ä»¥è¯´ï¼ŒZooKeeperä¸èƒ½ä¿è¯æœåŠ¡å¯ç”¨æ€§ã€‚\nZooKeeperå’ŒCAPç†è®ºåŠä¸€è‡´æ€§åŸåˆ™\ræœåŠ¡æ³¨å†Œä¸å‘ç°çš„å®ç°åŸç†ã€åŠå®ç°ä¼˜åŠ£åŠ¿æ¯”è¾ƒ\r ä¸‰ã€æ ¸å¿ƒæœºåˆ¶ä¸€ï¼šZNode æ•°æ®æ¨¡å‹ Zookeeper çš„ ZNode æ¨¡å‹å…¶å®å¯ä»¥ç†è§£ä¸ºç±»æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚ä¸‹å›¾ï¼š\n1ã€ZNode å¹¶ä¸é€‚åˆå­˜å‚¨å¤ªå¤§çš„æ•°æ® ä¸ºä»€ä¹ˆæ˜¯ç±»æ–‡ä»¶ç³»ç»Ÿå‘¢ï¼Ÿå› ä¸º ZNode æ¨¡å‹æ²¡æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„æ¦‚å¿µï¼Œæ¯ä¸ªèŠ‚ç‚¹æ—¢å¯ä»¥æœ‰å­èŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨æ•°æ®ã€‚\né‚£ä¹ˆæ—¢ç„¶æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨æ•°æ®ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ä»»æ„å­˜å‚¨æ— é™åˆ¶çš„æ•°æ®å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚åœ¨ Zookeeper ä¸­ï¼Œé™åˆ¶äº†æ¯ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨å°äº 1 M çš„æ•°æ®ï¼Œå®é™…åº”ç”¨ä¸­ï¼Œæœ€å¥½ä¸è¦è¶…è¿‡ 1kbã€‚\nåŸå› æœ‰ä»¥ä¸‹å››ç‚¹ï¼š\n åŒæ­¥å‹åŠ›ï¼šZookeeper çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨äº† Zookeeper çš„æ‰€æœ‰æ•°æ®ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€éƒ½è¦ä¿æŒå’Œ Leader ä¸€è‡´ï¼ŒåŒæ­¥è¿‡ç¨‹è‡³å°‘è¦ä¿è¯åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹åŒæ­¥æˆåŠŸï¼Œæ‰ç®—æœ€ç»ˆæˆåŠŸã€‚å¦‚æœæ•°æ®è¶Šå¤§ï¼Œåˆ™å†™å…¥çš„éš¾åº¦ä¹Ÿè¶Šå¤§ã€‚ è¯·æ±‚é˜»å¡ï¼šZookeeper ä¸ºäº†ä¿è¯å†™å…¥çš„å¼ºä¸€è‡´æ€§ï¼Œä¼šä¸¥æ ¼æŒ‰ç…§å†™å…¥çš„é¡ºåºä¸²è¡Œæ‰§è¡Œï¼ŒæŸä¸ªæ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ã€‚å¦‚æœä¸Šä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè€—æ—¶æ¯”è¾ƒé•¿ï¼Œä¼šé˜»å¡åé¢çš„è¯·æ±‚ï¼› å­˜å‚¨å‹åŠ›ï¼šæ­£æ˜¯å› ä¸ºæ¯ä¸ª Zookeeper çš„èŠ‚ç‚¹éƒ½å­˜å‚¨äº†å®Œæ•´çš„æ•°æ®ï¼Œæ¯ä¸ª ZNode å­˜å‚¨çš„æ•°æ®è¶Šå¤§ï¼Œåˆ™æ¶ˆè€—çš„ç‰©ç†å†…å­˜ä¹Ÿè¶Šå¤§ï¼› è®¾è®¡åˆè¡·ï¼šZookeeper çš„è®¾è®¡åˆè¡·ï¼Œä¸æ˜¯ä¸ºäº†æä¾›å¤§è§„æ¨¡çš„å­˜å‚¨æœåŠ¡ï¼Œè€Œæ˜¯æä¾›äº†è¿™æ ·çš„æ•°æ®æ¨¡å‹è§£å†³ä¸€äº›åˆ†å¸ƒå¼é—®é¢˜ã€‚   é™¤éé›†ç¾¤æ˜¯ä»¥ZNodeä¸ºå•ä½è¿›è¡ŒåŒæ­¥çš„ï¼Œå¦åˆ™ä»¥ä¸Šå››ç‚¹ä¸èƒ½ç®—ä½œé™å®šZNodeå¤§å°çš„åŸå› \n 2ã€ZNode çš„åˆ†ç±» ï¼ˆ1ï¼‰æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†ç±»\næŒ‰ç…§å£°æ˜å‘¨æœŸï¼ŒZNode å¯åˆ†ä¸ºæ°¸ä¹…èŠ‚ç‚¹å’Œä¸´æ—¶èŠ‚ç‚¹ã€‚\nå¾ˆå¥½ç†è§£ï¼Œæ°¸ä¹…èŠ‚ç‚¹å°±æ˜¯è¦æ˜¾ç¤ºçš„åˆ é™¤ï¼Œå¦åˆ™ä¼šä¸€ç›´å­˜åœ¨ï¼›ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ˜¯å’Œä¼šè¯ç»‘å®šçš„ï¼Œä¼šè¯åˆ›å»ºçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¼šåœ¨ä¼šè¯æ–­å¼€è¿æ¥æ—¶ï¼Œå…¨éƒ¨è¢« Zookeeper ç³»ç»Ÿåˆ é™¤ã€‚\nï¼ˆ2ï¼‰æŒ‰ç…§æ˜¯å¦å¸¦åºåˆ—å·åˆ†ç±»\nå¸¦åºåˆ—å·çš„è¯ï¼Œæ¯”å¦‚åœ¨ä»£ç ä¸­åˆ›å»º /a èŠ‚ç‚¹ï¼Œåˆ›å»ºä¹‹åå…¶å®æ˜¯ /a000000000000001ï¼Œå†åˆ›å»ºçš„è¯ï¼Œå°±æ˜¯ /a000000000000002ï¼Œä¾æ¬¡é€’å¢\nä¸å¸¦åºå·ï¼Œå°±æ˜¯åˆ›å»ºä»€ä¹ˆå°±æ˜¯ä»€ä¹ˆ\nï¼ˆ3ï¼‰æ‰€ä»¥ï¼Œä¸€å…±æœ‰å››ç§ ZNode\n æ°¸ä¹…çš„ä¸å¸¦åºå·çš„ æ°¸ä¹…çš„å¸¦åºå·çš„ ä¸´æ—¶çš„ä¸å¸¦åºå·çš„ ä¸´æ—¶çš„å¸¦åºå·çš„  ï¼ˆ4ï¼‰æ³¨æ„çš„ç‚¹\nä¸´æ—¶èŠ‚ç‚¹ä¸‹é¢ä¸èƒ½æŒ‚è½½å­èŠ‚ç‚¹ï¼Œåªèƒ½ä½œä¸ºå…¶ä»–èŠ‚ç‚¹çš„å¶å­èŠ‚ç‚¹ã€‚\n3ã€ä»£ç å®æˆ˜ ZNode çš„æ•°æ®æ¨¡å‹å…¶å®å¾ˆç®€å•ï¼Œåªæœ‰è¿™ä¹ˆå¤šçŸ¥è¯†ã€‚ä¸‹é¢ç”¨ä»£ç æ¥å·©å›ºä¸€ä¸‹ã€‚\nè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ curator æ¡†æ¶æ¥åš demoã€‚ï¼ˆå½“ç„¶ï¼Œä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨ Zookeeper å®˜æ–¹è‡ªå¸¦çš„ Apiï¼‰\nå¼•å…¥ pom åæ ‡ï¼š\n\u0026lt;!-- curator-framework --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.curator\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;curator-framework\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- curator-recipes --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.curator\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;curator-recipes\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ä»£ç ï¼š\npublic class ZkTest { // ä¼šè¯è¶…æ—¶  private final int SESSION_TIMEOUT = 30 * 1000; // è¿æ¥è¶…æ—¶ ã€ æœ‰å•¥åŒºåˆ«  private static final int CONNECTION_TIMEOUT = 3 * 1000; private static final String CONNECT_ADDR = \u0026#34;localhost:2181\u0026#34;; private CuratorFramework client = null; public static void main(String[] args) throws Exception { // åˆ›å»ºå®¢æˆ·ç«¯  RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 10); CuratorFramework client = CuratorFrameworkFactory.builder() .connectString(CONNECT_ADDR) .connectionTimeoutMs(CONNECTION_TIMEOUT) .retryPolicy(retryPolicy) .build(); client.start(); System.out.println(ZooKeeper.States.CONNECTED); System.out.println(client.getState()); // åˆ›å»ºèŠ‚ç‚¹ /test1  client.create() .forPath(\u0026#34;/test1\u0026#34;, \u0026#34;curator data\u0026#34;.getBytes(StandardCharsets.UTF_8)); System.out.println(client.getChildren().forPath(\u0026#34;/\u0026#34;)); // ä¸´æ—¶èŠ‚ç‚¹  client.create().withMode(CreateMode.EPHEMERAL) .forPath(\u0026#34;/secondPath\u0026#34;, \u0026#34;hello world\u0026#34;.getBytes(StandardCharsets.UTF_8)); System.out.println(new String(client.getData().forPath(\u0026#34;/secondPath\u0026#34;))); client.create().withMode(CreateMode.PERSISTENT_SEQUENTIAL) .forPath(\u0026#34;/abc\u0026#34;, \u0026#34;hello\u0026#34;.getBytes(StandardCharsets.UTF_8)); // é€’å½’åˆ›å»º  client.create() .creatingParentContainersIfNeeded() .forPath(\u0026#34;/secondPath1/sencond2/sencond3\u0026#34;); Thread.sleep(10000); } å››ã€æ ¸å¿ƒæœºåˆ¶äºŒï¼šWatcher ç›‘å¬æœºåˆ¶ Watcher ç›‘å¬æœºåˆ¶æ˜¯ Zookeeper è§£å†³å„ç§åˆ†å¸ƒå¼ä¸ä¸€è‡´ç–‘éš¾æ‚ç—‡çš„ç‹¬å®¶æ³•é—¨ï¼Œä¹Ÿæ˜¯å­¦ä¹  Zookeeper å¿…å­¦çš„çŸ¥è¯†ç‚¹ã€‚\n1ã€å¯¹äº Watcher æœºåˆ¶çš„ç†è§£ Zookeeper æä¾›äº†æ•°æ®çš„å‘å¸ƒä¸è®¢é˜…çš„åŠŸèƒ½ï¼Œå¤šä¸ªè®¢é˜…è€…å¯ä»¥åŒæ—¶ç›‘å¬æŸä¸€ä¸ªå¯¹è±¡ï¼Œå½“è¿™ä¸ªå¯¹è±¡è‡ªèº«çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¾‹å¦‚èŠ‚ç‚¹æ•°æ®æˆ–è€…èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°å˜åŒ–ï¼‰ï¼ŒZookeeper ç³»ç»Ÿä¼šé€šçŸ¥è¿™äº›è®¢é˜…è€…ã€‚\nå¯¹äºå‘å¸ƒå’Œè®¢é˜…è¿™ä¸ªæ¦‚å¿µçš„ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªåœºæ™¯æ¥ç†è§£ï¼š\næ¯”å¦‚å‰ä¸¤å¤©çš„å°é£ï¼Œè€æ¿æƒ³å‘ä¸€ä¸ªé€šçŸ¥ç»™å‘˜å·¥ï¼šæ˜å¤©åœ¨å®¶åŠå…¬ã€‚\näºæ˜¯è€æ¿ä¼šåœ¨é’‰é’‰ç¾¤ä¸Š Ding ä¸€ä¸ªæ¶ˆæ¯ï¼Œå‘˜å·¥è‡ªå·±æ‰“å¼€é’‰é’‰æŸ¥çœ‹ã€‚\nåœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œè€æ¿æ˜¯å‘å¸ƒè€…ï¼Œå‘˜å·¥æ˜¯è®¢é˜…è€…ï¼Œé’‰é’‰ç¾¤å°±æ˜¯ Zookeeper ç³»ç»Ÿã€‚\nè€æ¿å¹¶ä¸ä¸€ä¸€ç»™å‘˜å·¥å‘æ¶ˆæ¯ï¼Œè€Œæ˜¯æŠŠæ¶ˆæ¯å‘åˆ°ç¾¤é‡Œï¼Œå‘˜å·¥å°±å¯ä»¥æ„ŸçŸ¥åˆ°æ¶ˆæ¯çš„å˜åŒ–ã€‚\n   è®¢é˜…è€… å‘˜å·¥ å®¢æˆ·ç«¯1     ç³»ç»Ÿ é’‰é’‰ç¾¤ Zookeeperç³»ç»Ÿ   å‘å¸ƒè€… è€æ¿ å®¢æˆ·ç«¯2    2ã€ Watcher æœºåˆ¶çš„æµç¨‹ å®¢æˆ·ç«¯é¦–å…ˆå°† Watcher æ³¨å†Œåˆ°æœåŠ¡å™¨ä¸Šï¼ŒåŒæ—¶å°† Watcher å¯¹è±¡ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ Watcher ç®¡ç†å™¨ä¸­ã€‚å½“ Zookeeper æœåŠ¡ç«¯ç›‘å¬åˆ°æ•°æ®çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šé¦–å…ˆä¸»åŠ¨é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ¥ç€å®¢æˆ·ç«¯çš„ Watcher ç®¡ç†å™¨ä¼šè§¦å‘ç›¸å…³çš„ Watcher æ¥å›è°ƒå“åº”çš„é€»è¾‘ï¼Œä»è€Œå®Œæˆæ•´ä½“çš„å‘å¸ƒ/è®¢é˜…æµç¨‹ã€‚\nç›‘å¬å™¨ Watcher çš„å®šä¹‰ï¼š\npublic interface Watcher { // WatchedEvent å¯¹è±¡ä¸­æœ‰ä¸‹é¢ä¸‰ä¸ªå±æ€§ï¼ŒZookeeperçŠ¶æ€ï¼Œäº‹ä»¶ç±»å‹ï¼Œè·¯å¾„ // final private KeeperState keeperState; // final private EventType eventType; // private String path;  abstract public void process(WatchedEvent event); } ä¸‹é¢æ˜¯ç›‘å¬çš„å¤§è‡´æµç¨‹å›¾ï¼š\nç¨ç¨è§£é‡Šä¸€ä¸‹ï¼š\n1ã€Client1 å’Œ Client2 éƒ½å…³å¿ƒ /app2 èŠ‚ç‚¹çš„æ•°æ®çŠ¶æ€å˜åŒ–ï¼Œäºæ˜¯æ³¨å†Œä¸€ä¸ªå¯¹äº /app2 çš„ç›‘å¬å™¨åˆ° Zookeeper ä¸Šï¼› 2ã€å½“ Client3 ä¿®æ”¹ /app2 çš„å€¼åï¼ŒZookeeper ä¼šä¸»åŠ¨é€šçŸ¥ Client1 å’Œ Client2 ï¼Œå¹¶ä¸”å›è°ƒç›‘å¬å™¨çš„æ–¹æ³• å½“ç„¶è¿™é‡Œçš„æ•°æ®çŠ¶æ€å˜åŒ–æœ‰ä¸‹é¢è¿™äº›ç±»å‹ï¼š\n èŠ‚ç‚¹è¢«åˆ›å»ºï¼› èŠ‚ç‚¹è¢«åˆ é™¤ï¼› èŠ‚ç‚¹æ•°æ®å‘ç”Ÿæ”¹å˜ï¼› èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°å‘ç”Ÿæ”¹å˜  3ã€é€šè¿‡ä»£ç æ¥åˆæ­¥ç†è§£ æˆ‘ä»¬è¿˜æ˜¯ç”¨ Curator æ¡†æ¶æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªç›‘å¬å™¨\nä»£ç å¾ˆç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ TreeCache è¡¨ç¤ºå¯¹äº /app2 çš„ç›‘å¬ï¼Œå¹¶ä¸”æ³¨å†Œäº†ç›‘å¬çš„æ–¹æ³•\npublic class CuratorWatcher { public static void main(String[] args) throws Exception { CuratorFramework client = CuratorFrameworkFactory.builder().connectString(\u0026#34;localhost:2181\u0026#34;) .connectionTimeoutMs(10000) .retryPolicy(new ExponentialBackoffRetry(1000, 10)) .build(); client.start(); String path = \u0026#34;/app2\u0026#34;; TreeCache treeCache = new TreeCache(client, path); treeCache.start(); treeCache.getListenable().addListener((client1, event) -\u0026gt; { System.out.println(\u0026#34;event.getData()ï¼Œ\u0026#34; + event.getData()); System.out.println(\u0026#34;event.getType()ï¼Œ\u0026#34; + event.getType()); }); Thread.sleep(Integer.MAX_VALUE); } } å½“ /app2 çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šè°ƒç”¨ç›‘å¬çš„æ–¹æ³•ã€‚\nCurator æ˜¯å¯¹åŸç”Ÿçš„ Zookeeper Api æœ‰å°è£…çš„ï¼ŒåŸç”Ÿçš„ Zookeeper æä¾›çš„ Api ï¼Œæ³¨å†Œç›‘å¬åï¼Œå½“æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œç›‘å¬å°±è¢«æœåŠ¡ç«¯åˆ é™¤äº†ï¼Œè¦é‡å¤æ³¨å†Œç›‘å¬ã€‚\nCurator åˆ™å¯¹è¿™ä¸ªåšäº†ç›¸åº”çš„å°è£…å’Œæ”¹è¿›ã€‚\näº”ã€ä»£ç å®æˆ˜ï¼šå®ç°ä¸»å¤‡é€‰ä¸¾ è¿™é‡Œæˆ‘ä»¬ä¸»è¦æƒ³å®ç°çš„åŠŸèƒ½æ˜¯ï¼š\n æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œbigdata001ï¼Œbigdata002 ï¼Œä»–ä»¬äº’ç›¸ä¸»å¤‡ã€‚ bigdata001 å¯åŠ¨æ—¶ï¼Œå¾€ zk ä¸Šæ³¨å†Œä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ /ElectorLockï¼ˆé”ï¼‰ï¼Œå¹¶ä¸”å¾€ /ActiveMaster ä¸‹é¢æ³¨å†Œä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºè‡ªå·±æ˜¯ä¸»èŠ‚ç‚¹ï¼› bigdata002 å¯åŠ¨æ—¶ï¼Œå‘ç°ä¸´æ—¶èŠ‚ç‚¹ /ElectorLock å­˜åœ¨ï¼Œè¡¨ç¤ºå½“å‰ç³»ç»Ÿå·²ç»æœ‰ä¸»èŠ‚ç‚¹äº†ï¼Œåˆ™è‡ªå·±å¾€ /StandbyMaster ä¸‹æ³¨å†Œä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºè‡ªå·±æ˜¯ standbyã€‚ bigdata001 é€€å‡ºæ—¶ï¼Œé‡Šæ”¾ /ElectorLockï¼Œå¹¶ä¸”åˆ é™¤ /activeMaster ä¸‹çš„èŠ‚ç‚¹ã€‚ bigdata002 æ„ŸçŸ¥åˆ° /ElectorLock ä¸å­˜åœ¨æ—¶ï¼Œåˆ™è‡ªå·±å»æ³¨å†Œ /ElectorLockï¼Œå¹¶åœ¨ /ActiveMaster ä¸‹æ³¨å†Œè‡ªå·±ï¼Œè¡¨ç¤ºè‡ªå·±å·²ç»æˆä¸ºäº†ä¸»èŠ‚ç‚¹ã€‚  ä»£ç è¿˜æ˜¯ç”¨ Curator æ¡†æ¶å®ç°çš„ï¼š\npackage com.kkarch.zookeeper; import cn.hutool.core.util.StrUtil; import lombok.extern.slf4j.Slf4j; import org.apache.curator.framework.CuratorFramework; import org.apache.curator.framework.recipes.cache.TreeCache; import org.apache.curator.framework.recipes.cache.TreeCacheEvent; import org.apache.zookeeper.CreateMode; import java.nio.charset.StandardCharsets; /** * åˆ†å¸ƒå¼é€‰ä¸¾ * * @Author wangkai * @Time 2021/7/25 20:12 */ @Slf4j public class ElectorTest { private static final String PARENT = \u0026#34;/cluster_ha\u0026#34;; private static final String ACTIVE = PARENT + \u0026#34;/ActiveMaster\u0026#34;; private static final String STANDBY = PARENT + \u0026#34;/StandbyMaster\u0026#34;; private static final String LOCK = PARENT + \u0026#34;/ElectorLock\u0026#34;; private static final String HOSTNAME = \u0026#34;bigdata05\u0026#34;; private static final String activeMasterPath = ACTIVE + \u0026#34;/\u0026#34; + HOSTNAME; private static final String standByMasterPath = STANDBY + \u0026#34;/\u0026#34; + HOSTNAME; public static void main(String[] args) throws Exception { CuratorFramework zk = ZkUtil.createZkClient(\u0026#34;localhost:2181\u0026#34;); zk.start(); // æ³¨å†Œå¥½ç›‘å¬  TreeCache treeCache = new TreeCache(zk, PARENT); treeCache.start(); treeCache.getListenable().addListener((client, event) -\u0026gt; { if (event.getType().equals(TreeCacheEvent.Type.INITIALIZED) || event.getType().equals(TreeCacheEvent.Type.CONNECTION_LOST) || event.getType().equals(TreeCacheEvent.Type.CONNECTION_RECONNECTED) || event.getType().equals(TreeCacheEvent.Type.CONNECTION_SUSPENDED)) { return; } System.out.println(event.getData()); // å¦‚æœ Active ä¸‹æœ‰èŠ‚ç‚¹è¢«ç§»é™¤äº†ï¼Œæ²¡æœ‰èŠ‚ç‚¹ï¼Œåˆ™åº”è¯¥å»ç«é€‰æˆä¸º Active  if (StrUtil.startWith(event.getData().getPath(), ACTIVE) \u0026amp;\u0026amp; event.getType().equals(TreeCacheEvent.Type.NODE_REMOVED)) { if (getChildrenNumber(zk, ACTIVE) == 0) { createZNode(client, LOCK, HOSTNAME.getBytes(StandardCharsets.UTF_8), CreateMode.EPHEMERAL); System.out.println(HOSTNAME + \u0026#34;äº‰æŠ¢åˆ°äº†é”\u0026#34;); } } // å¦‚æœæœ‰é”èŠ‚ç‚¹è¢«åˆ›å»ºï¼Œåˆ™åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±åˆ›å»ºçš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åˆ‡æ¢è‡ªå·±çš„çŠ¶æ€ä¸º ACTIVE  else if (StrUtil.equals(event.getData().getPath(), LOCK) \u0026amp;\u0026amp; event.getType().equals(TreeCacheEvent.Type.NODE_ADDED)) { if (StrUtil.equals(new String(event.getData().getData()), HOSTNAME)) { createZNode(zk, activeMasterPath, HOSTNAME.getBytes(StandardCharsets.UTF_8), CreateMode.EPHEMERAL); if (checkExists(client, standByMasterPath)) { deleteZNode(client, standByMasterPath); } } } }); // å…ˆåˆ›å»º ACTIVE å’Œ STANDBY èŠ‚ç‚¹  if (zk.checkExists().forPath(ACTIVE) == null) { zk.create().creatingParentContainersIfNeeded().forPath(ACTIVE); } if (zk.checkExists().forPath(STANDBY) == null) { zk.create().creatingParentContainersIfNeeded().forPath(STANDBY); } // åˆ¤æ–­ ACTIVE ä¸‹æ˜¯å¦æœ‰å­èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™å»äº‰æŠ¢ä¸€æŠŠé”  if (getChildrenNumber(zk, ACTIVE) == 0) { createZNode(zk, LOCK, HOSTNAME.getBytes(StandardCharsets.UTF_8), CreateMode.EPHEMERAL); } // å¦‚æœæœ‰ï¼Œåˆ™è‡ªå·±æˆä¸º STANDBY çŠ¶æ€  else { createZNode(zk, standByMasterPath, HOSTNAME.getBytes(StandardCharsets.UTF_8), CreateMode.EPHEMERAL); } Thread.sleep(1000000000); } public static int getChildrenNumber(CuratorFramework client, String path) throws Exception { return client.getChildren().forPath(path).size(); } public static void createZNode(CuratorFramework client, String path, byte[] data, CreateMode mode) { try { client.create().withMode(mode).forPath(path, data); } catch (Exception e) { log.error(\u0026#34;åˆ›å»ºèŠ‚ç‚¹å¤±è´¥\u0026#34;, e); System.out.println(\u0026#34;åˆ›å»ºèŠ‚ç‚¹å¤±è´¥äº†\u0026#34;); } } public static boolean checkExists(CuratorFramework client, String path) throws Exception { return client.checkExists().forPath(path) != null; } public static void deleteZNode(CuratorFramework client, String path) { try { if (checkExists(client, path)) { client.delete().forPath(path); } } catch (Exception e) { log.error(\u0026#34;åˆ é™¤èŠ‚ç‚¹å¤±è´¥\u0026#34;, e); } } } å‚è€ƒ åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ Zookeeper æ ¸å¿ƒè®¾è®¡ ç†è§£ä¸å®æˆ˜ï¼Œå¹¶å®ç°ä¸€ä¸ªä¸»å¤‡åˆ‡æ¢\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/zookeeper/zookeeper%E6%A0%B8%E5%BF%83%E8%AE%BE%E8%AE%A1%E7%90%86%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98/","series":["Manual"],"tags":["ZK"],"title":"Zookeeperæ ¸å¿ƒè®¾è®¡ç†è§£ä¸å®æˆ˜"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ZooKeeperçš„statç»“æ„ ZooKeeperå‘½åç©ºé—´ä¸­çš„æ¯ä¸ªznodeéƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„statç»“æ„ï¼Œç±»ä¼¼äºUnix/Linuxæ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„statç»“æ„ã€‚ znodeçš„statç»“æ„ä¸­çš„å­—æ®µæ˜¾ç¤ºå¦‚ä¸‹ï¼Œå„è‡ªçš„å«ä¹‰å¦‚ä¸‹ï¼š\n cZxidï¼šè¿™æ˜¯å¯¼è‡´åˆ›å»ºznodeæ›´æ”¹çš„äº‹åŠ¡IDã€‚ mZxidï¼šè¿™æ˜¯æœ€åä¿®æ”¹znodeæ›´æ”¹çš„äº‹åŠ¡IDã€‚ pZxidï¼šè¿™æ˜¯ç”¨äºæ·»åŠ æˆ–åˆ é™¤å­èŠ‚ç‚¹çš„znodeæ›´æ”¹çš„äº‹åŠ¡IDã€‚ ctimeï¼šè¡¨ç¤ºä»1970-01-01T00:00:00Zå¼€å§‹ä»¥æ¯«ç§’ä¸ºå•ä½çš„znodeåˆ›å»ºæ—¶é—´ã€‚ mtimeï¼šè¡¨ç¤ºä»1970-01-01T00:00:00Zå¼€å§‹ä»¥æ¯«ç§’ä¸ºå•ä½çš„znodeæœ€è¿‘ä¿®æ”¹æ—¶é—´ã€‚ dataVersionï¼šè¡¨ç¤ºå¯¹è¯¥znodeçš„æ•°æ®æ‰€åšçš„æ›´æ”¹æ¬¡æ•°ã€‚ cversionï¼šè¿™è¡¨ç¤ºå¯¹æ­¤znodeçš„å­èŠ‚ç‚¹è¿›è¡Œçš„æ›´æ”¹æ¬¡æ•°ã€‚ aclVersionï¼šè¡¨ç¤ºå¯¹æ­¤znodeçš„ACLè¿›è¡Œæ›´æ”¹çš„æ¬¡æ•°ã€‚ ephemeralOwnerï¼šå¦‚æœznodeæ˜¯ephemeralç±»å‹èŠ‚ç‚¹ï¼Œåˆ™è¿™æ˜¯znodeæ‰€æœ‰è€…çš„ session IDã€‚ å¦‚æœznodeä¸æ˜¯ephemeralèŠ‚ç‚¹ï¼Œåˆ™è¯¥å­—æ®µè®¾ç½®ä¸ºé›¶ã€‚ dataLengthï¼šè¿™æ˜¯znodeæ•°æ®å­—æ®µçš„é•¿åº¦ã€‚ numChildrenï¼šè¿™è¡¨ç¤ºznodeçš„å­èŠ‚ç‚¹çš„æ•°é‡ã€‚  åœ¨ZooKeeper Java shellä¸­ï¼Œå¯ä»¥ä½¿ç”¨statæˆ–ls2å‘½ä»¤æŸ¥çœ‹znodeçš„statç»“æ„ã€‚ å…·ä½“è¯´æ˜å¦‚ä¸‹ï¼š\nä½¿ç”¨statå‘½ä»¤æŸ¥çœ‹znodeçš„statç»“æ„ï¼š\n[zk: localhost(CONNECTED) 0] stat /zookeeper cZxid = 0x0 ctime = Thu Jan 01 05:30:00 IST 1970 mZxid = 0x0 mtime = Thu Jan 01 05:30:00 IST 1970 pZxid = 0x0 cversion = -1 dataVersion = 0 aclVersion = 0 ephemeralOwner = 0x0 dataLength = 0 numChildren = 1 ä½¿ç”¨ls2å‘½ä»¤æŸ¥çœ‹znodeçš„statç»“æ„ï¼š\n[zk: localhost(CONNECTED) 1] ls2 /zookeeper [quota] cZxid = 0x0 ctime = Thu Jan 01 05:30:00 IST 1970 mZxid = 0x0 mtime = Thu Jan 01 05:30:00 IST 1970 pZxid = 0x0 cversion = -1 dataVersion = 0 aclVersion = 0 ephemeralOwner = 0x0 dataLength = 0 numChildren = 1 ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/zookeeper/zookeeper%E7%9A%84stat%E7%BB%93%E6%9E%84/","series":["Manual"],"tags":["ZK"],"title":"ZooKeeperçš„statç»“æ„"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ZooKeeperèƒ½åšä»€ä¹ˆï¼Ÿ ä»€ä¹ˆæ˜¯ZooKeeper?å®˜ç½‘\rä»‹ç»åˆ°ï¼šZooKeeper is a centralized service for maintaining configuration information, naming, providing distributed synchronization, and providing group services. è¿™å¤§æ¦‚æè¿°äº†Zookeeperä¸»è¦å¯ä»¥å¹²å“ªäº›äº‹æƒ…ï¼šé…ç½®ç®¡ç†ï¼Œåå­—æœåŠ¡ï¼Œæä¾›åˆ†å¸ƒå¼åŒæ­¥ä»¥åŠé›†ç¾¤ç®¡ç†ã€‚\n1. é…ç½®ç®¡ç† é…ç½®ç®¡ç†åˆè¢«ç§°ä¸ºå‘å¸ƒ-è®¢é˜…ã€‚\nåœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­é™¤äº†ä»£ç å¤–ï¼Œè¿˜æœ‰ä¸€äº›å°±æ˜¯å„ç§é…ç½®ã€‚æ¯”å¦‚æ•°æ®åº“è¿æ¥ç­‰ã€‚ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œåœ¨ä»£ç ä¸­å¼•å…¥è¿™äº›é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯å½“æˆ‘ä»¬åªæœ‰ä¸€ç§é…ç½®ï¼Œåªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä¸ç»å¸¸ä¿®æ”¹çš„æ—¶å€™ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åšæ³•ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬é…ç½®éå¸¸å¤šï¼Œæœ‰å¾ˆå¤šæœåŠ¡å™¨éƒ½éœ€è¦è¿™ä¸ªé…ç½®ï¼Œè€Œä¸”è¿˜å¯èƒ½æ˜¯åŠ¨æ€çš„è¯ä½¿ç”¨é…ç½®æ–‡ä»¶å°±ä¸æ˜¯ä¸ªå¥½ä¸»æ„äº†ã€‚è¿™ä¸ªæ—¶å€™å¾€å¾€éœ€è¦å¯»æ‰¾ä¸€ç§é›†ä¸­ç®¡ç†é…ç½®çš„æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªé›†ä¸­çš„åœ°æ–¹ä¿®æ”¹äº†é…ç½®ï¼Œæ‰€æœ‰å¯¹è¿™ä¸ªé…ç½®æ„Ÿå…´è¶£çš„éƒ½å¯ä»¥è·å¾—å˜æ›´ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥æŠŠé…ç½®æ”¾åœ¨æ•°æ®åº“é‡Œï¼Œç„¶åæ‰€æœ‰éœ€è¦é…ç½®çš„æœåŠ¡éƒ½å»è¿™ä¸ªæ•°æ®åº“è¯»å–é…ç½®ã€‚ä½†æ˜¯ï¼Œå› ä¸ºå¾ˆå¤šæœåŠ¡çš„æ­£å¸¸è¿è¡Œéƒ½éå¸¸ä¾èµ–è¿™ä¸ªé…ç½®ï¼Œæ‰€ä»¥éœ€è¦è¿™ä¸ªé›†ä¸­æä¾›é…ç½®æœåŠ¡çš„æœåŠ¡å…·å¤‡å¾ˆé«˜çš„å¯é æ€§ã€‚ä¸€èˆ¬æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªé›†ç¾¤æ¥æä¾›è¿™ä¸ªé…ç½®æœåŠ¡ï¼Œä½†æ˜¯ç”¨é›†ç¾¤æå‡å¯é æ€§ï¼Œé‚£å¦‚ä½•ä¿è¯é…ç½®åœ¨é›†ç¾¤ä¸­çš„ä¸€è‡´æ€§å‘¢ï¼Ÿ è¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨ä¸€ç§å®ç°äº†ä¸€è‡´æ€§åè®®çš„æœåŠ¡äº†ã€‚Zookeeperå°±æ˜¯è¿™ç§æœåŠ¡ï¼Œå®ƒä½¿ç”¨Zabè¿™ç§ä¸€è‡´æ€§åè®®æ¥æä¾›ä¸€è‡´æ€§ã€‚ç°åœ¨æœ‰å¾ˆå¤šå¼€æºé¡¹ç›®ä½¿ç”¨Zookeeperæ¥ç»´æŠ¤é…ç½®ï¼Œæ¯”å¦‚åœ¨HBaseä¸­ï¼Œå®¢æˆ·ç«¯å°±æ˜¯è¿æ¥ä¸€ä¸ªZookeeperï¼Œè·å¾—å¿…è¦çš„HBaseé›†ç¾¤çš„é…ç½®ä¿¡æ¯ï¼Œç„¶åæ‰å¯ä»¥è¿›ä¸€æ­¥æ“ä½œã€‚è¿˜æœ‰åœ¨å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—Kafkaä¸­ï¼Œä¹Ÿä½¿ç”¨Zookeeperæ¥ç»´æŠ¤brokerçš„ä¿¡æ¯ã€‚\nåº”ç”¨ä¸­ç”¨åˆ°çš„ä¸€äº›é…ç½®ä¿¡æ¯æ”¾åˆ°ZKä¸Šè¿›è¡Œé›†ä¸­ç®¡ç†ã€‚è¿™ç±»åœºæ™¯é€šå¸¸æ˜¯è¿™æ ·ï¼šåº”ç”¨åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šä¸»åŠ¨æ¥è·å–ä¸€æ¬¡é…ç½®ï¼ŒåŒæ—¶ï¼Œåœ¨èŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€ä¸ªWatcherï¼Œè¿™æ ·ä¸€æ¥ï¼Œä»¥åæ¯æ¬¡é…ç½®æœ‰æ›´æ–°çš„æ—¶å€™ï¼Œéƒ½ä¼šå®æ—¶é€šçŸ¥åˆ°è®¢é˜…çš„å®¢æˆ·ç«¯ï¼Œä»æ¥è¾¾åˆ°è·å–æœ€æ–°é…ç½®ä¿¡æ¯çš„ç›®çš„ã€‚\n2. å‘½åæœåŠ¡ å‘½åæœåŠ¡ä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ¯”è¾ƒå¸¸è§çš„ä¸€ç±»åœºæ™¯ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé€šè¿‡ä½¿ç”¨å‘½åæœåŠ¡ï¼Œå®¢æˆ·ç«¯åº”ç”¨èƒ½å¤Ÿæ ¹æ®æŒ‡å®šåå­—æ¥è·å–èµ„æºæˆ–æœåŠ¡çš„åœ°å€ï¼Œæä¾›è€…ç­‰ä¿¡æ¯ã€‚è¢«å‘½åçš„å®ä½“é€šå¸¸å¯ä»¥æ˜¯é›†ç¾¤ä¸­çš„æœºå™¨ï¼Œæä¾›çš„æœåŠ¡åœ°å€ï¼Œè¿œç¨‹å¯¹è±¡ç­‰ç­‰â€”â€”è¿™äº›æˆ‘ä»¬éƒ½å¯ä»¥ç»Ÿç§°ä»–ä»¬ä¸ºåå­—ï¼ˆNameï¼‰ã€‚å…¶ä¸­è¾ƒä¸ºå¸¸è§çš„å°±æ˜¯ä¸€äº›åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ä¸­çš„æœåŠ¡åœ°å€åˆ—è¡¨ã€‚é€šè¿‡è°ƒç”¨ZKæä¾›çš„åˆ›å»ºèŠ‚ç‚¹çš„APIï¼Œèƒ½å¤Ÿå¾ˆå®¹æ˜“åˆ›å»ºä¸€ä¸ªå…¨å±€å”¯ä¸€çš„pathï¼Œè¿™ä¸ªpathå°±å¯ä»¥ä½œä¸ºä¸€ä¸ªåç§°ã€‚\né˜¿é‡Œå·´å·´é›†å›¢å¼€æºçš„åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶Dubboä¸­ä½¿ç”¨ZooKeeperæ¥ä½œä¸ºå…¶å‘½åæœåŠ¡ï¼Œç»´æŠ¤å…¨å±€çš„æœåŠ¡åœ°å€åˆ—è¡¨ï¼Œç‚¹å‡»è¿™é‡Œ\ræŸ¥çœ‹Dubboå¼€æºé¡¹ç›®ã€‚åœ¨Dubboå®ç°ä¸­ï¼š æœåŠ¡æä¾›è€…åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œå‘ZKä¸Šçš„æŒ‡å®šèŠ‚ç‚¹/dubbo/${serviceName}/providersç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„URLåœ°å€ï¼Œè¿™ä¸ªæ“ä½œå°±å®Œæˆäº†æœåŠ¡çš„å‘å¸ƒã€‚ æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨çš„æ—¶å€™ï¼Œè®¢é˜…/dubbo/${serviceName}/providersç›®å½•ä¸‹çš„æä¾›è€…URLåœ°å€ï¼Œ å¹¶å‘/dubbo/${serviceName} /consumersç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„URLåœ°å€ã€‚ æ³¨æ„ï¼Œæ‰€æœ‰å‘ZKä¸Šæ³¨å†Œçš„åœ°å€éƒ½æ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼Œè¿™æ ·å°±èƒ½å¤Ÿä¿è¯æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…èƒ½å¤Ÿè‡ªåŠ¨æ„Ÿåº”èµ„æºçš„å˜åŒ–ã€‚ å¦å¤–ï¼ŒDubboè¿˜æœ‰é’ˆå¯¹æœåŠ¡ç²’åº¦çš„ç›‘æ§ï¼Œæ–¹æ³•æ˜¯è®¢é˜…/dubbo/${serviceName}ç›®å½•ä¸‹æ‰€æœ‰æä¾›è€…å’Œæ¶ˆè´¹è€…çš„ä¿¡æ¯ã€‚\n3. åˆ†å¸ƒå¼é” åˆ†å¸ƒå¼é”ï¼Œè¿™ä¸ªä¸»è¦å¾—ç›ŠäºZooKeeperä¸ºæˆ‘ä»¬ä¿è¯äº†æ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚é”æœåŠ¡å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯ä¿æŒç‹¬å ï¼ˆæ’ä»–é”ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯æ§åˆ¶æ—¶åºï¼ˆå…±äº«é”/è¯»é”ï¼‰ã€‚\næ‰€è°“ä¿æŒç‹¬å ï¼ˆæ’ä»–é”ï¼‰ï¼Œå°±æ˜¯æ‰€æœ‰è¯•å›¾æ¥è·å–è¿™ä¸ªé”çš„å®¢æˆ·ç«¯ï¼Œæœ€ç»ˆåªæœ‰ä¸€ä¸ªå¯ä»¥æˆåŠŸè·å¾—è¿™æŠŠé”ã€‚é€šå¸¸çš„åšæ³•æ˜¯æŠŠzkä¸Šçš„ä¸€ä¸ªznodeçœ‹ä½œæ˜¯ä¸€æŠŠé”ï¼Œé€šè¿‡create znodeçš„æ–¹å¼æ¥å®ç°ã€‚æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å»åˆ›å»º /distribute_lockèŠ‚ç‚¹ï¼Œæœ€ç»ˆæˆåŠŸåˆ›å»ºçš„é‚£ä¸ªå®¢æˆ·ç«¯ä¹Ÿå³æ‹¥æœ‰äº†è¿™æŠŠé”ã€‚\næ§åˆ¶æ—¶åºï¼ˆå…±äº«é”/è¯»é”ï¼‰æ˜¯æŒ‡æ‰€æœ‰è¯•å›¾æ¥è·å–è¿™ä¸ªé”çš„å®¢æˆ·ç«¯ï¼Œæœ€ç»ˆéƒ½æ˜¯ä¼šè¢«å®‰æ’æ‰§è¡Œï¼Œåªæ˜¯æœ‰ä¸ªå…¨å±€æ—¶åºäº†ã€‚åšæ³•å’Œä¸Šé¢åŸºæœ¬ç±»ä¼¼ï¼Œåªæ˜¯è¿™é‡Œ/distribute_lockå·²ç»é¢„å…ˆå­˜åœ¨ï¼Œå®¢æˆ·ç«¯åœ¨å®ƒä¸‹é¢åˆ›å»ºä¸´æ—¶æœ‰åºèŠ‚ç‚¹ï¼ˆè¿™ä¸ªå¯ä»¥é€šè¿‡èŠ‚ç‚¹çš„å±æ€§æ§åˆ¶ï¼šCreateMode.EPHEMERAL_SEQUENTIALæ¥æŒ‡å®šï¼‰ã€‚Zkçš„çˆ¶èŠ‚ç‚¹ï¼ˆ/distribute_lockï¼‰ç»´æŒä¸€ä»½sequence,ä¿è¯å­èŠ‚ç‚¹åˆ›å»ºçš„æ—¶åºæ€§ï¼Œä»è€Œä¹Ÿå½¢æˆäº†æ¯ä¸ªå®¢æˆ·ç«¯çš„å…¨å±€æ—¶åºã€‚\n4. é›†ç¾¤ç®¡ç† åœ¨åˆ†å¸ƒå¼çš„é›†ç¾¤ä¸­ï¼Œç»å¸¸ä¼šç”±äºå„ç§åŸå› ï¼Œæ¯”å¦‚ç¡¬ä»¶æ•…éšœï¼Œè½¯ä»¶æ•…éšœï¼Œç½‘ç»œé—®é¢˜ï¼Œæœ‰äº›èŠ‚ç‚¹ä¼šè¿›è¿›å‡ºå‡ºã€‚æœ‰æ–°çš„èŠ‚ç‚¹åŠ å…¥è¿›æ¥ï¼Œä¹Ÿæœ‰è€çš„èŠ‚ç‚¹é€€å‡ºé›†ç¾¤ã€‚è¿™ä¸ªæ—¶å€™ï¼Œé›†ç¾¤ä¸­å…¶ä»–æœºå™¨éœ€è¦æ„ŸçŸ¥åˆ°è¿™ç§å˜åŒ–ï¼Œç„¶åæ ¹æ®è¿™ç§å˜åŒ–åšå‡ºå¯¹åº”çš„å†³ç­–ã€‚\n4.1 Masteré€‰ä¸¾ Masteré€‰ä¸¾åˆ™æ˜¯ZooKeeperä¸­æœ€ä¸ºç»å…¸çš„åº”ç”¨åœºæ™¯äº†ã€‚æ¯”å¦‚ HDFS ä¸­ Active NameNode çš„é€‰ä¸¾ã€‚åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œç›¸åŒçš„ä¸šåŠ¡åº”ç”¨åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œæœ‰äº›ä¸šåŠ¡é€»è¾‘ï¼ˆä¾‹å¦‚ä¸€äº›è€—æ—¶çš„è®¡ç®—ï¼Œç½‘ç»œI/Oå¤„ç†ï¼‰ï¼Œå¾€å¾€åªéœ€è¦è®©æ•´ä¸ªé›†ç¾¤ä¸­çš„æŸä¸€å°æœºå™¨è¿›è¡Œæ‰§è¡Œï¼Œå…¶ä½™æœºå™¨å¯ä»¥å…±äº«è¿™ä¸ªç»“æœï¼Œè¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘é‡å¤åŠ³åŠ¨ï¼Œæé«˜æ€§èƒ½ï¼Œäºæ˜¯è¿™ä¸ªmasteré€‰ä¸¾ä¾¿æ˜¯è¿™ç§åœºæ™¯ä¸‹çš„ç¢°åˆ°çš„ä¸»è¦é—®é¢˜ã€‚\nåˆ©ç”¨ZooKeeperçš„å¼ºä¸€è‡´æ€§ï¼Œèƒ½å¤Ÿä¿è¯åœ¨åˆ†å¸ƒå¼é«˜å¹¶å‘æƒ…å†µä¸‹èŠ‚ç‚¹åˆ›å»ºçš„å…¨å±€å”¯ä¸€æ€§ï¼Œå³ï¼šåŒæ—¶æœ‰å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚åˆ›å»º /currentMasterèŠ‚ç‚¹ï¼Œæœ€ç»ˆä¸€å®šåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚èƒ½å¤Ÿåˆ›å»ºæˆåŠŸã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œå°±èƒ½å¾ˆè½»æ˜“çš„åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­è¿›è¡Œé›†ç¾¤Masteré€‰ä¸¾äº†ã€‚æˆåŠŸåˆ›å»ºè¯¥èŠ‚ç‚¹çš„å®¢æˆ·ç«¯æ‰€åœ¨çš„æœºå™¨å°±æˆä¸ºäº†Masterã€‚åŒæ—¶ï¼Œå…¶ä»–æ²¡æœ‰æˆåŠŸåˆ›å»ºè¯¥èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ï¼Œéƒ½ä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€ä¸ªå­èŠ‚ç‚¹å˜æ›´çš„ Watcherï¼Œç”¨äºç›‘æ§å½“å‰ Master æœºå™¨æ˜¯å¦å­˜æ´»ï¼Œä¸€æ—¦å‘ç°å½“å‰çš„MasteræŒ‚äº†ï¼Œé‚£ä¹ˆå…¶ä»–å®¢æˆ·ç«¯å°†ä¼šé‡æ–°è¿›è¡Œ Master é€‰ä¸¾ã€‚è¿™æ ·å°±å®ç°äº† Master çš„åŠ¨æ€é€‰ä¸¾ã€‚\n4.2 é›†ç¾¤æœºå™¨ç›‘æ§ è¿™é€šå¸¸ç”¨äºé‚£ç§å¯¹é›†ç¾¤ä¸­æœºå™¨çŠ¶æ€ï¼Œæœºå™¨åœ¨çº¿ç‡æœ‰è¾ƒé«˜è¦æ±‚çš„åœºæ™¯ï¼Œèƒ½å¤Ÿå¿«é€Ÿå¯¹é›†ç¾¤ä¸­æœºå™¨å˜åŒ–ä½œå‡ºå“åº”ã€‚è¿™æ ·çš„åœºæ™¯ä¸­ï¼Œå¾€å¾€æœ‰ä¸€ä¸ªç›‘æ§ç³»ç»Ÿï¼Œå®æ—¶æ£€æµ‹é›†ç¾¤æœºå™¨æ˜¯å¦å­˜æ´»ã€‚è¿‡å»çš„åšæ³•é€šå¸¸æ˜¯ï¼šç›‘æ§ç³»ç»Ÿé€šè¿‡æŸç§æ‰‹æ®µï¼ˆæ¯”å¦‚pingï¼‰å®šæ—¶æ£€æµ‹æ¯ä¸ªæœºå™¨ï¼Œæˆ–è€…æ¯ä¸ªæœºå™¨è‡ªå·±å®šæ—¶å‘ç›‘æ§ç³»ç»Ÿæ±‡æŠ¥â€œæˆ‘è¿˜æ´»ç€â€ã€‚è¿™ç§åšæ³•å¯è¡Œï¼Œä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„é—®é¢˜ï¼š\n å°†ä¼šäº§ç”Ÿä¸€å®šçš„æ—¶å»¶ï¼ˆå—å¿ƒè·³é•¿çŸ­é™åˆ¶ï¼‰; å½“é›†ç¾¤ä¸­çš„èŠ‚ç‚¹å‘ç”Ÿå˜æ›´æ—¶ï¼Œå…¶ä½™çš„èŠ‚ç‚¹éƒ½éœ€è¦å¯¹ç»´æŠ¤çš„é›†ç¾¤æ–‡ä»¶ï¼ˆçŠ¶æ€è¡¨ï¼‰è¿›è¡Œä¿®æ”¹ï¼Œä¿®æ”¹å†…å®¹å¤šã€‚  åˆ©ç”¨ZooKeeperæœ‰ä¸¤ä¸ªç‰¹æ€§ï¼Œå°±å¯ä»¥å®æ—¶å¦ä¸€ç§é›†ç¾¤æœºå™¨å­˜æ´»æ€§ç›‘æ§ç³»ç»Ÿï¼š\n å®¢æˆ·ç«¯åœ¨èŠ‚ç‚¹ x ä¸Šæ³¨å†Œä¸€ä¸ªWatcherï¼Œé‚£ä¹ˆå¦‚æœxçš„å­èŠ‚ç‚¹å˜åŒ–äº†ï¼Œä¼šé€šçŸ¥è¯¥å®¢æˆ·ç«¯ã€‚ åˆ›å»ºEPHEMERALç±»å‹çš„èŠ‚ç‚¹ï¼Œä¸€æ—¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ä¼šè¯ç»“æŸæˆ–è¿‡æœŸï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹å°±ä¼šæ¶ˆå¤±ã€‚  ä¾‹å¦‚ï¼Œç›‘æ§ç³»ç»Ÿåœ¨/clusterServersèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€ä¸ªWatcherï¼Œä»¥åæ¯åŠ¨æ€åŠ æœºå™¨ï¼Œé‚£ä¹ˆå°±å¾€/clusterServersä¸‹åˆ›å»ºä¸€ä¸ª EPHEMERALç±»å‹çš„èŠ‚ç‚¹ï¼š/clusterServers/{hostname}. è¿™æ ·ï¼Œç›‘æ§ç³»ç»Ÿå°±èƒ½å¤Ÿå®æ—¶çŸ¥é“æœºå™¨çš„å¢å‡æƒ…å†µï¼Œè‡³äºåç»­å¤„ç†å°±æ˜¯ç›‘æ§ç³»ç»Ÿçš„ä¸šåŠ¡äº†ã€‚\nå‚è€ƒé“¾æ¥ ã€åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‘ZooKeeperç»å…¸åº”ç”¨åœºæ™¯\rZookeeper-Zookeeperå¯ä»¥å¹²ä»€ä¹ˆ\rZooKeeperå…¸å‹åº”ç”¨åœºæ™¯ä¸€è§ˆ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/zookeeper/zookeeper%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88/","series":["Manual"],"tags":["ZK"],"title":"ZooKeeperèƒ½åšä»€ä¹ˆ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ã€è½¬ã€‘MySQLç´¢å¼•çš„å·¥ä½œåŸç† ç´¢å¼•æ˜¯ä¸€ç§åŠ å¿«æŸ¥è¯¢çš„æ•°æ®ç»“æ„ï¼Œåœ¨ MySQL ä¸­ï¼Œç´¢å¼•çš„æ•°æ®ç»“æ„é€‰æ‹©çš„æ˜¯ B+Treeï¼Œè‡³äº B+Tree æ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆ MySQL ä¸ºä»€ä¹ˆé€‰æ‹© B+Tree æ¥ä½œä¸ºç´¢å¼•ï¼Œå¯ä»¥å»æŸ¥çœ‹å…¬ä¼—å·çš„å‰ä¸‰ç¯‡æ–‡ç« ã€‚\n  ç´¢å¼•æ•°æ®ç»“æ„ä¹‹ B-Tree ä¸ B+Treeï¼ˆä¸Šç¯‡ï¼‰\r  ç´¢å¼•æ•°æ®ç»“æ„ä¹‹ B-Tree ä¸ B+Treeï¼ˆä¸‹ç¯‡ï¼‰\r  MySQL ä¸ºä»€ä¹ˆä¸ç”¨æ•°ç»„ã€å“ˆå¸Œè¡¨ã€äºŒå‰æ ‘ç­‰æ•°æ®ç»“æ„ä½œä¸ºç´¢å¼•å‘¢\rä»Šå¤©ä¸»è¦æ¥èŠèŠ MySQL ä¸­ç´¢å¼•çš„å·¥ä½œåŸç†ï¼Œè¿™ä¸€éƒ¨åˆ†çš„çŸ¥è¯†ï¼Œåœ¨å·¥ä½œä¸­ç»å¸¸è¢«ä½¿ç”¨åˆ°ï¼Œåœ¨é¢è¯•ä¸­ä¹Ÿå‡ ä¹æ˜¯å¿…é—®çš„ã€‚æ‰€ä»¥ï¼Œä¸ç®¡æ˜¯é¢è¯•é€ ç«ç®­ï¼Œè¿˜æ˜¯å·¥ä½œæ‹§èºä¸ï¼ŒæŒæ¡ç´¢å¼•çš„å·¥ä½œåŸç†ï¼Œéƒ½æ˜¯ååˆ†æœ‰å¿…è¦çš„ã€‚\n  é¦–å…ˆéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæœ¬æ–‡çš„æ‰€æœ‰è®¨è®ºå‡æ˜¯åŸºäº InnoDB å­˜å‚¨å¼•æ“ä¸ºå‰æã€‚\nç¤ºä¾‹è¡¨ ä¸ºäº†æ–¹ä¾¿è¯´æ˜ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªç¤ºä¾‹è¡¨ã€‚å»ºè¡¨è¯­å¥å¦‚ä¸‹\nCREATE TABLE user ( `id` BIGINT ( 11 ) NOT NULL AUTO_INCREMENT, `name` VARCHAR ( 64 ) COMMENT \u0026#39;å§“å\u0026#39;, `age` INT ( 4 ) COMMENT \u0026#39;å¹´é¾„\u0026#39;, PRIMARY KEY ( `id` ), INDEX ( NAME ) ) ENGINE = INNODB COMMENT \u0026#39;ç”¨æˆ·è¡¨\u0026#39;; INSERT INTO `user` ( `name`, `age` ) VALUES ( \u0026#39;AA\u0026#39;, 30 ),( \u0026#39;BB\u0026#39;, 33 ),( \u0026#39;CC\u0026#39;, 31 ),( \u0026#39;DD\u0026#39;, 30 ),( \u0026#39;EE\u0026#39;, 29 ) å¤åˆ¶ä»£ç  åœ¨ä¸Šé¢çš„ SQL è¯­å¥ä¸­ï¼Œåˆ›å»ºäº†ä¸€å¼  user è¡¨ï¼Œè¡¨ä¸­æœ‰ä¸‰ä¸ªå­—æ®µï¼Œid æ˜¯ä¸»é”®ï¼Œname å’Œ age åˆ†åˆ«è¡¨ç¤ºç”¨æˆ·çš„å§“åå’Œå¹´é¾„ï¼ŒåŒæ—¶è¿˜ä¸ºå­—æ®µ name åˆ›å»ºäº†ä¸€ä¸ªæ™®é€šç´¢å¼•ã€‚ä¸ºäº†æ–¹ä¾¿åé¢æè¿°ï¼Œå› æ­¤è¿˜å‘è¡¨ä¸­æ’å…¥äº† 5 æ¡æ•°æ®ï¼Œç”±äºä¸»é”® id æ˜¯è‡ªå¢çš„ï¼Œæ‰€ä»¥è¿™äº”è¡Œæ•°æ®çš„ id å€¼åˆ†ä¸ºæ˜¯ 1~5ã€‚\nä¸»é”®ç´¢å¼• ä¸»é”®ç´¢å¼•åˆç§°ä¹‹ä¸ºèšç°‡ç´¢å¼•ï¼ˆcluster indexï¼‰ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å¶å­ç»“ç‚¹ä¸­ä¼šå­˜æ”¾å½“å‰ä¸»é”®æ‰€å¯¹åº”è¡Œçš„æ•°æ®ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ‹¿ä¸Šé¢çš„ä¾‹å­æ¥è¯´æ˜ï¼Œåœ¨è¡¨ user ä¸­ï¼Œid ä¸ºä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€æ£µ id çš„ç´¢å¼•æ ‘ï¼Œåœ¨è¯¥ç´¢å¼•æ ‘çš„å¶å­ç»“ç‚¹ä¸­ï¼Œä¸ä»…å­˜æ”¾äº†ä¸»é”® id çš„å€¼ï¼Œè¿˜å­˜æ”¾äº† name å’Œ value çš„å€¼ã€‚ä¾‹å¦‚ï¼šåœ¨ id=1 è¿™ä¸€è¡Œçš„æ•°æ®ä¸­ï¼Œname å’Œ age çš„å€¼ä¸º AA å’Œ 30ï¼Œé‚£ä¹ˆåœ¨ç´¢å¼•æ ‘ä¸­ï¼Œåœ¨ id=1 çš„ç»“ç‚¹å¤„ï¼Œå­˜æ”¾çš„æ˜¯(1,\u0026ldquo;AA\u0026rdquo;,30)è¿™ä¸‰ä¸ªå€¼ã€‚id ç´¢å¼•æ ‘çš„ç¤ºæ„å›¾å¦‚ä¸‹ã€‚\nä¸‹é¢çœ‹çœ‹è¿™ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œæµç¨‹ï¼š\nselect * from user where id = 1; å¤åˆ¶ä»£ç  è¯¥è¯­å¥åœ¨ where æ¡ä»¶ä¸­åŠ äº† id=1 è¿™ä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œå› æ­¤ä¼šä½¿ç”¨åˆ°ä¸»é”® id çš„ç´¢å¼•æ ‘ã€‚\n é€‰æ‹©ä½¿ç”¨ id ä¸»é”®ç´¢å¼•æ ‘ï¼› æ‰¾åˆ° id ç´¢å¼•æ ‘çš„ç¬¬ä¸€å±‚ç»“ç‚¹ï¼ˆå…³é”®å­— 3ã€7 æ‰€åœ¨çš„ç»“ç‚¹ï¼‰ï¼Œç”±äº where æ¡ä»¶ä¸­ id=1ï¼Œ1 å°äº 3ï¼Œæ‰€ä»¥è¿›å…¥åˆ°å…³é”®å­— 3 çš„å·¦å­æ ‘ä¸­æŸ¥æ‰¾ï¼› è¿›å…¥åˆ° id ç´¢å¼•æ ‘çš„ç¬¬äºŒå±‚ç»“ç‚¹ï¼Œç¬¬äºŒå±‚ç»“ç‚¹æ˜¯å¶å­ç»“ç‚¹ï¼Œå¶å­ç»“ç‚¹ä¸­å­˜æ”¾äº†è¡¨çš„æ•°æ®ï¼Œå¹¶ä¸”å­˜åœ¨ id=1 çš„å…³é”®å­—ï¼Œæ‰€ä»¥å°† R1 è¿”å›ã€‚ï¼ˆR1 è¡¨ç¤ºçš„æ˜¯ id=1 è¿™ä¸€è¡Œçš„æ•°æ®ï¼‰ã€‚  å›è¡¨ æ™®é€šç´¢å¼•åˆç§°ä¹‹ä¸ºéèšç°‡ç´¢å¼•ï¼Œä¹Ÿå«åšäºŒçº§ç´¢å¼•ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å¶å­ç»“ç‚¹ä¸­ä¹Ÿä¼šå­˜æ”¾æ•°æ®ï¼Œä¸ä¸»é”®ç´¢å¼•ä¸åŒçš„æ˜¯ï¼Œæ™®é€šç´¢å¼•ä¸­å­˜æ”¾çš„æ•°æ®åªæœ‰ä¸»é”®çš„å€¼ï¼Œè€Œéæ•´è¡Œè®°å½•çš„æ•°æ®ã€‚ä¾‹å¦‚ä¸Šé¢çš„ç¤ºä¾‹è¡¨ä¸­ï¼Œname å°±æ˜¯ä¸€ä¸ªæ™®é€šç´¢å¼•ï¼Œå®ƒçš„ç´¢å¼•æ ‘ä¸­ï¼Œåœ¨å¶å­ç»“ç‚¹ä¸­å­˜æ”¾çš„æ•°æ®æ˜¯ä¸»é”® id çš„å€¼ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š\nä¸‹é¢çœ‹çœ‹è¿™ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œæµç¨‹ï¼š\nselect * from user where name = \u0026#39;BB\u0026#39;; å¤åˆ¶ä»£ç  è¯¥è¯­å¥åœ¨ where æ¡ä»¶ä¸­åŠ äº† name=\u0026lsquo;BB\u0026rsquo;è¿™ä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œç”±äºæˆ‘ä»¬åœ¨å»ºè¡¨æ—¶ä¸º name å­—æ®µåˆ›å»ºäº†ç´¢å¼•ï¼Œå› æ­¤ä¼šä½¿ç”¨åˆ° name è¿™æ£µç´¢å¼•æ ‘ã€‚å¦å¤–ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ select * ï¼Œä¹Ÿå°±æ˜¯æŸ¥è¯¢è¡¨ä¸­çš„æ‰€æœ‰å­—æ®µçš„å€¼ï¼Œä½†æ˜¯ name ç´¢å¼•æ ‘ä¸­åªå­˜æœ‰ä¸»é”® id çš„å€¼ï¼Œæ— æ³•æ»¡è¶³è¦æŸ¥è¯¢æ‰€æœ‰å­—æ®µçš„éœ€æ±‚ï¼Œè€Œæ‰€æœ‰å­—æ®µçš„æ•°æ®éƒ½æ˜¯å­˜æ”¾åœ¨ä¸»é”® id ç´¢å¼•æ ‘ä¸Šçš„ï¼Œå› æ­¤åœ¨ name ç´¢å¼•æ ‘ä¸ŠæŸ¥åˆ°ä¸»é”® id çš„å€¼åï¼Œè¿˜éœ€è¦æ ¹æ®æŸ¥åˆ°çš„ id å€¼ï¼Œå†å»ä¸»é”®ç´¢å¼•æ ‘ä¸ŠæŸ¥æ‰¾è¿™ä¸€è¡Œè®°å½•ä¸­å…¶ä»–å­—æ®µçš„å€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ç§°ä¹‹ä¸ºå›è¡¨ã€‚ï¼ˆä»æ™®é€šç´¢å¼•æ ‘å›åˆ°ä¸»é”®ç´¢å¼•æ ‘æœç´¢çš„è¿‡ç¨‹å°±å«åšå›è¡¨ï¼‰ã€‚ æ‰€ä»¥ä¸Šé¢çš„ SQL è¯­å¥çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š\n é€‰æ‹©ä½¿ç”¨ name ç´¢å¼•æ ‘ï¼› æ‰¾åˆ°ç´¢å¼•æ ‘çš„ç¬¬ä¸€å±‚ç»“ç‚¹ï¼Œç”±äº where æ¡ä»¶ä¸­\u0026rsquo;BB\u0026rsquo;çš„å€¼å°äºç¬¬ä¸€å±‚ç»“ç‚¹ä¸­å…³é”®å­—\u0026rsquo;CC\u0026rsquo;çš„å€¼ï¼Œç´¢å¼•è¿›å…¥åˆ°å…³é”®å­—\u0026rsquo;CC\u0026rsquo;çš„å·¦å­æ ‘ä¸­æŸ¥æ‰¾ï¼› è¿›å…¥åˆ°ç¬¬äºŒå±‚çš„å¶å­ç»“ç‚¹ï¼Œæ‰¾åˆ°å…³é”®å­—\u0026rsquo;BB\u0026rsquo;ï¼Œç”±äºå¶å­ç»“ç‚¹ä¸­å­˜æ”¾äº†ä¸»é”® id çš„æ•°æ®ï¼Œæ‰€ä»¥è¿”å›\u0026rsquo;BB\u0026rsquo;ä¸­ä¸»é”® id çš„å€¼ 2ï¼› æ ¹æ®ä¸»é”® id=2ï¼Œå†å»ä¸»é”® id çš„ç´¢å¼•æ ‘ä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ° id=2 æ‰€å¯¹åº”çš„æ•°æ® R2ï¼› åœ¨ name ç´¢å¼•æ ‘ä¸­ç»§ç»­å‘åæŸ¥æ‰¾ï¼Œæ‰¾åˆ°\u0026rsquo;BB\u0026rsquo;çš„ä¸‹ä¸€ä¸ªå…³é”®å­—\u0026rsquo;CC'ï¼Œå‘ç°\u0026rsquo;CC\u0026rsquo;ä¸ç­‰äº where æ¡ä»¶ä¸­çš„\u0026rsquo;BB'ï¼Œæ‰€ä»¥ç»“æŸæŸ¥æ‰¾ã€‚  è¦†ç›–ç´¢å¼• å¯¹äºä¸Šé¢çš„ç¬¬äºŒä¸ªä¾‹å­ï¼Œç”±äº name=\u0026lsquo;BB\u0026rsquo;çš„åªæœ‰ä¸€æ¡è®°å½•ï¼Œå› æ­¤åªå›äº†ä¸€æ¬¡è¡¨ï¼Œé‚£å¦‚æœæœ‰å¤šæ¡è®°å½•åŒæ—¶æ»¡è¶³ name=\u0026lsquo;BB\u0026rsquo;è¿™ä¸ªæ¡ä»¶ï¼Œé‚£å°±å¾—è¿›è¡Œå¤šæ¬¡å›è¡¨æ“ä½œäº†ã€‚æ˜¾ç„¶ï¼Œå›è¡¨æ¬¡æ•°è¶Šå¤šï¼ŒSQL æ‰§è¡Œçš„è¶Šæ…¢ï¼Œé‚£æœ‰ä»€ä¹ˆåŠæ³•èƒ½é¿å…å›è¡¨å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯è¦†ç›–ç´¢å¼•ã€‚\nè¦†ç›–ç´¢å¼•ç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿåœ¨ä¸Šé¢çš„ç¬¬äºŒä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† select * æ¥æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œé‚£å¦‚æœæˆ‘ä»¬å¹¶ä¸éœ€è¦æ‰€æœ‰çš„å­—æ®µå‘¢ï¼Œåªéœ€è¦ id å­—æ®µå‘¢ï¼Ÿä¾‹å¦‚ select id from user where name = \u0026lsquo;BB\u0026rsquo;; ç”±äºåœ¨ name ç´¢å¼•æ ‘çš„å¶å­ç»“ç‚¹ä¸­å·²ç»å­˜æœ‰äº†ä¸»é”® id çš„å€¼ï¼Œæ‰€ä»¥ name ç´¢å¼•æ ‘èƒ½ç›´æ¥æ»¡è¶³æˆ‘ä»¬çš„æŸ¥è¯¢è¦æ±‚ï¼Œå› æ­¤æ­¤æ—¶æ˜¯ä¸è¦å›è¡¨æ“ä½œï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬ç§°ä¹‹ä¸ºè¦†ç›–ç´¢å¼•ã€‚\nè¦†ç›–ç´¢å¼•èƒ½å¤Ÿæ˜¾è‘—çš„æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œå› ä¸ºå®ƒèƒ½æ˜æ˜¾å‡å°‘å¤§é‡çš„å›è¡¨æ“ä½œã€‚è¦†ç›–ç´¢å¼•æ˜¯éå¸¸å¸¸ç”¨çš„ä¸€ç§ SQL ä¼˜åŒ–æ‰‹æ®µï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿååˆ†ç®€å•ã€‚æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸å»ºè®®ä¸è¦ä½¿ç”¨ select * æ¥æŸ¥è¯¢æ•°æ®ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºåœ¨æ•°æ®é‡å¤§æ—¶ï¼Œselect * å¯èƒ½ä¼šè¿”å›å¥½å¤šæ— ç”¨å­—æ®µï¼Œæµªè´¹ç½‘ç»œèµ„æºï¼›å¦ä¸€æ–¹é¢ä¹Ÿæ˜¯å‡ºäºå°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„è€ƒè™‘ã€‚\nè”åˆç´¢å¼•ä¸æœ€å·¦åŒ¹é…åŸåˆ™ å‡å¦‚æˆ‘ä»¬ç°åœ¨æœ‰ä¸ªéœ€æ±‚æ˜¯è¦æŸ¥è¯¢ user è¡¨ä¸­ï¼Œname=\u0026lsquo;BB\u0026rsquo;çš„äººçš„ name å’Œ ageï¼Œæˆ‘ä»¬çš„ SQL éœ€è¦è¿™æ ·å†™ï¼š\nselect name,age from user where name = \u0026#39;BB\u0026#39;; å¤åˆ¶ä»£ç  æ˜¾ç„¶ï¼Œæ­¤æ—¶ä¹Ÿä¼šä½¿ç”¨åˆ° name ç´¢å¼•æ ‘ï¼Œåˆå› ä¸º name ç´¢å¼•æ ‘ä¸­å¹¶æ²¡æœ‰å­˜æ”¾ age å­—æ®µçš„ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦è¿›è¡Œå›è¡¨ï¼Œå›åˆ°ä¸»é”® id çš„ç´¢å¼•æ ‘ä¸­å– age å­—æ®µçš„å€¼ã€‚é‚£ä¹ˆæœ‰ä»€ä¹ˆæ–¹æ³•èƒ½ä¼˜åŒ–ä¸€ä¸‹å‘¢ï¼Ÿè®©è¿™æ¬¡æŸ¥è¯¢ä¸éœ€è¦è¿›è¡Œå›è¡¨ã€‚è‚¯å®šæœ‰å•Šï¼ä½¿ç”¨è¦†ç›–ç´¢å¼•å•Šã€‚æ€ä¹ˆç”¨å‘¢ï¼Ÿ\næˆ‘ä»¬åœ¨åˆ›å»º name ç´¢å¼•çš„æ—¶å€™ï¼Œå®é™…ä¸Šåˆ›å»ºçš„æ˜¯å•åˆ—ç´¢å¼•ï¼ˆåªé€‰ç”¨äº† name è¿™ä¸€åˆ—ï¼‰ï¼Œè€Œåœ¨ MySQL ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥åœ¨åˆ›å»ºç´¢å¼•æ—¶ï¼Œé€‰æ‹©å¤šä¸ªåˆ—è¿›è¡Œç´¢å¼•åˆ›å»ºï¼Œè¿™ä¸€ç±»ç´¢å¼•æˆ‘ä»¬ç§°ä¹‹ä¸ºè”åˆç´¢å¼•ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬ç°åœ¨ä¸º name å­—æ®µå’Œ age å­—æ®µåˆ›å»ºä¸€ä¸ªè”åˆç´¢å¼•ï¼Œæ‰§è¡Œè¯­å¥å¦‚ä¸‹ï¼š\n# ä¸ºäº†ä¸å½±å“æµ‹è¯•ï¼Œæˆ‘ä»¬å…ˆå°†ä¹‹å‰çš„nameå­—æ®µçš„ç´¢å¼•åˆ é™¤ alter table user drop index `name`; # åˆ›å»ºnameã€ageçš„è”åˆç´¢å¼• alter table user add index(`name`,`age`); å¤åˆ¶ä»£ç  è¿™ä¸ªæ—¶å€™ï¼Œè¿™ä¸ªè”åˆç´¢å¼•çš„ç´¢å¼•æ ‘ä¸Šï¼Œæ¯ä¸ªç»“ç‚¹ä¸Šå­˜æ”¾çš„ä¸ä»…ä»…åªæœ‰ name å­—æ®µçš„å€¼äº†ï¼Œè¿˜æœ‰ age å­—æ®µçš„å€¼ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š\né‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå½“æˆ‘ä»¬ select name,age from user where name = \u0026lsquo;BB\u0026rsquo; æ—¶ï¼Œç”±äºéœ€è¦çš„ name å­—æ®µå’Œ age å­—æ®µåœ¨è¿™æ£µè”åˆç´¢å¼•æ ‘ä¸Šå·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥è¿™æ¬¡æŸ¥è¯¢ä¸éœ€è¦å›è¡¨ã€‚\nåœ¨ä½¿ç”¨è”åˆç´¢å¼•æ—¶ï¼Œç´¢å¼•çš„æ¯ä¸€åˆ—åªèƒ½åšç­‰å€¼åˆ¤æ–­ï¼Œå› ä¸º MySQL ä¼šä½¿ç”¨æœ€å·¦åŒ¹é…åŸåˆ™è¿›è¡ŒåŒ¹é…ï¼Œä¹Ÿå°±æ˜¯ä»ç´¢å¼•æœ€å·¦è¾¹çš„åˆ—å¼€å§‹è¿ç»­åŒ¹é…ï¼Œåœ¨ç¢°åˆ°èŒƒå›´æŸ¥æ‰¾æ—¶ä¼šåœæ­¢åŒ¹é…ï¼Œå¦‚é‡åˆ° likeã€\u0026gt;ã€\u0026lt;ã€between ç­‰èŒƒå›´æŸ¥æ‰¾ã€‚å¯ä»¥ç»“åˆä¸‹é¢ä¸‰ä¸ªç¤ºä¾‹æ¥ç†è§£ä¸€ä¸‹ã€‚\nselect name,age from user where name = \u0026#39;BB\u0026#39; and age = 33; # åœ¨ä½¿ç”¨è”åˆç´¢å¼•æ—¶ï¼Œä¼šä¾æ¬¡åŒ¹é…nameåˆ—å’Œageåˆ—ã€‚ select name,age from user where name like \u0026#39;B%\u0026#39; and age = 33; # åœ¨ä½¿ç”¨è”åˆç´¢å¼•æ—¶ï¼Œå½“åŒ¹é…åˆ°nameè¿™ä¸€åˆ—çš„æ—¶å€™ï¼Œç”±äºnameä½¿ç”¨äº†likeèŒƒå›´æŸ¥æ‰¾ï¼Œå› æ­¤åé¢ä¸ä¼šå†åŒ¹é…ageè¿™ä¸€åˆ—äº†ã€‚ select name,age from user where age = 33; # åœ¨ä½¿ç”¨è”åˆç´¢å¼•æ—¶ï¼Œç”±äºè”åˆç´¢å¼•çš„æœ€å·¦åˆ—ä¸ºnameåˆ—ï¼Œè€Œæˆ‘ä»¬åœ¨whereæ¡ä»¶ä¸­åŒ¹é…çš„æ˜¯ageåˆ—ï¼Œå› æ­¤ä¸æ»¡è¶³æœ€å·¦åŒ¹é…åŸåˆ™ï¼Œæ‰€ä»¥è¯¥æ¡SQLä¼šè¿›è¡Œè¯¥è”åˆç´¢å¼•çš„å…¨è¡¨æ‰«æã€‚ å¤åˆ¶ä»£ç  ä¸ºä»€ä¹ˆ MySQL è¦éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º B+Tree ä¸­ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„æ•°æ®æ˜¯æœ‰åºçš„ï¼Œå½“æˆ‘ä»¬åˆ›å»ºè”åˆç´¢å¼•æ—¶ï¼Œé¦–å…ˆä¿è¯çš„æ˜¯æ‰€æœ‰æ•°æ®çš„ç¬¬ä¸€åˆ—æ˜¯æœ‰åºçš„ï¼Œç„¶åå†ä¿è¯ç¬¬äºŒåˆ—ã€ç¬¬ä¸‰åˆ—ä»¥åŠåé¢çš„åˆ—æœ‰åºã€‚ä»¥ä¸Šé¢çš„ user è¡¨ä¸­çš„è”åˆç´¢å¼•ä¸ºä¾‹ï¼Œåœ¨è¯¥ç´¢å¼•æ ‘ä¸­ï¼Œname è¿™ä¸€åˆ—åœ¨æ‰€æœ‰æ•°æ®ä¸Šæ˜¯æœ‰åºçš„ï¼Œä½†æ˜¯ age è¿™ä¸€åˆ—ï¼Œå´ä¸æ˜¯æœ‰åºçš„ï¼Œåªæœ‰å¯¹äº name ç›¸åŒçš„æƒ…å†µçš„ä¸‹ï¼Œage æ‰æœ‰åºã€‚å½“æˆ‘ä»¬åœ¨æŸ¥æ‰¾æ•°æ®æ—¶ï¼Œå¦‚æœç¢°åˆ°èŒƒå›´æŸ¥æ‰¾çš„æ—¶å€™ï¼Œç”±äºåé¢çš„åˆ—æ²¡æ³•ä¿è¯æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥ä¸èƒ½å†ç»§ç»­è¿›è¡Œç­‰å€¼åŒ¹é…ï¼Œåªèƒ½å¯¹åé¢çš„åˆ—è¿›è¡Œå…¨è¡¨æ‰«æã€‚\næ€»ç»“ æœ¬æ–‡ä¸»è¦è®²äº†ä¸€æ¡æŸ¥è¯¢ SQL è¯­å¥æ˜¯å¦‚ä½•é€šè¿‡ç´¢å¼•æ¥æŸ¥è¯¢æ•°æ®çš„ï¼Œä»¥åŠä»€ä¹ˆæ˜¯å›è¡¨ã€‚åœ¨ä½¿ç”¨ç´¢å¼•æ—¶ï¼Œä¸ºäº†æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºåˆç†çš„ç´¢å¼•ï¼Œä½¿ç”¨è¦†ç›–ç´¢å¼•æ¥å‡å°‘å›è¡¨æ“ä½œï¼Œä»è€Œè¾¾åˆ°æå‡æŸ¥è¯¢æ€§èƒ½çš„ç›®çš„ã€‚æœ€åï¼Œåœ¨è”åˆç´¢å¼•çš„ä½¿ç”¨ä¸­ï¼Œç”±äºæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œéœ€è¦æ³¨æ„ç´¢å¼•åˆ—çš„é¡ºåºï¼Œåœ¨åˆ›å»ºè”åˆç´¢å¼•æ—¶ï¼Œéœ€è¦è€ƒè™‘å¥½å¦‚ä½•å®‰æ’ç´¢å¼•å†…å­—æ®µçš„é¡ºåºï¼Œä»¥æ»¡è¶³æ›´å¤šçš„æŸ¥è¯¢åœºæ™¯ï¼Œé¿å…åˆ›å»ºå¤šä¸ªç´¢å¼•ã€‚\nå‚è€ƒ MySQLç´¢å¼•çš„å·¥ä½œåŸç†\rç´¢å¼•æ•°æ®ç»“æ„ä¹‹B-Treeä¸B+Treeï¼ˆä¸Šç¯‡ï¼‰\rç´¢å¼•æ•°æ®ç»“æ„ä¹‹B-Treeä¸B+Treeï¼ˆä¸‹ç¯‡ï¼‰\rMySQLä¸ºä»€ä¹ˆä¸ç”¨æ•°ç»„ã€å“ˆå¸Œè¡¨ã€äºŒå‰æ ‘ç­‰æ•°æ®ç»“æ„ä½œä¸ºç´¢å¼•å‘¢\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mysql/%E8%BD%ACmysql%E7%B4%A2%E5%BC%95%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/","series":["Manual"],"tags":["MQ"],"title":"ã€è½¬ã€‘MySQLç´¢å¼•çš„å·¥ä½œåŸç†"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ä¸€ã€ä¸»ä»å¤åˆ¶æ¦‚è¿° ä¸»ä»å¤åˆ¶ï¼Œæ˜¯æŒ‡å°†ä¸€å°RedisæœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„RedisæœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸ºä¸»èŠ‚ç‚¹(master)ï¼Œåè€…ç§°ä¸ºä»èŠ‚ç‚¹(slave)ï¼›æ•°æ®çš„å¤åˆ¶æ˜¯å•å‘çš„ï¼Œåªèƒ½ç”±ä¸»èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯å°RedisæœåŠ¡å™¨éƒ½æ˜¯ä¸»èŠ‚ç‚¹ï¼›ä¸”ä¸€ä¸ªä¸»èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªä»èŠ‚ç‚¹(æˆ–æ²¡æœ‰ä»èŠ‚ç‚¹)ï¼Œä½†ä¸€ä¸ªä»èŠ‚ç‚¹åªèƒ½æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ã€‚\nä¸»ä»å¤åˆ¶çš„ä½œç”¨\nä¸»ä»å¤åˆ¶çš„ä½œç”¨ä¸»è¦åŒ…æ‹¬ï¼š\n æ•°æ®å†—ä½™ï¼šä¸»ä»å¤åˆ¶å®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼ã€‚ æ•…éšœæ¢å¤ï¼šå½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ï¼›å®é™…ä¸Šæ˜¯ä¸€ç§æœåŠ¡çš„å†—ä½™ã€‚ è´Ÿè½½å‡è¡¡ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼ˆå³å†™Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¯»Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä»èŠ‚ç‚¹ï¼‰ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ï¼›å°¤å…¶æ˜¯åœ¨å†™å°‘è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜RedisæœåŠ¡å™¨çš„å¹¶å‘é‡ã€‚ é«˜å¯ç”¨åŸºçŸ³ï¼šé™¤äº†ä¸Šè¿°ä½œç”¨ä»¥å¤–ï¼Œä¸»ä»å¤åˆ¶è¿˜æ˜¯å“¨å…µå’Œé›†ç¾¤èƒ½å¤Ÿå®æ–½çš„åŸºç¡€ï¼Œå› æ­¤è¯´ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€ã€‚  äºŒã€å¦‚ä½•ä½¿ç”¨ä¸»ä»å¤åˆ¶ ä¸ºäº†æ›´ç›´è§‚çš„ç†è§£ä¸»ä»å¤åˆ¶ï¼Œåœ¨ä»‹ç»å…¶å†…éƒ¨åŸç†ä¹‹å‰ï¼Œå…ˆè¯´æ˜æˆ‘ä»¬éœ€è¦å¦‚ä½•æ“ä½œæ‰èƒ½å¼€å¯ä¸»ä»å¤åˆ¶ã€‚\n1. å»ºç«‹å¤åˆ¶ éœ€è¦æ³¨æ„ï¼Œä¸»ä»å¤åˆ¶çš„å¼€å¯ï¼Œå®Œå…¨æ˜¯åœ¨ä»èŠ‚ç‚¹å‘èµ·çš„ï¼›ä¸éœ€è¦æˆ‘ä»¬åœ¨ä¸»èŠ‚ç‚¹åšä»»ä½•äº‹æƒ…ã€‚\nä»èŠ‚ç‚¹å¼€å¯ä¸»ä»å¤åˆ¶ï¼Œæœ‰3ç§æ–¹å¼ï¼š\nï¼ˆ1ï¼‰é…ç½®æ–‡ä»¶\nåœ¨ä»æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ï¼šslaveof ï¼ˆ2ï¼‰å¯åŠ¨å‘½ä»¤\nredis-serverå¯åŠ¨å‘½ä»¤ååŠ å…¥ \u0026ndash;slaveof ï¼ˆ3ï¼‰å®¢æˆ·ç«¯å‘½ä»¤\nRedisæœåŠ¡å™¨å¯åŠ¨åï¼Œç›´æ¥é€šè¿‡å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤ï¼šslaveof ï¼Œåˆ™è¯¥Rediså®ä¾‹æˆä¸ºä»èŠ‚ç‚¹ã€‚\nä¸Šè¿°3ç§æ–¹å¼æ˜¯ç­‰æ•ˆçš„ï¼Œä¸‹é¢ä»¥å®¢æˆ·ç«¯å‘½ä»¤çš„æ–¹å¼ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹å½“æ‰§è¡Œäº†slaveofåï¼ŒRedisä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹çš„å˜åŒ–ã€‚\n2. å®ä¾‹ å‡†å¤‡å·¥ä½œï¼šå¯åŠ¨ä¸¤ä¸ªèŠ‚ç‚¹ æ–¹ä¾¿èµ·è§ï¼Œå®éªŒæ‰€ä½¿ç”¨çš„ä¸»ä»èŠ‚ç‚¹æ˜¯åœ¨ä¸€å°æœºå™¨ä¸Šçš„ä¸åŒRediså®ä¾‹ï¼Œå…¶ä¸­ä¸»èŠ‚ç‚¹ç›‘å¬6379ç«¯å£ï¼Œä»èŠ‚ç‚¹ç›‘å¬6380ç«¯å£ï¼›ä»èŠ‚ç‚¹ç›‘å¬çš„ç«¯å£å·å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ï¼š\nå¯åŠ¨åå¯ä»¥çœ‹åˆ°ï¼š\nä¸¤ä¸ªRedisèŠ‚ç‚¹å¯åŠ¨åï¼ˆåˆ†åˆ«ç§°ä¸º6379èŠ‚ç‚¹å’Œ6380èŠ‚ç‚¹ï¼‰ï¼Œé»˜è®¤éƒ½æ˜¯ä¸»èŠ‚ç‚¹ã€‚\nå»ºç«‹å¤åˆ¶ æ­¤æ—¶åœ¨6380èŠ‚ç‚¹æ‰§è¡Œslaveofå‘½ä»¤ï¼Œä½¿ä¹‹å˜ä¸ºä»èŠ‚ç‚¹ï¼š\nè§‚å¯Ÿæ•ˆæœ ä¸‹é¢éªŒè¯ä¸€ä¸‹ï¼Œåœ¨ä¸»ä»å¤åˆ¶å»ºç«‹åï¼Œä¸»èŠ‚ç‚¹çš„æ•°æ®ä¼šå¤åˆ¶åˆ°ä»èŠ‚ç‚¹ä¸­ã€‚\nï¼ˆ1ï¼‰é¦–å…ˆåœ¨ä»èŠ‚ç‚¹æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„keyï¼š\nï¼ˆ2ï¼‰ç„¶ååœ¨ä¸»èŠ‚ç‚¹ä¸­å¢åŠ è¿™ä¸ªkeyï¼š\nï¼ˆ3ï¼‰æ­¤æ—¶åœ¨ä»èŠ‚ç‚¹ä¸­å†æ¬¡æŸ¥è¯¢è¿™ä¸ªkeyï¼Œä¼šå‘ç°ä¸»èŠ‚ç‚¹çš„æ“ä½œå·²ç»åŒæ­¥è‡³ä»èŠ‚ç‚¹ï¼š\nï¼ˆ4ï¼‰ç„¶ååœ¨ä¸»èŠ‚ç‚¹åˆ é™¤è¿™ä¸ªkeyï¼š\nï¼ˆ5ï¼‰æ­¤æ—¶åœ¨ä»èŠ‚ç‚¹ä¸­å†æ¬¡æŸ¥è¯¢è¿™ä¸ªkeyï¼Œä¼šå‘ç°ä¸»èŠ‚ç‚¹çš„æ“ä½œå·²ç»åŒæ­¥è‡³ä»èŠ‚ç‚¹ï¼š\n3. æ–­å¼€å¤åˆ¶ é€šè¿‡slaveof å‘½ä»¤å»ºç«‹ä¸»ä»å¤åˆ¶å…³ç³»ä»¥åï¼Œå¯ä»¥é€šè¿‡slaveof no oneæ–­å¼€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»èŠ‚ç‚¹æ–­å¼€å¤åˆ¶åï¼Œä¸ä¼šåˆ é™¤å·²æœ‰çš„æ•°æ®ï¼Œåªæ˜¯ä¸å†æ¥å—ä¸»èŠ‚ç‚¹æ–°çš„æ•°æ®å˜åŒ–ã€‚\nä»èŠ‚ç‚¹æ‰§è¡Œslaveof no oneåï¼Œæ‰“å°æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼›å¯ä»¥çœ‹å‡ºæ–­å¼€å¤åˆ¶åï¼Œä»èŠ‚ç‚¹åˆå˜å›ä¸ºä¸»èŠ‚ç‚¹ã€‚\nä¸»èŠ‚ç‚¹æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š\nä¸‰ã€ä¸»ä»å¤åˆ¶çš„å®ç°åŸç† ä¸Šé¢ä¸€èŠ‚ä¸­ï¼Œä»‹ç»äº†å¦‚ä½•æ“ä½œå¯ä»¥å»ºç«‹ä¸»ä»å…³ç³»ï¼›æœ¬å°èŠ‚å°†ä»‹ç»ä¸»ä»å¤åˆ¶çš„å®ç°åŸç†ã€‚\nä¸»ä»å¤åˆ¶è¿‡ç¨‹å¤§ä½“å¯ä»¥åˆ†ä¸º3ä¸ªé˜¶æ®µï¼šè¿æ¥å»ºç«‹é˜¶æ®µï¼ˆå³å‡†å¤‡é˜¶æ®µï¼‰ã€æ•°æ®åŒæ­¥é˜¶æ®µã€å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼›ä¸‹é¢åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚\n1. è¿æ¥å»ºç«‹é˜¶æ®µ è¯¥é˜¶æ®µçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ä¸»ä»èŠ‚ç‚¹ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä¸ºæ•°æ®åŒæ­¥åšå¥½å‡†å¤‡ã€‚\næ­¥éª¤1ï¼šä¿å­˜ä¸»èŠ‚ç‚¹ä¿¡æ¯ ä»èŠ‚ç‚¹æœåŠ¡å™¨å†…éƒ¨ç»´æŠ¤äº†ä¸¤ä¸ªå­—æ®µï¼Œå³masterhostå’Œmasterportå­—æ®µï¼Œç”¨äºå­˜å‚¨ä¸»èŠ‚ç‚¹çš„ipå’Œportä¿¡æ¯ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œslaveofæ˜¯å¼‚æ­¥å‘½ä»¤ï¼Œä»èŠ‚ç‚¹å®Œæˆä¸»èŠ‚ç‚¹ipå’Œportçš„ä¿å­˜åï¼Œå‘å‘é€slaveofå‘½ä»¤çš„å®¢æˆ·ç«¯ç›´æ¥è¿”å›OK**ï¼Œå®é™…çš„å¤åˆ¶æ“ä½œåœ¨è¿™ä¹‹åæ‰å¼€å§‹è¿›è¡Œã€‚**\nè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä»èŠ‚ç‚¹æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š\næ­¥éª¤2ï¼šå»ºç«‹socketè¿æ¥ ä»èŠ‚ç‚¹æ¯ç§’1æ¬¡è°ƒç”¨å¤åˆ¶å®šæ—¶å‡½æ•°replicationCron()ï¼Œå¦‚æœå‘ç°äº†æœ‰ä¸»èŠ‚ç‚¹å¯ä»¥è¿æ¥ï¼Œä¾¿ä¼šæ ¹æ®ä¸»èŠ‚ç‚¹çš„ipå’Œportï¼Œåˆ›å»ºsocketè¿æ¥ã€‚å¦‚æœè¿æ¥æˆåŠŸï¼Œåˆ™ï¼š\nä»èŠ‚ç‚¹ï¼šä¸ºè¯¥socketå»ºç«‹ä¸€ä¸ªä¸“é—¨å¤„ç†å¤åˆ¶å·¥ä½œçš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼Œè´Ÿè´£åç»­çš„å¤åˆ¶å·¥ä½œï¼Œå¦‚æ¥æ”¶RDBæ–‡ä»¶ã€æ¥æ”¶å‘½ä»¤ä¼ æ’­ç­‰ã€‚\nä¸»èŠ‚ç‚¹ï¼šæ¥æ”¶åˆ°ä»èŠ‚ç‚¹çš„socketè¿æ¥åï¼ˆå³acceptä¹‹åï¼‰ï¼Œä¸ºè¯¥socketåˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ï¼Œå¹¶å°†ä»èŠ‚ç‚¹çœ‹åšæ˜¯è¿æ¥åˆ°ä¸»èŠ‚ç‚¹çš„ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œåé¢çš„æ­¥éª¤ä¼šä»¥ä»èŠ‚ç‚¹å‘ä¸»èŠ‚ç‚¹å‘é€å‘½ä»¤è¯·æ±‚çš„å½¢å¼æ¥è¿›è¡Œã€‚\nè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä»èŠ‚ç‚¹æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š\næ­¥éª¤3ï¼šå‘é€pingå‘½ä»¤ ä»èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¹‹åï¼Œå‘é€pingå‘½ä»¤è¿›è¡Œé¦–æ¬¡è¯·æ±‚ï¼Œç›®çš„æ˜¯ï¼šæ£€æŸ¥socketè¿æ¥æ˜¯å¦å¯ç”¨ï¼Œä»¥åŠä¸»èŠ‚ç‚¹å½“å‰æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¯·æ±‚ã€‚\nä»èŠ‚ç‚¹å‘é€pingå‘½ä»¤åï¼Œå¯èƒ½å‡ºç°3ç§æƒ…å†µï¼š\nï¼ˆ1ï¼‰è¿”å›pongï¼šè¯´æ˜socketè¿æ¥æ­£å¸¸ï¼Œä¸”ä¸»èŠ‚ç‚¹å½“å‰å¯ä»¥å¤„ç†è¯·æ±‚ï¼Œå¤åˆ¶è¿‡ç¨‹ç»§ç»­ã€‚\nï¼ˆ2ï¼‰è¶…æ—¶ï¼šä¸€å®šæ—¶é—´åä»èŠ‚ç‚¹ä»æœªæ”¶åˆ°ä¸»èŠ‚ç‚¹çš„å›å¤ï¼Œè¯´æ˜socketè¿æ¥ä¸å¯ç”¨ï¼Œåˆ™ä»èŠ‚ç‚¹æ–­å¼€socketè¿æ¥ï¼Œå¹¶é‡è¿ã€‚\nï¼ˆ3ï¼‰è¿”å›pongä»¥å¤–çš„ç»“æœï¼šå¦‚æœä¸»èŠ‚ç‚¹è¿”å›å…¶ä»–ç»“æœï¼Œå¦‚æ­£åœ¨å¤„ç†è¶…æ—¶è¿è¡Œçš„è„šæœ¬ï¼Œè¯´æ˜ä¸»èŠ‚ç‚¹å½“å‰æ— æ³•å¤„ç†å‘½ä»¤ï¼Œåˆ™ä»èŠ‚ç‚¹æ–­å¼€socketè¿æ¥ï¼Œå¹¶é‡è¿ã€‚\nåœ¨ä¸»èŠ‚ç‚¹è¿”å›pongæƒ…å†µä¸‹ï¼Œä»èŠ‚ç‚¹æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š\næ­¥éª¤4ï¼šèº«ä»½éªŒè¯ å¦‚æœä»èŠ‚ç‚¹ä¸­è®¾ç½®äº†masterauthé€‰é¡¹ï¼Œåˆ™ä»èŠ‚ç‚¹éœ€è¦å‘ä¸»èŠ‚ç‚¹è¿›è¡Œèº«ä»½éªŒè¯ï¼›æ²¡æœ‰è®¾ç½®è¯¥é€‰é¡¹ï¼Œåˆ™ä¸éœ€è¦éªŒè¯ã€‚ä»èŠ‚ç‚¹è¿›è¡Œèº«ä»½éªŒè¯æ˜¯é€šè¿‡å‘ä¸»èŠ‚ç‚¹å‘é€authå‘½ä»¤è¿›è¡Œçš„ï¼Œauthå‘½ä»¤çš„å‚æ•°å³ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„masterauthçš„å€¼ã€‚\nå¦‚æœä¸»èŠ‚ç‚¹è®¾ç½®å¯†ç çš„çŠ¶æ€ï¼Œä¸ä»èŠ‚ç‚¹masterauthçš„çŠ¶æ€ä¸€è‡´ï¼ˆä¸€è‡´æ˜¯æŒ‡éƒ½å­˜åœ¨ï¼Œä¸”å¯†ç ç›¸åŒï¼Œæˆ–è€…éƒ½ä¸å­˜åœ¨ï¼‰ï¼Œåˆ™èº«ä»½éªŒè¯é€šè¿‡ï¼Œå¤åˆ¶è¿‡ç¨‹ç»§ç»­ï¼›å¦‚æœä¸ä¸€è‡´ï¼Œåˆ™ä»èŠ‚ç‚¹æ–­å¼€socketè¿æ¥ï¼Œå¹¶é‡è¿ã€‚\næ­¥éª¤5ï¼šå‘é€ä»èŠ‚ç‚¹ç«¯å£ä¿¡æ¯ èº«ä»½éªŒè¯ä¹‹åï¼Œä»èŠ‚ç‚¹ä¼šå‘ä¸»èŠ‚ç‚¹å‘é€å…¶ç›‘å¬çš„ç«¯å£å·ï¼ˆå‰è¿°ä¾‹å­ä¸­ä¸º6380ï¼‰ï¼Œä¸»èŠ‚ç‚¹å°†è¯¥ä¿¡æ¯ä¿å­˜åˆ°è¯¥ä»èŠ‚ç‚¹å¯¹åº”çš„å®¢æˆ·ç«¯çš„slave_listening_portå­—æ®µä¸­ï¼›è¯¥ç«¯å£ä¿¡æ¯é™¤äº†åœ¨ä¸»èŠ‚ç‚¹ä¸­æ‰§è¡Œinfo Replicationæ—¶æ˜¾ç¤ºä»¥å¤–ï¼Œæ²¡æœ‰å…¶ä»–ä½œç”¨ã€‚\n2. æ•°æ®åŒæ­¥é˜¶æ®µ ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥å»ºç«‹ä»¥åï¼Œä¾¿å¯ä»¥å¼€å§‹è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œè¯¥é˜¶æ®µå¯ä»¥ç†è§£ä¸ºä»èŠ‚ç‚¹æ•°æ®çš„åˆå§‹åŒ–ã€‚å…·ä½“æ‰§è¡Œçš„æ–¹å¼æ˜¯ï¼šä»èŠ‚ç‚¹å‘ä¸»èŠ‚ç‚¹å‘é€psyncå‘½ä»¤ï¼ˆRedis2.8ä»¥å‰æ˜¯syncå‘½ä»¤ï¼‰ï¼Œå¼€å§‹åŒæ­¥ã€‚\næ•°æ®åŒæ­¥é˜¶æ®µæ˜¯ä¸»ä»å¤åˆ¶æœ€æ ¸å¿ƒçš„é˜¶æ®µï¼Œæ ¹æ®ä¸»ä»èŠ‚ç‚¹å½“å‰çŠ¶æ€çš„ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºå…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶ï¼Œä¸‹é¢ä¼šæœ‰ä¸€ç« ä¸“é—¨è®²è§£è¿™ä¸¤ç§å¤åˆ¶æ–¹å¼ä»¥åŠpsyncå‘½ä»¤çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ•°æ®åŒæ­¥é˜¶æ®µä¹‹å‰ï¼Œä»èŠ‚ç‚¹æ˜¯ä¸»èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ï¼Œä¸»èŠ‚ç‚¹ä¸æ˜¯ä»èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ï¼›è€Œåˆ°äº†è¿™ä¸€é˜¶æ®µåŠä»¥åï¼Œä¸»ä»èŠ‚ç‚¹äº’ä¸ºå®¢æˆ·ç«¯ã€‚åŸå› åœ¨äºï¼šåœ¨æ­¤ä¹‹å‰ï¼Œä¸»èŠ‚ç‚¹åªéœ€è¦å“åº”ä»èŠ‚ç‚¹çš„è¯·æ±‚å³å¯ï¼Œä¸éœ€è¦ä¸»åŠ¨å‘è¯·æ±‚ï¼Œè€Œåœ¨æ•°æ®åŒæ­¥é˜¶æ®µå’Œåé¢çš„å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä¸»èŠ‚ç‚¹éœ€è¦ä¸»åŠ¨å‘ä»èŠ‚ç‚¹å‘é€è¯·æ±‚ï¼ˆå¦‚æ¨é€ç¼“å†²åŒºä¸­çš„å†™å‘½ä»¤ï¼‰ï¼Œæ‰èƒ½å®Œæˆå¤åˆ¶ã€‚\n3. å‘½ä»¤ä¼ æ’­é˜¶æ®µ æ•°æ®åŒæ­¥é˜¶æ®µå®Œæˆåï¼Œä¸»ä»èŠ‚ç‚¹è¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼›åœ¨è¿™ä¸ªé˜¶æ®µä¸»èŠ‚ç‚¹å°†è‡ªå·±æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¥æ”¶å‘½ä»¤å¹¶æ‰§è¡Œï¼Œä»è€Œä¿è¯ä¸»ä»èŠ‚ç‚¹æ•°æ®çš„ä¸€è‡´æ€§ã€‚\nåœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œé™¤äº†å‘é€å†™å‘½ä»¤ï¼Œä¸»ä»èŠ‚ç‚¹è¿˜ç»´æŒç€å¿ƒè·³æœºåˆ¶ï¼šPINGå’ŒREPLCONF ACKã€‚ç”±äºå¿ƒè·³æœºåˆ¶çš„åŸç†æ¶‰åŠéƒ¨åˆ†å¤åˆ¶ï¼Œå› æ­¤å°†åœ¨ä»‹ç»äº†éƒ¨åˆ†å¤åˆ¶çš„ç›¸å…³å†…å®¹åå•ç‹¬ä»‹ç»è¯¥å¿ƒè·³æœºåˆ¶ã€‚\nå»¶è¿Ÿä¸ä¸ä¸€è‡´\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‘½ä»¤ä¼ æ’­æ˜¯å¼‚æ­¥çš„è¿‡ç¨‹ï¼Œå³ä¸»èŠ‚ç‚¹å‘é€å†™å‘½ä»¤åå¹¶ä¸ä¼šç­‰å¾…ä»èŠ‚ç‚¹çš„å›å¤ï¼›å› æ­¤å®é™…ä¸Šä¸»ä»èŠ‚ç‚¹ä¹‹é—´å¾ˆéš¾ä¿æŒå®æ—¶çš„ä¸€è‡´æ€§ï¼Œå»¶è¿Ÿåœ¨æ‰€éš¾å…ã€‚æ•°æ®ä¸ä¸€è‡´çš„ç¨‹åº¦ï¼Œä¸ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œçŠ¶å†µã€ä¸»èŠ‚ç‚¹å†™å‘½ä»¤çš„æ‰§è¡Œé¢‘ç‡ã€ä»¥åŠä¸»èŠ‚ç‚¹ä¸­çš„repl-disable-tcp-nodelayé…ç½®ç­‰æœ‰å…³ã€‚\nrepl-disable-tcp-nodelay noï¼šè¯¥é…ç½®ä½œç”¨äºå‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œæ§åˆ¶ä¸»èŠ‚ç‚¹æ˜¯å¦ç¦æ­¢ä¸ä»èŠ‚ç‚¹çš„TCP_NODELAYï¼›é»˜è®¤noï¼Œå³ä¸ç¦æ­¢TCP_NODELAYã€‚å½“è®¾ç½®ä¸ºyesæ—¶ï¼ŒTCPä¼šå¯¹åŒ…è¿›è¡Œåˆå¹¶ä»è€Œå‡å°‘å¸¦å®½ï¼Œä½†æ˜¯å‘é€çš„é¢‘ç‡ä¼šé™ä½ï¼Œä»èŠ‚ç‚¹æ•°æ®å»¶è¿Ÿå¢åŠ ï¼Œä¸€è‡´æ€§å˜å·®ï¼›å…·ä½“å‘é€é¢‘ç‡ä¸Linuxå†…æ ¸çš„é…ç½®æœ‰å…³ï¼Œé»˜è®¤é…ç½®ä¸º40msã€‚å½“è®¾ç½®ä¸ºnoæ—¶ï¼ŒTCPä¼šç«‹é©¬å°†ä¸»èŠ‚ç‚¹çš„æ•°æ®å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œå¸¦å®½å¢åŠ ä½†å»¶è¿Ÿå˜å°ã€‚\nä¸€èˆ¬æ¥è¯´ï¼Œåªæœ‰å½“åº”ç”¨å¯¹Redisæ•°æ®ä¸ä¸€è‡´çš„å®¹å¿åº¦è¾ƒé«˜ï¼Œä¸”ä¸»ä»èŠ‚ç‚¹ä¹‹é—´ç½‘ç»œçŠ¶å†µä¸å¥½æ—¶ï¼Œæ‰ä¼šè®¾ç½®ä¸ºyesï¼›å¤šæ•°æƒ…å†µä½¿ç”¨é»˜è®¤å€¼noã€‚\nå››ã€ã€æ•°æ®åŒæ­¥é˜¶æ®µã€‘å…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶ åœ¨Redis2.8ä»¥å‰ï¼Œä»èŠ‚ç‚¹å‘ä¸»èŠ‚ç‚¹å‘é€syncå‘½ä»¤è¯·æ±‚åŒæ­¥æ•°æ®ï¼Œæ­¤æ—¶çš„åŒæ­¥æ–¹å¼æ˜¯å…¨é‡å¤åˆ¶ï¼›åœ¨Redis2.8åŠä»¥åï¼Œä»èŠ‚ç‚¹å¯ä»¥å‘é€psyncå‘½ä»¤è¯·æ±‚åŒæ­¥æ•°æ®ï¼Œæ­¤æ—¶æ ¹æ®ä¸»ä»èŠ‚ç‚¹å½“å‰çŠ¶æ€çš„ä¸åŒï¼ŒåŒæ­¥æ–¹å¼å¯èƒ½æ˜¯å…¨é‡å¤åˆ¶æˆ–éƒ¨åˆ†å¤åˆ¶ã€‚åæ–‡ä»‹ç»ä»¥Redis2.8åŠä»¥åç‰ˆæœ¬ä¸ºä¾‹ã€‚\n å…¨é‡å¤åˆ¶ï¼šç”¨äºåˆæ¬¡å¤åˆ¶æˆ–å…¶ä»–æ— æ³•è¿›è¡Œéƒ¨åˆ†å¤åˆ¶çš„æƒ…å†µï¼Œå°†ä¸»èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é‡å‹çš„æ“ä½œã€‚ éƒ¨åˆ†å¤åˆ¶ï¼šç”¨äºç½‘ç»œä¸­æ–­ç­‰æƒ…å†µåçš„å¤åˆ¶ï¼Œåªå°†ä¸­æ–­æœŸé—´ä¸»èŠ‚ç‚¹æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä¸å…¨é‡å¤åˆ¶ç›¸æ¯”æ›´åŠ é«˜æ•ˆã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœç½‘ç»œä¸­æ–­æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´ä¸»èŠ‚ç‚¹æ²¡æœ‰èƒ½å¤Ÿå®Œæ•´åœ°ä¿å­˜ä¸­æ–­æœŸé—´æ‰§è¡Œçš„å†™å‘½ä»¤ï¼Œåˆ™æ— æ³•è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ï¼Œä»ä½¿ç”¨å…¨é‡å¤åˆ¶ã€‚  1. å…¨é‡å¤åˆ¶ Redisé€šè¿‡psyncå‘½ä»¤è¿›è¡Œå…¨é‡å¤åˆ¶çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š\nï¼ˆ1ï¼‰ä»èŠ‚ç‚¹åˆ¤æ–­æ— æ³•è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ï¼Œå‘ä¸»èŠ‚ç‚¹å‘é€å…¨é‡å¤åˆ¶çš„è¯·æ±‚ï¼›æˆ–ä»èŠ‚ç‚¹å‘é€éƒ¨åˆ†å¤åˆ¶çš„è¯·æ±‚ï¼Œä½†ä¸»èŠ‚ç‚¹åˆ¤æ–­æ— æ³•è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ï¼›å…·ä½“åˆ¤æ–­è¿‡ç¨‹éœ€è¦åœ¨è®²è¿°äº†éƒ¨åˆ†å¤åˆ¶åŸç†åå†ä»‹ç»ã€‚\nï¼ˆ2ï¼‰ä¸»èŠ‚ç‚¹æ”¶åˆ°å…¨é‡å¤åˆ¶çš„å‘½ä»¤åï¼Œæ‰§è¡Œbgsaveï¼Œåœ¨åå°ç”ŸæˆRDBæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºï¼ˆç§°ä¸ºå¤åˆ¶ç¼“å†²åŒºï¼‰è®°å½•ä»ç°åœ¨å¼€å§‹æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤\nï¼ˆ3ï¼‰ä¸»èŠ‚ç‚¹çš„bgsaveæ‰§è¡Œå®Œæˆåï¼Œå°†RDBæ–‡ä»¶å‘é€ç»™ä»èŠ‚ç‚¹ï¼›ä»èŠ‚ç‚¹é¦–å…ˆæ¸…é™¤è‡ªå·±çš„æ—§æ•°æ®ï¼Œç„¶åè½½å…¥æ¥æ”¶çš„RDBæ–‡ä»¶ï¼Œå°†æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»èŠ‚ç‚¹æ‰§è¡Œbgsaveæ—¶çš„æ•°æ®åº“çŠ¶æ€\nï¼ˆ4ï¼‰ä¸»èŠ‚ç‚¹å°†å‰è¿°å¤åˆ¶ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ‰§è¡Œè¿™äº›å†™å‘½ä»¤ï¼Œå°†æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»èŠ‚ç‚¹çš„æœ€æ–°çŠ¶æ€\nï¼ˆ5ï¼‰å¦‚æœä»èŠ‚ç‚¹å¼€å¯äº†AOFï¼Œåˆ™ä¼šè§¦å‘bgrewriteaofçš„æ‰§è¡Œï¼Œä»è€Œä¿è¯AOFæ–‡ä»¶æ›´æ–°è‡³ä¸»èŠ‚ç‚¹çš„æœ€æ–°çŠ¶æ€\nä¸‹é¢æ˜¯æ‰§è¡Œå…¨é‡å¤åˆ¶æ—¶ï¼Œä¸»ä»èŠ‚ç‚¹æ‰“å°çš„æ—¥å¿—ï¼›å¯ä»¥çœ‹å‡ºæ—¥å¿—å†…å®¹ä¸ä¸Šè¿°æ­¥éª¤æ˜¯å®Œå…¨å¯¹åº”çš„ã€‚\nä¸»èŠ‚ç‚¹çš„æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š\nä»èŠ‚ç‚¹æ‰“å°æ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå…¶ä¸­ï¼Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼šä»èŠ‚ç‚¹æ¥æ”¶äº†æ¥è‡ªä¸»èŠ‚ç‚¹çš„89260ä¸ªå­—èŠ‚çš„æ•°æ®ï¼›ä»èŠ‚ç‚¹åœ¨è½½å…¥ä¸»èŠ‚ç‚¹çš„æ•°æ®ä¹‹å‰è¦å…ˆå°†è€æ•°æ®æ¸…é™¤ï¼›ä»èŠ‚ç‚¹åœ¨åŒæ­¥å®Œæ•°æ®åï¼Œè°ƒç”¨äº†bgrewriteaofã€‚\né€šè¿‡å…¨é‡å¤åˆ¶çš„è¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼Œå…¨é‡å¤åˆ¶æ˜¯éå¸¸é‡å‹çš„æ“ä½œï¼š\nï¼ˆ1ï¼‰ä¸»èŠ‚ç‚¹é€šè¿‡bgsaveå‘½ä»¤forkå­è¿›ç¨‹è¿›è¡ŒRDBæŒä¹…åŒ–ï¼Œè¯¥è¿‡ç¨‹æ˜¯éå¸¸æ¶ˆè€—CPUã€å†…å­˜(é¡µè¡¨å¤åˆ¶)ã€ç¡¬ç›˜IOçš„ï¼›å…³äºbgsaveçš„æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒ æ·±å…¥å­¦ä¹ Redisï¼ˆ2ï¼‰ï¼šæŒä¹…åŒ–\rï¼ˆ2ï¼‰ä¸»èŠ‚ç‚¹é€šè¿‡ç½‘ç»œå°†RDBæ–‡ä»¶å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œå¯¹ä¸»ä»èŠ‚ç‚¹çš„å¸¦å®½éƒ½ä¼šå¸¦æ¥å¾ˆå¤§çš„æ¶ˆè€—\nï¼ˆ3ï¼‰ä»èŠ‚ç‚¹æ¸…ç©ºè€æ•°æ®ã€è½½å…¥æ–°RDBæ–‡ä»¶çš„è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œæ— æ³•å“åº”å®¢æˆ·ç«¯çš„å‘½ä»¤ï¼›å¦‚æœä»èŠ‚ç‚¹æ‰§è¡Œbgrewriteaofï¼Œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„æ¶ˆè€—\n2. éƒ¨åˆ†å¤åˆ¶ ç”±äºå…¨é‡å¤åˆ¶åœ¨ä¸»èŠ‚ç‚¹æ•°æ®é‡è¾ƒå¤§æ—¶æ•ˆç‡å¤ªä½ï¼Œå› æ­¤Redis2.8å¼€å§‹æä¾›éƒ¨åˆ†å¤åˆ¶ï¼Œç”¨äºå¤„ç†ç½‘ç»œä¸­æ–­æ—¶çš„æ•°æ®åŒæ­¥ã€‚\néƒ¨åˆ†å¤åˆ¶çš„å®ç°ï¼Œä¾èµ–äºä¸‰ä¸ªé‡è¦çš„æ¦‚å¿µï¼š\nï¼ˆ1ï¼‰å¤åˆ¶åç§»é‡ ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹åˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡ï¼ˆoffsetï¼‰ï¼Œä»£è¡¨çš„æ˜¯ä¸»èŠ‚ç‚¹å‘ä»èŠ‚ç‚¹ä¼ é€’çš„å­—èŠ‚æ•°ï¼›ä¸»èŠ‚ç‚¹æ¯æ¬¡å‘ä»èŠ‚ç‚¹ä¼ æ’­Nä¸ªå­—èŠ‚æ•°æ®æ—¶ï¼Œä¸»èŠ‚ç‚¹çš„offsetå¢åŠ Nï¼›ä»èŠ‚ç‚¹æ¯æ¬¡æ”¶åˆ°ä¸»èŠ‚ç‚¹ä¼ æ¥çš„Nä¸ªå­—èŠ‚æ•°æ®æ—¶ï¼Œä»èŠ‚ç‚¹çš„offsetå¢åŠ Nã€‚\noffsetç”¨äºåˆ¤æ–­ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®åº“çŠ¶æ€æ˜¯å¦ä¸€è‡´ï¼šå¦‚æœäºŒè€…offsetç›¸åŒï¼Œåˆ™ä¸€è‡´ï¼›å¦‚æœoffsetä¸åŒï¼Œåˆ™ä¸ä¸€è‡´ï¼Œæ­¤æ—¶å¯ä»¥æ ¹æ®ä¸¤ä¸ªoffsetæ‰¾å‡ºä»èŠ‚ç‚¹ç¼ºå°‘çš„é‚£éƒ¨åˆ†æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸»èŠ‚ç‚¹çš„offsetæ˜¯1000ï¼Œè€Œä»èŠ‚ç‚¹çš„offsetæ˜¯500ï¼Œé‚£ä¹ˆéƒ¨åˆ†å¤åˆ¶å°±éœ€è¦å°†offsetä¸º501-1000çš„æ•°æ®ä¼ é€’ç»™ä»èŠ‚ç‚¹ã€‚è€Œoffsetä¸º501-1000çš„æ•°æ®å­˜å‚¨çš„ä½ç½®ï¼Œå°±æ˜¯ä¸‹é¢è¦ä»‹ç»çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚\nï¼ˆ2ï¼‰å¤åˆ¶ç§¯å‹ç¼“å†²åŒº å¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ˜¯ç”±ä¸»èŠ‚ç‚¹ç»´æŠ¤çš„ã€å›ºå®šé•¿åº¦çš„ã€å…ˆè¿›å…ˆå‡º(FIFO)é˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°1MBï¼›å½“ä¸»èŠ‚ç‚¹å¼€å§‹æœ‰ä»èŠ‚ç‚¹æ—¶åˆ›å»ºï¼Œå…¶ä½œç”¨æ˜¯å¤‡ä»½ä¸»èŠ‚ç‚¹æœ€è¿‘å‘é€ç»™ä»èŠ‚ç‚¹çš„æ•°æ®ã€‚æ³¨æ„ï¼Œæ— è®ºä¸»èŠ‚ç‚¹æœ‰ä¸€ä¸ªè¿˜æ˜¯å¤šä¸ªä»èŠ‚ç‚¹ï¼Œéƒ½åªéœ€è¦ä¸€ä¸ªå¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚\nåœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä¸»èŠ‚ç‚¹é™¤äº†å°†å†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œè¿˜ä¼šå‘é€ä¸€ä»½ç»™å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œä½œä¸ºå†™å‘½ä»¤çš„å¤‡ä»½ï¼›é™¤äº†å­˜å‚¨å†™å‘½ä»¤ï¼Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­è¿˜å­˜å‚¨äº†å…¶ä¸­çš„æ¯ä¸ªå­—èŠ‚å¯¹åº”çš„å¤åˆ¶åç§»é‡ï¼ˆoffsetï¼‰ã€‚ç”±äºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºå®šé•¿ä¸”æ˜¯å…ˆè¿›å…ˆå‡ºï¼Œæ‰€ä»¥å®ƒä¿å­˜çš„æ˜¯ä¸»èŠ‚ç‚¹æœ€è¿‘æ‰§è¡Œçš„å†™å‘½ä»¤ï¼›æ—¶é—´è¾ƒæ—©çš„å†™å‘½ä»¤ä¼šè¢«æŒ¤å‡ºç¼“å†²åŒºã€‚\nç”±äºè¯¥ç¼“å†²åŒºé•¿åº¦å›ºå®šä¸”æœ‰é™ï¼Œå› æ­¤å¯ä»¥å¤‡ä»½çš„å†™å‘½ä»¤ä¹Ÿæœ‰é™ï¼Œå½“ä¸»ä»èŠ‚ç‚¹offsetçš„å·®è·è¿‡å¤§è¶…è¿‡ç¼“å†²åŒºé•¿åº¦æ—¶ï¼Œå°†æ— æ³•æ‰§è¡Œéƒ¨åˆ†å¤åˆ¶ï¼Œåªèƒ½æ‰§è¡Œå…¨é‡å¤åˆ¶ã€‚åè¿‡æ¥è¯´ï¼Œä¸ºäº†æé«˜ç½‘ç»œä¸­æ–­æ—¶éƒ¨åˆ†å¤åˆ¶æ‰§è¡Œçš„æ¦‚ç‡ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å¢å¤§å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°(é€šè¿‡é…ç½®repl-backlog-size)ï¼›ä¾‹å¦‚å¦‚æœç½‘ç»œä¸­æ–­çš„å¹³å‡æ—¶é—´æ˜¯60sï¼Œè€Œä¸»èŠ‚ç‚¹å¹³å‡æ¯ç§’äº§ç”Ÿçš„å†™å‘½ä»¤(ç‰¹å®šåè®®æ ¼å¼)æ‰€å çš„å­—èŠ‚æ•°ä¸º100KBï¼Œåˆ™å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¹³å‡éœ€æ±‚ä¸º6MBï¼Œä¿é™©èµ·è§ï¼Œå¯ä»¥è®¾ç½®ä¸º12MBï¼Œæ¥ä¿è¯ç»å¤§å¤šæ•°æ–­çº¿æƒ…å†µéƒ½å¯ä»¥ä½¿ç”¨éƒ¨åˆ†å¤åˆ¶ã€‚\nä»èŠ‚ç‚¹å°†offsetå‘é€ç»™ä¸»èŠ‚ç‚¹åï¼Œä¸»èŠ‚ç‚¹æ ¹æ®offsetå’Œç¼“å†²åŒºå¤§å°å†³å®šèƒ½å¦æ‰§è¡Œéƒ¨åˆ†å¤åˆ¶ï¼š\n å¦‚æœoffsetåç§»é‡ä¹‹åçš„æ•°æ®ï¼Œä»ç„¶éƒ½åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œï¼Œåˆ™æ‰§è¡Œéƒ¨åˆ†å¤åˆ¶ï¼› å¦‚æœoffsetåç§»é‡ä¹‹åçš„æ•°æ®å·²ä¸åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­ï¼ˆæ•°æ®å·²è¢«æŒ¤å‡ºï¼‰ï¼Œåˆ™æ‰§è¡Œå…¨é‡å¤åˆ¶ã€‚  ï¼ˆ3ï¼‰æœåŠ¡å™¨è¿è¡ŒID(runid) æ¯ä¸ªRedisèŠ‚ç‚¹(æ— è®ºä¸»ä»)ï¼Œåœ¨å¯åŠ¨æ—¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºID(æ¯æ¬¡å¯åŠ¨éƒ½ä¸ä¸€æ ·)ï¼Œç”±40ä¸ªéšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ç»„æˆï¼›runidç”¨æ¥å”¯ä¸€è¯†åˆ«ä¸€ä¸ªRedisèŠ‚ç‚¹ã€‚é€šè¿‡info Serverå‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹èŠ‚ç‚¹çš„runidï¼š\nä¸»ä»èŠ‚ç‚¹åˆæ¬¡å¤åˆ¶æ—¶ï¼Œä¸»èŠ‚ç‚¹å°†è‡ªå·±çš„runidå‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹å°†è¿™ä¸ªrunidä¿å­˜èµ·æ¥ï¼›å½“æ–­çº¿é‡è¿æ—¶ï¼Œä»èŠ‚ç‚¹ä¼šå°†è¿™ä¸ªrunidå‘é€ç»™ä¸»èŠ‚ç‚¹ï¼›ä¸»èŠ‚ç‚¹æ ¹æ®runidåˆ¤æ–­èƒ½å¦è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ï¼š\n å¦‚æœä»èŠ‚ç‚¹ä¿å­˜çš„runidä¸ä¸»èŠ‚ç‚¹ç°åœ¨çš„runidç›¸åŒï¼Œè¯´æ˜ä¸»ä»èŠ‚ç‚¹ä¹‹å‰åŒæ­¥è¿‡ï¼Œä¸»èŠ‚ç‚¹ä¼šç»§ç»­å°è¯•ä½¿ç”¨éƒ¨åˆ†å¤åˆ¶(åˆ°åº•èƒ½ä¸èƒ½éƒ¨åˆ†å¤åˆ¶è¿˜è¦çœ‹offsetå’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„æƒ…å†µ)ï¼› å¦‚æœä»èŠ‚ç‚¹ä¿å­˜çš„runidä¸ä¸»èŠ‚ç‚¹ç°åœ¨çš„runidä¸åŒï¼Œè¯´æ˜ä»èŠ‚ç‚¹åœ¨æ–­çº¿å‰åŒæ­¥çš„RedisèŠ‚ç‚¹å¹¶ä¸æ˜¯å½“å‰çš„ä¸»èŠ‚ç‚¹ï¼Œåªèƒ½è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚  3. psyncå‘½ä»¤çš„æ‰§è¡Œ åœ¨äº†è§£äº†å¤åˆ¶åç§»é‡ã€å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€èŠ‚ç‚¹è¿è¡Œidä¹‹åï¼Œæœ¬èŠ‚å°†ä»‹ç»psyncå‘½ä»¤çš„å‚æ•°å’Œè¿”å›å€¼ï¼Œä»è€Œè¯´æ˜psyncå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸»ä»èŠ‚ç‚¹æ˜¯å¦‚ä½•ç¡®å®šä½¿ç”¨å…¨é‡å¤åˆ¶è¿˜æ˜¯éƒ¨åˆ†å¤åˆ¶çš„ã€‚\npsyncå‘½ä»¤çš„æ‰§è¡Œè¿‡ç¨‹å¯ä»¥å‚è§ä¸‹å›¾ï¼ˆå›¾ç‰‡æ¥æºï¼šã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹ï¼‰ï¼š\nï¼ˆ1ï¼‰é¦–å…ˆï¼Œä»èŠ‚ç‚¹æ ¹æ®å½“å‰çŠ¶æ€ï¼Œå†³å®šå¦‚ä½•è°ƒç”¨psyncå‘½ä»¤ï¼š\n å¦‚æœä»èŠ‚ç‚¹ä¹‹å‰æœªæ‰§è¡Œè¿‡slaveofæˆ–æœ€è¿‘æ‰§è¡Œäº†slaveof no oneï¼Œåˆ™ä»èŠ‚ç‚¹å‘é€å‘½ä»¤ä¸ºpsync ? -1ï¼Œå‘ä¸»èŠ‚ç‚¹è¯·æ±‚å…¨é‡å¤åˆ¶ï¼› å¦‚æœä»èŠ‚ç‚¹ä¹‹å‰æ‰§è¡Œäº†slaveofï¼Œåˆ™å‘é€å‘½ä»¤ä¸ºpsync ï¼Œå…¶ä¸­runidä¸ºä¸Šæ¬¡å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„runidï¼Œoffsetä¸ºä¸Šæ¬¡å¤åˆ¶æˆªæ­¢æ—¶ä»èŠ‚ç‚¹ä¿å­˜çš„å¤åˆ¶åç§»é‡ã€‚  ï¼ˆ2ï¼‰ä¸»èŠ‚ç‚¹æ ¹æ®æ”¶åˆ°çš„psyncå‘½ä»¤ï¼ŒåŠå½“å‰æœåŠ¡å™¨çŠ¶æ€ï¼Œå†³å®šæ‰§è¡Œå…¨é‡å¤åˆ¶è¿˜æ˜¯éƒ¨åˆ†å¤åˆ¶ï¼š\n å¦‚æœä¸»èŠ‚ç‚¹ç‰ˆæœ¬ä½äºRedis2.8ï¼Œåˆ™è¿”å›-ERRå›å¤ï¼Œæ­¤æ—¶ä»èŠ‚ç‚¹é‡æ–°å‘é€syncå‘½ä»¤æ‰§è¡Œå…¨é‡å¤åˆ¶ï¼› å¦‚æœä¸»èŠ‚ç‚¹ç‰ˆæœ¬å¤Ÿæ–°ï¼Œä¸”runidä¸ä»èŠ‚ç‚¹å‘é€çš„runidç›¸åŒï¼Œä¸”ä»èŠ‚ç‚¹å‘é€çš„offsetä¹‹åçš„æ•°æ®åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­éƒ½å­˜åœ¨ï¼Œåˆ™å›å¤+CONTINUEï¼Œè¡¨ç¤ºå°†è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ï¼Œä»èŠ‚ç‚¹ç­‰å¾…ä¸»èŠ‚ç‚¹å‘é€å…¶ç¼ºå°‘çš„æ•°æ®å³å¯ï¼› å¦‚æœä¸»èŠ‚ç‚¹ç‰ˆæœ¬å¤Ÿæ–°ï¼Œä½†æ˜¯runidä¸ä»èŠ‚ç‚¹å‘é€çš„runidä¸åŒï¼Œæˆ–ä»èŠ‚ç‚¹å‘é€çš„offsetä¹‹åçš„æ•°æ®å·²ä¸åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­(åœ¨é˜Ÿåˆ—ä¸­è¢«æŒ¤å‡ºäº†)ï¼Œåˆ™å›å¤+FULLRESYNC ï¼Œè¡¨ç¤ºè¦è¿›è¡Œå…¨é‡å¤åˆ¶ï¼Œå…¶ä¸­runidè¡¨ç¤ºä¸»èŠ‚ç‚¹å½“å‰çš„runidï¼Œoffsetè¡¨ç¤ºä¸»èŠ‚ç‚¹å½“å‰çš„offsetï¼Œä»èŠ‚ç‚¹ä¿å­˜è¿™ä¸¤ä¸ªå€¼ï¼Œä»¥å¤‡ä½¿ç”¨ã€‚  4. éƒ¨åˆ†å¤åˆ¶æ¼”ç¤º åœ¨ä¸‹é¢çš„æ¼”ç¤ºä¸­ï¼Œç½‘ç»œä¸­æ–­å‡ åˆ†é’Ÿåæ¢å¤ï¼Œæ–­å¼€è¿æ¥çš„ä¸»ä»èŠ‚ç‚¹è¿›è¡Œäº†éƒ¨åˆ†å¤åˆ¶ï¼›ä¸ºäº†ä¾¿äºæ¨¡æ‹Ÿç½‘ç»œä¸­æ–­ï¼Œæœ¬ä¾‹ä¸­çš„ä¸»ä»èŠ‚ç‚¹åœ¨å±€åŸŸç½‘ä¸­çš„ä¸¤å°æœºå™¨ä¸Šã€‚\nç½‘ç»œä¸­æ–­\nç½‘ç»œä¸­æ–­ä¸€æ®µæ—¶é—´åï¼Œä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹éƒ½ä¼šå‘ç°å¤±å»äº†ä¸å¯¹æ–¹çš„è¿æ¥ï¼ˆå…³äºä¸»ä»èŠ‚ç‚¹å¯¹è¶…æ—¶çš„åˆ¤æ–­æœºåˆ¶ï¼Œåé¢ä¼šæœ‰è¯´æ˜ï¼‰ï¼›æ­¤åï¼Œä»èŠ‚ç‚¹ä¾¿å¼€å§‹æ‰§è¡Œå¯¹ä¸»èŠ‚ç‚¹çš„é‡è¿ï¼Œç”±äºæ­¤æ—¶ç½‘ç»œè¿˜æ²¡æœ‰æ¢å¤ï¼Œé‡è¿å¤±è´¥ï¼Œä»èŠ‚ç‚¹ä¼šä¸€ç›´å°è¯•é‡è¿ã€‚\nä¸»èŠ‚ç‚¹æ—¥å¿—å¦‚ä¸‹ï¼š\nä»èŠ‚ç‚¹æ—¥å¿—å¦‚ä¸‹ï¼š\nç½‘ç»œæ¢å¤\nç½‘ç»œæ¢å¤åï¼Œä»èŠ‚ç‚¹è¿æ¥ä¸»èŠ‚ç‚¹æˆåŠŸï¼Œå¹¶è¯·æ±‚è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ï¼Œä¸»èŠ‚ç‚¹æ¥æ”¶è¯·æ±‚åï¼ŒäºŒè€…è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ä»¥åŒæ­¥æ•°æ®ã€‚\nä¸»èŠ‚ç‚¹æ—¥å¿—å¦‚ä¸‹ï¼š\nä»èŠ‚ç‚¹æ—¥å¿—å¦‚ä¸‹ï¼š\näº”ã€ã€å‘½ä»¤ä¼ æ’­é˜¶æ®µã€‘å¿ƒè·³æœºåˆ¶ åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œé™¤äº†å‘é€å†™å‘½ä»¤ï¼Œä¸»ä»èŠ‚ç‚¹è¿˜ç»´æŒç€å¿ƒè·³æœºåˆ¶ï¼šPINGå’ŒREPLCONF ACKã€‚å¿ƒè·³æœºåˆ¶å¯¹äºä¸»ä»å¤åˆ¶çš„è¶…æ—¶åˆ¤æ–­ã€æ•°æ®å®‰å…¨ç­‰æœ‰ä½œç”¨ã€‚\n1.ä¸»-\u0026gt;ä»ï¼šPING æ¯éš”æŒ‡å®šçš„æ—¶é—´ï¼Œä¸»èŠ‚ç‚¹ä¼šå‘ä»èŠ‚ç‚¹å‘é€PINGå‘½ä»¤ï¼Œè¿™ä¸ªPINGå‘½ä»¤çš„ä½œç”¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®©ä»èŠ‚ç‚¹è¿›è¡Œè¶…æ—¶åˆ¤æ–­ã€‚\nPINGå‘é€çš„é¢‘ç‡ç”±repl-ping-slave-periodå‚æ•°æ§åˆ¶ï¼Œå•ä½æ˜¯ç§’ï¼Œé»˜è®¤å€¼æ˜¯10sã€‚\nå…³äºè¯¥PINGå‘½ä»¤ç©¶ç«Ÿæ˜¯ç”±ä¸»èŠ‚ç‚¹å‘ç»™ä»èŠ‚ç‚¹ï¼Œè¿˜æ˜¯ç›¸åï¼Œæœ‰ä¸€äº›äº‰è®®ï¼›å› ä¸ºåœ¨Redisçš„å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå¯¹è¯¥å‚æ•°çš„æ³¨é‡Šä¸­è¯´æ˜æ˜¯ä»èŠ‚ç‚¹å‘ä¸»èŠ‚ç‚¹å‘é€PINGå‘½ä»¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä½†æ˜¯æ ¹æ®è¯¥å‚æ•°çš„åç§°(å«æœ‰ping-slave)ï¼Œä»¥åŠä»£ç å®ç°ï¼Œæˆ‘è®¤ä¸ºè¯¥PINGå‘½ä»¤æ˜¯ä¸»èŠ‚ç‚¹å‘ç»™ä»èŠ‚ç‚¹çš„ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š\n2. ä»-\u0026gt;ä¸»ï¼šREPLCONF ACK åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œ**ä»èŠ‚ç‚¹ä¼šå‘ä¸»èŠ‚ç‚¹å‘é€REPLCONF ACKå‘½ä»¤ï¼Œ**é¢‘ç‡æ˜¯æ¯ç§’1æ¬¡ï¼›å‘½ä»¤æ ¼å¼ä¸ºï¼šREPLCONF ACK {offset}ï¼Œå…¶ä¸­offsetæŒ‡ä»èŠ‚ç‚¹ä¿å­˜çš„å¤åˆ¶åç§»é‡ã€‚REPLCONF ACKå‘½ä»¤çš„ä½œç”¨åŒ…æ‹¬ï¼š\nï¼ˆ1ï¼‰å®æ—¶ç›‘æµ‹ä¸»ä»èŠ‚ç‚¹ç½‘ç»œçŠ¶æ€ï¼šè¯¥å‘½ä»¤ä¼šè¢«ä¸»èŠ‚ç‚¹ç”¨äºå¤åˆ¶è¶…æ—¶çš„åˆ¤æ–­ã€‚æ­¤å¤–ï¼Œåœ¨ä¸»èŠ‚ç‚¹ä¸­ä½¿ç”¨info Replicationï¼Œå¯ä»¥çœ‹åˆ°å…¶ä»èŠ‚ç‚¹çš„çŠ¶æ€ä¸­çš„lagå€¼ï¼Œä»£è¡¨çš„æ˜¯ä¸»èŠ‚ç‚¹ä¸Šæ¬¡æ”¶åˆ°è¯¥REPLCONF ACKå‘½ä»¤çš„æ—¶é—´é—´éš”ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯¥å€¼åº”è¯¥æ˜¯0æˆ–1ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nï¼ˆ2ï¼‰æ£€æµ‹å‘½ä»¤ä¸¢å¤±ï¼šä»èŠ‚ç‚¹å‘é€äº†è‡ªèº«çš„offsetï¼Œä¸»èŠ‚ç‚¹ä¼šä¸è‡ªå·±çš„offsetå¯¹æ¯”ï¼Œå¦‚æœä»èŠ‚ç‚¹æ•°æ®ç¼ºå¤±ï¼ˆå¦‚ç½‘ç»œä¸¢åŒ…ï¼‰ï¼Œä¸»èŠ‚ç‚¹ä¼šæ¨é€ç¼ºå¤±çš„æ•°æ®ï¼ˆè¿™é‡Œä¹Ÿä¼šåˆ©ç”¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼‰ã€‚æ³¨æ„ï¼Œoffsetå’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œä¸ä»…å¯ä»¥ç”¨äºéƒ¨åˆ†å¤åˆ¶ï¼Œä¹Ÿå¯ä»¥ç”¨äºå¤„ç†å‘½ä»¤ä¸¢å¤±ç­‰æƒ…å½¢ï¼›åŒºåˆ«åœ¨äºå‰è€…æ˜¯åœ¨æ–­çº¿é‡è¿åè¿›è¡Œçš„ï¼Œè€Œåè€…æ˜¯åœ¨ä¸»ä»èŠ‚ç‚¹æ²¡æœ‰æ–­çº¿çš„æƒ…å†µä¸‹è¿›è¡Œçš„ã€‚\nï¼ˆ3ï¼‰è¾…åŠ©ä¿è¯ä»èŠ‚ç‚¹çš„æ•°é‡å’Œå»¶è¿Ÿï¼šRedisä¸»èŠ‚ç‚¹ä¸­ä½¿ç”¨min-slaves-to-writeå’Œmin-slaves-max-lagå‚æ•°ï¼Œæ¥ä¿è¯ä¸»èŠ‚ç‚¹åœ¨ä¸å®‰å…¨çš„æƒ…å†µä¸‹ä¸ä¼šæ‰§è¡Œå†™å‘½ä»¤ï¼›æ‰€è°“ä¸å®‰å…¨ï¼Œæ˜¯æŒ‡ä»èŠ‚ç‚¹æ•°é‡å¤ªå°‘ï¼Œæˆ–å»¶è¿Ÿè¿‡é«˜ã€‚ä¾‹å¦‚min-slaves-to-writeå’Œmin-slaves-max-lagåˆ†åˆ«æ˜¯3å’Œ10ï¼Œå«ä¹‰æ˜¯å¦‚æœä»èŠ‚ç‚¹æ•°é‡å°äº3ä¸ªï¼Œæˆ–æ‰€æœ‰ä»èŠ‚ç‚¹çš„å»¶è¿Ÿå€¼éƒ½å¤§äº10sï¼Œåˆ™ä¸»èŠ‚ç‚¹æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤ã€‚è€Œè¿™é‡Œä»èŠ‚ç‚¹å»¶è¿Ÿå€¼çš„è·å–ï¼Œå°±æ˜¯é€šè¿‡ä¸»èŠ‚ç‚¹æ¥æ”¶åˆ°REPLCONF ACKå‘½ä»¤çš„æ—¶é—´æ¥åˆ¤æ–­çš„ï¼Œå³å‰é¢æ‰€è¯´çš„info Replicationä¸­çš„lagå€¼ã€‚\nå…­ã€åº”ç”¨ä¸­çš„é—®é¢˜ 1. è¯»å†™åˆ†ç¦»åŠå…¶ä¸­çš„é—®é¢˜ åœ¨ä¸»ä»å¤åˆ¶åŸºç¡€ä¸Šå®ç°çš„è¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥å®ç°Redisçš„è¯»è´Ÿè½½å‡è¡¡ï¼šç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä¸€ä¸ªæˆ–å¤šä¸ªä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼ˆå¤šä¸ªä»èŠ‚ç‚¹æ—¢å¯ä»¥æé«˜æ•°æ®å†—ä½™ç¨‹åº¦ï¼Œä¹Ÿå¯ä»¥æœ€å¤§åŒ–è¯»è´Ÿè½½èƒ½åŠ›ï¼‰ï¼›åœ¨è¯»è´Ÿè½½è¾ƒå¤§çš„åº”ç”¨åœºæ™¯ä¸‹ï¼Œå¯ä»¥å¤§å¤§æé«˜RedisæœåŠ¡å™¨çš„å¹¶å‘é‡ã€‚ä¸‹é¢ä»‹ç»åœ¨ä½¿ç”¨Redisè¯»å†™åˆ†ç¦»æ—¶ï¼Œéœ€è¦æ³¨æ„çš„é—®é¢˜ã€‚\nï¼ˆ1ï¼‰å»¶è¿Ÿä¸ä¸ä¸€è‡´é—®é¢˜ å‰é¢å·²ç»è®²åˆ°ï¼Œç”±äºä¸»ä»å¤åˆ¶çš„å‘½ä»¤ä¼ æ’­æ˜¯å¼‚æ­¥çš„ï¼Œå»¶è¿Ÿä¸æ•°æ®çš„ä¸ä¸€è‡´ä¸å¯é¿å…ã€‚å¦‚æœåº”ç”¨å¯¹æ•°æ®ä¸ä¸€è‡´çš„æ¥å—ç¨‹åº¦ç¨‹åº¦è¾ƒä½ï¼Œå¯èƒ½çš„ä¼˜åŒ–æªæ–½åŒ…æ‹¬ï¼šä¼˜åŒ–ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œç¯å¢ƒï¼ˆå¦‚åœ¨åŒæœºæˆ¿éƒ¨ç½²ï¼‰ï¼›ç›‘æ§ä¸»ä»èŠ‚ç‚¹å»¶è¿Ÿï¼ˆé€šè¿‡offsetï¼‰åˆ¤æ–­ï¼Œå¦‚æœä»èŠ‚ç‚¹å»¶è¿Ÿè¿‡å¤§ï¼Œé€šçŸ¥åº”ç”¨ä¸å†é€šè¿‡è¯¥ä»èŠ‚ç‚¹è¯»å–æ•°æ®ï¼›ä½¿ç”¨é›†ç¾¤åŒæ—¶æ‰©å±•å†™è´Ÿè½½å’Œè¯»è´Ÿè½½ç­‰ã€‚\nåœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µä»¥å¤–çš„å…¶ä»–æƒ…å†µä¸‹ï¼Œä»èŠ‚ç‚¹çš„æ•°æ®ä¸ä¸€è‡´å¯èƒ½æ›´åŠ ä¸¥é‡ï¼Œä¾‹å¦‚è¿æ¥åœ¨æ•°æ®åŒæ­¥é˜¶æ®µï¼Œæˆ–ä»èŠ‚ç‚¹å¤±å»ä¸ä¸»èŠ‚ç‚¹çš„è¿æ¥æ—¶ç­‰ã€‚ä»èŠ‚ç‚¹çš„slave-serve-stale-dataå‚æ•°ä¾¿ä¸æ­¤æœ‰å…³ï¼šå®ƒæ§åˆ¶è¿™ç§æƒ…å†µä¸‹ä»èŠ‚ç‚¹çš„è¡¨ç°ï¼›å¦‚æœä¸ºyesï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™ä»èŠ‚ç‚¹ä»èƒ½å¤Ÿå“åº”å®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œå¦‚æœä¸ºnoï¼Œåˆ™ä»èŠ‚ç‚¹åªèƒ½å“åº”infoã€slaveofç­‰å°‘æ•°å‘½ä»¤ã€‚è¯¥å‚æ•°çš„è®¾ç½®ä¸åº”ç”¨å¯¹æ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚æœ‰å…³ï¼›å¦‚æœå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼Œåˆ™åº”è®¾ç½®ä¸ºnoã€‚\nï¼ˆ2ï¼‰æ•°æ®è¿‡æœŸé—®é¢˜ åœ¨å•æœºç‰ˆRedisä¸­ï¼Œå­˜åœ¨ä¸¤ç§åˆ é™¤ç­–ç•¥ï¼š\n æƒ°æ€§åˆ é™¤ï¼šæœåŠ¡å™¨ä¸ä¼šä¸»åŠ¨åˆ é™¤æ•°æ®ï¼Œåªæœ‰å½“å®¢æˆ·ç«¯æŸ¥è¯¢æŸä¸ªæ•°æ®æ—¶ï¼ŒæœåŠ¡å™¨åˆ¤æ–­è¯¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤ã€‚ å®šæœŸåˆ é™¤ï¼šæœåŠ¡å™¨æ‰§è¡Œå®šæ—¶ä»»åŠ¡åˆ é™¤è¿‡æœŸæ•°æ®ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å†…å­˜å’ŒCPUçš„æŠ˜ä¸­ï¼ˆåˆ é™¤ä¼šé‡Šæ”¾å†…å­˜ï¼Œä½†æ˜¯é¢‘ç¹çš„åˆ é™¤æ“ä½œå¯¹CPUä¸å‹å¥½ï¼‰ï¼Œè¯¥åˆ é™¤çš„é¢‘ç‡å’Œæ‰§è¡Œæ—¶é—´éƒ½å—åˆ°äº†é™åˆ¶ã€‚  åœ¨ä¸»ä»å¤åˆ¶åœºæ™¯ä¸‹ï¼Œä¸ºäº†ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä»èŠ‚ç‚¹ä¸ä¼šä¸»åŠ¨åˆ é™¤æ•°æ®ï¼Œè€Œæ˜¯ç”±ä¸»èŠ‚ç‚¹æ§åˆ¶ä»èŠ‚ç‚¹ä¸­è¿‡æœŸæ•°æ®çš„åˆ é™¤ã€‚ç”±äºä¸»èŠ‚ç‚¹çš„æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç­–ç•¥ï¼Œéƒ½ä¸èƒ½ä¿è¯ä¸»èŠ‚ç‚¹åŠæ—¶å¯¹è¿‡æœŸæ•°æ®æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œå› æ­¤ï¼Œå½“å®¢æˆ·ç«¯é€šè¿‡Redisä»èŠ‚ç‚¹è¯»å–æ•°æ®æ—¶ï¼Œå¾ˆå®¹æ˜“è¯»å–åˆ°å·²ç»è¿‡æœŸçš„æ•°æ®ã€‚\nRedis 3.2ä¸­ï¼Œä»èŠ‚ç‚¹åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¢åŠ äº†å¯¹æ•°æ®æ˜¯å¦è¿‡æœŸçš„åˆ¤æ–­ï¼šå¦‚æœè¯¥æ•°æ®å·²è¿‡æœŸï¼Œåˆ™ä¸è¿”å›ç»™å®¢æˆ·ç«¯ï¼›å°†Rediså‡çº§åˆ°3.2å¯ä»¥è§£å†³æ•°æ®è¿‡æœŸé—®é¢˜ã€‚\nï¼ˆ3ï¼‰æ•…éšœåˆ‡æ¢é—®é¢˜ åœ¨æ²¡æœ‰ä½¿ç”¨å“¨å…µçš„è¯»å†™åˆ†ç¦»åœºæ™¯ä¸‹ï¼Œåº”ç”¨é’ˆå¯¹è¯»å’Œå†™åˆ†åˆ«è¿æ¥ä¸åŒçš„RedisèŠ‚ç‚¹ï¼›å½“ä¸»èŠ‚ç‚¹æˆ–ä»èŠ‚ç‚¹å‡ºç°é—®é¢˜è€Œå‘ç”Ÿæ›´æ”¹æ—¶ï¼Œéœ€è¦åŠæ—¶ä¿®æ”¹åº”ç”¨ç¨‹åºè¯»å†™Redisæ•°æ®çš„è¿æ¥ï¼›è¿æ¥çš„åˆ‡æ¢å¯ä»¥æ‰‹åŠ¨è¿›è¡Œï¼Œæˆ–è€…è‡ªå·±å†™ç›‘æ§ç¨‹åºè¿›è¡Œåˆ‡æ¢ï¼Œä½†å‰è€…å“åº”æ…¢ã€å®¹æ˜“å‡ºé”™ï¼Œåè€…å®ç°å¤æ‚ï¼Œæˆæœ¬éƒ½ä¸ç®—ä½ã€‚\nï¼ˆ4ï¼‰æ€»ç»“ åœ¨ä½¿ç”¨è¯»å†™åˆ†ç¦»ä¹‹å‰ï¼Œå¯ä»¥è€ƒè™‘å…¶ä»–æ–¹æ³•å¢åŠ Redisçš„è¯»è´Ÿè½½èƒ½åŠ›ï¼šå¦‚å°½é‡ä¼˜åŒ–ä¸»èŠ‚ç‚¹ï¼ˆå‡å°‘æ…¢æŸ¥è¯¢ã€å‡å°‘æŒä¹…åŒ–ç­‰å…¶ä»–æƒ…å†µå¸¦æ¥çš„é˜»å¡ç­‰ï¼‰æé«˜è´Ÿè½½èƒ½åŠ›ï¼›ä½¿ç”¨Redisé›†ç¾¤åŒæ—¶æé«˜è¯»è´Ÿè½½èƒ½åŠ›å’Œå†™è´Ÿè½½èƒ½åŠ›ç­‰ã€‚å¦‚æœä½¿ç”¨è¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ä½¿ç”¨å“¨å…µï¼Œä½¿ä¸»ä»èŠ‚ç‚¹çš„æ•…éšœåˆ‡æ¢å°½å¯èƒ½è‡ªåŠ¨åŒ–ï¼Œå¹¶å‡å°‘å¯¹åº”ç”¨ç¨‹åºçš„ä¾µå…¥ã€‚\n2. å¤åˆ¶è¶…æ—¶é—®é¢˜ ä¸»ä»èŠ‚ç‚¹å¤åˆ¶è¶…æ—¶æ˜¯å¯¼è‡´å¤åˆ¶ä¸­æ–­çš„æœ€é‡è¦çš„åŸå› ä¹‹ä¸€ï¼Œæœ¬å°èŠ‚å•ç‹¬è¯´æ˜è¶…æ—¶é—®é¢˜ï¼Œä¸‹ä¸€å°èŠ‚è¯´æ˜å…¶ä»–ä¼šå¯¼è‡´å¤åˆ¶ä¸­æ–­çš„é—®é¢˜ã€‚\nè¶…æ—¶åˆ¤æ–­æ„ä¹‰\nåœ¨å¤åˆ¶è¿æ¥å»ºç«‹è¿‡ç¨‹ä¸­åŠä¹‹åï¼Œä¸»ä»èŠ‚ç‚¹éƒ½æœ‰æœºåˆ¶åˆ¤æ–­è¿æ¥æ˜¯å¦è¶…æ—¶ï¼Œå…¶æ„ä¹‰åœ¨äºï¼š\nï¼ˆ1ï¼‰å¦‚æœä¸»èŠ‚ç‚¹åˆ¤æ–­è¿æ¥è¶…æ—¶ï¼Œå…¶ä¼šé‡Šæ”¾ç›¸åº”ä»èŠ‚ç‚¹çš„è¿æ¥ï¼Œä»è€Œé‡Šæ”¾å„ç§èµ„æºï¼Œå¦åˆ™æ— æ•ˆçš„ä»èŠ‚ç‚¹ä»ä¼šå ç”¨ä¸»èŠ‚ç‚¹çš„å„ç§èµ„æºï¼ˆè¾“å‡ºç¼“å†²åŒºã€å¸¦å®½ã€è¿æ¥ç­‰ï¼‰ï¼›æ­¤å¤–è¿æ¥è¶…æ—¶çš„åˆ¤æ–­å¯ä»¥è®©ä¸»èŠ‚ç‚¹æ›´å‡†ç¡®çš„çŸ¥é“å½“å‰æœ‰æ•ˆä»èŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œæœ‰åŠ©äºä¿è¯æ•°æ®å®‰å…¨ï¼ˆé…åˆå‰é¢è®²åˆ°çš„min-slaves-to-writeç­‰å‚æ•°ï¼‰ã€‚\nï¼ˆ2ï¼‰å¦‚æœä»èŠ‚ç‚¹åˆ¤æ–­è¿æ¥è¶…æ—¶ï¼Œåˆ™å¯ä»¥åŠæ—¶é‡æ–°å»ºç«‹è¿æ¥ï¼Œé¿å…ä¸ä¸»èŠ‚ç‚¹æ•°æ®é•¿æœŸçš„ä¸ä¸€è‡´ã€‚\nåˆ¤æ–­æœºåˆ¶\nä¸»ä»å¤åˆ¶è¶…æ—¶åˆ¤æ–­çš„æ ¸å¿ƒï¼Œåœ¨äºrepl-timeoutå‚æ•°ï¼Œè¯¥å‚æ•°è§„å®šäº†è¶…æ—¶æ—¶é—´çš„é˜ˆå€¼ï¼ˆé»˜è®¤60sï¼‰ï¼Œå¯¹äºä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹åŒæ—¶æœ‰æ•ˆï¼›ä¸»ä»èŠ‚ç‚¹è§¦å‘è¶…æ—¶çš„æ¡ä»¶åˆ†åˆ«å¦‚ä¸‹ï¼š\nï¼ˆ1ï¼‰ä¸»èŠ‚ç‚¹ï¼šæ¯ç§’1æ¬¡è°ƒç”¨å¤åˆ¶å®šæ—¶å‡½æ•°replicationCron()ï¼Œåœ¨å…¶ä¸­åˆ¤æ–­å½“å‰æ—¶é—´è·ç¦»ä¸Šæ¬¡æ”¶åˆ°å„ä¸ªä»èŠ‚ç‚¹REPLCONF ACKçš„æ—¶é—´ï¼Œæ˜¯å¦è¶…è¿‡äº†repl-timeoutå€¼ï¼Œå¦‚æœè¶…è¿‡äº†åˆ™é‡Šæ”¾ç›¸åº”ä»èŠ‚ç‚¹çš„è¿æ¥ã€‚\nï¼ˆ2ï¼‰ä»èŠ‚ç‚¹ï¼šä»èŠ‚ç‚¹å¯¹è¶…æ—¶çš„åˆ¤æ–­åŒæ ·æ˜¯åœ¨å¤åˆ¶å®šæ—¶å‡½æ•°ä¸­åˆ¤æ–­ï¼ŒåŸºæœ¬é€»è¾‘æ˜¯ï¼š\n å¦‚æœå½“å‰å¤„äºè¿æ¥å»ºç«‹é˜¶æ®µï¼Œä¸”è·ç¦»ä¸Šæ¬¡æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„ä¿¡æ¯çš„æ—¶é—´å·²è¶…è¿‡repl-timeoutï¼Œåˆ™é‡Šæ”¾ä¸ä¸»èŠ‚ç‚¹çš„è¿æ¥ï¼› å¦‚æœå½“å‰å¤„äºæ•°æ®åŒæ­¥é˜¶æ®µï¼Œä¸”æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„RDBæ–‡ä»¶çš„æ—¶é—´è¶…æ—¶ï¼Œåˆ™åœæ­¢æ•°æ®åŒæ­¥ï¼Œé‡Šæ”¾è¿æ¥ï¼› å¦‚æœå½“å‰å¤„äºå‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä¸”è·ç¦»ä¸Šæ¬¡æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„PINGå‘½ä»¤æˆ–æ•°æ®çš„æ—¶é—´å·²è¶…è¿‡repl-timeoutå€¼ï¼Œåˆ™é‡Šæ”¾ä¸ä¸»èŠ‚ç‚¹çš„è¿æ¥ã€‚  ä¸»ä»èŠ‚ç‚¹åˆ¤æ–­è¿æ¥è¶…æ—¶çš„ç›¸å…³æºä»£ç å¦‚ä¸‹ï¼š\n/* Replication cron function, called 1 time per second. */ void replicationCron(void) { static long long replication_cron_loops = 0; /* Non blocking connection timeout? */ if (server.masterhost \u0026amp;\u0026amp; (server.repl_state == REDIS_REPL_CONNECTING || slaveIsInHandshakeState()) \u0026amp;\u0026amp; (time(NULL)-server.repl_transfer_lastio) \u0026gt; server.repl_timeout) { redisLog(REDIS_WARNING,\u0026#34;Timeout connecting to the MASTER...\u0026#34;); undoConnectWithMaster(); } /* Bulk transfer I/O timeout? */ if (server.masterhost \u0026amp;\u0026amp; server.repl_state == REDIS_REPL_TRANSFER \u0026amp;\u0026amp; (time(NULL)-server.repl_transfer_lastio) \u0026gt; server.repl_timeout) { redisLog(REDIS_WARNING,\u0026#34;Timeout receiving bulk data from MASTER... If the problem persists try to set the \u0026#39;repl-timeout\u0026#39; parameter in redis.conf to a larger value.\u0026#34;); replicationAbortSyncTransfer(); } /* Timed out master when we are an already connected slave? */ if (server.masterhost \u0026amp;\u0026amp; server.repl_state == REDIS_REPL_CONNECTED \u0026amp;\u0026amp; (time(NULL)-server.master-\u0026gt;lastinteraction) \u0026gt; server.repl_timeout) { redisLog(REDIS_WARNING,\u0026#34;MASTER timeout: no data nor PING received...\u0026#34;); freeClient(server.master); } //æ­¤å¤„çœç•¥æ— å…³ä»£ç â€¦â€¦  /* Disconnect timedout slaves. */ if (listLength(server.slaves)) { listIter li; listNode *ln; listRewind(server.slaves,\u0026amp;li); while((ln = listNext(\u0026amp;li))) { redisClient *slave = ln-\u0026gt;value; if (slave-\u0026gt;replstate != REDIS_REPL_ONLINE) continue; if (slave-\u0026gt;flags \u0026amp; REDIS_PRE_PSYNC) continue; if ((server.unixtime - slave-\u0026gt;repl_ack_time) \u0026gt; server.repl_timeout) { redisLog(REDIS_WARNING, \u0026#34;Disconnecting timedout slave: %s\u0026#34;, replicationGetSlaveName(slave)); freeClient(slave); } } } //æ­¤å¤„çœç•¥æ— å…³ä»£ç â€¦â€¦  } ã€€éœ€è¦æ³¨æ„çš„å‘\nä¸‹é¢ä»‹ç»ä¸å¤åˆ¶é˜¶æ®µè¿æ¥è¶…æ—¶æœ‰å…³çš„ä¸€äº›å®é™…é—®é¢˜ï¼š\nï¼ˆ1ï¼‰æ•°æ®åŒæ­¥é˜¶æ®µï¼šåœ¨ä¸»ä»èŠ‚ç‚¹è¿›è¡Œå…¨é‡å¤åˆ¶bgsaveæ—¶ï¼Œä¸»èŠ‚ç‚¹éœ€è¦é¦–å…ˆforkå­è¿›ç¨‹å°†å½“å‰æ•°æ®ä¿å­˜åˆ°RDBæ–‡ä»¶ä¸­ï¼Œç„¶åå†å°†RDBæ–‡ä»¶é€šè¿‡ç½‘ç»œä¼ è¾“åˆ°ä»èŠ‚ç‚¹ã€‚å¦‚æœRDBæ–‡ä»¶è¿‡å¤§ï¼Œä¸»èŠ‚ç‚¹åœ¨forkå­è¿›ç¨‹+ä¿å­˜RDBæ–‡ä»¶æ—¶è€—æ—¶è¿‡å¤šï¼Œå¯èƒ½ä¼šå¯¼è‡´ä»èŠ‚ç‚¹é•¿æ—¶é—´æ”¶ä¸åˆ°æ•°æ®è€Œè§¦å‘è¶…æ—¶ï¼›æ­¤æ—¶ä»èŠ‚ç‚¹ä¼šé‡è¿ä¸»èŠ‚ç‚¹ï¼Œç„¶åå†æ¬¡å…¨é‡å¤åˆ¶ï¼Œå†æ¬¡è¶…æ—¶ï¼Œå†æ¬¡é‡è¿â€¦â€¦è¿™æ˜¯ä¸ªæ‚²ä¼¤çš„å¾ªç¯ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œé™¤äº†æ³¨æ„Rediså•æœºæ•°æ®é‡ä¸è¦è¿‡å¤§ï¼Œå¦ä¸€æ–¹é¢å°±æ˜¯é€‚å½“å¢å¤§repl-timeoutå€¼ï¼Œå…·ä½“çš„å¤§å°å¯ä»¥æ ¹æ®bgsaveè€—æ—¶æ¥è°ƒæ•´ã€‚\nï¼ˆ2ï¼‰å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼šå¦‚å‰æ‰€è¿°ï¼Œåœ¨è¯¥é˜¶æ®µä¸»èŠ‚ç‚¹ä¼šå‘ä»èŠ‚ç‚¹å‘é€PINGå‘½ä»¤ï¼Œé¢‘ç‡ç”±repl-ping-slave-periodæ§åˆ¶ï¼›è¯¥å‚æ•°åº”æ˜æ˜¾å°äºrepl-timeoutå€¼(åè€…è‡³å°‘æ˜¯å‰è€…çš„å‡ å€)ã€‚å¦åˆ™ï¼Œå¦‚æœä¸¤ä¸ªå‚æ•°ç›¸ç­‰æˆ–æ¥è¿‘ï¼Œç½‘ç»œæŠ–åŠ¨å¯¼è‡´ä¸ªåˆ«PINGå‘½ä»¤ä¸¢å¤±ï¼Œæ­¤æ—¶æ°å·§ä¸»èŠ‚ç‚¹ä¹Ÿæ²¡æœ‰å‘ä»èŠ‚ç‚¹å‘é€æ•°æ®ï¼Œåˆ™ä»èŠ‚ç‚¹å¾ˆå®¹æ˜“åˆ¤æ–­è¶…æ—¶ã€‚\nï¼ˆ3ï¼‰æ…¢æŸ¥è¯¢å¯¼è‡´çš„é˜»å¡ï¼šå¦‚æœä¸»èŠ‚ç‚¹æˆ–ä»èŠ‚ç‚¹æ‰§è¡Œäº†ä¸€äº›æ…¢æŸ¥è¯¢ï¼ˆå¦‚keys *æˆ–è€…å¯¹å¤§æ•°æ®çš„hgetallç­‰ï¼‰ï¼Œå¯¼è‡´æœåŠ¡å™¨é˜»å¡ï¼›é˜»å¡æœŸé—´æ— æ³•å“åº”å¤åˆ¶è¿æ¥ä¸­å¯¹æ–¹èŠ‚ç‚¹çš„è¯·æ±‚ï¼Œå¯èƒ½å¯¼è‡´å¤åˆ¶è¶…æ—¶ã€‚\n3. å¤åˆ¶ä¸­æ–­é—®é¢˜ ä¸»ä»èŠ‚ç‚¹è¶…æ—¶æ˜¯å¤åˆ¶ä¸­æ–­çš„åŸå› ä¹‹ä¸€ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–æƒ…å†µå¯èƒ½å¯¼è‡´å¤åˆ¶ä¸­æ–­ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯å¤åˆ¶ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ã€‚\nå¤åˆ¶ç¼“å†²åŒºæº¢å‡º å‰é¢æ›¾æåˆ°è¿‡ï¼Œåœ¨å…¨é‡å¤åˆ¶é˜¶æ®µï¼Œä¸»èŠ‚ç‚¹ä¼šå°†æ‰§è¡Œçš„å†™å‘½ä»¤æ”¾åˆ°å¤åˆ¶ç¼“å†²åŒºä¸­ï¼Œè¯¥ç¼“å†²åŒºå­˜æ”¾çš„æ•°æ®åŒ…æ‹¬äº†ä»¥ä¸‹å‡ ä¸ªæ—¶é—´æ®µå†…ä¸»èŠ‚ç‚¹æ‰§è¡Œçš„å†™å‘½ä»¤ï¼šbgsaveç”ŸæˆRDBæ–‡ä»¶ã€RDBæ–‡ä»¶ç”±ä¸»èŠ‚ç‚¹å‘å¾€ä»èŠ‚ç‚¹ã€ä»èŠ‚ç‚¹æ¸…ç©ºè€æ•°æ®å¹¶è½½å…¥RDBæ–‡ä»¶ä¸­çš„æ•°æ®ã€‚å½“ä¸»èŠ‚ç‚¹æ•°æ®é‡è¾ƒå¤§ï¼Œæˆ–è€…ä¸»ä»èŠ‚ç‚¹ä¹‹é—´ç½‘ç»œå»¶è¿Ÿè¾ƒå¤§æ—¶ï¼Œå¯èƒ½å¯¼è‡´è¯¥ç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†é™åˆ¶ï¼Œæ­¤æ—¶ä¸»èŠ‚ç‚¹ä¼šæ–­å¼€ä¸ä»èŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥ï¼›è¿™ç§æƒ…å†µå¯èƒ½å¼•èµ·å…¨é‡å¤åˆ¶-\u0026gt;å¤åˆ¶ç¼“å†²åŒºæº¢å‡ºå¯¼è‡´è¿æ¥ä¸­æ–­-\u0026gt;é‡è¿-\u0026gt;å…¨é‡å¤åˆ¶-\u0026gt;å¤åˆ¶ç¼“å†²åŒºæº¢å‡ºå¯¼è‡´è¿æ¥ä¸­æ–­â€¦â€¦çš„å¾ªç¯ã€‚\nå¤åˆ¶ç¼“å†²åŒºçš„å¤§å°ç”±client-output-buffer-limit slave {hard limit} {soft limit} {soft seconds}é…ç½®ï¼Œé»˜è®¤å€¼ä¸ºclient-output-buffer-limit slave 256MB 64MB 60ï¼Œå…¶å«ä¹‰æ˜¯ï¼šå¦‚æœbufferå¤§äº256MBï¼Œæˆ–è€…è¿ç»­60så¤§äº64MBï¼Œåˆ™ä¸»èŠ‚ç‚¹ä¼šæ–­å¼€ä¸è¯¥ä»èŠ‚ç‚¹çš„è¿æ¥ã€‚è¯¥å‚æ•°æ˜¯å¯ä»¥é€šè¿‡config setå‘½ä»¤åŠ¨æ€é…ç½®çš„ï¼ˆå³ä¸é‡å¯Redisä¹Ÿå¯ä»¥ç”Ÿæ•ˆï¼‰ã€‚\nå½“å¤åˆ¶ç¼“å†²åŒºæº¢å‡ºæ—¶ï¼Œä¸»èŠ‚ç‚¹æ‰“å°æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤åˆ¶ç¼“å†²åŒºæ˜¯å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºçš„ä¸€ç§ï¼Œä¸»èŠ‚ç‚¹ä¼šä¸ºæ¯ä¸€ä¸ªä»èŠ‚ç‚¹åˆ†åˆ«åˆ†é…å¤åˆ¶ç¼“å†²åŒºï¼›è€Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºåˆ™æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªï¼Œæ— è®ºå®ƒæœ‰å¤šå°‘ä¸ªä»èŠ‚ç‚¹ã€‚\n4. å„åœºæ™¯ä¸‹å¤åˆ¶çš„é€‰æ‹©åŠä¼˜åŒ–æŠ€å·§ åœ¨ä»‹ç»äº†Rediså¤åˆ¶çš„ç§ç§ç»†èŠ‚ä¹‹åï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨ä¸‹é¢å¸¸è§çš„åœºæ™¯ä¸­ï¼Œä½•æ—¶ä½¿ç”¨éƒ¨åˆ†å¤åˆ¶ï¼Œä»¥åŠéœ€è¦æ³¨æ„å“ªäº›é—®é¢˜ã€‚\nï¼ˆ1ï¼‰ç¬¬ä¸€æ¬¡å»ºç«‹å¤åˆ¶ æ­¤æ—¶å…¨é‡å¤åˆ¶ä¸å¯é¿å…ï¼Œä½†ä»æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼šå¦‚æœä¸»èŠ‚ç‚¹çš„æ•°æ®é‡è¾ƒå¤§ï¼Œåº”è¯¥å°½é‡é¿å¼€æµé‡çš„é«˜å³°æœŸï¼Œé¿å…é€ æˆé˜»å¡ï¼›å¦‚æœæœ‰å¤šä¸ªä»èŠ‚ç‚¹éœ€è¦å»ºç«‹å¯¹ä¸»èŠ‚ç‚¹çš„å¤åˆ¶ï¼Œå¯ä»¥è€ƒè™‘å°†å‡ ä¸ªä»èŠ‚ç‚¹é”™å¼€ï¼Œé¿å…ä¸»èŠ‚ç‚¹å¸¦å®½å ç”¨è¿‡å¤§ã€‚æ­¤å¤–ï¼Œå¦‚æœä»èŠ‚ç‚¹è¿‡å¤šï¼Œä¹Ÿå¯ä»¥è°ƒæ•´ä¸»ä»å¤åˆ¶çš„æ‹“æ‰‘ç»“æ„ï¼Œç”±ä¸€ä¸»å¤šä»ç»“æ„å˜ä¸ºæ ‘çŠ¶ç»“æ„ï¼ˆä¸­é—´çš„èŠ‚ç‚¹æ—¢æ˜¯å…¶ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯å…¶ä»èŠ‚ç‚¹çš„ä¸»èŠ‚ç‚¹ï¼‰ï¼›ä½†ä½¿ç”¨æ ‘çŠ¶ç»“æ„åº”è¯¥è°¨æ…ï¼šè™½ç„¶ä¸»èŠ‚ç‚¹çš„ç›´æ¥ä»èŠ‚ç‚¹å‡å°‘ï¼Œé™ä½äº†ä¸»èŠ‚ç‚¹çš„è´Ÿæ‹…ï¼Œä½†æ˜¯å¤šå±‚ä»èŠ‚ç‚¹çš„å»¶è¿Ÿå¢å¤§ï¼Œæ•°æ®ä¸€è‡´æ€§å˜å·®ï¼›ä¸”ç»“æ„å¤æ‚ï¼Œç»´æŠ¤ç›¸å½“å›°éš¾ã€‚\nï¼ˆ2ï¼‰ä¸»èŠ‚ç‚¹é‡å¯ ä¸»èŠ‚ç‚¹é‡å¯å¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å†µæ¥è®¨è®ºï¼Œä¸€ç§æ˜¯æ•…éšœå¯¼è‡´å®•æœºï¼Œå¦ä¸€ç§åˆ™æ˜¯æœ‰è®¡åˆ’çš„é‡å¯ã€‚\nä¸»èŠ‚ç‚¹å®•æœº\nä¸»èŠ‚ç‚¹å®•æœºé‡å¯åï¼Œrunidä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤ä¸èƒ½è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ï¼Œåªèƒ½å…¨é‡å¤åˆ¶ã€‚\nå®é™…ä¸Šåœ¨ä¸»èŠ‚ç‚¹å®•æœºçš„æƒ…å†µä¸‹ï¼Œåº”è¿›è¡Œæ•…éšœè½¬ç§»å¤„ç†ï¼Œå°†å…¶ä¸­çš„ä¸€ä¸ªä»èŠ‚ç‚¹å‡çº§ä¸ºä¸»èŠ‚ç‚¹ï¼Œå…¶ä»–ä»èŠ‚ç‚¹ä»æ–°çš„ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ï¼›ä¸”æ•…éšœè½¬ç§»åº”å°½é‡çš„è‡ªåŠ¨åŒ–ï¼Œåé¢æ–‡ç« å°†è¦ä»‹ç»çš„å“¨å…µä¾¿å¯ä»¥è¿›è¡Œè‡ªåŠ¨çš„æ•…éšœè½¬ç§»ã€‚\nå®‰å…¨é‡å¯ï¼šdebug reload\nåœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œå¯èƒ½å¸Œæœ›å¯¹ä¸»èŠ‚ç‚¹è¿›è¡Œé‡å¯ï¼Œä¾‹å¦‚ä¸»èŠ‚ç‚¹å†…å­˜ç¢ç‰‡ç‡è¿‡é«˜ï¼Œæˆ–è€…å¸Œæœ›è°ƒæ•´ä¸€äº›åªèƒ½åœ¨å¯åŠ¨æ—¶è°ƒæ•´çš„å‚æ•°ã€‚å¦‚æœä½¿ç”¨æ™®é€šçš„æ‰‹æ®µé‡å¯ä¸»èŠ‚ç‚¹ï¼Œä¼šä½¿å¾—runidå‘ç”Ÿå˜åŒ–ï¼Œå¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„å…¨é‡å¤åˆ¶ã€‚\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedisæä¾›äº†debug reloadçš„é‡å¯æ–¹å¼ï¼š**é‡å¯åï¼Œä¸»èŠ‚ç‚¹çš„runidå’Œoffset****éƒ½ä¸å—å½±å“ï¼Œ**é¿å…äº†å…¨é‡å¤åˆ¶ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œdebug reloadé‡å¯årunidå’Œoffsetéƒ½æœªå—å½±å“ï¼š\nä½†debug reloadæ˜¯ä¸€æŸ„åŒåˆƒå‰‘ï¼šå®ƒä¼šæ¸…ç©ºå½“å‰å†…å­˜ä¸­çš„æ•°æ®ï¼Œé‡æ–°ä»RDBæ–‡ä»¶ä¸­åŠ è½½ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå¯¼è‡´ä¸»èŠ‚ç‚¹çš„é˜»å¡ï¼Œå› æ­¤ä¹Ÿéœ€è¦è°¨æ…ã€‚\nï¼ˆ3ï¼‰ä»èŠ‚ç‚¹é‡å¯ ä»èŠ‚ç‚¹å®•æœºé‡å¯åï¼Œå…¶ä¿å­˜çš„ä¸»èŠ‚ç‚¹çš„runidä¼šä¸¢å¤±ï¼Œå› æ­¤å³ä½¿å†æ¬¡æ‰§è¡Œslaveofï¼Œä¹Ÿæ— æ³•è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ã€‚\nï¼ˆ4ï¼‰ç½‘ç»œä¸­æ–­ å¦‚æœä¸»ä»èŠ‚ç‚¹ä¹‹é—´å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œé€ æˆçŸ­æ—¶é—´å†…ç½‘ç»œä¸­æ–­ï¼Œå¯ä»¥åˆ†ä¸ºå¤šç§æƒ…å†µè®¨è®ºã€‚\nç¬¬ä¸€ç§æƒ…å†µï¼šç½‘ç»œé—®é¢˜æ—¶é—´æä¸ºçŸ­æš‚ï¼Œåªé€ æˆäº†çŸ­æš‚çš„ä¸¢åŒ…ï¼Œä¸»ä»èŠ‚ç‚¹éƒ½æ²¡æœ‰åˆ¤å®šè¶…æ—¶ï¼ˆæœªè§¦å‘repl-timeoutï¼‰ï¼›æ­¤æ—¶åªéœ€è¦é€šè¿‡REPLCONF ACKæ¥è¡¥å……ä¸¢å¤±çš„æ•°æ®å³å¯ã€‚\nç¬¬äºŒç§æƒ…å†µï¼šç½‘ç»œé—®é¢˜æ—¶é—´å¾ˆé•¿ï¼Œä¸»ä»èŠ‚ç‚¹åˆ¤æ–­è¶…æ—¶ï¼ˆè§¦å‘äº†repl-timeoutï¼‰ï¼Œä¸”ä¸¢å¤±çš„æ•°æ®è¿‡å¤šï¼Œè¶…è¿‡äº†å¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ‰€èƒ½å­˜å‚¨çš„èŒƒå›´ï¼›æ­¤æ—¶ä¸»ä»èŠ‚ç‚¹æ— æ³•è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ï¼Œåªèƒ½è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚ä¸ºäº†å°½å¯èƒ½é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œåº”è¯¥æ ¹æ®å®é™…æƒ…å†µé€‚å½“è°ƒæ•´å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°ï¼›æ­¤å¤–åŠæ—¶å‘ç°å¹¶ä¿®å¤ç½‘ç»œä¸­æ–­ï¼Œä¹Ÿå¯ä»¥å‡å°‘å…¨é‡å¤åˆ¶ã€‚\nç¬¬ä¸‰ç§æƒ…å†µï¼šä»‹äºå‰è¿°ä¸¤ç§æƒ…å†µä¹‹é—´ï¼Œä¸»ä»èŠ‚ç‚¹åˆ¤æ–­è¶…æ—¶ï¼Œä¸”ä¸¢å¤±çš„æ•°æ®ä»ç„¶éƒ½åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­ï¼›æ­¤æ—¶ä¸»ä»èŠ‚ç‚¹å¯ä»¥è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ã€‚\n5. å¤åˆ¶ç›¸å…³çš„é…ç½® è¿™ä¸€èŠ‚æ€»ç»“ä¸€ä¸‹ä¸å¤åˆ¶æœ‰å…³çš„é…ç½®ï¼Œè¯´æ˜è¿™äº›é…ç½®çš„ä½œç”¨ã€èµ·ä½œç”¨çš„é˜¶æ®µï¼Œä»¥åŠé…ç½®æ–¹æ³•ç­‰ï¼›é€šè¿‡äº†è§£è¿™äº›é…ç½®ï¼Œä¸€æ–¹é¢åŠ æ·±å¯¹Rediså¤åˆ¶çš„äº†è§£ï¼Œå¦ä¸€æ–¹é¢æŒæ¡è¿™äº›é…ç½®çš„æ–¹æ³•ï¼Œå¯ä»¥ä¼˜åŒ–Redisçš„ä½¿ç”¨ï¼Œå°‘èµ°å‘ã€‚\né…ç½®å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸»èŠ‚ç‚¹ç›¸å…³é…ç½®ã€ä»èŠ‚ç‚¹ç›¸å…³é…ç½®ä»¥åŠä¸ä¸»ä»èŠ‚ç‚¹éƒ½æœ‰å…³çš„é…ç½®ï¼Œä¸‹é¢åˆ†åˆ«è¯´æ˜ã€‚\nï¼ˆ1ï¼‰ä¸ä¸»ä»èŠ‚ç‚¹éƒ½æœ‰å…³çš„é…ç½® é¦–å…ˆä»‹ç»æœ€ç‰¹æ®Šçš„é…ç½®ï¼Œå®ƒå†³å®šäº†è¯¥èŠ‚ç‚¹æ˜¯ä¸»èŠ‚ç‚¹è¿˜æ˜¯ä»èŠ‚ç‚¹ï¼š\n  slaveof ï¼šRediså¯åŠ¨æ—¶èµ·ä½œç”¨ï¼›ä½œç”¨æ˜¯å»ºç«‹å¤åˆ¶å…³ç³»ï¼Œå¼€å¯äº†è¯¥é…ç½®çš„RedisæœåŠ¡å™¨åœ¨å¯åŠ¨åæˆä¸ºä»èŠ‚ç‚¹ã€‚è¯¥æ³¨é‡Šé»˜è®¤æ³¨é‡Šæ‰ï¼Œå³RedisæœåŠ¡å™¨é»˜è®¤éƒ½æ˜¯ä¸»èŠ‚ç‚¹ã€‚\n  repl-timeout 60ï¼šä¸å„ä¸ªé˜¶æ®µä¸»ä»èŠ‚ç‚¹è¿æ¥è¶…æ—¶åˆ¤æ–­æœ‰å…³ï¼Œè§å‰é¢çš„ä»‹ç»ã€‚\n  ï¼ˆ2ï¼‰ä¸»èŠ‚ç‚¹ç›¸å…³é…ç½®   repl-diskless-sync noï¼šä½œç”¨äºå…¨é‡å¤åˆ¶é˜¶æ®µï¼Œæ§åˆ¶ä¸»èŠ‚ç‚¹æ˜¯å¦ä½¿ç”¨disklesså¤åˆ¶ï¼ˆæ— ç›˜å¤åˆ¶ï¼‰ã€‚æ‰€è°“disklesså¤åˆ¶ï¼Œæ˜¯æŒ‡åœ¨å…¨é‡å¤åˆ¶æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¸å†å…ˆæŠŠæ•°æ®å†™å…¥RDBæ–‡ä»¶ï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥slaveçš„socketä¸­ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­ä¸æ¶‰åŠç¡¬ç›˜ï¼›disklesså¤åˆ¶åœ¨ç£ç›˜IOå¾ˆæ…¢è€Œç½‘é€Ÿå¾ˆå¿«æ—¶æ›´æœ‰ä¼˜åŠ¿ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆªè‡³Redis3.0ï¼Œdisklesså¤åˆ¶å¤„äºå®éªŒé˜¶æ®µï¼Œé»˜è®¤æ˜¯å…³é—­çš„ã€‚\n  repl-diskless-sync-delay 5ï¼šè¯¥é…ç½®ä½œç”¨äºå…¨é‡å¤åˆ¶é˜¶æ®µï¼Œå½“ä¸»èŠ‚ç‚¹ä½¿ç”¨disklesså¤åˆ¶æ—¶ï¼Œè¯¥é…ç½®å†³å®šä¸»èŠ‚ç‚¹å‘ä»èŠ‚ç‚¹å‘é€ä¹‹å‰åœé¡¿çš„æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ï¼›åªæœ‰å½“disklesså¤åˆ¶æ‰“å¼€æ—¶æœ‰æ•ˆï¼Œé»˜è®¤5sã€‚ä¹‹æ‰€ä»¥è®¾ç½®åœé¡¿æ—¶é—´ï¼Œæ˜¯åŸºäºä»¥ä¸‹ä¸¤ä¸ªè€ƒè™‘ï¼š(1)å‘slaveçš„socketçš„ä¼ è¾“ä¸€æ—¦å¼€å§‹ï¼Œæ–°è¿æ¥çš„slaveåªèƒ½ç­‰å¾…å½“å‰æ•°æ®ä¼ è¾“ç»“æŸï¼Œæ‰èƒ½å¼€å§‹æ–°çš„æ•°æ®ä¼ è¾“ (2)å¤šä¸ªä»èŠ‚ç‚¹æœ‰è¾ƒå¤§çš„æ¦‚ç‡åœ¨çŸ­æ—¶é—´å†…å»ºç«‹ä¸»ä»å¤åˆ¶ã€‚\n  client-output-buffer-limit slave 256MB 64MB 60ï¼šä¸å…¨é‡å¤åˆ¶é˜¶æ®µä¸»èŠ‚ç‚¹çš„ç¼“å†²åŒºå¤§å°æœ‰å…³ï¼Œè§å‰é¢çš„ä»‹ç»ã€‚\n  repl-disable-tcp-nodelay noï¼šä¸å‘½ä»¤ä¼ æ’­é˜¶æ®µçš„å»¶è¿Ÿæœ‰å…³ï¼Œè§å‰é¢çš„ä»‹ç»ã€‚\n  masterauth ï¼šä¸è¿æ¥å»ºç«‹é˜¶æ®µçš„èº«ä»½éªŒè¯æœ‰å…³ï¼Œè§å‰é¢çš„ä»‹ç»ã€‚\n  repl-ping-slave-period 10ï¼šä¸å‘½ä»¤ä¼ æ’­é˜¶æ®µä¸»ä»èŠ‚ç‚¹çš„è¶…æ—¶åˆ¤æ–­æœ‰å…³ï¼Œè§å‰é¢çš„ä»‹ç»ã€‚\n  repl-backlog-size 1mbï¼šå¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°ï¼Œè§å‰é¢çš„ä»‹ç»ã€‚\n  repl-backlog-ttl 3600ï¼šå½“ä¸»èŠ‚ç‚¹æ²¡æœ‰ä»èŠ‚ç‚¹æ—¶ï¼Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¿ç•™çš„æ—¶é—´ï¼Œè¿™æ ·å½“æ–­å¼€çš„ä»èŠ‚ç‚¹é‡æ–°è¿è¿›æ¥æ—¶ï¼Œå¯ä»¥è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ï¼›é»˜è®¤3600sã€‚å¦‚æœè®¾ç½®ä¸º0ï¼Œåˆ™æ°¸è¿œä¸ä¼šé‡Šæ”¾å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚\n  min-slaves-to-write 3ä¸min-slaves-max-lag 10ï¼šè§„å®šäº†ä¸»èŠ‚ç‚¹çš„æœ€å°ä»èŠ‚ç‚¹æ•°ç›®ï¼ŒåŠå¯¹åº”çš„æœ€å¤§å»¶è¿Ÿï¼Œè§å‰é¢çš„ä»‹ç»ã€‚\n  ï¼ˆ3ï¼‰ä»èŠ‚ç‚¹ç›¸å…³é…ç½®   slave-serve-stale-data yesï¼šä¸ä»èŠ‚ç‚¹æ•°æ®é™ˆæ—§æ—¶æ˜¯å¦å“åº”å®¢æˆ·ç«¯å‘½ä»¤æœ‰å…³ï¼Œè§å‰é¢çš„ä»‹ç»ã€‚\n  slave-read-only yesï¼šä»èŠ‚ç‚¹æ˜¯å¦åªè¯»ï¼›é»˜è®¤æ˜¯åªè¯»çš„ã€‚ç”±äºä»èŠ‚ç‚¹å¼€å¯å†™æ“ä½œå®¹æ˜“å¯¼è‡´ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œå› æ­¤è¯¥é…ç½®å°½é‡ä¸è¦ä¿®æ”¹ã€‚\n  6. å•æœºå†…å­˜å¤§å°é™åˆ¶ åœ¨ æ·±å…¥å­¦ä¹ Redisï¼ˆ2ï¼‰ï¼šæŒä¹…åŒ–\rä¸€æ–‡ä¸­ï¼Œè®²åˆ°äº†forkæ“ä½œå¯¹Rediså•æœºå†…å­˜å¤§å°çš„é™åˆ¶ã€‚å®é™…ä¸Šåœ¨Redisçš„ä½¿ç”¨ä¸­ï¼Œé™åˆ¶å•æœºå†…å­˜å¤§å°çš„å› ç´ éå¸¸ä¹‹å¤šï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹åœ¨ä¸»ä»å¤åˆ¶ä¸­ï¼Œå•æœºå†…å­˜è¿‡å¤§å¯èƒ½é€ æˆçš„å½±å“ï¼š\nï¼ˆ1ï¼‰åˆ‡ä¸»ï¼šå½“ä¸»èŠ‚ç‚¹å®•æœºæ—¶ï¼Œä¸€ç§å¸¸è§çš„å®¹ç¾ç­–ç•¥æ˜¯å°†å…¶ä¸­ä¸€ä¸ªä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶ä»–ä»èŠ‚ç‚¹æŒ‚è½½åˆ°æ–°çš„ä¸»èŠ‚ç‚¹ä¸Šï¼Œæ­¤æ—¶è¿™äº›ä»èŠ‚ç‚¹åªèƒ½è¿›è¡Œå…¨é‡å¤åˆ¶ï¼›å¦‚æœRediså•æœºå†…å­˜è¾¾åˆ°10GBï¼Œä¸€ä¸ªä»èŠ‚ç‚¹çš„åŒæ­¥æ—¶é—´åœ¨å‡ åˆ†é’Ÿçš„çº§åˆ«ï¼›å¦‚æœä»èŠ‚ç‚¹è¾ƒå¤šï¼Œæ¢å¤çš„é€Ÿåº¦ä¼šæ›´æ…¢ã€‚å¦‚æœç³»ç»Ÿçš„è¯»è´Ÿè½½å¾ˆé«˜ï¼Œè€Œè¿™æ®µæ—¶é—´ä»èŠ‚ç‚¹æ— æ³•æä¾›æœåŠ¡ï¼Œä¼šå¯¹ç³»ç»Ÿé€ æˆå¾ˆå¤§çš„å‹åŠ›ã€‚\nï¼ˆ2ï¼‰ä»åº“æ‰©å®¹ï¼šå¦‚æœè®¿é—®é‡çªç„¶å¢å¤§ï¼Œæ­¤æ—¶å¸Œæœ›å¢åŠ ä»èŠ‚ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œä»èŠ‚ç‚¹åŒæ­¥å¤ªæ…¢ï¼Œéš¾ä»¥åŠæ—¶åº”å¯¹è®¿é—®é‡çš„æš´å¢ã€‚\nï¼ˆ3ï¼‰ç¼“å†²åŒºæº¢å‡ºï¼šï¼ˆ1ï¼‰å’Œï¼ˆ2ï¼‰éƒ½æ˜¯ä»èŠ‚ç‚¹å¯ä»¥æ­£å¸¸åŒæ­¥çš„æƒ…å½¢ï¼ˆè™½ç„¶æ…¢ï¼‰ï¼Œä½†æ˜¯å¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œå¯¼è‡´å…¨é‡å¤åˆ¶é˜¶æ®µä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºæº¢å‡ºï¼Œä»è€Œå¯¼è‡´å¤åˆ¶ä¸­æ–­ï¼Œåˆ™ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®åŒæ­¥ä¼šå…¨é‡å¤åˆ¶-\u0026gt;å¤åˆ¶ç¼“å†²åŒºæº¢å‡ºå¯¼è‡´å¤åˆ¶ä¸­æ–­-\u0026gt;é‡è¿-\u0026gt;å…¨é‡å¤åˆ¶-\u0026gt;å¤åˆ¶ç¼“å†²åŒºæº¢å‡ºå¯¼è‡´å¤åˆ¶ä¸­æ–­â€¦â€¦çš„å¾ªç¯ã€‚\nï¼ˆ4ï¼‰è¶…æ—¶ï¼šå¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œå…¨é‡å¤åˆ¶é˜¶æ®µä¸»èŠ‚ç‚¹fork+ä¿å­˜RDBæ–‡ä»¶è€—æ—¶è¿‡å¤§ï¼Œä»èŠ‚ç‚¹é•¿æ—¶é—´æ¥æ”¶ä¸åˆ°æ•°æ®è§¦å‘è¶…æ—¶ï¼Œä¸»ä»èŠ‚ç‚¹çš„æ•°æ®åŒæ­¥åŒæ ·å¯èƒ½é™·å…¥å…¨é‡å¤åˆ¶-\u0026gt;è¶…æ—¶å¯¼è‡´å¤åˆ¶ä¸­æ–­-\u0026gt;é‡è¿-\u0026gt;å…¨é‡å¤åˆ¶-\u0026gt;è¶…æ—¶å¯¼è‡´å¤åˆ¶ä¸­æ–­â€¦â€¦çš„å¾ªç¯ã€‚\næ­¤å¤–ï¼Œä¸»èŠ‚ç‚¹å•æœºå†…å­˜é™¤äº†ç»å¯¹é‡ä¸èƒ½å¤ªå¤§ï¼Œå…¶å ç”¨ä¸»æœºå†…å­˜çš„æ¯”ä¾‹ä¹Ÿä¸åº”è¿‡å¤§ï¼šæœ€å¥½åªä½¿ç”¨50%-65%çš„å†…å­˜ï¼Œç•™ä¸‹30%-45%çš„å†…å­˜ç”¨äºæ‰§è¡Œbgsaveå‘½ä»¤å’Œåˆ›å»ºå¤åˆ¶ç¼“å†²åŒºç­‰ã€‚\n7. info Replication åœ¨Rediså®¢æˆ·ç«¯é€šè¿‡info Replicationå¯ä»¥æŸ¥çœ‹ä¸å¤åˆ¶ç›¸å…³çš„çŠ¶æ€ï¼Œå¯¹äºäº†è§£ä¸»ä»èŠ‚ç‚¹çš„å½“å‰çŠ¶æ€ï¼Œä»¥åŠè§£å†³å‡ºç°çš„é—®é¢˜éƒ½ä¼šæœ‰å¸®åŠ©ã€‚\nä¸»èŠ‚ç‚¹ï¼š\nä»èŠ‚ç‚¹ï¼š\nå¯¹äºä»èŠ‚ç‚¹ï¼Œä¸ŠåŠéƒ¨åˆ†å±•ç¤ºçš„æ˜¯å…¶ä½œä¸ºä»èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä»connectd_slaveså¼€å§‹ï¼Œå±•ç¤ºçš„æ˜¯å…¶ä½œä¸ºæ½œåœ¨çš„ä¸»èŠ‚ç‚¹çš„çŠ¶æ€ã€‚\ninfo Replicationä¸­å±•ç¤ºçš„å¤§éƒ¨åˆ†å†…å®¹åœ¨æ–‡ç« ä¸­éƒ½å·²ç»è®²è¿°ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚\nä¸ƒã€æ€»ç»“ ä¸‹é¢å›é¡¾ä¸€ä¸‹æœ¬æ–‡çš„ä¸»è¦å†…å®¹ï¼š\n1ã€ä¸»ä»å¤åˆ¶çš„ä½œç”¨ï¼šå®è§‚çš„äº†è§£ä¸»ä»å¤åˆ¶æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜ï¼Œå³æ•°æ®å†—ä½™ã€æ•…éšœæ¢å¤ã€è¯»è´Ÿè½½å‡è¡¡ç­‰ã€‚\n2ã€ä¸»ä»å¤åˆ¶çš„æ“ä½œï¼šå³slaveofå‘½ä»¤ã€‚\n3ã€ä¸»ä»å¤åˆ¶çš„åŸç†ï¼šä¸»ä»å¤åˆ¶åŒ…æ‹¬äº†è¿æ¥å»ºç«‹é˜¶æ®µã€æ•°æ®åŒæ­¥é˜¶æ®µã€å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼›å…¶ä¸­æ•°æ®åŒæ­¥é˜¶æ®µï¼Œæœ‰å…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶ä¸¤ç§æ•°æ®åŒæ­¥æ–¹å¼ï¼›å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä¸»ä»èŠ‚ç‚¹ä¹‹é—´æœ‰PINGå’ŒREPLCONF ACKå‘½ä»¤äº’ç›¸è¿›è¡Œå¿ƒè·³æ£€æµ‹ã€‚\n4ã€åº”ç”¨ä¸­çš„é—®é¢˜ï¼šåŒ…æ‹¬è¯»å†™åˆ†ç¦»çš„é—®é¢˜ï¼ˆæ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€æ•°æ®è¿‡æœŸé—®é¢˜ã€æ•…éšœåˆ‡æ¢é—®é¢˜ç­‰ï¼‰ã€å¤åˆ¶è¶…æ—¶é—®é¢˜ã€å¤åˆ¶ä¸­æ–­é—®é¢˜ç­‰ï¼Œç„¶åæ€»ç»“äº†ä¸»ä»å¤åˆ¶ç›¸å…³çš„é…ç½®ï¼Œå…¶ä¸­repl-timeoutã€client-output-buffer-limit slaveç­‰å¯¹è§£å†³Redisä¸»ä»å¤åˆ¶ä¸­å‡ºç°çš„é—®é¢˜å¯èƒ½ä¼šæœ‰å¸®åŠ©ã€‚\nä¸»ä»å¤åˆ¶è™½ç„¶è§£å†³æˆ–ç¼“è§£äº†æ•°æ®å†—ä½™ã€æ•…éšœæ¢å¤ã€è¯»è´Ÿè½½å‡è¡¡ç­‰é—®é¢˜ï¼Œä½†å…¶ç¼ºé™·ä»å¾ˆæ˜æ˜¾ï¼šæ•…éšœæ¢å¤æ— æ³•è‡ªåŠ¨åŒ–ï¼›å†™æ“ä½œæ— æ³•è´Ÿè½½å‡è¡¡ï¼›å­˜å‚¨èƒ½åŠ›å—åˆ°å•æœºçš„é™åˆ¶ï¼›è¿™äº›é—®é¢˜çš„è§£å†³ï¼Œéœ€è¦å“¨å…µå’Œé›†ç¾¤çš„å¸®åŠ©ï¼Œæˆ‘å°†åœ¨åé¢çš„æ–‡ç« ä¸­ä»‹ç»ï¼Œæ¬¢è¿å…³æ³¨ã€‚\nå‚è€ƒ æ·±å…¥å­¦ä¹ Redisï¼ˆ3ï¼‰ï¼šä¸»ä»å¤åˆ¶\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/redis/%E8%BD%ACredis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/","series":["Manual"],"tags":["Redis"],"title":"ã€è½¬ã€‘redisä¸»ä»å¤åˆ¶"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"èƒŒæ™¯ è¿™ç¯‡æ–‡ç« æœ€å¼€å§‹å†æˆ‘çš„ç¾¤é‡Œé¢æœ‰è®¨è®ºè¿‡ï¼Œå½“æ—¶æƒ³å†™çš„è¿™ç¯‡æ–‡ç« çš„ï¼Œä½†æ˜¯å› ä¸ºä¸€äº›æ—¶é—´çš„å…³ç³»æ‰€ä»¥ä¾¿æ²¡æœ‰å†™ã€‚æœ€è¿‘é˜…è¯»å¾®ä¿¡æ–‡ç« çš„æ—¶å€™å‘ç°äº†ä¸€ç¯‡é›¶åº¦å†™çš„ä¸€ç¯‡æ–‡ç« ã€Šåˆ†äº«ä¸€é“é˜¿é‡ŒJavaå¹¶å‘é¢è¯•é¢˜ã€‹ï¼Œå¯¹äºæœ‰å…³Javaå¹¶å‘æ€§æŠ€æœ¯çš„æ–‡ç« æˆ‘ä¸€èˆ¬è¿˜æ˜¯æŒºæ„Ÿå…´è¶£çš„ï¼Œäºæ˜¯é˜…è¯»äº†ä¸€ä¸‹ï¼Œæ•´ä½“æ¥è¯´è¿˜æ˜¯æŒºä¸é”™çš„ï¼Œä½†æ˜¯å…¶ä¸­çŠ¯äº†ä¸€ä¸ªéªŒè¯å¯è§æ€§çš„é—®é¢˜ã€‚ç”±äºå¾®ä¿¡æ–‡ç« å›å¤ä¸æ–¹ä¾¿è®¨è®ºï¼Œäºæ˜¯æˆ‘ä¾¿æŠŠä¹‹å‰ä¸€äº›å’Œç¾¤å‹çš„è®¨è®ºåœ¨è¿™é‡Œå†™å‡ºæ¥ã€‚\nå¦‚ä½•æµ‹è¯•å¯è§æ€§é—®é¢˜ å› ä¸ºåœ¨ç¾¤é‡Œé¢æˆ‘ä»¬ä¹ æƒ¯çš„æœ‰æ¯å‘¨ä¸€é—®ï¼Œä¹Ÿå°±ç”±æˆ‘æˆ–è€…ç¾¤å‹å‘ç°ä¸€äº›ç”±æ„æ€çš„é—®é¢˜ç„¶åæé—®ç»™å¤§å®¶ï¼Œè®©å¤§å®¶å‚ä¸è®¨è®ºï¼Œå½“æ—¶æˆ‘æå‡ºäº†ä¸€ä¸ªå¦‚ä½•æµ‹è¯•vlolatileå¯è§æ€§çš„é—®é¢˜ï¼Œé¦–å…ˆåœ¨Effective Javaç»™å‡ºäº†ä¸€ä¸ªæµ‹è¯•volatileå¯è§æ€§çš„ä¾‹å­:\nimport java.util.concurrent.*; public class Test { private static /*volatile*/ boolean stop = false; public static void main(String[] args) throws Exception { Thread t = new Thread(new Runnable() { public void run() { int i = 0; while (!stop) { i++; // System.out.println(\u0026#34;hello\u0026#34;);  } } }); t.start(); Thread.sleep(1000); TimeUnit.SECONDS.sleep(1); System.out.println(\u0026#34;Stop Thread\u0026#34;); stop = true; } } è¿™é‡Œå¤§å®¶å¯ä»¥å¤åˆ¶ä¸Šé¢çš„ä»£ç ï¼Œä½ ä¼šå‘ç°è¿™é‡Œç¨‹åºæ°¸è¿œä¸ä¼šç»“æŸï¼Œåœ¨é›¶åº¦çš„é‚£ç¯‡æ–‡ç« ä¸­ä¹Ÿç»™å‡ºäº†ä¸€ä¸ªæµ‹è¯•å¯è§æ€§çš„ä¾‹å­:\npublic class ThreadSafeCache { int result; public int getResult() { return result; } public synchronized void setResult(int result) { this.result = result; } public static void main(String[] args) { ThreadSafeCache threadSafeCache = new ThreadSafeCache(); for (int i = 0; i \u0026lt; 8; i++) { new Thread(() -\u0026gt; { int x = 0; while (threadSafeCache.getResult() \u0026lt; 100) { x++; } System.out.println(x); }).start(); } try { Thread.sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } threadSafeCache.setResult(200); } } è¿™é‡Œå¤§å®¶ä¹Ÿå¯ä»¥è¿è¡Œä¸€ä¸‹è¿™é‡Œæ˜¯ä¸ä¼šç»“æŸçš„ã€‚\nç„¶è€Œè¿™ä¸¤ä¸ªä¾‹å­çœŸçš„æ˜¯æµ‹è¯•å¯è§æ€§çš„ï¼Ÿæˆ‘ä»¬å…ˆä¸ç€æ€¥ä¸‹å®šè®ºï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ä½•ä¸ºå¯è§æ€§ï¼Œè¿™é‡Œä¸ºäº†é˜²æ­¢è‡ªå·±çš„ä¸€äº›ç‰‡é¢ä¹‹è¯ï¼ŒæŸ¥é˜…äº†ä¸€äº›èµ„æ–™å¯ä»¥å‘ç°å¯è§æ€§çš„å®šä¹‰æ€»ä½“æ¥è¯´å¯ä»¥å®šä¹‰ä¸º:\n å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹ã€‚\n å¯è§æ€§çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼Œé‚£æ€ä¹ˆå»å®ç°å‘¢ï¼Ÿä¸€èˆ¬æ¥è¯´å¯è§æ€§ä¼šé€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®®æ¥å®Œæˆï¼Œè¿™é‡Œæœ‰ç¯‡æ–‡ç« è®²CPUç¼“å­˜ä¸€è‡´æ€§åè®®è®²å¾—ä¸é”™:https://www.cnblogs.com/yanlong300/p/8986041.htmlï¼Œæˆ‘è¿™é‡Œç›´æ¥å€Ÿç”¨ä»–çš„å›¾ç‰‡,\n CPU A è®¡ç®—å®Œæˆåå‘æŒ‡ä»¤éœ€è¦ä¿®æ”¹x. CPU A å°†xè®¾ç½®ä¸ºMçŠ¶æ€ï¼ˆä¿®æ”¹çŠ¶æ€ï¼‰å¹¶é€šçŸ¥ç¼“å­˜äº†xçš„CPU B, CPU Bå°†æœ¬åœ°cache bä¸­çš„xè®¾ç½®ä¸ºIçŠ¶æ€(æ— æ•ˆçŠ¶æ€) CPU A å¯¹xè¿›è¡Œèµ‹å€¼ CPU B å‘ç°xæ˜¯å¤±æ•ˆçš„è¿™ä¸ªæ—¶å€™ä¼šè¿›è¡Œå›åˆ·æ“ä½œ  å¯ä»¥çœ‹è§æˆ‘ä»¬çš„ä¸€è‡´æ€§åè®®ä¼šæœ‰ä¸€å®šçš„æ—¶é—´å»¶è¿Ÿï¼Œä½†æ˜¯æˆ‘ä»¬çš„å¯è§æ€§çš„ç›®çš„æ˜¯ç«‹å³è¯»åˆ°æœ€æ–°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¼šå°†æ— æ•ˆçŠ¶æ€é€šçŸ¥åˆ°å…¶ä»–æ‹¥æœ‰è¯¥ç¼“å­˜æ•°æ®çš„CPUç¼“å­˜ä¸­ï¼Œå¹¶ä¸”ç­‰å¾…ç¡®è®¤ï¼Œæˆ‘ä»¬vlolatileä¹Ÿæ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼è¾¾åˆ°å¯è§æ€§çš„ï¼Œå½“ç„¶æ›´å¤šçš„ç»†èŠ‚ä½ å¯ä»¥ç›´æ¥é˜…è¯»ä¸Šé¢æ¨èçš„æ–‡ç« ã€‚\næˆ‘ä»¬åˆå›åˆ°æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬çš„whileå¾ªç¯æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ç¼“å­˜ä¸€è‡´æ€§åè®®æ˜¯ä¸€å®šæ—¶é—´å»¶è¿Ÿï¼Œè™½ç„¶è¿™ä¸ªä¸€å®šæ—¶é—´å¹¶ä¸ä¿è¯ï¼Œä½†æ˜¯åœ¨ç°ä»£çš„ç”µè„‘ç³»ç»Ÿä¸Šå°¤å…¶æ˜¯ä½ è‡ªå·±çš„æœºå™¨ä¸Šï¼Œåˆ·æ–°ä¸€ä¸ªç¼“å­˜è¿™ç‚¹å°æ—¶é—´è¿˜æ˜¯æœ‰çš„å§ã€‚\nå¹¶ä¸”æˆ‘ä»¬éªŒè¯å¯è§æ€§çš„æ—¶å€™ä¼¼ä¹è¿èƒŒäº†æˆ‘ä»¬åˆè¡·ï¼Œå¯è§æ€§çš„å®šä¹‰æ˜¯ç«‹å³è¯»åˆ°æœ€æ–°çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å´åœ¨å¼ºè°ƒæˆ‘ä»¬çš„æµ‹è¯•ç¨‹åºä¼šå‡ºç°æ­»å¾ªç¯ï¼Œé‚£æˆ‘ä»¬ä¸å°±æ˜¯éªŒè¯çš„æ˜¯æ°¸è¿œéƒ½è¯»ä¸åˆ°æœ€æ–°çš„å—ï¼Ÿ\né€šè¿‡ä¸Šé¢çš„ç§ç§è®ºè¿°æˆ‘ä»¬å‘ç°æˆ‘ä»¬å¯è§æ€§çš„éªŒè¯ä¼¼ä¹å‡ºäº†ä¸€ç‚¹é—®é¢˜ã€‚\næ¨ç¿»éªŒè¯ç¨‹åº æˆ‘ä»¬è¿™é‡Œåªéœ€è¦ä¸€è¡Œä»£ç å°±å¯ä»¥æ¨ç¿»æˆ‘ä»¬ä¸Šé¢çš„éªŒè¯ç¨‹åºï¼Œæˆ‘ä»¬ç”¨ç¬¬äºŒä¸ªéªŒè¯ç¨‹åº:\nåªæ·»åŠ äº†ä¸€å¥æ‰“å°æˆ‘ä»¬çš„ç»“æœå€¼,æˆ‘ä»¬çš„ç¨‹åºå´åœæ­¢äº†:\nè¿™ä¸ªç»“æœè¯æ˜æˆ‘ä»¬çš„å…¶ä»–çº¿ç¨‹æ˜¯èƒ½è·å–åˆ°æˆ‘ä»¬çš„æ›´æ–°åçš„ç»“æœå€¼çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸€å®šæ˜¯æœ‰å…¶ä»–åŸå› ã€‚\nçœŸç›¸å¤§ç™½ æˆ‘ä»¬ä¸Šé¢æ·»åŠ äº†ä¸€å¥è¯ï¼Œå¹¶æ²¡æœ‰å½±å“æˆ‘ä»¬çš„é€»è¾‘ï¼Œä½†æ˜¯å´äº§ç”Ÿäº†æˆªç„¶ä¸åŒçš„ç»“æœï¼Œè¿™ä¸ªåˆ°åº•æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬èƒ½æƒ³åˆ°çš„æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œçœ‹çœ‹æ·»åŠ ä»£ç å‰å’Œæ·»åŠ ä»£ç åï¼Œç¼–è¯‘å™¨ç¼–è¯‘ä¹‹åçš„ä»£ç æ˜¯ä»€ä¹ˆï¼Œç”±äºæˆ‘ä»¬ç”¨çš„æ˜¯ideaç›´æ¥æ‰“å¼€ideaçš„classæ–‡ä»¶ä¼šå¸®åŠ©æˆ‘ä»¬åšåç¼–è¯‘ã€‚\næ·»åŠ ä»£ç å‰:\næ·»åŠ ä»£ç å:\nè¿™é‡Œå¯ä»¥çœ‹è§ç¼–è¯‘å™¨å·²ç»å°†æˆ‘ä»¬çš„whileå¾ªç¯ä¼˜åŒ–æˆforå¾ªç¯ï¼Œåœ¨å¾ªç¯å†…éƒ¨æ·»åŠ äº†ä¸€ä¸ªè¾“å‡ºè¯­å¥ï¼Œè¿™é‡Œå¯ä»¥çœ‹è§é€»è¾‘å¹¶æ²¡æœ‰å¤ªå¤§çš„å˜åŒ–ï¼Œå¯ä»¥çœ‹è§ä¸æ˜¯æˆ‘ä»¬çš„ç¼–è¯‘å™¨ä½œæ€ªçš„é—®é¢˜ï¼Œè¿™ç§ä¼˜åŒ–ä»£ç çš„é—®é¢˜è¿˜æœ‰ä¸€ä¸ªå…ƒå‡¶é‚£å°±æ˜¯JITï¼Œç”±äºæˆ‘ä»¬çš„å¾ªç¯æœ‰å¾ˆå¤šæ¬¡è‚¯å®šä¼šè§¦å‘JITç¼–è¯‘ä¼˜åŒ–ã€‚\nç”±äºJITç¼–è¯‘ä¼˜åŒ–æœ‰å¤šä¸ªå±‚çº§ï¼Œè¿™é‡Œæˆ‘ä»¬åªçœ‹æœ€ç»ˆçš„C2ä¼˜åŒ–åçš„æ±‡ç¼–ä»£ç ,çœ‹JITçš„æ±‡ç¼–ä»£ç å¯ä»¥åˆ©ç”¨hsdis+JITWatchæŸ¥çœ‹ï¼Œè¿™é‡Œæˆ‘åªç”¨äº†hsdisæ‰“å°åœ¨æ§åˆ¶å°ä¸ŠæŸ¥çœ‹å³å¯ã€‚è¿™é‡Œéœ€è¦æ·»åŠ ä¸€ä¸‹JVMå¯åŠ¨å‚æ•°-XX:+UnlockDiagnosticVMOptions -XX:+PrintAssemblyï¼Œ å¯åŠ¨ä¹‹åä¸€å¤§å †æ±‡ç¼–ä»£ç ï¼Œä¸ºäº†çœ‹è¿™ä¸ªæŸ¥è¯¢äº†å¥½å¤šæ±‡ç¼–æŒ‡ä»¤ç»ˆäºæ˜¯æŠŠå®ƒç†é¡ºäº†ã€‚\n0x0000000112f81ce8: cmp $0x64,%r10d\r0x0000000112f81cec: jge 0x0000000112f81cfc ;*goto\r; - ThreadSafeCache::lambda$main$0@14 (line 29)\r0x0000000112f81cee: inc %ebx ; OopMap{rbp=Oop off=80}\r;*goto\r; - ThreadSafeCache::lambda$main$0@14 (line 29)\r0x0000000112f81cf0: test %eax,-0xb001cf6(%rip) # 0x0000000107f80000\r;*goto\r; - ThreadSafeCache::lambda$main$0@14 (line 29)\r; {poll}\r0x0000000112f81cf6: jmp 0x0000000112f81cee\rä¸Šé¢çš„è¿™ä¹ˆå¤šè¡Œä»£ç éƒ½æ˜¯æˆ‘ä»¬ä¸‹é¢:è¿™æ®µä»£ç çš„ç¿»è¯‘:\nwhile (threadSafeCache.getResult() \u0026lt; 100) { x++; } è§£é‡Šä¸€ä¸‹æ±‡ç¼–çš„ä»£ç :\n Step 1ï¼šæ¯”è¾ƒthreadSafeCache.getResult() å’Œ100çš„å¤§å° Step 2: threadSafeCache.getResult()å¦‚æœå¤§äºç­‰äº100ï¼Œè·³è½¬è‡³0x0000000112f81cfc,ä¹Ÿå°±æ˜¯å¾ªç¯å¤–çš„ä»£ç ã€‚ Step 3: å¦‚æœå°äºï¼Œé‚£ä¹ˆæ‰§è¡Œx++æ“ä½œã€‚ Step 4: æ£€æŸ¥å®‰å…¨ç‚¹checkpoint,è¿™é‡Œä¸æ˜¯é€»è¾‘ä»£ç ä¸éœ€è¦å¤ªå…³æ³¨ã€‚ Step 5: è·³è½¬è‡³æˆ‘ä»¬çš„Step3å¤„ã€‚  å¯ä»¥çœ‹è§æˆ‘ä»¬ä¸Šé¢çš„ä»£ç Step3-5ä¹‹é—´å½¢æˆäº†æ­»å¾ªç¯ï¼Œå…¶å®æˆ‘ä»¬çš„ä»£ç ç¿»è¯‘è¿‡æ¥å¯ä»¥çœ‹ä½œä¸‹é¢çš„ä»£ç ï¼š\nif(threadSafeCache.getResult() \u0026lt; 100){ while(true){ x++; } } å¯ä»¥çœ‹è§æˆ‘ä»¬çš„æ•´æ®µä»£ç åªæ‰§è¡Œäº†è¿™ä¸€æ¬¡geté€»è¾‘ï¼Œæœ‰å¯èƒ½getçš„æ—¶å€™æˆ‘ä»¬ä¸»çº¿ç¨‹è¿˜æ²¡æœ‰æ‰§è¡Œsetã€‚ ä¸ºä»€ä¹ˆé‡Œé¢åŠ äº†ä¸€æ®µæ‰“å°ä¹‹åå°±ä¸ä¼šæœ‰è¿™æ ·çš„æ•ˆæœå‘¢ï¼Ÿæˆ‘çš„çŒœæµ‹æ˜¯å¦‚æœåœ¨æˆ‘ä»¬printä¸­æœ‰syncåŠ é”æ“ä½œï¼Œjitä¼šå–æ¶ˆè¿™ç§æ¿€è¿›çš„ä¼˜åŒ–ï¼Œå½“ç„¶æˆ‘ä»¬çš„å˜é‡å¦‚æœæ˜¯volatileä¹Ÿä¼šæœ‰è¿™æ ·çš„æ•ˆæœï¼Œæˆ‘ä»¬æ·»åŠ volatileçš„jitçš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š\nå¯ä»¥å‘ç°è¿™é‡Œæ²¡æœ‰åšæ¿€è¿›çš„ä¼˜åŒ–è€Œæ˜¯æ¯æ¬¡éƒ½ä¼šè·å–æ–°çš„å€¼ï¼Œæ¥è¿›è¡Œæ¯”è¾ƒã€‚\næ€»ç»“ åˆ°æœ€åï¼Œæˆ‘ä¹Ÿæ²¡æœ‰æåŠï¼Œå¦‚ä½•å»æµ‹è¯•å¯è§æ€§ï¼Œå› ä¸ºè¿™ä¸ªä¸œè¥¿ç†è®ºä¸Šæ¥è¯´æ— æ³•å»æµ‹è¯•ï¼Œå› ä¸ºæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸€ç‚¹æˆ‘ä»¬æ²¡æ³•ç¡®å®šçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºï¼Œå½“ç„¶ä¹Ÿæœ‰ç¡®å®šçš„æ–¹å¼ï¼Œé‚£å°±æ˜¯åŠ ä¸€ä¸ªåŒæ­¥å™¨ï¼Œå¯ä»¥æ˜¯é”ï¼Œå¯ä»¥æ˜¯ä¿¡å·é‡ï¼Œè®©æˆ‘ä»¬çš„è¯»å–æ“ä½œ,åœ¨æˆ‘ä»¬å†™æ“ä½œä¹‹åï¼Œè¿˜æœ‰è¯»æ“ä½œä¸€å®šæ˜¯ä¸€æ¬¡ï¼Œä¸èƒ½ä½¿ç”¨å¾ªç¯ï¼Œæˆ‘å°è¯•ç€æŒ‰ç…§è¿™ä¸ªæ€è·¯å»å†™ï¼š\npublic class Test { private static /*volatile*/ boolean stop = false; public static void main(String[] args) throws Exception { CountDownLatch countDownLatch = new CountDownLatch(1); Thread t = new Thread(new Runnable() { public void run() { try { countDownLatch.await(); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(stop); } }); t.start(); Thread.sleep(1000); TimeUnit.SECONDS.sleep(1); System.out.println(\u0026#34;Stop Thread\u0026#34;); stop = true; countDownLatch.countDown(); } } ä¸Šé¢è¿™ä¸ªç¨‹åºæ²¡æœ‰åŠ volatile,é‚£ä¹ˆè¾“å‡ºç»“æœæ˜¯æœ‰ä¸€å®šå¯èƒ½æ˜¯falseçš„ä½†æ˜¯å‘ç°ï¼Œæ‰€æœ‰ç»“æœæ˜¯trueï¼Œå…¶å®è¿™ç§æ–¹å¼æ²¡æ³•å»æµ‹è¯•ï¼Œå› ä¸ºæˆ‘ä»¬å¤–åŠ äº†åŒæ­¥å™¨è€Œæˆ‘ä»¬çš„åŒæ­¥å™¨ä¼šå¸¦æ¥è¯»å†™å±éšœçš„åŠ å…¥ï¼Œå¦‚æœæ˜¯è¯»å±éšœé‚£ä¹ˆä¼šå‘Šè¯‰å¤„ç†å™¨åœ¨æ‰§è¡Œä»»ä½•çš„åŠ è½½å‰ï¼Œå…ˆåº”ç”¨æ‰€æœ‰å·²ç»åœ¨å¤±æ•ˆé˜Ÿåˆ—ä¸­çš„å¤±æ•ˆæ“ä½œçš„æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ä¼šæ‰§è¡Œå¤±æ•ˆï¼Œå›åˆ·ç¼“å­˜ã€‚\næ‰€ä»¥éªŒè¯å¯è§æ€§çš„ç¡®æ²¡æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¦‚æœæ²¡æœ‰å…¶ä»–ä¿éšœ(è¯»å†™å±éšœç­‰)ï¼Œæœ‰å¯èƒ½ä¸èƒ½è·å–åˆ°æœ€æ–°çš„æ•°æ®ï¼Œä½†æ˜¯å…¶æœ€ç»ˆä¼šè·å–åˆ°æ›´æ–°çš„æ•°æ®ï¼Œè¿™ä¸ªä¹Ÿå¾ˆåƒæˆ‘ä»¬åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸­çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚\næœ€åå¤§å®¶ä¹Ÿå¯ä»¥çœ‹çœ‹é›¶åº¦çš„è¿™ç¯‡æ–‡ç« ï¼šhttps://mp.weixin.qq.com/s/i9ES7u5MPWCv1n8jYU_q_wï¼Œå…¶ä¸­çš„å¯¹å†…å­˜å±éšœå’Œhappens-beforeä¹Ÿæœ‰ä¸€å®šçš„è®²è§£ã€‚\nè½¬è‡ª ä½ äº†è§£çš„å¯è§æ€§å¯èƒ½æ˜¯é”™çš„ï¼\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E8%BD%AC%E4%BD%A0%E4%BA%86%E8%A7%A3%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7%E5%8F%AF%E8%83%BD%E6%98%AF%E9%94%99%E7%9A%84/","series":["Manual"],"tags":["Java"],"title":"ã€è½¬ã€‘ä½ äº†è§£çš„å¯è§æ€§å¯èƒ½æ˜¯é”™çš„"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ä¸€ä¸ªSQLæ‰§è¡Œçš„å¾ˆæ…¢ï¼Œæˆ‘ä»¬è¦åˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼š\nå¤§å¤šæ•°æƒ…å†µä¸‹å¾ˆæ­£å¸¸ï¼Œå¶å°”å¾ˆæ…¢  æ•°æ®åº“åœ¨åˆ·æ–°è„é¡µï¼Œä¾‹å¦‚ redo log å†™æ»¡äº†éœ€è¦åŒæ­¥åˆ°ç£ç›˜ã€‚  å½“æˆ‘ä»¬è¦å¾€æ•°æ®åº“æ’å…¥ä¸€æ¡æ•°æ®ã€æˆ–è€…è¦æ›´æ–°ä¸€æ¡æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬çŸ¥é“æ•°æ®åº“ä¼šåœ¨å†…å­˜ä¸­æŠŠå¯¹åº”å­—æ®µçš„æ•°æ®æ›´æ–°äº†ï¼Œä½†æ˜¯æ›´æ–°ä¹‹åï¼Œè¿™äº›æ›´æ–°çš„å­—æ®µå¹¶ä¸ä¼šé©¬ä¸ŠåŒæ­¥æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­å»ï¼Œè€Œæ˜¯æŠŠè¿™äº›æ›´æ–°çš„è®°å½•å†™å…¥åˆ° redo log æ—¥è®°ä¸­å»ï¼Œç­‰åˆ°ç©ºé—²çš„æ—¶å€™ï¼Œåœ¨é€šè¿‡ redo log é‡Œçš„æ—¥è®°æŠŠæœ€æ–°çš„æ•°æ®åŒæ­¥åˆ°ç£ç›˜ä¸­å»ã€‚å†™redo logæ˜¯é¡ºåºio\n æ‰§è¡Œçš„æ—¶å€™ï¼Œé‡åˆ°é”ï¼Œå¦‚è¡¨é”ã€è¡Œé”ã€‚  è¿™æ¡ SQL è¯­å¥ä¸€ç›´æ‰§è¡Œçš„å¾ˆæ…¢  æ²¡æœ‰ç”¨ä¸Šç´¢å¼•ï¼šä¾‹å¦‚è¯¥å­—æ®µæ²¡æœ‰ç´¢å¼•ï¼›ç”±äºå¯¹å­—æ®µè¿›è¡Œè¿ç®—ã€å‡½æ•°æ“ä½œå¯¼è‡´æ— æ³•ç”¨ç´¢å¼•ã€‚ æ•°æ®åº“é€‰é”™äº†ç´¢å¼•ã€‚  å‚è€ƒé“¾æ¥ï¼š è…¾è®¯é¢è¯•ï¼šä¸€æ¡SQLè¯­å¥æ‰§è¡Œå¾—å¾ˆæ…¢çš„åŸå› æœ‰å“ªäº›ï¼Ÿ\u0026mdash;ä¸çœ‹åæ‚”ç³»åˆ—\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mysql/%E4%B8%80%E4%B8%AAsql%E6%89%A7%E8%A1%8C%E7%9A%84%E5%BE%88%E6%85%A2/","series":["Manual"],"tags":["MySQL"],"title":"ä¸€ä¸ªSQLæ‰§è¡Œçš„å¾ˆæ…¢"},{"categories":["æŒç»­é›†æˆéƒ¨ç½²"],"content":"ä¸ºdockerå®¹å™¨å®‰è£…å·¥å…·\nå› ä¸ºæˆ‘çš„docker jenkinséœ€è¦nodeç¯å¢ƒï¼Œé»˜è®¤æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥æœ€åˆæƒ³æ³•æ˜¯å’Œmavenä¸€æ ·ï¼Œå°†å®¿ä¸»æœºçš„mavenå’Œdockerä¸€èµ·å…±äº«ä½¿ç”¨ï¼Œä½†æ˜¯ä¸ç®¡æ€ä¹ˆæ“ä½œå°±ä¸è¡Œï¼Œå¾ˆè¯¡å¼‚ï¼ŒåŒæ ·çš„æ“ä½œï¼Œmavenå¯ä»¥æ‰§è¡Œï¼Œjdkå’Œnodeå´ä¸è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nversion: \u0026#39;3\u0026#39; services: jenkins: image: jenkinsci/blueocean deploy: resources: limits: cpus: \u0026#39;0.50\u0026#39; memory: 1024M reservations: memory: 64M container_name: jenkins user: root ports: - \u0026#39;8080:8080\u0026#39; - \u0026#39;50000:50000\u0026#39; volumes: - \u0026#39;/docker/volumes/jenkins:/var/jenkins_home\u0026#39; - \u0026#39;/var/run/docker.sock:/var/run/docker.sock\u0026#39; - \u0026#39;/usr/local/jdk1.8.0_241:/usr/local/jdk1.8.0_241\u0026#39; - \u0026#39;/usr/local/apache-maven-3.6.3:/usr/local/apache-maven-3.6.3\u0026#39; - \u0026#39;/usr/bin/docker:/usr/bin/docker\u0026#39; - \u0026#39;/usr/local/node-v12.16.3-linux-x64:/usr/local/node-v12.16.3-linux-x64\u0026#39; restart: always  æ›´è¯¡å¼‚çš„æ˜¯ï¼Œè™½ç„¶dockerä¸‹æ— æ³•æ‰§è¡Œnodeå‘½ä»¤ï¼Œjenkinså´èƒ½è°ƒç”¨ï¼š\nè¿™é‡Œæš‚ä¸”ä¸ç®¡ï¼Œè¯·å½“ä½œdockeræ²¡æœ‰nodeç¯å¢ƒï¼Œç»§ç»­å¾€ä¸‹é˜…è¯»ã€‚\n ç»è¿‡å½»å¤œæœªçœ çš„æ’é™¤ï¼ŒåŸºæœ¬èƒ½å®šä½ä¸ºé¢˜çš„åŸå› ï¼šæœ¬è´¨ä¸æ˜¯nodeå‘½ä»¤æ‰¾ä¸åˆ°ï¼Œè€Œæ˜¯nodeçš„ä¾èµ–åœ¨dockerå®¹å™¨é‡Œé¢æ‰¾ä¸åˆ°ï¼Œnodeä¾èµ–å¦‚ä¸‹ï¼š\næ‰€ä»¥è¦ä¹ˆè¿›å…¥åˆ°å®¹å™¨é‡Œé¢ä½¿ç”¨apk addï¼Œè¦ä¹ˆè‡ªå·±åˆ¶ä½œé•œåƒï¼ˆè¿™æ ·å¤ªéº»çƒ¦äº†ï¼‰ï¼Œæˆ‘é€‰æ‹©å‰è€…ã€‚\nè¿›å…¥åˆ°å®¹å™¨é‡Œé¢å®‰è£…ï¼š\napk add --no-cache nodejs  å¯èƒ½ä¼šé‡åˆ°ä¸‹è½½ç¼“æ…¢ã€æ‰¾ä¸åˆ°åŒ…ç­‰é—®é¢˜ã€‚\n è§£å†³åŠæ³•å¦‚ä¸‹ï¼š\n åœ¨ https://mirrors.alpinelinux.org/\ræ‰¾åˆ°ä¸­å›½çš„é•œåƒä»“åº“ï¼Œå¹¶æ·»åŠ åˆ° etc/apk/repositories, å‚è€ƒå¦‚ä¸‹ï¼š A. æ°¸ä¹…ä¿®æ”¹ä¸‹è½½æº\nvi etc/apk/repositories http://mirrors.aliyun.com/alpine/v3.8/main/ http://mirrors.aliyun.com/alpine/v3.8/community/ apk update B. ä¸´æ—¶ä¿®æ”¹ä¸‹è½½æºåœ°å€ å¦‚æœä¸Šé¢çš„æ°¸ä¹…æºåœ°å€æ‰¾ä¸åˆ°å¯¹åº”çš„åŒ…ï¼Œå¯ä½¿ç”¨æœ¬æ–¹æ³•ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š B.1. å…ˆé€šè¿‡ https://pkgs.alpinelinux.org/packages\ræ‰¾åˆ°ä½ è¦ä¸‹è½½çš„packageå¯¹åº”çš„Branchå’ŒRepositoryã€‚ B.2. æ·»åŠ package\napk add gradle --repository http://mirrors.tuna.tsinghua.edu.cn/alpine/edge/community  å‚è€ƒé“¾æ¥ï¼š https://pkgs.alpinelinux.org/packages\rhttps://mirrors.alpinelinux.org/\rhttps://www.cnblogs.com/sunsky303/p/11548343.html\rhttps://my.oschina.net/u/1422143/blog/1858790\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/cicd/%E4%B8%BAdocker%E5%AE%B9%E5%99%A8%E5%AE%89%E8%A3%85%E5%B7%A5%E5%85%B7/","series":null,"tags":["docker"],"title":"ä¸ºdockerå®¹å™¨å®‰è£…å·¥å…·"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ä¸ºä»€ä¹ˆéœ€è¦protobuf  protobufé‡‡ç”¨å­—èŠ‚ç¼–ç ï¼Œè€Œjson, xmléƒ½æ˜¯å­—ç¬¦ç¼–ç ï¼Œå­—èŠ‚ç¼–ç æ›´åŠ èŠ‚çœç©ºé—´ é‡‡ç”¨äº†varintç¼–ç ï¼Œè¿›ä¸€æ­¥é™ä½äº†ç¼–ç åçš„ç©ºé—´å¤§å°  Varintå°±æ˜¯ä¸€ç§å¯¹æ•°å­—è¿›è¡Œç¼–ç çš„æ–¹æ³•ï¼Œç¼–ç åäºŒè¿›åˆ¶æ•°æ®æ˜¯ä¸å®šé•¿çš„ï¼Œæ•°å€¼è¶Šå°çš„æ•°å­—ä½¿ç”¨çš„å­—èŠ‚æ•°è¶Šå°‘ã€‚ä¾‹å¦‚å¯¹äºint32_tï¼Œé‡‡ç”¨Varintç¼–ç åéœ€è¦1~5ä¸ªbytesï¼Œå°çš„æ•°å­—ä½¿ç”¨1ä¸ªbyteï¼Œå¤§çš„æ•°å­—ä½¿ç”¨5ä¸ªbytesã€‚åŸºäºå®é™…åœºæ™¯ä¸­å°æ•°å­—çš„ä½¿ç”¨è¿œè¿œå¤šäºå¤§æ•°å­—ï¼Œå› æ­¤é€šè¿‡Varintç¼–ç å¯¹äºå¤§éƒ¨åˆ†åœºæ™¯éƒ½å¯ä»¥èµ·åˆ°ä¸€ä¸ªå‹ç¼©çš„æ•ˆæœã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E6%8B%BE%E9%81%97/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81protobuf/","series":["Manual"],"tags":["Other"],"title":"ä¸ºä»€ä¹ˆéœ€è¦protobuf"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‚è€ƒé“¾æ¥ï¼š æ‰‹æŠŠæ‰‹å¸¦ä½ å®æˆ˜ä¸‹Springçš„ä¸ƒç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º\rSpringçš„PROPAGATION_NESTEDå’ŒPROPAGATION_REQUIRES_NEWçš„åŒºåˆ«ï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E5%AE%9E%E6%88%98/","series":["Manual"],"tags":["Spring"],"title":"äº‹åŠ¡ä¼ æ’­å®æˆ˜"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"äº‹åŠ¡å…·æœ‰åŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼‰ã€æŒä¹…æ€§ï¼ˆDurabilityï¼‰å››ä¸ªç‰¹æ€§ï¼Œç®€ç§° ACIDï¼Œç¼ºä¸€ä¸å¯ã€‚ä»Šå¤©è¦è¯´çš„å°±æ˜¯éš”ç¦»æ€§ã€‚\n1. æ¦‚å¿µè¯´æ˜ ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µæ˜¯äº‹åŠ¡éš”ç¦»çº§åˆ«è¦å®é™…è§£å†³çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ææ¸…æ¥šéƒ½æ˜¯ä»€ä¹ˆæ„æ€ã€‚\nè„è¯» è„è¯»æŒ‡çš„æ˜¯è¯»åˆ°äº†å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼Œæœªæäº¤æ„å‘³ç€è¿™äº›æ•°æ®å¯èƒ½ä¼šå›æ»šï¼Œä¹Ÿå°±æ˜¯å¯èƒ½æœ€ç»ˆä¸ä¼šå­˜åˆ°æ•°æ®åº“ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸å­˜åœ¨çš„æ•°æ®ã€‚è¯»åˆ°äº†å¹¶ä¸€å®šæœ€ç»ˆå­˜åœ¨çš„æ•°æ®ï¼Œè¿™å°±æ˜¯è„è¯»ã€‚\nå¯é‡å¤è¯» å¯é‡å¤è¯»æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ï¼Œæœ€å¼€å§‹è¯»åˆ°çš„æ•°æ®å’Œäº‹åŠ¡ç»“æŸå‰çš„ä»»æ„æ—¶åˆ»è¯»åˆ°çš„åŒä¸€æ‰¹æ•°æ®éƒ½æ˜¯ä¸€è‡´çš„ã€‚é€šå¸¸é’ˆå¯¹æ•°æ®**æ›´æ–°ï¼ˆUPDATEï¼‰**æ“ä½œã€‚\nä¸å¯é‡å¤è¯» å¯¹æ¯”å¯é‡å¤è¯»ï¼Œä¸å¯é‡å¤è¯»æŒ‡çš„æ˜¯åœ¨åŒä¸€äº‹åŠ¡å†…ï¼Œä¸åŒçš„æ—¶åˆ»è¯»åˆ°çš„åŒä¸€æ‰¹æ•°æ®å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¯èƒ½ä¼šå—åˆ°å…¶ä»–äº‹åŠ¡çš„å½±å“ï¼Œæ¯”å¦‚å…¶ä»–äº‹åŠ¡æ”¹äº†è¿™æ‰¹æ•°æ®å¹¶æäº¤äº†ã€‚é€šå¸¸é’ˆå¯¹æ•°æ®**æ›´æ–°ï¼ˆUPDATEï¼‰**æ“ä½œã€‚\nå¹»è¯» å¹»è¯»æ˜¯é’ˆå¯¹æ•°æ®**æ’å…¥ï¼ˆINSERTï¼‰**æ“ä½œæ¥è¯´çš„ã€‚å‡è®¾äº‹åŠ¡Aå¯¹æŸäº›è¡Œçš„å†…å®¹ä½œäº†æ›´æ”¹ï¼Œä½†æ˜¯è¿˜æœªæäº¤ï¼Œæ­¤æ—¶äº‹åŠ¡Bæ’å…¥äº†ä¸äº‹åŠ¡Aæ›´æ”¹å‰çš„è®°å½•ç›¸åŒçš„è®°å½•è¡Œï¼Œå¹¶ä¸”åœ¨äº‹åŠ¡Aæäº¤ä¹‹å‰å…ˆæäº¤äº†ï¼Œè€Œè¿™æ—¶ï¼Œåœ¨äº‹åŠ¡Aä¸­æŸ¥è¯¢ï¼Œä¼šå‘ç°å¥½åƒåˆšåˆšçš„æ›´æ”¹å¯¹äºæŸäº›æ•°æ®æœªèµ·ä½œç”¨ï¼Œä½†å…¶å®æ˜¯äº‹åŠ¡Båˆšæ’å…¥è¿›æ¥çš„ï¼Œè®©ç”¨æˆ·æ„Ÿè§‰å¾ˆé­”å¹»ï¼Œæ„Ÿè§‰å‡ºç°äº†å¹»è§‰ï¼Œè¿™å°±å«å¹»è¯»ã€‚\n2. äº‹åŠ¡éš”ç¦»çº§åˆ« SQL æ ‡å‡†å®šä¹‰äº†å››ç§éš”ç¦»çº§åˆ«ï¼ŒMySQL å…¨éƒ½æ”¯æŒã€‚è¿™å››ç§éš”ç¦»çº§åˆ«åˆ†åˆ«æ˜¯ï¼š\n è¯»æœªæäº¤ï¼ˆREAD UNCOMMITTEDï¼‰ è¯»æäº¤ ï¼ˆREAD COMMITTEDï¼‰ å¯é‡å¤è¯» ï¼ˆREPEATABLE READï¼‰ ä¸²è¡ŒåŒ– ï¼ˆSERIALIZABLEï¼‰  ä»ä¸Šå¾€ä¸‹ï¼Œéš”ç¦»å¼ºåº¦é€æ¸å¢å¼ºï¼Œæ€§èƒ½é€æ¸å˜å·®ã€‚é‡‡ç”¨å“ªç§éš”ç¦»çº§åˆ«è¦æ ¹æ®ç³»ç»Ÿéœ€æ±‚æƒè¡¡å†³å®šï¼Œå…¶ä¸­ï¼Œå¯é‡å¤è¯»æ˜¯ MySQL çš„é»˜è®¤çº§åˆ«ã€‚\näº‹åŠ¡éš”ç¦»å…¶å®å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šé¢æåˆ°çš„è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»è¿™å‡ ä¸ªé—®é¢˜ï¼Œä¸‹é¢å±•ç¤ºäº† 4 ç§éš”ç¦»çº§åˆ«å¯¹è¿™ä¸‰ä¸ªé—®é¢˜çš„è§£å†³ç¨‹åº¦ã€‚\nåªæœ‰ä¸²è¡ŒåŒ–çš„éš”ç¦»çº§åˆ«è§£å†³äº†å…¨éƒ¨è¿™ 3 ä¸ªé—®é¢˜ï¼Œå…¶ä»–çš„ 3 ä¸ªéš”ç¦»çº§åˆ«éƒ½æœ‰ç¼ºé™·ã€‚\n3. æ ‡å‡†SQLäº‹åŠ¡éš”ç¦»çº§åˆ«å®ç°åŸç† æˆ‘ä»¬ä¸Šé¢é‡åˆ°çš„é—®é¢˜å…¶å®å°±æ˜¯å¹¶å‘äº‹åŠ¡ä¸‹çš„æ§åˆ¶é—®é¢˜ï¼Œè§£å†³å¹¶å‘äº‹åŠ¡çš„æœ€å¸¸è§æ–¹å¼å°±æ˜¯æ‚²è§‚å¹¶å‘æ§åˆ¶äº†ï¼ˆä¹Ÿå°±æ˜¯æ•°æ®åº“ä¸­çš„é”ï¼‰ã€‚æ ‡å‡†SQLäº‹åŠ¡éš”ç¦»çº§åˆ«çš„å®ç°æ˜¯ä¾èµ–é”çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼š\n   äº‹åŠ¡éš”ç¦»çº§åˆ« å®ç°æ–¹å¼     æœªæäº¤è¯»ï¼ˆRUï¼‰ äº‹åŠ¡å¯¹å½“å‰è¢«è¯»å–çš„æ•°æ®ä¸åŠ é”ï¼›äº‹åŠ¡åœ¨æ›´æ–°æŸæ•°æ®çš„ç¬é—´ï¼ˆå°±æ˜¯å‘ç”Ÿæ›´æ–°çš„ç¬é—´ï¼‰ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡Œçº§å…±äº«é”ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ã€‚   æäº¤è¯»ï¼ˆRCï¼‰ äº‹åŠ¡å¯¹å½“å‰è¢«è¯»å–çš„æ•°æ®åŠ è¡Œçº§å…±äº«é”ï¼ˆå½“è¯»åˆ°æ—¶æ‰åŠ é”ï¼‰ï¼Œä¸€æ—¦è¯»å®Œè¯¥è¡Œï¼Œç«‹å³é‡Šæ”¾è¯¥è¡Œçº§å…±äº«é”ï¼›äº‹åŠ¡åœ¨æ›´æ–°æŸæ•°æ®çš„ç¬é—´ï¼ˆå°±æ˜¯å‘ç”Ÿæ›´æ–°çš„ç¬é—´ï¼‰ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡Œçº§æ’ä»–é”ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ã€‚   å¯é‡å¤è¯»ï¼ˆRRï¼‰ äº‹åŠ¡åœ¨è¯»å–æŸæ•°æ®çš„ç¬é—´ï¼ˆå°±æ˜¯å¼€å§‹è¯»å–çš„ç¬é—´ï¼‰ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡Œçº§å…±äº«é”ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ï¼›äº‹åŠ¡åœ¨æ›´æ–°æŸæ•°æ®çš„ç¬é—´ï¼ˆå°±æ˜¯å‘ç”Ÿæ›´æ–°çš„ç¬é—´ï¼‰ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡Œçº§æ’ä»–é”ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ã€‚   åºåˆ—åŒ–è¯»ï¼ˆSï¼‰ äº‹åŠ¡åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡¨çº§å…±äº«é” ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ï¼›äº‹åŠ¡åœ¨æ›´æ–°æ•°æ®æ—¶ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡¨çº§æ’ä»–é” ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ã€‚    å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åªä½¿ç”¨é”æ¥å®ç°éš”ç¦»çº§åˆ«çš„æ§åˆ¶çš„æ—¶å€™ï¼Œéœ€è¦é¢‘ç¹çš„åŠ é”è§£é”ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‘ç”Ÿè¯»å†™çš„å†²çªï¼ˆä¾‹å¦‚åœ¨RCçº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Aæ›´æ–°äº†æ•°æ®è¡Œ1ï¼Œäº‹åŠ¡Båˆ™åœ¨äº‹åŠ¡Aæäº¤å‰è¯»å–æ•°æ®è¡Œ1éƒ½è¦ç­‰å¾…äº‹åŠ¡Aæäº¤å¹¶é‡Šæ”¾é”ï¼‰ã€‚\nä¸ºäº†ä¸åŠ é”è§£å†³è¯»å†™å†²çªçš„é—®é¢˜ï¼ŒMySQLå¼•å…¥äº†MVCCæœºåˆ¶ï¼Œè¯¦ç»†å¯è§æˆ‘ä»¥å‰çš„åˆ†ææ–‡ç« ï¼šä¸€æ–‡è¯»æ‡‚æ•°æ®åº“ä¸­çš„ä¹è§‚é”å’Œæ‚²è§‚é”å’ŒMVCC\rã€‚\n å…±äº«é”ã€æ’ä»–é”éƒ½æ˜¯æ‚²è§‚é”ã€‚\n 4. InnoDBäº‹åŠ¡éš”ç¦»çº§åˆ«å®ç°åŸç† åœ¨å¾€ä¸‹åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å‡ ä¸ªæ¦‚å¿µéœ€è¦å…ˆäº†è§£ä¸‹ï¼š\n1ã€é”å®šè¯»å’Œä¸€è‡´æ€§éé”å®šè¯» é”å®šè¯»ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä¸»åŠ¨ç»™è¯»åŠ é”ï¼Œå¦‚SELECT \u0026hellip; LOCK IN SHARE MODE å’Œ SELECT \u0026hellip; FOR UPDATEã€‚åˆ†åˆ«åŠ ä¸Šäº†è¡Œå…±äº«é”å’Œè¡Œæ’ä»–é”ã€‚15.7.2.4 Locking Reads\rä¸€è‡´æ€§éé”å®šè¯»ï¼šInnoDBä½¿ç”¨MVCCå‘äº‹åŠ¡çš„æŸ¥è¯¢æä¾›æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®åº“å¿«ç…§ã€‚æŸ¥è¯¢ä¼šçœ‹åˆ°åœ¨è¯¥æ—¶é—´ç‚¹ä¹‹å‰æäº¤çš„äº‹åŠ¡æ‰€åšçš„æ›´æ”¹ï¼Œè€Œä¸ä¼šçœ‹åˆ°ç¨åæˆ–æœªæäº¤çš„äº‹åŠ¡æ‰€åšçš„æ›´æ”¹ï¼ˆæœ¬äº‹åŠ¡é™¤å¤–ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨å¼€å§‹äº†äº‹åŠ¡ä¹‹åï¼Œäº‹åŠ¡çœ‹åˆ°çš„æ•°æ®å°±éƒ½æ˜¯äº‹åŠ¡å¼€å¯é‚£ä¸€åˆ»çš„æ•°æ®äº†ï¼Œå…¶ä»–äº‹åŠ¡çš„åç»­ä¿®æ”¹ä¸ä¼šåœ¨æœ¬æ¬¡äº‹åŠ¡ä¸­å¯è§ã€‚\nConsistent readæ˜¯InnoDBåœ¨RCå’ŒRRéš”ç¦»çº§åˆ«å¤„ç†SELECTè¯­å¥çš„é»˜è®¤æ¨¡å¼ã€‚ä¸€è‡´æ€§éé”å®šè¯»ä¸ä¼šå¯¹å…¶è®¿é—®çš„è¡¨è®¾ç½®ä»»ä½•é”ï¼Œå› æ­¤ï¼Œåœ¨å¯¹è¡¨æ‰§è¡Œä¸€è‡´æ€§éé”å®šè¯»çš„åŒæ—¶ï¼Œå…¶å®ƒäº‹åŠ¡å¯ä»¥åŒæ—¶å¹¶å‘çš„è¯»å–æˆ–è€…ä¿®æ”¹å®ƒä»¬ã€‚15.7.2.3 Consistent Nonlocking Reads\r2ã€å½“å‰è¯»å’Œå¿«ç…§è¯» å½“å‰è¯»\nè¯»å–çš„æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼ŒåƒUPDATEã€DELETEã€INSERTã€SELECT \u0026hellip; LOCK IN SHARE MODEã€SELECT \u0026hellip; FOR UPDATEè¿™äº›æ“ä½œéƒ½æ˜¯ä¸€ç§å½“å‰è¯»ï¼Œä¸ºä»€ä¹ˆå«å½“å‰è¯»ï¼Ÿå°±æ˜¯å®ƒè¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè¯»å–æ—¶è¿˜è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œä¼šå¯¹è¯»å–çš„è®°å½•è¿›è¡ŒåŠ é”ã€‚\nå¿«ç…§è¯»\nè¯»å–çš„æ˜¯å¿«ç…§ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯å†å²ç‰ˆæœ¬ï¼Œåƒä¸åŠ é”çš„SELECTæ“ä½œå°±æ˜¯å¿«ç…§è¯»ï¼Œå³ä¸åŠ é”çš„éé˜»å¡è¯»ï¼›å¿«ç…§è¯»çš„å‰ææ˜¯éš”ç¦»çº§åˆ«ä¸æ˜¯æœªæäº¤è¯»å’Œåºåˆ—åŒ–è¯»çº§åˆ«ï¼Œå› ä¸ºæœªæäº¤è¯»æ€»æ˜¯è¯»å–æœ€æ–°çš„æ•°æ®è¡Œï¼Œè€Œä¸æ˜¯ç¬¦åˆå½“å‰äº‹åŠ¡ç‰ˆæœ¬çš„æ•°æ®è¡Œï¼Œè€Œåºåˆ—åŒ–è¯»åˆ™ä¼šå¯¹è¡¨åŠ é”ã€‚\n3ã€éšå¼é”å®šå’Œæ˜¾å¼é” éšå¼é”å®š\nInnoDBåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ä¸¤é˜¶æ®µé”åè®®ï¼ˆä¸ä¸»åŠ¨è¿›è¡Œæ˜¾ç¤ºé”å®šçš„æƒ…å†µï¼‰ï¼š\n éšæ—¶éƒ½å¯ä»¥æ‰§è¡Œé”å®šï¼ŒInnoDBä¼šæ ¹æ®éš”ç¦»çº§åˆ«åœ¨éœ€è¦çš„æ—¶å€™è‡ªåŠ¨åŠ é”ï¼› é”åªæœ‰åœ¨æ‰§è¡Œcommitæˆ–è€…rollbackçš„æ—¶å€™æ‰ä¼šé‡Šæ”¾ï¼Œå¹¶ä¸”æ‰€æœ‰çš„é”éƒ½æ˜¯åœ¨åŒä¸€æ—¶åˆ»è¢«é‡Šæ”¾ã€‚  æ˜¾å¼é”å®š\n InnoDBä¹Ÿæ”¯æŒé€šè¿‡ç‰¹å®šçš„è¯­å¥è¿›è¡Œæ˜¾ç¤ºé”å®šï¼ˆå­˜å‚¨å¼•æ“å±‚ï¼‰  select ... lock in share mode //å…±äº«é” select ... for update //æ’ä»–é”  MySQL Serverå±‚çš„æ˜¾ç¤ºé”å®šï¼š  lock table unlock table äº†è§£å®Œä¸Šé¢çš„æ¦‚å¿µåï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹InnoDBçš„äº‹åŠ¡å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼ˆä¸‹é¢çš„è¯»éƒ½æŒ‡çš„æ˜¯éä¸»åŠ¨åŠ é”çš„selectï¼‰\n   äº‹åŠ¡éš”ç¦»çº§åˆ« å®ç°æ–¹å¼     æœªæäº¤è¯»ï¼ˆRUï¼‰ äº‹åŠ¡å¯¹å½“å‰è¢«è¯»å–çš„æ•°æ®ä¸åŠ é”ï¼Œéƒ½æ˜¯å½“å‰è¯»ï¼›äº‹åŠ¡åœ¨æ›´æ–°æŸæ•°æ®çš„ç¬é—´ï¼ˆå°±æ˜¯å‘ç”Ÿæ›´æ–°çš„ç¬é—´ï¼‰ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡Œçº§å…±äº«é”ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ã€‚   æäº¤è¯»ï¼ˆRCï¼‰ äº‹åŠ¡å¯¹å½“å‰è¢«è¯»å–çš„æ•°æ®ä¸åŠ é”ï¼Œä¸”æ˜¯å¿«ç…§è¯»ï¼›äº‹åŠ¡åœ¨æ›´æ–°æŸæ•°æ®çš„ç¬é—´ï¼ˆå°±æ˜¯å‘ç”Ÿæ›´æ–°çš„ç¬é—´ï¼‰ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡Œçº§æ’ä»–é”ï¼ˆRecordï¼‰ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ã€‚é€šè¿‡å¿«ç…§ï¼ˆMVCCï¼‰ï¼Œåœ¨è¿™ä¸ªçº§åˆ«MySQLå°±è§£å†³äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜   å¯é‡å¤è¯»ï¼ˆRRï¼‰ äº‹åŠ¡å¯¹å½“å‰è¢«è¯»å–çš„æ•°æ®ä¸åŠ é”ï¼Œä¸”æ˜¯å¿«ç…§è¯»ï¼›äº‹åŠ¡åœ¨æ›´æ–°æŸæ•°æ®çš„ç¬é—´ï¼ˆå°±æ˜¯å‘ç”Ÿæ›´æ–°çš„ç¬é—´ï¼‰ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡Œçº§æ’ä»–é”ï¼ˆRecordï¼ŒGAPï¼ŒNext-Keyï¼‰ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ã€‚é€šè¿‡é—´éš™é”ï¼Œåœ¨è¿™ä¸ªçº§åˆ«MySQLå°±è§£å†³äº†å¹»è¯»çš„é—®é¢˜   åºåˆ—åŒ–è¯»ï¼ˆSï¼‰ äº‹åŠ¡åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡¨çº§å…±äº«é” ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ï¼Œéƒ½æ˜¯å½“å‰è¯»ï¼›äº‹åŠ¡åœ¨æ›´æ–°æ•°æ®æ—¶ï¼Œå¿…é¡»å…ˆå¯¹å…¶åŠ è¡¨çº§æ’ä»–é” ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾ã€‚    å¯ä»¥çœ‹åˆ°ï¼ŒInnoDBé€šè¿‡MVCCå¾ˆå¥½çš„è§£å†³äº†è¯»å†™å†²çªçš„é—®é¢˜ï¼Œè€Œä¸”æå‰ä¸€ä¸ªçº§åˆ«å°±è§£å†³äº†æ ‡å‡†çº§åˆ«ä¸‹ä¼šå‡ºç°çš„å¹»è¯»å’Œä¸å¯é‡å¤è¯»é—®é¢˜ï¼Œå¤§å¤§æå‡äº†æ•°æ®åº“çš„å¹¶å‘èƒ½åŠ›ã€‚\nå‚è€ƒè¿æ¥ï¼š\næ·±å…¥ç†è§£MySQLä¸­äº‹åŠ¡éš”ç¦»çº§åˆ«çš„å®ç°åŸç†\rMySQLäº‹åŠ¡éš”ç¦»çº§åˆ«å’Œå®ç°åŸç†ï¼ˆçœ‹è¿™ä¸€ç¯‡æ–‡ç« å°±å¤Ÿäº†ï¼ï¼‰\rInnodbä¸­çš„äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œé”çš„å…³ç³»\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mysql/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8C%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/","series":["Manual"],"tags":["MySQL"],"title":"äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œå®ç°åŸç†"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä»é›¶æ­å»ºK8S\næœºå™¨å‡†å¤‡    åç§° æ•°é‡ IP å¤‡æ³¨     master 1 172.17.0.14 æ“ä½œç³»ç»Ÿ: Linux(centos7, å…¶å®ƒæ“ä½œç³»ç»Ÿä¹Ÿå¯, å®‰è£…è¿‡ç¨‹ç±»ä¼¼, å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£) æœºå™¨é…ç½®: 4C8G   node1 1 172.18.0.7 åŒä¸Š   node2 1 172.19.0.5 åŒä¸Š    ç”±äºæœ¬äººå¾ˆç©·ï¼Œè¿™å‡ å°æœºå™¨æ˜¯åˆ†åˆ«å±äºä¸åŒçš„è…¾è®¯äº‘è´¦å·ï¼Œä¸åŒçš„è´¦å·ä¹‹é—´ä¸èƒ½å†…ç½‘é€šä¿¡ï¼Œä¸è¿‡å¯ä»¥é€šè¿‡å»ºç«‹â€œå¯¹ç­‰è¿æ¥â€å®ç°é€šä¿¡ï¼Œæ¯”ç›´æ¥ç”¨å…¬ç½‘é€šä¿¡é è°±ã€‚\n1. ä¿®æ”¹hostname [root@k8s-master ~]$ vim /etc/hostname # ä¿®æ”¹hostname [root@k8s-master ~]$ vim /etc/hosts\t# å°†æœ¬æœºIPæŒ‡å‘hostname [root@k8s-master ~]$ reboot -h # é‡å¯(å¯ä»¥åšå®Œå…¨éƒ¨å‰æœŸå‡†å¤‡åå†é‡å¯) ä¿®æ”¹åï¼š\n[root@k8s-master ~]# cat /etc/hosts ::1 VM_0_5_centos VM_0_5_centos ::1 localhost.localdomain localhost ::1 localhost6.localdomain6 localhost6 127.0.0.1 localhost localhost.localdomain k8s-master 172.17.0.14 k8s-master 172.18.0.7 k8s-node1 172.19.0.5 k8s-node2 2. é…ç½®é˜²ç«å¢™ ç¬”è€…å›¾æ–¹ä¾¿, ç›´æ¥å…³é—­äº†é˜²ç«å¢™. è‹¥å®‰å…¨è¦æ±‚è¾ƒé«˜, å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£æ”¾è¡Œå¿…è¦ç«¯å£.\n[root@k8s-master ~]$ systemctl stop firewalld\t# å…³é—­æœåŠ¡ [root@k8s-master ~]$ systemctl disable firewalld\t# ç¦ç”¨æœåŠ¡ 3. ç¦ç”¨SELinux è…¾è®¯äº‘centos7.6é»˜è®¤æ˜¯ç¦æ­¢çš„ï¼Œå¦‚æœä½ çš„ä¸æ˜¯ï¼Œè¯·ä¿®æ”¹/etc/selinux/config, è®¾ç½®SELINUX=disabled. é‡å¯æœºå™¨.\n[root@k8s-master ~]$ sestatus\t# æŸ¥çœ‹SELinuxçŠ¶æ€ SELinux status: disabled 4. ç¦ç”¨äº¤æ¢åˆ†åŒº è…¾è®¯äº‘centos7.6é»˜è®¤æ˜¯ç¦æ­¢çš„ï¼Œå¦‚æœä½ çš„ä¸æ˜¯ï¼Œè¯·ç¼–è¾‘/etc/fstab, å°†swapæ³¨é‡Šæ‰. é‡å¯æœºå™¨.\n[root@k8s-master ~]$ vim /etc/fstab #/dev/mapper/cl-swap swap swap defaults 0 0 5. å®‰è£…Docker æ–¹æ³•ä¸€ï¼š å®˜æ–¹å®‰è£…è„šæœ¬è‡ªåŠ¨å®‰è£…\ncurl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun æ–¹æ³•äºŒï¼š æ‰‹åŠ¨å®‰è£…\n//ç¬¬ä¸€æ­¥ yum install -y yum-utils \\ device-mapper-persistent-data \\ lvm2 //ç¬¬äºŒæ­¥ yum-config-manager \\ --add-repo \\ http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo //ç¬¬ä¸‰æ­¥ yum install docker-ce docker-ce-cli containerd.io //ç¬¬å››æ­¥ systemctl start docker é…ç½®dockerï¼š\n[root@k8s-master ~]# cat /etc/docker/daemon.json  { \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;https://mirror.ccs.tencentyun.com\u0026#34;], \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;], \u0026#34;bip\u0026#34;: \u0026#34;172.200.0.1/16\u0026#34; } å®‰è£…é…ç½®å®Œæ¯•åæ‰§è¡Œ:\n[root@k8s-master ~]$ systemctl enable docker [root@k8s-master ~]$ systemctl start docker 6. å®‰è£…Kubernetes ç”±äºå›½å†…ç½‘ç»œåŸå› , å®˜æ–¹æ–‡æ¡£ä¸­çš„åœ°å€ä¸å¯ç”¨, æœ¬æ–‡æ›¿æ¢ä¸ºé˜¿é‡Œäº‘é•œåƒåœ°å€, æ‰§è¡Œä»¥ä¸‹ä»£ç å³å¯:\ncat \u0026lt;\u0026lt;EOF \u0026gt; /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF å®‰è£…kubeadmï¼Œkubeletï¼Œkubectlï¼š\nyum install -y kubelet kubeadm kubectl systemctl enable kubelet \u0026amp;\u0026amp; systemctl start kubelet ä¿®æ”¹ç½‘ç»œé…ç½®ï¼š\ncat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sysctl --system [su_highlight]æ³¨æ„: è‡³æ­¤, ä»¥ä¸Šçš„å…¨éƒ¨æ“ä½œ, åœ¨Workeræœºå™¨ä¸Šä¹Ÿéœ€è¦æ‰§è¡Œ. æ³¨æ„hostnameç­‰ä¸è¦ç›¸åŒ.[/su_highlight]\n7. åˆå§‹åŒ–Master [root@k8s-master ~]$ kubeadm config print init-defaults \u0026gt; kubeadm-init.yaml è¯¥æ–‡ä»¶æœ‰ä¸¤å¤„éœ€è¦ä¿®æ”¹:\nå°†advertiseAddress: 1.2.3.4ä¿®æ”¹ä¸ºæœ¬æœºåœ°å€ å°†imageRepository: k8s.gcr.ioä¿®æ”¹ä¸ºimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers\napiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 172.17.0.14 bindPort: 6443 nodeRegistration: criSocket: /var/run/dockershim.sock name: k8s-master taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers kind: ClusterConfiguration kubernetesVersion: v1.15.0 networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/12 scheduler: {} ä¸‹è½½é•œåƒï¼š\n[root@k8s-master ~]$ kubeadm config images pull --config kubeadm-init.yaml æ‰§è¡Œåˆå§‹åŒ–ï¼š\n[root@k8s-master ~]$ kubeadm init --config kubeadm-init.yaml ç­‰å¾…æ‰§è¡Œå®Œæ¯•å, ä¼šè¾“å‡ºå¦‚ä¸‹å†…å®¹ï¼š\nYour Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \u0026#34;kubectl apply -f [podnetwork].yaml\u0026#34; with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: kubeadm join 172.17.0.14:6443 --token abcdef.0123456789abcdef \\  --discovery-token-ca-cert-hash sha256:e245251e3de01986694f77319827481ed8669be6ba2ccc23a29596072b275346 æœ€åä¸¤è¡Œéœ€è¦ä¿å­˜ä¸‹æ¥, kubeadm join \u0026hellip;æ˜¯workerèŠ‚ç‚¹åŠ å…¥æ‰€éœ€è¦æ‰§è¡Œçš„å‘½ä»¤.\næ¥ä¸‹æ¥é…ç½®ç¯å¢ƒ, è®©å½“å‰ç”¨æˆ·å¯ä»¥æ‰§è¡Œkubectlå‘½ä»¤:\nmkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config æµ‹è¯•ä¸€ä¸‹: æ­¤å¤„çš„NotReadyæ˜¯å› ä¸ºç½‘ç»œè¿˜æ²¡é…ç½®.\n[root@k8s-master kubernetes]$ kubectl get node NAME STATUS ROLES AGE VERSION k8s-master NotReady master 3m25s v1.15.3 8. é…ç½®ç½‘ç»œ ä¸‹è½½æè¿°æ–‡ä»¶ï¼š\n[root@k8s-master ~]$ wget https://docs.projectcalico.org/v3.15/manifests/calico.yaml [root@k8s-master ~]$ cat kubeadm-init.yaml | grep serviceSubnet: serviceSubnet: 10.96.0.0/12 æ‰“å¼€calico.yaml, å°†192.168.0.0/16ä¿®æ”¹ä¸º10.96.0.0/12\n[su_highlight]éœ€è¦æ³¨æ„çš„æ˜¯, calico.yamlä¸­çš„IPå’Œkubeadm-init.yamléœ€è¦ä¿æŒä¸€è‡´, è¦ä¹ˆåˆå§‹åŒ–å‰ä¿®æ”¹kubeadm-init.yaml, è¦ä¹ˆåˆå§‹åŒ–åä¿®æ”¹calico.yaml.[/su_highlight]\næ‰§è¡Œkubectl apply -f calico.yamlåˆå§‹åŒ–ç½‘ç»œ.\næ­¤æ—¶æŸ¥çœ‹nodeä¿¡æ¯, masterçš„çŠ¶æ€å·²ç»æ˜¯Readyäº†.\n[root@k8s-master ~]$ kubectl get node NAME STATUS ROLES AGE VERSION k8s-master Ready master 15m v1.15.3 9. å®‰è£…Dashboard 91. éƒ¨ç½²Dashboard [root@k8s-master ~]$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml [root@k8s-master ~]$ kubectl apply -f recommended.yaml éƒ¨ç½²å®Œæ¯•å, æ‰§è¡Œkubectl get pods --all-namespacesæŸ¥çœ‹podsçŠ¶æ€\n[root@k8s-master kubernetes]$ kubectl get pods --all-namespaces | grep dashboard NAMESPACE NAME READY STATUS kubernetes-dashboard dashboard-metrics-scraper-fb986f88d-m9d8z 1/1 Running kubernetes-dashboard kubernetes-dashboard-6bb65fcc49-7s85s 1/1 Running 9.2 åˆ›å»ºç”¨æˆ· åˆ›å»ºä¸€ä¸ªç”¨äºç™»å½•Dashboardçš„ç”¨æˆ·. åˆ›å»ºæ–‡ä»¶dashboard-adminuser.yamlå†…å®¹å¦‚ä¸‹:\napiVersion: v1 kind: ServiceAccount metadata: name: admin-user namespace: kube-system --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: admin-user roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: admin-user namespace: kube-system æ‰§è¡Œå‘½ä»¤kubectl apply -f dashboard-adminuser.yaml.\n9.3 ç”Ÿæˆè¯ä¹¦ [root@k8s-master ~]$ grep \u0026#39;client-certificate-data\u0026#39; ~/.kube/config | head -n 1 | awk \u0026#39;{print $2}\u0026#39; | base64 -d \u0026gt;\u0026gt; kubecfg.crt [root@k8s-master ~]$ grep \u0026#39;client-key-data\u0026#39; ~/.kube/config | head -n 1 | awk \u0026#39;{print $2}\u0026#39; | base64 -d \u0026gt;\u0026gt; kubecfg.key [root@k8s-master ~]$ openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name \u0026#34;kubernetes-client\u0026#34; ç¬¬ä¸‰æ¡å‘½ä»¤ç”Ÿæˆè¯ä¹¦æ—¶ä¼šæç¤ºè¾“å…¥å¯†ç , å¯ä»¥ç›´æ¥ä¸¤æ¬¡å›è½¦è·³è¿‡.\nkubecfg.p12å³éœ€è¦å¯¼å…¥å®¢æˆ·ç«¯æœºå™¨çš„è¯ä¹¦. å°†è¯ä¹¦æ‹·è´åˆ°å®¢æˆ·ç«¯æœºå™¨ä¸Š, å¯¼å…¥å³å¯. chromeæµè§ˆå™¨æŒ‰ä¸‹å›¾æ‰€ç¤ºå¯¼å…¥ï¼š\næ­¤æ—¶æˆ‘ä»¬å¯ä»¥ç™»å½•é¢æ¿äº†, è®¿é—®åœ°å€: https://{k8s-master-ip}:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/login\n9.4 ç™»å½•Dashboard æ‰§è¡Œkubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}'), è·å–Token.\n[root@k8s-master ~]# kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk \u0026#39;{print $1}\u0026#39;) Name: admin-user-token-6mpx4 Namespace: kube-system Labels: \u0026lt;none\u0026gt; Annotations: kubernetes.io/service-account.name: admin-user kubernetes.io/service-account.uid: cabcc858-826a-4236-8514-51f473bf7752 Type: kubernetes.io/service-account-token Data ==== ca.crt: 1025 bytes namespace: 11 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6Iks2dmRwalB5SWNKbWJTVUUxanVlVlAwbTk1OHR6QzhfN0FOZUw0V3huM0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTZtcHg0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJjYWJjYzg1OC04MjZhLTQyMzYtODUxNC01MWY0NzNiZjc3NTIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.jHAzmmOBRn5tfZBeukORLm--9_q879fTHPDzjjyCm42MbHP0TFrgbo2A8ZmN0Od4qe9rTHiD9pJl3BtUQ06pIMsly7LvENnuLAxGuK3oDqc5FCdqb8L-f9-9HmBo7nEAMy67i6Cv9TjfD9790ejfOg6ZI0PC8MDXInxSgY97hlwBlyJh_M5zz8SMnOOnMYyr8UFmHRZJjTO5pdIs7cdVBxLz27wzw4h0svJyOsi9MBqHskN6Hq7KOsEYP5wyDHXmU_iHqQJH64R9DA6dpHx6v3qV1dyhtXJE9tZECsvoVtvNlKQ-VirtX4sJX29a5wAXDqkcysDiClIXZGZKtg8tFw å¤åˆ¶è¯¥Tokenåˆ°ç™»å½•é¡µ, ç‚¹å‡»ç™»å½•å³å¯, æ•ˆæœå¦‚ä¸‹:\n10. æ·»åŠ NodeèŠ‚ç‚¹ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å°†WorkeråŠ å…¥é›†ç¾¤:\nkubeadm join 172.17.0.14:6443 --token abcdef.0123456789abcdef \\  --discovery-token-ca-cert-hash sha256:e245251e3de01986694f77319827481ed8669be6ba2ccc23a29596072b275346 æ³¨æ„: æ­¤å¤„çš„ç§˜é’¥æ˜¯åˆå§‹åŒ–Masteråç”Ÿæˆçš„, å‚è€ƒå‰æ–‡.\nå¦‚æœtokenè¿‡æœŸï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡æ–°ç”Ÿæˆï¼š\nkubeadm token create --print-join-command å‚è€ƒè¿æ¥ï¼škubeadm ç”Ÿæˆçš„tokenè¿‡æœŸåï¼Œé›†ç¾¤å¢åŠ èŠ‚ç‚¹\rå¦‚æœjoinæ—¶æŠ¥é”™ï¼š[ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1 æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š\necho \u0026#34;1\u0026#34;\u0026gt;/proc/sys/net/ipv4/ip_forward å‚è€ƒé“¾æ¥ï¼škubernetes åŠ å…¥å­èŠ‚ç‚¹\ræ·»åŠ å®Œæ¯•å, åœ¨Masterä¸ŠæŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€:\n[root@k8s-master ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master Ready master 125m v1.18.4 k8s-node1 Ready \u0026lt;none\u0026gt; 97m v1.18.4 k8s-node2 Ready \u0026lt;none\u0026gt; 95m v1.18.4 åœ¨é¢æ¿ä¸Šä¹Ÿå¯æŸ¥çœ‹:\né…ç½®nodeèŠ‚ç‚¹ï¼Œä»¥ä¾¿nodeèŠ‚ç‚¹èƒ½å¤Ÿæ‰§è¡Œç±»ä¼¼kubectl get nodeçš„æ—¶å€™ä¸è‡³äºæŠ¥The connection to the server localhost:8080 was refused - did you specify the right host or port?\nåœ¨nodeèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼š\nmkdir -p $HOME/.kube cp -i /etc/kubernetes/kubelet.conf $HOME/.kube/config chown $(id -u):$(id -g) $HOME/.kube/config //å¦‚æœä½ æœ¬èº«æ˜¯rootç”¨æˆ·ï¼Œå¯ä»¥ä¸æ‰§è¡Œ å‚è€ƒé“¾æ¥ https://juejin.im/post/5d7fb46d5188253264365dcf\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BAk8s/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"ä»é›¶æ­å»ºK8S"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä½¿ç”¨kubeadmæ›´æ–°k8sè¯ä¹¦ ä»Šå¤©æ“ä½œk8sçš„æ—¶å€™ï¼Œçªç„¶è¯´è¯ä¹¦æ— æ•ˆï¼š\nUnable to connect to the server: x509: certificate has expired or is not yet valid é€šè¿‡ kubeadm alpha certs check-expiration æŸ¥çœ‹ï¼Œç¡®å®æ˜¯è¿‡æœŸäº†ï¼š\n[root@k8s-master ~]# kubeadm alpha certs check-expiration [check-expiration] Reading configuration from the cluster... [check-expiration] FYI: You can look at this config file with \u0026#39;kubectl -n kube-system get cm kubeadm-config -oyaml\u0026#39; [check-expiration] Error reading configuration from the Cluster. Falling back to default configuration W0627 11:21:35.745166 8754 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io] CERTIFICATE EXPIRES RESIDUAL TIME CERTIFICATE AUTHORITY EXTERNALLY MANAGED admin.conf Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; no apiserver Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; ca no apiserver-etcd-client Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; etcd-ca no apiserver-kubelet-client Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; ca no controller-manager.conf Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; no etcd-healthcheck-client Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; etcd-ca no etcd-peer Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; etcd-ca no etcd-server Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; etcd-ca no front-proxy-client Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; front-proxy-ca no scheduler.conf Jun 24, 2021 09:45 UTC \u0026lt;invalid\u0026gt; no CERTIFICATE AUTHORITY EXPIRES RESIDUAL TIME EXTERNALLY MANAGED ca Jun 22, 2030 09:45 UTC 8y no etcd-ca Jun 22, 2030 09:45 UTC 8y no front-proxy-ca Jun 22, 2030 09:45 UTC 8y no é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯æ›´æ–°è¯ä¹¦ğŸ“„äº†ï¼š\n ä¸‹é¢çš„æ“ä½œéƒ½æ˜¯åœ¨ master èŠ‚ç‚¹ä¸Šè¿›è¡Œ\n   å¤‡ä»½   //é¦–å…ˆå¤‡ä»½åŸæœ‰è¯ä¹¦ï¼š [root@k8s-master ~]# mkdir /etc/kubernetes.bak [root@k8s-master ~]# cp -r /etc/kubernetes/pki/ /etc/kubernetes.bak [root@k8s-master ~]# cp /etc/kubernetes/*.conf /etc/kubernetes.bak //ç„¶åå¤‡ä»½ etcd æ•°æ®ç›®å½•ï¼š [root@k8s-master ~]# cp -r /var/lib/etcd /var/lib/etcd.bak  é€šè¿‡ kubeadm alpha certs renew all æ›´æ–°è¯ä¹¦   [root@k8s-master ~]# kubeadm alpha certs renew all [renew] Reading configuration from the cluster... [renew] FYI: You can look at this config file with \u0026#39;kubectl -n kube-system get cm kubeadm-config -oyaml\u0026#39; [renew] Error reading configuration from the Cluster. Falling back to default configuration W0627 13:06:09.974228 14219 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io] certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed certificate for serving the Kubernetes API renewed certificate the apiserver uses to access etcd renewed certificate for the API server to connect to kubelet renewed certificate embedded in the kubeconfig file for the controller manager to use renewed certificate for liveness probes to healthcheck etcd renewed certificate for etcd nodes to communicate with each other renewed certificate for serving etcd renewed certificate for the front proxy client renewed certificate embedded in the kubeconfig file for the scheduler manager to use renewed  å†æ¬¡æŸ¥çœ‹è¯ä¹¦æ—¶é—´   [root@k8s-master ~]# kubeadm alpha certs check-expiration [check-expiration] Reading configuration from the cluster... [check-expiration] FYI: You can look at this config file with \u0026#39;kubectl -n kube-system get cm kubeadm-config -oyaml\u0026#39; CERTIFICATE EXPIRES RESIDUAL TIME CERTIFICATE AUTHORITY EXTERNALLY MANAGED admin.conf Jun 27, 2022 05:06 UTC 364d no apiserver Jun 27, 2022 05:06 UTC 364d ca no apiserver-etcd-client Jun 27, 2022 05:06 UTC 364d etcd-ca no apiserver-kubelet-client Jun 27, 2022 05:06 UTC 364d ca no controller-manager.conf Jun 27, 2022 05:06 UTC 364d no etcd-healthcheck-client Jun 27, 2022 05:06 UTC 364d etcd-ca no etcd-peer Jun 27, 2022 05:06 UTC 364d etcd-ca no etcd-server Jun 27, 2022 05:06 UTC 364d etcd-ca no front-proxy-client Jun 27, 2022 05:06 UTC 364d front-proxy-ca no scheduler.conf Jun 27, 2022 05:06 UTC 364d no CERTIFICATE AUTHORITY EXPIRES RESIDUAL TIME EXTERNALLY MANAGED ca Jun 22, 2030 09:45 UTC 8y no etcd-ca Jun 22, 2030 09:45 UTC 8y no å·²ç»æ›´æ–°æˆåŠŸäº†ã€‚\n æŸ¥çœ‹kubectlæ˜¯å¦å¯ç”¨   [root@k8s-master ~]# kubectl get pods error: You must be logged in to the server (Unauthorized) è¿˜ä¸å¯ç”¨ï¼Œéœ€è¦æ›´æ–°æ›´æ–°ä¸‹ kubeconfig æ–‡ä»¶ã€‚\n é€šè¿‡ kubeadm init phase kubeconfig all æ›´æ–° kubeconfig æ–‡ä»¶   [root@k8s-master ~]# kubeadm init phase kubeconfig all I0627 13:07:48.893885 15844 version.go:252] remote version is much newer: v1.21.2; falling back to: stable-1.18 W0627 13:07:50.865825 15844 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io] [kubeconfig] Using kubeconfig folder \u0026#34;/etc/kubernetes\u0026#34; [kubeconfig] Using existing kubeconfig file: \u0026#34;/etc/kubernetes/admin.conf\u0026#34; [kubeconfig] Using existing kubeconfig file: \u0026#34;/etc/kubernetes/kubelet.conf\u0026#34; [kubeconfig] Using existing kubeconfig file: \u0026#34;/etc/kubernetes/controller-manager.conf\u0026#34; [kubeconfig] Using existing kubeconfig file: \u0026#34;/etc/kubernetes/scheduler.conf\u0026#34;  å°†æ–°ç”Ÿæˆçš„ admin é…ç½®æ–‡ä»¶è¦†ç›–æ‰åŸæœ¬çš„ admin æ–‡ä»¶:   [root@k8s-master ~]# mv $HOME/.kube/config $HOME/.kube/config.old [root@k8s-master ~]# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config [root@k8s-master ~]# chown $(id -u):$(id -g) $HOME/.kube/config  å†æ¬¡éªŒè¯è¯ä¹¦æ—¶é—´   æŸ¥çœ‹ apiserver çš„è¯ä¹¦çš„æœ‰æ•ˆæœŸæ¥éªŒè¯æ˜¯å¦æ›´æ–°æˆåŠŸ\n[root@k8s-master ~]# echo | openssl s_client -showcerts -connect 127.0.0.1:6443 -servername api 2\u0026gt;/dev/null | openssl x509 -noout -enddate notAfter=Jun 27 05:06:10 2022 GMT æŸ¥çœ‹å‘½ä»¤æ˜¯å¦å¯ç”¨\n[root@k8s-master ~]# kubectl get pod NAME READY STATUS RESTARTS AGE ceres-admin-server-deployment-7f9c4c697d-7pphh 2/2 Running 0 91d ceres-admin-web-deployment-7c8fb64f58-ft8xv 2/2 Running 2 192d ceres-app-server-deployment-65b6bb99f9-qlwb2 2/2 Running 0 91d ceres-jobs-server-deployment-bdcd669bb-284k5 2/2 Running 2 217d ceres-merchant-web-deployment-6c6b668b8d-5vtq5 2/2 Running 2 192d ceres-settled-merchant-deployment-5f74c8f46d-f982v 2/2 Running 2 213d details-v1-6c9f8bcbcb-pzkfm 2/2 Running 6 296d nfs-client-provisioner-6965c6967-6jv6c 2/2 Running 8 217d productpage-v1-7f9d9c48c8-kgtlw 2/2 Running 4 296d ratings-v1-65cff55fb8-vmj4z 2/2 Running 6 296d reviews-v1-d5b6b667f-9b7kw 2/2 Running 4 296d reviews-v2-784495d9bc-xvqpw 2/2 Running 6 296d reviews-v3-57fcb844b7-xsj47 2/2 Running 4 296d [root@k8s-master ~]# kubens  default ingress-nginx Istio-system kube-node-lease kube-public kube-system kube-wordpress kubernetes-dashboard tkb å‚è€ƒé“¾æ¥ğŸ”—ï¼š æ›´æ–°ä¸€ä¸ª10å¹´æœ‰æ•ˆæœŸçš„ Kubernetes è¯ä¹¦\rä½¿ç”¨ kubeadm è¿›è¡Œè¯ä¹¦ç®¡ç†\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/%E4%BD%BF%E7%94%A8kubeadm%E6%9B%B4%E6%96%B0k8s%E8%AF%81%E4%B9%A6/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"ä½¿ç”¨kubeadmæ›´æ–°k8sè¯ä¹¦"},{"categories":["å…¶ä»–"],"content":"ä½¿ç”¨Xshellç™»å½•AWSçš„EC2äº‘æœåŠ¡å™¨å’Œå¼€å¯EC2ä¸Šå…è®¸root+å¯†ç æ–¹å¼ç™»å½• https://www.dwhd.org/20150525_182436.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/%E4%BD%BF%E7%94%A8xshell%E7%99%BB%E5%BD%95aws%E7%9A%84ec2%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%BC%80%E5%90%AFec2%E4%B8%8A%E5%85%81%E8%AE%B8root+%E5%AF%86%E7%A0%81%E6%96%B9%E5%BC%8F%E7%99%BB%E5%BD%95/","series":["Manual"],"tags":["Other"],"title":"ä½¿ç”¨Xshellç™»å½•AWSçš„EC2äº‘æœåŠ¡å™¨å’Œå¼€å¯EC2ä¸Šå…è®¸root+å¯†ç æ–¹å¼ç™»å½•"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å…¨æ–‡ç´¢å¼• å‚è€ƒ ä»€ä¹ˆæ˜¯å…¨æ–‡ç´¢å¼•ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨å…¨æ–‡ç´¢å¼•\rMySQL ä¹‹å…¨æ–‡ç´¢å¼•\ræµ…è°ˆmysql fulltextå…¨æ–‡ç´¢å¼•ä¼˜ç¼ºç‚¹\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E6%8B%BE%E9%81%97/%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95/","series":["Manual"],"tags":["Other"],"title":"å…¨æ–‡ç´¢å¼•"},{"categories":["æ¶æ„æ¼”è¿›"],"content":"å‰è¨€ æœåŠ¡æ³¨å†Œä¸­å¿ƒæœ¬è´¨ä¸Šæ˜¯ä¸ºäº†è§£è€¦æœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…ã€‚å¯¹äºä»»ä½•ä¸€ä¸ªå¾®æœåŠ¡ï¼ŒåŸåˆ™ä¸Šéƒ½åº”å­˜åœ¨æˆ–è€…æ”¯æŒå¤šä¸ªæä¾›è€…ï¼Œè¿™æ˜¯ç”±å¾®æœåŠ¡çš„åˆ†å¸ƒå¼å±æ€§å†³å®šçš„ã€‚æ›´è¿›ä¸€æ­¥ï¼Œä¸ºäº†æ”¯æŒå¼¹æ€§æ‰©ç¼©å®¹ç‰¹æ€§ï¼Œä¸€ä¸ªå¾®æœåŠ¡çš„æä¾›è€…çš„æ•°é‡å’Œåˆ†å¸ƒå¾€å¾€æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œä¹Ÿæ˜¯æ— æ³•é¢„å…ˆç¡®å®šçš„ã€‚å› æ­¤ï¼ŒåŸæœ¬åœ¨å•ä½“åº”ç”¨é˜¶æ®µå¸¸ç”¨çš„é™æ€LBæœºåˆ¶å°±ä¸å†é€‚ç”¨äº†ï¼Œéœ€è¦å¼•å…¥é¢å¤–çš„ç»„ä»¶æ¥ç®¡ç†å¾®æœåŠ¡æä¾›è€…çš„æ³¨å†Œä¸å‘ç°ï¼Œè€Œè¿™ä¸ªç»„ä»¶å°±æ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚\nCAPç†è®º CAPç†è®ºæ˜¯åˆ†å¸ƒå¼æ¶æ„ä¸­é‡è¦ç†è®º\n ä¸€è‡´æ€§(Consistency) (æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´å…·æœ‰ç›¸åŒçš„æ•°æ®) å¯ç”¨æ€§(Availability) (ä¿è¯æ¯ä¸ªè¯·æ±‚ä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥éƒ½æœ‰å“åº”) åˆ†éš”å®¹å¿(Partition tolerance) (ç³»ç»Ÿä¸­ä»»æ„ä¿¡æ¯çš„ä¸¢å¤±æˆ–å¤±è´¥ä¸ä¼šå½±å“ç³»ç»Ÿçš„ç»§ç»­è¿ä½œ)  å…³äº\nPçš„ç†è§£ï¼Œæˆ‘è§‰å¾—æ˜¯åœ¨æ•´ä¸ªç³»ç»Ÿä¸­æŸä¸ªéƒ¨åˆ†ï¼ŒæŒ‚æ‰äº†ï¼Œæˆ–è€…å®•æœºäº†ï¼Œå¹¶ä¸å½±å“æ•´ä¸ªç³»ç»Ÿçš„è¿ä½œæˆ–è€…è¯´ä½¿ç”¨ï¼Œè€Œå¯ç”¨æ€§æ˜¯ï¼ŒæŸä¸ªç³»ç»Ÿçš„æŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œä½†æ˜¯å¹¶ä¸å½±å“ç³»ç»Ÿçš„æ¥å—æˆ–è€…å‘å‡ºè¯·æ±‚ï¼ŒCAP ä¸å¯èƒ½éƒ½å–ï¼Œåªèƒ½å–å…¶ä¸­2ä¸ª\nåŸå› æ˜¯\nå¦‚æœCæ˜¯ç¬¬ä¸€éœ€æ±‚çš„è¯ï¼Œé‚£ä¹ˆä¼šå½±å“Açš„æ€§èƒ½ï¼Œå› ä¸ºè¦æ•°æ®åŒæ­¥ï¼Œä¸ç„¶è¯·æ±‚ç»“æœä¼šæœ‰å·®å¼‚ï¼Œä½†æ˜¯æ•°æ®åŒæ­¥ä¼šæ¶ˆè€—æ—¶é—´ï¼ŒæœŸé—´å¯ç”¨æ€§å°±ä¼šé™ä½ã€‚\nå¦‚æœAæ˜¯ç¬¬ä¸€éœ€æ±‚ï¼Œé‚£ä¹ˆåªè¦æœ‰ä¸€ä¸ªæœåŠ¡åœ¨ï¼Œå°±èƒ½æ­£å¸¸æ¥å—è¯·æ±‚ï¼Œä½†æ˜¯å¯¹ä¸è¿”å›ç»“æœå˜ä¸èƒ½ä¿è¯ï¼ŒåŸå› æ˜¯ï¼Œåœ¨åˆ†å¸ƒå¼éƒ¨ç½²çš„æ—¶å€™ï¼Œæ•°æ®ä¸€è‡´çš„è¿‡ç¨‹ä¸å¯èƒ½æƒ³åˆ‡çº¿è·¯é‚£ä¹ˆå¿«ã€‚\nå†å¦‚æœï¼ŒåŒäº‹æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Œé‚£ä¹ˆåˆ†åŒºå®¹é”™å°±å¾ˆéš¾ä¿è¯äº†ï¼Œä¹Ÿå°±æ˜¯å•ç‚¹ï¼Œä¹Ÿæ˜¯åˆ†å¸ƒå¼çš„åŸºæœ¬æ ¸å¿ƒï¼Œå¥½äº†ï¼Œæ˜ç™½è¿™äº›ç†è®ºï¼Œå°±å¯ä»¥åœ¨ç›¸åº”çš„åœºæ™¯é€‰å–æœåŠ¡æ³¨å†Œä¸å‘ç°äº†\næœåŠ¡æ³¨å†Œä¸­å¿ƒè§£å†³æ–¹æ¡ˆ è®¾è®¡æˆ–è€…é€‰å‹ä¸€ä¸ªæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œé¦–å…ˆè¦è€ƒè™‘çš„å°±æ˜¯æœåŠ¡æ³¨å†Œä¸å‘ç°æœºåˆ¶ã€‚çºµè§‚å½“ä¸‹å„ç§ä¸»æµçš„æœåŠ¡æ³¨å†Œä¸­å¿ƒè§£å†³æ–¹æ¡ˆï¼Œå¤§è‡´å¯å½’ä¸ºä¸‰ç±»ï¼š\n  åº”ç”¨å†…ï¼šç›´æ¥é›†æˆåˆ°åº”ç”¨ä¸­ï¼Œä¾èµ–äºåº”ç”¨è‡ªèº«å®ŒæˆæœåŠ¡çš„æ³¨å†Œä¸å‘ç°ï¼Œæœ€å…¸å‹çš„æ˜¯Netflixæä¾›çš„Eureka\n  åº”ç”¨å¤–ï¼šæŠŠåº”ç”¨å½“æˆé»‘ç›’ï¼Œé€šè¿‡åº”ç”¨å¤–çš„æŸç§æœºåˆ¶å°†æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œæœ€å°åŒ–å¯¹åº”ç”¨çš„ä¾µå…¥æ€§ï¼Œæ¯”å¦‚Airbnbçš„SmartStackï¼ŒHashiCorpçš„Consul\n  DNSï¼šå°†æœåŠ¡æ³¨å†Œä¸ºDNSçš„SRVè®°å½•ï¼Œä¸¥æ ¼æ¥è¯´ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„åº”ç”¨å¤–æ³¨å†Œæ–¹å¼ï¼ŒSkyDNSæ˜¯å…¶ä¸­çš„ä»£è¡¨\n   æ³¨1ï¼šå¯¹äºç¬¬ä¸€ç±»æ³¨å†Œæ–¹å¼ï¼Œé™¤äº†Eurekaè¿™ç§ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œè¿˜å¯ä»¥åŸºäºZooKeeperæˆ–è€…Etcdè‡ªè¡Œå®ç°ä¸€å¥—æœåŠ¡æ³¨å†Œæœºåˆ¶ï¼Œè¿™åœ¨å¤§å…¬å¸æ¯”è¾ƒå¸¸è§ï¼Œä½†å¯¹äºå°å…¬å¸è€Œè¨€æ˜¾ç„¶æ€§ä»·æ¯”å¤ªä½ã€‚\næ³¨2ï¼šç”±äºDNSå›ºæœ‰çš„ç¼“å­˜ç¼ºé™·ï¼Œæœ¬æ–‡ä¸å¯¹ç¬¬ä¸‰ç±»æ³¨å†Œæ–¹å¼ä½œæ·±å…¥æ¢è®¨ã€‚\n é™¤äº†åŸºæœ¬çš„æœåŠ¡æ³¨å†Œä¸å‘ç°æœºåˆ¶ï¼Œä»å¼€å‘å’Œè¿ç»´è§’åº¦ï¼Œè‡³å°‘è¿˜è¦è€ƒè™‘å¦‚ä¸‹äº”ä¸ªæ–¹é¢ï¼š\n  æµ‹æ´»ï¼šæœåŠ¡æ³¨å†Œä¹‹åï¼Œå¦‚ä½•å¯¹æœåŠ¡è¿›è¡Œæµ‹æ´»ä»¥ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ï¼Ÿ\n  è´Ÿè½½å‡è¡¡ï¼šå½“å­˜åœ¨å¤šä¸ªæœåŠ¡æä¾›è€…æ—¶ï¼Œå¦‚ä½•å‡è¡¡å„ä¸ªæä¾›è€…çš„è´Ÿè½½ï¼Ÿ\n  é›†æˆï¼šåœ¨æœåŠ¡æä¾›ç«¯æˆ–è€…è°ƒç”¨ç«¯ï¼Œå¦‚ä½•é›†æˆæ³¨å†Œä¸­å¿ƒï¼Ÿ\n  è¿è¡Œæ—¶ä¾èµ–ï¼šå¼•å…¥æ³¨å†Œä¸­å¿ƒä¹‹åï¼Œå¯¹åº”ç”¨çš„è¿è¡Œæ—¶ç¯å¢ƒæœ‰ä½•å½±å“ï¼Ÿ\n  å¯ç”¨æ€§ï¼šå¦‚ä½•ä¿è¯æ³¨å†Œä¸­å¿ƒæœ¬èº«çš„å¯ç”¨æ€§ï¼Œç‰¹åˆ«æ˜¯æ¶ˆé™¤å•ç‚¹æ•…éšœï¼Ÿ\n  ä¸»æµæ³¨å†Œä¸­å¿ƒäº§å“  è½¯ä»¶äº§å“ç‰¹æ€§å¹¶éä¸€æˆä¸å˜ï¼Œå¦‚æœå‘ç°åŠŸèƒ½ç‰¹æ€§æœ‰å˜æ›´ï¼Œæ¬¢è¿è¯„è®ºæŒ‡æ­£\n     Nacos Eureka Consul CoreDNS Zookeeper     ä¸€è‡´æ€§åè®® CP+AP AP CP â€” CP   å¥åº·æ£€æŸ¥ TCP/HTTP/MYSQL/Client Beat Client Beat TCP/HTTP/gRPC/Cmd â€” Keep Alive   è´Ÿè½½å‡è¡¡ç­–ç•¥ æƒé‡/ metadata/Selector Ribbon Fabio RoundRobin â€”   é›ªå´©ä¿æŠ¤ æœ‰ æœ‰ æ—  æ—  æ—    è‡ªåŠ¨æ³¨é”€å®ä¾‹ æ”¯æŒ æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ   è®¿é—®åè®® HTTP/DNS HTTP HTTP/DNS DNS TCP   ç›‘å¬æ”¯æŒ æ”¯æŒ æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ   å¤šæ•°æ®ä¸­å¿ƒ æ”¯æŒ æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ ä¸æ”¯æŒ   è·¨æ³¨å†Œä¸­å¿ƒåŒæ­¥ æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ ä¸æ”¯æŒ   SpringCloudé›†æˆ æ”¯æŒ æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ   Dubboé›†æˆ æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ   K8Sé›†æˆ æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ      Consulæ˜¯æ”¯æŒè‡ªåŠ¨æ³¨é”€æœåŠ¡å®ä¾‹ï¼Œ è¯·è§æ–‡æ¡£ï¼š https://www.consul.io/api-docs/agent/service\rï¼Œåœ¨checkçš„ DeregisterCriticalServiceAfter è¿™ä¸ªå‚æ•°\u0026ndash; æ„Ÿè°¢@è¶…å¸…çš„èœé¸Ÿåšä¸»æä¾›æœ€æ–°ä¿¡æ¯ æ–°ç‰ˆæœ¬çš„Dubboä¹Ÿæ‰©å±•äº†å¯¹ Consul çš„æ”¯æŒã€‚ å‚è€ƒ: https://github.com/apache/dubbo/tree/master/dubbo-registry\r    Nacosã€Eurekaéƒ½æ”¯æŒé›ªå´©ä¿æŠ¤ï¼Œé¿å…å› ä¸ºè¿‡å¤šçš„å®ä¾‹ä¸å¥åº·å¯¹å¥åº·çš„å®ä¾‹é€ æˆé›ªå´©æ•ˆåº”ã€‚\nNacosé›ªå´©ä¿æŠ¤ï¼šä¸ºäº†é˜²æ­¢å› è¿‡å¤šå®ä¾‹ (Instance) ä¸å¥åº·å¯¼è‡´æµé‡å…¨éƒ¨æµå‘å¥åº·å®ä¾‹ (Instance) ï¼Œç»§è€Œé€ æˆæµé‡å‹åŠ›æŠŠå¥åº·å®ä¾‹ (Instance) å‹å®å¹¶å½¢æˆé›ªå´©æ•ˆåº”ï¼Œåº”å°†å¥åº·ä¿æŠ¤é˜ˆå€¼å®šä¹‰ä¸ºä¸€ä¸ª 0 åˆ° 1 ä¹‹é—´çš„æµ®ç‚¹æ•°ã€‚å½“åŸŸåå¥åº·å®ä¾‹å æ€»æœåŠ¡å®ä¾‹çš„æ¯”ä¾‹å°äºè¯¥å€¼æ—¶ï¼Œæ— è®ºå®ä¾‹æ˜¯å¦å¥åº·ï¼Œéƒ½ä¼šå°†è¿™ä¸ªå®ä¾‹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™æ ·åšè™½ç„¶æŸå¤±äº†ä¸€éƒ¨åˆ†æµé‡ï¼Œä½†æ˜¯ä¿è¯äº†é›†ç¾¤çš„å‰©ä½™å¥åº·å®ä¾‹ (Instance) èƒ½æ­£å¸¸å·¥ä½œã€‚\nEurekaé›ªå´©ä¿æŠ¤ï¼šå½“ç½‘ç»œåˆ†åŒºæ•…éšœå‘ç”Ÿæ—¶ï¼Œå¾®æœåŠ¡ä¸Eureka Serverä¹‹é—´çªç„¶æ— æ³•æ­£å¸¸é€šä¿¡äº†ï¼Œæ ¹æ®å¿ƒè·³æœºåˆ¶ï¼Œå¾®æœåŠ¡å°†ä¼šè¢«æ³¨é”€ã€‚é‚£ä¹ˆè¿™ç§å¿ƒè·³æœºåˆ¶æ˜¯ä¸æ˜¯å°±å˜å¾—ä¸å¤ªå‹å¥½äº†ï¼Ÿå› ä¸ºè¿™ç§æƒ…å†µä¸‹å¾®æœåŠ¡æœ¬èº«å…¶å®æ˜¯å¥åº·çš„ï¼Œæœ¬ä¸åº”è¯¥æ³¨é”€è¿™ä¸ªå¾®æœåŠ¡ï¼Œå› æ­¤Eurekaå°±æä¾›äº†ä¸€ä¸ªè‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‚å½“Eureka ServerèŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…ä¸¢å¤±è¿‡å¤šå®¢æˆ·ç«¯ï¼ˆå¯èƒ½å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºæ•…éšœï¼‰ï¼Œé»˜è®¤æ˜¯15åˆ†é’Ÿå†…æ”¶åˆ°çš„ç»­çº¦ä½äºåŸæ¥çš„85%æ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚ä¸€æ—¦è¿›å…¥è¯¥æ¨¡å¼ï¼ŒEureka Serverä»èƒ½æ¥æ”¶æ–°æœåŠ¡çš„æ³¨å†Œå’ŒæŸ¥è¯¢è¯·æ±‚ï¼Œä½†æ˜¯ä¸ä¼šåŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šï¼›åŒæ—¶ä¹Ÿä¼šä¿æŠ¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œä¸å†ç§»é™¤æ³¨å†Œåˆ—è¡¨ä¸­å› ä¸ºé•¿æ—¶é—´æ²¡æ”¶åˆ°å¿ƒè·³è€Œåº”è¯¥è¿‡æœŸçš„æœåŠ¡ã€‚å½“ç½‘ç»œæ•…éšœæ¢å¤åï¼Œè¯¥Eureka ServerèŠ‚ç‚¹ä¼šè‡ªåŠ¨é€€å‡ºè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚\nå› æ­¤ï¼ŒEurekaé›ªå´©ä¿æŠ¤èƒ½åŠ›è¾ƒå¼±ã€‚è¯•æƒ³ï¼ŒæŒ‰ç…§ä¸Šè¿°è¯´æ³•ï¼Œå¦‚æœä¸€ä¸ªå¾®æœåŠ¡æä¾›è€…å¤§éƒ¨åˆ†èŠ‚ç‚¹éƒ½å‘ç”Ÿå®•æœºæˆ–è€…ä¸Eureka Serverä¹‹é—´ç½‘ç»œä¸é€šï¼Œä½†æ˜¯Eureka Serverä¸å…¶ä»–å¾®æœåŠ¡æä¾›è€…è¿æ¥æ­£å¸¸ï¼Œå³ä¸æ»¡è¶³â€œ15åˆ†é’Ÿå†…æ”¶åˆ°çš„ç»­çº¦ä½äºåŸæ¥çš„85%â€çš„æ¡ä»¶ï¼Œåˆ™Eureka Serveræ ¹æ®å¿ƒè·³æœºåˆ¶å°†è¯¥å¾®æœåŠ¡æ— æ³•è¿æ¥çš„èŠ‚ç‚¹å…¨éƒ¨æ³¨é”€ï¼Œæµé‡å…¨éƒ¨å»åˆ°è¯¥å¾®æœåŠ¡çš„è¿é€šèŠ‚ç‚¹ä¸Šï¼Œé€ æˆé›ªå´©ã€‚\n Apache Zookeeper -\u0026gt; CP ä¸ Eureka æœ‰æ‰€ä¸åŒï¼ŒApache Zookeeper åœ¨è®¾è®¡æ—¶å°±ç´§éµCPåŸåˆ™ï¼Œå³ä»»ä½•æ—¶å€™å¯¹ Zookeeper çš„è®¿é—®è¯·æ±‚èƒ½å¾—åˆ°ä¸€è‡´çš„æ•°æ®ç»“æœï¼ŒåŒæ—¶ç³»ç»Ÿå¯¹ç½‘ç»œåˆ†å‰²å…·å¤‡å®¹é”™æ€§ï¼Œä½†æ˜¯ Zookeeper ä¸èƒ½ä¿è¯æ¯æ¬¡æœåŠ¡è¯·æ±‚éƒ½æ˜¯å¯è¾¾çš„ã€‚\nä» Zookeeper çš„å®é™…åº”ç”¨æƒ…å†µæ¥çœ‹ï¼Œåœ¨ä½¿ç”¨ Zookeeper è·å–æœåŠ¡åˆ—è¡¨æ—¶ï¼Œå¦‚æœæ­¤æ—¶çš„ Zookeeper é›†ç¾¤ä¸­çš„ Leader å®•æœºäº†ï¼Œè¯¥é›†ç¾¤å°±è¦è¿›è¡Œ Leader çš„é€‰ä¸¾ï¼Œåˆæˆ–è€… Zookeeper é›†ç¾¤ä¸­åŠæ•°ä»¥ä¸ŠæœåŠ¡å™¨èŠ‚ç‚¹ä¸å¯ç”¨ï¼ˆä¾‹å¦‚æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹ä¸€æ£€æµ‹åˆ°èŠ‚ç‚¹ä¸‰æŒ‚äº† ï¼ŒèŠ‚ç‚¹äºŒä¹Ÿæ£€æµ‹åˆ°èŠ‚ç‚¹ä¸‰æŒ‚äº†ï¼Œé‚£è¿™ä¸ªèŠ‚ç‚¹æ‰ç®—æ˜¯çœŸçš„æŒ‚äº†ï¼‰ï¼Œé‚£ä¹ˆå°†æ— æ³•å¤„ç†è¯¥è¯·æ±‚ã€‚æ‰€ä»¥è¯´ï¼ŒZookeeper ä¸èƒ½ä¿è¯æœåŠ¡å¯ç”¨æ€§ã€‚\nå½“ç„¶ï¼Œåœ¨å¤§å¤šæ•°åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ°æ•°æ®å­˜å‚¨çš„åœºæ™¯ï¼Œæ•°æ®ä¸€è‡´æ€§åº”è¯¥æ˜¯é¦–å…ˆè¢«ä¿è¯çš„ï¼Œè¿™ä¹Ÿæ˜¯ Zookeeper è®¾è®¡ç´§éµCPåŸåˆ™çš„å¦ä¸€ä¸ªåŸå› ã€‚\nä½†æ˜¯å¯¹äºæœåŠ¡å‘ç°æ¥è¯´ï¼Œæƒ…å†µå°±ä¸å¤ªä¸€æ ·äº†ï¼Œé’ˆå¯¹åŒä¸€ä¸ªæœåŠ¡ï¼Œå³ä½¿æ³¨å†Œä¸­å¿ƒçš„ä¸åŒèŠ‚ç‚¹ä¿å­˜çš„æœåŠ¡æä¾›è€…ä¿¡æ¯ä¸å°½ç›¸åŒï¼Œä¹Ÿå¹¶ä¸ä¼šé€ æˆç¾éš¾æ€§çš„åæœã€‚\nå› ä¸ºå¯¹äºæœåŠ¡æ¶ˆè´¹è€…æ¥è¯´ï¼Œèƒ½æ¶ˆè´¹æ‰æ˜¯æœ€é‡è¦çš„ï¼Œæ¶ˆè´¹è€…è™½ç„¶æ‹¿åˆ°å¯èƒ½ä¸æ­£ç¡®çš„æœåŠ¡å®ä¾‹ä¿¡æ¯åå°è¯•æ¶ˆè´¹ä¸€ä¸‹ï¼Œä¹Ÿè¦èƒœè¿‡å› ä¸ºæ— æ³•è·å–å®ä¾‹ä¿¡æ¯è€Œä¸å»æ¶ˆè´¹ï¼Œå¯¼è‡´ç³»ç»Ÿå¼‚å¸¸è¦å¥½ï¼ˆæ·˜å®çš„åŒåä¸€ï¼Œäº¬ä¸œçš„618å°±æ˜¯ç´§éµAPçš„æœ€å¥½å‚ç…§ï¼‰ã€‚\nå½“masterèŠ‚ç‚¹å› ä¸ºç½‘ç»œæ•…éšœä¸å…¶ä»–èŠ‚ç‚¹å¤±å»è”ç³»æ—¶ï¼Œå‰©ä½™èŠ‚ç‚¹ä¼šé‡æ–°è¿›è¡Œleaderé€‰ä¸¾ã€‚é—®é¢˜åœ¨äºï¼Œé€‰ä¸¾leaderçš„æ—¶é—´å¤ªé•¿ï¼Œ30~120sï¼Œè€Œä¸”é€‰ä¸¾æœŸé—´æ•´ä¸ªzké›†ç¾¤éƒ½æ˜¯ä¸å¯ç”¨çš„ï¼Œè¿™å°±å¯¼è‡´åœ¨é€‰ä¸¾æœŸé—´æ³¨å†ŒæœåŠ¡ç˜«ç—ªã€‚\nåœ¨äº‘éƒ¨ç½²ç¯å¢ƒä¸‹ï¼Œ å› ä¸ºç½‘ç»œé—®é¢˜ä½¿å¾—zké›†ç¾¤å¤±å»masterèŠ‚ç‚¹æ˜¯å¤§æ¦‚ç‡äº‹ä»¶ï¼Œè™½ç„¶æœåŠ¡èƒ½æœ€ç»ˆæ¢å¤ï¼Œä½†æ˜¯æ¼«é•¿çš„é€‰ä¸¾äº‹ä»¶å¯¼è‡´æ³¨å†Œé•¿æœŸä¸å¯ç”¨æ˜¯ä¸èƒ½å®¹å¿çš„ã€‚\nSpring Cloud Eureka -\u0026gt; AP Spring Cloud Netflix åœ¨è®¾è®¡ Eureka æ—¶å°±ç´§éµAPåŸåˆ™ï¼ˆå°½ç®¡ç°åœ¨2.0å‘å¸ƒäº†ï¼Œä½†æ˜¯ç”±äºå…¶é—­æºçš„åŸå›  ï¼Œä½†æ˜¯ç›®å‰ Ereka 1.x ä»»ç„¶æ˜¯æ¯”è¾ƒæ´»è·ƒçš„ï¼‰ã€‚\nEureka Server ä¹Ÿå¯ä»¥è¿è¡Œå¤šä¸ªå®ä¾‹æ¥æ„å»ºé›†ç¾¤ï¼Œè§£å†³å•ç‚¹é—®é¢˜ï¼Œä½†ä¸åŒäº ZooKeeper çš„é€‰ä¸¾ leader çš„è¿‡ç¨‹ï¼ŒEureka Server é‡‡ç”¨çš„æ˜¯Peer to Peer å¯¹ç­‰é€šä¿¡ã€‚è¿™æ˜¯ä¸€ç§å»ä¸­å¿ƒåŒ–çš„æ¶æ„ï¼Œæ—  master/slave ä¹‹åˆ†ï¼Œæ¯ä¸€ä¸ª Peer éƒ½æ˜¯å¯¹ç­‰çš„ã€‚åœ¨è¿™ç§æ¶æ„é£æ ¼ä¸­ï¼ŒèŠ‚ç‚¹é€šè¿‡å½¼æ­¤äº’ç›¸æ³¨å†Œæ¥æé«˜å¯ç”¨æ€§ï¼Œæ¯ä¸ªèŠ‚ç‚¹éœ€è¦æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæœ‰æ•ˆçš„ serviceUrl æŒ‡å‘å…¶ä»–èŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯è¢«è§†ä¸ºå…¶ä»–èŠ‚ç‚¹çš„å‰¯æœ¬ã€‚\nåœ¨é›†ç¾¤ç¯å¢ƒä¸­å¦‚æœæŸå° Eureka Server å®•æœºï¼ŒEureka Client çš„è¯·æ±‚ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°çš„ Eureka Server èŠ‚ç‚¹ä¸Šï¼Œå½“å®•æœºçš„æœåŠ¡å™¨é‡æ–°æ¢å¤åï¼ŒEureka ä¼šå†æ¬¡å°†å…¶çº³å…¥åˆ°æœåŠ¡å™¨é›†ç¾¤ç®¡ç†ä¹‹ä¸­ã€‚å½“èŠ‚ç‚¹å¼€å§‹æ¥å—å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½ä¼šåœ¨èŠ‚ç‚¹é—´è¿›è¡Œå¤åˆ¶ï¼ˆreplicate To Peerï¼‰æ“ä½œï¼Œå°†è¯·æ±‚å¤åˆ¶åˆ°è¯¥ Eureka Server å½“å‰æ‰€çŸ¥çš„å…¶å®ƒæ‰€æœ‰èŠ‚ç‚¹ä¸­ã€‚\nå½“ä¸€ä¸ªæ–°çš„ Eureka Server èŠ‚ç‚¹å¯åŠ¨åï¼Œä¼šé¦–å…ˆå°è¯•ä»é‚»è¿‘èŠ‚ç‚¹è·å–æ‰€æœ‰æ³¨å†Œåˆ—è¡¨ä¿¡æ¯ï¼Œå¹¶å®Œæˆåˆå§‹åŒ–ã€‚Eureka Server é€šè¿‡ getEurekaServiceUrls() æ–¹æ³•è·å–æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¼šé€šè¿‡å¿ƒè·³å¥‘çº¦çš„æ–¹å¼å®šæœŸæ›´æ–°ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœ Eureka Server åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ¥æ”¶åˆ°æŸä¸ªæœåŠ¡å®ä¾‹çš„å¿ƒè·³ï¼ˆé»˜è®¤å‘¨æœŸä¸º30ç§’ï¼‰ï¼ŒEureka Server å°†ä¼šæ³¨é”€è¯¥å®ä¾‹ï¼ˆé»˜è®¤ä¸º90ç§’ï¼Œ eureka.instance.lease-expiration-duration-in-seconds è¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼‰ã€‚\nå½“ Eureka Server èŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…ä¸¢å¤±è¿‡å¤šçš„å¿ƒè·³æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚\nEurekaçš„é›†ç¾¤ä¸­ï¼Œåªè¦æœ‰ä¸€å°Eurekaè¿˜åœ¨ï¼Œå°±èƒ½ä¿è¯æ³¨å†ŒæœåŠ¡å¯ç”¨ï¼ˆä¿è¯å¯ç”¨æ€§ï¼‰ï¼Œåªä¸è¿‡æŸ¥åˆ°çš„ä¿¡æ¯å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼ˆä¸ä¿è¯å¼ºä¸€è‡´æ€§ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒEurekaè¿˜æœ‰ä¸€ç§è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œå¦‚æœåœ¨15åˆ†é’Ÿå†…è¶…è¿‡85%çš„èŠ‚ç‚¹éƒ½æ²¡æœ‰æ­£å¸¸çš„å¿ƒè·³ï¼Œé‚£ä¹ˆEurekaå°±è®¤ä¸ºå®¢æˆ·ç«¯ä¸æ³¨å†Œä¸­å¿ƒå‡ºç°äº†ç½‘ç»œæ•…éšœï¼Œæ­¤æ—¶ä¼šå‡ºç°ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š\n Eurekaä¸å†ä»æ³¨å†Œè¡¨ä¸­ç§»é™¤å› ä¸ºé•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°å¿ƒè·³è€Œè¿‡æœŸçš„æœåŠ¡ï¼› Eurekaä»ç„¶èƒ½å¤Ÿæ¥å—æ–°æœåŠ¡æ³¨å†Œå’ŒæŸ¥è¯¢è¯·æ±‚ï¼Œä½†æ˜¯ä¸ä¼šè¢«åŒæ­¥åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šï¼ˆå³ä¿è¯å½“å‰èŠ‚ç‚¹ä¾ç„¶å¯ç”¨ï¼‰ï¼› å½“ç½‘ç»œç¨³å®šæ—¶ï¼Œå½“å‰å®ä¾‹æ–°æ³¨å†Œçš„ä¿¡æ¯ä¼šè¢«åŒæ­¥åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸­ï¼›  å› æ­¤ï¼ŒEurekaå¯ä»¥å¾ˆå¥½çš„åº”å¯¹å› ç½‘ç»œæ•…éšœå¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹å¤±å»è”ç³»çš„æƒ…å†µï¼Œè€Œä¸ä¼šåƒzookeeperé‚£æ ·ä½¿å¾—æ•´ä¸ªæ³¨å†ŒæœåŠ¡ç˜«ç—ªã€‚\nConsul Consul æ˜¯ HashiCorp å…¬å¸æ¨å‡ºçš„å¼€æºå·¥å…·ï¼Œç”¨äºå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœåŠ¡å‘ç°ä¸é…ç½®ã€‚Consul ä½¿ç”¨ Go è¯­è¨€ç¼–å†™ï¼Œå› æ­¤å…·æœ‰å¤©ç„¶å¯ç§»æ¤æ€§ï¼ˆæ”¯æŒLinuxã€windowså’ŒMac OS Xï¼‰ã€‚\nConsul å†…ç½®äº†æœåŠ¡æ³¨å†Œä¸å‘ç°æ¡†æ¶ã€åˆ†å¸ƒä¸€è‡´æ€§åè®®å®ç°ã€å¥åº·æ£€æŸ¥ã€Key/Value å­˜å‚¨ã€å¤šæ•°æ®ä¸­å¿ƒæ–¹æ¡ˆï¼Œä¸å†éœ€è¦ä¾èµ–å…¶ä»–å·¥å…·ï¼ˆæ¯”å¦‚ ZooKeeper ç­‰ï¼‰ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿè¾ƒä¸ºç®€å•ã€‚\nConsul éµå¾ªCAPåŸç†ä¸­çš„CPåŸåˆ™ï¼Œä¿è¯äº†å¼ºä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œä¸”ä½¿ç”¨çš„æ˜¯Raftç®—æ³•ï¼Œæ¯”zookeeperä½¿ç”¨çš„Paxosç®—æ³•æ›´åŠ ç®€å•ã€‚è™½ç„¶ä¿è¯äº†å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯å¯ç”¨æ€§å°±ç›¸åº”ä¸‹é™äº†ï¼Œä¾‹å¦‚æœåŠ¡æ³¨å†Œçš„æ—¶é—´ä¼šç¨é•¿ä¸€äº›ï¼Œå› ä¸º Consul çš„ raft åè®®è¦æ±‚å¿…é¡»è¿‡åŠæ•°çš„èŠ‚ç‚¹éƒ½å†™å…¥æˆåŠŸæ‰è®¤ä¸ºæ³¨å†ŒæˆåŠŸ ï¼›åœ¨leaderæŒ‚æ‰äº†ä¹‹åï¼Œé‡æ–°é€‰ä¸¾å‡ºleaderä¹‹å‰ä¼šå¯¼è‡´Consul æœåŠ¡ä¸å¯ç”¨ã€‚\nConsulæœ¬è´¨ä¸Šå±äºåº”ç”¨å¤–çš„æ³¨å†Œæ–¹å¼ï¼Œä½†å¯ä»¥é€šè¿‡SDKç®€åŒ–æ³¨å†Œæµç¨‹ã€‚è€ŒæœåŠ¡å‘ç°æ°å¥½ç›¸åï¼Œé»˜è®¤ä¾èµ–äºSDKï¼Œä½†å¯ä»¥é€šè¿‡Consul Templateï¼ˆä¸‹æ–‡ä¼šæåˆ°ï¼‰å»é™¤SDKä¾èµ–ã€‚\nConsul Template Consulï¼Œé»˜è®¤æœåŠ¡è°ƒç”¨è€…éœ€è¦ä¾èµ–Consul SDKæ¥å‘ç°æœåŠ¡ï¼Œè¿™å°±æ— æ³•ä¿è¯å¯¹åº”ç”¨çš„é›¶ä¾µå…¥æ€§ã€‚\næ‰€å¹¸é€šè¿‡Consul Template\rï¼Œå¯ä»¥å®šæ—¶ä»Consulé›†ç¾¤è·å–æœ€æ–°çš„æœåŠ¡æä¾›è€…åˆ—è¡¨å¹¶åˆ·æ–°LBé…ç½®ï¼ˆæ¯”å¦‚nginxçš„upstreamï¼‰ï¼Œè¿™æ ·å¯¹äºæœåŠ¡è°ƒç”¨è€…è€Œè¨€ï¼Œåªéœ€è¦é…ç½®ä¸€ä¸ªç»Ÿä¸€çš„æœåŠ¡è°ƒç”¨åœ°å€å³å¯ã€‚\nConsulå¼ºä¸€è‡´æ€§(C)å¸¦æ¥çš„æ˜¯ï¼š\n æœåŠ¡æ³¨å†Œç›¸æ¯”Eurekaä¼šç¨æ…¢ä¸€äº›ã€‚å› ä¸ºConsulçš„raftåè®®è¦æ±‚å¿…é¡»è¿‡åŠæ•°çš„èŠ‚ç‚¹éƒ½å†™å…¥æˆåŠŸæ‰è®¤ä¸ºæ³¨å†ŒæˆåŠŸ LeaderæŒ‚æ‰æ—¶ï¼Œé‡æ–°é€‰ä¸¾æœŸé—´æ•´ä¸ªconsulä¸å¯ç”¨ã€‚ä¿è¯äº†å¼ºä¸€è‡´æ€§ä½†ç‰ºç‰²äº†å¯ç”¨æ€§ã€‚  Eurekaä¿è¯é«˜å¯ç”¨(A)å’Œæœ€ç»ˆä¸€è‡´æ€§ï¼š\n æœåŠ¡æ³¨å†Œç›¸å¯¹è¦å¿«ï¼Œå› ä¸ºä¸éœ€è¦ç­‰æ³¨å†Œä¿¡æ¯replicateåˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œä¹Ÿä¸ä¿è¯æ³¨å†Œä¿¡æ¯æ˜¯å¦replicateæˆåŠŸ å½“æ•°æ®å‡ºç°ä¸ä¸€è‡´æ—¶ï¼Œè™½ç„¶A, Bä¸Šçš„æ³¨å†Œä¿¡æ¯ä¸å®Œå…¨ç›¸åŒï¼Œä½†æ¯ä¸ªEurekaèŠ‚ç‚¹ä¾ç„¶èƒ½å¤Ÿæ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™ä¼šå‡ºç°æŸ¥è¯¢æœåŠ¡ä¿¡æ¯æ—¶å¦‚æœè¯·æ±‚AæŸ¥ä¸åˆ°ï¼Œä½†è¯·æ±‚Bå°±èƒ½æŸ¥åˆ°ã€‚å¦‚æ­¤ä¿è¯äº†å¯ç”¨æ€§ä½†ç‰ºç‰²äº†ä¸€è‡´æ€§ã€‚  å…¶ä»–æ–¹é¢ï¼Œeurekaå°±æ˜¯ä¸ªservletç¨‹åºï¼Œè·‘åœ¨servletå®¹å™¨ä¸­; Consulåˆ™æ˜¯goç¼–å†™è€Œæˆã€‚\nNacos Nacosæ˜¯é˜¿é‡Œå¼€æºçš„ï¼ŒNacos æ”¯æŒåŸºäº DNS å’ŒåŸºäº RPC çš„æœåŠ¡å‘ç°ã€‚åœ¨Spring Cloudä¸­ä½¿ç”¨Nacosï¼Œåªéœ€è¦å…ˆä¸‹è½½ Nacos å¹¶å¯åŠ¨ Nacos serverï¼ŒNacosåªéœ€è¦ç®€å•çš„é…ç½®å°±å¯ä»¥å®ŒæˆæœåŠ¡çš„æ³¨å†Œå‘ç°ã€‚\nNacosé™¤äº†æœåŠ¡çš„æ³¨å†Œå‘ç°ä¹‹å¤–ï¼Œè¿˜æ”¯æŒåŠ¨æ€é…ç½®æœåŠ¡ã€‚åŠ¨æ€é…ç½®æœåŠ¡å¯ä»¥è®©æ‚¨ä»¥ä¸­å¿ƒåŒ–ã€å¤–éƒ¨åŒ–å’ŒåŠ¨æ€åŒ–çš„æ–¹å¼ç®¡ç†æ‰€æœ‰ç¯å¢ƒçš„åº”ç”¨é…ç½®å’ŒæœåŠ¡é…ç½®ã€‚åŠ¨æ€é…ç½®æ¶ˆé™¤äº†é…ç½®å˜æ›´æ—¶é‡æ–°éƒ¨ç½²åº”ç”¨å’ŒæœåŠ¡çš„éœ€è¦ï¼Œè®©é…ç½®ç®¡ç†å˜å¾—æ›´åŠ é«˜æ•ˆå’Œæ•æ·ã€‚é…ç½®ä¸­å¿ƒåŒ–ç®¡ç†è®©å®ç°æ— çŠ¶æ€æœåŠ¡å˜å¾—æ›´ç®€å•ï¼Œè®©æœåŠ¡æŒ‰éœ€å¼¹æ€§æ‰©å±•å˜å¾—æ›´å®¹æ˜“ã€‚\nä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯Nacos = Spring Cloudæ³¨å†Œä¸­å¿ƒ + Spring Cloudé…ç½®ä¸­å¿ƒã€‚\nå‚è€ƒ å¾®æœåŠ¡ï¼šæ³¨å†Œä¸­å¿ƒZooKeeperã€Eurekaã€Consul ã€Nacoså¯¹æ¯”\ræ³¨å†Œä¸­å¿ƒé€‰å‹ç¯‡-å››æ¬¾æ³¨å†Œä¸­å¿ƒç‰¹ç‚¹è¶…å…¨æ€»ç»“\rè§£æ„ Dubbo-go çš„æ ¸å¿ƒæ³¨å†Œå¼•æ“ Nacos\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/%E5%87%A0%E7%A7%8D%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AF%B9%E6%AF%94/","series":["Manual"],"tags":["CS"],"title":"å‡ ç§æ³¨å†Œä¸­å¿ƒå¯¹æ¯”"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"åˆ†å¸ƒå¼IDç”Ÿæˆæ–¹å¼ ä¸€ã€ä¸ºä»€ä¹ˆè¦ç”¨åˆ†å¸ƒå¼IDï¼Ÿ åœ¨è¯´åˆ†å¸ƒå¼IDçš„å…·ä½“å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥ç®€å•åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆç”¨åˆ†å¸ƒå¼IDï¼Ÿåˆ†å¸ƒå¼IDåº”è¯¥æ»¡è¶³å“ªäº›ç‰¹å¾ï¼Ÿ\n1ã€ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼IDï¼Ÿ æ‹¿MySQLæ•°æ®åº“ä¸¾ä¸ªæ —å­ï¼š\nåœ¨æˆ‘ä»¬ä¸šåŠ¡æ•°æ®é‡ä¸å¤§çš„æ—¶å€™ï¼Œå•åº“å•è¡¨å®Œå…¨å¯ä»¥æ”¯æ’‘ç°æœ‰ä¸šåŠ¡ï¼Œæ•°æ®å†å¤§ä¸€ç‚¹æä¸ªMySQLä¸»ä»åŒæ­¥è¯»å†™åˆ†ç¦»ä¹Ÿèƒ½å¯¹ä»˜ã€‚\nä½†éšç€æ•°æ®æ—¥æ¸å¢é•¿ï¼Œä¸»ä»åŒæ­¥ä¹Ÿæ‰›ä¸ä½äº†ï¼Œå°±éœ€è¦å¯¹æ•°æ®åº“è¿›è¡Œåˆ†åº“åˆ†è¡¨ï¼Œä½†åˆ†åº“åˆ†è¡¨åéœ€è¦æœ‰ä¸€ä¸ªå”¯ä¸€IDæ¥æ ‡è¯†ä¸€æ¡æ•°æ®ï¼Œæ•°æ®åº“çš„è‡ªå¢IDæ˜¾ç„¶ä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼›ç‰¹åˆ«ä¸€ç‚¹çš„å¦‚è®¢å•ã€ä¼˜æƒ åˆ¸ä¹Ÿéƒ½éœ€è¦æœ‰å”¯ä¸€IDåšæ ‡è¯†ã€‚æ­¤æ—¶ä¸€ä¸ªèƒ½å¤Ÿç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„ç³»ç»Ÿæ˜¯éå¸¸å¿…è¦çš„ã€‚é‚£ä¹ˆè¿™ä¸ªå…¨å±€å”¯ä¸€IDå°±å«åˆ†å¸ƒå¼IDã€‚\n2ã€é‚£ä¹ˆåˆ†å¸ƒå¼IDéœ€è¦æ»¡è¶³é‚£äº›æ¡ä»¶ï¼Ÿ  å…¨å±€å”¯ä¸€ï¼šå¿…é¡»ä¿è¯IDæ˜¯å…¨å±€æ€§å”¯ä¸€çš„ï¼ŒåŸºæœ¬è¦æ±‚ é«˜æ€§èƒ½ï¼šé«˜å¯ç”¨ä½å»¶æ—¶ï¼ŒIDç”Ÿæˆå“åº”è¦å—ï¼Œå¦åˆ™åå€’ä¼šæˆä¸ºä¸šåŠ¡ç“¶é¢ˆ é«˜å¯ç”¨ï¼š100%çš„å¯ç”¨æ€§æ˜¯éª—äººçš„ï¼Œä½†æ˜¯ä¹Ÿè¦æ— é™æ¥è¿‘äº100%çš„å¯ç”¨æ€§ å¥½æ¥å…¥ï¼šè¦ç§‰ç€æ‹¿æ¥å³ç”¨çš„è®¾è®¡åŸåˆ™ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡å’Œå®ç°ä¸Šè¦å°½å¯èƒ½çš„ç®€å• è¶‹åŠ¿é€’å¢ï¼šæœ€å¥½è¶‹åŠ¿é€’å¢ï¼Œè¿™ä¸ªè¦æ±‚å°±å¾—çœ‹å…·ä½“ä¸šåŠ¡åœºæ™¯äº†ï¼Œä¸€èˆ¬ä¸ä¸¥æ ¼è¦æ±‚  äºŒã€ åˆ†å¸ƒå¼IDéƒ½æœ‰å“ªäº›ç”Ÿæˆæ–¹å¼ï¼Ÿ ä»Šå¤©ä¸»è¦åˆ†æä¸€ä¸‹ä»¥ä¸‹9ç§ï¼Œåˆ†å¸ƒå¼IDç”Ÿæˆå™¨æ–¹å¼ä»¥åŠä¼˜ç¼ºç‚¹ï¼š\n UUID æ•°æ®åº“è‡ªå¢ID æ•°æ®åº“å¤šä¸»æ¨¡å¼ å·æ®µæ¨¡å¼ Redis é›ªèŠ±ç®—æ³•ï¼ˆSnowFlakeï¼‰ æ»´æ»´å‡ºå“ï¼ˆTinyIDï¼‰ ç™¾åº¦ ï¼ˆUidgeneratorï¼‰ ç¾å›¢ï¼ˆLeafï¼‰  é‚£ä¹ˆå®ƒä»¬éƒ½æ˜¯å¦‚ä½•å®ç°ï¼Ÿä»¥åŠå„è‡ªæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿæˆ‘ä»¬å¾€ä¸‹çœ‹\n ä»¥ä¸Šå›¾ç‰‡æºè‡ªç½‘ç»œï¼Œå¦‚æœ‰ä¾µæƒè”ç³»åˆ é™¤\n 1ã€åŸºäºUUID åœ¨Javaçš„ä¸–ç•Œé‡Œï¼Œæƒ³è¦å¾—åˆ°ä¸€ä¸ªå…·æœ‰å”¯ä¸€æ€§çš„IDï¼Œé¦–å…ˆè¢«æƒ³åˆ°å¯èƒ½å°±æ˜¯UUIDï¼Œæ¯•ç«Ÿå®ƒæœ‰ç€å…¨çƒå”¯ä¸€çš„ç‰¹æ€§ã€‚é‚£ä¹ˆUUIDå¯ä»¥åšåˆ†å¸ƒå¼IDå—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¹¶ä¸æ¨èï¼\npublic static void main(String[] args) { String uuid = UUID.randomUUID().toString().replaceAll(\u0026#34;-\u0026#34;,\u0026#34;\u0026#34;); System.out.println(uuid); } UUIDçš„ç”Ÿæˆç®€å•åˆ°åªæœ‰ä¸€è¡Œä»£ç ï¼Œè¾“å‡ºç»“æœ c2b8c2b9e46c47e3b30dca3b0d447718ï¼Œä½†UUIDå´å¹¶ä¸é€‚ç”¨äºå®é™…çš„ä¸šåŠ¡éœ€æ±‚ã€‚åƒç”¨ä½œè®¢å•å·UUIDè¿™æ ·çš„å­—ç¬¦ä¸²æ²¡æœ‰ä¸æ¯«çš„æ„ä¹‰ï¼Œçœ‹ä¸å‡ºå’Œè®¢å•ç›¸å…³çš„æœ‰ç”¨ä¿¡æ¯ï¼›è€Œå¯¹äºæ•°æ®åº“æ¥è¯´ç”¨ä½œä¸šåŠ¡ä¸»é”®IDï¼Œå®ƒä¸ä»…æ˜¯å¤ªé•¿è¿˜æ˜¯å­—ç¬¦ä¸²ï¼Œå­˜å‚¨æ€§èƒ½å·®æŸ¥è¯¢ä¹Ÿå¾ˆè€—æ—¶ï¼Œæ‰€ä»¥ä¸æ¨èç”¨ä½œåˆ†å¸ƒå¼IDã€‚\nä¼˜ç‚¹ï¼š\n ç”Ÿæˆè¶³å¤Ÿç®€å•ï¼Œæœ¬åœ°ç”Ÿæˆæ— ç½‘ç»œæ¶ˆè€—ï¼Œå…·æœ‰å”¯ä¸€æ€§  ç¼ºç‚¹ï¼š\n æ— åºçš„å­—ç¬¦ä¸²ï¼Œä¸å…·å¤‡è¶‹åŠ¿è‡ªå¢ç‰¹æ€§ æ²¡æœ‰å…·ä½“çš„ä¸šåŠ¡å«ä¹‰ é•¿åº¦è¿‡é•¿16 å­—èŠ‚128ä½ï¼Œ36ä½é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œå­˜å‚¨ä»¥åŠæŸ¥è¯¢å¯¹MySQLçš„æ€§èƒ½æ¶ˆè€—è¾ƒå¤§ï¼ŒMySQLå®˜æ–¹æ˜ç¡®å»ºè®®ä¸»é”®è¦å°½é‡è¶ŠçŸ­è¶Šå¥½ï¼Œä½œä¸ºæ•°æ®åº“ä¸»é”® UUID çš„æ— åºæ€§ä¼šå¯¼è‡´æ•°æ®ä½ç½®é¢‘ç¹å˜åŠ¨ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚  2ã€åŸºäºæ•°æ®åº“è‡ªå¢ID åŸºäºæ•°æ®åº“çš„auto_incrementè‡ªå¢IDå®Œå…¨å¯ä»¥å……å½“åˆ†å¸ƒå¼IDï¼Œå…·ä½“å®ç°ï¼šéœ€è¦ä¸€ä¸ªå•ç‹¬çš„MySQLå®ä¾‹ç”¨æ¥ç”ŸæˆIDï¼Œå»ºè¡¨ç»“æ„å¦‚ä¸‹ï¼š\nCREATE DATABASE `SEQ_ID`; CREATE TABLE SEQID.SEQUENCE_ID ( id bigint(20) unsigned NOT NULL auto_increment, value char(10) NOT NULL default \u0026#39;\u0026#39;, PRIMARY KEY (id), ) ENGINE=MyISAM; insert into SEQUENCE_ID(value) VALUES (\u0026#39;values\u0026#39;); å½“æˆ‘ä»¬éœ€è¦ä¸€ä¸ªIDçš„æ—¶å€™ï¼Œå‘è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•è¿”å›ä¸»é”®IDï¼Œä½†è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„ç¼ºç‚¹ï¼Œè®¿é—®é‡æ¿€å¢æ—¶MySQLæœ¬èº«å°±æ˜¯ç³»ç»Ÿçš„ç“¶é¢ˆï¼Œç”¨å®ƒæ¥å®ç°åˆ†å¸ƒå¼æœåŠ¡é£é™©æ¯”è¾ƒå¤§ï¼Œä¸æ¨èï¼\nä¼˜ç‚¹ï¼š\n å®ç°ç®€å•ï¼ŒIDå•è°ƒè‡ªå¢ï¼Œæ•°å€¼ç±»å‹æŸ¥è¯¢é€Ÿåº¦å¿«  ç¼ºç‚¹ï¼š\n DBå•ç‚¹å­˜åœ¨å®•æœºé£é™©ï¼Œæ— æ³•æ‰›ä½é«˜å¹¶å‘åœºæ™¯  3ã€åŸºäºæ•°æ®åº“é›†ç¾¤æ¨¡å¼ å‰è¾¹è¯´äº†å•ç‚¹æ•°æ®åº“æ–¹å¼ä¸å¯å–ï¼Œé‚£å¯¹ä¸Šè¾¹çš„æ–¹å¼åšä¸€äº›é«˜å¯ç”¨ä¼˜åŒ–ï¼Œæ¢æˆä¸»ä»æ¨¡å¼é›†ç¾¤ã€‚å®³æ€•ä¸€ä¸ªä¸»èŠ‚ç‚¹æŒ‚æ‰æ²¡æ³•ç”¨ï¼Œé‚£å°±åšåŒä¸»æ¨¡å¼é›†ç¾¤ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªMysqlå®ä¾‹éƒ½èƒ½å•ç‹¬çš„ç”Ÿäº§è‡ªå¢IDã€‚\né‚£è¿™æ ·è¿˜ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œä¸¤ä¸ªMySQLå®ä¾‹çš„è‡ªå¢IDéƒ½ä»1å¼€å§‹ï¼Œä¼šç”Ÿæˆé‡å¤çš„IDæ€ä¹ˆåŠï¼Ÿ\nè§£å†³æ–¹æ¡ˆï¼šè®¾ç½®èµ·å§‹å€¼å’Œè‡ªå¢æ­¥é•¿\nMySQL_1 é…ç½®ï¼š\nset @@auto_increment_offset = 1; -- èµ·å§‹å€¼ set @@auto_increment_increment = 2; -- æ­¥é•¿ MySQL_2 é…ç½®ï¼š\nset @@auto_increment_offset = 2; -- èµ·å§‹å€¼ set @@auto_increment_increment = 2; -- æ­¥é•¿ è¿™æ ·ä¸¤ä¸ªMySQLå®ä¾‹çš„è‡ªå¢IDåˆ†åˆ«å°±æ˜¯ï¼š\n 1ã€3ã€5ã€7ã€9 2ã€4ã€6ã€8ã€10\n é‚£å¦‚æœé›†ç¾¤åçš„æ€§èƒ½è¿˜æ˜¯æ‰›ä¸ä½é«˜å¹¶å‘å’‹åŠï¼Ÿå°±è¦è¿›è¡ŒMySQLæ‰©å®¹å¢åŠ èŠ‚ç‚¹ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒéº»çƒ¦çš„äº‹ã€‚\nä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæ°´å¹³æ‰©å±•çš„æ•°æ®åº“é›†ç¾¤ï¼Œæœ‰åˆ©äºè§£å†³æ•°æ®åº“å•ç‚¹å‹åŠ›çš„é—®é¢˜ï¼ŒåŒæ—¶ä¸ºäº†IDç”Ÿæˆç‰¹æ€§ï¼Œå°†è‡ªå¢æ­¥é•¿æŒ‰ç…§æœºå™¨æ•°é‡æ¥è®¾ç½®ã€‚\nå¢åŠ ç¬¬ä¸‰å°MySQLå®ä¾‹éœ€è¦äººå·¥ä¿®æ”¹ä¸€ã€äºŒä¸¤å°MySQLå®ä¾‹çš„èµ·å§‹å€¼å’Œæ­¥é•¿ï¼ŒæŠŠç¬¬ä¸‰å°æœºå™¨çš„IDèµ·å§‹ç”Ÿæˆä½ç½®è®¾å®šåœ¨æ¯”ç°æœ‰æœ€å¤§è‡ªå¢IDçš„ä½ç½®è¿œä¸€äº›ï¼Œä½†å¿…é¡»åœ¨ä¸€ã€äºŒä¸¤å°MySQLå®ä¾‹IDè¿˜æ²¡æœ‰å¢é•¿åˆ°ç¬¬ä¸‰å°MySQLå®ä¾‹çš„èµ·å§‹IDå€¼çš„æ—¶å€™ï¼Œå¦åˆ™è‡ªå¢IDå°±è¦å‡ºç°é‡å¤äº†ï¼Œå¿…è¦æ—¶å¯èƒ½è¿˜éœ€è¦åœæœºä¿®æ”¹ã€‚\nä¼˜ç‚¹ï¼š\n è§£å†³DBå•ç‚¹é—®é¢˜  ç¼ºç‚¹ï¼š\n ä¸åˆ©äºåç»­æ‰©å®¹ï¼Œè€Œä¸”å®é™…ä¸Šå•ä¸ªæ•°æ®åº“è‡ªèº«å‹åŠ›è¿˜æ˜¯å¤§ï¼Œä¾æ—§æ— æ³•æ»¡è¶³é«˜å¹¶å‘åœºæ™¯ã€‚  4ã€åŸºäºæ•°æ®åº“çš„å·æ®µæ¨¡å¼ å·æ®µæ¨¡å¼æ˜¯å½“ä¸‹åˆ†å¸ƒå¼IDç”Ÿæˆå™¨çš„ä¸»æµå®ç°æ–¹å¼ä¹‹ä¸€ï¼Œå·æ®µæ¨¡å¼å¯ä»¥ç†è§£ä¸ºä»æ•°æ®åº“æ‰¹é‡çš„è·å–è‡ªå¢IDï¼Œæ¯æ¬¡ä»æ•°æ®åº“å–å‡ºä¸€ä¸ªå·æ®µèŒƒå›´ï¼Œä¾‹å¦‚ (1,1000] ä»£è¡¨1000ä¸ªIDï¼Œå…·ä½“çš„ä¸šåŠ¡æœåŠ¡å°†æœ¬å·æ®µï¼Œç”Ÿæˆ1~1000çš„è‡ªå¢IDå¹¶åŠ è½½åˆ°å†…å­˜ã€‚è¡¨ç»“æ„å¦‚ä¸‹ï¼š\nCREATE TABLE id_generator ( id int(10) NOT NULL, max_id bigint(20) NOT NULL COMMENT \u0026#39;å½“å‰æœ€å¤§id\u0026#39;, step int(20) NOT NULL COMMENT \u0026#39;å·æ®µçš„å¸ƒé•¿\u0026#39;, biz_type int(20) NOT NULL COMMENT \u0026#39;ä¸šåŠ¡ç±»å‹\u0026#39;, version int(20) NOT NULL COMMENT \u0026#39;ç‰ˆæœ¬å·\u0026#39;, PRIMARY KEY (`id`) ) biz_type ï¼šä»£è¡¨ä¸åŒä¸šåŠ¡ç±»å‹\nmax_id ï¼šå½“å‰æœ€å¤§çš„å¯ç”¨id\nstep ï¼šä»£è¡¨å·æ®µçš„é•¿åº¦\nversion ï¼šæ˜¯ä¸€ä¸ªä¹è§‚é”ï¼Œæ¯æ¬¡éƒ½æ›´æ–°versionï¼Œä¿è¯å¹¶å‘æ—¶æ•°æ®çš„æ­£ç¡®æ€§\n   id biz_type max_id step version     1 101 1000 2000 0    ç­‰è¿™æ‰¹å·æ®µIDç”¨å®Œï¼Œå†æ¬¡å‘æ•°æ®åº“ç”³è¯·æ–°å·æ®µï¼Œå¯¹max_idå­—æ®µåšä¸€æ¬¡updateæ“ä½œï¼Œupdate max_id= max_id + stepï¼ŒupdateæˆåŠŸåˆ™è¯´æ˜æ–°å·æ®µè·å–æˆåŠŸï¼Œæ–°çš„å·æ®µèŒƒå›´æ˜¯(max_id ,max_id +step]ã€‚\nupdate id_generator set max_id = #{max_id+step}, version = version + 1 where version = # {version} and biz_type = XXX ç”±äºå¤šä¸šåŠ¡ç«¯å¯èƒ½åŒæ—¶æ“ä½œï¼Œæ‰€ä»¥é‡‡ç”¨ç‰ˆæœ¬å·versionä¹è§‚é”æ–¹å¼æ›´æ–°ï¼Œè¿™ç§åˆ†å¸ƒå¼IDç”Ÿæˆæ–¹å¼ä¸å¼ºä¾èµ–äºæ•°æ®åº“ï¼Œä¸ä¼šé¢‘ç¹çš„è®¿é—®æ•°æ®åº“ï¼Œå¯¹æ•°æ®åº“çš„å‹åŠ›å°å¾ˆå¤šã€‚\n5ã€åŸºäºRedisæ¨¡å¼ Redisä¹ŸåŒæ ·å¯ä»¥å®ç°ï¼ŒåŸç†å°±æ˜¯åˆ©ç”¨redisçš„ incrå‘½ä»¤å®ç°IDçš„åŸå­æ€§è‡ªå¢ã€‚\n127.0.0.1:6379\u0026gt; set seq_id 1 // åˆå§‹åŒ–è‡ªå¢IDä¸º1 OK 127.0.0.1:6379\u0026gt; incr seq_id // å¢åŠ 1ï¼Œå¹¶è¿”å›é€’å¢åçš„æ•°å€¼ (integer) 2 ç”¨rediså®ç°éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œè¦è€ƒè™‘åˆ°redisæŒä¹…åŒ–çš„é—®é¢˜ã€‚redisæœ‰ä¸¤ç§æŒä¹…åŒ–æ–¹å¼RDBå’ŒAOF\n RDBä¼šå®šæ—¶æ‰“ä¸€ä¸ªå¿«ç…§è¿›è¡ŒæŒä¹…åŒ–ï¼Œå‡å¦‚è¿ç»­è‡ªå¢ä½†redisæ²¡åŠæ—¶æŒä¹…åŒ–ï¼Œè€Œè¿™ä¼šRedisæŒ‚æ‰äº†ï¼Œé‡å¯Redisåä¼šå‡ºç°IDé‡å¤çš„æƒ…å†µã€‚ AOFä¼šå¯¹æ¯æ¡å†™å‘½ä»¤è¿›è¡ŒæŒä¹…åŒ–ï¼Œå³ä½¿RedisæŒ‚æ‰äº†ä¹Ÿä¸ä¼šå‡ºç°IDé‡å¤çš„æƒ…å†µï¼Œä½†ç”±äºincrå‘½ä»¤çš„ç‰¹æ®Šæ€§ï¼Œä¼šå¯¼è‡´Redisé‡å¯æ¢å¤çš„æ•°æ®æ—¶é—´è¿‡é•¿ã€‚  6ã€åŸºäºé›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰æ¨¡å¼ é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰æ˜¯twitterå…¬å¸å†…éƒ¨åˆ†å¸ƒå¼é¡¹ç›®é‡‡ç”¨çš„IDç”Ÿæˆç®—æ³•ï¼Œå¼€æºåå¹¿å—å›½å†…å¤§å‚çš„å¥½è¯„ï¼Œåœ¨è¯¥ç®—æ³•å½±å“ä¸‹å„å¤§å…¬å¸ç›¸ç»§å¼€å‘å‡ºå„å…·ç‰¹è‰²çš„åˆ†å¸ƒå¼ç”Ÿæˆå™¨ã€‚\n ä»¥ä¸Šå›¾ç‰‡æºè‡ªç½‘ç»œï¼Œå¦‚æœ‰ä¾µæƒè”ç³»åˆ é™¤\n Snowflakeç”Ÿæˆçš„æ˜¯Longç±»å‹çš„IDï¼Œä¸€ä¸ªLongç±»å‹å 8ä¸ªå­—èŠ‚ï¼Œæ¯ä¸ªå­—èŠ‚å 8æ¯”ç‰¹ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªLongç±»å‹å 64ä¸ªæ¯”ç‰¹ã€‚\nSnowflake IDç»„æˆç»“æ„ï¼šæ­£æ•°ä½ï¼ˆå 1æ¯”ç‰¹ï¼‰+ æ—¶é—´æˆ³ï¼ˆå 41æ¯”ç‰¹ï¼‰+ æœºå™¨IDï¼ˆå 5æ¯”ç‰¹ï¼‰+ æ•°æ®ä¸­å¿ƒï¼ˆå 5æ¯”ç‰¹ï¼‰+ è‡ªå¢å€¼ï¼ˆå 12æ¯”ç‰¹ï¼‰ï¼Œæ€»å…±64æ¯”ç‰¹ç»„æˆçš„ä¸€ä¸ªLongç±»å‹ã€‚\n ç¬¬ä¸€ä¸ªbitä½ï¼ˆ1bitï¼‰ï¼šJavaä¸­longçš„æœ€é«˜ä½æ˜¯ç¬¦å·ä½ä»£è¡¨æ­£è´Ÿï¼Œæ­£æ•°æ˜¯0ï¼Œè´Ÿæ•°æ˜¯1ï¼Œä¸€èˆ¬ç”ŸæˆIDéƒ½ä¸ºæ­£æ•°ï¼Œæ‰€ä»¥é»˜è®¤ä¸º0ã€‚ æ—¶é—´æˆ³éƒ¨åˆ†ï¼ˆ41bitï¼‰ï¼šæ¯«ç§’çº§çš„æ—¶é—´ï¼Œä¸å»ºè®®å­˜å½“å‰æ—¶é—´æˆ³ï¼Œè€Œæ˜¯ç”¨ï¼ˆå½“å‰æ—¶é—´æˆ³ - å›ºå®šå¼€å§‹æ—¶é—´æˆ³ï¼‰çš„å·®å€¼ï¼Œå¯ä»¥ä½¿äº§ç”Ÿçš„IDä»æ›´å°çš„å€¼å¼€å§‹ï¼›41ä½çš„æ—¶é—´æˆ³å¯ä»¥ä½¿ç”¨69å¹´ï¼Œ(1L \u0026laquo; 41) / (1000L * 60 * 60 * 24 * 365) = 69å¹´ å·¥ä½œæœºå™¨idï¼ˆ10bitï¼‰ï¼šä¹Ÿè¢«å«åšworkIdï¼Œè¿™ä¸ªå¯ä»¥çµæ´»é…ç½®ï¼Œæœºæˆ¿æˆ–è€…æœºå™¨å·ç»„åˆéƒ½å¯ä»¥ã€‚ åºåˆ—å·éƒ¨åˆ†ï¼ˆ12bitï¼‰ï¼Œè‡ªå¢å€¼æ”¯æŒåŒä¸€æ¯«ç§’å†…åŒä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥ç”Ÿæˆ4096ä¸ªID  æ ¹æ®è¿™ä¸ªç®—æ³•çš„é€»è¾‘ï¼Œåªéœ€è¦å°†è¿™ä¸ªç®—æ³•ç”¨Javaè¯­è¨€å®ç°å‡ºæ¥ï¼Œå°è£…ä¸ºä¸€ä¸ªå·¥å…·æ–¹æ³•ï¼Œé‚£ä¹ˆå„ä¸ªä¸šåŠ¡åº”ç”¨å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥å·¥å…·æ–¹æ³•æ¥è·å–åˆ†å¸ƒå¼IDï¼Œåªéœ€ä¿è¯æ¯ä¸ªä¸šåŠ¡åº”ç”¨æœ‰è‡ªå·±çš„å·¥ä½œæœºå™¨idå³å¯ï¼Œè€Œä¸éœ€è¦å•ç‹¬å»æ­å»ºä¸€ä¸ªè·å–åˆ†å¸ƒå¼IDçš„åº”ç”¨ã€‚\nJavaç‰ˆæœ¬çš„Snowflakeç®—æ³•å®ç°ï¼š\n/** * Twitterçš„SnowFlakeç®—æ³•,ä½¿ç”¨SnowFlakeç®—æ³•ç”Ÿæˆä¸€ä¸ªæ•´æ•°ï¼Œç„¶åè½¬åŒ–ä¸º62è¿›åˆ¶å˜æˆä¸€ä¸ªçŸ­åœ°å€URL * * https://github.com/beyondfengyu/SnowFlake */ public class SnowFlakeShortUrl { /** * èµ·å§‹çš„æ—¶é—´æˆ³ */ private final static long START_TIMESTAMP = 1480166465631L; /** * æ¯ä¸€éƒ¨åˆ†å ç”¨çš„ä½æ•° */ private final static long SEQUENCE_BIT = 12; //åºåˆ—å·å ç”¨çš„ä½æ•°  private final static long MACHINE_BIT = 5; //æœºå™¨æ ‡è¯†å ç”¨çš„ä½æ•°  private final static long DATA_CENTER_BIT = 5; //æ•°æ®ä¸­å¿ƒå ç”¨çš„ä½æ•°  /** * æ¯ä¸€éƒ¨åˆ†çš„æœ€å¤§å€¼ */ private final static long MAX_SEQUENCE = -1L ^ (-1L \u0026lt;\u0026lt; SEQUENCE_BIT); private final static long MAX_MACHINE_NUM = -1L ^ (-1L \u0026lt;\u0026lt; MACHINE_BIT); private final static long MAX_DATA_CENTER_NUM = -1L ^ (-1L \u0026lt;\u0026lt; DATA_CENTER_BIT); /** * æ¯ä¸€éƒ¨åˆ†å‘å·¦çš„ä½ç§» */ private final static long MACHINE_LEFT = SEQUENCE_BIT; private final static long DATA_CENTER_LEFT = SEQUENCE_BIT + MACHINE_BIT; private final static long TIMESTAMP_LEFT = DATA_CENTER_LEFT + DATA_CENTER_BIT; private long dataCenterId; //æ•°æ®ä¸­å¿ƒ  private long machineId; //æœºå™¨æ ‡è¯†  private long sequence = 0L; //åºåˆ—å·  private long lastTimeStamp = -1L; //ä¸Šä¸€æ¬¡æ—¶é—´æˆ³  private long getNextMill() { long mill = getNewTimeStamp(); while (mill \u0026lt;= lastTimeStamp) { mill = getNewTimeStamp(); } return mill; } private long getNewTimeStamp() { return System.currentTimeMillis(); } /** * æ ¹æ®æŒ‡å®šçš„æ•°æ®ä¸­å¿ƒIDå’Œæœºå™¨æ ‡å¿—IDç”ŸæˆæŒ‡å®šçš„åºåˆ—å· * * @param dataCenterId æ•°æ®ä¸­å¿ƒID * @param machineId æœºå™¨æ ‡å¿—ID */ public SnowFlakeShortUrl(long dataCenterId, long machineId) { if (dataCenterId \u0026gt; MAX_DATA_CENTER_NUM || dataCenterId \u0026lt; 0) { throw new IllegalArgumentException(\u0026#34;DtaCenterId can\u0026#39;t be greater than MAX_DATA_CENTER_NUM or less than 0ï¼\u0026#34;); } if (machineId \u0026gt; MAX_MACHINE_NUM || machineId \u0026lt; 0) { throw new IllegalArgumentException(\u0026#34;MachineId can\u0026#39;t be greater than MAX_MACHINE_NUM or less than 0ï¼\u0026#34;); } this.dataCenterId = dataCenterId; this.machineId = machineId; } /** * äº§ç”Ÿä¸‹ä¸€ä¸ªID * * @return */ public synchronized long nextId() { long currTimeStamp = getNewTimeStamp(); if (currTimeStamp \u0026lt; lastTimeStamp) { throw new RuntimeException(\u0026#34;Clock moved backwards. Refusing to generate id\u0026#34;); } if (currTimeStamp == lastTimeStamp) { //ç›¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢  sequence = (sequence + 1) \u0026amp; MAX_SEQUENCE; //åŒä¸€æ¯«ç§’çš„åºåˆ—æ•°å·²ç»è¾¾åˆ°æœ€å¤§  if (sequence == 0L) { currTimeStamp = getNextMill(); } } else { //ä¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·ç½®ä¸º0  sequence = 0L; } lastTimeStamp = currTimeStamp; return (currTimeStamp - START_TIMESTAMP) \u0026lt;\u0026lt; TIMESTAMP_LEFT //æ—¶é—´æˆ³éƒ¨åˆ†  | dataCenterId \u0026lt;\u0026lt; DATA_CENTER_LEFT //æ•°æ®ä¸­å¿ƒéƒ¨åˆ†  | machineId \u0026lt;\u0026lt; MACHINE_LEFT //æœºå™¨æ ‡è¯†éƒ¨åˆ†  | sequence; //åºåˆ—å·éƒ¨åˆ†  } public static void main(String[] args) { SnowFlakeShortUrl snowFlake = new SnowFlakeShortUrl(2, 3); for (int i = 0; i \u0026lt; (1 \u0026lt;\u0026lt; 4); i++) { //10è¿›åˆ¶  System.out.println(snowFlake.nextId()); } } } 7ã€ç™¾åº¦ï¼ˆuid-generatorï¼‰ uid-generatoræ˜¯ç”±ç™¾åº¦æŠ€æœ¯éƒ¨å¼€å‘ï¼Œé¡¹ç›®GitHubåœ°å€ https://github.com/baidu/uid-generator\ruid-generatoræ˜¯åŸºäºSnowflakeç®—æ³•å®ç°çš„ï¼Œä¸åŸå§‹çš„snowflakeç®—æ³•ä¸åŒåœ¨äºï¼Œuid-generatoræ”¯æŒè‡ªå®šä¹‰æ—¶é—´æˆ³ã€å·¥ä½œæœºå™¨IDå’Œ åºåˆ—å· ç­‰å„éƒ¨åˆ†çš„ä½æ•°ï¼Œè€Œä¸”uid-generatorä¸­é‡‡ç”¨ç”¨æˆ·è‡ªå®šä¹‰workIdçš„ç”Ÿæˆç­–ç•¥ã€‚\nuid-generatoréœ€è¦ä¸æ•°æ®åº“é…åˆä½¿ç”¨ï¼Œéœ€è¦æ–°å¢ä¸€ä¸ªWORKER_NODEè¡¨ã€‚å½“åº”ç”¨å¯åŠ¨æ—¶ä¼šå‘æ•°æ®åº“è¡¨ä¸­å»æ’å…¥ä¸€æ¡æ•°æ®ï¼Œæ’å…¥æˆåŠŸåè¿”å›çš„è‡ªå¢IDå°±æ˜¯è¯¥æœºå™¨çš„workIdæ•°æ®ç”±hostï¼Œportç»„æˆã€‚\nå¯¹äºuid-generator IDç»„æˆç»“æ„ï¼š\nworkIdï¼Œå ç”¨äº†22ä¸ªbitä½ï¼Œæ—¶é—´å ç”¨äº†28ä¸ªbitä½ï¼Œåºåˆ—åŒ–å ç”¨äº†13ä¸ªbitä½ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå’ŒåŸå§‹çš„snowflakeä¸å¤ªä¸€æ ·ï¼Œæ—¶é—´çš„å•ä½æ˜¯ç§’ï¼Œè€Œä¸æ˜¯æ¯«ç§’ï¼ŒworkIdä¹Ÿä¸ä¸€æ ·ï¼Œè€Œä¸”åŒä¸€åº”ç”¨æ¯æ¬¡é‡å¯å°±ä¼šæ¶ˆè´¹ä¸€ä¸ªworkIdã€‚\n å‚è€ƒæ–‡çŒ® https://github.com/baidu/uid-generator/blob/master/README.zh_cn.md\r 8ã€ç¾å›¢ï¼ˆLeafï¼‰ Leafç”±ç¾å›¢å¼€å‘ï¼Œgithubåœ°å€ï¼šhttps://github.com/Meituan-Dianping/Leaf\nLeafåŒæ—¶æ”¯æŒå·æ®µæ¨¡å¼å’Œsnowflakeç®—æ³•æ¨¡å¼ï¼Œå¯ä»¥åˆ‡æ¢ä½¿ç”¨ã€‚\nå·æ®µæ¨¡å¼ å…ˆå¯¼å…¥æºç  https://github.com/Meituan-Dianping/Leaf\rï¼Œåœ¨å»ºä¸€å¼ è¡¨leaf_alloc\nDROP TABLE IF EXISTS `leaf_alloc`; CREATE TABLE `leaf_alloc` ( `biz_tag` varchar(128) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;ä¸šåŠ¡key\u0026#39;, `max_id` bigint(20) NOT NULL DEFAULT \u0026#39;1\u0026#39; COMMENT \u0026#39;å½“å‰å·²ç»åˆ†é…äº†çš„æœ€å¤§id\u0026#39;, `step` int(11) NOT NULL COMMENT \u0026#39;åˆå§‹æ­¥é•¿ï¼Œä¹Ÿæ˜¯åŠ¨æ€è°ƒæ•´çš„æœ€å°æ­¥é•¿\u0026#39;, `description` varchar(256) DEFAULT NULL COMMENT \u0026#39;ä¸šåŠ¡keyçš„æè¿°\u0026#39;, `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ•°æ®åº“ç»´æŠ¤çš„æ›´æ–°æ—¶é—´\u0026#39;, PRIMARY KEY (`biz_tag`) ) ENGINE=InnoDB; ç„¶ååœ¨é¡¹ç›®ä¸­å¼€å¯å·æ®µæ¨¡å¼ï¼Œé…ç½®å¯¹åº”çš„æ•°æ®åº“ä¿¡æ¯ï¼Œå¹¶å…³é—­snowflakeæ¨¡å¼\nleaf.name=com.sankuai.leaf.opensource.test\rleaf.segment.enable=true\rleaf.jdbc.url=jdbc:mysql://localhost:3306/leaf_test?useUnicode=true\u0026amp;characterEncoding=utf8\u0026amp;characterSetResults=utf8\rleaf.jdbc.username=root\rleaf.jdbc.password=root\rleaf.snowflake.enable=false\r#leaf.snowflake.zk.address=\r#leaf.snowflake.port=\rå¯åŠ¨leaf-server æ¨¡å—çš„ LeafServerApplicationé¡¹ç›®å°±è·‘èµ·æ¥äº†\nå·æ®µæ¨¡å¼è·å–åˆ†å¸ƒå¼è‡ªå¢IDçš„æµ‹è¯•url ï¼šhttpï¼š//localhostï¼š8080/api/segment/get/leaf-segment-test\nç›‘æ§å·æ®µæ¨¡å¼ï¼šhttp://localhost:8080/cache\nsnowflakeæ¨¡å¼ Leafçš„snowflakeæ¨¡å¼ä¾èµ–äºZooKeeperï¼Œä¸åŒäºåŸå§‹snowflakeç®—æ³•ä¹Ÿä¸»è¦æ˜¯åœ¨workIdçš„ç”Ÿæˆä¸Šï¼ŒLeafä¸­workIdæ˜¯åŸºäºZooKeeperçš„é¡ºåºIdæ¥ç”Ÿæˆçš„ï¼Œæ¯ä¸ªåº”ç”¨åœ¨ä½¿ç”¨Leaf-snowflakeæ—¶ï¼Œå¯åŠ¨æ—¶éƒ½ä¼šéƒ½åœ¨Zookeeperä¸­ç”Ÿæˆä¸€ä¸ªé¡ºåºIdï¼Œç›¸å½“äºä¸€å°æœºå™¨å¯¹åº”ä¸€ä¸ªé¡ºåºèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªworkIdã€‚\nleaf.snowflake.enable=true\rleaf.snowflake.zk.address=127.0.0.1\rleaf.snowflake.port=2181\rsnowflakeæ¨¡å¼è·å–åˆ†å¸ƒå¼è‡ªå¢IDçš„æµ‹è¯•urlï¼šhttp://localhost:8080/api/snowflake/get/test\n9ã€æ»´æ»´ï¼ˆTinyidï¼‰ Tinyidç”±æ»´æ»´å¼€å‘ï¼ŒGithubåœ°å€ï¼šhttps://github.com/didi/tinyidã€‚\nTinyidæ˜¯åŸºäºå·æ®µæ¨¡å¼åŸç†å®ç°çš„ä¸Leafå¦‚å‡ºä¸€è¾™ï¼Œæ¯ä¸ªæœåŠ¡è·å–ä¸€ä¸ªå·æ®µï¼ˆ1000,2000]ã€ï¼ˆ2000,3000]ã€ï¼ˆ3000,4000]\nTinyidæä¾›httpå’Œtinyid-clientä¸¤ç§æ–¹å¼æ¥å…¥\nHttpæ–¹å¼æ¥å…¥ ï¼ˆ1ï¼‰å¯¼å…¥Tinyidæºç ï¼š\ngit clone https://github.com/didi/tinyid.git\rï¼ˆ2ï¼‰åˆ›å»ºæ•°æ®è¡¨ï¼š\nCREATE TABLE `tiny_id_info` ( `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT \u0026#39;è‡ªå¢ä¸»é”®\u0026#39;, `biz_type` varchar(63) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;ä¸šåŠ¡ç±»å‹ï¼Œå”¯ä¸€\u0026#39;, `begin_id` bigint(20) NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;å¼€å§‹idï¼Œä»…è®°å½•åˆå§‹å€¼ï¼Œæ— å…¶ä»–å«ä¹‰ã€‚åˆå§‹åŒ–æ—¶begin_idå’Œmax_idåº”ç›¸åŒ\u0026#39;, `max_id` bigint(20) NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;å½“å‰æœ€å¤§id\u0026#39;, `step` int(11) DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;æ­¥é•¿\u0026#39;, `delta` int(11) NOT NULL DEFAULT \u0026#39;1\u0026#39; COMMENT \u0026#39;æ¯æ¬¡idå¢é‡\u0026#39;, `remainder` int(11) NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;ä½™æ•°\u0026#39;, `create_time` timestamp NOT NULL DEFAULT \u0026#39;2010-01-01 00:00:00\u0026#39; COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, `update_time` timestamp NOT NULL DEFAULT \u0026#39;2010-01-01 00:00:00\u0026#39; COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, `version` bigint(20) NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;ç‰ˆæœ¬å·\u0026#39;, PRIMARY KEY (`id`), UNIQUE KEY `uniq_biz_type` (`biz_type`) ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT \u0026#39;idä¿¡æ¯è¡¨\u0026#39;; CREATE TABLE `tiny_id_token` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT \u0026#39;è‡ªå¢id\u0026#39;, `token` varchar(255) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;token\u0026#39;, `biz_type` varchar(63) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;æ­¤tokenå¯è®¿é—®çš„ä¸šåŠ¡ç±»å‹æ ‡è¯†\u0026#39;, `remark` varchar(255) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;å¤‡æ³¨\u0026#39;, `create_time` timestamp NOT NULL DEFAULT \u0026#39;2010-01-01 00:00:00\u0026#39; COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, `update_time` timestamp NOT NULL DEFAULT \u0026#39;2010-01-01 00:00:00\u0026#39; COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT \u0026#39;tokenä¿¡æ¯è¡¨\u0026#39;; INSERT INTO `tiny_id_info` (`id`, `biz_type`, `begin_id`, `max_id`, `step`, `delta`, `remainder`, `create_time`, `update_time`, `version`) VALUES (1, \u0026#39;test\u0026#39;, 1, 1, 100000, 1, 0, \u0026#39;2018-07-21 23:52:58\u0026#39;, \u0026#39;2018-07-22 23:19:27\u0026#39;, 1); INSERT INTO `tiny_id_info` (`id`, `biz_type`, `begin_id`, `max_id`, `step`, `delta`, `remainder`, `create_time`, `update_time`, `version`) VALUES (2, \u0026#39;test_odd\u0026#39;, 1, 1, 100000, 2, 1, \u0026#39;2018-07-21 23:52:58\u0026#39;, \u0026#39;2018-07-23 00:39:24\u0026#39;, 3); INSERT INTO `tiny_id_token` (`id`, `token`, `biz_type`, `remark`, `create_time`, `update_time`) VALUES (1, \u0026#39;0f673adf80504e2eaa552f5d791b644c\u0026#39;, \u0026#39;test\u0026#39;, \u0026#39;1\u0026#39;, \u0026#39;2017-12-14 16:36:46\u0026#39;, \u0026#39;2017-12-14 16:36:48\u0026#39;); INSERT INTO `tiny_id_token` (`id`, `token`, `biz_type`, `remark`, `create_time`, `update_time`) VALUES (2, \u0026#39;0f673adf80504e2eaa552f5d791b644c\u0026#39;, \u0026#39;test_odd\u0026#39;, \u0026#39;1\u0026#39;, \u0026#39;2017-12-14 16:36:46\u0026#39;, \u0026#39;2017-12-14 16:36:48\u0026#39;); ï¼ˆ3ï¼‰é…ç½®æ•°æ®åº“ï¼š\ndatasource.tinyid.names=primary\rdatasource.tinyid.primary.driver-class-name=com.mysql.jdbc.Driver\rdatasource.tinyid.primary.url=jdbc:mysql://ip:port/databaseName?autoReconnect=true\u0026amp;useUnicode=true\u0026amp;characterEncoding=UTF-8\rdatasource.tinyid.primary.username=root\rdatasource.tinyid.primary.password=123456\rï¼ˆ4ï¼‰å¯åŠ¨tinyid-serveråæµ‹è¯•\nè·å–åˆ†å¸ƒå¼è‡ªå¢ID: http://localhost:9999/tinyid/id/nextIdSimple?bizType=test\u0026amp;token=0f673adf80504e2eaa552f5d791b644c'\rè¿”å›ç»“æœ: 3\ræ‰¹é‡è·å–åˆ†å¸ƒå¼è‡ªå¢ID:\rhttp://localhost:9999/tinyid/id/nextIdSimple?bizType=test\u0026amp;token=0f673adf80504e2eaa552f5d791b644c\u0026amp;batchSize=10'\rè¿”å›ç»“æœ: 4,5,6,7,8,9,10,11,12,13\rJavaå®¢æˆ·ç«¯æ–¹å¼æ¥å…¥ é‡å¤Httpæ–¹å¼çš„ï¼ˆ2ï¼‰ï¼ˆ3ï¼‰æ“ä½œ\nå¼•å…¥ä¾èµ–\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.xiaoju.uemc.tinyid\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;tinyid-client\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${tinyid.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; é…ç½®æ–‡ä»¶\ntinyid.server =localhost:9999\rtinyid.token =0f673adf80504e2eaa552f5d791b644c\rtest ã€tinyid.tokenæ˜¯åœ¨æ•°æ®åº“è¡¨ä¸­é¢„å…ˆæ’å…¥çš„æ•°æ®ï¼Œtest æ˜¯å…·ä½“ä¸šåŠ¡ç±»å‹ï¼Œtinyid.tokenè¡¨ç¤ºå¯è®¿é—®çš„ä¸šåŠ¡ç±»å‹\n// è·å–å•ä¸ªåˆ†å¸ƒå¼è‡ªå¢ID Long id = TinyId . nextId( \u0026#34; test \u0026#34; ); // æŒ‰éœ€æ‰¹é‡åˆ†å¸ƒå¼è‡ªå¢ID List\u0026lt; Long \u0026gt; ids = TinyId . nextId( \u0026#34; test \u0026#34; , 10 );  æ€»ç»“ æœ¬æ–‡åªæ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹æ¯ç§åˆ†å¸ƒå¼IDç”Ÿæˆå™¨ï¼Œæ—¨åœ¨ç»™å¤§å®¶ä¸€ä¸ªè¯¦ç»†å­¦ä¹ çš„æ–¹å‘ï¼Œæ¯ç§ç”Ÿæˆæ–¹å¼éƒ½æœ‰å®ƒè‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼Œå…·ä½“å¦‚ä½•ä½¿ç”¨è¿˜è¦çœ‹å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚ã€‚\nå‚è€ƒé“¾æ¥ ä¸€å£æ°”è¯´å‡º9ç§åˆ†å¸ƒå¼IDç”Ÿæˆæ–¹å¼ï¼Œé¢è¯•å®˜æœ‰ç‚¹æ‡µäº†\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8Fid%E7%94%9F%E6%88%90%E6%96%B9%E5%BC%8F/","series":["Manual"],"tags":["åˆ†å¸ƒå¼","CS"],"title":"åˆ†å¸ƒå¼IDç”Ÿæˆæ–¹å¼"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"åˆ†å¸ƒå¼äº‹åŠ¡ åˆ†å¸ƒå¼äº‹åŠ¡é¡¾åæ€ä¹‰å°±æ˜¯è¦åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°äº‹åŠ¡ï¼Œå®ƒå…¶å®æ˜¯ç”±å¤šä¸ªæœ¬åœ°äº‹åŠ¡ç»„åˆè€Œæˆã€‚å¯¹äºåˆ†å¸ƒå¼äº‹åŠ¡è€Œè¨€å‡ ä¹æ»¡è¶³ä¸äº† ACIDï¼Œå…¶å®å¯¹äºå•æœºäº‹åŠ¡è€Œè¨€å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¹Ÿæ²¡æœ‰æ»¡è¶³ ACIDï¼Œä¸ç„¶æ€ä¹ˆä¼šæœ‰å››ç§éš”ç¦»çº§åˆ«å‘¢ï¼Ÿæ‰€ä»¥æ›´åˆ«è¯´åˆ†å¸ƒåœ¨ä¸åŒæ•°æ®åº“æˆ–è€…ä¸åŒåº”ç”¨ä¸Šçš„åˆ†å¸ƒå¼äº‹åŠ¡äº†ã€‚\n2PC 2PCï¼ˆTwo-phase commit protocolï¼‰ï¼Œä¸­æ–‡å«äºŒé˜¶æ®µæäº¤ã€‚ äºŒé˜¶æ®µæäº¤æ˜¯ä¸€ç§å¼ºä¸€è‡´æ€§è®¾è®¡ï¼Œ2PC å¼•å…¥ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…çš„è§’è‰²æ¥åè°ƒç®¡ç†å„å‚ä¸è€…ï¼ˆä¹Ÿå¯ç§°ä¹‹ä¸ºå„æœ¬åœ°èµ„æºï¼‰çš„æäº¤å’Œå›æ»šï¼ŒäºŒé˜¶æ®µåˆ†åˆ«æŒ‡çš„æ˜¯å‡†å¤‡ï¼ˆæŠ•ç¥¨ï¼‰å’Œæäº¤ä¸¤ä¸ªé˜¶æ®µã€‚\n**å‡†å¤‡é˜¶æ®µ**åè°ƒè€…ä¼šç»™å„å‚ä¸è€…å‘é€å‡†å¤‡å‘½ä»¤ï¼Œä½ å¯ä»¥æŠŠå‡†å¤‡å‘½ä»¤ç†è§£æˆé™¤äº†æäº¤äº‹åŠ¡ä¹‹å¤–å•¥äº‹éƒ½åšå®Œäº†ã€‚\nåŒæ­¥ç­‰å¾…æ‰€æœ‰èµ„æºçš„å“åº”ä¹‹åå°±è¿›å…¥ç¬¬äºŒé˜¶æ®µå³**æäº¤é˜¶æ®µ**ï¼ˆæ³¨æ„æäº¤é˜¶æ®µä¸ä¸€å®šæ˜¯æäº¤äº‹åŠ¡ï¼Œä¹Ÿå¯èƒ½æ˜¯å›æ»šäº‹åŠ¡ï¼‰ã€‚\nå‡å¦‚åœ¨ç¬¬ä¸€é˜¶æ®µæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›å‡†å¤‡æˆåŠŸï¼Œé‚£ä¹ˆåè°ƒè€…åˆ™å‘æ‰€æœ‰å‚ä¸è€…å‘é€æäº¤äº‹åŠ¡å‘½ä»¤ï¼Œç„¶åç­‰å¾…æ‰€æœ‰äº‹åŠ¡éƒ½æäº¤æˆåŠŸä¹‹åï¼Œè¿”å›äº‹åŠ¡æ‰§è¡ŒæˆåŠŸã€‚\nå‡å¦‚åœ¨ç¬¬ä¸€é˜¶æ®µæœ‰ä¸€ä¸ªå‚ä¸è€…è¿”å›å¤±è´¥ï¼Œé‚£ä¹ˆåè°ƒè€…å°±ä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€å›æ»šäº‹åŠ¡çš„è¯·æ±‚ï¼Œå³åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œå¤±è´¥ã€‚\né¦–å…ˆ 2PC æ˜¯ä¸€ä¸ªåŒæ­¥é˜»å¡åè®®ï¼Œåƒç¬¬ä¸€é˜¶æ®µåè°ƒè€…ä¼šç­‰å¾…æ‰€æœ‰å‚ä¸è€…å“åº”æ‰ä¼šè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œå½“ç„¶ç¬¬ä¸€é˜¶æ®µçš„åè°ƒè€…æœ‰è¶…æ—¶æœºåˆ¶ï¼Œå‡è®¾å› ä¸ºç½‘ç»œåŸå› æ²¡æœ‰æ”¶åˆ°æŸå‚ä¸è€…çš„å“åº”æˆ–æŸå‚ä¸è€…æŒ‚äº†ï¼Œé‚£ä¹ˆè¶…æ—¶åå°±ä¼šåˆ¤æ–­äº‹åŠ¡å¤±è´¥ï¼Œå‘æ‰€æœ‰å‚ä¸è€…å‘é€å›æ»šå‘½ä»¤ã€‚\nåœ¨ç¬¬äºŒé˜¶æ®µåè°ƒè€…çš„æ²¡æ³•è¶…æ—¶ï¼Œåªèƒ½ä¸æ–­é‡è¯•ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š\nç¬¬ä¸€ç§æ˜¯ç¬¬äºŒé˜¶æ®µæ‰§è¡Œçš„æ˜¯å›æ»šäº‹åŠ¡æ“ä½œï¼Œé‚£ä¹ˆç­”æ¡ˆæ˜¯ä¸æ–­é‡è¯•ï¼Œç›´åˆ°æ‰€æœ‰å‚ä¸è€…éƒ½å›æ»šäº†ï¼Œä¸ç„¶é‚£äº›åœ¨ç¬¬ä¸€é˜¶æ®µå‡†å¤‡æˆåŠŸçš„å‚ä¸è€…ä¼šä¸€ç›´é˜»å¡ç€ã€‚\nç¬¬äºŒç§æ˜¯ç¬¬äºŒé˜¶æ®µæ‰§è¡Œçš„æ˜¯æäº¤äº‹åŠ¡æ“ä½œï¼Œé‚£ä¹ˆç­”æ¡ˆä¹Ÿæ˜¯ä¸æ–­é‡è¯•ï¼Œå› ä¸ºæœ‰å¯èƒ½ä¸€äº›å‚ä¸è€…çš„äº‹åŠ¡å·²ç»æäº¤æˆåŠŸäº†ï¼Œè¿™ä¸ªæ—¶å€™åªæœ‰ä¸€æ¡è·¯ï¼Œå°±æ˜¯å¤´é“å¾€å‰å†²ï¼Œä¸æ–­çš„é‡è¯•ï¼Œç›´åˆ°æäº¤æˆåŠŸï¼Œåˆ°æœ€åçœŸçš„ä¸è¡Œåªèƒ½äººå·¥ä»‹å…¥å¤„ç†ã€‚\nè‡³æ­¤æˆ‘ä»¬å·²ç»è¯¦ç»†çš„åˆ†æçš„ 2PC çš„å„ç§ç»†èŠ‚ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼š\n 2PC æ˜¯ä¸€ç§å°½é‡ä¿è¯å¼ºä¸€è‡´æ€§çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå› æ­¤å®ƒæ˜¯åŒæ­¥é˜»å¡çš„ï¼Œè€ŒåŒæ­¥é˜»å¡å°±å¯¼è‡´é•¿ä¹…çš„èµ„æºé”å®šé—®é¢˜ï¼Œæ€»ä½“è€Œè¨€æ•ˆç‡ä½ï¼Œå¹¶ä¸”å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼Œåœ¨æç«¯æ¡ä»¶ä¸‹å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„é£é™©ã€‚\nå½“ç„¶å…·ä½“çš„å®ç°å¯ä»¥å˜å½¢ï¼Œè€Œä¸” 2PC ä¹Ÿæœ‰å˜ç§ï¼Œä¾‹å¦‚ Tree 2PCã€Dynamic 2PCã€‚\nè¿˜æœ‰ä¸€ç‚¹ä¸çŸ¥é“ä½ ä»¬çœ‹å‡ºæ¥æ²¡ï¼Œ2PC é€‚ç”¨äºæ•°æ®åº“å±‚é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ï¼Œè€Œæˆ‘ä»¬ä¸šåŠ¡éœ€æ±‚æœ‰æ—¶å€™ä¸ä»…ä»…å…³ä¹æ•°æ®åº“ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸Šä¼ ä¸€å¼ å›¾ç‰‡æˆ–è€…å‘é€ä¸€æ¡çŸ­ä¿¡ã€‚\nè€Œä¸”åƒ Java ä¸­çš„ JTA åªèƒ½è§£å†³ä¸€ä¸ªåº”ç”¨ä¸‹å¤šæ•°æ®åº“çš„åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œè·¨æœåŠ¡äº†å°±ä¸èƒ½ç”¨äº†ã€‚\nç®€å•è¯´ä¸‹ Java ä¸­ JTAï¼Œå®ƒæ˜¯åŸºäºXAè§„èŒƒå®ç°çš„äº‹åŠ¡æ¥å£ï¼Œè¿™é‡Œçš„ XA ä½ å¯ä»¥ç®€å•ç†è§£ä¸ºåŸºäºæ•°æ®åº“çš„ XA è§„èŒƒæ¥å®ç°çš„ 2PCã€‚\n 3PC 3PC çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³ 2PC çš„ä¸€äº›é—®é¢˜ï¼Œç›¸æ¯”äº 2PC å®ƒåœ¨å‚ä¸è€…ä¸­ä¹Ÿå¼•å…¥äº†è¶…æ—¶æœºåˆ¶ï¼Œå¹¶ä¸”æ–°å¢äº†ä¸€ä¸ªé˜¶æ®µä½¿å¾—å‚ä¸è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ä¸ªé˜¶æ®µç»Ÿä¸€å„è‡ªçš„çŠ¶æ€ã€‚\nè®©æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸€ä¸‹ã€‚\n3PC åŒ…å«äº†ä¸‰ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯**å‡†å¤‡é˜¶æ®µã€é¢„æäº¤é˜¶æ®µã€æäº¤é˜¶æ®µ**ï¼Œå¯¹åº”çš„è‹±æ–‡å°±æ˜¯ï¼šCanCommitã€PreCommit ã€ DoCommitã€‚\nçœ‹èµ·æ¥æ˜¯æŠŠ 2PC çš„æäº¤é˜¶æ®µå˜æˆäº†é¢„æäº¤é˜¶æ®µå’Œæäº¤é˜¶æ®µï¼Œä½†æ˜¯ 3PC çš„å‡†å¤‡é˜¶æ®µåè°ƒè€…åªæ˜¯è¯¢é—®å‚ä¸è€…çš„è‡ªèº«çŠ¶å†µï¼Œæ¯”å¦‚ä½ ç°åœ¨è¿˜å¥½å—ï¼Ÿè´Ÿè½½é‡ä¸é‡ï¼Ÿè¿™ç±»çš„ã€‚\nè€Œé¢„æäº¤é˜¶æ®µå°±æ˜¯å’Œ 2PC çš„å‡†å¤‡é˜¶æ®µä¸€æ ·ï¼Œé™¤äº†äº‹åŠ¡çš„æäº¤è¯¥åšçš„éƒ½åšäº†ã€‚\næäº¤é˜¶æ®µå’Œ 2PC çš„ä¸€æ ·ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å›¾ã€‚\nä¸ç®¡å“ªä¸€ä¸ªé˜¶æ®µæœ‰å‚ä¸è€…è¿”å›å¤±è´¥éƒ½ä¼šå®£å¸ƒäº‹åŠ¡å¤±è´¥ï¼Œè¿™å’Œ 2PC æ˜¯ä¸€æ ·çš„ï¼ˆå½“ç„¶åˆ°æœ€åçš„æäº¤é˜¶æ®µå’Œ 2PC ä¸€æ ·åªè¦æ˜¯æäº¤è¯·æ±‚å°±åªèƒ½ä¸æ–­é‡è¯•ï¼‰ã€‚\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ 3PC çš„é˜¶æ®µå˜æ›´æœ‰ä»€ä¹ˆå½±å“ã€‚\né¦–å…ˆå‡†å¤‡é˜¶æ®µçš„å˜æ›´æˆä¸ä¼šç›´æ¥æ‰§è¡Œäº‹åŠ¡ï¼Œè€Œæ˜¯ä¼šå…ˆå»è¯¢é—®æ­¤æ—¶çš„å‚ä¸è€…æ˜¯å¦æœ‰æ¡ä»¶æ¥è¿™ä¸ªäº‹åŠ¡ï¼Œå› æ­¤ä¸ä¼šä¸€æ¥å°±å¹²æ´»ç›´æ¥é”èµ„æºï¼Œä½¿å¾—åœ¨æŸäº›èµ„æºä¸å¯ç”¨çš„æƒ…å†µä¸‹æ‰€æœ‰å‚ä¸è€…éƒ½é˜»å¡ç€ã€‚\nè€Œé¢„æäº¤é˜¶æ®µçš„å¼•å…¥èµ·åˆ°äº†ä¸€ä¸ªç»Ÿä¸€çŠ¶æ€çš„ä½œç”¨ï¼Œå®ƒåƒä¸€é“æ …æ ï¼Œè¡¨æ˜åœ¨é¢„æäº¤é˜¶æ®µå‰æ‰€æœ‰å‚ä¸è€…å…¶å®è¿˜æœªéƒ½å›åº”ï¼Œåœ¨é¢„å¤„ç†é˜¶æ®µè¡¨æ˜æ‰€æœ‰å‚ä¸è€…éƒ½å·²ç»å›åº”äº†ã€‚\nå‡å¦‚ä½ æ˜¯ä¸€ä½å‚ä¸è€…ï¼Œä½ çŸ¥é“è‡ªå·±è¿›å…¥äº†é¢„æäº¤çŠ¶æ€é‚£ä½ å°±å¯ä»¥æ¨æ–­å‡ºæ¥å…¶ä»–å‚ä¸è€…ä¹Ÿéƒ½è¿›å…¥äº†é¢„æäº¤çŠ¶æ€ã€‚\nä½†æ˜¯å¤šå¼•å…¥ä¸€ä¸ªé˜¶æ®µä¹Ÿå¤šä¸€ä¸ªäº¤äº’ï¼Œå› æ­¤æ€§èƒ½ä¼šå·®ä¸€äº›ï¼Œè€Œä¸”ç»å¤§éƒ¨åˆ†çš„æƒ…å†µä¸‹èµ„æºåº”è¯¥éƒ½æ˜¯å¯ç”¨çš„ï¼Œè¿™æ ·ç­‰äºæ¯æ¬¡æ˜çŸ¥å¯ç”¨æ‰§è¡Œè¿˜å¾—è¯¢é—®ä¸€æ¬¡ã€‚\næˆ‘ä»¬å†æ¥çœ‹ä¸‹å‚ä¸è€…è¶…æ—¶èƒ½å¸¦æ¥ä»€ä¹ˆæ ·çš„å½±å“ã€‚\næˆ‘ä»¬çŸ¥é“ 2PC æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œä¸Šé¢æˆ‘ä»¬å·²ç»åˆ†æäº†åè°ƒè€…æŒ‚åœ¨äº†æäº¤è¯·æ±‚è¿˜æœªå‘å‡ºå»çš„æ—¶å€™æ˜¯æœ€ä¼¤çš„ï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½å·²ç»é”å®šèµ„æºå¹¶ä¸”é˜»å¡ç­‰å¾…ç€ã€‚\né‚£ä¹ˆå¼•å…¥äº†è¶…æ—¶æœºåˆ¶ï¼Œå‚ä¸è€…å°±ä¸ä¼šå‚»ç­‰äº†ï¼Œå¦‚æœæ˜¯ç­‰å¾…æäº¤å‘½ä»¤è¶…æ—¶ï¼Œé‚£ä¹ˆå‚ä¸è€…å°±ä¼šæäº¤äº‹åŠ¡äº†ï¼Œå› ä¸ºéƒ½åˆ°äº†è¿™ä¸€é˜¶æ®µäº†å¤§æ¦‚ç‡æ˜¯æäº¤çš„ï¼Œå¦‚æœæ˜¯ç­‰å¾…é¢„æäº¤å‘½ä»¤è¶…æ—¶ï¼Œé‚£è¯¥å¹²å•¥å°±å¹²å•¥äº†ï¼Œåæ­£æœ¬æ¥å•¥ä¹Ÿæ²¡å¹²ã€‚\nç„¶è€Œè¶…æ—¶æœºåˆ¶ä¹Ÿä¼šå¸¦æ¥æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæ¯”å¦‚åœ¨ç­‰å¾…æäº¤å‘½ä»¤æ—¶å€™è¶…æ—¶äº†ï¼Œå‚ä¸è€…é»˜è®¤æ‰§è¡Œçš„æ˜¯æäº¤äº‹åŠ¡æ“ä½œï¼Œä½†æ˜¯æœ‰å¯èƒ½æ‰§è¡Œçš„æ˜¯å›æ»šæ“ä½œï¼Œè¿™æ ·ä¸€æ¥æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚\nå½“ç„¶ 3PC åè°ƒè€…è¶…æ—¶è¿˜æ˜¯åœ¨çš„ï¼Œå…·ä½“ä¸åˆ†æäº†å’Œ 2PC æ˜¯ä¸€æ ·çš„ã€‚\nä»ç»´åŸºç™¾ç§‘ä¸Šçœ‹ï¼Œ3PC çš„å¼•å…¥æ˜¯ä¸ºäº†è§£å†³æäº¤é˜¶æ®µ 2PC åè°ƒè€…å’ŒæŸå‚ä¸è€…éƒ½æŒ‚äº†ä¹‹åæ–°é€‰ä¸¾çš„åè°ƒè€…ä¸çŸ¥é“å½“å‰åº”è¯¥æäº¤è¿˜æ˜¯å›æ»šçš„é—®é¢˜ã€‚\næ–°åè°ƒè€…æ¥çš„æ—¶å€™å‘ç°æœ‰ä¸€ä¸ªå‚ä¸è€…å¤„äºé¢„æäº¤æˆ–è€…æäº¤é˜¶æ®µï¼Œé‚£ä¹ˆè¡¨æ˜å·²ç»ç»è¿‡äº†æ‰€æœ‰å‚ä¸è€…çš„ç¡®è®¤äº†ï¼Œæ‰€ä»¥æ­¤æ—¶æ‰§è¡Œçš„å°±æ˜¯æäº¤å‘½ä»¤ã€‚\næ‰€ä»¥è¯´ 3PC å°±æ˜¯é€šè¿‡å¼•å…¥é¢„æäº¤é˜¶æ®µæ¥ä½¿å¾—å‚ä¸è€…ä¹‹é—´çš„çŠ¶æ€å¾—åˆ°ç»Ÿä¸€ï¼Œä¹Ÿå°±æ˜¯ç•™äº†ä¸€ä¸ªé˜¶æ®µè®©å¤§å®¶åŒæ­¥ä¸€ä¸‹ã€‚\nä½†æ˜¯è¿™ä¹Ÿåªèƒ½è®©åè°ƒè€…çŸ¥é“è¯¥å¦‚æœåšï¼Œä½†ä¸èƒ½ä¿è¯è¿™æ ·åšä¸€å®šå¯¹ï¼Œè¿™å…¶å®å’Œä¸Šé¢ 2PC åˆ†æä¸€è‡´ï¼Œå› ä¸ºæŒ‚äº†çš„å‚ä¸è€…åˆ°åº•æœ‰æ²¡æœ‰æ‰§è¡Œäº‹åŠ¡æ— æ³•æ–­å®šã€‚\næ‰€ä»¥è¯´ 3PC é€šè¿‡é¢„æäº¤é˜¶æ®µå¯ä»¥å‡å°‘æ•…éšœæ¢å¤æ—¶å€™çš„å¤æ‚æ€§ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸€è‡´ï¼Œé™¤éæŒ‚äº†çš„é‚£ä¸ªå‚ä¸è€…æ¢å¤ã€‚\nè®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œ 3PC ç›¸å¯¹äº 2PC åšäº†ä¸€å®šçš„æ”¹è¿›ï¼š\n   å¼•å…¥äº†å‚ä¸è€…è¶…æ—¶æœºåˆ¶\n  å‡†å¤‡é˜¶æ®µä¸æ‰§è¡Œäº‹åŠ¡ï¼Œä¸é”å®šèµ„æºï¼Œåªæ˜¯è¯¢é—®å‚ä¸è€…çŠ¶æ€ï¼Œä¸è‡³äºä½¿å¾—åœ¨æŸäº›å‚ä¸è€…èµ„æºä¸å¯ç”¨çš„æƒ…å†µä¸‹æ‰€æœ‰å‚ä¸è€…éƒ½é˜»å¡ç€ã€‚\n  å¢åŠ äº†é¢„æäº¤é˜¶æ®µä½¿å¾—æ•…éšœæ¢å¤ä¹‹ååè°ƒè€…çš„å†³ç­–å¤æ‚åº¦é™ä½\nä½†æ•´ä½“çš„äº¤äº’è¿‡ç¨‹æ›´é•¿äº†ï¼Œæ€§èƒ½æœ‰æ‰€ä¸‹é™ï¼Œå¹¶ä¸”è¿˜æ˜¯ä¼šå­˜åœ¨æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚\n   æ‰€ä»¥ 2PC å’Œ 3PC éƒ½ä¸èƒ½ä¿è¯æ•°æ®100%ä¸€è‡´ï¼Œå› æ­¤ä¸€èˆ¬éƒ½éœ€è¦æœ‰å®šæ—¶æ‰«æè¡¥å¿æœºåˆ¶ã€‚\næˆ‘å†è¯´ä¸‹ 3PC æˆ‘æ²¡æœ‰æ‰¾åˆ°å…·ä½“çš„å®ç°ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸º 3PC åªæ˜¯çº¯çš„ç†è®ºä¸Šçš„ä¸œè¥¿ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°ç›¸æ¯”äº 2PC å®ƒæ˜¯åšäº†ä¸€äº›åŠªåŠ›ä½†æ˜¯æ•ˆæœç”šå¾®ï¼Œæ‰€ä»¥åªåšäº†è§£å³å¯ã€‚\nTCC\r 2PC å’Œ 3PC éƒ½æ˜¯æ•°æ®åº“å±‚é¢çš„ï¼Œè€Œ TCC æ˜¯ä¸šåŠ¡å±‚é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå°±åƒæˆ‘å‰é¢è¯´çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸ä»…ä»…åŒ…æ‹¬æ•°æ®åº“çš„æ“ä½œï¼Œè¿˜åŒ…æ‹¬å‘é€çŸ­ä¿¡ç­‰ï¼Œè¿™æ—¶å€™ TCC å°±æ´¾ä¸Šç”¨åœºäº†ï¼\nTCC æŒ‡çš„æ˜¯Try - Confirm - Cancelã€‚\n Try æŒ‡çš„æ˜¯é¢„ç•™ï¼Œå³èµ„æºçš„é¢„ç•™å’Œé”å®šï¼Œæ³¨æ„æ˜¯é¢„ç•™ã€‚ Confirm æŒ‡çš„æ˜¯ç¡®è®¤æ“ä½œï¼Œè¿™ä¸€æ­¥å…¶å®å°±æ˜¯çœŸæ­£çš„æ‰§è¡Œäº†ã€‚ Cancel æŒ‡çš„æ˜¯æ’¤é”€æ“ä½œï¼Œå¯ä»¥ç†è§£ä¸ºæŠŠé¢„ç•™é˜¶æ®µçš„åŠ¨ä½œæ’¤é”€äº†ã€‚  å…¶å®ä»æ€æƒ³ä¸Šçœ‹å’Œ 2PC å·®ä¸å¤šï¼Œéƒ½æ˜¯å…ˆè¯•æ¢æ€§çš„æ‰§è¡Œï¼Œå¦‚æœéƒ½å¯ä»¥é‚£å°±çœŸæ­£çš„æ‰§è¡Œï¼Œå¦‚æœä¸è¡Œå°±å›æ»šã€‚\næ¯”å¦‚è¯´ä¸€ä¸ªäº‹åŠ¡è¦æ‰§è¡ŒAã€Bã€Cä¸‰ä¸ªæ“ä½œï¼Œé‚£ä¹ˆå…ˆå¯¹ä¸‰ä¸ªæ“ä½œæ‰§è¡Œé¢„ç•™åŠ¨ä½œã€‚å¦‚æœéƒ½é¢„ç•™æˆåŠŸäº†é‚£ä¹ˆå°±æ‰§è¡Œç¡®è®¤æ“ä½œï¼Œå¦‚æœæœ‰ä¸€ä¸ªé¢„ç•™å¤±è´¥é‚£å°±éƒ½æ‰§è¡Œæ’¤é”€åŠ¨ä½œã€‚\næˆ‘ä»¬æ¥çœ‹ä¸‹æµç¨‹ï¼ŒTCCæ¨¡å‹è¿˜æœ‰ä¸ªäº‹åŠ¡ç®¡ç†è€…çš„è§’è‰²ï¼Œç”¨æ¥è®°å½•TCCå…¨å±€äº‹åŠ¡çŠ¶æ€å¹¶æäº¤æˆ–è€…å›æ»šäº‹åŠ¡ã€‚\nå¯ä»¥çœ‹åˆ°æµç¨‹è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œéš¾ç‚¹åœ¨äºä¸šåŠ¡ä¸Šçš„å®šä¹‰ï¼Œå¯¹äºæ¯ä¸€ä¸ªæ“ä½œä½ éƒ½éœ€è¦å®šä¹‰ä¸‰ä¸ªåŠ¨ä½œåˆ†åˆ«å¯¹åº”Try - Confirm - Cancelã€‚\nå› æ­¤ TCC å¯¹ä¸šåŠ¡çš„ä¾µå…¥è¾ƒå¤§å’Œä¸šåŠ¡ç´§è€¦åˆï¼Œéœ€è¦æ ¹æ®ç‰¹å®šçš„åœºæ™¯å’Œä¸šåŠ¡é€»è¾‘æ¥è®¾è®¡ç›¸åº”çš„æ“ä½œã€‚\nè¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œæ’¤é”€å’Œç¡®è®¤æ“ä½œçš„æ‰§è¡Œå¯èƒ½éœ€è¦é‡è¯•ï¼Œå› æ­¤è¿˜éœ€è¦ä¿è¯æ“ä½œçš„å¹‚ç­‰ã€‚\nç›¸å¯¹äº 2PCã€3PC ï¼ŒTCC é€‚ç”¨çš„èŒƒå›´æ›´å¤§ï¼Œä½†æ˜¯å¼€å‘é‡ä¹Ÿæ›´å¤§ï¼Œæ¯•ç«Ÿéƒ½åœ¨ä¸šåŠ¡ä¸Šå®ç°ï¼Œè€Œä¸”æœ‰æ—¶å€™ä½ ä¼šå‘ç°è¿™ä¸‰ä¸ªæ–¹æ³•è¿˜çœŸä¸å¥½å†™ã€‚ä¸è¿‡ä¹Ÿå› ä¸ºæ˜¯åœ¨ä¸šåŠ¡ä¸Šå®ç°çš„ï¼Œæ‰€ä»¥TCCå¯ä»¥è·¨æ•°æ®åº“ã€è·¨ä¸åŒçš„ä¸šåŠ¡ç³»ç»Ÿæ¥å®ç°äº‹åŠ¡ã€‚\næœ¬åœ°æ¶ˆæ¯è¡¨ æœ¬åœ°æ¶ˆæ¯è¡¨å…¶å®å°±æ˜¯åˆ©ç”¨äº† å„ç³»ç»Ÿæœ¬åœ°çš„äº‹åŠ¡æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\næœ¬åœ°æ¶ˆæ¯è¡¨é¡¾åæ€ä¹‰å°±æ˜¯ä¼šæœ‰ä¸€å¼ å­˜æ”¾æœ¬åœ°æ¶ˆæ¯çš„è¡¨ï¼Œä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨æ•°æ®åº“ä¸­ï¼Œç„¶ååœ¨æ‰§è¡Œä¸šåŠ¡çš„æ—¶å€™ å°†ä¸šåŠ¡çš„æ‰§è¡Œå’Œå°†æ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯è¡¨ä¸­çš„æ“ä½œæ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œè¿™æ ·å°±èƒ½ä¿è¯æ¶ˆæ¯æ”¾å…¥æœ¬åœ°è¡¨ä¸­ä¸šåŠ¡è‚¯å®šæ˜¯æ‰§è¡ŒæˆåŠŸçš„ã€‚\nç„¶åå†å»è°ƒç”¨ä¸‹ä¸€ä¸ªæ“ä½œï¼Œå¦‚æœä¸‹ä¸€ä¸ªæ“ä½œè°ƒç”¨æˆåŠŸäº†å¥½è¯´ï¼Œæ¶ˆæ¯è¡¨çš„æ¶ˆæ¯çŠ¶æ€å¯ä»¥ç›´æ¥æ”¹æˆå·²æˆåŠŸã€‚\nå¦‚æœè°ƒç”¨å¤±è´¥ä¹Ÿæ²¡äº‹ï¼Œä¼šæœ‰ åå°ä»»åŠ¡å®šæ—¶å»è¯»å–æœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œç­›é€‰å‡ºè¿˜æœªæˆåŠŸçš„æ¶ˆæ¯å†è°ƒç”¨å¯¹åº”çš„æœåŠ¡ï¼ŒæœåŠ¡æ›´æ–°æˆåŠŸäº†å†å˜æ›´æ¶ˆæ¯çš„çŠ¶æ€ã€‚\nè¿™æ—¶å€™æœ‰å¯èƒ½æ¶ˆæ¯å¯¹åº”çš„æ“ä½œä¸æˆåŠŸï¼Œå› æ­¤ä¹Ÿéœ€è¦é‡è¯•ï¼Œé‡è¯•å°±å¾—ä¿è¯å¯¹åº”æœåŠ¡çš„æ–¹æ³•æ˜¯å¹‚ç­‰çš„ï¼Œè€Œä¸”ä¸€èˆ¬é‡è¯•ä¼šæœ‰æœ€å¤§æ¬¡æ•°ï¼Œè¶…è¿‡æœ€å¤§æ¬¡æ•°å¯ä»¥è®°å½•ä¸‹æŠ¥è­¦è®©äººå·¥å¤„ç†ã€‚\nå¯ä»¥çœ‹åˆ°æœ¬åœ°æ¶ˆæ¯è¡¨å…¶å®å®ç°çš„æ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œå®¹å¿äº†æ•°æ®æš‚æ—¶ä¸ä¸€è‡´çš„æƒ…å†µã€‚\n æœ¬åœ°æ¶ˆæ¯è¡¨åº”ç”¨å¾—ç›¸å½“å¹¿æ³›ï¼Œé™¤äº†ä¸Šé¢çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹å¼ï¼Œæœ¬åœ°æ¶ˆæ¯ä¸€èˆ¬è¿˜å¯ä»¥è¿™æ ·å®ç°ï¼š\nä¾‹å¦‚ä¿å­˜è®¢å•æ•°æ®çš„åŒæ—¶éœ€è¦è°ƒç”¨æ”¯ä»˜æ¥å£ï¼š\n ä¿å­˜è®¢å•çš„æ—¶å€™å°†å…¶çŠ¶æ€è®¾ç½®ä¸ºâ€œå¾…ç”Ÿæ•ˆâ€ è°ƒç”¨æ”¯ä»˜æˆåŠŸåˆ™æ›´æ–°è®¢å•çŠ¶æ€ ğŸ‘‰ â€œå·²ç”Ÿæ•ˆâ€ï¼Œè°ƒç”¨å¤±è´¥åˆ™æç¤ºç”¨æˆ·ç¨åå†è¯•  è¿™ä¸ªè¿‡ç¨‹éœ€è¦æ”¯ä»˜æ¥å£å…·å¤‡å¹‚ç­‰æ€§\n æ¶ˆæ¯äº‹åŠ¡ RocketMQ å°±å¾ˆå¥½çš„æ”¯æŒäº†æ¶ˆæ¯äº‹åŠ¡ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•é€šè¿‡æ¶ˆæ¯å®ç°äº‹åŠ¡ã€‚\nç¬¬ä¸€æ­¥å…ˆç»™ Broker å‘é€äº‹åŠ¡æ¶ˆæ¯å³åŠæ¶ˆæ¯ï¼ŒåŠæ¶ˆæ¯ä¸æ˜¯è¯´ä¸€åŠæ¶ˆæ¯ï¼Œè€Œæ˜¯è¿™ä¸ªæ¶ˆæ¯å¯¹æ¶ˆè´¹è€…æ¥è¯´ä¸å¯è§ï¼Œç„¶åå‘é€æˆåŠŸåå‘é€æ–¹å†æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ã€‚\nå†æ ¹æ®æœ¬åœ°äº‹åŠ¡çš„ç»“æœå‘ Broker å‘é€ Commit æˆ–è€… RollBack å‘½ä»¤ã€‚\nå¹¶ä¸” RocketMQ çš„å‘é€æ–¹ä¼šæä¾›ä¸€ä¸ªåæŸ¥äº‹åŠ¡çŠ¶æ€æ¥å£ï¼Œå¦‚æœä¸€æ®µæ—¶é—´å†…åŠæ¶ˆæ¯æ²¡æœ‰æ”¶åˆ°ä»»ä½•æ“ä½œè¯·æ±‚ï¼Œé‚£ä¹ˆ Broker ä¼šé€šè¿‡åæŸ¥æ¥å£å¾—çŸ¥å‘é€æ–¹äº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œç„¶åæ‰§è¡Œ Commit æˆ–è€… RollBack å‘½ä»¤ã€‚\nå¦‚æœæ˜¯ Commit é‚£ä¹ˆè®¢é˜…æ–¹å°±èƒ½æ”¶åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œç„¶åå†åšå¯¹åº”çš„æ“ä½œï¼Œåšå®Œäº†ä¹‹åå†æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯å³å¯ã€‚\nå¦‚æœæ˜¯ RollBack é‚£ä¹ˆè®¢é˜…æ–¹æ”¶ä¸åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œç­‰äºäº‹åŠ¡å°±æ²¡æ‰§è¡Œè¿‡ã€‚\nå¯ä»¥çœ‹åˆ°é€šè¿‡ RocketMQ è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“å®ç°çš„ï¼ŒRocketMQ æä¾›äº†äº‹åŠ¡æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰å¥½äº‹åŠ¡åæŸ¥æ¥å£å³å¯ã€‚\nå¯ä»¥çœ‹åˆ°æ¶ˆæ¯äº‹åŠ¡å®ç°çš„ä¹Ÿæ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚\næœ€å¤§åŠªåŠ›é€šçŸ¥ å…¶å®æˆ‘è§‰å¾—æœ¬åœ°æ¶ˆæ¯è¡¨ä¹Ÿå¯ä»¥ç®—æœ€å¤§åŠªåŠ›ï¼Œäº‹åŠ¡æ¶ˆæ¯ä¹Ÿå¯ä»¥ç®—æœ€å¤§åŠªåŠ›ã€‚\nå°±æœ¬åœ°æ¶ˆæ¯è¡¨æ¥è¯´ä¼šæœ‰åå°ä»»åŠ¡å®šæ—¶å»æŸ¥çœ‹æœªå®Œæˆçš„æ¶ˆæ¯ï¼Œç„¶åå»è°ƒç”¨å¯¹åº”çš„æœåŠ¡ï¼Œå½“ä¸€ä¸ªæ¶ˆæ¯å¤šæ¬¡è°ƒç”¨éƒ½å¤±è´¥çš„æ—¶å€™å¯ä»¥è®°å½•ä¸‹ç„¶åå¼•å…¥äººå·¥ï¼Œæˆ–è€…ç›´æ¥èˆå¼ƒã€‚è¿™å…¶å®ç®—æ˜¯æœ€å¤§åŠªåŠ›äº†ã€‚\näº‹åŠ¡æ¶ˆæ¯ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå½“åŠæ¶ˆæ¯è¢«commitäº†ä¹‹åç¡®å®å°±æ˜¯æ™®é€šæ¶ˆæ¯äº†ï¼Œå¦‚æœè®¢é˜…è€…ä¸€ç›´ä¸æ¶ˆè´¹æˆ–è€…æ¶ˆè´¹ä¸äº†åˆ™ä¼šä¸€ç›´é‡è¯•ï¼Œåˆ°æœ€åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚å…¶å®è¿™ä¹Ÿç®—æœ€å¤§åŠªåŠ›ã€‚\næ‰€ä»¥æœ€å¤§åŠªåŠ›é€šçŸ¥å…¶å®åªæ˜¯è¡¨æ˜äº†ä¸€ç§æŸ”æ€§äº‹åŠ¡çš„æ€æƒ³ï¼šæˆ‘å·²ç»å°½åŠ›æˆ‘æœ€å¤§çš„åŠªåŠ›æƒ³è¾¾æˆäº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´äº†ã€‚\né€‚ç”¨äºå¯¹æ—¶é—´ä¸æ•æ„Ÿçš„ä¸šåŠ¡ï¼Œä¾‹å¦‚çŸ­ä¿¡é€šçŸ¥ã€‚\nSaga\r åœ¨Sagaæ¨¡å¼ä¸­ï¼Œä¸šåŠ¡æµç¨‹ä¸­æ¯ä¸ªå‚ä¸è€…éƒ½æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå½“å‡ºç°æŸä¸€ä¸ªå‚ä¸è€…å¤±è´¥åˆ™è¡¥å¿å‰é¢å·²ç»æˆåŠŸçš„å‚ä¸è€…ï¼Œä¸€é˜¶æ®µæ­£å‘æœåŠ¡å’ŒäºŒé˜¶æ®µè¡¥å¿æœåŠ¡éƒ½ç”±ä¸šåŠ¡å¼€å‘å®ç°ã€‚\né€‚ç”¨åœºæ™¯ï¼š  ä¸šåŠ¡æµç¨‹é•¿ã€ä¸šåŠ¡æµç¨‹å¤š å‚ä¸è€…åŒ…å«å…¶å®ƒå…¬å¸æˆ–é—ç•™ç³»ç»ŸæœåŠ¡ï¼Œæ— æ³•æä¾› TCC æ¨¡å¼è¦æ±‚çš„ä¸‰ä¸ªæ¥å£  ä¼˜åŠ¿ï¼š  ä¸€é˜¶æ®µæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œæ— é”ï¼Œé«˜æ€§èƒ½ äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå‚ä¸è€…å¯å¼‚æ­¥æ‰§è¡Œï¼Œé«˜åå è¡¥å¿æœåŠ¡æ˜“äºå®ç°  ç¼ºç‚¹ï¼š  ä¸ä¿è¯éš”ç¦»æ€§  æ€»ç»“ å¯ä»¥çœ‹å‡º 2PC å’Œ 3PC æ˜¯ä¸€ç§å¼ºä¸€è‡´æ€§äº‹åŠ¡ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰æ•°æ®ä¸ä¸€è‡´ï¼Œé˜»å¡ç­‰é£é™©ï¼Œè€Œä¸”åªèƒ½ç”¨åœ¨æ•°æ®åº“å±‚é¢ã€‚\nè€Œ TCC æ˜¯ä¸€ç§è¡¥å¿æ€§äº‹åŠ¡æ€æƒ³ï¼Œé€‚ç”¨çš„èŒƒå›´æ›´å¹¿ï¼Œåœ¨ä¸šåŠ¡å±‚é¢å®ç°ï¼Œå› æ­¤å¯¹ä¸šåŠ¡çš„ä¾µå…¥æ€§è¾ƒå¤§ï¼Œæ¯ä¸€ä¸ªæ“ä½œéƒ½éœ€è¦å®ç°å¯¹åº”çš„ä¸‰ä¸ªæ–¹æ³•ã€‚\næœ¬åœ°æ¶ˆæ¯ã€äº‹åŠ¡æ¶ˆæ¯å’Œæœ€å¤§åŠªåŠ›é€šçŸ¥å…¶å®éƒ½æ˜¯æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ï¼Œå› æ­¤é€‚ç”¨äºä¸€äº›å¯¹æ—¶é—´ä¸æ•æ„Ÿçš„ä¸šåŠ¡ã€‚\nå‚è€ƒ é¢è¯•å¿…é—®ï¼šåˆ†å¸ƒå¼äº‹åŠ¡å…­ç§è§£å†³æ–¹æ¡ˆ\rSeata\rå†æœ‰äººé—®ä½ åˆ†å¸ƒå¼äº‹åŠ¡ï¼ŒæŠŠè¿™ç¯‡æ‰”ç»™ä»–\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/","series":["Manual"],"tags":["åˆ†å¸ƒå¼","CS"],"title":"åˆ†å¸ƒå¼äº‹åŠ¡"},{"categories":["äº‘åŸç”Ÿ"],"content":"åˆ‡æ¢namespace\n0. èƒŒæ™¯ k8så¦‚ä½•åˆ‡æ¢namespaceï¼Ÿï¼Ÿè€Œä¸å¿…æ¯æ¬¡æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™åœ¨åé¢æŒ‡å®šnamespaceï¼Ÿk8så¹¶æ²¡æœ‰ç›´æ¥æä¾›åˆ‡æ¢namespaceçš„å‘½ä»¤ã€‚ä¸è¿‡å¯ä»¥é€šè¿‡ï¼š\n åˆ‡æ¢contextè¾¾åˆ°åˆ‡æ¢namespaceçš„ç›®çš„ï¼Œè¿™éœ€è¦æå‰åˆ›å»ºå¥½contextå’Œnamespaceçš„ç»‘å®šå…³ç³»ï¼ˆå¦‚ï¼škubectl config set-context test --namespace=testï¼‰,ç„¶åä½¿ç”¨ kubectl config use-context test åˆ‡æ¢contextï¼Œä»è€Œé—´æ¥çš„è¾¾åˆ°åˆ‡æ¢namespaceçš„ç›®çš„ã€‚è¿™æ–¹æ³•å±å®æ˜¯å¤ªåˆ«æ‰­äº†ï¼Œå¼ºè¿«ç—‡æ‚£è€…éƒ½ä¸å–œæ¬¢ã€‚ æˆ–è€…ä½¿ç”¨kubectxå·¥å…·ï¼Œå…¶æœ¬è´¨æ˜¯åŠ¨æ€çš„ä¿®æ”¹contextå’Œnamespaceçš„ç»‘å®šå…³ç³»ã€‚ä½¿ç”¨å½¢å¦‚ï¼škubens test å³å¯åˆ‡æ¢ã€‚è¿™æ ·æ‰æ˜¯åˆ‡æ¢namespaceçš„æ­£ç¡®æ‰“å¼€æ–¹å¼ï¼Œä¼˜é›…å¤šäº†ã€‚  å‚è€ƒèµ„æ–™ï¼š Kuberneteså‘½åç©ºé—´\rä¸€æ¡å‘½ä»¤è§£å†³Kubernetesæ›´æ”¹é»˜è®¤çš„namespace\rKubernetes åˆ‡æ¢contextå’Œnamespace\rk8sé›†ç¾¤namespaceå’Œcontextä½¿ç”¨\rahmetb / kubectx\ræé«˜æ‚¨çš„kubectlç”Ÿäº§åŠ›ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰ï¼šé›†ç¾¤ä¸Šä¸‹æ–‡åˆ‡æ¢ã€ä½¿ç”¨åˆ«åå‡å°‘è¾“å…¥å’Œæ’ä»¶æ‰©å±•\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/%E5%88%87%E6%8D%A2namespace/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"åˆ‡æ¢namespace"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"class CQueue { Stack\u0026lt;Integer\u0026gt; stack1; Stack\u0026lt;Integer\u0026gt; stack2; public CQueue() { stack1 = new Stack(); stack2 = new Stack(); } public void appendTail(int value) { stack1.push(value); } public int deleteHead() { if(stack2.isEmpty()){ while(stack1.isEmpty() == false){ stack2.push(stack1.pop()); } } if(stack2.isEmpty()){ return -1; }else{ return stack2.pop(); } } } /** * Your CQueue object will be instantiated and called as such: * CQueue obj = new CQueue(); * obj.appendTail(value); * int param_2 = obj.deleteHead(); */ å‰‘æŒ‡ Offer 09. ç”¨ä¸¤ä¸ªæ ˆå®ç°é˜Ÿåˆ—\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/leetcode/%E5%89%91%E6%8C%87-offer-09.-%E7%94%A8%E4%B8%A4%E4%B8%AA%E6%A0%88%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/","series":["Manual"],"tags":["å‰‘æŒ‡offer"],"title":"å‰‘æŒ‡ Offer 09. ç”¨ä¸¤ä¸ªæ ˆå®ç°é˜Ÿåˆ—"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"class CQueue { Stack\u0026lt;Integer\u0026gt; stack1; Stack\u0026lt;Integer\u0026gt; stack2; public CQueue() { stack1 = new Stack(); stack2 = new Stack(); } public void appendTail(int value) { stack1.push(value); } public int deleteHead() { if(stack2.isEmpty()){ while(stack1.isEmpty() == false){ stack2.push(stack1.pop()); } } if(stack2.isEmpty()){ return -1; }else{ return stack2.pop(); } } } /** * Your CQueue object will be instantiated and called as such: * CQueue obj = new CQueue(); * obj.appendTail(value); * int param_2 = obj.deleteHead(); */ å‰‘æŒ‡ Offer 09. ç”¨ä¸¤ä¸ªæ ˆå®ç°é˜Ÿåˆ—\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/leetcode/%E5%89%91%E6%8C%87-offer-18.-%E5%88%A0%E9%99%A4%E9%93%BE%E8%A1%A8%E7%9A%84%E8%8A%82%E7%82%B9/","series":["Manual"],"tags":["å‰‘æŒ‡offer"],"title":"å‰‘æŒ‡ Offer 18. åˆ é™¤é“¾è¡¨çš„èŠ‚ç‚¹"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‰‘æŒ‡ Offer 27. äºŒå‰æ ‘çš„é•œåƒ\r/** * Definition for a binary tree node. * public class TreeNode { * int val; * TreeNode left; * TreeNode right; * TreeNode(int x) { val = x; } * } */ class Solution { public TreeNode mirrorTree(TreeNode root) { if(root == null){ return root; } TreeNode posL = root.left; TreeNode posR = root.right; root.left = posR; root.right = posL; mirrorTree(root.left); mirrorTree(root.right); return root; } } ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/leetcode/%E5%89%91%E6%8C%87-offer-27.-%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E9%95%9C%E5%83%8F/","series":["Manual"],"tags":["å‰‘æŒ‡offer"],"title":"å‰‘æŒ‡ Offer 27. äºŒå‰æ ‘çš„é•œåƒ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"/** * Definition for a binary tree node. * public class TreeNode { * int val; * TreeNode left; * TreeNode right; * TreeNode(int x) { val = x; } * } */ class Solution { public boolean isSymmetric(TreeNode root) { if(root == null){return true;} return isSymmetric2(root.left, root.right); } private boolean isSymmetric2(TreeNode left, TreeNode right){ if (left == null \u0026amp;\u0026amp; right == null){return true;} if ((left == null \u0026amp;\u0026amp; right != null) || (left !=null \u0026amp;\u0026amp; right == null)){ return false; } if (left.val == right.val){ return isSymmetric2(left.left, right.right) \u0026amp;\u0026amp; isSymmetric2(left.right, right.left); } return false; } } å‰‘æŒ‡ Offer 28. å¯¹ç§°çš„äºŒå‰æ ‘\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/leetcode/%E5%89%91%E6%8C%87-offer-28.-%E5%AF%B9%E7%A7%B0%E7%9A%84%E4%BA%8C%E5%8F%89%E6%A0%91/","series":["Manual"],"tags":["å‰‘æŒ‡offer"],"title":"å‰‘æŒ‡ Offer 28. å¯¹ç§°çš„äºŒå‰æ ‘"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‰‘æŒ‡ Offer 30. åŒ…å«minå‡½æ•°çš„æ ˆ\rclass MinStack { Stack\u0026lt;Integer\u0026gt; stack1; Stack\u0026lt;Integer\u0026gt; stack2; /** initialize your data structure here. */ public MinStack() { stack1 = new Stack(); stack2 = new Stack(); } public void push(int x) { stack1.push(x); if(stack2.isEmpty()){ stack2.push(x); }else if(x \u0026gt; stack2.peek()){ stack2.push(stack2.peek()); }else{ stack2.push(x); } } public void pop() { stack1.pop(); stack2.pop(); } public int top() { return stack1.peek(); } public int min() { return stack2.peek(); } } /** * Your MinStack object will be instantiated and called as such: * MinStack obj = new MinStack(); * obj.push(x); * obj.pop(); * int param_3 = obj.top(); * int param_4 = obj.min(); */ ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/leetcode/%E5%89%91%E6%8C%87-offer-30.-%E5%8C%85%E5%90%ABmin%E5%87%BD%E6%95%B0%E7%9A%84%E6%A0%88/","series":["Manual"],"tags":["å‰‘æŒ‡offer"],"title":"å‰‘æŒ‡ Offer 30. åŒ…å«minå‡½æ•°çš„æ ˆ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"/** * Definition for singly-linked list. * public class ListNode { * int val; * ListNode next; * ListNode(int x) { val = x; } * } */ class Solution { public static int[] levelOrder(TreeNode root) { ArrayList\u0026lt;Integer\u0026gt; list = new ArrayList\u0026lt;Integer\u0026gt;(); if (root == null) { return new int[]{}; } Queue\u0026lt;TreeNode\u0026gt; queue=new LinkedList\u0026lt;TreeNode\u0026gt;(); queue.add(root); while(!queue.isEmpty()){ TreeNode node=queue.poll(); list.add(node.val); if(node.left!=null){ queue.add(node.left); } if(node.right!=null){ queue.add(node.right); } } int[] res = new int[list.size()]; for (int i = 0; i \u0026lt; list.size(); i++) { res[i] = list.get(i); } return res; } } å‰‘æŒ‡ Offer 32 - I. ä»ä¸Šåˆ°ä¸‹æ‰“å°äºŒå‰æ ‘\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/leetcode/%E5%89%91%E6%8C%87-offer-32-i.-%E4%BB%8E%E4%B8%8A%E5%88%B0%E4%B8%8B%E6%89%93%E5%8D%B0%E4%BA%8C%E5%8F%89%E6%A0%91/","series":["Manual"],"tags":["å‰‘æŒ‡offer"],"title":"å‰‘æŒ‡ Offer 32 - I. ä»ä¸Šåˆ°ä¸‹æ‰“å°äºŒå‰æ ‘"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‰‘æŒ‡ Offer 32 - II. ä»ä¸Šåˆ°ä¸‹æ‰“å°äºŒå‰æ ‘ II\rclass Solution { public List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; levelOrder(TreeNode root) { Queue\u0026lt;TreeNode\u0026gt; queue = new LinkedList\u0026lt;\u0026gt;(); List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; res = new ArrayList\u0026lt;\u0026gt;(); if(root != null) queue.add(root); while(!queue.isEmpty()) { List\u0026lt;Integer\u0026gt; tmp = new ArrayList\u0026lt;\u0026gt;(); for(int i = queue.size(); i \u0026gt; 0; i--) { TreeNode node = queue.poll(); tmp.add(node.val); if(node.left != null) queue.add(node.left); if(node.right != null) queue.add(node.right); } res.add(tmp); } return res; } } ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/leetcode/%E5%89%91%E6%8C%87-offer-32-ii.-%E4%BB%8E%E4%B8%8A%E5%88%B0%E4%B8%8B%E6%89%93%E5%8D%B0%E4%BA%8C%E5%8F%89%E6%A0%91-ii/","series":["Manual"],"tags":["å‰‘æŒ‡offer"],"title":"å‰‘æŒ‡ Offer 32 - II. ä»ä¸Šåˆ°ä¸‹æ‰“å°äºŒå‰æ ‘ II"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‰‘æŒ‡ Offer 32 - III. ä»ä¸Šåˆ°ä¸‹æ‰“å°äºŒå‰æ ‘ III\rpackage com.xzj; import java.util.*; /** * Definition for singly-linked list. * public class ListNode { * int val; * ListNode next; * ListNode(int x) { val = x; } * } */ class Solution { public static List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; levelOrder(TreeNode root) { List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; res = new ArrayList\u0026lt;\u0026gt;(); if (root == null){return res;} Stack\u0026lt;TreeNode\u0026gt; stack1 = new Stack(); Stack\u0026lt;TreeNode\u0026gt; stack2 = new Stack(); stack1.push(root); while (stack1.isEmpty() == false || stack2.isEmpty() == false){ List\u0026lt;Integer\u0026gt; sub = new ArrayList(); while (stack1.isEmpty() == false){ TreeNode node = stack1.pop(); sub.add(node.val); if (node.left != null){ stack2.push(node.left); } if (node.right != null){ stack2.push(node.right); } } if (sub.isEmpty() == false){ res.add(sub); } sub = new ArrayList(); while (stack2.isEmpty() == false){ TreeNode node = stack2.pop(); sub.add(node.val); if (node.right != null){ stack1.push(node.right); } if (node.left != null){ stack1.push(node.left); } } if (sub.isEmpty() == false){ res.add(sub); } } return res; } public static void main(String[] args) { TreeNode node1 = new TreeNode(3); TreeNode node2 = new TreeNode(9); TreeNode node3 = new TreeNode(20); TreeNode node4 = new TreeNode(15); TreeNode node5 = new TreeNode(7); node1.left = node2; node1.right = node3; node3.left = node4; node3.right = node5; System.out.println(levelOrder(node1)); System.out.println((7 \u0026amp; 8)); System.out.println(0 / 2); } } ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/leetcode/%E5%89%91%E6%8C%87-offer-32-iii.-%E4%BB%8E%E4%B8%8A%E5%88%B0%E4%B8%8B%E6%89%93%E5%8D%B0%E4%BA%8C%E5%8F%89%E6%A0%91-iii/","series":["Manual"],"tags":["å‰‘æŒ‡offer"],"title":"å‰‘æŒ‡ Offer 32 - III. ä»ä¸Šåˆ°ä¸‹æ‰“å°äºŒå‰æ ‘ III"},{"categories":["äººå·¥æ™ºèƒ½"],"content":"åœ¨ CNN å‡ºç°ä¹‹å‰ï¼Œå›¾åƒå¯¹äºäººå·¥æ™ºèƒ½æ¥è¯´æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼Œæœ‰2ä¸ªåŸå› ï¼š\n å›¾åƒéœ€è¦å¤„ç†çš„æ•°æ®é‡å¤ªå¤§ï¼Œå¯¼è‡´æˆæœ¬å¾ˆé«˜ï¼Œæ•ˆç‡å¾ˆä½ å›¾åƒåœ¨æ•°å­—åŒ–çš„è¿‡ç¨‹ä¸­å¾ˆéš¾ä¿ç•™åŸæœ‰çš„ç‰¹å¾ï¼Œå¯¼è‡´å›¾åƒå¤„ç†çš„å‡†ç¡®ç‡ä¸é«˜  ä¸‹é¢å°±è¯¦ç»†è¯´æ˜ä¸€ä¸‹è¿™2ä¸ªé—®é¢˜ï¼š\n0.0ã€éœ€è¦å¤„ç†çš„æ•°æ®é‡å¤ªå¤§ å›¾åƒæ˜¯ç”±åƒç´ æ„æˆçš„ï¼Œæ¯ä¸ªåƒç´ åˆæ˜¯ç”±é¢œè‰²æ„æˆçš„ã€‚\nç°åœ¨éšéšä¾¿ä¾¿ä¸€å¼ å›¾ç‰‡éƒ½æ˜¯ 1000Ã—1000 åƒç´ ä»¥ä¸Šçš„ï¼Œ æ¯ä¸ªåƒç´ éƒ½æœ‰RGB 3ä¸ªå‚æ•°æ¥è¡¨ç¤ºé¢œè‰²ä¿¡æ¯ã€‚\nå‡å¦‚æˆ‘ä»¬å¤„ç†ä¸€å¼  1000Ã—1000 åƒç´ çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬å°±éœ€è¦å¤„ç†3ç™¾ä¸‡ä¸ªå‚æ•°ï¼\n1000Ã—1000Ã—3=3,000,000\nè¿™ä¹ˆå¤§é‡çš„æ•°æ®å¤„ç†èµ·æ¥æ˜¯éå¸¸æ¶ˆè€—èµ„æºçš„ï¼Œè€Œä¸”è¿™åªæ˜¯ä¸€å¼ ä¸ç®—å¤ªå¤§çš„å›¾ç‰‡ï¼\nå·ç§¯ç¥ç»ç½‘ç»œ â€“ CNN è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ã€Œå°†å¤æ‚é—®é¢˜ç®€åŒ–ã€ï¼ŒæŠŠå¤§é‡å‚æ•°é™ç»´æˆå°‘é‡å‚æ•°ï¼Œå†åšå¤„ç†ã€‚\næ›´é‡è¦çš„æ˜¯ï¼šæˆ‘ä»¬åœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ï¼Œé™ç»´å¹¶ä¸ä¼šå½±å“ç»“æœã€‚æ¯”å¦‚1000åƒç´ çš„å›¾ç‰‡ç¼©å°æˆ200åƒç´ ï¼Œå¹¶ä¸å½±å“è‚‰çœ¼è®¤å‡ºæ¥å›¾ç‰‡ä¸­æ˜¯ä¸€åªçŒ«è¿˜æ˜¯ä¸€åªç‹—ï¼Œæœºå™¨ä¹Ÿæ˜¯å¦‚æ­¤ã€‚\n0.1ã€ä¿ç•™å›¾åƒç‰¹å¾ å›¾ç‰‡æ•°å­—åŒ–çš„ä¼ ç»Ÿæ–¹å¼æˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹ï¼Œå°±ç±»ä¼¼ä¸‹å›¾çš„è¿‡ç¨‹ï¼š\nå‡å¦‚æœ‰åœ†å½¢æ˜¯1ï¼Œæ²¡æœ‰åœ†å½¢æ˜¯0ï¼Œé‚£ä¹ˆåœ†å½¢çš„ä½ç½®ä¸åŒå°±ä¼šäº§ç”Ÿå®Œå…¨ä¸åŒçš„æ•°æ®è¡¨è¾¾ã€‚ä½†æ˜¯ä»è§†è§‰çš„è§’åº¦æ¥çœ‹ï¼Œå›¾åƒçš„å†…å®¹ï¼ˆæœ¬è´¨ï¼‰å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåªæ˜¯ä½ç½®å‘ç”Ÿäº†å˜åŒ–ã€‚\næ‰€ä»¥å½“æˆ‘ä»¬ç§»åŠ¨å›¾åƒä¸­çš„ç‰©ä½“ï¼Œç”¨ä¼ ç»Ÿçš„æ–¹å¼çš„å¾—å‡ºæ¥çš„å‚æ•°ä¼šå·®å¼‚å¾ˆå¤§ï¼è¿™æ˜¯ä¸ç¬¦åˆå›¾åƒå¤„ç†çš„è¦æ±‚çš„ã€‚\nè€Œ CNN è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä»–ç”¨ç±»ä¼¼è§†è§‰çš„æ–¹å¼ä¿ç•™äº†å›¾åƒçš„ç‰¹å¾ï¼Œå½“å›¾åƒåšç¿»è½¬ï¼Œæ—‹è½¬æˆ–è€…å˜æ¢ä½ç½®æ—¶ï¼Œå®ƒä¹Ÿèƒ½æœ‰æ•ˆçš„è¯†åˆ«å‡ºæ¥æ˜¯ç±»ä¼¼çš„å›¾åƒã€‚\né‚£ä¹ˆå·ç§¯ç¥ç»ç½‘ç»œæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿåœ¨æˆ‘ä»¬äº†è§£ CNN åŸç†ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹äººç±»çš„è§†è§‰åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ\n1ã€äººç±»çš„è§†è§‰åŸç† æ·±åº¦å­¦ä¹ çš„è®¸å¤šç ”ç©¶æˆæœï¼Œç¦»ä¸å¼€å¯¹å¤§è„‘è®¤çŸ¥åŸç†çš„ç ”ç©¶ï¼Œå°¤å…¶æ˜¯è§†è§‰åŸç†çš„ç ”ç©¶ã€‚\n1981 å¹´çš„è¯ºè´å°”åŒ»å­¦å¥–ï¼Œé¢å‘ç»™äº† David Hubelï¼ˆå‡ºç”ŸäºåŠ æ‹¿å¤§çš„ç¾å›½ç¥ç»ç”Ÿç‰©å­¦å®¶ï¼‰ å’ŒTorstenWieselï¼Œä»¥åŠ Roger Sperryã€‚å‰ä¸¤ä½çš„ä¸»è¦è´¡çŒ®ï¼Œæ˜¯â€œå‘ç°äº†è§†è§‰ç³»ç»Ÿçš„ä¿¡æ¯å¤„ç†â€ï¼Œå¯è§†çš®å±‚æ˜¯åˆ†çº§çš„ã€‚\näººç±»çš„è§†è§‰åŸç†å¦‚ä¸‹ï¼šä»åŸå§‹ä¿¡å·æ‘„å…¥å¼€å§‹ï¼ˆç³å­”æ‘„å…¥åƒç´  Pixelsï¼‰ï¼Œæ¥ç€åšåˆæ­¥å¤„ç†ï¼ˆå¤§è„‘çš®å±‚æŸäº›ç»†èƒå‘ç°è¾¹ç¼˜å’Œæ–¹å‘ï¼‰ï¼Œç„¶åæŠ½è±¡ï¼ˆå¤§è„‘åˆ¤å®šï¼Œçœ¼å‰çš„ç‰©ä½“çš„å½¢çŠ¶ï¼Œæ˜¯åœ†å½¢çš„ï¼‰ï¼Œç„¶åè¿›ä¸€æ­¥æŠ½è±¡ï¼ˆå¤§è„‘è¿›ä¸€æ­¥åˆ¤å®šè¯¥ç‰©ä½“æ˜¯åªæ°”çƒï¼‰ã€‚ä¸‹é¢æ˜¯äººè„‘è¿›è¡Œäººè„¸è¯†åˆ«çš„ä¸€ä¸ªç¤ºä¾‹ï¼š\nå¯¹äºä¸åŒçš„ç‰©ä½“ï¼Œäººç±»è§†è§‰ä¹Ÿæ˜¯é€šè¿‡è¿™æ ·é€å±‚åˆ†çº§ï¼Œæ¥è¿›è¡Œè®¤çŸ¥çš„ï¼š\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æœ€åº•å±‚ç‰¹å¾åŸºæœ¬ä¸Šæ˜¯ç±»ä¼¼çš„ï¼Œå°±æ˜¯å„ç§è¾¹ç¼˜ï¼Œè¶Šå¾€ä¸Šï¼Œè¶Šèƒ½æå–å‡ºæ­¤ç±»ç‰©ä½“çš„ä¸€äº›ç‰¹å¾ï¼ˆè½®å­ã€çœ¼ç›ã€èº¯å¹²ç­‰ï¼‰ï¼Œåˆ°æœ€ä¸Šå±‚ï¼Œä¸åŒçš„é«˜çº§ç‰¹å¾æœ€ç»ˆç»„åˆæˆç›¸åº”çš„å›¾åƒï¼Œä»è€Œèƒ½å¤Ÿè®©äººç±»å‡†ç¡®çš„åŒºåˆ†ä¸åŒçš„ç‰©ä½“ã€‚\né‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾ˆè‡ªç„¶çš„æƒ³åˆ°ï¼šå¯ä»¥ä¸å¯ä»¥æ¨¡ä»¿äººç±»å¤§è„‘çš„è¿™ä¸ªç‰¹ç‚¹ï¼Œæ„é€ å¤šå±‚çš„ç¥ç»ç½‘ç»œï¼Œè¾ƒä½å±‚çš„è¯†åˆ«åˆçº§çš„å›¾åƒç‰¹å¾ï¼Œè‹¥å¹²åº•å±‚ç‰¹å¾ç»„æˆæ›´ä¸Šä¸€å±‚ç‰¹å¾ï¼Œæœ€ç»ˆé€šè¿‡å¤šä¸ªå±‚çº§çš„ç»„åˆï¼Œæœ€ç»ˆåœ¨é¡¶å±‚åšå‡ºåˆ†ç±»å‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¿™ä¹Ÿæ˜¯è®¸å¤šæ·±åº¦å­¦ä¹ ç®—æ³•ï¼ˆåŒ…æ‹¬CNNï¼‰çš„çµæ„Ÿæ¥æºã€‚\n2ã€å·ç§¯ç¥ç»ç½‘ç»œ-CNN çš„åŸºæœ¬åŸç† å…¸å‹çš„ CNN ç”±3ä¸ªéƒ¨åˆ†æ„æˆï¼š\n å·ç§¯å±‚ æ± åŒ–å±‚ å…¨è¿æ¥å±‚  å¦‚æœç®€å•æ¥æè¿°çš„è¯ï¼šå·ç§¯å±‚è´Ÿè´£æå–å›¾åƒä¸­çš„å±€éƒ¨ç‰¹å¾ï¼›æ± åŒ–å±‚ç”¨æ¥å¤§å¹…é™ä½å‚æ•°é‡çº§(é™ç»´)ï¼›å…¨è¿æ¥å±‚ç±»ä¼¼ä¼ ç»Ÿç¥ç»ç½‘ç»œçš„éƒ¨åˆ†ï¼Œç”¨æ¥è¾“å‡ºæƒ³è¦çš„ç»“æœã€‚\nä¸‹é¢çš„åŸç†è§£é‡Šä¸ºäº†é€šä¿—æ˜“æ‡‚ï¼Œå¿½ç•¥äº†å¾ˆå¤šæŠ€æœ¯ç»†èŠ‚ï¼Œå¦‚æœå¤§å®¶å¯¹è¯¦ç»†çš„åŸç†æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹è¿™ä¸ªè§†é¢‘ã€Šå·ç§¯ç¥ç»ç½‘ç»œåŸºç¡€\rã€‹ã€‚\n2.1ã€å·ç§¯â€”â€”æå–ç‰¹å¾ å·ç§¯å±‚çš„è¿ç®—è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼Œç”¨ä¸€ä¸ªå·ç§¯æ ¸æ‰«å®Œæ•´å¼ å›¾ç‰‡ï¼š\nè¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªè¿‡æ»¤å™¨ï¼ˆå·ç§¯æ ¸ï¼‰æ¥è¿‡æ»¤å›¾åƒçš„å„ä¸ªå°åŒºåŸŸï¼Œä»è€Œå¾—åˆ°è¿™äº›å°åŒºåŸŸçš„ç‰¹å¾å€¼ã€‚\nåœ¨å…·ä½“åº”ç”¨ä¸­ï¼Œå¾€å¾€æœ‰å¤šä¸ªå·ç§¯æ ¸ï¼Œå¯ä»¥è®¤ä¸ºï¼Œæ¯ä¸ªå·ç§¯æ ¸ä»£è¡¨äº†ä¸€ç§å›¾åƒæ¨¡å¼ï¼Œå¦‚æœæŸä¸ªå›¾åƒå—ä¸æ­¤å·ç§¯æ ¸å·ç§¯å‡ºçš„å€¼å¤§ï¼Œåˆ™è®¤ä¸ºæ­¤å›¾åƒå—ååˆ†æ¥è¿‘äºæ­¤å·ç§¯æ ¸ã€‚å¦‚æœæˆ‘ä»¬è®¾è®¡äº†6ä¸ªå·ç§¯æ ¸ï¼Œå¯ä»¥ç†è§£ï¼šæˆ‘ä»¬è®¤ä¸ºè¿™ä¸ªå›¾åƒä¸Šæœ‰6ç§åº•å±‚çº¹ç†æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨6ä¸­åŸºç¡€æ¨¡å¼å°±èƒ½æç»˜å‡ºä¸€å‰¯å›¾åƒã€‚ä»¥ä¸‹å°±æ˜¯25ç§ä¸åŒçš„å·ç§¯æ ¸çš„ç¤ºä¾‹ï¼š\næ€»ç»“ï¼šå·ç§¯å±‚çš„é€šè¿‡å·ç§¯æ ¸çš„è¿‡æ»¤æå–å‡ºå›¾ç‰‡ä¸­å±€éƒ¨çš„ç‰¹å¾ï¼Œè·Ÿä¸Šé¢æåˆ°çš„äººç±»è§†è§‰çš„ç‰¹å¾æå–ç±»ä¼¼ã€‚\n2.2ã€æ± åŒ–å±‚ï¼ˆä¸‹é‡‡æ ·ï¼‰â€”â€”æ•°æ®é™ç»´ï¼Œé¿å…è¿‡æ‹Ÿåˆ æ± åŒ–å±‚ç®€å•è¯´å°±æ˜¯ä¸‹é‡‡æ ·ï¼Œä»–å¯ä»¥å¤§å¤§é™ä½æ•°æ®çš„ç»´åº¦ã€‚å…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š\nä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒåŸå§‹å›¾ç‰‡æ˜¯20Ã—20çš„ï¼Œæˆ‘ä»¬å¯¹å…¶è¿›è¡Œä¸‹é‡‡æ ·ï¼Œé‡‡æ ·çª—å£ä¸º10Ã—10ï¼Œæœ€ç»ˆå°†å…¶ä¸‹é‡‡æ ·æˆä¸ºä¸€ä¸ª2Ã—2å¤§å°çš„ç‰¹å¾å›¾ã€‚\nä¹‹æ‰€ä»¥è¿™ä¹ˆåšçš„åŸå› ï¼Œæ˜¯å› ä¸ºå³ä½¿åšå®Œäº†å·ç§¯ï¼Œå›¾åƒä»ç„¶å¾ˆå¤§ï¼ˆå› ä¸ºå·ç§¯æ ¸æ¯”è¾ƒå°ï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†é™ä½æ•°æ®ç»´åº¦ï¼Œå°±è¿›è¡Œä¸‹é‡‡æ ·ã€‚\næ€»ç»“ï¼šæ± åŒ–å±‚ç›¸æ¯”å·ç§¯å±‚å¯ä»¥æ›´æœ‰æ•ˆçš„é™ä½æ•°æ®ç»´åº¦ï¼Œè¿™ä¹ˆåšä¸ä½†å¯ä»¥å¤§å¤§å‡å°‘è¿ç®—é‡ï¼Œè¿˜å¯ä»¥æœ‰æ•ˆçš„é¿å…è¿‡æ‹Ÿåˆã€‚\n2.3ã€å…¨è¿æ¥å±‚â€”â€”è¾“å‡ºç»“æœ è¿™ä¸ªéƒ¨åˆ†å°±æ˜¯æœ€åä¸€æ­¥äº†ï¼Œç»è¿‡å·ç§¯å±‚å’Œæ± åŒ–å±‚å¤„ç†è¿‡çš„æ•°æ®è¾“å…¥åˆ°å…¨è¿æ¥å±‚ï¼Œå¾—åˆ°æœ€ç»ˆæƒ³è¦çš„ç»“æœã€‚\nç»è¿‡å·ç§¯å±‚å’Œæ± åŒ–å±‚é™ç»´è¿‡çš„æ•°æ®ï¼Œå…¨è¿æ¥å±‚æ‰èƒ½â€è·‘å¾—åŠ¨â€ï¼Œä¸ç„¶æ•°æ®é‡å¤ªå¤§ï¼Œè®¡ç®—æˆæœ¬é«˜ï¼Œæ•ˆç‡ä½ä¸‹ã€‚\nå…¸å‹çš„ CNN å¹¶éåªæ˜¯ä¸Šé¢æåˆ°çš„3å±‚ç»“æ„ï¼Œè€Œæ˜¯å¤šå±‚ç»“æ„ï¼Œä¾‹å¦‚ LeNet-5 çš„ç»“æ„å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå·ç§¯å±‚ â€“ æ± åŒ–å±‚- å·ç§¯å±‚ â€“ æ± åŒ–å±‚ â€“ å·ç§¯å±‚ â€“ å…¨è¿æ¥å±‚\n3ã€æ€»ç»“ ä»Šå¤©æˆ‘ä»¬ä»‹ç»äº† CNN çš„ä»·å€¼ã€åŸºæœ¬åŸç†å’Œåº”ç”¨åœºæ™¯ï¼Œç®€å•æ€»ç»“å¦‚ä¸‹ï¼š\nCNN çš„ä»·å€¼ï¼š\n èƒ½å¤Ÿå°†å¤§æ•°æ®é‡çš„å›¾ç‰‡æœ‰æ•ˆçš„é™ç»´æˆå°æ•°æ®é‡(å¹¶ä¸å½±å“ç»“æœ) èƒ½å¤Ÿä¿ç•™å›¾ç‰‡çš„ç‰¹å¾ï¼Œç±»ä¼¼äººç±»çš„è§†è§‰åŸç†  CNN çš„åŸºæœ¬åŸç†ï¼š\n å·ç§¯å±‚ â€“ ä¸»è¦ä½œç”¨æ˜¯ä¿ç•™å›¾ç‰‡çš„ç‰¹å¾ æ± åŒ–å±‚ â€“ ä¸»è¦ä½œç”¨æ˜¯æŠŠæ•°æ®é™ç»´ï¼Œå¯ä»¥æœ‰æ•ˆçš„é¿å…è¿‡æ‹Ÿåˆ å…¨è¿æ¥å±‚ â€“ æ ¹æ®ä¸åŒä»»åŠ¡è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„ç»“æœ  CNN çš„å®é™…åº”ç”¨ï¼š\nå›¾åƒåˆ†ç±»ã€æ£€ç´¢\nå›¾åƒåˆ†ç±»æ˜¯æ¯”è¾ƒåŸºç¡€çš„åº”ç”¨ï¼Œä»–å¯ä»¥èŠ‚çœå¤§é‡çš„äººå·¥æˆæœ¬ï¼Œå°†å›¾åƒè¿›è¡Œæœ‰æ•ˆçš„åˆ†ç±»ã€‚å¯¹äºä¸€äº›ç‰¹å®šé¢†åŸŸçš„å›¾ç‰‡ï¼Œåˆ†ç±»çš„å‡†ç¡®ç‡å¯ä»¥è¾¾åˆ° 95%+ï¼Œå·²ç»ç®—æ˜¯ä¸€ä¸ªå¯ç”¨æ€§å¾ˆé«˜çš„åº”ç”¨äº†ã€‚\nå…¸å‹åœºæ™¯ï¼šå›¾åƒæœç´¢â€¦\nç›®æ ‡å®šä½æ£€æµ‹\nå¯ä»¥åœ¨å›¾åƒä¸­å®šä½ç›®æ ‡ï¼Œå¹¶ç¡®å®šç›®æ ‡çš„ä½ç½®åŠå¤§å°ã€‚\nå…¸å‹åœºæ™¯ï¼šè‡ªåŠ¨é©¾é©¶ã€å®‰é˜²ã€åŒ»ç–—â€¦\nç›®æ ‡åˆ†å‰²\nç®€å•ç†è§£å°±æ˜¯ä¸€ä¸ªåƒç´ çº§çš„åˆ†ç±»ã€‚\nä»–å¯ä»¥å¯¹å‰æ™¯å’ŒèƒŒæ™¯è¿›è¡Œåƒç´ çº§çš„åŒºåˆ†ã€å†é«˜çº§ä¸€ç‚¹è¿˜å¯ä»¥è¯†åˆ«å‡ºç›®æ ‡å¹¶ä¸”å¯¹ç›®æ ‡è¿›è¡Œåˆ†ç±»ã€‚\nå…¸å‹åœºæ™¯ï¼šç¾å›¾ç§€ç§€ã€è§†é¢‘åæœŸåŠ å·¥ã€å›¾åƒç”Ÿæˆâ€¦\näººè„¸è¯†åˆ«\näººè„¸è¯†åˆ«å·²ç»æ˜¯ä¸€ä¸ªéå¸¸æ™®åŠçš„åº”ç”¨äº†ï¼Œåœ¨å¾ˆå¤šé¢†åŸŸéƒ½æœ‰å¹¿æ³›çš„åº”ç”¨ã€‚\nå…¸å‹åœºæ™¯ï¼šå®‰é˜²ã€é‡‘èã€ç”Ÿæ´»â€¦\néª¨éª¼è¯†åˆ«\néª¨éª¼è¯†åˆ«æ˜¯å¯ä»¥è¯†åˆ«èº«ä½“çš„å…³é”®éª¨éª¼ï¼Œä»¥åŠè¿½è¸ªéª¨éª¼çš„åŠ¨ä½œã€‚\nå…¸å‹åœºæ™¯ï¼šå®‰é˜²ã€ç”µå½±ã€å›¾åƒè§†é¢‘ç”Ÿæˆã€æ¸¸æˆâ€¦\nå‚è€ƒ https://easyai.tech/ai-definition/cnn/\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9Ccnn/","series":["Manual"],"tags":["CNN","AI"],"title":"å·ç§¯ç¥ç»ç½‘ç»œâ€“CNN"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. proxy_passåé¢åŠ æ ¹è·¯å¾„/ location ^~/user/ { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-NginX-Proxy true; proxy_pass http://user/; } ^~/user/è¡¨ç¤ºåŒ¹é…å‰ç¼€æ˜¯userçš„è¯·æ±‚ï¼Œproxy_passçš„ç»“å°¾æœ‰/ï¼Œ åˆ™ä¼šæŠŠ/user/*åé¢çš„è·¯å¾„ç›´æ¥æ‹¼æ¥åˆ°åé¢ï¼Œå³ç§»é™¤userã€‚\n2. ä½¿ç”¨rewrite location ^~/user/ { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-NginX-Proxy true; rewrite ^/user/(.*)$ /$1 break; proxy_pass http://user; } æ³¨æ„åˆ°proxy_passç»“å°¾æ²¡æœ‰/ï¼Œ rewriteé‡å†™äº†urlã€‚\nå‚è€ƒé“¾æ¥ï¼š Nginxä»£ç†proxy passé…ç½®å»é™¤å‰ç¼€\rNginx è½¬å‘åŸŸååœ°å€æŠ¥ 400 Bad Request\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/nginx/%E5%8E%BB%E9%99%A4%E8%AF%B7%E6%B1%82path%E5%89%8D%E7%BC%80/","series":["Manual"],"tags":["nginx"],"title":"å»é™¤è¯·æ±‚pathå‰ç¼€"},{"categories":["äººå·¥æ™ºèƒ½"],"content":"è¯´åˆ°ç¥ç»ç½‘ç»œï¼Œå¤§å®¶çœ‹åˆ°è¿™ä¸ªå›¾åº”è¯¥ä¸é™Œç”Ÿï¼š\nè¿™æ˜¯å…¸å‹çš„ä¸‰å±‚ç¥ç»ç½‘ç»œçš„åŸºæœ¬æ„æˆï¼ŒLayer L1æ˜¯è¾“å…¥å±‚ï¼ŒLayer L2æ˜¯éšå«å±‚ï¼ŒLayer L3æ˜¯éšå«å±‚ï¼Œæˆ‘ä»¬ç°åœ¨æ‰‹é‡Œæœ‰ä¸€å †æ•°æ®{x1,x2,x3,\u0026hellip;,xn},è¾“å‡ºä¹Ÿæ˜¯ä¸€å †æ•°æ®{y1,y2,y3,\u0026hellip;,yn},ç°åœ¨è¦ä»–ä»¬åœ¨éšå«å±‚åšæŸç§å˜æ¢ï¼Œè®©ä½ æŠŠæ•°æ®çŒè¿›å»åå¾—åˆ°ä½ æœŸæœ›çš„è¾“å‡ºã€‚å¦‚æœä½ å¸Œæœ›ä½ çš„è¾“å‡ºå’ŒåŸå§‹è¾“å…¥ä¸€æ ·ï¼Œé‚£ä¹ˆå°±æ˜¯æœ€å¸¸è§çš„è‡ªç¼–ç æ¨¡å‹ï¼ˆAuto-Encoderï¼‰ã€‚å¯èƒ½æœ‰äººä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦è¾“å…¥è¾“å‡ºéƒ½ä¸€æ ·å‘¢ï¼Ÿæœ‰ä»€ä¹ˆç”¨å•Šï¼Ÿå…¶å®åº”ç”¨æŒºå¹¿çš„ï¼Œåœ¨å›¾åƒè¯†åˆ«ï¼Œæ–‡æœ¬åˆ†ç±»ç­‰ç­‰éƒ½ä¼šç”¨åˆ°ï¼Œæˆ‘ä¼šä¸“é—¨å†å†™ä¸€ç¯‡Auto-Encoderçš„æ–‡ç« æ¥è¯´æ˜ï¼ŒåŒ…æ‹¬ä¸€äº›å˜ç§ä¹‹ç±»çš„ã€‚å¦‚æœä½ çš„è¾“å‡ºå’ŒåŸå§‹è¾“å…¥ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå°±æ˜¯å¾ˆå¸¸è§çš„äººå·¥ç¥ç»ç½‘ç»œäº†ï¼Œç›¸å½“äºè®©åŸå§‹æ•°æ®é€šè¿‡ä¸€ä¸ªæ˜ å°„æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„è¾“å‡ºæ•°æ®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®²çš„è¯é¢˜ã€‚\næœ¬æ–‡ç›´æ¥ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¸¦å…¥æ•°å€¼æ¼”ç¤ºåå‘ä¼ æ’­æ³•çš„è¿‡ç¨‹ï¼Œå…¬å¼çš„æ¨å¯¼ç­‰åˆ°ä¸‹æ¬¡å†™Auto-Encoderçš„æ—¶å€™å†å†™ï¼Œå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±æ¨å¯¼ä¸‹è¯•è¯•ï¼šï¼‰ï¼ˆæ³¨ï¼šæœ¬æ–‡å‡è®¾ä½ å·²ç»æ‡‚å¾—åŸºæœ¬çš„ç¥ç»ç½‘ç»œæ„æˆï¼Œå¦‚æœå®Œå…¨ä¸æ‡‚ï¼Œå¯ä»¥å‚è€ƒPollå†™çš„ç¬”è®°ï¼š[Mechine Learning \u0026amp; Algorithm] ç¥ç»ç½‘ç»œåŸºç¡€\rï¼‰\nå‡è®¾ï¼Œä½ æœ‰è¿™æ ·ä¸€ä¸ªç½‘ç»œå±‚ï¼š\nç¬¬ä¸€å±‚æ˜¯è¾“å…¥å±‚ï¼ŒåŒ…å«ä¸¤ä¸ªç¥ç»å…ƒi1ï¼Œi2ï¼Œå’Œæˆªè·é¡¹b1ï¼›ç¬¬äºŒå±‚æ˜¯éšå«å±‚ï¼ŒåŒ…å«ä¸¤ä¸ªç¥ç»å…ƒh1,h2å’Œæˆªè·é¡¹b2ï¼Œç¬¬ä¸‰å±‚æ˜¯è¾“å‡ºo1,o2ï¼Œæ¯æ¡çº¿ä¸Šæ ‡çš„wiæ˜¯å±‚ä¸å±‚ä¹‹é—´è¿æ¥çš„æƒé‡ï¼Œæ¿€æ´»å‡½æ•°æˆ‘ä»¬é»˜è®¤ä¸ºsigmoidå‡½æ•°ã€‚\nç°åœ¨å¯¹ä»–ä»¬èµ‹ä¸Šåˆå€¼ï¼Œå¦‚ä¸‹å›¾ï¼š\nå…¶ä¸­ï¼Œè¾“å…¥æ•°æ® i1=0.05ï¼Œi2=0.10;\nã€€è¾“å‡ºæ•°æ® o1=0.01,o2=0.99;\nã€€åˆå§‹æƒé‡ w1=0.15,w2=0.20,w3=0.25,w4=0.30;\nã€€w5=0.40,w6=0.45,w7=0.50,w8=0.55\nç›®æ ‡ï¼šç»™å‡ºè¾“å…¥æ•°æ®i1,i2(0.05å’Œ0.10)ï¼Œä½¿è¾“å‡ºå°½å¯èƒ½ä¸åŸå§‹è¾“å‡ºo1,o2(0.01å’Œ0.99)æ¥è¿‘ã€‚\nStep 1 å‰å‘ä¼ æ’­\n1.è¾“å…¥å±‚\u0026mdash;-\u0026gt;éšå«å±‚ï¼š\nè®¡ç®—ç¥ç»å…ƒh1çš„è¾“å…¥åŠ æƒå’Œï¼š $$ \\begin{array}{l} n e t_{h 1}=w_{1} * i_{1}+w_{2} * i_{2}+b_{1} * 1 \\\n{ net }_{h 1}=0.15 * 0.05+0.2 * 0.1+0.35 * 1=0.3775 \\end{array} $$ ç¥ç»å…ƒh1çš„è¾“å‡ºo1:(æ­¤å¤„ç”¨åˆ°æ¿€æ´»å‡½æ•°ä¸ºsigmoidå‡½æ•°)ï¼š $$ { out }_{h 1}=\\frac{1}{1+e^{-n e t_{h 1}}}=\\frac{1}{1+e^{-0.3775}}=0.593269992 $$ åŒç†ï¼Œå¯è®¡ç®—å‡ºç¥ç»å…ƒh2çš„è¾“å‡ºo2ï¼š $$ { out }_{h 2}=0.596884378 $$ 2.éšå«å±‚\u0026mdash;-\u0026gt;è¾“å‡ºå±‚ï¼š\nè®¡ç®—è¾“å‡ºå±‚ç¥ç»å…ƒo1å’Œo2çš„å€¼ï¼š $$ \\begin{array}{l} { net }{o 1}=w{5} * { out }{h 1}+w{6} * { out }{h 2}+b{2} * 1 \\\n{ net }{o 1}=0.4 * 0.593269992+0.45 * 0.596884378+0.6 * 1=1.105905967 \\\n{ out }{o 1}=\\frac{1}{1+e^{-n e t_{o 1}}}=\\frac{1}{1+e^{-1.105905967}}=0.75136507 \\\n{ out }_{o 2}=0.772928465 \\end{array} $$ è¿™æ ·å‰å‘ä¼ æ’­çš„è¿‡ç¨‹å°±ç»“æŸäº†ï¼Œæˆ‘ä»¬å¾—åˆ°è¾“å‡ºå€¼ä¸º[0.75136079 , 0.772928465]ï¼Œä¸å®é™…å€¼[0.01 , 0.99]ç›¸å·®è¿˜å¾ˆè¿œï¼Œç°åœ¨æˆ‘ä»¬å¯¹è¯¯å·®è¿›è¡Œåå‘ä¼ æ’­ï¼Œæ›´æ–°æƒå€¼ï¼Œé‡æ–°è®¡ç®—è¾“å‡ºã€‚\nStep 2 åå‘ä¼ æ’­\n1.è®¡ç®—æ€»è¯¯å·®\næ€»è¯¯å·®ï¼š(square error) $$ E_{ {total }}=\\sum \\frac{1}{2}( { target }- { output })^{2} $$ ä½†æ˜¯æœ‰ä¸¤ä¸ªè¾“å‡ºï¼Œæ‰€ä»¥åˆ†åˆ«è®¡ç®—o1å’Œo2çš„è¯¯å·®ï¼Œæ€»è¯¯å·®ä¸ºä¸¤è€…ä¹‹å’Œï¼š $$ \\begin{array}{l} E_{o 1}=\\frac{1}{2}\\left( { target }_{o 1}- { out }_{o 1}\\right)^{2}=\\frac{1}{2}(0.01-0.75136507)^{2}=0.274811083 \\\nE_{o 2}=0.023560026 \\\nE_{ {total }}=E_{o 1}+E_{o 2}=0.274811083+0.023560026=0.298371109 \\end{array} $$ 2.éšå«å±‚\u0026mdash;-\u0026gt;è¾“å‡ºå±‚çš„æƒå€¼æ›´æ–°ï¼š\nä»¥æƒé‡å‚æ•°w5ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³çŸ¥é“w5å¯¹æ•´ä½“è¯¯å·®äº§ç”Ÿäº†å¤šå°‘å½±å“ï¼Œå¯ä»¥ç”¨æ•´ä½“è¯¯å·®å¯¹w5æ±‚åå¯¼æ±‚å‡ºï¼šï¼ˆé“¾å¼æ³•åˆ™ï¼‰ $$ \\frac{\\partial E_{{total }}}{\\partial w_{5}}=\\frac{\\partial E_{\\text {total }}}{\\partial { out }_{o 1}} * \\frac{\\partial {out }_{o 1}}{\\partial { net }_{o 1}} * \\frac{\\partial { net }_{o 1}}{\\partial w_{5}} $$ ä¸‹é¢çš„å›¾å¯ä»¥æ›´ç›´è§‚çš„çœ‹æ¸…æ¥šè¯¯å·®æ˜¯æ€æ ·åå‘ä¼ æ’­çš„ï¼š\nç°åœ¨æˆ‘ä»¬æ¥åˆ†åˆ«è®¡ç®—æ¯ä¸ªå¼å­çš„å€¼ï¼š\nè®¡ç®—ï¼š $$ \\frac{\\partial E_{ {total }}}{\\partial { out }_{o 1}} $$\n$$ \\begin{array}{l} E_{ {total }}=\\frac{1}{2}\\left( { target }_{o 1}-\\text { out }_{o 1}\\right)^{2}+\\frac{1}{2}\\left( { target }_{o 2}- { out }_{o 2}\\right)^{2} \\\n\\frac{\\partial E_{ {total }}}{\\partial { out }_{o 1}}=2 * \\frac{1}{2}\\left( { target }_{o 1}- { out }_{o 1}\\right)^{2-1} *-1+0 \\\n\\frac{\\partial E_{ {total }}}{\\partial { outo }}=-\\left( { target }_{o 1}- { out }_{o 1}\\right)=-(0.01-0.75136507)=0.74136507 \\end{array} $$\nè®¡ç®—ï¼š $$ \\frac{\\partial { out }{o 1}}{\\partial n e t{o 1}} $$\n$$ \\begin{array}{l} { out }{o 1}=\\frac{1}{1+e^{-n e t{o 1}}} \\\n\\frac{\\partial { out }{o 1}}{\\partial { net }{o 1}}= { out }{o 1}\\left(1- { out }{o 1}\\right)=0.75136507(1-0.75136507)=0.186815602 \\end{array} $$\nï¼ˆè¿™ä¸€æ­¥å®é™…ä¸Šå°±æ˜¯å¯¹sigmoidå‡½æ•°æ±‚å¯¼ï¼Œæ¯”è¾ƒç®€å•ï¼Œå¯ä»¥è‡ªå·±æ¨å¯¼ä¸€ä¸‹ï¼‰\nè®¡ç®—ï¼š $$ \\frac{\\partial { net }{o 1}}{\\partial w{5}} $$\n$$ \\begin{array}{l} n e t_{o 1}=w_{5} * { out }_{h 1}+w_{6} * { out }_{h 2}+b_{2} * 1 \\\n\\frac{\\partial { net }_{o 1}}{\\partial w_{5}}=1 * { out }_{h 1} * w_{5}^{(1-1)}+0+0= { out }_{h 1}=0.593269992 \\end{array} $$\næœ€åä¸‰è€…ç›¸ä¹˜ï¼š $$ \\begin{array}{l} \\frac{\\partial E_{ {total }}}{\\partial w_{5}}=\\frac{\\partial E_{ {total }}}{\\partial o u t_{o 1}} * \\frac{\\partial { out }_{o 1}}{\\partial n e t_{o 1}} * \\frac{\\partial n e t_{o 1}}{\\partial w_{5}} \\\n\\frac{\\partial E_{ {total }}}{\\partial w_{5}}=0.74136507 * 0.186815602 * 0.593269992=0.082167041 \\end{array} $$ è¿™æ ·æˆ‘ä»¬å°±è®¡ç®—å‡ºæ•´ä½“è¯¯å·®E(total)å¯¹w5çš„åå¯¼å€¼ã€‚\nå›è¿‡å¤´æ¥å†çœ‹çœ‹ä¸Šé¢çš„å…¬å¼ï¼Œæˆ‘ä»¬å‘ç°ï¼š $$ \\frac{\\partial E_{t o t a l}}{\\partial w_{5}}=-\\left(\\operatorname{target}_{o 1}- { out }_{o 1}\\right) * { out }_{o 1}\\left(1- { out }_{o 1}\\right) * { out }_{h 1} $$ ä¸ºäº†è¡¨è¾¾æ–¹ä¾¿ï¼Œç”¨$$\\delta_{o 1}$$æ¥è¡¨ç¤ºè¾“å‡ºå±‚çš„è¯¯å·®ï¼š $$ \\begin{array}{l} \\delta_{o 1}=\\frac{\\partial E_{ {total }}}{\\partial o u t_{o 1}} * \\frac{\\partial { out }_{o 1}}{\\partial n e t_{o 1}}=\\frac{\\partial E_{ {total }}}{\\partial n e t_{o 1}} \\\n\\delta_{o 1}=-\\left(\\operatorname{target}_{o 1}- { out }_{o 1}\\right) * { out }_{o 1}\\left(1- { out }_{o 1}\\right) \\end{array} $$ å› æ­¤ï¼Œæ•´ä½“è¯¯å·®E(total)å¯¹w5çš„åå¯¼å…¬å¼å¯ä»¥å†™æˆï¼š $$ \\frac{\\partial E_{ {total }}}{\\partial w_{5}}=\\delta_{o 1} { out }_{h 1} $$ å¦‚æœè¾“å‡ºå±‚è¯¯å·®è®¡ä¸ºè´Ÿçš„è¯ï¼Œä¹Ÿå¯ä»¥å†™æˆï¼š $$ \\frac{\\partial E_{ {total }}}{\\partial w_{5}}=-\\delta_{o 1} { out }_{h 1} $$ æœ€åæˆ‘ä»¬æ¥æ›´æ–°w5çš„å€¼ï¼š $$ w_{5}^{+}=w_{5}-\\eta * \\frac{\\partial E_{ {total }}}{\\partial_{w_{5}}}=0.4-0.5 * 0.082167041=0.35891648 $$ ï¼ˆå…¶ä¸­ï¼Œ$$\\eta$$æ˜¯å­¦ä¹ é€Ÿç‡ï¼Œè¿™é‡Œæˆ‘ä»¬å–0.5ï¼‰\nåŒç†ï¼Œå¯æ›´æ–°w6,w7,w8: $$ \\begin{array}{l} w_{6}^{+}=0.408666186 \\\nw_{7}^{+}=0.511301270 \\\nw_{8}^{+}=0.561370121 \\end{array} $$ 3.éšå«å±‚\u0026mdash;-\u0026gt;è¾“å…¥å±‚çš„æƒå€¼æ›´æ–°ï¼š\nã€€æ–¹æ³•å…¶å®ä¸ä¸Šé¢è¯´çš„å·®ä¸å¤šï¼Œä½†æ˜¯æœ‰ä¸ªåœ°æ–¹éœ€è¦å˜ä¸€ä¸‹ï¼Œåœ¨ä¸Šæ–‡è®¡ç®—æ€»è¯¯å·®å¯¹w5çš„åå¯¼æ—¶ï¼Œæ˜¯ä»out(o1)\u0026mdash;-\u0026gt;net(o1)\u0026mdash;-\u0026gt;w5,ä½†æ˜¯åœ¨éšå«å±‚ä¹‹é—´çš„æƒå€¼æ›´æ–°æ—¶ï¼Œæ˜¯out(h1)\u0026mdash;-\u0026gt;net(h1)\u0026mdash;-\u0026gt;w1,è€Œout(h1)ä¼šæ¥å—E(o1)å’ŒE(o2)ä¸¤ä¸ªåœ°æ–¹ä¼ æ¥çš„è¯¯å·®ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ä¸¤ä¸ªéƒ½è¦è®¡ç®—ã€‚\nè®¡ç®—ï¼š $$ \\frac{\\partial E_{ {total }}}{\\partial { out }_{h 1}} $$\n$$ \\frac{\\partial E_{ {total }}}{\\partial o u t_{h 1}}=\\frac{\\partial E_{o 1}}{\\partial o u t_{h 1}}+\\frac{\\partial E_{o 2}}{\\partial o u t_{h 1}} $$\nå…ˆè®¡ç®—ï¼š $$ \\frac{\\partial E_{o 1}}{\\partial o u t_{h 1}} $$\n$$ \\begin{array}{l} \\frac{\\partial E_{o 1}}{\\partial o u t_{h 1}}=\\frac{\\partial E_{o 1}}{\\partial n e t_{o 1}} * \\frac{\\partial n e t_{o 1}}{\\partial o u t_{h 1}} \\\n\\frac{\\partial E_{o 1}}{\\partial n e t_{o 1}}=\\frac{\\partial E_{o 1}}{\\partial o u t_{o 1}} * \\frac{\\partial o u t_{o 1}}{\\partial n e t_{o 1}}=0.74136507 * 0.186815602=0.138498562 \\\n{ net }_{o 1}=w_{5} * o u t_{h 1}+w_{6} * { out }_{h 2}+b_{2} * 1 \\\n\\frac{\\partial { net }_{o 1}}{\\partial o u t_{h 1}}=w_{5}=0.40 \\\n\\frac{\\partial E_{o 1}}{\\partial o u t_{h 1}}=\\frac{\\partial E_{o 1}}{\\partial n e t_{o 1}} * \\frac{\\partial n e t_{o 1}}{\\partial o u t_{h 1}}=0.138498562 * 0.40=0.055399425 \\end{array} $$\nåŒç†ï¼Œè®¡ç®—å‡ºï¼š $$ \\frac{\\partial E_{o 2}}{\\partial o u t_{h 1}}=-0.019049119 $$ ä¸¤è€…ç›¸åŠ å¾—åˆ°æ€»å€¼ï¼š $$ \\frac{\\partial E_{ {total }}}{\\partial o u t_{h 1}}=\\frac{\\partial E_{o 1}}{\\partial o u t_{h 1}}+\\frac{\\partial E_{o 2}}{\\partial o u t_{h 1}}=0.055399425+-0.019049119=0.036350306 $$ å†è®¡ç®—ï¼š $$ \\frac{\\partial o u t_{h 1}}{\\partial n e t_{h 1}} $$\n$$ \\begin{array}{l} { out }{h 1}=\\frac{1}{1+e^{-n e t}{h 1}} \\\n\\frac{\\partial { out }{h 1}}{\\partial n e t{h 1}}= { out }{h 1}\\left(1- { out }{h 1}\\right)=0.59326999(1-0.59326999)=0.241300709 \\end{array} $$\nå†è®¡ç®—ï¼š $$ \\frac{\\partial n e t_{h 1}}{\\partial w_{1}} $$\n$$ \\begin{array}{l} { net }{h 1}=w{1} * i_{1}+w_{2} * i_{2}+b_{1} * 1 \\\n\\frac{\\partial n e t_{h 1}}{\\partial w_{1}}=i_{1}=0.05 \\end{array} $$\næœ€åï¼Œä¸‰è€…ç›¸ä¹˜ï¼š $$ \\begin{array}{l} \\frac{\\partial E_{ {total }}}{\\partial w_{1}}=\\frac{\\partial E_{ {total }}}{\\partial { out }_{h 1}} * \\frac{\\partial { out }_{h 1}}{\\partial n e t_{h 1}} * \\frac{\\partial { net }_{h 1}}{\\partial w_{1}} \\\n\\frac{\\partial E_{ {total }}}{\\partial w_{1}}=0.036350306 * 0.241300709 * 0.05=0.000438568 \\end{array} $$ ä¸ºäº†ç®€åŒ–å…¬å¼ï¼Œç”¨sigma(h1)è¡¨ç¤ºéšå«å±‚å•å…ƒh1çš„è¯¯å·®ï¼š $$ \\begin{array}{l} \\frac{\\partial E_{ {total }}}{\\partial w_{1}}=\\left(\\sum_{o} \\frac{\\partial E_{ {total }}}{\\partial o u t_{o}} * \\frac{\\partial { out }_{o}}{\\partial n e t_{o}} * \\frac{\\partial { net }_{o}}{\\partial o u t_{h 1}}\\right) * \\frac{\\partial o u t_{h 1}}{\\partial n e t_{h 1}} * \\frac{\\partial n e t_{h 1}}{\\partial w_{1}} \\\n\\frac{\\partial E_{ {total }}}{\\partial w_{1}}=\\left(\\sum_{o} \\delta_{o} * w_{h o}\\right) * { out }_{h 1}\\left(1- { out }_{h 1}\\right) * i_{1} \\\n\\frac{\\partial E_{ {total }}}{\\partial w_{1}}=\\delta_{h 1} i_{1} \\end{array} $$ æœ€åï¼Œæ›´æ–°w1çš„æƒå€¼ï¼š $$ w_{1}^{+}=w_{1}-\\eta * \\frac{\\partial E_{\\text {total }}}{\\partial w_{1}}=0.15-0.5 * 0.000438568=0.149780716 $$ åŒç†ï¼Œé¢å¯æ›´æ–°w2,w3,w4çš„æƒå€¼ï¼š $$ \\begin{array}{l} w_{2}^{+}=0.19956143 \\\nw_{3}^{+}=0.24975114 \\\nw_{4}^{+}=0.29950229 \\end{array} $$ è¿™æ ·è¯¯å·®åå‘ä¼ æ’­æ³•å°±å®Œæˆäº†ï¼Œæœ€åæˆ‘ä»¬å†æŠŠæ›´æ–°çš„æƒå€¼é‡æ–°è®¡ç®—ï¼Œä¸åœåœ°è¿­ä»£ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ç¬¬ä¸€æ¬¡è¿­ä»£ä¹‹åï¼Œæ€»è¯¯å·®E(total)ç”±0.298371109ä¸‹é™è‡³0.291027924ã€‚è¿­ä»£10000æ¬¡åï¼Œæ€»è¯¯å·®ä¸º0.000035085ï¼Œè¾“å‡ºä¸º0.015912196,0.984065734\r,è¯æ˜æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚\n#coding:utf-8 import random import math # # å‚æ•°è§£é‡Šï¼š # \u0026#34;pd_\u0026#34; ï¼šåå¯¼çš„å‰ç¼€ # \u0026#34;d_\u0026#34; ï¼šå¯¼æ•°çš„å‰ç¼€ # \u0026#34;w_ho\u0026#34; ï¼šéšå«å±‚åˆ°è¾“å‡ºå±‚çš„æƒé‡ç³»æ•°ç´¢å¼• # \u0026#34;w_ih\u0026#34; ï¼šè¾“å…¥å±‚åˆ°éšå«å±‚çš„æƒé‡ç³»æ•°çš„ç´¢å¼• class NeuralNetwork: LEARNING_RATE = 0.5 def __init__(self, num_inputs, num_hidden, num_outputs, hidden_layer_weights = None, hidden_layer_bias = None, output_layer_weights = None, output_layer_bias = None): self.num_inputs = num_inputs self.hidden_layer = NeuronLayer(num_hidden, hidden_layer_bias) self.output_layer = NeuronLayer(num_outputs, output_layer_bias) self.init_weights_from_inputs_to_hidden_layer_neurons(hidden_layer_weights) self.init_weights_from_hidden_layer_neurons_to_output_layer_neurons(output_layer_weights) def init_weights_from_inputs_to_hidden_layer_neurons(self, hidden_layer_weights): weight_num = 0 for h in range(len(self.hidden_layer.neurons)): for i in range(self.num_inputs): if not hidden_layer_weights: self.hidden_layer.neurons[h].weights.append(random.random()) else: self.hidden_layer.neurons[h].weights.append(hidden_layer_weights[weight_num]) weight_num += 1 def init_weights_from_hidden_layer_neurons_to_output_layer_neurons(self, output_layer_weights): weight_num = 0 for o in range(len(self.output_layer.neurons)): for h in range(len(self.hidden_layer.neurons)): if not output_layer_weights: self.output_layer.neurons[o].weights.append(random.random()) else: self.output_layer.neurons[o].weights.append(output_layer_weights[weight_num]) weight_num += 1 def inspect(self): print(\u0026#39;------\u0026#39;) print(\u0026#39;* Inputs: {}\u0026#39;.format(self.num_inputs)) print(\u0026#39;------\u0026#39;) print(\u0026#39;Hidden Layer\u0026#39;) self.hidden_layer.inspect() print(\u0026#39;------\u0026#39;) print(\u0026#39;* Output Layer\u0026#39;) self.output_layer.inspect() print(\u0026#39;------\u0026#39;) def feed_forward(self, inputs): hidden_layer_outputs = self.hidden_layer.feed_forward(inputs) return self.output_layer.feed_forward(hidden_layer_outputs) def train(self, training_inputs, training_outputs): self.feed_forward(training_inputs) # 1. è¾“å‡ºç¥ç»å…ƒçš„å€¼ pd_errors_wrt_output_neuron_total_net_input = [0] * len(self.output_layer.neurons) for o in range(len(self.output_layer.neurons)): # âˆ‚E/âˆ‚zâ±¼ pd_errors_wrt_output_neuron_total_net_input[o] = self.output_layer.neurons[o].calculate_pd_error_wrt_total_net_input(training_outputs[o]) # 2. éšå«å±‚ç¥ç»å…ƒçš„å€¼ pd_errors_wrt_hidden_neuron_total_net_input = [0] * len(self.hidden_layer.neurons) for h in range(len(self.hidden_layer.neurons)): # dE/dyâ±¼ = Î£ âˆ‚E/âˆ‚zâ±¼ * âˆ‚z/âˆ‚yâ±¼ = Î£ âˆ‚E/âˆ‚zâ±¼ * wáµ¢â±¼ d_error_wrt_hidden_neuron_output = 0 for o in range(len(self.output_layer.neurons)): d_error_wrt_hidden_neuron_output += pd_errors_wrt_output_neuron_total_net_input[o] * self.output_layer.neurons[o].weights[h] # âˆ‚E/âˆ‚zâ±¼ = dE/dyâ±¼ * âˆ‚zâ±¼/âˆ‚ pd_errors_wrt_hidden_neuron_total_net_input[h] = d_error_wrt_hidden_neuron_output * self.hidden_layer.neurons[h].calculate_pd_total_net_input_wrt_input() # 3. æ›´æ–°è¾“å‡ºå±‚æƒé‡ç³»æ•° for o in range(len(self.output_layer.neurons)): for w_ho in range(len(self.output_layer.neurons[o].weights)): # âˆ‚Eâ±¼/âˆ‚wáµ¢â±¼ = âˆ‚E/âˆ‚zâ±¼ * âˆ‚zâ±¼/âˆ‚wáµ¢â±¼ pd_error_wrt_weight = pd_errors_wrt_output_neuron_total_net_input[o] * self.output_layer.neurons[o].calculate_pd_total_net_input_wrt_weight(w_ho) # Î”w = Î± * âˆ‚Eâ±¼/âˆ‚wáµ¢ self.output_layer.neurons[o].weights[w_ho] -= self.LEARNING_RATE * pd_error_wrt_weight # 4. æ›´æ–°éšå«å±‚çš„æƒé‡ç³»æ•° for h in range(len(self.hidden_layer.neurons)): for w_ih in range(len(self.hidden_layer.neurons[h].weights)): # âˆ‚Eâ±¼/âˆ‚wáµ¢ = âˆ‚E/âˆ‚zâ±¼ * âˆ‚zâ±¼/âˆ‚wáµ¢ pd_error_wrt_weight = pd_errors_wrt_hidden_neuron_total_net_input[h] * self.hidden_layer.neurons[h].calculate_pd_total_net_input_wrt_weight(w_ih) # Î”w = Î± * âˆ‚Eâ±¼/âˆ‚wáµ¢ self.hidden_layer.neurons[h].weights[w_ih] -= self.LEARNING_RATE * pd_error_wrt_weight def calculate_total_error(self, training_sets): total_error = 0 for t in range(len(training_sets)): training_inputs, training_outputs = training_sets[t] self.feed_forward(training_inputs) for o in range(len(training_outputs)): total_error += self.output_layer.neurons[o].calculate_error(training_outputs[o]) return total_error class NeuronLayer: def __init__(self, num_neurons, bias): # åŒä¸€å±‚çš„ç¥ç»å…ƒå…±äº«ä¸€ä¸ªæˆªè·é¡¹b self.bias = bias if bias else random.random() self.neurons = [] for i in range(num_neurons): self.neurons.append(Neuron(self.bias)) def inspect(self): print(\u0026#39;Neurons:\u0026#39;, len(self.neurons)) for n in range(len(self.neurons)): print(\u0026#39; Neuron\u0026#39;, n) for w in range(len(self.neurons[n].weights)): print(\u0026#39; Weight:\u0026#39;, self.neurons[n].weights[w]) print(\u0026#39; Bias:\u0026#39;, self.bias) def feed_forward(self, inputs): outputs = [] for neuron in self.neurons: outputs.append(neuron.calculate_output(inputs)) return outputs def get_outputs(self): outputs = [] for neuron in self.neurons: outputs.append(neuron.output) return outputs class Neuron: def __init__(self, bias): self.bias = bias self.weights = [] def calculate_output(self, inputs): self.inputs = inputs self.output = self.squash(self.calculate_total_net_input()) return self.output def calculate_total_net_input(self): total = 0 for i in range(len(self.inputs)): total += self.inputs[i] * self.weights[i] return total + self.bias # æ¿€æ´»å‡½æ•°sigmoid def squash(self, total_net_input): return 1 / (1 + math.exp(-total_net_input)) def calculate_pd_error_wrt_total_net_input(self, target_output): return self.calculate_pd_error_wrt_output(target_output) * self.calculate_pd_total_net_input_wrt_input(); # æ¯ä¸€ä¸ªç¥ç»å…ƒçš„è¯¯å·®æ˜¯ç”±å¹³æ–¹å·®å…¬å¼è®¡ç®—çš„ def calculate_error(self, target_output): return 0.5 * (target_output - self.output) ** 2 def calculate_pd_error_wrt_output(self, target_output): return -(target_output - self.output) def calculate_pd_total_net_input_wrt_input(self): return self.output * (1 - self.output) def calculate_pd_total_net_input_wrt_weight(self, index): return self.inputs[index] # æ–‡ä¸­çš„ä¾‹å­: nn = NeuralNetwork(2, 2, 2, hidden_layer_weights=[0.15, 0.2, 0.25, 0.3], hidden_layer_bias=0.35, output_layer_weights=[0.4, 0.45, 0.5, 0.55], output_layer_bias=0.6) for i in range(10000): nn.train([0.05, 0.1], [0.01, 0.09]) print(i, round(nn.calculate_total_error([[[0.05, 0.1], [0.01, 0.09]]]), 9)) #å¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œå¯ä»¥æŠŠä¸Šé¢çš„ä¾‹å­æ³¨é‡Šæ‰å†è¿è¡Œä¸€ä¸‹: # training_sets = [ # [[0, 0], [0]], # [[0, 1], [1]], # [[1, 0], [1]], # [[1, 1], [0]] # ] # nn = NeuralNetwork(len(training_sets[0][0]), 5, len(training_sets[0][1])) # for i in range(10000): # training_inputs, training_outputs = random.choice(training_sets) # nn.train(training_inputs, training_outputs) # print(i, nn.calculate_total_error(training_sets)) æœ€åå†™åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œç°åœ¨è¿˜ä¸ä¼šç”¨latexç¼–è¾‘æ•°å­¦å…¬å¼ï¼Œæœ¬æ¥éƒ½ç›´æ¥æƒ³å†™åœ¨è‰ç¨¿çº¸ä¸Šç„¶åæ‰«æäº†ä¼ ä¸Šæ¥ï¼Œä½†æ˜¯è§‰å¾—å¤ªå½±å“é˜…è¯»ä½“éªŒäº†ã€‚ä»¥åä¼šç”¨å…¬å¼ç¼–è¾‘å™¨åå†é‡æŠŠå…¬å¼é‡æ–°ç¼–è¾‘ä¸€éã€‚ç¨³é‡ä½¿ç”¨çš„æ˜¯sigmoidæ¿€æ´»å‡½æ•°ï¼Œå®é™…è¿˜æœ‰å‡ ç§ä¸åŒçš„æ¿€æ´»å‡½æ•°å¯ä»¥é€‰æ‹©ï¼Œå…·ä½“çš„å¯ä»¥å‚è€ƒæ–‡çŒ®[3]ï¼Œæœ€åæ¨èä¸€ä¸ªåœ¨çº¿æ¼”ç¤ºç¥ç»ç½‘ç»œå˜åŒ–çš„ç½‘å€ï¼šhttp://www.emergentmind.com/neural-networkï¼Œå¯ä»¥è‡ªå·±å¡«è¾“å…¥è¾“å‡ºï¼Œç„¶åè§‚çœ‹æ¯ä¸€æ¬¡è¿­ä»£æƒå€¼çš„å˜åŒ–ï¼Œå¾ˆå¥½ç©~å¦‚æœæœ‰é”™è¯¯çš„æˆ–è€…ä¸æ‡‚çš„æ¬¢è¿ç•™è¨€ï¼šï¼‰\nåŸæ–‡ï¼š\nhttps://www.cnblogs.com/charlotte77/p/5629865.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%ADbp/","series":["Manual"],"tags":["CNN","AI"],"title":"åå‘ä¼ æ’­â€”BP"},{"categories":["äº‘åŸç”Ÿ"],"content":"åŒæ­¥é•œåƒåˆ°è‡ªå·±çš„ä»“åº“ ç»å¸¸æœ‰ä¸€äº›å›½å¤–çš„é•œåƒä»“åº“ï¼Œåœ¨å›½å†…æ— æ³•æ‹‰å–ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å…ˆæ‰¾å°å›½å¤–çš„æœåŠ¡å™¨æ‹‰å–ä¸‹æ¥ï¼Œé‡æ–°æ‰“tagåæ¨é€åˆ°è‡ªå·±çš„é•œåƒä»“åº“ã€‚\n1âƒ£ï¸ å…è´¹æœåŠ¡å™¨\nhttps://labs.play-with-k8s.com/\r2âƒ£ï¸ æ‹‰å–-æ‰“tag-æ¨é€\n3âƒ£ï¸ éªŒè¯\nå‚è€ƒé“¾æ¥ğŸ”— å¦‚ä½•æ‹‰å–k8s.grc.ioã€quay.ioçš„é•œåƒ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/%E5%90%8C%E6%AD%A5%E9%95%9C%E5%83%8F%E5%88%B0%E8%87%AA%E5%B7%B1%E7%9A%84%E4%BB%93%E5%BA%93/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"åŒæ­¥é•œåƒåˆ°è‡ªå·±çš„ä»“åº“"},{"categories":["äº‘åŸç”Ÿ"],"content":"åœ¨namespaceä¹‹é—´å…±äº«secret\næœ‰çš„æ—¶å€™åœ¨defaultç©ºé—´ä¸‹åˆ›å»ºäº†æ‹‰å–é•œåƒçš„secretï¼Œå½“éƒ¨ç½²k8sçš„èµ„æºåˆ°å…¶ä»–namespaceçš„æ—¶å€™ï¼Œå¦‚æœéƒ¨ç½²çš„çš„æ˜¯deploymentçš„ä¹‹ç±»çš„åŠ¿å¿…ä¼šè¦æ‹‰å–é•œåƒï¼Œè¿™ä¸ªæ—¶å€™å¿…ç„¶å¤±è´¥ï¼Œå› ä¸ºsecretåˆ›å»ºåœ¨defaultç©ºé—´ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†secretå¤åˆ¶ä¸€ä»½åˆ°éœ€è¦çš„namespaceä¸‹é¢ï¼š\nkubectl get secret coding-regcred --namespace=default -oyaml | grep -v \u0026#39;^\\s*namespace:\\s\u0026#39; | kubectl apply --namespace=tkb -f - å‚è€ƒé“¾æ¥ï¼šKubernetes - sharing secret across namespaces\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/%E5%9C%A8namespace%E4%B9%8B%E9%97%B4%E5%85%B1%E4%BA%ABsecret/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"åœ¨namespaceä¹‹é—´å…±äº«secret"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"åœ¨å·¥ä½œä¸­ï¼Œæˆ‘ä»¬æœ‰æ—¶å€™éœ€è¦å°†ä¸€äº›å…¬å…±çš„åŠŸèƒ½å°è£…ï¼Œæ¯”å¦‚æ“ä½œæ—¥å¿—çš„å­˜å‚¨ï¼Œé˜²é‡å¤æäº¤ç­‰ç­‰ã€‚è¿™äº›åŠŸèƒ½æœ‰äº›æ¥å£ä¼šç”¨åˆ°ï¼Œä¸ºäº†ä¾¿äºå…¶ä»–æ¥å£å’Œæ–¹æ³•çš„ä½¿ç”¨ï¼Œåšæˆè‡ªå®šä¹‰æ³¨è§£ï¼Œä¾µå…¥æ€§æ›´ä½ä¸€ç‚¹ã€‚åˆ«äººç”¨çš„è¯ç›´æ¥æ³¨è§£å°±å¥½ã€‚ä¸‹é¢å°±æ¥è®²è®²è‡ªå®šä¹‰æ³¨è§£è¿™äº›äº‹æƒ…ã€‚\n1. @Targetã€@Retentionã€@Documentedç®€ä»‹ javaè‡ªå®šä¹‰æ³¨è§£çš„æ³¨è§£ä½äºåŒ…ï¼šjava.lang.annotationä¸‹ã€‚åŒ…å«ä¸‰ä¸ªå…ƒæ³¨è§£@Targetã€@Retentionã€@Documentedï¼Œå³æ³¨è§£çš„æ³¨è§£ã€‚\n@Target @Target:æ³¨è§£çš„ä½œç”¨ç›®æ ‡ã€‚å’Œæšä¸¾ElementTypeå…±åŒèµ·ä½œç”¨\næ ¹æ®æºç çŸ¥é“ï¼Œå¯ä»¥é…ç½®å¤šä¸ªä½œç”¨ç›®æ ‡ã€‚\n@Documented @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.ANNOTATION_TYPE) public @interface Target { /** * Returns an array of the kinds of elements an annotation type * can be applied to. * @return an array of the kinds of elements an annotation type * can be applied to */ ElementType[] value(); } å¤åˆ¶ä»£ç  ElementTypeçš„ç±»å‹å¦‚ä¸‹ï¼š\n* @author Joshua Bloch * @since 1.5 * @jls 9.6.4.1 @Target * @jls 4.1 The Kinds of Types and Values */ public enum ElementType { /** ç±», æ¥å£ (åŒ…æ‹¬æ³¨è§£ç±»å‹), æˆ– æšä¸¾ å£°æ˜ */ TYPE, /** å­—æ®µå£°æ˜ï¼ˆåŒ…æ‹¬æšä¸¾å¸¸é‡ï¼‰ */ FIELD, /** æ–¹æ³•å£°æ˜(Method declaration) */ METHOD, /** æ­£å¼çš„å‚æ•°å£°æ˜ */ PARAMETER, /** æ„é€ å‡½æ•°å£°æ˜ */ CONSTRUCTOR, /** å±€éƒ¨å˜é‡å£°æ˜ */ LOCAL_VARIABLE, /** æ³¨è§£ç±»å‹å£°æ˜ */ ANNOTATION_TYPE, /** åŒ…å£°æ˜ */ PACKAGE, /** * ç±»å‹å‚æ•°å£°æ˜ * * @since 1.8 */ TYPE_PARAMETER, /** * ä½¿ç”¨çš„ç±»å‹ * * @since 1.8 */ TYPE_USE } å¤åˆ¶ä»£ç  @Retention æŒ‡ç¤ºå¸¦æ³¨è§£ç±»å‹çš„æ³¨è§£è¦å¤šé•¿æ—¶é—´è¢«ä¿ç•™ã€‚å¦‚æœæ²¡æœ‰ä¿ç•™æ³¨é‡Šå­˜åœ¨ æ³¨é‡Šç±»å‹å£°æ˜ï¼Œä¿ç•™ç­–ç•¥é»˜è®¤ä¸º {@code RetentionPolicy.CLASS}å’ŒRetentionPolicyå…±åŒèµ·ä½œç”¨ã€‚\nRetentionPolicyç±»å‹å¦‚ä¸‹ï¼š\npackage java.lang.annotation; /** * Annotation retention policy. The constants of this enumerated type * describe the various policies for retaining annotations. They are used * in conjunction with the {@link Retention} meta-annotation type to specify * how long annotations are to be retained. * * @author Joshua Bloch * @since 1.5 */ public enum RetentionPolicy { /** * æ³¨è§£åªä¿ç•™åœ¨æºæ–‡ä»¶ï¼Œå½“Javaæ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶çš„æ—¶å€™ï¼Œæ³¨è§£è¢«é—å¼ƒï¼›è¢«ç¼–è¯‘å™¨å¿½ç•¥ */ SOURCE, /** * æ³¨è§£è¢«ä¿ç•™åˆ°classæ–‡ä»¶ï¼Œä½†jvmåŠ è½½classæ–‡ä»¶æ—¶å€™è¢«é—å¼ƒï¼Œè¿™æ˜¯é»˜è®¤çš„ç”Ÿå‘½å‘¨æœŸ */ CLASS, /** * æ³¨è§£ä¸ä»…è¢«ä¿å­˜åˆ°classæ–‡ä»¶ä¸­ï¼ŒjvmåŠ è½½classæ–‡ä»¶ä¹‹åï¼Œä»ç„¶å­˜åœ¨ */ RUNTIME } å¤åˆ¶ä»£ç  è¿™3ä¸ªç”Ÿå‘½å‘¨æœŸåˆ†åˆ«å¯¹åº”äºï¼šJavaæºæ–‡ä»¶(.javaæ–‡ä»¶) \u0026mdash;\u0026gt; .classæ–‡ä»¶ \u0026mdash;\u0026gt; å†…å­˜ä¸­çš„å­—èŠ‚ç ã€‚\n é‚£æ€ä¹ˆæ¥é€‰æ‹©åˆé€‚çš„æ³¨è§£ç”Ÿå‘½å‘¨æœŸå‘¢ï¼Ÿ\né¦–å…ˆè¦æ˜ç¡®ç”Ÿå‘½å‘¨æœŸé•¿åº¦ SOURCE \u0026lt; CLASS \u0026lt; RUNTIME ï¼Œæ‰€ä»¥å‰è€…èƒ½ä½œç”¨çš„åœ°æ–¹åè€…ä¸€å®šä¹Ÿèƒ½ä½œç”¨ã€‚ä¸€èˆ¬å¦‚æœéœ€è¦åœ¨è¿è¡Œæ—¶å»åŠ¨æ€è·å–æ³¨è§£ä¿¡æ¯ï¼Œé‚£åªèƒ½ç”¨ RUNTIME æ³¨è§£ï¼›å¦‚æœè¦åœ¨ç¼–è¯‘æ—¶è¿›è¡Œä¸€äº›é¢„å¤„ç†æ“ä½œï¼Œæ¯”å¦‚ç”Ÿæˆä¸€äº›è¾…åŠ©ä»£ç ï¼ˆå¦‚ ButterKnife\rï¼‰ï¼Œå°±ç”¨ CLASSæ³¨è§£ï¼›å¦‚æœåªæ˜¯åšä¸€äº›æ£€æŸ¥æ€§çš„æ“ä½œï¼Œæ¯”å¦‚ @Override å’Œ @SuppressWarningsï¼Œåˆ™å¯é€‰ç”¨ SOURCE æ³¨è§£ã€‚\n **@**Documented **@**Documented æ³¨è§£è¡¨æ˜è¿™ä¸ªæ³¨è§£åº”è¯¥è¢« javadocå·¥å…·è®°å½•. é»˜è®¤æƒ…å†µä¸‹,javadocæ˜¯ä¸åŒ…æ‹¬æ³¨è§£çš„. ä½†å¦‚æœå£°æ˜æ³¨è§£æ—¶æŒ‡å®šäº† @Documented,åˆ™å®ƒä¼šè¢« javadoc ä¹‹ç±»çš„å·¥å…·å¤„ç†, æ‰€ä»¥æ³¨è§£ç±»å‹ä¿¡æ¯ä¹Ÿä¼šè¢«åŒ…æ‹¬åœ¨ç”Ÿæˆçš„æ–‡æ¡£ä¸­ï¼Œæ˜¯ä¸€ä¸ªæ ‡è®°æ³¨è§£ï¼Œæ²¡æœ‰æˆå‘˜ã€‚\n2. å®æˆ˜ Logæ³¨è§£\n@Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) public @interface Log { String value() default \u0026#34;\u0026#34;; } Aspect\n@Aspect @Component @Slf4j public class SysLogAspect { @Pointcut(\u0026#34;@annotation(com.tony.annotation.aspect.Log)\u0026#34;) public void logPointCut() { } @Around(\u0026#34;logPointCut()\u0026#34;) public Object around(ProceedingJoinPoint point) throws Throwable { long beginTime = System.currentTimeMillis(); Object result = point.proceed(); long time = System.currentTimeMillis() - beginTime; // ç›®æ ‡æ–¹æ³•  MethodSignature signature = (MethodSignature) point.getSignature(); Method method = signature.getMethod(); Log syslog = method.getAnnotation(Log.class); if (syslog != null) { // æ³¨è§£ä¸Šçš„æè¿°  log.info(syslog.value() + \u0026#34; :\u0026#34; + time); } return result; } } ä½¿ç”¨\n@Service public class HelloLog { @Log(\u0026#34;æµ‹è¯•è‡ªå®šä¹‰æ³¨è§£\u0026#34;) public void sayHello() { System.out.println(\u0026#34;hello, log\u0026#34; ); } } æµ‹è¯•\n@RunWith(SpringRunner.class) @SpringBootTest class AnnotationApplicationTests { @Autowired HelloLog helloLog; @Test public void HelloLogTest(){ helloLog.sayHello(); } } å‚è€ƒ åˆ†åˆ†é’Ÿç©è½¬SpringBootè‡ªå®šä¹‰æ³¨è§£\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/%E5%9F%BA%E4%BA%8Easpect%E5%AE%9E%E7%8E%B0%E6%B3%A8%E8%A7%A3/","series":["Manual"],"tags":["Spring"],"title":"åŸºäºaspectå®ç°æ³¨è§£"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‰è¨€ æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°åˆ°åº•æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Œå…¶ä¸­å‚è€ƒäº†è®¸å¤šå¤§ä½¬å†™çš„æ–‡ç« ï¼Œç®—æ˜¯å¯¹åˆ†å¸ƒå¼é”åšä¸€ä¸ªæ€»ç»“\nåˆ†å¸ƒå¼é”æ¦‚è§ˆ åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œä¸ºäº†ä¿è¯ä¸€ä¸ªä»£ç å—åœ¨åŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼ŒJavaä¸­æˆ‘ä»¬ä¸€èˆ¬å¯ä»¥ä½¿ç”¨synchronizedè¯­æ³•å’ŒReetrantLockå»ä¿è¯ï¼Œè¿™å®é™…ä¸Šæ˜¯æœ¬åœ°é”çš„æ–¹å¼ã€‚ä½†æ˜¯ç°åœ¨å…¬å¸éƒ½æ˜¯æµè¡Œåˆ†å¸ƒå¼æ¶æ„ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå¦‚ä½•ä¿è¯ä¸åŒèŠ‚ç‚¹çš„çº¿ç¨‹åŒæ­¥æ‰§è¡Œå‘¢ï¼Ÿ\nå®é™…ä¸Šï¼Œå¯¹äºåˆ†å¸ƒå¼åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œå®ƒæ˜¯æ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´äº’æ–¥è®¿é—®å…±äº«èµ„æºçš„ä¸€ç§æ–¹å¼ã€‚\næ¯”å¦‚è¯´åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šå°æœºå™¨ä¸Šéƒ¨ç½²äº†å¤šä¸ªæœåŠ¡ï¼Œå½“å®¢æˆ·ç«¯ä¸€ä¸ªç”¨æˆ·å‘èµ·ä¸€ä¸ªæ•°æ®æ’å…¥è¯·æ±‚æ—¶ï¼Œå¦‚æœæ²¡æœ‰åˆ†å¸ƒå¼é”æœºåˆ¶ä¿è¯ï¼Œé‚£ä¹ˆé‚£å¤šå°æœºå™¨ä¸Šçš„å¤šä¸ªæœåŠ¡å¯èƒ½è¿›è¡Œå¹¶å‘æ’å…¥æ“ä½œï¼Œå¯¼è‡´æ•°æ®é‡å¤æ’å…¥ï¼Œå¯¹äºæŸäº›ä¸å…è®¸æœ‰å¤šä½™æ•°æ®çš„ä¸šåŠ¡æ¥è¯´ï¼Œè¿™å°±ä¼šé€ æˆé—®é¢˜ã€‚è€Œåˆ†å¸ƒå¼é”æœºåˆ¶å°±æ˜¯ä¸ºäº†è§£å†³ç±»ä¼¼è¿™ç±»é—®é¢˜ï¼Œä¿è¯å¤šä¸ªæœåŠ¡ä¹‹é—´äº’æ–¥çš„è®¿é—®å…±äº«èµ„æºï¼Œå¦‚æœä¸€ä¸ªæœåŠ¡æŠ¢å äº†åˆ†å¸ƒå¼é”ï¼Œå…¶ä»–æœåŠ¡æ²¡è·å–åˆ°é”ï¼Œå°±ä¸è¿›è¡Œåç»­æ“ä½œã€‚å¤§è‡´æ„æ€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆä¸ä¸€å®šå‡†ç¡®ï¼‰ï¼š\nåˆ†å¸ƒå¼é”çš„ç‰¹ç‚¹ åˆ†å¸ƒå¼é”ä¸€èˆ¬æœ‰å¦‚ä¸‹çš„ç‰¹ç‚¹ï¼š\n äº’æ–¥æ€§ï¼š åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é” å¯é‡å…¥æ€§ï¼š åŒä¸€èŠ‚ç‚¹ä¸Šçš„åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœè·å–äº†é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–é” é”è¶…æ—¶ï¼šå’ŒJ.U.Cä¸­çš„é”ä¸€æ ·æ”¯æŒé”è¶…æ—¶ï¼Œé˜²æ­¢æ­»é” é«˜æ€§èƒ½å’Œé«˜å¯ç”¨ï¼š åŠ é”å’Œè§£é”éœ€è¦é«˜æ•ˆï¼ŒåŒæ—¶ä¹Ÿéœ€è¦ä¿è¯é«˜å¯ç”¨ï¼Œé˜²æ­¢åˆ†å¸ƒå¼é”å¤±æ•ˆ å…·å¤‡é˜»å¡å’Œéé˜»å¡æ€§ï¼šèƒ½å¤ŸåŠæ—¶ä»é˜»å¡çŠ¶æ€ä¸­è¢«å”¤é†’  åˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼ æˆ‘ä»¬ä¸€èˆ¬å®ç°åˆ†å¸ƒå¼é”æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š\n åŸºäºæ•°æ®åº“ åŸºäºRedis åŸºäºzookeeper  æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»åŸºäºRediså¦‚ä½•å®ç°åˆ†å¸ƒå¼é”\nRedisçš„åˆ†å¸ƒå¼é”å®ç° 1. åˆ©ç”¨setnx+expireå‘½ä»¤ (é”™è¯¯çš„åšæ³•) Redisçš„SETNXå‘½ä»¤ï¼Œsetnx key valueï¼Œå°†keyè®¾ç½®ä¸ºvalueï¼Œå½“é”®ä¸å­˜åœ¨æ—¶ï¼Œæ‰èƒ½æˆåŠŸï¼Œè‹¥é”®å­˜åœ¨ï¼Œä»€ä¹ˆä¹Ÿä¸åšï¼ŒæˆåŠŸè¿”å›1ï¼Œå¤±è´¥è¿”å›0 ã€‚ SETNXå®é™…ä¸Šå°±æ˜¯SET IF NOT Existsçš„ç¼©å†™\nå› ä¸ºåˆ†å¸ƒå¼é”è¿˜éœ€è¦è¶…æ—¶æœºåˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨expireå‘½ä»¤æ¥è®¾ç½®ï¼Œæ‰€ä»¥åˆ©ç”¨setnx+expireå‘½ä»¤çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\npublic boolean tryLock(String key,String requset,int timeout) {\rLong result = jedis.setnx(key, requset);\r// result = 1æ—¶ï¼Œè®¾ç½®æˆåŠŸï¼Œå¦åˆ™è®¾ç½®å¤±è´¥\rif (result == 1L) {\rreturn jedis.expire(key, timeout) == 1L;\r} else {\rreturn false;\r}\r}\rå¤åˆ¶ä»£ç \rå®é™…ä¸Šä¸Šé¢çš„æ­¥éª¤æ˜¯æœ‰é—®é¢˜çš„ï¼Œsetnxå’Œexpireæ˜¯åˆ†å¼€çš„ä¸¤æ­¥æ“ä½œï¼Œä¸å…·æœ‰åŸå­æ€§ï¼Œå¦‚æœæ‰§è¡Œå®Œç¬¬ä¸€æ¡æŒ‡ä»¤åº”ç”¨å¼‚å¸¸æˆ–è€…é‡å¯äº†ï¼Œé”å°†æ— æ³•è¿‡æœŸã€‚\nä¸€ç§æ”¹å–„æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨Luaè„šæœ¬æ¥ä¿è¯åŸå­æ€§ï¼ˆåŒ…å«setnxå’Œexpireä¸¤æ¡æŒ‡ä»¤ï¼‰\n2. ä½¿ç”¨Luaè„šæœ¬ï¼ˆåŒ…å«setnxå’Œexpireä¸¤æ¡æŒ‡ä»¤ï¼‰ ä»£ç å¦‚ä¸‹\npublic boolean tryLock_with_lua(String key, String UniqueId, int seconds) { String lua_scripts = \u0026#34;if redis.call(\u0026#39;setnx\u0026#39;,KEYS[1],ARGV[1]) == 1 then\u0026#34; + \u0026#34;redis.call(\u0026#39;expire\u0026#39;,KEYS[1],ARGV[2]) return 1 else return 0 end\u0026#34;; List\u0026lt;String\u0026gt; keys = new ArrayList\u0026lt;\u0026gt;(); List\u0026lt;String\u0026gt; values = new ArrayList\u0026lt;\u0026gt;(); keys.add(key); values.add(UniqueId); values.add(String.valueOf(seconds)); Object result = jedis.eval(lua_scripts, keys, values); //åˆ¤æ–­æ˜¯å¦æˆåŠŸ  return result.equals(1L); } 3. ä½¿ç”¨ set key value [EX seconds][PX milliseconds][NX|XX] å‘½ä»¤ (æ­£ç¡®åšæ³•) Redisåœ¨ 2.6.12 ç‰ˆæœ¬å¼€å§‹ï¼Œä¸º SET å‘½ä»¤å¢åŠ ä¸€ç³»åˆ—é€‰é¡¹ï¼š\nSET key value[EX seconds][PX milliseconds][NX|XX]  EX seconds: è®¾å®šè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ PX milliseconds: è®¾å®šè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ NX: ä»…å½“keyä¸å­˜åœ¨æ—¶è®¾ç½®å€¼ XX: ä»…å½“keyå­˜åœ¨æ—¶è®¾ç½®å€¼  setå‘½ä»¤çš„nxé€‰é¡¹ï¼Œå°±ç­‰åŒäºsetnxå‘½ä»¤ï¼Œä»£ç è¿‡ç¨‹å¦‚ä¸‹ï¼š\npublic boolean tryLock_with_set(String key, String UniqueId, int seconds) { return \u0026#34;OK\u0026#34;.equals(jedis.set(key, UniqueId, \u0026#34;NX\u0026#34;, \u0026#34;EX\u0026#34;, seconds)); } valueå¿…é¡»è¦å…·æœ‰å”¯ä¸€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨UUIDæ¥åšï¼Œè®¾ç½®éšæœºå­—ç¬¦ä¸²ä¿è¯å”¯ä¸€æ€§ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦ä¿è¯å”¯ä¸€æ€§ï¼Ÿå‡å¦‚valueä¸æ˜¯éšæœºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œé‚£ä¹ˆå°±å¯èƒ½å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š\n 1.å®¢æˆ·ç«¯1è·å–é”æˆåŠŸ 2.å®¢æˆ·ç«¯1åœ¨æŸä¸ªæ“ä½œä¸Šé˜»å¡äº†å¤ªé•¿æ—¶é—´ 3.è®¾ç½®çš„keyè¿‡æœŸäº†ï¼Œé”è‡ªåŠ¨é‡Šæ”¾äº† 4.å®¢æˆ·ç«¯2è·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é” 5.å®¢æˆ·ç«¯1ä»é˜»å¡ä¸­æ¢å¤è¿‡æ¥ï¼Œå› ä¸ºvalueå€¼ä¸€æ ·ï¼Œæ‰€ä»¥æ‰§è¡Œé‡Šæ”¾é”æ“ä½œæ—¶å°±ä¼šé‡Šæ”¾æ‰å®¢æˆ·ç«¯2æŒæœ‰çš„é”ï¼Œè¿™æ ·å°±ä¼šé€ æˆé—®é¢˜  æ‰€ä»¥é€šå¸¸æ¥è¯´ï¼Œåœ¨é‡Šæ”¾é”æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹valueè¿›è¡ŒéªŒè¯\né‡Šæ”¾é”çš„å®ç° é‡Šæ”¾é”æ—¶éœ€è¦éªŒè¯valueå€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨è·å–é”çš„æ—¶å€™éœ€è¦è®¾ç½®ä¸€ä¸ªvalueï¼Œä¸èƒ½ç›´æ¥ç”¨del keyè¿™ç§ç²—æš´çš„æ–¹å¼ï¼Œå› ä¸ºç›´æ¥del keyä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥è¿›è¡Œè§£é”äº†ï¼Œæ‰€ä»¥è§£é”æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­é”æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼ŒåŸºäºvalueå€¼æ¥åˆ¤æ–­ï¼Œä»£ç å¦‚ä¸‹ï¼š\npublic boolean releaseLock_with_lua(String key,String value) { String luaScript = \u0026#34;if redis.call(\u0026#39;get\u0026#39;,KEYS[1]) == ARGV[1] then \u0026#34; + \u0026#34;return redis.call(\u0026#39;del\u0026#39;,KEYS[1]) else return 0 end\u0026#34;; return jedis.eval(luaScript, Collections.singletonList(key), Collections.singletonList(value)).equals(1L); } è¿™é‡Œä½¿ç”¨Luaè„šæœ¬çš„æ–¹å¼ï¼Œå°½é‡ä¿è¯åŸå­æ€§ã€‚\nä½¿ç”¨ set key value [EX seconds][PX milliseconds][NX|XX] å‘½ä»¤ çœ‹ä¸Šå»å¾ˆOKï¼Œå®é™…ä¸Šåœ¨Redisé›†ç¾¤çš„æ—¶å€™ä¹Ÿä¼šå‡ºç°é—®é¢˜ï¼Œæ¯”å¦‚è¯´Aå®¢æˆ·ç«¯åœ¨Redisçš„masterèŠ‚ç‚¹ä¸Šæ‹¿åˆ°äº†é”ï¼Œä½†æ˜¯è¿™ä¸ªåŠ é”çš„keyè¿˜æ²¡æœ‰åŒæ­¥åˆ°slaveèŠ‚ç‚¹ï¼Œmasteræ•…éšœï¼Œå‘ç”Ÿæ•…éšœè½¬ç§»ï¼Œä¸€ä¸ªslaveèŠ‚ç‚¹å‡çº§ä¸ºmasterèŠ‚ç‚¹ï¼ŒBå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥è·å–åŒä¸ªkeyçš„é”ï¼Œä½†å®¢æˆ·ç«¯Aä¹Ÿå·²ç»æ‹¿åˆ°é”äº†ï¼Œè¿™å°±å¯¼è‡´å¤šä¸ªå®¢æˆ·ç«¯éƒ½æ‹¿åˆ°é”ã€‚\næ‰€ä»¥é’ˆå¯¹Redisé›†ç¾¤è¿™ç§æƒ…å†µï¼Œè¿˜æœ‰å…¶ä»–æ–¹æ¡ˆ\n4. Redlockç®—æ³• ä¸ Redisson å®ç° Redisä½œè€… antirezåŸºäºåˆ†å¸ƒå¼ç¯å¢ƒä¸‹æå‡ºäº†ä¸€ç§æ›´é«˜çº§çš„åˆ†å¸ƒå¼é”çš„å®ç°Redlockï¼ŒåŸç†å¦‚ä¸‹ï¼š\n ä¸‹é¢å‚è€ƒæ–‡ç« Redlockï¼šRedisåˆ†å¸ƒå¼é”æœ€ç‰›é€¼çš„å®ç°\rå’Œ redis.io/topics/distâ€¦\r å‡è®¾æœ‰5ä¸ªç‹¬ç«‹çš„RedisèŠ‚ç‚¹ï¼ˆæ³¨æ„è¿™é‡Œçš„èŠ‚ç‚¹å¯ä»¥æ˜¯5ä¸ªRediså•masterå®ä¾‹ï¼Œä¹Ÿå¯ä»¥æ˜¯5ä¸ªRedis Clusteré›†ç¾¤ï¼Œä½†å¹¶ä¸æ˜¯æœ‰5ä¸ªä¸»èŠ‚ç‚¹çš„clusteré›†ç¾¤ï¼‰ï¼š\n è·å–å½“å‰Unixæ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ ä¾æ¬¡å°è¯•ä»5ä¸ªå®ä¾‹ï¼Œä½¿ç”¨ç›¸åŒçš„keyå’Œå…·æœ‰å”¯ä¸€æ€§çš„value(ä¾‹å¦‚UUID)è·å–é”ï¼Œå½“å‘Redisè¯·æ±‚è·å–é”æ—¶ï¼Œå®¢æˆ·ç«¯åº”è¯¥è®¾ç½®ä¸€ä¸ªç½‘ç»œè¿æ¥å’Œå“åº”è¶…æ—¶æ—¶é—´ï¼Œè¿™ä¸ªè¶…æ—¶æ—¶é—´åº”ç”¨å°äºé”çš„å¤±æ•ˆæ—¶é—´ï¼Œä¾‹å¦‚ä½ çš„é”è‡ªåŠ¨å¤±æ•ˆæ—¶é—´ä¸º10sï¼Œåˆ™è¶…æ—¶æ—¶é—´åº”è¯¥åœ¨5~50æ¯«ç§’ä¹‹é—´ï¼Œè¿™æ ·å¯ä»¥é¿å…æœåŠ¡å™¨ç«¯Rediså·²ç»æŒ‚æ‰çš„æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯è¿˜åœ¨æ­»æ­»åœ°ç­‰å¾…å“åº”ç»“æœã€‚å¦‚æœæœåŠ¡ç«¯æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”ï¼Œå®¢æˆ·ç«¯åº”è¯¥å°½å¿«å°è¯•å»å¦å¤–ä¸€ä¸ªRediså®ä¾‹è¯·æ±‚è·å–é” å®¢æˆ·ç«¯ä½¿ç”¨å½“å‰æ—¶é—´å‡å»å¼€å§‹è·å–é”æ—¶é—´ï¼ˆæ­¥éª¤1è®°å½•çš„æ—¶é—´ï¼‰å°±å¾—åˆ°è·å–é”ä½¿ç”¨çš„æ—¶é—´ï¼Œå½“ä¸”ä»…å½“ä»å¤§å¤šæ•°(N/2+1ï¼Œè¿™é‡Œæ˜¯3ä¸ªèŠ‚ç‚¹)çš„RedisèŠ‚ç‚¹éƒ½å–åˆ°é”ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ—¶é—´å°äºé”å¤±è´¥æ—¶é—´æ—¶ï¼Œé”æ‰ç®—è·å–æˆåŠŸã€‚ å¦‚æœå–åˆ°äº†é”ï¼Œkeyçš„çœŸæ­£æœ‰æ•ˆæ—¶é—´ç­‰äºæœ‰æ•ˆæ—¶é—´å‡å»è·å–é”æ‰€ä½¿ç”¨çš„æ—¶é—´ï¼ˆæ­¥éª¤3è®¡ç®—çš„ç»“æœï¼‰ å¦‚æœæŸäº›åŸå› ï¼Œè·å–é”å¤±è´¥ï¼ˆæ²¡æœ‰åœ¨è‡³å°‘N/2+1ä¸ªRediså®ä¾‹å–åˆ°é”æˆ–è€…å–é”æ—¶é—´å·²ç»è¶…è¿‡äº†æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œå®¢æˆ·ç«¯åº”è¯¥åœ¨æ‰€æœ‰çš„Rediså®ä¾‹ä¸Šè¿›è¡Œè§£é”ï¼ˆå³ä¾¿æŸäº›Rediså®ä¾‹æ ¹æœ¬å°±æ²¡æœ‰åŠ é”æˆåŠŸï¼Œé˜²æ­¢æŸäº›èŠ‚ç‚¹è·å–åˆ°é”ä½†æ˜¯å®¢æˆ·ç«¯æ²¡æœ‰å¾—åˆ°å“åº”è€Œå¯¼è‡´æ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ä¸èƒ½è¢«é‡æ–°è·å–é”ï¼‰  Redissonå®ç°ç®€å•åˆ†å¸ƒå¼é” å¯¹äºJavaç”¨æˆ·è€Œè¨€ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨Jedisï¼ŒJedisæ˜¯Redisçš„Javaå®¢æˆ·ç«¯ï¼Œé™¤äº†Jedisä¹‹å¤–ï¼ŒRedissonä¹Ÿæ˜¯Javaçš„å®¢æˆ·ç«¯ï¼ŒJedisæ˜¯é˜»å¡å¼I/Oï¼Œè€ŒRedissonåº•å±‚ä½¿ç”¨Nettyå¯ä»¥å®ç°éé˜»å¡I/Oï¼Œè¯¥å®¢æˆ·ç«¯å°è£…äº†é”çš„ï¼Œç»§æ‰¿äº†J.U.Cçš„Lockæ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨ReentrantLockä¸€æ ·ä½¿ç”¨Redissonï¼Œå…·ä½“ä½¿ç”¨è¿‡ç¨‹å¦‚ä¸‹ã€‚\n é¦–å…ˆåŠ å…¥POMä¾èµ–  \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.redisson\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;redisson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.10.6\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt;  ä½¿ç”¨Redissonï¼Œä»£ç å¦‚ä¸‹(ä¸ä½¿ç”¨ReentrantLockç±»ä¼¼ï¼‰  // 1. é…ç½®æ–‡ä»¶ Config config = new Config(); config.useSingleServer() .setAddress(\u0026#34;redis://127.0.0.1:6379\u0026#34;) .setPassword(RedisConfig.PASSWORD) .setDatabase(0); //2. æ„é€ RedissonClient RedissonClient redissonClient = Redisson.create(config); //3. è®¾ç½®é”å®šèµ„æºåç§° RLock lock = redissonClient.getLock(\u0026#34;redlock\u0026#34;); lock.lock(); try { System.out.println(\u0026#34;è·å–é”æˆåŠŸï¼Œå®ç°ä¸šåŠ¡é€»è¾‘\u0026#34;); Thread.sleep(10000); } catch (InterruptedException e) { e.printStackTrace(); } finally { lock.unlock(); } å…³äºRedlockç®—æ³•çš„å®ç°ï¼Œåœ¨Redissonä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨RedissonRedLockæ¥å®Œæˆï¼Œå…·ä½“ä½¿ç”¨ç»†èŠ‚å¯ä»¥å‚è€ƒå¤§ä½¬çš„æ–‡ç« ï¼š mp.weixin.qq.com/s/8uhYult2hâ€¦\rRediså®ç°çš„åˆ†å¸ƒå¼é”è½®å­ ä¸‹é¢åˆ©ç”¨SpringBoot + Jedis + AOPçš„ç»„åˆæ¥å®ç°ä¸€ä¸ªç®€æ˜“çš„åˆ†å¸ƒå¼é”ã€‚\n1. è‡ªå®šä¹‰æ³¨è§£ è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£ï¼Œè¢«æ³¨è§£çš„æ–¹æ³•ä¼šæ‰§è¡Œè·å–åˆ†å¸ƒå¼é”çš„é€»è¾‘\n@Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited public @interface RedisLock { /** * ä¸šåŠ¡é”® * * @return */ String key(); /** * é”çš„è¿‡æœŸç§’æ•°,é»˜è®¤æ˜¯5ç§’ * * @return */ int expire() default 5; /** * å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…æ—¶é—´ * * @return */ long waitTime() default Long.MIN_VALUE; /** * é”çš„è¶…æ—¶æ—¶é—´å•ä½ * * @return */ TimeUnit timeUnit() default TimeUnit.SECONDS; } 2. AOPæ‹¦æˆªå™¨å®ç° åœ¨AOPä¸­æˆ‘ä»¬å»æ‰§è¡Œè·å–åˆ†å¸ƒå¼é”å’Œé‡Šæ”¾åˆ†å¸ƒå¼é”çš„é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹ï¼š\n@Aspect @Component public class LockMethodAspect { @Autowired private RedisLockHelper redisLockHelper; @Autowired private JedisUtil jedisUtil; private Logger logger = LoggerFactory.getLogger(LockMethodAspect.class); @Around(\u0026#34;@annotation(com.redis.lock.annotation.RedisLock)\u0026#34;) public Object around(ProceedingJoinPoint joinPoint) { Jedis jedis = jedisUtil.getJedis(); MethodSignature signature = (MethodSignature) joinPoint.getSignature(); Method method = signature.getMethod(); RedisLock redisLock = method.getAnnotation(RedisLock.class); String value = UUID.randomUUID().toString(); String key = redisLock.key(); try { final boolean islock = redisLockHelper.lock(jedis,key, value, redisLock.expire(), redisLock.timeUnit()); logger.info(\u0026#34;isLock : {}\u0026#34;,islock); if (!islock) { logger.error(\u0026#34;è·å–é”å¤±è´¥\u0026#34;); throw new RuntimeException(\u0026#34;è·å–é”å¤±è´¥\u0026#34;); } try { return joinPoint.proceed(); } catch (Throwable throwable) { throw new RuntimeException(\u0026#34;ç³»ç»Ÿå¼‚å¸¸\u0026#34;); } } finally { logger.info(\u0026#34;é‡Šæ”¾é”\u0026#34;); redisLockHelper.unlock(jedis,key, value); jedis.close(); } } } 3. Rediså®ç°åˆ†å¸ƒå¼é”æ ¸å¿ƒç±» @Component public class RedisLockHelper { private long sleepTime = 100; /** * ç›´æ¥ä½¿ç”¨setnx + expireæ–¹å¼è·å–åˆ†å¸ƒå¼é” * éåŸå­æ€§ * * @param key * @param value * @param timeout * @return */ public boolean lock_setnx(Jedis jedis,String key, String value, int timeout) { Long result = jedis.setnx(key, value); // result = 1æ—¶ï¼Œè®¾ç½®æˆåŠŸï¼Œå¦åˆ™è®¾ç½®å¤±è´¥  if (result == 1L) { return jedis.expire(key, timeout) == 1L; } else { return false; } } /** * ä½¿ç”¨Luaè„šæœ¬ï¼Œè„šæœ¬ä¸­ä½¿ç”¨setnex+expireå‘½ä»¤è¿›è¡ŒåŠ é”æ“ä½œ * * @param jedis * @param key * @param UniqueId * @param seconds * @return */ public boolean Lock_with_lua(Jedis jedis,String key, String UniqueId, int seconds) { String lua_scripts = \u0026#34;if redis.call(\u0026#39;setnx\u0026#39;,KEYS[1],ARGV[1]) == 1 then\u0026#34; + \u0026#34;redis.call(\u0026#39;expire\u0026#39;,KEYS[1],ARGV[2]) return 1 else return 0 end\u0026#34;; List\u0026lt;String\u0026gt; keys = new ArrayList\u0026lt;\u0026gt;(); List\u0026lt;String\u0026gt; values = new ArrayList\u0026lt;\u0026gt;(); keys.add(key); values.add(UniqueId); values.add(String.valueOf(seconds)); Object result = jedis.eval(lua_scripts, keys, values); //åˆ¤æ–­æ˜¯å¦æˆåŠŸ  return result.equals(1L); } /** * åœ¨Redisçš„2.6.12åŠä»¥åä¸­,ä½¿ç”¨ set key value [NX] [EX] å‘½ä»¤ * * @param key * @param value * @param timeout * @return */ public boolean lock(Jedis jedis,String key, String value, int timeout, TimeUnit timeUnit) { long seconds = timeUnit.toSeconds(timeout); return \u0026#34;OK\u0026#34;.equals(jedis.set(key, value, \u0026#34;NX\u0026#34;, \u0026#34;EX\u0026#34;, seconds)); } /** * è‡ªå®šä¹‰è·å–é”çš„è¶…æ—¶æ—¶é—´ * * @param jedis * @param key * @param value * @param timeout * @param waitTime * @param timeUnit * @return * @throws InterruptedException */ public boolean lock_with_waitTime(Jedis jedis,String key, String value, int timeout, long waitTime,TimeUnit timeUnit) throws InterruptedException { long seconds = timeUnit.toSeconds(timeout); while (waitTime \u0026gt;= 0) { String result = jedis.set(key, value, \u0026#34;nx\u0026#34;, \u0026#34;ex\u0026#34;, seconds); if (\u0026#34;OK\u0026#34;.equals(result)) { return true; } waitTime -= sleepTime; Thread.sleep(sleepTime); } return false; } /** * é”™è¯¯çš„è§£é”æ–¹æ³•â€”ç›´æ¥åˆ é™¤key * * @param key */ public void unlock_with_del(Jedis jedis,String key) { jedis.del(key); } /** * ä½¿ç”¨Luaè„šæœ¬è¿›è¡Œè§£é”æ“çºµï¼Œè§£é”çš„æ—¶å€™éªŒè¯valueå€¼ * * @param jedis * @param key * @param value * @return */ public boolean unlock(Jedis jedis,String key,String value) { String luaScript = \u0026#34;if redis.call(\u0026#39;get\u0026#39;,KEYS[1]) == ARGV[1] then \u0026#34; + \u0026#34;return redis.call(\u0026#39;del\u0026#39;,KEYS[1]) else return 0 end\u0026#34;; return jedis.eval(luaScript, Collections.singletonList(key), Collections.singletonList(value)).equals(1L); } } 4. Controllerå±‚æ§åˆ¶ å®šä¹‰ä¸€ä¸ªTestControlleræ¥æµ‹è¯•æˆ‘ä»¬å®ç°çš„åˆ†å¸ƒå¼é”\n@RestController public class TestController { @RedisLock(key = \u0026#34;redis_lock\u0026#34;) @GetMapping(\u0026#34;/index\u0026#34;) public String index() { return \u0026#34;index\u0026#34;; } } å°ç»“ åˆ†å¸ƒå¼é”é‡ç‚¹åœ¨äºäº’æ–¥æ€§ï¼Œåœ¨ä»»æ„ä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è·å–äº†é”ã€‚åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåˆ†å¸ƒå¼é”çš„å®ç°å¯èƒ½ä¼šæ›´å¤æ‚ï¼Œè€Œæˆ‘è¿™é‡Œçš„è®²è¿°ä¸»è¦é’ˆå¯¹çš„æ˜¯å•æœºç¯å¢ƒä¸‹çš„åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°ï¼Œè‡³äºRedisé›†ç¾¤ç¯å¢ƒå¹¶æ²¡æœ‰è¿‡å¤šæ¶‰åŠï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥æŸ¥é˜…ç›¸å…³èµ„æ–™ã€‚\né¡¹ç›®æºç åœ°å€ï¼šgithub.com/pjmike/rediâ€¦\rå‚è€ƒ åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/redis/%E5%9F%BA%E4%BA%8Eredis%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/","series":["Manual"],"tags":["Redis"],"title":"åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ä½ ä»¬æœ‰æ²¡æœ‰åš MySQL è¯»å†™åˆ†ç¦»ï¼Ÿå¦‚ä½•å®ç° MySQL çš„è¯»å†™åˆ†ç¦»ï¼ŸMySQL ä¸»ä»å¤åˆ¶åŸç†çš„æ˜¯å•¥ï¼Ÿå¦‚ä½•è§£å†³ MySQL ä¸»ä»åŒæ­¥çš„å»¶æ—¶é—®é¢˜ï¼Ÿ\nå¦‚ä½•å®ç° MySQL çš„è¯»å†™åˆ†ç¦»ï¼Ÿ å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯åŸºäºä¸»ä»å¤åˆ¶æ¶æ„ï¼Œç®€å•æ¥è¯´ï¼Œå°±æä¸€ä¸ªä¸»åº“ï¼ŒæŒ‚å¤šä¸ªä»åº“ï¼Œç„¶åæˆ‘ä»¬å°±å•å•åªæ˜¯å†™ä¸»åº“ï¼Œç„¶åä¸»åº“ä¼šè‡ªåŠ¨æŠŠæ•°æ®ç»™åŒæ­¥åˆ°ä»åº“ä¸Šå»ã€‚\nMySQL ä¸»ä»å¤åˆ¶åŸç†çš„æ˜¯å•¥ï¼Ÿ ä¸»åº“å°†å˜æ›´å†™å…¥ binlog æ—¥å¿—ï¼Œç„¶åä»åº“è¿æ¥åˆ°ä¸»åº“ä¹‹åï¼Œä»åº“æœ‰ä¸€ä¸ª IO çº¿ç¨‹ï¼Œå°†ä¸»åº“çš„ binlog æ—¥å¿—æ‹·è´åˆ°è‡ªå·±æœ¬åœ°ï¼Œå†™å…¥ä¸€ä¸ª relay ä¸­ç»§æ—¥å¿—ä¸­ã€‚æ¥ç€ä»åº“ä¸­æœ‰ä¸€ä¸ª SQL çº¿ç¨‹ä¼šä»ä¸­ç»§æ—¥å¿—è¯»å– binlogï¼Œç„¶åæ‰§è¡Œ binlog æ—¥å¿—ä¸­çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯åœ¨è‡ªå·±æœ¬åœ°å†æ¬¡æ‰§è¡Œä¸€é SQLï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯è‡ªå·±è·Ÿä¸»åº“çš„æ•°æ®æ˜¯ä¸€æ ·çš„ã€‚\nè¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯ä»åº“åŒæ­¥ä¸»åº“æ•°æ®çš„è¿‡ç¨‹æ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸»åº“ä¸Šå¹¶è¡Œçš„æ“ä½œï¼Œåœ¨ä»åº“ä¸Šä¼šä¸²è¡Œæ‰§è¡Œã€‚æ‰€ä»¥è¿™å°±æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹äº†ï¼Œç”±äºä»åº“ä»ä¸»åº“æ‹·è´æ—¥å¿—ä»¥åŠä¸²è¡Œæ‰§è¡Œ SQL çš„ç‰¹ç‚¹ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä»åº“çš„æ•°æ®ä¸€å®šä¼šæ¯”ä¸»åº“æ…¢ä¸€äº›ï¼Œæ˜¯æœ‰å»¶æ—¶çš„ã€‚æ‰€ä»¥ç»å¸¸å‡ºç°ï¼Œåˆšå†™å…¥ä¸»åº“çš„æ•°æ®å¯èƒ½æ˜¯è¯»ä¸åˆ°çš„ï¼Œè¦è¿‡å‡ åæ¯«ç§’ï¼Œç”šè‡³å‡ ç™¾æ¯«ç§’æ‰èƒ½è¯»å–åˆ°ã€‚\nè€Œä¸”è¿™é‡Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœä¸»åº“çªç„¶å®•æœºï¼Œç„¶åæ°å¥½æ•°æ®è¿˜æ²¡åŒæ­¥åˆ°ä»åº“ï¼Œé‚£ä¹ˆæœ‰äº›æ•°æ®å¯èƒ½åœ¨ä»åº“ä¸Šæ˜¯æ²¡æœ‰çš„ï¼Œæœ‰äº›æ•°æ®å¯èƒ½å°±ä¸¢å¤±äº†ã€‚\næ‰€ä»¥ MySQL å®é™…ä¸Šåœ¨è¿™ä¸€å—æœ‰ä¸¤ä¸ªæœºåˆ¶ï¼Œä¸€ä¸ªæ˜¯åŠåŒæ­¥å¤åˆ¶ï¼Œç”¨æ¥è§£å†³ä¸»åº“æ•°æ®ä¸¢å¤±é—®é¢˜ï¼›ä¸€ä¸ªæ˜¯å¹¶è¡Œå¤åˆ¶ï¼Œç”¨æ¥è§£å†³ä¸»ä»åŒæ­¥å»¶æ—¶é—®é¢˜ã€‚\nè¿™ä¸ªæ‰€è°“åŠåŒæ­¥å¤åˆ¶ï¼Œä¹Ÿå« semi-sync å¤åˆ¶ï¼ŒæŒ‡çš„å°±æ˜¯ä¸»åº“å†™å…¥ binlog æ—¥å¿—ä¹‹åï¼Œå°±ä¼šå°†å¼ºåˆ¶æ­¤æ—¶ç«‹å³å°†æ•°æ®åŒæ­¥åˆ°ä»åº“ï¼Œä»åº“å°†æ—¥å¿—å†™å…¥è‡ªå·±æœ¬åœ°çš„ relay log ä¹‹åï¼Œæ¥ç€ä¼šè¿”å›ä¸€ä¸ª ack ç»™ä¸»åº“ï¼Œä¸»åº“æ¥æ”¶åˆ°è‡³å°‘ä¸€ä¸ªä»åº“çš„ ack ä¹‹åæ‰ä¼šè®¤ä¸ºå†™æ“ä½œå®Œæˆäº†ã€‚\næ‰€è°“å¹¶è¡Œå¤åˆ¶ï¼ŒæŒ‡çš„æ˜¯ä»åº“å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œå¹¶è¡Œè¯»å– relay log ä¸­ä¸åŒåº“çš„æ—¥å¿—ï¼Œç„¶åå¹¶è¡Œé‡æ”¾ä¸åŒåº“çš„æ—¥å¿—ï¼Œè¿™æ˜¯åº“çº§åˆ«çš„å¹¶è¡Œã€‚\nMySQL ä¸»ä»åŒæ­¥å»¶æ—¶é—®é¢˜ï¼ˆç²¾åï¼‰ ä»¥å‰çº¿ä¸Šç¡®å®å¤„ç†è¿‡å› ä¸ºä¸»ä»åŒæ­¥å»¶æ—¶é—®é¢˜è€Œå¯¼è‡´çš„çº¿ä¸Šçš„ bugï¼Œå±äºå°å‹çš„ç”Ÿäº§äº‹æ•…ã€‚\næ˜¯è¿™ä¸ªä¹ˆåœºæ™¯ã€‚æœ‰ä¸ªåŒå­¦æ˜¯è¿™æ ·å†™ä»£ç é€»è¾‘çš„ã€‚å…ˆæ’å…¥ä¸€æ¡æ•°æ®ï¼Œå†æŠŠå®ƒæŸ¥å‡ºæ¥ï¼Œç„¶åæ›´æ–°è¿™æ¡æ•°æ®ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒé«˜å³°æœŸï¼Œå†™å¹¶å‘è¾¾åˆ°äº† 2000/sï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¸»ä»å¤åˆ¶å»¶æ—¶å¤§æ¦‚æ˜¯åœ¨å°å‡ åæ¯«ç§’ã€‚çº¿ä¸Šä¼šå‘ç°ï¼Œæ¯å¤©æ€»æœ‰é‚£ä¹ˆä¸€äº›æ•°æ®ï¼Œæˆ‘ä»¬æœŸæœ›æ›´æ–°ä¸€äº›é‡è¦çš„æ•°æ®çŠ¶æ€ï¼Œä½†åœ¨é«˜å³°æœŸæ—¶å€™å´æ²¡æ›´æ–°ã€‚ç”¨æˆ·è·Ÿå®¢æœåé¦ˆï¼Œè€Œå®¢æœå°±ä¼šåé¦ˆç»™æˆ‘ä»¬ã€‚\næˆ‘ä»¬é€šè¿‡ MySQL å‘½ä»¤ï¼š\nshow slave status\ræŸ¥çœ‹ Seconds_Behind_Master ï¼Œå¯ä»¥çœ‹åˆ°ä»åº“å¤åˆ¶ä¸»åº“çš„æ•°æ®è½åäº†å‡  msã€‚\nä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸»ä»å»¶è¿Ÿè¾ƒä¸ºä¸¥é‡ï¼Œæœ‰ä»¥ä¸‹è§£å†³æ–¹æ¡ˆï¼š\n åˆ†åº“ï¼Œå°†ä¸€ä¸ªä¸»åº“æ‹†åˆ†ä¸ºå¤šä¸ªä¸»åº“ï¼Œæ¯ä¸ªä¸»åº“çš„å†™å¹¶å‘å°±å‡å°‘äº†å‡ å€ï¼Œæ­¤æ—¶ä¸»ä»å»¶è¿Ÿå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ æ‰“å¼€ MySQL æ”¯æŒçš„å¹¶è¡Œå¤åˆ¶ï¼Œå¤šä¸ªåº“å¹¶è¡Œå¤åˆ¶ã€‚å¦‚æœè¯´æŸä¸ªåº“çš„å†™å…¥å¹¶å‘å°±æ˜¯ç‰¹åˆ«é«˜ï¼Œå•åº“å†™å¹¶å‘è¾¾åˆ°äº† 2000/sï¼Œå¹¶è¡Œå¤åˆ¶è¿˜æ˜¯æ²¡æ„ä¹‰ã€‚ é‡å†™ä»£ç ï¼Œå†™ä»£ç çš„åŒå­¦ï¼Œè¦æ…é‡ï¼Œæ’å…¥æ•°æ®æ—¶ç«‹é©¬æŸ¥è¯¢å¯èƒ½æŸ¥ä¸åˆ°ã€‚ å¦‚æœç¡®å®æ˜¯å­˜åœ¨å¿…é¡»å…ˆæ’å…¥ï¼Œç«‹é©¬è¦æ±‚å°±æŸ¥è¯¢åˆ°ï¼Œç„¶åç«‹é©¬å°±è¦åè¿‡æ¥æ‰§è¡Œä¸€äº›æ“ä½œï¼Œå¯¹è¿™ä¸ªæŸ¥è¯¢è®¾ç½®ç›´è¿ä¸»åº“ã€‚ä¸æ¨èè¿™ç§æ–¹æ³•ï¼Œä½ è¦æ˜¯è¿™ä¹ˆæï¼Œè¯»å†™åˆ†ç¦»çš„æ„ä¹‰å°±ä¸§å¤±äº†ã€‚  å‚è€ƒ ä½ ä»¬æœ‰æ²¡æœ‰åš MySQL è¯»å†™åˆ†ç¦»ï¼Ÿå¦‚ä½•å®ç° MySQL çš„è¯»å†™åˆ†ç¦»ï¼ŸMySQL ä¸»ä»å¤åˆ¶åŸç†çš„æ˜¯å•¥ï¼Ÿå¦‚ä½•è§£å†³ MySQL ä¸»ä»åŒæ­¥çš„å»¶æ—¶é—®é¢˜ï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mysql/%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3mysql%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E7%9A%84%E5%BB%B6%E6%97%B6%E9%97%AE%E9%A2%98/","series":["Manual"],"tags":["MySQL"],"title":"å¦‚ä½•è§£å†³MySQLä¸»ä»åŒæ­¥çš„å»¶æ—¶é—®é¢˜"},{"categories":["æ¶æ„æ¼”è¿›"],"content":"å…¶å®æ‰€è°“çš„é«˜å¹¶å‘ï¼Œå¦‚æœä½ è¦ç†è§£è¿™ä¸ªé—®é¢˜å‘¢ï¼Œå…¶å®å°±å¾—ä»é«˜å¹¶å‘çš„æ ¹æºå‡ºå‘ï¼Œä¸ºå•¥ä¼šæœ‰é«˜å¹¶å‘ï¼Ÿä¸ºå•¥é«˜å¹¶å‘å°±å¾ˆç‰›é€¼ï¼Ÿ\næˆ‘è¯´çš„æµ…æ˜¾ä¸€ç‚¹ï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯å› ä¸ºåˆšå¼€å§‹ç³»ç»Ÿéƒ½æ˜¯è¿æ¥æ•°æ®åº“çš„ï¼Œä½†æ˜¯è¦çŸ¥é“æ•°æ®åº“æ”¯æ’‘åˆ°æ¯ç§’å¹¶å‘ä¸¤ä¸‰åƒçš„æ—¶å€™ï¼ŒåŸºæœ¬å°±å¿«å®Œäº†ã€‚æ‰€ä»¥æ‰æœ‰è¯´ï¼Œå¾ˆå¤šå…¬å¸ï¼Œåˆšå¼€å§‹å¹²çš„æ—¶å€™ï¼ŒæŠ€æœ¯æ¯”è¾ƒ lowï¼Œç»“æœä¸šåŠ¡å‘å±•å¤ªå¿«ï¼Œæœ‰çš„æ—¶å€™ç³»ç»Ÿæ‰›ä¸ä½å‹åŠ›å°±æŒ‚äº†ã€‚\nå½“ç„¶ä¼šæŒ‚äº†ï¼Œå‡­ä»€ä¹ˆä¸æŒ‚ï¼Ÿä½ æ•°æ®åº“å¦‚æœç¬é—´æ‰¿è½½æ¯ç§’ 5000/8000ï¼Œç”šè‡³ä¸Šä¸‡çš„å¹¶å‘ï¼Œä¸€å®šä¼šå®•æœºï¼Œå› ä¸ºæ¯”å¦‚ mysql å°±å‹æ ¹å„¿æ‰›ä¸ä½è¿™ä¹ˆé«˜çš„å¹¶å‘é‡ã€‚\næ‰€ä»¥ä¸ºå•¥é«˜å¹¶å‘ç‰›é€¼ï¼Ÿå°±æ˜¯å› ä¸ºç°åœ¨ç”¨äº’è”ç½‘çš„äººè¶Šæ¥è¶Šå¤šï¼Œå¾ˆå¤š appã€ç½‘ç«™ã€ç³»ç»Ÿæ‰¿è½½çš„éƒ½æ˜¯é«˜å¹¶å‘è¯·æ±‚ï¼Œå¯èƒ½é«˜å³°æœŸæ¯ç§’å¹¶å‘é‡å‡ åƒï¼Œå¾ˆæ­£å¸¸çš„ã€‚å¦‚æœæ˜¯ä»€ä¹ˆåŒåä¸€ä¹‹ç±»çš„ï¼Œæ¯ç§’å¹¶å‘å‡ ä¸‡å‡ åä¸‡éƒ½æœ‰å¯èƒ½ã€‚\né‚£ä¹ˆå¦‚æ­¤ä¹‹é«˜çš„å¹¶å‘é‡ï¼ŒåŠ ä¸ŠåŸæœ¬å°±å¦‚æ­¤ä¹‹å¤æ‚çš„ä¸šåŠ¡ï¼Œå’‹ç©å„¿ï¼ŸçœŸæ­£å‰å®³çš„ï¼Œä¸€å®šæ˜¯åœ¨å¤æ‚ä¸šåŠ¡ç³»ç»Ÿé‡Œç©å„¿è¿‡é«˜å¹¶å‘æ¶æ„çš„äººï¼Œä½†æ˜¯ä½ æ²¡æœ‰ï¼Œé‚£ä¹ˆæˆ‘ç»™ä½ è¯´ä¸€ä¸‹ä½ è¯¥æ€ä¹ˆå›ç­”è¿™ä¸ªé—®é¢˜ï¼š\nå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 6 ç‚¹ï¼š\n ç³»ç»Ÿæ‹†åˆ† ç¼“å­˜ MQ åˆ†åº“åˆ†è¡¨ è¯»å†™åˆ†ç¦» ElasticSearch  ç³»ç»Ÿæ‹†åˆ† å°†ä¸€ä¸ªç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªå­ç³»ç»Ÿï¼Œç”¨ dubbo æ¥æã€‚ç„¶åæ¯ä¸ªç³»ç»Ÿè¿ä¸€ä¸ªæ•°æ®åº“ï¼Œè¿™æ ·æœ¬æ¥å°±ä¸€ä¸ªåº“ï¼Œç°åœ¨å¤šä¸ªæ•°æ®åº“ï¼Œä¸ä¹Ÿå¯ä»¥æ‰›é«˜å¹¶å‘ä¹ˆã€‚\nç¼“å­˜ ç¼“å­˜ï¼Œå¿…é¡»å¾—ç”¨ç¼“å­˜ã€‚å¤§éƒ¨åˆ†çš„é«˜å¹¶å‘åœºæ™¯ï¼Œéƒ½æ˜¯è¯»å¤šå†™å°‘ï¼Œé‚£ä½ å®Œå…¨å¯ä»¥åœ¨æ•°æ®åº“å’Œç¼“å­˜é‡Œéƒ½å†™ä¸€ä»½ï¼Œç„¶åè¯»çš„æ—¶å€™å¤§é‡èµ°ç¼“å­˜ä¸å°±å¾—äº†ã€‚æ¯•ç«Ÿäººå®¶ redis è½»è½»æ¾æ¾å•æœºå‡ ä¸‡çš„å¹¶å‘ã€‚æ‰€ä»¥ä½ å¯ä»¥è€ƒè™‘è€ƒè™‘ä½ çš„é¡¹ç›®é‡Œï¼Œé‚£äº›æ‰¿è½½ä¸»è¦è¯·æ±‚çš„è¯»åœºæ™¯ï¼Œæ€ä¹ˆç”¨ç¼“å­˜æ¥æŠ—é«˜å¹¶å‘ã€‚\nMQ MQï¼Œå¿…é¡»å¾—ç”¨ MQã€‚å¯èƒ½ä½ è¿˜æ˜¯ä¼šå‡ºç°é«˜å¹¶å‘å†™çš„åœºæ™¯ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªä¸šåŠ¡æ“ä½œé‡Œè¦é¢‘ç¹ææ•°æ®åº“å‡ åæ¬¡ï¼Œå¢åˆ æ”¹å¢åˆ æ”¹ï¼Œç–¯äº†ã€‚é‚£é«˜å¹¶å‘ç»å¯¹ææŒ‚ä½ çš„ç³»ç»Ÿï¼Œä½ è¦æ˜¯ç”¨ redis æ¥æ‰¿è½½å†™é‚£è‚¯å®šä¸è¡Œï¼Œäººå®¶æ˜¯ç¼“å­˜ï¼Œæ•°æ®éšæ—¶å°±è¢« LRU äº†ï¼Œæ•°æ®æ ¼å¼è¿˜æ— æ¯”ç®€å•ï¼Œæ²¡æœ‰äº‹åŠ¡æ”¯æŒã€‚æ‰€ä»¥è¯¥ç”¨ mysql è¿˜å¾—ç”¨ mysql å•Šã€‚é‚£ä½ å’‹åŠï¼Ÿç”¨ MQ å§ï¼Œå¤§é‡çš„å†™è¯·æ±‚çŒå…¥ MQ é‡Œï¼Œæ’é˜Ÿæ…¢æ…¢ç©å„¿ï¼Œåè¾¹ç³»ç»Ÿæ¶ˆè´¹åæ…¢æ…¢å†™ï¼Œæ§åˆ¶åœ¨ mysql æ‰¿è½½èŒƒå›´ä¹‹å†…ã€‚æ‰€ä»¥ä½ å¾—è€ƒè™‘è€ƒè™‘ä½ çš„é¡¹ç›®é‡Œï¼Œé‚£äº›æ‰¿è½½å¤æ‚å†™ä¸šåŠ¡é€»è¾‘çš„åœºæ™¯é‡Œï¼Œå¦‚ä½•ç”¨ MQ æ¥å¼‚æ­¥å†™ï¼Œæå‡å¹¶å‘æ€§ã€‚MQ å•æœºæŠ—å‡ ä¸‡å¹¶å‘ä¹Ÿæ˜¯ ok çš„ï¼Œè¿™ä¸ªä¹‹å‰è¿˜ç‰¹æ„è¯´è¿‡ã€‚\nåˆ†åº“åˆ†è¡¨ åˆ†åº“åˆ†è¡¨ï¼Œå¯èƒ½åˆ°äº†æœ€åæ•°æ®åº“å±‚é¢è¿˜æ˜¯å…ä¸äº†æŠ—é«˜å¹¶å‘çš„è¦æ±‚ï¼Œå¥½å§ï¼Œé‚£ä¹ˆå°±å°†ä¸€ä¸ªæ•°æ®åº“æ‹†åˆ†ä¸ºå¤šä¸ªåº“ï¼Œå¤šä¸ªåº“æ¥æ‰›æ›´é«˜çš„å¹¶å‘ï¼›ç„¶åå°†ä¸€ä¸ªè¡¨æ‹†åˆ†ä¸ºå¤šä¸ªè¡¨ï¼Œæ¯ä¸ªè¡¨çš„æ•°æ®é‡ä¿æŒå°‘ä¸€ç‚¹ï¼Œæé«˜ sql è·‘çš„æ€§èƒ½ã€‚\nè¯»å†™åˆ†ç¦» è¯»å†™åˆ†ç¦»ï¼Œè¿™ä¸ªå°±æ˜¯è¯´å¤§éƒ¨åˆ†æ—¶å€™æ•°æ®åº“å¯èƒ½ä¹Ÿæ˜¯è¯»å¤šå†™å°‘ï¼Œæ²¡å¿…è¦æ‰€æœ‰è¯·æ±‚éƒ½é›†ä¸­åœ¨ä¸€ä¸ªåº“ä¸Šå§ï¼Œå¯ä»¥æä¸ªä¸»ä»æ¶æ„ï¼Œä¸»åº“å†™å…¥ï¼Œä»åº“è¯»å–ï¼Œæä¸€ä¸ªè¯»å†™åˆ†ç¦»ã€‚è¯»æµé‡å¤ªå¤šçš„æ—¶å€™ï¼Œè¿˜å¯ä»¥åŠ æ›´å¤šçš„ä»åº“ã€‚\nElasticSearch Elasticsearchï¼Œç®€ç§° esã€‚es æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå¯ä»¥éšä¾¿æ‰©å®¹ï¼Œåˆ†å¸ƒå¼å¤©ç„¶å°±å¯ä»¥æ”¯æ’‘é«˜å¹¶å‘ï¼Œå› ä¸ºåŠ¨ä¸åŠ¨å°±å¯ä»¥æ‰©å®¹åŠ æœºå™¨æ¥æ‰›æ›´é«˜çš„å¹¶å‘ã€‚é‚£ä¹ˆä¸€äº›æ¯”è¾ƒç®€å•çš„æŸ¥è¯¢ã€ç»Ÿè®¡ç±»çš„æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ç”¨ es æ¥æ‰¿è½½ï¼Œè¿˜æœ‰ä¸€äº›å…¨æ–‡æœç´¢ç±»çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ç”¨ es æ¥æ‰¿è½½ã€‚\nå‚è€ƒ å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜å¹¶å‘ç³»ç»Ÿï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F/","series":["Manual"],"tags":["SA"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜å¹¶å‘ç³»ç»Ÿ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. åŸºäºçº¿ç¨‹çš„join(long millis)æ–¹æ³• å…¶å®è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç‰µå¼ºï¼Œå› ä¸ºå®ƒä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å¤šä¸ªçº¿ç¨‹ä¹‹é—´è¿›è¡ŒåŒæ­¥çš„ã€‚ä½†å› ä¸ºå®ƒæä¾›äº†è¿™ä¸ªå¸¦å‚æ•°çš„æ–¹æ³•ï¼ˆæ‰€ä»¥è¿™ä¹Ÿç»™äº†æˆ‘ä»¬ä¸€ä¸ªæ›´å¹¿æ³›çš„æ€è·¯ï¼Œå°±æ˜¯ä¸€èˆ¬å¸¦æœ‰è¶…æ—¶å‚æ•°çš„æ–¹æ³•æˆ‘ä»¬éƒ½å¯ä»¥å°è¯•ç€ç”¨å®ƒæ¥å®ç°è¶…æ—¶ç»“æŸä»»åŠ¡ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥å®ç°ã€‚æ³¨æ„è¿™é‡Œçš„å‚æ•°çš„å•ä½æ˜¯å›ºå®šçš„æ¯«ç§’ï¼Œä¸åŒäºæ¥ä¸‹æ¥çš„å¸¦å•ä½çš„å‡½æ•°ã€‚å…·ä½“ç”¨æ³•è¯·çœ‹ç¤ºä¾‹ï¼š\npublic class JoinTest { public static void main(String[] args) { Task task1 = new Task(\u0026#34;one\u0026#34;, 4); Task task2 = new Task(\u0026#34;two\u0026#34;, 2); Thread t1 = new Thread(task1); Thread t2 = new Thread(task2); t1.start(); try { t1.join(2000); // åœ¨ä¸»çº¿ç¨‹ä¸­ç­‰å¾…t1æ‰§è¡Œ2ç§’  } catch (InterruptedException e) { System.out.println(\u0026#34;t1 interrupted when waiting join\u0026#34;); e.printStackTrace(); } t1.interrupt(); // è¿™é‡Œå¾ˆé‡è¦ï¼Œä¸€å®šè¦æ‰“æ–­t1,å› ä¸ºå®ƒå·²ç»æ‰§è¡Œäº†2ç§’ã€‚  t2.start(); try { t2.join(1000); } catch (InterruptedException e) { System.out.println(\u0026#34;t2 interrupted when waiting join\u0026#34;); e.printStackTrace(); } } } class Task implements Runnable { public String name; private int time; public Task(String s, int t) { name = s; time = t; } public void run() { for (int i = 0; i \u0026lt; time; ++i) { System.out.println(\u0026#34;task \u0026#34; + name + \u0026#34; \u0026#34; + (i + 1) + \u0026#34; round\u0026#34;); try { Thread.sleep(1000); } catch (InterruptedException e) { System.out.println(name + \u0026#34;is interrupted when calculating, will stop...\u0026#34;); return; // æ³¨æ„è¿™é‡Œå¦‚æœä¸returnçš„è¯ï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥ä»»åŠ¡è¶…æ—¶ååœ¨è¿™é‡Œå¤„ç†ç»“æœç„¶åè¿”å›  } } } } 2. Future.get(long million, TimeUnit unit) é…åˆFuture.cancle(true) public class FutureTest { static class Task implements Callable\u0026lt;Boolean\u0026gt; { public String name; private int time; public Task(String s, int t) { name = s; time = t; } @Override public Boolean call() throws Exception { for (int i = 0; i \u0026lt; time; ++i) { System.out.println(\u0026#34;task \u0026#34; + name + \u0026#34; round \u0026#34; + (i + 1)); try { Thread.sleep(1000); } catch (InterruptedException e) { System.out.println(name + \u0026#34; is interrupted when calculating, will stop...\u0026#34;); return false; // æ³¨æ„è¿™é‡Œå¦‚æœä¸returnçš„è¯ï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥ä»»åŠ¡è¶…æ—¶ååœ¨è¿™é‡Œå¤„ç†ç»“æœç„¶åè¿”å›  } } return true; } } public static void main(String[] args) { ExecutorService executor = Executors.newCachedThreadPool(); Task task1 = new Task(\u0026#34;one\u0026#34;, 5); Future\u0026lt;Boolean\u0026gt; f1 = executor.submit(task1); try { if (f1.get(2, TimeUnit.SECONDS)) { // futureå°†åœ¨2ç§’ä¹‹åå–ç»“æœ  System.out.println(\u0026#34;one complete successfully\u0026#34;); } } catch (InterruptedException e) { System.out.println(\u0026#34;futureåœ¨ç¡ç€æ—¶è¢«æ‰“æ–­\u0026#34;); executor.shutdownNow(); } catch (ExecutionException e) { System.out.println(\u0026#34;futureåœ¨å°è¯•å–å¾—ä»»åŠ¡ç»“æœæ—¶å‡ºé”™\u0026#34;); executor.shutdownNow(); } catch (TimeoutException e) { System.out.println(\u0026#34;futureæ—¶é—´è¶…æ—¶\u0026#34;); f1.cancel(true); // executor.shutdownNow();  // executor.shutdown();  } finally { executor.shutdownNow(); } } } 3. å®šæ—¶å™¨æˆ–è€…å®ˆæŠ¤çº¿ç¨‹ è¿™ä¸¤ç§æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡æŒæœ‰ç›®æ ‡çº¿ç¨‹çš„å¼•ç”¨ï¼Œåœ¨å®šæ—¶ç»“æŸåæ‰“æ–­ç›®æ ‡çº¿ç¨‹ï¼Œè¿™ä¸¤ç§æ–¹æ³•çš„æ§åˆ¶ç²¾åº¦æœ€ä½ï¼Œå› ä¸ºå®ƒæ˜¯é‡‡ç”¨å¦ä¸€ä¸ªçº¿ç¨‹æ¥ç›‘è§†ç›®æ ‡çº¿ç¨‹çš„è¿è¡Œæ—¶é—´ï¼Œå› ä¸ºçº¿ç¨‹è°ƒåº¦çš„ä¸ç¡®å®šæ€§ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨å®šæ—¶ç»“æŸåä¸ä¸€å®šä¼šé©¬ä¸Šå¾—åˆ°æ‰§è¡Œè€Œæ‰“æ–­ç›®æ ‡çº¿ç¨‹ã€‚\næ€»ç»“ï¼šéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ— è®ºä»¥ä¸Šå“ªä¸€ç§æ–¹æ³•ï¼Œå…¶å®ç°åŸç†éƒ½æ˜¯åœ¨è¶…æ—¶åé€šè¿‡interruptæ‰“æ–­ç›®æ ‡çº¿ç¨‹çš„è¿è¡Œï¼Œæ‰€ä»¥éƒ½è¦åœ¨æ•æ‰åˆ°InterruptedExceptionçš„catchä»£ç å—ä¸­return,å¦åˆ™çº¿ç¨‹ä»ç„¶ä¼šç»§ç»­æ‰§è¡Œã€‚\nå‚è€ƒé“¾æ¥ï¼š Javaå¤šçº¿ç¨‹ä»»åŠ¡è¶…æ—¶ç»“æŸçš„5ç§å®ç°æ–¹æ³•\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B%E8%B6%85%E6%97%B6%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/","series":["Manual"],"tags":["Java"],"title":"å®ç°çº¿ç¨‹è¶…æ—¶çš„å‡ ç§æ–¹å¼"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"Javaä¸­ç±»åŠæ–¹æ³•çš„åŠ è½½é¡ºåº\rJavaç±»åŠ è½½é¡ºåº\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E5%AF%B9%E8%B1%A1%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%BA%E5%BA%8F/","series":["Manual"],"tags":["Java"],"title":"å¯¹è±¡åˆå§‹åŒ–é¡ºåº"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ å‚è€ƒï¼šKafkaç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/kafka/%E5%B8%B8%E5%A4%87%E7%9F%A5%E8%AF%86%E7%82%B9/","series":["Manual"],"tags":["Kafka"],"title":"å¸¸å¤‡çŸ¥è¯†ç‚¹"},{"categories":["äººå·¥æ™ºèƒ½"],"content":"â€œæ²¡æœ‰æµ‹é‡ï¼Œå°±æ²¡æœ‰ç§‘å­¦ã€‚â€è¿™æ˜¯ç§‘å­¦å®¶é—¨æ·åˆ—å¤«çš„åè¨€ã€‚åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨æœºå™¨å­¦ä¹ çš„é¢†åŸŸï¼Œå¯¹æ¨¡å‹çš„æµ‹é‡å’Œè¯„ä¼°åŒæ ·è‡³å…³é‡è¦ã€‚åªæœ‰é€‰æ‹©ä¸é—®é¢˜ç›¸åŒ¹é…çš„è¯„ä¼°æ–¹æ³•ï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿå¿«é€Ÿçš„å‘ç°åœ¨æ¨¡å‹é€‰æ‹©å’Œè®­ç»ƒè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œè¿­ä»£åœ°å¯¹æ¨¡å‹è¿›è¡Œä¼˜åŒ–ã€‚æœ¬æ–‡å°†æ€»ç»“æœºå™¨å­¦ä¹ æœ€å¸¸è§çš„æ¨¡å‹è¯„ä¼°æŒ‡æ ‡ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š\n precision recall F1-score PRC ROCå’ŒAUC IOU  ä»æ··æ·†çŸ©é˜µè°ˆèµ· çœ‹ä¸€çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼šå‡å®šç“œå†œæ‹‰æ¥ä¸€è½¦è¥¿ç“œï¼Œæˆ‘ä»¬ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹å¯¹è¿™äº›è¥¿ç“œè¿›è¡Œåˆ¤åˆ«ï¼Œæ˜¾ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é”™è¯¯ç‡æ¥è¡¡é‡æœ‰å¤šå°‘æ¯”ä¾‹çš„ç“œè¢«åˆ¤åˆ«é”™è¯¯ã€‚ä½†å¦‚æœæˆ‘ä»¬å…³å¿ƒçš„æ˜¯â€œæŒ‘å‡ºçš„è¥¿ç“œä¸­æœ‰å¤šå°‘æ¯”ä¾‹æ˜¯å¥½ç“œâ€ï¼Œæˆ–è€…â€œæ‰€æœ‰å¥½ç“œä¸­æœ‰å¤šå°‘æ¯”ä¾‹è¢«æŒ‘å‡ºæ¥äº†â€ï¼Œé‚£ä¹ˆé”™è¯¯ç‡æ˜¾ç„¶å°±ä¸å¤Ÿç”¨äº†ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦å¼•å…¥æ–°çš„è¯„ä¼°æŒ‡æ ‡ï¼Œæ¯”å¦‚â€œæŸ¥å‡†ç‡â€å’ŒæŸ¥å…¨ç‡æ›´é€‚åˆæ­¤ç±»éœ€æ±‚çš„æ€§èƒ½åº¦é‡ã€‚\nåœ¨å¼•å…¥æŸ¥å…¨ç‡å’ŒæŸ¥å‡†ç‡ä¹‹å‰æˆ‘ä»¬å¿…é¡»å…ˆç†è§£åˆ°ä»€ä¹ˆæ˜¯æ··æ·†çŸ©é˜µï¼ˆConfusion matrixï¼‰ã€‚è¿™ä¸ªåå­—èµ·å¾—æ˜¯çœŸçš„å¥½ï¼Œåˆå­¦è€…å¾ˆå®¹æ˜“è¢«è¿™ä¸ªçŸ©é˜µæå¾—æ™•å¤´è½¬å‘ã€‚ä¸‹å›¾aå°±æ˜¯æœ‰åçš„æ··æ·†çŸ©é˜µï¼Œè€Œä¸‹å›¾båˆ™æ˜¯ç”±æ··æ·†çŸ©é˜µæ¨å‡ºçš„ä¸€äº›æœ‰åçš„è¯„ä¼°æŒ‡æ ‡ã€‚\næˆ‘ä»¬é¦–å…ˆå¥½å¥½è§£è¯»ä¸€ä¸‹æ··æ·†çŸ©é˜µé‡Œçš„ä¸€äº›åè¯å’Œå…¶æ„æ€ã€‚æ ¹æ®æ··æ·†çŸ©é˜µæˆ‘ä»¬å¯ä»¥å¾—åˆ°TP,FN,FP,TNå››ä¸ªå€¼ï¼Œæ˜¾ç„¶TP+FP+TN+FN=æ ·æœ¬æ€»æ•°ã€‚è¿™å››ä¸ªå€¼ä¸­éƒ½å¸¦ä¸¤ä¸ªå­—æ¯ï¼Œå•çº¯è®°å¿†è¿™å››ç§æƒ…å†µå¾ˆéš¾è®°å¾—ç‰¢ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£ï¼šç¬¬ä¸€ä¸ªå­—æ¯è¡¨ç¤ºæœ¬æ¬¡é¢„æµ‹çš„æ­£ç¡®æ€§ï¼ŒTå°±æ˜¯æ­£ç¡®ï¼ŒFå°±æ˜¯é”™è¯¯ï¼›ç¬¬äºŒä¸ªå­—æ¯åˆ™è¡¨ç¤ºç”±åˆ†ç±»å™¨é¢„æµ‹çš„ç±»åˆ«ï¼ŒPä»£è¡¨é¢„æµ‹ä¸ºæ­£ä¾‹ï¼ŒNä»£è¡¨é¢„æµ‹ä¸ºåä¾‹ã€‚æ¯”å¦‚TPæˆ‘ä»¬å°±å¯ä»¥ç†è§£ä¸ºåˆ†ç±»å™¨é¢„æµ‹ä¸ºæ­£ä¾‹ï¼ˆPï¼‰ï¼Œè€Œä¸”è¿™æ¬¡é¢„æµ‹æ˜¯å¯¹çš„ï¼ˆTï¼‰ï¼ŒFNå¯ä»¥ç†è§£ä¸ºåˆ†ç±»å™¨çš„é¢„æµ‹æ˜¯åä¾‹ï¼ˆNï¼‰ï¼Œè€Œä¸”è¿™æ¬¡é¢„æµ‹æ˜¯é”™è¯¯çš„ï¼ˆFï¼‰ï¼Œæ­£ç¡®ç»“æœæ˜¯æ­£ä¾‹ï¼Œå³ä¸€ä¸ªæ­£æ ·æœ¬è¢«é”™è¯¯é¢„æµ‹ä¸ºè´Ÿæ ·æœ¬ã€‚æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸Šçš„ç†è§£æ–¹å¼æ¥è®°ä½TPã€FPã€TNã€FNçš„æ„æ€åº”è¯¥å°±ä¸å†å›°éš¾äº†ã€‚ï¼Œä¸‹é¢å¯¹æ··æ·†çŸ©é˜µçš„å››ä¸ªå€¼è¿›è¡Œæ€»ç»“æ€§è®²è§£ï¼š\n True Positive ï¼ˆçœŸæ­£ï¼ŒTPï¼‰è¢«æ¨¡å‹é¢„æµ‹ä¸ºæ­£çš„æ­£æ ·æœ¬ True Negativeï¼ˆçœŸè´Ÿ , TNï¼‰è¢«æ¨¡å‹é¢„æµ‹ä¸ºè´Ÿçš„è´Ÿæ ·æœ¬ False Positive ï¼ˆå‡æ­£, FPï¼‰è¢«æ¨¡å‹é¢„æµ‹ä¸ºæ­£çš„è´Ÿæ ·æœ¬ False Negativeï¼ˆå‡è´Ÿ , FNï¼‰è¢«æ¨¡å‹é¢„æµ‹ä¸ºè´Ÿçš„æ­£æ ·æœ¬  Precisionã€Recallã€PRCã€F1-score PrecisionæŒ‡æ ‡åœ¨ä¸­æ–‡é‡Œå¯ä»¥ç§°ä¸ºæŸ¥å‡†ç‡æˆ–è€…æ˜¯ç²¾ç¡®ç‡ï¼ŒRecallæŒ‡æ ‡åœ¨ä¸­å«é‡Œå¸¸è¢«ç§°ä¸ºæŸ¥å…¨ç‡æˆ–è€…æ˜¯å¬å›ç‡ï¼ŒæŸ¥å‡†ç‡ På’ŒæŸ¥å…¨ç‡ Råˆ†åˆ«å®šä¹‰ä¸ºï¼š\næŸ¥å‡†ç‡På’ŒæŸ¥å…¨ç‡Rçš„å…·ä½“å«ä¹‰å¦‚ä¸‹ï¼š\n  æŸ¥å‡†ç‡(Precisionï¼‰æ˜¯æŒ‡åœ¨æ‰€æœ‰ç³»ç»Ÿåˆ¤å®šçš„â€œçœŸâ€çš„æ ·æœ¬ä¸­ï¼Œç¡®å®æ˜¯çœŸçš„çš„å æ¯”\n  æŸ¥å…¨ç‡ï¼ˆRecallï¼‰æ˜¯æŒ‡åœ¨æ‰€æœ‰ç¡®å®ä¸ºçœŸçš„æ ·æœ¬ä¸­ï¼Œè¢«åˆ¤ä¸ºçš„â€œçœŸâ€çš„å æ¯”\n  è¿™é‡Œæƒ³å¼ºè°ƒä¸€ç‚¹ï¼Œprecisionå’Œaccuracyï¼ˆæ­£ç¡®ç‡ï¼‰ä¸ä¸€æ ·çš„ï¼Œaccuracyé’ˆå¯¹æ‰€æœ‰æ ·æœ¬ï¼Œprecisioné’ˆå¯¹éƒ¨åˆ†æ ·æœ¬ï¼Œå³æ­£ç¡®çš„é¢„æµ‹/æ€»çš„æ­£åä¾‹ï¼š\næŸ¥å‡†ç‡å’ŒæŸ¥å…¨ç‡æ˜¯ä¸€å¯¹çŸ›ç›¾çš„åº¦é‡ï¼Œä¸€èˆ¬è€Œè¨€ï¼ŒæŸ¥å‡†ç‡é«˜æ—¶ï¼ŒæŸ¥å…¨ç‡å¾€å¾€åä½ï¼›è€ŒæŸ¥å…¨ç‡é«˜æ—¶ï¼ŒæŸ¥å‡†ç‡å¾€å¾€åä½ã€‚æˆ‘ä»¬ä»ç›´è§‚ç†è§£ç¡®å®å¦‚æ­¤ï¼šæˆ‘ä»¬å¦‚æœå¸Œæœ›å¥½ç“œå°½å¯èƒ½å¤šåœ°é€‰å‡ºæ¥ï¼Œåˆ™å¯ä»¥é€šè¿‡å¢åŠ é€‰ç“œçš„æ•°é‡æ¥å®ç°ï¼Œå¦‚æœå°†æ‰€æœ‰ç“œéƒ½é€‰ä¸Šäº†ï¼Œé‚£ä¹ˆæ‰€æœ‰å¥½ç“œä¹Ÿå¿…ç„¶è¢«é€‰ä¸Šï¼Œä½†æ˜¯è¿™æ ·æŸ¥å‡†ç‡å°±ä¼šè¶Šä½ï¼›è‹¥å¸Œæœ›é€‰å‡ºçš„ç“œä¸­å¥½ç“œçš„æ¯”ä¾‹å°½å¯èƒ½é«˜ï¼Œåˆ™åªé€‰æœ€æœ‰æŠŠæ¡çš„ç“œï¼Œä½†è¿™æ ·éš¾å…ä¼šæ¼æ‰ä¸å°‘å¥½ç“œï¼Œå¯¼è‡´æŸ¥å…¨ç‡è¾ƒä½ã€‚é€šå¸¸åªæœ‰åœ¨ä¸€äº›ç®€å•ä»»åŠ¡ä¸­ï¼Œæ‰å¯èƒ½ä½¿æŸ¥å…¨ç‡å’ŒæŸ¥å‡†ç‡éƒ½å¾ˆé«˜ã€‚\nå†è¯´PRCï¼Œ å…¶å…¨ç§°å°±æ˜¯Precision Recall Curveï¼Œå®ƒä»¥æŸ¥å‡†ç‡ä¸ºYè½´ï¼Œã€æŸ¥å…¨ç‡ä¸ºXè½´åšçš„å›¾ã€‚å®ƒæ˜¯ç»¼åˆè¯„ä»·æ•´ä½“ç»“æœçš„è¯„ä¼°æŒ‡æ ‡ã€‚æ‰€ä»¥ï¼Œå“ªç§ç±»å‹ï¼ˆæ­£æˆ–è€…è´Ÿï¼‰æ ·æœ¬å¤šï¼Œæƒé‡å°±å¤§ã€‚ä¹Ÿå°±æ˜¯é€šå¸¸è¯´çš„ã€å¯¹æ ·æœ¬ä¸å‡è¡¡æ•æ„Ÿã€ï¼Œã€å®¹æ˜“è¢«å¤šçš„æ ·å“å¸¦èµ°ã€ã€‚\nä¸Šå›¾å°±æ˜¯ä¸€å¹…P-Rå›¾ï¼Œå®ƒèƒ½ç›´è§‚åœ°æ˜¾ç¤ºå‡ºå­¦ä¹ å™¨åœ¨æ ·æœ¬æ€»ä½“ä¸Šçš„æŸ¥å…¨ç‡å’ŒæŸ¥å‡†ç‡ï¼Œæ˜¾ç„¶å®ƒæ˜¯ä¸€æ¡æ€»ä½“è¶‹åŠ¿æ˜¯é€’å‡çš„æ›²çº¿ã€‚åœ¨è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œè‹¥ä¸€ä¸ªå­¦ä¹ å™¨çš„PRæ›²çº¿è¢«å¦ä¸€ä¸ªå­¦ä¹ å™¨çš„æ›²çº¿å®Œå…¨åŒ…ä½ï¼Œåˆ™å¯æ–­è¨€åè€…çš„æ€§èƒ½ä¼˜äºå‰è€…ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­Aä¼˜äºCã€‚ä½†æ˜¯Bå’ŒAè°æ›´å¥½å‘¢ï¼Ÿå› ä¸ºABä¸¤æ¡æ›²çº¿äº¤å‰äº†ï¼Œæ‰€ä»¥å¾ˆéš¾æ¯”è¾ƒï¼Œè¿™æ—¶æ¯”è¾ƒåˆç†çš„åˆ¤æ®å°±æ˜¯æ¯”è¾ƒPRæ›²çº¿ä¸‹çš„é¢ç§¯ï¼Œè¯¥æŒ‡æ ‡åœ¨ä¸€å®šç¨‹åº¦ä¸Šè¡¨å¾äº†å­¦ä¹ å™¨åœ¨æŸ¥å‡†ç‡å’ŒæŸ¥å…¨ç‡ä¸Šå–å¾—ç›¸å¯¹â€œåŒé«˜â€çš„æ¯”ä¾‹ã€‚å› ä¸ºè¿™ä¸ªå€¼ä¸å®¹æ˜“ä¼°ç®—ï¼Œæ‰€ä»¥äººä»¬å¼•å…¥â€œå¹³è¡¡ç‚¹â€(BEP)æ¥åº¦é‡ï¼Œä»–è¡¨ç¤ºâ€œæŸ¥å‡†ç‡=æŸ¥å…¨ç‡â€æ—¶çš„å–å€¼ï¼Œå€¼è¶Šå¤§è¡¨æ˜åˆ†ç±»å™¨æ€§èƒ½è¶Šå¥½ï¼Œä»¥æ­¤æ¯”è¾ƒæˆ‘ä»¬ä¸€ä¸‹å­å°±èƒ½åˆ¤æ–­Aè¾ƒBå¥½ã€‚\nBEPè¿˜æ˜¯æœ‰ç‚¹ç®€åŒ–äº†ï¼Œæ›´å¸¸ç”¨çš„æ˜¯F1åº¦é‡ï¼š\nF1-score å°±æ˜¯ä¸€ä¸ªç»¼åˆè€ƒè™‘precisionå’Œrecallçš„æŒ‡æ ‡ï¼Œæ¯”BEPæ›´ä¸ºå¸¸ç”¨ã€‚\nROC \u0026amp; AUC ROCå…¨ç§°æ˜¯â€œå—è¯•è€…å·¥ä½œç‰¹å¾â€ï¼ˆReceiver Operating Characteristicï¼‰æ›²çº¿ï¼ŒROCæ›²çº¿ä»¥â€œçœŸæ­£ä¾‹ç‡â€ï¼ˆTPRï¼‰ä¸ºYè½´ï¼Œä»¥â€œå‡æ­£ä¾‹ç‡â€ï¼ˆFPRï¼‰ä¸ºXè½´ï¼Œå¯¹è§’çº¿å¯¹åº”äºâ€œéšæœºçŒœæµ‹â€æ¨¡å‹ï¼Œè€Œï¼ˆ0,1ï¼‰åˆ™å¯¹åº”â€œç†æƒ³æ¨¡å‹â€ã€‚ROCå½¢å¼å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nTPRå’ŒFPRçš„å®šä¹‰å¦‚ä¸‹ï¼š\nä»å½¢å¼ä¸Šçœ‹TPRå°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„æŸ¥å…¨ç‡Recallï¼Œè€ŒFPRçš„å«ä¹‰å°±æ˜¯ï¼šæ‰€æœ‰ç¡®å®ä¸ºâ€œå‡â€çš„æ ·æœ¬ä¸­ï¼Œè¢«è¯¯åˆ¤çœŸçš„æ ·æœ¬ã€‚\nè¿›è¡Œå­¦ä¹ å™¨æ¯”è¾ƒæ—¶ï¼Œä¸PRå›¾ç›¸ä¼¼ï¼Œè‹¥ä¸€ä¸ªå­¦ä¹ å™¨çš„ROCæ›²çº¿è¢«å¦ä¸€ä¸ªå­¦ä¹ å™¨çš„æ›²çº¿åŒ…ä½ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ–­è¨€åè€…æ€§èƒ½ä¼˜äºå‰è€…ï¼›è‹¥ä¸¤ä¸ªå­¦ä¹ å™¨çš„ROCæ›²çº¿å‘ç”Ÿäº¤å‰ï¼Œåˆ™éš¾ä»¥ä¸€èˆ¬æ€§æ–­è¨€ä¸¤è€…å­°ä¼˜å­°åŠ£ã€‚æ­¤æ—¶è‹¥è¦è¿›è¡Œæ¯”è¾ƒï¼Œé‚£ä¹ˆå¯ä»¥æ¯”è¾ƒROCæ›²çº¿ä¸‹çš„é¢ç§¯ï¼Œå³AUCï¼Œé¢ç§¯å¤§çš„æ›²çº¿å¯¹åº”çš„åˆ†ç±»å™¨æ€§èƒ½æ›´å¥½ã€‚\nAUCï¼ˆArea Under Curveï¼‰çš„å€¼ä¸ºROCæ›²çº¿ä¸‹é¢çš„é¢ç§¯ï¼Œè‹¥åˆ†ç±»å™¨çš„æ€§èƒ½æå¥½ï¼Œåˆ™AUCä¸º1ã€‚ä½†ç°å®ç”Ÿæ´»ä¸­å°¤å…¶æ˜¯å·¥ä¸šç•Œä¸ä¼šæœ‰å¦‚æ­¤å®Œç¾çš„æ¨¡å‹ï¼Œä¸€èˆ¬AUCå‡åœ¨0.5åˆ°1ä¹‹é—´ï¼ŒAUCè¶Šé«˜ï¼Œæ¨¡å‹çš„åŒºåˆ†èƒ½åŠ›è¶Šå¥½ï¼Œä¸Šå›¾AUCä¸º0.81ã€‚è‹¥AUC=0.5ï¼Œå³ä¸ä¸Šå›¾ä¸­çº¢çº¿é‡åˆï¼Œè¡¨ç¤ºæ¨¡å‹çš„åŒºåˆ†èƒ½åŠ›ä¸éšæœºçŒœæµ‹æ²¡æœ‰å·®åˆ«ã€‚è‹¥AUCçœŸçš„å°äº0.5ï¼Œè¯·æ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯å¥½åæ ‡ç­¾æ ‡åäº†ï¼Œæˆ–è€…æ˜¯æ¨¡å‹çœŸçš„å¾ˆå·®ã€‚\næ€ä¹ˆé€‰æ‹©è¯„ä¼°æŒ‡æ ‡ï¼Ÿ è¿™ç§é—®é¢˜çš„ç­”æ¡ˆå½“ç„¶æ˜¯å…·ä½“é—®é¢˜å…·ä½“åˆ†æå•¦ï¼Œå•çº¯åœ°å›ç­”è°å¥½è°åæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæˆ‘ä»¬éœ€è¦ç»“åˆå®é™…åœºæ™¯ç»™å‡ºåˆé€‚çš„å›ç­”ã€‚\nè€ƒè™‘ä¸‹é¢æ˜¯ä¸¤ä¸ªåœºæ™¯ï¼Œç”±æ­¤çœ‹å‡ºä¸åŒåœºæ™¯ä¸‹æˆ‘ä»¬å…³æ³¨çš„ç‚¹æ˜¯ä¸ä¸€æ ·çš„ï¼š\n å¯¹äºåœ°éœ‡çš„é¢„æµ‹ï¼Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯Recalléå¸¸é«˜ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡åœ°éœ‡æˆ‘ä»¬éƒ½å¸Œæœ›é¢„æµ‹å‡ºæ¥ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ç‰ºç‰²Precisionã€‚æƒ…æ„¿å‘å‡º1000æ¬¡è­¦æŠ¥ï¼ŒæŠŠ10æ¬¡åœ°éœ‡éƒ½é¢„æµ‹æ­£ç¡®äº†ï¼›ä¹Ÿä¸è¦é¢„æµ‹100æ¬¡å¯¹äº†8æ¬¡æ¼äº†ä¸¤æ¬¡ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾å®šåœ¨åˆç†çš„precisionä¸‹ï¼Œæœ€é«˜çš„recallä½œä¸ºæœ€ä¼˜ç‚¹ï¼Œæ‰¾åˆ°è¿™ä¸ªå¯¹åº”çš„thresholdç‚¹ã€‚ å«Œç–‘äººå®šç½ªåŸºäºä¸é”™æ€ªä¸€ä¸ªå¥½äººçš„åŸåˆ™ï¼Œå¯¹äºå«Œç–‘äººçš„å®šç½ªæˆ‘ä»¬å¸Œæœ›æ˜¯éå¸¸å‡†ç¡®çš„ã€‚å³ä½¿æœ‰æ—¶å€™æ”¾è¿‡äº†ä¸€äº›ç½ªçŠ¯ï¼ˆRecallä½ï¼‰ï¼Œä½†ä¹Ÿæ˜¯å€¼å¾—çš„ã€‚  ROCå’ŒPRCåœ¨æ¨¡å‹æ€§èƒ½è¯„ä¼°ä¸Šæ•ˆæœéƒ½å·®ä¸å¤šï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ­£è´Ÿæ ·æœ¬åˆ†å¸ƒå¾—æä¸å‡åŒ€(highly skewed datasets)çš„æƒ…å†µä¸‹ï¼ŒPRCæ¯”ROCèƒ½æ›´æœ‰æ•ˆåœ°ååº”åˆ†ç±»å™¨çš„å¥½åã€‚åœ¨æ•°æ®æåº¦ä¸å¹³è¡¡çš„æƒ…å†µä¸‹ï¼Œè­¬å¦‚è¯´1ä¸‡å°é‚®ä»¶ä¸­åªæœ‰1å°åƒåœ¾é‚®ä»¶ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘æŒ‘å‡º10å°ï¼Œ50å°ï¼Œ100\u0026hellip;å°åƒåœ¾é‚®ä»¶ï¼ˆå‡è®¾æˆ‘ä»¬æ¯æ¬¡æŒ‘å‡ºçš„Nå°é‚®ä»¶ä¸­éƒ½åŒ…å«çœŸæ­£çš„é‚£å°åƒåœ¾é‚®ä»¶ï¼‰ï¼ŒRecalléƒ½æ˜¯100%ï¼Œä½†æ˜¯FPRåˆ†åˆ«æ˜¯9/9999, 49/9999, 99/9999ï¼ˆæ•°æ®éƒ½æ¯”è¾ƒå¥½çœ‹ï¼šFPRè¶Šä½è¶Šå¥½ï¼‰ï¼Œè€ŒPrecisionå´åªæœ‰1/10ï¼Œ1/50ï¼Œ 1/100 ï¼ˆæ•°æ®å¾ˆå·®ï¼šPrecisionè¶Šé«˜è¶Šå¥½ï¼‰ã€‚æ‰€ä»¥åœ¨æ•°æ®éå¸¸ä¸å‡è¡¡çš„æƒ…å†µä¸‹ï¼Œçœ‹ROCçš„AUCå¯èƒ½æ˜¯çœ‹ä¸å‡ºå¤ªå¤šå¥½åçš„ï¼Œè€ŒPR curveå°±è¦æ•æ„Ÿçš„å¤šã€‚\nIOU ä¸Šé¢è®¨è®ºçš„æ˜¯åˆ†ç±»ä»»åŠ¡ä¸­çš„è¯„ä»·æŒ‡æ ‡ï¼Œè¿™é‡Œæƒ³ç®€å•è®²è®²ç›®æ ‡æ£€æµ‹ä»»åŠ¡ä¸­å¸¸ç”¨çš„è¯„ä»·æŒ‡æ ‡ï¼šIOUï¼ˆIntersection over Unionï¼‰ï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºäº¤å¹¶æ¯”ã€‚\nè¿™é‡Œæ˜¯ä¸€ä¸ªå®é™…ä¾‹å­ï¼šä¸‹å›¾ç»¿è‰²æ¡†æ˜¯çœŸå®æ„Ÿå…´è¶£åŒºåŸŸï¼Œçº¢è‰²æ¡†æ˜¯é¢„æµ‹åŒºåŸŸï¼Œè¿™ç§æƒ…å†µä¸‹äº¤é›†ç¡®å®æ˜¯æœ€å¤§çš„ï¼Œä½†æ˜¯çº¢è‰²æ¡†å¹¶ä¸èƒ½å‡†ç¡®é¢„æµ‹ç‰©ä½“ä½ç½®ã€‚å› ä¸ºé¢„æµ‹åŒºåŸŸæ€»æ˜¯è¯•å›¾è¦†ç›–ç›®æ ‡ç‰©ä½“è€Œä¸æ˜¯æ­£å¥½é¢„æµ‹ç‰©ä½“ä½ç½®ã€‚è¿™æ—¶å¦‚æœæˆ‘ä»¬èƒ½é™¤ä»¥ä¸€ä¸ªå¹¶é›†çš„å¤§å°ï¼Œå°±å¯ä»¥è§„é¿è¿™ç§é—®é¢˜ã€‚è¿™å°±æ˜¯IOUè¦è§£å†³çš„é—®é¢˜äº†ã€‚\nä¸‹å›¾è¡¨ç¤ºäº†IOUçš„å…·ä½“æ„ä¹‰ï¼Œå³ï¼šé¢„æµ‹æ¡†ä¸æ ‡æ³¨æ¡†çš„äº¤é›†ä¸å¹¶é›†ä¹‹æ¯”ï¼Œæ•°å€¼è¶Šå¤§è¡¨ç¤ºè¯¥æ£€æµ‹å™¨çš„æ€§èƒ½è¶Šå¥½ã€‚\nä½¿ç”¨IOUè¯„ä»·æŒ‡æ ‡åï¼Œä¸Šé¢æåˆ°çš„é—®é¢˜ä¸€ä¸‹å­è§£å†³äº†ï¼šæˆ‘ä»¬æ§åˆ¶å¹¶é›†ä¸è¦è®©å¹¶é›†å¤ªå¤§ï¼Œå¯¹å‡†ç¡®é¢„æµ‹æ˜¯æœ‰ç›Šçš„ï¼Œè¿™å°±æœ‰æ•ˆæŠ‘åˆ¶äº†â€œä¸€å‘³åœ°è¿½æ±‚äº¤é›†æœ€å¤§â€çš„æƒ…å†µçš„å‘ç”Ÿã€‚ä¸‹å›¾çš„2,3å°å›¾å°±æ˜¯ç›®æ ‡æ£€æµ‹æ•ˆæœæ¯”è¾ƒå¥½çš„æƒ…å†µã€‚\nå‚è€ƒï¼š https://www.cnblogs.com/skyfsm/p/8467613.html\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%E5%B8%B8%E7%94%A8%E7%9A%84%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E6%8C%87%E6%A0%87/","series":["Manual"],"tags":["CNN","AI"],"title":"å¸¸ç”¨çš„æ¨¡å‹è¯„ä¼°æŒ‡æ ‡"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"å¸¸è§ç±»å‹åŒ…æ‹¬LFUã€LRUã€ARCã€FIFOã€MRUã€‚\n æœ€ä¸ç»å¸¸ä½¿ç”¨ç®—æ³•ï¼ˆLFU, Least Frequently Usedï¼‰ï¼š  è¿™ä¸ªç¼“å­˜ç®—æ³•ä½¿ç”¨ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•æ¡ç›®è¢«è®¿é—®çš„é¢‘ç‡ã€‚é€šè¿‡ä½¿ç”¨LFUç¼“å­˜ç®—æ³•ï¼Œæœ€ä½è®¿é—®æ•°çš„æ¡ç›®é¦–å…ˆè¢«ç§»é™¤ã€‚è¿™ä¸ªæ–¹æ³•å¹¶ä¸ç»å¸¸ä½¿ç”¨ï¼Œå› ä¸ºå®ƒæ— æ³•å¯¹ä¸€ä¸ªæ‹¥æœ‰æœ€åˆé«˜è®¿é—®ç‡ä¹‹åé•¿æ—¶é—´æ²¡æœ‰è¢«è®¿é—®çš„æ¡ç›®ç¼“å­˜è´Ÿè´£ã€‚\n æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼ˆLRU, Least Recently Usedï¼‰  LRUæ˜¯é¦–å…ˆæ·˜æ±°æœ€é•¿æ—¶é—´æœªè¢«ä½¿ç”¨çš„é¡µé¢ã€‚è¿™ç§ç®—æ³•æŠŠè¿‘æœŸæœ€ä¹…æ²¡æœ‰è¢«è®¿é—®è¿‡çš„é¡µé¢ä½œä¸ºè¢«æ›¿æ¢çš„é¡µé¢ã€‚å®ƒæŠŠLFUç®—æ³•ä¸­è¦è®°å½•æ•°é‡ä¸Šçš„\u0026quot;å¤š\u0026quot;ä¸\u0026quot;å°‘\u0026quot;ç®€åŒ–æˆåˆ¤æ–­\u0026quot;æœ‰\u0026quot;ä¸\u0026quot;æ— \u0026quot;ï¼Œå› æ­¤ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒå®¹æ˜“ã€‚\næ³¨æ„ï¼šLRUçš„æ·˜æ±°è§„åˆ™æ˜¯åŸºäºè®¿é—®æ—¶é—´ï¼Œè€ŒLFUæ˜¯åŸºäºè®¿é—®æ¬¡æ•°çš„\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/%E5%B8%B8%E7%94%A8%E7%BC%93%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AE%97%E6%B3%95/","series":["Manual"],"tags":["CS"],"title":"å¸¸ç”¨ç¼“å­˜æ·˜æ±°ç®—æ³•"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"å‰è¨€ ç½‘ç»œå±‚åªæŠŠåˆ†ç»„å‘é€åˆ°ç›®çš„ä¸»æœºï¼Œä½†æ˜¯çœŸæ­£é€šä¿¡çš„å¹¶ä¸æ˜¯ä¸»æœºè€Œæ˜¯ä¸»æœºä¸­çš„è¿›ç¨‹ã€‚ä¼ è¾“å±‚æä¾›äº†è¿›ç¨‹é—´çš„é€»è¾‘é€šä¿¡ï¼Œä¼ è¾“å±‚å‘é«˜å±‚ç”¨æˆ·å±è”½äº†ä¸‹é¢ç½‘ç»œå±‚çš„æ ¸å¿ƒç»†èŠ‚ï¼Œä½¿åº”ç”¨ç¨‹åºçœ‹èµ·æ¥åƒæ˜¯åœ¨ä¸¤ä¸ªä¼ è¾“å±‚å®ä½“ä¹‹é—´æœ‰ä¸€æ¡ç«¯åˆ°ç«¯çš„é€»è¾‘é€šä¿¡ä¿¡é“ã€‚\nUDP å’Œ TCP çš„ç‰¹ç‚¹ä¸åŒºåˆ« ç”¨æˆ·æ•°æ®æŠ¥åè®® UDPï¼ˆUser Datagram Protocolï¼‰\ræ˜¯æ— è¿æ¥çš„ï¼Œå°½æœ€å¤§å¯èƒ½äº¤ä»˜ï¼Œæ²¡æœ‰æ‹¥å¡æ§åˆ¶ï¼Œé¢å‘æŠ¥æ–‡ï¼ˆå¯¹äºåº”ç”¨ç¨‹åºä¼ ä¸‹æ¥çš„æŠ¥æ–‡ä¸åˆå¹¶ä¹Ÿä¸æ‹†åˆ†ï¼Œåªæ˜¯æ·»åŠ  UDP é¦–éƒ¨ï¼‰ï¼Œæ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šçš„äº¤äº’é€šä¿¡ã€‚\nä¼ è¾“æ§åˆ¶åè®® TCPï¼ˆTransmission Control Protocolï¼‰\ræ˜¯é¢å‘è¿æ¥çš„ï¼Œæä¾›å¯é äº¤ä»˜ï¼Œæœ‰æµé‡æ§åˆ¶ï¼Œæ‹¥å¡æ§åˆ¶ï¼Œæä¾›å…¨åŒå·¥é€šä¿¡ï¼Œé¢å‘å­—èŠ‚æµï¼ˆæŠŠåº”ç”¨å±‚ä¼ ä¸‹æ¥çš„æŠ¥æ–‡çœ‹æˆå­—èŠ‚æµï¼ŒæŠŠå­—èŠ‚æµç»„ç»‡æˆå¤§å°ä¸ç­‰çš„æ•°æ®å—ï¼‰ï¼Œæ¯ä¸€æ¡ TCP è¿æ¥åªèƒ½æ˜¯ç‚¹å¯¹ç‚¹çš„ï¼ˆä¸€å¯¹ä¸€ï¼‰ã€‚\n2ã€UDP ã€TCP é¦–éƒ¨æ ¼å¼ UDP é¦–éƒ¨å­—æ®µåªæœ‰ 8 ä¸ªå­—èŠ‚ï¼ŒåŒ…æ‹¬æºç«¯å£ã€ç›®çš„ç«¯å£ã€é•¿åº¦ã€æ£€éªŒå’Œã€‚12 å­—èŠ‚çš„ä¼ªé¦–éƒ¨æ˜¯ä¸ºäº†è®¡ç®—æ£€éªŒå’Œä¸´æ—¶æ·»åŠ çš„ã€‚\nTCP é¦–éƒ¨æ ¼å¼æ¯” UDP å¤æ‚ã€‚\nåºå·ï¼šç”¨äºå¯¹å­—èŠ‚æµè¿›è¡Œç¼–å·ï¼Œä¾‹å¦‚åºå·ä¸º 301ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ªå­—èŠ‚çš„ç¼–å·ä¸º 301ï¼Œå¦‚æœæºå¸¦çš„æ•°æ®é•¿åº¦ä¸º 100 å­—èŠ‚ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„åºå·åº”ä¸º 401ã€‚\nç¡®è®¤å·ï¼šæœŸæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„åºå·ã€‚ä¾‹å¦‚ B æ­£ç¡®æ”¶åˆ° A å‘é€æ¥çš„ä¸€ä¸ªæŠ¥æ–‡æ®µï¼Œåºå·ä¸º 501ï¼Œæºå¸¦çš„æ•°æ®é•¿åº¦ä¸º 200 å­—èŠ‚ï¼Œå› æ­¤ B æœŸæœ›ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„åºå·ä¸º 701ï¼ŒB å‘é€ç»™ A çš„ç¡®è®¤æŠ¥æ–‡æ®µä¸­ç¡®è®¤å·å°±ä¸º 701ã€‚\næ•°æ®åç§»ï¼šæŒ‡çš„æ˜¯æ•°æ®éƒ¨åˆ†è·ç¦»æŠ¥æ–‡æ®µèµ·å§‹å¤„çš„åç§»é‡ï¼Œå®é™…ä¸ŠæŒ‡çš„æ˜¯é¦–éƒ¨çš„é•¿åº¦ã€‚\næ§åˆ¶ä½ï¼šå…«ä½ä»å·¦åˆ°å³åˆ†åˆ«æ˜¯ CWRï¼ŒECEï¼ŒURGï¼ŒACKï¼ŒPSHï¼ŒRSTï¼ŒSYNï¼ŒFINã€‚\nCWRï¼šCWR æ ‡å¿—ä¸åé¢çš„ ECE æ ‡å¿—éƒ½ç”¨äº IP é¦–éƒ¨çš„ ECN å­—æ®µï¼ŒECE æ ‡å¿—ä¸º 1 æ—¶ï¼Œåˆ™é€šçŸ¥å¯¹æ–¹å·²å°†æ‹¥å¡çª—å£ç¼©å°ï¼›\nECEï¼šè‹¥å…¶å€¼ä¸º 1 åˆ™ä¼šé€šçŸ¥å¯¹æ–¹ï¼Œä»å¯¹æ–¹åˆ°è¿™è¾¹çš„ç½‘ç»œæœ‰é˜»å¡ã€‚åœ¨æ”¶åˆ°æ•°æ®åŒ…çš„ IP é¦–éƒ¨ä¸­ ECN ä¸º 1 æ—¶å°† TCP é¦–éƒ¨ä¸­çš„ ECE è®¾ä¸º 1ï¼›\nURGï¼šè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤ºåŒ…ä¸­æœ‰éœ€è¦ç´§æ€¥å¤„ç†çš„æ•°æ®ï¼Œå¯¹äºéœ€è¦ç´§æ€¥å¤„ç†çš„æ•°æ®ï¼Œä¸åé¢çš„ç´§æ€¥æŒ‡é’ˆæœ‰å…³ï¼›\nACKï¼šè¯¥ä½è®¾ä¸º 1ï¼Œç¡®è®¤åº”ç­”çš„å­—æ®µæœ‰æ•ˆï¼ŒTCPè§„å®šé™¤äº†æœ€åˆå»ºç«‹è¿æ¥æ—¶çš„ SYN åŒ…ä¹‹å¤–è¯¥ä½å¿…é¡»è®¾ä¸º 1ï¼›\nPSHï¼šè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤ºéœ€è¦å°†æ”¶åˆ°çš„æ•°æ®ç«‹åˆ»ä¼ ç»™ä¸Šå±‚åº”ç”¨åè®®ï¼Œè‹¥è®¾ä¸º 0ï¼Œåˆ™å…ˆå°†æ•°æ®è¿›è¡Œç¼“å­˜ï¼›\nRSTï¼šè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤º TCP è¿æ¥å‡ºç°å¼‚å¸¸å¿…é¡»å¼ºåˆ¶æ–­å¼€è¿æ¥ï¼›\nSYNï¼šç”¨äºå»ºç«‹è¿æ¥ï¼Œè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤ºå¸Œæœ›å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨å…¶åºåˆ—å·çš„å­—æ®µè¿›è¡Œåºåˆ—å·åˆå€¼è®¾å®šï¼›\nFINï¼šè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤ºä»Šåä¸å†æœ‰æ•°æ®å‘é€ï¼Œå¸Œæœ›æ–­å¼€è¿æ¥ã€‚å½“é€šä¿¡ç»“æŸå¸Œæœ›æ–­å¼€è¿æ¥æ—¶ï¼Œé€šä¿¡åŒæ–¹çš„ä¸»æœºä¹‹é—´å°±å¯ä»¥ç›¸äº’äº¤æ¢ FIN ä½ç½®ä¸º 1 çš„ TCP æ®µã€‚\næ¯ä¸ªä¸»æœºåˆå¯¹å¯¹æ–¹çš„ FIN åŒ…è¿›è¡Œç¡®è®¤åº”ç­”ä¹‹åå¯ä»¥æ–­å¼€è¿æ¥ã€‚ä¸è¿‡ï¼Œä¸»æœºæ”¶åˆ° FIN è®¾ç½®ä¸º 1 çš„ TCP æ®µä¹‹åä¸å¿…é©¬ä¸Šå›å¤ä¸€ä¸ª FIN åŒ…ï¼Œè€Œæ˜¯å¯ä»¥ç­‰åˆ°ç¼“å†²åŒºä¸­çš„æ‰€æœ‰æ•°æ®éƒ½å› ä¸ºå·²æˆåŠŸå‘é€è€Œè¢«è‡ªåŠ¨åˆ é™¤ä¹‹åå†å‘ FIN åŒ…ï¼›\nçª—å£ï¼šçª—å£å€¼ä½œä¸ºæ¥æ”¶æ–¹è®©å‘é€æ–¹è®¾ç½®å…¶å‘é€çª—å£çš„ä¾æ®ã€‚ä¹‹æ‰€ä»¥è¦æœ‰è¿™ä¸ªé™åˆ¶ï¼Œæ˜¯å› ä¸ºæ¥æ”¶æ–¹çš„æ•°æ®ç¼“å­˜ç©ºé—´æ˜¯æœ‰é™çš„ã€‚\n3ã€ä»€ä¹ˆæ˜¯ TCP çš„ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ï¼Ÿ TCP æ˜¯ä¸€ç§é¢å‘è¿æ¥çš„å•æ’­åè®®ï¼Œåœ¨å‘é€æ•°æ®å‰ï¼Œé€šä¿¡åŒæ–¹å¿…é¡»åœ¨å½¼æ­¤é—´å»ºç«‹ä¸€æ¡è¿æ¥ã€‚æ‰€è°“çš„â€œè¿æ¥â€ï¼Œå…¶å®æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„å†…å­˜é‡Œä¿å­˜çš„ä¸€ä»½å…³äºå¯¹æ–¹çš„ä¿¡æ¯ï¼Œå¦‚ IP åœ°å€ã€ç«¯å£å·ç­‰ã€‚\nTCP å¯ä»¥çœ‹æˆæ˜¯ä¸€ç§å­—èŠ‚æµï¼Œå®ƒä¼šå¤„ç† IP å±‚æˆ–ä»¥ä¸‹çš„å±‚çš„ä¸¢åŒ…ã€é‡å¤ä»¥åŠé”™è¯¯é—®é¢˜ã€‚åœ¨è¿æ¥çš„å»ºç«‹è¿‡ç¨‹ä¸­ï¼ŒåŒæ–¹éœ€è¦äº¤æ¢ä¸€äº›è¿æ¥çš„å‚æ•°ã€‚è¿™äº›å‚æ•°å¯ä»¥æ”¾åœ¨ TCP å¤´éƒ¨ã€‚\nTCP æä¾›äº†ä¸€ç§å¯é ã€é¢å‘è¿æ¥ã€å­—èŠ‚æµã€ä¼ è¾“å±‚çš„æœåŠ¡ï¼Œé‡‡ç”¨ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼›é‡‡ç”¨å››æ¬¡æŒ¥æ‰‹æ¥å…³é—­ä¸€ä¸ªè¿æ¥ã€‚\nä¸€ä¸ª TCP è¿æ¥ç”±ä¸€ä¸ª 4 å…ƒç»„æ„æˆï¼Œåˆ†åˆ«æ˜¯ä¸¤ä¸ª IP åœ°å€å’Œä¸¤ä¸ªç«¯å£å·ã€‚ä¸€ä¸ªTCPè¿æ¥é€šå¸¸åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šå¯åŠ¨ã€æ•°æ®ä¼ è¾“ã€é€€å‡ºï¼ˆå…³é—­ï¼‰ã€‚\nå½“ TCP æ¥æ”¶åˆ°å¦ä¸€ç«¯çš„æ•°æ®æ—¶ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªç¡®è®¤ï¼Œä½†è¿™ä¸ªç¡®è®¤ä¸ä¼šç«‹å³å‘é€ï¼Œä¸€èˆ¬ä¼šå»¶è¿Ÿä¸€ä¼šï¼ˆæä¾›ç½‘ç»œåˆ©ç”¨ç‡è¿™éƒ¨åˆ†æœ‰è®²åˆ°ï¼‰ã€‚\nACK æ˜¯ç´¯ç§¯çš„ï¼Œä¸€ä¸ªç¡®è®¤å­—èŠ‚å· N çš„ ACK è¡¨ç¤ºæ‰€æœ‰ç›´åˆ° N çš„å­—èŠ‚ï¼ˆä¸åŒ…æ‹¬ Nï¼‰å·²ç»æˆåŠŸè¢«æ¥æ”¶äº†ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯å¦‚æœä¸€ä¸ª ACK ä¸¢å¤±ï¼Œå¾ˆå¯èƒ½åç»­çš„ ACK å°±è¶³ä»¥ç¡®è®¤å‰é¢çš„æŠ¥æ–‡æ®µäº†ã€‚\nä¸€ä¸ªå®Œæ•´çš„ TCP è¿æ¥æ˜¯åŒå‘å’Œå¯¹ç§°çš„ï¼Œæ•°æ®å¯ä»¥åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šå¹³ç­‰åœ°æµåŠ¨ã€‚ç»™ä¸Šå±‚åº”ç”¨ç¨‹åºæä¾›ä¸€ç§åŒå·¥æœåŠ¡ã€‚ä¸€æ—¦å»ºç«‹äº†ä¸€ä¸ªè¿æ¥ï¼Œè¿™ä¸ªè¿æ¥çš„ä¸€ä¸ªæ–¹å‘ä¸Šçš„æ¯ä¸ª TCP æŠ¥æ–‡æ®µéƒ½åŒ…å«äº†ç›¸åæ–¹å‘ä¸Šçš„æŠ¥æ–‡æ®µçš„ä¸€ä¸ª ACKã€‚\nåºåˆ—å·çš„ä½œç”¨æ˜¯ä½¿å¾—ä¸€ä¸ª TCP æ¥æ”¶ç«¯å¯ä¸¢å¼ƒé‡å¤çš„æŠ¥æ–‡æ®µï¼Œè®°å½•ä»¥æ‚ä¹±æ¬¡åºåˆ°è¾¾çš„æŠ¥æ–‡æ®µã€‚å› ä¸º TCP ä½¿ç”¨ IP æ¥ä¼ è¾“æŠ¥æ–‡æ®µï¼Œè€ŒIP ä¸æä¾›é‡å¤æ¶ˆé™¤æˆ–è€…ä¿è¯æ¬¡åºæ­£ç¡®çš„åŠŸèƒ½ã€‚\nå¦ä¸€æ–¹é¢ï¼ŒTCP æ˜¯ä¸€ä¸ªå­—èŠ‚æµåè®®ï¼Œç»ä¸ä¼šä»¥æ‚ä¹±çš„æ¬¡åºç»™ä¸Šå±‚ç¨‹åºå‘é€æ•°æ®ã€‚å› æ­¤ TCP æ¥æ”¶ç«¯ä¼šè¢«è¿«å…ˆä¿æŒå¤§åºåˆ—å·çš„æ•°æ®ä¸äº¤ç»™åº”ç”¨ç¨‹åºï¼Œç›´åˆ°ç¼ºå¤±çš„å°åºåˆ—å·çš„æŠ¥æ–‡æ®µè¢«å¡«æ»¡ã€‚\n4ã€TCP çš„ä¸‰æ¬¡æ¡æ‰‹ï¼ˆä¸ºä»€ä¹ˆä¸‰æ¬¡ï¼Ÿï¼‰ ä¸‰æ¬¡æ¡æ‰‹ï¼š\nå‡è®¾ A ä¸ºå®¢æˆ·ç«¯ï¼ŒB ä¸ºæœåŠ¡å™¨ç«¯ã€‚\né¦–å…ˆ B å¤„äº LISTENï¼ˆç›‘å¬ï¼‰çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·çš„è¿æ¥è¯·æ±‚ã€‚\n A å‘ B å‘é€è¿æ¥è¯·æ±‚æŠ¥æ–‡ï¼ŒSYN=1ï¼ŒACK=0ï¼Œé€‰æ‹©ä¸€ä¸ªåˆå§‹çš„åºå· xã€‚ B æ”¶åˆ°è¿æ¥è¯·æ±‚æŠ¥æ–‡ï¼Œå¦‚æœåŒæ„å»ºç«‹è¿æ¥ï¼Œåˆ™å‘ A å‘é€è¿æ¥ç¡®è®¤æŠ¥æ–‡ï¼ŒSYN=1ï¼ŒACK=1ï¼Œç¡®è®¤å·ä¸º x+1ï¼ŒåŒæ—¶ä¹Ÿé€‰æ‹©ä¸€ä¸ªåˆå§‹çš„åºå· yã€‚ A æ”¶åˆ° B çš„è¿æ¥ç¡®è®¤æŠ¥æ–‡åï¼Œè¿˜è¦å‘ B å‘å‡ºç¡®è®¤ï¼Œç¡®è®¤å·ä¸º y+1ï¼Œåºå·ä¸º x+1ã€‚  B æ”¶åˆ° A çš„ç¡®è®¤åï¼Œè¿æ¥å»ºç«‹ã€‚ ä¸ºä»€ä¹ˆä¸‰æ¬¡ï¼Ÿ 1ã€ç¬¬ä¸‰æ¬¡æ¡æ‰‹æ˜¯ä¸ºäº†é˜²æ­¢å¤±æ•ˆçš„è¿æ¥è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ï¼Œè®©æœåŠ¡å™¨é”™è¯¯æ‰“å¼€è¿æ¥ã€‚\n2ã€æ¢ä¸ªæ˜“äºç†è§£çš„è§†è§’æ¥çœ‹ä¸ºä»€ä¹ˆè¦ 3 æ¬¡æ¡æ‰‹ã€‚\nå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šä¿¡å‰è¦è¿›è¡Œè¿æ¥ï¼Œâ€œ3æ¬¡æ¡æ‰‹â€çš„ä½œç”¨å°±æ˜¯åŒæ–¹éƒ½èƒ½æ˜ç¡®è‡ªå·±å’Œå¯¹æ–¹çš„æ”¶ã€å‘èƒ½åŠ›æ˜¯æ­£å¸¸çš„ã€‚\nç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ç½‘ç»œåŒ…ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±èƒ½å¾—å‡ºç»“è®ºï¼šå®¢æˆ·ç«¯çš„å‘é€èƒ½åŠ›ã€æœåŠ¡ç«¯çš„æ¥æ”¶èƒ½åŠ›æ˜¯æ­£å¸¸çš„ã€‚\nç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡ç«¯å‘åŒ…ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°äº†ã€‚è¿™æ ·å®¢æˆ·ç«¯å°±èƒ½å¾—å‡ºç»“è®ºï¼šæœåŠ¡ç«¯çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›ï¼Œå®¢æˆ·ç«¯çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›æ˜¯æ­£å¸¸çš„ã€‚ä»å®¢æˆ·ç«¯çš„è§†è§’æ¥çœ‹ï¼Œæˆ‘æ¥åˆ°äº†æœåŠ¡ç«¯å‘é€è¿‡æ¥çš„å“åº”æ•°æ®åŒ…ï¼Œè¯´æ˜æœåŠ¡ç«¯æ¥æ”¶åˆ°äº†æˆ‘åœ¨ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶å‘é€çš„ç½‘ç»œåŒ…ï¼Œå¹¶ä¸”æˆåŠŸå‘é€äº†å“åº”æ•°æ®åŒ…ï¼Œè¿™å°±è¯´æ˜ï¼ŒæœåŠ¡ç«¯çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›æ­£å¸¸ã€‚è€Œå¦ä¸€æ–¹é¢ï¼Œæˆ‘æ”¶åˆ°äº†æœåŠ¡ç«¯çš„å“åº”æ•°æ®åŒ…ï¼Œè¯´æ˜æˆ‘ç¬¬ä¸€æ¬¡å‘é€çš„ç½‘ç»œåŒ…æˆåŠŸåˆ°è¾¾æœåŠ¡ç«¯ï¼Œè¿™æ ·ï¼Œæˆ‘è‡ªå·±çš„å‘é€å’Œæ¥æ”¶èƒ½åŠ›ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚\nç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘åŒ…ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±èƒ½å¾—å‡ºç»“è®ºï¼šå®¢æˆ·ç«¯çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›ï¼ŒæœåŠ¡ç«¯çš„å‘é€ã€æ¥æ”¶èƒ½åŠ›æ˜¯æ­£å¸¸çš„ã€‚ç¬¬ä¸€ã€äºŒæ¬¡æ¡æ‰‹åï¼ŒæœåŠ¡ç«¯å¹¶ä¸çŸ¥é“å®¢æˆ·ç«¯çš„æ¥æ”¶èƒ½åŠ›ä»¥åŠè‡ªå·±çš„å‘é€èƒ½åŠ›æ˜¯å¦æ­£å¸¸ã€‚\nè€Œåœ¨ç¬¬ä¸‰æ¬¡æ¡æ‰‹æ—¶ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°äº†å®¢æˆ·ç«¯å¯¹ç¬¬äºŒæ¬¡æ¡æ‰‹ä½œçš„å›åº”ã€‚ä»æœåŠ¡ç«¯çš„è§’åº¦ï¼Œæˆ‘åœ¨ç¬¬äºŒæ¬¡æ¡æ‰‹æ—¶çš„å“åº”æ•°æ®å‘é€å‡ºå»äº†ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘çš„å‘é€èƒ½åŠ›æ˜¯æ­£å¸¸çš„ã€‚è€Œå®¢æˆ·ç«¯çš„æ¥æ”¶èƒ½åŠ›ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚\nç»å†äº†ä¸Šé¢çš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½ç¡®è®¤äº†è‡ªå·±çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›æ˜¯æ­£å¸¸çš„ã€‚ä¹‹åå°±å¯ä»¥æ­£å¸¸é€šä¿¡äº†ã€‚\næ¯æ¬¡éƒ½æ˜¯æ¥æ”¶åˆ°æ•°æ®åŒ…çš„ä¸€æ–¹å¯ä»¥å¾—åˆ°ä¸€äº›ç»“è®ºï¼Œå‘é€çš„ä¸€æ–¹å…¶å®æ²¡æœ‰ä»»ä½•å¤´ç»ªã€‚æˆ‘è™½ç„¶æœ‰å‘åŒ…çš„åŠ¨ä½œï¼Œä½†æ˜¯æˆ‘æ€ä¹ˆçŸ¥é“æˆ‘æœ‰æ²¡æœ‰å‘å‡ºå»ï¼Œè€Œå¯¹æ–¹æœ‰æ²¡æœ‰æ¥æ”¶åˆ°å‘¢ï¼Ÿ\nè€Œä»ä¸Šé¢çš„è¿‡ç¨‹å¯ä»¥çœ‹åˆ°ï¼Œæœ€å°‘æ˜¯éœ€è¦ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹çš„ã€‚ä¸¤æ¬¡è¾¾ä¸åˆ°è®©åŒæ–¹éƒ½å¾—å‡ºè‡ªå·±ã€å¯¹æ–¹çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›éƒ½æ­£å¸¸çš„ç»“è®ºã€‚\nå…¶å®æ¯æ¬¡æ”¶åˆ°ç½‘ç»œåŒ…çš„ä¸€æ–¹è‡³å°‘æ˜¯å¯ä»¥å¾—åˆ°ï¼šå¯¹æ–¹çš„å‘é€ã€æˆ‘æ–¹çš„æ¥æ”¶æ˜¯æ­£å¸¸çš„ã€‚è€Œæ¯ä¸€æ­¥éƒ½æ˜¯æœ‰å…³è”çš„ï¼Œä¸‹ä¸€æ¬¡çš„â€œå“åº”â€æ˜¯ç”±äºç¬¬ä¸€æ¬¡çš„â€œè¯·æ±‚â€è§¦å‘ï¼Œå› æ­¤æ¯æ¬¡æ¡æ‰‹å…¶å®æ˜¯å¯ä»¥å¾—åˆ°é¢å¤–çš„ç»“è®ºçš„ã€‚\næ¯”å¦‚ç¬¬ä¸‰æ¬¡æ¡æ‰‹æ—¶ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°æ•°æ®åŒ…ï¼Œè¡¨æ˜çœ‹æœåŠ¡ç«¯åªèƒ½å¾—åˆ°å®¢æˆ·ç«¯çš„å‘é€èƒ½åŠ›ã€æœåŠ¡ç«¯çš„æ¥æ”¶èƒ½åŠ›æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯ç»“åˆç¬¬äºŒæ¬¡ï¼Œè¯´æ˜æœåŠ¡ç«¯åœ¨ç¬¬äºŒæ¬¡å‘é€çš„å“åº”åŒ…ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°äº†ï¼Œå¹¶ä¸”ä½œå‡ºäº†å“åº”ï¼Œä»è€Œå¾—åˆ°é¢å¤–çš„ç»“è®ºï¼šå®¢æˆ·ç«¯çš„æ¥æ”¶ã€æœåŠ¡ç«¯çš„å‘é€æ˜¯æ­£å¸¸çš„ã€‚\n5ã€TCP çš„å››æ¬¡æŒ¥æ‰‹ï¼ˆä¸ºä»€ä¹ˆå››æ¬¡ï¼Ÿï¼‰ å››æ¬¡æŒ¥æ‰‹ï¼š\n å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª FIN æ®µï¼Œå¹¶åŒ…å«ä¸€ä¸ªå¸Œæœ›æ¥æ”¶è€…çœ‹åˆ°çš„è‡ªå·±å½“å‰çš„åºåˆ—å· K. åŒæ—¶è¿˜åŒ…å«ä¸€ä¸ª ACK è¡¨ç¤ºç¡®è®¤å¯¹æ–¹æœ€è¿‘ä¸€æ¬¡å‘è¿‡æ¥çš„æ•°æ®ã€‚ æœåŠ¡ç«¯å°† K å€¼åŠ  1 ä½œä¸º ACK åºå·å€¼ï¼Œè¡¨æ˜æ”¶åˆ°äº†ä¸Šä¸€ä¸ªåŒ…ã€‚è¿™æ—¶ä¸Šå±‚çš„åº”ç”¨ç¨‹åºä¼šè¢«å‘ŠçŸ¥å¦ä¸€ç«¯å‘èµ·äº†å…³é—­æ“ä½œï¼Œé€šå¸¸è¿™å°†å¼•èµ·åº”ç”¨ç¨‹åºå‘èµ·è‡ªå·±çš„å…³é—­æ“ä½œã€‚ æœåŠ¡ç«¯å‘èµ·è‡ªå·±çš„ FIN æ®µï¼ŒACK=K+1, Seq=Lã€‚ å®¢æˆ·ç«¯ç¡®è®¤ã€‚è¿›å…¥ TIME-WAIT çŠ¶æ€ï¼Œç­‰å¾… 2 MSLï¼ˆæœ€å¤§æŠ¥æ–‡å­˜æ´»æ—¶é—´ï¼‰åé‡Šæ”¾è¿æ¥ã€‚ACK=L+1ã€‚  ä¸ºä»€ä¹ˆå»ºç«‹è¿æ¥æ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œå…³é—­è¿æ¥å´æ˜¯å››æ¬¡æŒ¥æ‰‹å‘¢ï¼Ÿ\n1ã€TCPè¿æ¥æ˜¯åŒå‘ä¼ è¾“çš„å¯¹ç­‰çš„æ¨¡å¼ï¼Œå°±æ˜¯è¯´åŒæ–¹éƒ½å¯ä»¥åŒæ—¶å‘å¯¹æ–¹å‘é€æˆ–æ¥æ”¶æ•°æ®ã€‚å½“æœ‰ä¸€æ–¹è¦å…³é—­è¿æ¥æ—¶ï¼Œä¼šå‘é€æŒ‡ä»¤å‘ŠçŸ¥å¯¹æ–¹ï¼Œæˆ‘è¦å…³é—­è¿æ¥äº†ã€‚\n2ã€è¿™æ—¶å¯¹æ–¹ä¼šå›ä¸€ä¸ªACKï¼Œæ­¤æ—¶ä¸€ä¸ªæ–¹å‘çš„è¿æ¥å…³é—­ã€‚ä½†æ˜¯å¦ä¸€ä¸ªæ–¹å‘ä»ç„¶å¯ä»¥ç»§ç»­ä¼ è¾“æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„ FIN æ ‡å¿—ï¼ŒçŸ¥é“å®¢æˆ·ç«¯æƒ³è¦æ–­å¼€è¿™æ¬¡è¿æ¥äº†ï¼Œä½†æ˜¯ï¼Œæˆ‘æœåŠ¡ç«¯ï¼Œæˆ‘è¿˜æƒ³å‘æ•°æ®å‘¢ï¼Ÿæˆ‘ç­‰åˆ°å‘é€å®Œäº†æ‰€æœ‰çš„æ•°æ®åï¼Œä¼šå‘é€ä¸€ä¸ª FIN æ®µæ¥å…³é—­æ­¤æ–¹å‘ä¸Šçš„è¿æ¥ã€‚æ¥æ”¶æ–¹å‘é€ ACKç¡®è®¤å…³é—­è¿æ¥ã€‚\næ³¨æ„ï¼Œæ¥æ”¶åˆ°FINæŠ¥æ–‡çš„ä¸€æ–¹åªèƒ½å›å¤ä¸€ä¸ªACK, å®ƒæ˜¯æ— æ³•é©¬ä¸Šè¿”å›å¯¹æ–¹ä¸€ä¸ªFINæŠ¥æ–‡æ®µçš„ï¼Œå› ä¸ºç»“æŸæ•°æ®ä¼ è¾“çš„â€œæŒ‡ä»¤â€æ˜¯ä¸Šå±‚åº”ç”¨å±‚ç»™å‡ºçš„ï¼Œæˆ‘åªæ˜¯ä¸€ä¸ªâ€œæ¬è¿å·¥â€ï¼Œæˆ‘æ— æ³•äº†è§£â€œä¸Šå±‚çš„æ„å¿—â€ã€‚\n3ã€å®¢æˆ·ç«¯å‘é€äº† FIN è¿æ¥é‡Šæ”¾æŠ¥æ–‡ä¹‹åï¼ŒæœåŠ¡å™¨æ”¶åˆ°äº†è¿™ä¸ªæŠ¥æ–‡ï¼Œå°±è¿›å…¥äº† CLOSE-WAIT çŠ¶æ€ã€‚è¿™ä¸ªçŠ¶æ€æ˜¯ä¸ºäº†è®©æœåŠ¡å™¨ç«¯å‘é€è¿˜æœªä¼ é€å®Œæ¯•çš„æ•°æ®ï¼Œä¼ é€å®Œæ¯•ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå‘é€ FIN è¿æ¥é‡Šæ”¾æŠ¥æ–‡ã€‚\n4ã€å› ä¸ºæœåŠ¡ç«¯åœ¨ LISTEN çŠ¶æ€ä¸‹ï¼Œæ”¶åˆ°å»ºç«‹è¿æ¥è¯·æ±‚çš„ SYN æŠ¥æ–‡åï¼ŒæŠŠ ACK å’Œ SYN æ”¾åœ¨ä¸€ä¸ªæŠ¥æ–‡é‡Œå‘é€ç»™å®¢æˆ·ç«¯ã€‚è€Œå…³é—­è¿æ¥æ—¶ï¼Œå½“æ”¶åˆ°å¯¹æ–¹çš„ FIN æŠ¥æ–‡æ—¶ï¼Œä»…ä»…è¡¨ç¤ºå¯¹æ–¹ä¸å†å‘é€æ•°æ®äº†ä½†æ˜¯è¿˜èƒ½æ¥æ”¶æ•°æ®ï¼Œå·±æ–¹æ˜¯å¦ç°åœ¨å…³é—­å‘é€æ•°æ®é€šé“ï¼Œéœ€è¦ä¸Šå±‚åº”ç”¨æ¥å†³å®šï¼Œå› æ­¤ï¼Œå·±æ–¹ ACK å’Œ FIN ä¸€èˆ¬éƒ½ä¼šåˆ†å¼€å‘ã€‚\nTIME_WAIT\nå®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡å™¨ç«¯çš„ FIN æŠ¥æ–‡åè¿›å…¥æ­¤çŠ¶æ€ï¼Œæ­¤æ—¶å¹¶ä¸æ˜¯ç›´æ¥è¿›å…¥ CLOSED çŠ¶æ€ï¼Œè¿˜éœ€è¦ç­‰å¾…ä¸€ä¸ªæ—¶é—´è®¡æ—¶å™¨è®¾ç½®çš„æ—¶é—´ 2MSLï¼ˆmaximum segment lifetimeï¼‰ã€‚è¿™ä¹ˆåšæœ‰ä¸¤ä¸ªç†ç”±ï¼š\n ç¡®ä¿æœ€åä¸€ä¸ªç¡®è®¤æŠ¥æ–‡èƒ½å¤Ÿåˆ°è¾¾ã€‚å¦‚æœ B æ²¡æ”¶åˆ° A å‘é€æ¥çš„ç¡®è®¤æŠ¥æ–‡ï¼Œé‚£ä¹ˆå°±ä¼šé‡æ–°å‘é€è¿æ¥é‡Šæ”¾è¯·æ±‚æŠ¥æ–‡ï¼ŒA ç­‰å¾…ä¸€æ®µæ—¶é—´å°±æ˜¯ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚ï¼ˆserverç«¯å‘é€å…³é—­è¿æ¥çš„FINæŠ¥æ–‡ä¹‹åï¼Œå®ƒéœ€è¦ç­‰å¾…clientå‘é€ä¸€ä¸ªç¡®è®¤æŠ¥æ–‡ï¼Œå¦‚æœè¿™ä¸ªç¡®è®¤æŠ¥æ–‡è¢«ä¸¢å¤±ï¼Œserverç«¯ä¼šé‡å‘FINæŠ¥æ–‡ï¼Œclientç«¯å¤„äºTIME_WAITçŠ¶æ€è¿˜èƒ½å¤Ÿå†æ¬¡å›å¤ä¸€ä¸ªç¡®è®¤æŠ¥æ–‡ï¼‰ ç­‰å¾…ä¸€æ®µæ—¶é—´æ˜¯ä¸ºäº†è®©æœ¬è¿æ¥æŒç»­æ—¶é—´å†…æ‰€äº§ç”Ÿçš„æ‰€æœ‰æŠ¥æ–‡éƒ½ä»ç½‘ç»œä¸­æ¶ˆå¤±ï¼Œä½¿å¾—ä¸‹ä¸€ä¸ªæ–°çš„è¿æ¥ä¸ä¼šå‡ºç°æ—§çš„è¿æ¥è¯·æ±‚æŠ¥æ–‡ã€‚  6ã€TCP çŸ­è¿æ¥å’Œé•¿è¿æ¥çš„åŒºåˆ« çŸ­è¿æ¥ï¼šClient å‘ Server å‘é€æ¶ˆæ¯ï¼ŒServer å›åº” Clientï¼Œç„¶åä¸€æ¬¡è¯»å†™å°±å®Œæˆäº†ï¼Œè¿™æ—¶å€™åŒæ–¹ä»»ä½•ä¸€ä¸ªéƒ½å¯ä»¥å‘èµ· close æ“ä½œï¼Œä¸è¿‡ä¸€èˆ¬éƒ½æ˜¯ Client å…ˆå‘èµ· close æ“ä½œã€‚çŸ­è¿æ¥ä¸€èˆ¬åªä¼šåœ¨ Client/Server é—´ä¼ é€’ä¸€æ¬¡è¯»å†™æ“ä½œã€‚\nçŸ­è¿æ¥çš„ä¼˜ç‚¹ï¼šç®¡ç†èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå»ºç«‹å­˜åœ¨çš„è¿æ¥éƒ½æ˜¯æœ‰ç”¨çš„è¿æ¥ï¼Œä¸éœ€è¦é¢å¤–çš„æ§åˆ¶æ‰‹æ®µã€‚\né•¿è¿æ¥ï¼šClient ä¸ Server å®Œæˆä¸€æ¬¡è¯»å†™ä¹‹åï¼Œå®ƒä»¬ä¹‹é—´çš„è¿æ¥å¹¶ä¸ä¼šä¸»åŠ¨å…³é—­ï¼Œåç»­çš„è¯»å†™æ“ä½œä¼šç»§ç»­ä½¿ç”¨è¿™ä¸ªè¿æ¥ã€‚\nåœ¨é•¿è¿æ¥çš„åº”ç”¨åœºæ™¯ä¸‹ï¼ŒClient ç«¯ä¸€èˆ¬ä¸ä¼šä¸»åŠ¨å…³é—­å®ƒä»¬ä¹‹é—´çš„è¿æ¥ï¼ŒClient ä¸ Server ä¹‹é—´çš„è¿æ¥å¦‚æœä¸€ç›´ä¸å…³é—­çš„è¯ï¼Œéšç€å®¢æˆ·ç«¯è¿æ¥è¶Šæ¥è¶Šå¤šï¼ŒServer å‹åŠ›ä¹Ÿè¶Šæ¥è¶Šå¤§ï¼Œè¿™æ—¶å€™ Server ç«¯éœ€è¦é‡‡å–ä¸€äº›ç­–ç•¥ï¼Œå¦‚å…³é—­ä¸€äº›é•¿æ—¶é—´æ²¡æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿçš„è¿æ¥ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸€äº›æ¶æ„è¿æ¥å¯¼è‡´ Server ç«¯æœåŠ¡å—æŸï¼›å¦‚æœæ¡ä»¶å†å…è®¸å¯ä»¥ä»¥å®¢æˆ·ç«¯ä¸ºé¢—ç²’åº¦ï¼Œé™åˆ¶æ¯ä¸ªå®¢æˆ·ç«¯çš„æœ€å¤§é•¿è¿æ¥æ•°ï¼Œä»è€Œé¿å…æŸä¸ªå®¢æˆ·ç«¯è¿ç´¯åç«¯çš„æœåŠ¡ã€‚\né•¿è¿æ¥å’ŒçŸ­è¿æ¥çš„äº§ç”Ÿåœ¨äº Client å’Œ Server é‡‡å–çš„å…³é—­ç­–ç•¥ï¼Œå…·ä½“çš„åº”ç”¨åœºæ™¯é‡‡ç”¨å…·ä½“çš„ç­–ç•¥ã€‚\nä»€ä¹ˆæ—¶å€™ç”¨é•¿è¿æ¥ï¼ŒçŸ­è¿æ¥ï¼Ÿ\né•¿è¿æ¥å¤šç”¨äºæ“ä½œé¢‘ç¹ï¼Œç‚¹å¯¹ç‚¹çš„é€šè®¯ï¼Œè€Œä¸”è¿æ¥æ•°ä¸èƒ½å¤ªå¤šæƒ…å†µï¼Œã€‚æ¯ä¸ªTCPè¿æ¥éƒ½éœ€è¦ä¸‰æ­¥æ¡æ‰‹ï¼Œè¿™éœ€è¦æ—¶é—´ï¼Œå¦‚æœæ¯ä¸ªæ“ä½œéƒ½æ˜¯å…ˆè¿æ¥ï¼Œå†æ“ä½œçš„è¯é‚£ä¹ˆå¤„ç†é€Ÿåº¦ä¼šé™ä½å¾ˆå¤šï¼Œæ‰€ä»¥æ¯ä¸ªæ“ä½œå®Œåéƒ½ä¸æ–­å¼€ï¼Œæ¬¡å¤„ç†æ—¶ç›´æ¥å‘é€æ•°æ®åŒ…å°±OKäº†ï¼Œä¸ç”¨å»ºç«‹TCPè¿æ¥ã€‚ä¾‹å¦‚ï¼šæ•°æ®åº“çš„è¿æ¥ç”¨é•¿è¿æ¥ï¼Œ å¦‚æœç”¨çŸ­è¿æ¥é¢‘ç¹çš„é€šä¿¡ä¼šé€ æˆsocketé”™è¯¯ï¼Œè€Œä¸”é¢‘ç¹çš„socket åˆ›å»ºä¹Ÿæ˜¯å¯¹èµ„æºçš„æµªè´¹ã€‚\nè€ŒåƒWEBç½‘ç«™çš„httpæœåŠ¡ä¸€èˆ¬éƒ½ç”¨çŸ­é“¾æ¥ï¼Œå› ä¸ºé•¿è¿æ¥å¯¹äºæœåŠ¡ç«¯æ¥è¯´ä¼šè€—è´¹ä¸€å®šçš„èµ„æºï¼Œè€ŒåƒWEBç½‘ç«™è¿™ä¹ˆé¢‘ç¹çš„æˆåƒä¸Šä¸‡ç”šè‡³ä¸Šäº¿å®¢æˆ·ç«¯çš„è¿æ¥ç”¨çŸ­è¿æ¥ä¼šæ›´çœä¸€äº›èµ„æºï¼Œå¦‚æœç”¨é•¿è¿æ¥ï¼Œè€Œä¸”åŒæ—¶æœ‰æˆåƒä¸Šä¸‡çš„ç”¨æˆ·ï¼Œå¦‚æœæ¯ä¸ªç”¨æˆ·éƒ½å ç”¨ä¸€ä¸ªè¿æ¥çš„è¯ï¼Œé‚£å¯æƒ³è€ŒçŸ¥å§ã€‚æ‰€ä»¥å¹¶å‘é‡å¤§ï¼Œä½†æ¯ä¸ªç”¨æˆ·æ— éœ€é¢‘ç¹æ“ä½œæƒ…å†µä¸‹éœ€ç”¨çŸ­è¿å¥½ã€‚\n7ã€TCPç²˜åŒ…ã€æ‹†åŒ…åŠè§£å†³åŠæ³• 7.1 ä¸ºä»€ä¹ˆå¸¸è¯´ TCP æœ‰ç²˜åŒ…å’Œæ‹†åŒ…çš„é—®é¢˜è€Œä¸è¯´ UDP ï¼Ÿ ç”±å‰ä¸¤èŠ‚å¯çŸ¥ï¼ŒUDP æ˜¯åŸºäºæŠ¥æ–‡å‘é€çš„ï¼ŒUDPé¦–éƒ¨é‡‡ç”¨äº† 16bit æ¥æŒ‡ç¤º UDP æ•°æ®æŠ¥æ–‡çš„é•¿åº¦ï¼Œå› æ­¤åœ¨åº”ç”¨å±‚èƒ½å¾ˆå¥½çš„å°†ä¸åŒçš„æ•°æ®æŠ¥æ–‡åŒºåˆ†å¼€ï¼Œä»è€Œé¿å…ç²˜åŒ…å’Œæ‹†åŒ…çš„é—®é¢˜ã€‚\nè€Œ TCP æ˜¯åŸºäºå­—èŠ‚æµçš„ï¼Œè™½ç„¶åº”ç”¨å±‚å’Œ TCP ä¼ è¾“å±‚ä¹‹é—´çš„æ•°æ®äº¤äº’æ˜¯å¤§å°ä¸ç­‰çš„æ•°æ®å—ï¼Œä½†æ˜¯ TCP å¹¶æ²¡æœ‰æŠŠè¿™äº›æ•°æ®å—åŒºåˆ†è¾¹ç•Œï¼Œä»…ä»…æ˜¯ä¸€è¿ä¸²æ²¡æœ‰ç»“æ„çš„å­—èŠ‚æµï¼›å¦å¤–ä» TCP çš„å¸§ç»“æ„ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨ TCP çš„é¦–éƒ¨æ²¡æœ‰è¡¨ç¤ºæ•°æ®é•¿åº¦çš„å­—æ®µï¼ŒåŸºäºä¸Šé¢ä¸¤ç‚¹ï¼Œåœ¨ä½¿ç”¨ TCP ä¼ è¾“æ•°æ®æ—¶ï¼Œæ‰æœ‰ç²˜åŒ…æˆ–è€…æ‹†åŒ…ç°è±¡å‘ç”Ÿçš„å¯èƒ½ã€‚\n7.2 ä»€ä¹ˆæ˜¯ç²˜åŒ…ã€æ‹†åŒ…ï¼Ÿ å‡è®¾ Client å‘ Server è¿ç»­å‘é€äº†ä¸¤ä¸ªæ•°æ®åŒ…ï¼Œç”¨ packet1 å’Œ packet2 æ¥è¡¨ç¤ºï¼Œé‚£ä¹ˆæœåŠ¡ç«¯æ”¶åˆ°çš„æ•°æ®å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼Œç°åˆ—ä¸¾å¦‚ä¸‹ï¼š\nç¬¬ä¸€ç§æƒ…å†µï¼Œæ¥æ”¶ç«¯æ­£å¸¸æ”¶åˆ°ä¸¤ä¸ªæ•°æ®åŒ…ï¼Œå³æ²¡æœ‰å‘ç”Ÿæ‹†åŒ…å’Œç²˜åŒ…çš„ç°è±¡ã€‚\nç¬¬äºŒç§æƒ…å†µï¼Œæ¥æ”¶ç«¯åªæ”¶åˆ°ä¸€ä¸ªæ•°æ®åŒ…ï¼Œä½†æ˜¯è¿™ä¸€ä¸ªæ•°æ®åŒ…ä¸­åŒ…å«äº†å‘é€ç«¯å‘é€çš„ä¸¤ä¸ªæ•°æ®åŒ…çš„ä¿¡æ¯ï¼Œè¿™ç§ç°è±¡å³ä¸ºç²˜åŒ…ã€‚è¿™ç§æƒ…å†µç”±äºæ¥æ”¶ç«¯ä¸çŸ¥é“è¿™ä¸¤ä¸ªæ•°æ®åŒ…çš„ç•Œé™ï¼Œæ‰€ä»¥å¯¹äºæ¥æ”¶ç«¯æ¥è¯´å¾ˆéš¾å¤„ç†ã€‚\nç¬¬ä¸‰ç§æƒ…å†µï¼Œè¿™ç§æƒ…å†µæœ‰ä¸¤ç§è¡¨ç°å½¢å¼ï¼Œå¦‚ä¸‹å›¾ã€‚æ¥æ”¶ç«¯æ”¶åˆ°äº†ä¸¤ä¸ªæ•°æ®åŒ…ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ•°æ®åŒ…è¦ä¹ˆæ˜¯ä¸å®Œæ•´çš„ï¼Œè¦ä¹ˆå°±æ˜¯å¤šå‡ºæ¥ä¸€å—ï¼Œè¿™ç§æƒ…å†µå³å‘ç”Ÿäº†æ‹†åŒ…å’Œç²˜åŒ…ã€‚è¿™ä¸¤ç§æƒ…å†µå¦‚æœä¸åŠ ç‰¹æ®Šå¤„ç†ï¼Œå¯¹äºæ¥æ”¶ç«¯åŒæ ·æ˜¯ä¸å¥½å¤„ç†çš„ã€‚\n7.3 ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿ TCP ç²˜åŒ…ã€æ‹†åŒ…ï¼Ÿ  è¦å‘é€çš„æ•°æ®å¤§äº TCP å‘é€ç¼“å†²åŒºå‰©ä½™ç©ºé—´å¤§å°ï¼Œå°†ä¼šå‘ç”Ÿæ‹†åŒ…ã€‚ å¾…å‘é€æ•°æ®å¤§äº MSSï¼ˆæœ€å¤§æŠ¥æ–‡é•¿åº¦ï¼‰ï¼ŒTCP åœ¨ä¼ è¾“å‰å°†è¿›è¡Œæ‹†åŒ…ã€‚ è¦å‘é€çš„æ•°æ®å°äº TCP å‘é€ç¼“å†²åŒºçš„å¤§å°ï¼ŒTCP å°†å¤šæ¬¡å†™å…¥ç¼“å†²åŒºçš„æ•°æ®ä¸€æ¬¡å‘é€å‡ºå»ï¼Œå°†ä¼šå‘ç”Ÿç²˜åŒ…ã€‚ æ¥æ”¶æ•°æ®ç«¯çš„åº”ç”¨å±‚æ²¡æœ‰åŠæ—¶è¯»å–æ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå°†å‘ç”Ÿç²˜åŒ…ã€‚  7.4 ç²˜åŒ…ã€æ‹†åŒ…è§£å†³åŠæ³• ç”±äº TCP æœ¬èº«æ˜¯é¢å‘å­—èŠ‚æµçš„ï¼Œæ— æ³•ç†è§£ä¸Šå±‚çš„ä¸šåŠ¡æ•°æ®ï¼Œæ‰€ä»¥åœ¨åº•å±‚æ˜¯æ— æ³•ä¿è¯æ•°æ®åŒ…ä¸è¢«æ‹†åˆ†å’Œé‡ç»„çš„ï¼Œè¿™ä¸ªé—®é¢˜åªèƒ½é€šè¿‡ä¸Šå±‚çš„åº”ç”¨åè®®æ ˆè®¾è®¡æ¥è§£å†³ï¼Œæ ¹æ®ä¸šç•Œçš„ä¸»æµåè®®çš„è§£å†³æ–¹æ¡ˆï¼Œå½’çº³å¦‚ä¸‹ï¼š\n æ¶ˆæ¯å®šé•¿ï¼šå‘é€ç«¯å°†æ¯ä¸ªæ•°æ®åŒ…å°è£…ä¸ºå›ºå®šé•¿åº¦ï¼ˆä¸å¤Ÿçš„å¯ä»¥é€šè¿‡è¡¥ 0 å¡«å……ï¼‰ï¼Œè¿™æ ·æ¥æ”¶ç«¯æ¯æ¬¡æ¥æ”¶ç¼“å†²åŒºä¸­è¯»å–å›ºå®šé•¿åº¦çš„æ•°æ®å°±è‡ªç„¶è€Œç„¶çš„æŠŠæ¯ä¸ªæ•°æ®åŒ…æ‹†åˆ†å¼€æ¥ã€‚ è®¾ç½®æ¶ˆæ¯è¾¹ç•Œï¼šæœåŠ¡ç«¯ä»ç½‘ç»œæµä¸­æŒ‰æ¶ˆæ¯è¾¹ç•Œåˆ†ç¦»å‡ºæ¶ˆæ¯å†…å®¹ã€‚åœ¨åŒ…å°¾å¢åŠ å›è½¦æ¢è¡Œç¬¦è¿›è¡Œåˆ†å‰²ï¼Œä¾‹å¦‚ FTP åè®®ã€‚ å°†æ¶ˆæ¯åˆ†ä¸ºæ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ï¼šæ¶ˆæ¯å¤´ä¸­åŒ…å«è¡¨ç¤ºæ¶ˆæ¯æ€»é•¿åº¦ï¼ˆæˆ–è€…æ¶ˆæ¯ä½“é•¿åº¦ï¼‰çš„å­—æ®µã€‚ æ›´å¤æ‚çš„åº”ç”¨å±‚åè®®æ¯”å¦‚ Netty ä¸­å®ç°çš„ä¸€äº›åè®®éƒ½å¯¹ç²˜åŒ…ã€æ‹†åŒ…åšäº†å¾ˆå¥½çš„å¤„ç†ã€‚  æ¨è TCPç²˜åŒ…ã€æ‹†åŒ…ä¸é€šä¿¡åè®®è¯¦è§£\rtcpçš„æ‹†åŒ…å’Œç²˜åŒ…\rä¸¤ç¯‡æ–‡ç« è¯¦ç»†æè¿°äº†ç²˜åŒ…æ‹†åŒ…ã€‚\n8ã€TCP å¯é ä¼ è¾“ TCP ä½¿ç”¨è¶…æ—¶é‡ä¼ æ¥å®ç°å¯é ä¼ è¾“ï¼šå¦‚æœä¸€ä¸ªå·²ç»å‘é€çš„æŠ¥æ–‡æ®µåœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼Œé‚£ä¹ˆå°±é‡ä¼ è¿™ä¸ªæŠ¥æ–‡æ®µã€‚\nä¸€ä¸ªæŠ¥æ–‡æ®µä»å‘é€å†åˆ°æ¥æ”¶åˆ°ç¡®è®¤æ‰€ç»è¿‡çš„æ—¶é—´ç§°ä¸ºå¾€è¿”æ—¶é—´ RTTï¼ŒåŠ æƒå¹³å‡å¾€è¿”æ—¶é—´ RTTs è®¡ç®—å¦‚ä¸‹ï¼š\nå…¶ä¸­ï¼Œ0 â‰¤ a ï¼œ 1ï¼ŒRTTs éšç€ a çš„å¢åŠ æ›´å®¹æ˜“å—åˆ° RTT çš„å½±å“ã€‚è¶…æ—¶æ—¶é—´ RTO åº”è¯¥ç•¥å¤§äº RTTsï¼ŒTCP ä½¿ç”¨çš„è¶…æ—¶æ—¶é—´è®¡ç®—å¦‚ä¸‹ï¼š\nå…¶ä¸­ RTTd ä¸ºåå·®çš„åŠ æƒå¹³å‡å€¼ã€‚\n9ã€TCP æ»‘åŠ¨çª—å£ çª—å£æ˜¯ç¼“å­˜çš„ä¸€éƒ¨åˆ†ï¼Œç”¨æ¥æš‚æ—¶å­˜æ”¾å­—èŠ‚æµã€‚å‘é€æ–¹å’Œæ¥æ”¶æ–¹å„æœ‰ä¸€ä¸ªçª—å£ï¼Œæ¥æ”¶æ–¹é€šè¿‡ TCP æŠ¥æ–‡æ®µä¸­çš„çª—å£å­—æ®µå‘Šè¯‰å‘é€æ–¹è‡ªå·±çš„çª—å£å¤§å°ï¼Œå‘é€æ–¹æ ¹æ®è¿™ä¸ªå€¼å’Œå…¶å®ƒä¿¡æ¯è®¾ç½®è‡ªå·±çš„çª—å£å¤§å°ã€‚\nå‘é€çª—å£å†…çš„å­—èŠ‚éƒ½å…è®¸è¢«å‘é€ï¼Œæ¥æ”¶çª—å£å†…çš„å­—èŠ‚éƒ½å…è®¸è¢«æ¥æ”¶ã€‚å¦‚æœå‘é€çª—å£å·¦éƒ¨çš„å­—èŠ‚å·²ç»å‘é€å¹¶ä¸”æ”¶åˆ°äº†ç¡®è®¤ï¼Œé‚£ä¹ˆå°±å°†å‘é€çª—å£å‘å³æ»‘åŠ¨ä¸€å®šè·ç¦»ï¼Œç›´åˆ°å·¦éƒ¨ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸æ˜¯å·²å‘é€å¹¶ä¸”å·²ç¡®è®¤çš„çŠ¶æ€ï¼›æ¥æ”¶çª—å£çš„æ»‘åŠ¨ç±»ä¼¼ï¼Œæ¥æ”¶çª—å£å·¦éƒ¨å­—èŠ‚å·²ç»å‘é€ç¡®è®¤å¹¶äº¤ä»˜ä¸»æœºï¼Œå°±å‘å³æ»‘åŠ¨æ¥æ”¶çª—å£ã€‚\næ¥æ”¶çª—å£åªä¼šå¯¹çª—å£å†…æœ€åä¸€ä¸ªæŒ‰åºåˆ°è¾¾çš„å­—èŠ‚è¿›è¡Œç¡®è®¤ï¼Œä¾‹å¦‚æ¥æ”¶çª—å£å·²ç»æ”¶åˆ°çš„å­—èŠ‚ä¸º {31, 34, 35}ï¼Œå…¶ä¸­ {31} æŒ‰åºåˆ°è¾¾ï¼Œè€Œ {34, 35} å°±ä¸æ˜¯ï¼Œå› æ­¤åªå¯¹å­—èŠ‚ 31 è¿›è¡Œç¡®è®¤ã€‚å‘é€æ–¹å¾—åˆ°ä¸€ä¸ªå­—èŠ‚çš„ç¡®è®¤ä¹‹åï¼Œå°±çŸ¥é“è¿™ä¸ªå­—èŠ‚ä¹‹å‰çš„æ‰€æœ‰å­—èŠ‚éƒ½å·²ç»è¢«æ¥æ”¶ã€‚\n10ã€TCP æµé‡æ§åˆ¶ æµé‡æ§åˆ¶æ˜¯ä¸ºäº†æ§åˆ¶å‘é€æ–¹å‘é€é€Ÿç‡ï¼Œä¿è¯æ¥æ”¶æ–¹æ¥å¾—åŠæ¥æ”¶ã€‚\næ¥æ”¶æ–¹å‘é€çš„ç¡®è®¤æŠ¥æ–‡ä¸­çš„çª—å£å­—æ®µå¯ä»¥ç”¨æ¥æ§åˆ¶å‘é€æ–¹çª—å£å¤§å°ï¼Œä»è€Œå½±å“å‘é€æ–¹çš„å‘é€é€Ÿç‡ã€‚å°†çª—å£å­—æ®µè®¾ç½®ä¸º 0ï¼Œåˆ™å‘é€æ–¹ä¸èƒ½å‘é€æ•°æ®ã€‚\nå®é™…ä¸Šï¼Œä¸ºäº†é¿å…æ­¤é—®é¢˜çš„äº§ç”Ÿï¼Œå‘é€ç«¯ä¸»æœºä¼šæ—¶ä¸æ—¶çš„å‘é€ä¸€ä¸ªå«åšçª—å£æ¢æµ‹çš„æ•°æ®æ®µï¼Œæ­¤æ•°æ®æ®µä»…åŒ…å«ä¸€ä¸ªå­—èŠ‚æ¥è·å–æœ€æ–°çš„çª—å£å¤§å°ä¿¡æ¯ã€‚\n11ã€TCP æ‹¥å¡æ§åˆ¶ å¦‚æœç½‘ç»œå‡ºç°æ‹¥å¡ï¼Œåˆ†ç»„å°†ä¼šä¸¢å¤±ï¼Œæ­¤æ—¶å‘é€æ–¹ä¼šç»§ç»­é‡ä¼ ï¼Œä»è€Œå¯¼è‡´ç½‘ç»œæ‹¥å¡ç¨‹åº¦æ›´é«˜ã€‚å› æ­¤å½“å‡ºç°æ‹¥å¡æ—¶ï¼Œåº”å½“æ§åˆ¶å‘é€æ–¹çš„é€Ÿç‡ã€‚è¿™ä¸€ç‚¹å’Œæµé‡æ§åˆ¶å¾ˆåƒï¼Œä½†æ˜¯å‡ºå‘ç‚¹ä¸åŒã€‚æµé‡æ§åˆ¶æ˜¯ä¸ºäº†è®©æ¥æ”¶æ–¹èƒ½æ¥å¾—åŠæ¥æ”¶ï¼Œè€Œæ‹¥å¡æ§åˆ¶æ˜¯ä¸ºäº†é™ä½æ•´ä¸ªç½‘ç»œçš„æ‹¥å¡ç¨‹åº¦ã€‚\nTCP ä¸»è¦é€šè¿‡å››ä¸ªç®—æ³•æ¥è¿›è¡Œæ‹¥å¡æ§åˆ¶ï¼š\næ…¢å¼€å§‹ã€æ‹¥å¡é¿å…ã€å¿«é‡ä¼ ã€å¿«æ¢å¤ã€‚\nå‘é€æ–¹éœ€è¦ç»´æŠ¤ä¸€ä¸ªå«åšæ‹¥å¡çª—å£ï¼ˆcwndï¼‰çš„çŠ¶æ€å˜é‡ï¼Œæ³¨æ„æ‹¥å¡çª—å£ä¸å‘é€æ–¹çª—å£çš„åŒºåˆ«ï¼šæ‹¥å¡çª—å£åªæ˜¯ä¸€ä¸ªçŠ¶æ€å˜é‡ï¼Œå®é™…å†³å®šå‘é€æ–¹èƒ½å‘é€å¤šå°‘æ•°æ®çš„æ˜¯å‘é€æ–¹çª—å£ã€‚\nä¸ºäº†ä¾¿äºè®¨è®ºï¼Œåšå¦‚ä¸‹å‡è®¾ï¼š\n æ¥æ”¶æ–¹æœ‰è¶³å¤Ÿå¤§çš„æ¥æ”¶ç¼“å­˜ï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿæµé‡æ§åˆ¶ï¼› è™½ç„¶ TCP çš„çª—å£åŸºäºå­—èŠ‚ï¼Œä½†æ˜¯è¿™é‡Œè®¾çª—å£çš„å¤§å°å•ä½ä¸ºæŠ¥æ–‡æ®µã€‚  11.1 æ…¢å¼€å§‹ä¸æ‹¥å¡é¿å… å‘é€çš„æœ€åˆæ‰§è¡Œæ…¢å¼€å§‹ï¼Œä»¤ cwnd = 1ï¼Œå‘é€æ–¹åªèƒ½å‘é€ 1 ä¸ªæŠ¥æ–‡æ®µï¼›å½“æ”¶åˆ°ç¡®è®¤åï¼Œå°† cwnd åŠ å€ï¼Œå› æ­¤ä¹‹åå‘é€æ–¹èƒ½å¤Ÿå‘é€çš„æŠ¥æ–‡æ®µæ•°é‡ä¸ºï¼š2ã€4ã€8 \u0026hellip;\næ³¨æ„åˆ°æ…¢å¼€å§‹æ¯ä¸ªè½®æ¬¡éƒ½å°† cwnd åŠ å€ï¼Œè¿™æ ·ä¼šè®© cwnd å¢é•¿é€Ÿåº¦éå¸¸å¿«ï¼Œä»è€Œä½¿å¾—å‘é€æ–¹å‘é€çš„é€Ÿåº¦å¢é•¿é€Ÿåº¦è¿‡å¿«ï¼Œç½‘ç»œæ‹¥å¡çš„å¯èƒ½æ€§ä¹Ÿå°±æ›´é«˜ã€‚è®¾ç½®ä¸€ä¸ªæ…¢å¼€å§‹é—¨é™ ssthreshï¼Œå½“ cwnd \u0026gt;= ssthresh æ—¶ï¼Œè¿›å…¥æ‹¥å¡é¿å…ï¼Œæ¯ä¸ªè½®æ¬¡åªå°† cwnd åŠ  1ã€‚\nå¦‚æœå‡ºç°äº†è¶…æ—¶ï¼Œåˆ™ä»¤ ssthresh = cwnd / 2ï¼Œç„¶åé‡æ–°æ‰§è¡Œæ…¢å¼€å§‹ã€‚\n11.2 å¿«é‡ä¼ ä¸å¿«æ¢å¤ åœ¨æ¥æ”¶æ–¹ï¼Œè¦æ±‚æ¯æ¬¡æ¥æ”¶åˆ°æŠ¥æ–‡æ®µéƒ½åº”è¯¥å¯¹æœ€åä¸€ä¸ªå·²æ”¶åˆ°çš„æœ‰åºæŠ¥æ–‡æ®µè¿›è¡Œç¡®è®¤ã€‚ä¾‹å¦‚å·²ç»æ¥æ”¶åˆ° M1 å’Œ M2ï¼Œæ­¤æ—¶æ”¶åˆ° M4ï¼Œåº”å½“å‘é€å¯¹ M2 çš„ç¡®è®¤ã€‚\nåœ¨å‘é€æ–¹ï¼Œå¦‚æœæ”¶åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤ï¼Œé‚£ä¹ˆå¯ä»¥çŸ¥é“ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µä¸¢å¤±ï¼Œæ­¤æ—¶æ‰§è¡Œå¿«é‡ä¼ ï¼Œç«‹å³é‡ä¼ ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µã€‚ä¾‹å¦‚æ”¶åˆ°ä¸‰ä¸ª M2ï¼Œåˆ™ M3 ä¸¢å¤±ï¼Œç«‹å³é‡ä¼  M3ã€‚\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªæ˜¯ä¸¢å¤±ä¸ªåˆ«æŠ¥æ–‡æ®µï¼Œè€Œä¸æ˜¯ç½‘ç»œæ‹¥å¡ã€‚å› æ­¤æ‰§è¡Œå¿«æ¢å¤ï¼Œä»¤ ssthresh = cwnd / 2 ï¼Œcwnd = ssthreshï¼Œæ³¨æ„åˆ°æ­¤æ—¶ç›´æ¥è¿›å…¥æ‹¥å¡é¿å…ã€‚\næ…¢å¼€å§‹å’Œå¿«æ¢å¤çš„å¿«æ…¢æŒ‡çš„æ˜¯ cwnd çš„è®¾å®šå€¼ï¼Œè€Œä¸æ˜¯ cwnd çš„å¢é•¿é€Ÿç‡ã€‚æ…¢å¼€å§‹ cwnd è®¾å®šä¸º 1ï¼Œè€Œå¿«æ¢å¤ cwnd è®¾å®šä¸º ssthreshã€‚\n12ã€æä¾›ç½‘ç»œåˆ©ç”¨ç‡ 12. 1 Nagle ç®—æ³• å‘é€ç«¯å³ä½¿è¿˜æœ‰åº”è¯¥å‘é€çš„æ•°æ®ï¼Œä½†å¦‚æœè¿™éƒ¨åˆ†æ•°æ®å¾ˆå°‘çš„è¯ï¼Œåˆ™è¿›è¡Œå»¶è¿Ÿå‘é€çš„ä¸€ç§å¤„ç†æœºåˆ¶ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯ä»…åœ¨ä¸‹åˆ—ä»»æ„ä¸€ç§æ¡ä»¶ä¸‹æ‰èƒ½å‘é€æ•°æ®ã€‚å¦‚æœä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆæš‚æ—¶ç­‰å¾…ä¸€æ®µæ—¶é—´ä»¥åå†è¿›è¡Œæ•°æ®å‘é€ã€‚\n å·²å‘é€çš„æ•°æ®éƒ½å·²ç»æ”¶åˆ°ç¡®è®¤åº”ç­”ã€‚ å¯ä»¥å‘é€æœ€å¤§æ®µé•¿åº¦çš„æ•°æ®æ—¶ã€‚  12. 2 å»¶è¿Ÿç¡®è®¤åº”ç­” æ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®ä¹‹åå¯ä»¥å¹¶ä¸ç«‹å³è¿”å›ç¡®è®¤åº”ç­”ï¼Œè€Œæ˜¯å»¶è¿Ÿä¸€æ®µæ—¶é—´çš„æœºåˆ¶ã€‚\n åœ¨æ²¡æœ‰æ”¶åˆ° 2*æœ€å¤§æ®µé•¿åº¦çš„æ•°æ®ä¸ºæ­¢ä¸åšç¡®è®¤åº”ç­”ã€‚ å…¶ä»–æƒ…å†µä¸‹ï¼Œæœ€å¤§å»¶è¿Ÿ 0.5ç§’ å‘é€ç¡®è®¤åº”ç­”ã€‚ TCP æ–‡ä»¶ä¼ è¾“ä¸­ï¼Œå¤§å¤šæ•°æ˜¯æ¯ä¸¤ä¸ªæ•°æ®æ®µè¿”å›ä¸€æ¬¡ç¡®è®¤åº”ç­”ã€‚  12. 3 æå¸¦åº”ç­” åœ¨ä¸€ä¸ª TCP åŒ…ä¸­æ—¢å‘é€æ•°æ®åˆå‘é€ç¡®è®¤åº”ç­”çš„ä¸€ç§æœºåˆ¶ï¼Œç”±æ­¤ï¼Œç½‘ç»œåˆ©ç”¨ç‡ä¼šæé«˜ï¼Œè®¡ç®—æœºçš„è´Ÿè·ä¹Ÿä¼šå‡è½»ï¼Œä½†æ˜¯è¿™ç§åº”ç­”å¿…é¡»ç­‰åˆ°åº”ç”¨å¤„ç†å®Œæ•°æ®å¹¶å°†ä½œä¸ºå›æ‰§çš„æ•°æ®è¿”å›ä¸ºæ­¢ã€‚\nå‚è€ƒé“¾æ¥ï¼š ä¸€æ–‡æå®š UDP å’Œ TCP é«˜é¢‘é¢è¯•é¢˜ï¼\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/tcp/%E5%B8%B8%E8%A7%81%E7%9F%A5%E8%AF%86%E7%82%B9/","series":["Manual"],"tags":["CS"],"title":"å¸¸è§çŸ¥è¯†ç‚¹"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨ï¼Ÿ\nç­”ï¼šè·³è¡¨è¿™ç§é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå€¼å¾—æ¯ä¸€ä¸ªç¨‹åºå‘˜æŒæ¡\rä¸ºä»€ä¹ˆä½¿ç”¨ziplistï¼Ÿ\nç­”ï¼šç›¸è¾ƒäºåŒé“¾è¡¨ï¼ŒèŠ‚çœäº†ä¸¤ä¸ªæŒ‡é’ˆçš„ç©ºé—´ã€‚ï¼ˆpre_entry_lengthå‰é©±æ•°æ®é¡¹çš„å¤§å°ã€‚å› ä¸ºä¸ç”¨æè¿°å‰é©±çš„æ•°æ®ç±»å‹ï¼Œæè¿°è¾ƒä¸ºç®€å•ï¼‰ã€‚ç›¸è¾ƒäºæ•°ç»„ï¼Œziplistçš„æ¯ä¸ªentryæ‰€å çš„å†…å­˜å¤§å°å¯ä»¥ä¸åŒï¼Œä¾¿äºèŠ‚çœç©ºé—´ã€‚\nä¸ºä»€ä¹ˆlist  hash  zset åœ¨æ•°æ®ä¸¤å¤§çš„æ—¶å€™ä¸å†ä½¿ç”¨ziplistï¼Ÿ\nç­”ï¼šéš¾ä»¥è·å¾—å¤§çš„è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚\nå‚è€ƒé“¾æ¥ å›¾è§£redisäº”ç§æ•°æ®ç»“æ„åº•å±‚å®ç°(åŠ¨å›¾å“¦)\rRedis æ•°æ®ç»“æ„ ziplist\rRedisæºç åˆ†æ-å‹ç¼©åˆ—è¡¨ziplist\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/redis/%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/","series":["Manual"],"tags":["Redis"],"title":"åº•å±‚æ•°æ®ç»“æ„"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"æ‚²è§‚é” å…±äº«é”ã€æ’ä»–é”\n å…±äº«é”ï¼Œä¹Ÿå°±æ˜¯å…¶ä»–äº‹åŠ¡å¯ä»¥å¹¶å‘è¯»ï¼ˆå…¶ä»–äº‹åŠ¡ä¹Ÿéœ€è¦åŠ å…±äº«é”ï¼‰ï¼Œä½†æ˜¯ä¸èƒ½å†™ã€‚\næ’å®ƒé”ï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½å¹¶å‘å†™ä¹Ÿä¸èƒ½å¹¶å‘è¯»ã€‚\n ä¹è§‚é” ä¹è§‚é”å…¶å®ä¹Ÿä¸æ˜¯å®é™…çš„é”ï¼Œç”šè‡³æ²¡æœ‰ç”¨åˆ°é”æ¥å®ç°å¹¶å‘æ§åˆ¶ï¼Œè€Œæ˜¯é‡‡å–å…¶ä»–æ–¹å¼æ¥åˆ¤æ–­èƒ½å¦ä¿®æ”¹æ•°æ®ã€‚ä¹è§‚é”ä¸€èˆ¬æ˜¯ç”¨æˆ·è‡ªå·±å®ç°çš„ä¸€ç§é”æœºåˆ¶ï¼Œè™½ç„¶æ²¡æœ‰ç”¨åˆ°å®é™…çš„é”ï¼Œä½†æ˜¯èƒ½äº§ç”ŸåŠ é”çš„æ•ˆæœã€‚\nä¹è§‚é”åŸºæœ¬éƒ½æ˜¯åŸºäº CASï¼ˆCompare and swapï¼‰ç®—æ³•æ¥å®ç°çš„ã€‚\nä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š\n ç‰ˆæœ¬å·æ ‡è®°ï¼šåœ¨è¡¨ä¸­æ–°å¢ä¸€ä¸ªå­—æ®µï¼šversionï¼Œç”¨äºä¿å­˜ç‰ˆæœ¬å·ã€‚è·å–æ•°æ®çš„æ—¶å€™åŒæ—¶è·å–ç‰ˆæœ¬å·ï¼Œç„¶åæ›´æ–°æ•°æ®çš„æ—¶å€™ç”¨ä»¥ä¸‹å‘½ä»¤:update xxx set version=version+1,â€¦ where â€¦ version=\u0026quot;old version\u0026quot; and ....ã€‚è¿™æ—¶å€™é€šè¿‡åˆ¤æ–­è¿”å›ç»“æœçš„å½±å“è¡Œæ•°æ˜¯å¦ä¸º0æ¥åˆ¤æ–­æ˜¯å¦æ›´æ–°æˆåŠŸï¼Œæ›´æ–°å¤±è´¥åˆ™è¯´æ˜æœ‰å…¶ä»–è¯·æ±‚å·²ç»æ›´æ–°äº†æ•°æ®äº†ã€‚ æ—¶é—´æˆ³æ ‡è®°ï¼šå’Œç‰ˆæœ¬å·ä¸€æ ·ï¼Œåªæ˜¯é€šè¿‡æ—¶é—´æˆ³æ¥åˆ¤æ–­ã€‚ä¸€èˆ¬æ¥è¯´å¾ˆå¤šæ•°æ®è¡¨éƒ½ä¼šæœ‰æ›´æ–°æ—¶é—´è¿™ä¸€ä¸ªå­—æ®µï¼Œé€šè¿‡è¿™ä¸ªå­—æ®µæ¥åˆ¤æ–­å°±ä¸ç”¨å†æ–°å¢ä¸€ä¸ªå­—æ®µäº†ã€‚ å¾…æ›´æ–°å­—æ®µï¼šå¦‚æœæ²¡æœ‰æ—¶é—´æˆ³å­—æ®µï¼Œè€Œä¸”ä¸æƒ³æ–°å¢å­—æ®µï¼Œé‚£å¯ä»¥è€ƒè™‘ç”¨å¾…æ›´æ–°å­—æ®µæ¥åˆ¤æ–­ï¼Œå› ä¸ºæ›´æ–°æ•°æ®ä¸€èˆ¬éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé‚£æ›´æ–°å‰å¯ä»¥æ‹¿è¦æ›´æ–°çš„å­—æ®µçš„æ—§å€¼å’Œæ•°æ®åº“çš„ç°å€¼è¿›è¡Œæ¯”å¯¹ï¼Œæ²¡æœ‰å˜åŒ–åˆ™æ›´æ–°ã€‚ æ‰€æœ‰å­—æ®µæ ‡è®°ï¼šæ•°æ®è¡¨æ‰€æœ‰å­—æ®µéƒ½ç”¨æ¥åˆ¤æ–­ã€‚è¿™ç§ç›¸å½“äºå°±ã€ä¸ä»…ä»…å¯¹æŸå‡ ä¸ªå­—æ®µåšåŠ é”äº†ï¼Œè€Œæ˜¯å¯¹æ•´ä¸ªæ•°æ®è¡ŒåŠ é”ï¼Œåªè¦æœ¬è¡Œæ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¸è¿›è¡Œæ›´æ–°ã€‚  æ€»ç»“ æ‚²è§‚é”å’Œä¹è§‚é”å¤§éƒ¨åˆ†åœºæ™¯ä¸‹å·®å¼‚ä¸å¤§ï¼Œä¸€äº›ç‹¬ç‰¹åœºæ™¯ä¸‹æœ‰ä¸€äº›å·®åˆ«ï¼Œä¸€èˆ¬æˆ‘ä»¬å¯ä»¥ä»å¦‚ä¸‹å‡ ä¸ªæ–¹é¢æ¥åˆ¤æ–­ï¼š\n1.å“åº”é€Ÿåº¦ï¼šå¦‚æœéœ€è¦éå¸¸é«˜çš„å“åº”é€Ÿåº¦ï¼Œå»ºè®®é‡‡ç”¨ä¹è§‚é”æ–¹æ¡ˆï¼ŒæˆåŠŸå°±æ‰§è¡Œï¼Œä¸æˆåŠŸå°±å¤±è´¥ï¼Œä¸éœ€è¦ç­‰å¾…å…¶ä»–å¹¶å‘å»é‡Šæ”¾é”\n2.å†²çªé¢‘ç‡ï¼šå¦‚æœå†²çªé¢‘ç‡éå¸¸é«˜ï¼Œå»ºè®®é‡‡ç”¨æ‚²è§‚é”ï¼Œä¿è¯æˆåŠŸç‡ï¼Œå¦‚æœå†²çªé¢‘ç‡å¤§ï¼Œä¹è§‚é”ä¼šéœ€è¦å¤šæ¬¡é‡è¯•æ‰èƒ½æˆåŠŸï¼Œä»£ä»·æ¯”è¾ƒå¤§\n3.é‡è¯•ä»£ä»·ï¼šå¦‚æœé‡è¯•ä»£ä»·å¤§ï¼Œå»ºè®®é‡‡ç”¨æ‚²è§‚é”\nå‚è€ƒé“¾æ¥ï¼š ä¹è§‚é”ä¸æ‚²è§‚é”å„è‡ªé€‚ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ\rä¸€æ–‡è¯»æ‡‚æ•°æ®åº“ä¸­çš„ä¹è§‚é”å’Œæ‚²è§‚é”å’ŒMVCC\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/mysql/%E6%82%B2%E8%A7%82%E9%94%81%E5%92%8C%E4%B9%90%E8%A7%82%E9%94%81/","series":["Manual"],"tags":["MySQL"],"title":"æ‚²è§‚é”å’Œä¹è§‚é”"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"æˆ‘ä»¬çŸ¥é“javaåœ¨è¿è¡Œçš„æ—¶å€™æœ‰ä¸¤ä¸ªåœ°æ–¹å¯èƒ½ç”¨åˆ°é‡æ’åºï¼Œä¸€ä¸ªæ˜¯ç¼–è¯‘å™¨ç¼–è¯‘çš„çš„æ—¶å€™ï¼Œä¸€ä¸ªæ˜¯å¤„ç†å™¨è¿è¡Œçš„æ—¶å€™ã€‚\né‚£ä¹ˆæˆ‘ä»¬å°±åº”è¯¥é—®é—®ä¸ºå•¥è¦ç”¨æŒ‡ä»¤é‡æ’åºå‘¢ï¼Ÿ\nç¼–è¯‘æœŸé‡æ’åºæœ‰å•¥å¥½å¤„ï¼Ÿ\nCPUè®¡ç®—çš„æ—¶å€™è¦è®¿é—®å€¼ï¼Œå¦‚æœå¸¸å¸¸åˆ©ç”¨åˆ°å¯„å­˜å™¨ä¸­å·²æœ‰çš„å€¼å°±ä¸ç”¨å»å†…å­˜è¯»å–äº†ï¼Œæ¯”å¦‚è¯´\nint a = 1; int b = 1; a = a + 1; b = b +1 ; å°±å¯èƒ½æ²¡æœ‰\nint a = 1; a = a + 1; int b = 1; b = b +1 ; æ€§èƒ½å¥½ï¼Œå› ä¸ºåè€…çš„aæˆ–bå¯èƒ½åœ¨å¯„å­˜å™¨ä¸­äº†ã€‚\nå¤„ç†å™¨ä¸ºå•¥è¦é‡æ’åºï¼Ÿ\nä¸€æ¡æ±‡ç¼–æŒ‡ä»¤çš„æ‰§è¡Œæ­¥éª¤ï¼š\n  å–æŒ‡ IF è¯‘ç å’Œå–å¯„å­˜å™¨æ“ä½œ ID æ‰§è¡Œæˆ–è€…æœ‰æ•ˆåœ°å€è®¡ç®— EX å­˜å‚¨å™¨è®¿é—® MEM å†™å› WB   åœ¨CPUå·¥ä½œä¸­æ±‡ç¼–æŒ‡ä»¤åˆ†å¤šæ­¥å®Œæˆï¼Œæ¯ä¸€éƒ¨æ¶‰åŠåˆ°çš„ç¡¬ä»¶ï¼ˆå¯„å­˜å™¨ï¼‰å¯èƒ½ä¸åŒï¼Œäºæ˜¯æœ‰äº†æµæ°´çº¿æŠ€æœ¯æ¥æ‰§è¡ŒæŒ‡ä»¤ã€‚\næ²¡æœ‰æµæ°´çº¿æŠ€æœ¯å‰ï¼Œå¦‚æœåŒæ—¶ä¸¤ä¸ªæŒ‡ä»¤è¿‡æ¥æ‰§è¡Œ ä¸€ä¸ªéœ€è¦5ç§’ï¼Œé‚£ä¹ˆä¸¤ä¸ªå°±éœ€è¦10ç§’ï¼›æœ‰äº†æµæ°´çº¿æŠ€æœ¯ä¹‹åï¼Œå¯èƒ½å°±åªè¦6ç§’ã€‚å¤šä¸ªæŒ‡ä»¤åŒæ—¶æ‰§è¡Œæ—¶æ€§èƒ½æ˜¾è‘—æå‡ã€‚\n æµæ°´çº¿æŠ€æœ¯æ˜¯ä¸€ç§å°†æŒ‡ä»¤åˆ†è§£ä¸ºå¤šæ­¥ï¼Œå¹¶è®©ä¸åŒæŒ‡ä»¤çš„å„æ­¥æ“ä½œé‡å ï¼Œä»è€Œå®ç°å‡ æ¡æŒ‡ä»¤å¹¶è¡Œå¤„ç†ã€‚\næŒ‡ä»¤1 IF ID EX MEN WB\næŒ‡ä»¤2 IF ID EX MEN WB\næŒ‡ä»¤çš„æ¯ä¸€æ­¥éƒ½ç”±ä¸åŒçš„ç¡¬ä»¶å®Œæˆï¼Œå‡è®¾æ¯ä¸€æ­¥è€—æ—¶1ms,æ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤éœ€è€—æ—¶5ms,\næ¯æ¡æŒ‡ä»¤éƒ½æŒ‰é¡ºåºæ‰§è¡Œï¼Œé‚£ä¸¤æ¡æŒ‡ä»¤åˆ™éœ€10msã€‚\nä½†æ˜¯é€šè¿‡æµæ°´çº¿åœ¨æŒ‡ä»¤1åˆšæ‰§è¡Œå®ŒIFï¼Œæ‰§è¡ŒIFçš„ç¡¬ä»¶ç«‹é©¬å°±å¼€å§‹æ‰§è¡ŒæŒ‡ä»¤2çš„IFï¼Œè¿™æ ·æŒ‡ä»¤2åªéœ€è¦ç­‰1ms,ä¸¤ä¸ªæŒ‡ä»¤æ‰§è¡Œå®Œåªéœ€è¦6ms,æ•ˆç‡æ˜¯ä¸æ˜¯æå‡å·¨å¤§ï¼\n è¿™ä¸ªå’ŒæŒ‡ä»¤é‡æ’æœ‰å•¥å…³ç³»ï¼Ÿ\næµæ°´çº¿æŠ€æœ¯å¹¶ä¸æ˜¯è¯´å¤šä¸ªæ±‡ç¼–æŒ‡ä»¤éƒ½èƒ½å¹¶è¡Œæ‰§è¡Œï¼Œè¿˜æ˜¯éœ€è¦ç­‰ä»–å…¶ä»–æŒ‡ä»¤æ‰§è¡Œå®Œæ‰å¯ä»¥æ‰§è¡Œï¼ˆæ¯”å¦‚ADDæŒ‡ä»¤éœ€è¦ç­‰å¾…LWæŒ‡ä»¤è¯»å–å¯„å­˜å™¨æ•°æ®å®Œæˆï¼‰ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®©å’Œè¿™ä¸ªæŒ‡ä»¤ä¸ç›¸å¹²çš„åé¢çš„æŒ‡ä»¤å…ˆæ‰§è¡Œï¼ˆæ¯”å¦‚å¦å¤–ä¸€ä¸ªè¡¨è¾¾å¼çš„LWæŒ‡ä»¤ï¼‰ï¼Œè¿™å°±æ˜¯æŒ‡ä»¤é‡æ’ã€‚\nå…ˆè®°ä½å‡ ä¸ªæŒ‡ä»¤ï¼š\n LW(åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨çš„æŒ‡ä»¤)\nADD(ä¸¤ä¸ªå®šç‚¹å¯„å­˜å™¨çš„å†…å®¹ç›¸åŠ )\nSUB(ç›¸å‡)\nSW(æŠŠæ•°æ®ä»å¯„å­˜å™¨å­˜å‚¨åˆ°å­˜å‚¨å™¨)\n ç°åœ¨æ¥çœ‹ä¸€ä¸‹ä»£ç  A=B+C æ˜¯æ€ä¹ˆæ‰§è¡Œçš„\nç°æœ‰R1,R2,R3ä¸‰ä¸ªå¯„å­˜å™¨,\rLW R1,B IF ID EX MEN WBï¼ˆåŠ è½½Båˆ°R1ä¸­ï¼‰\rLW R2,C IF ID EX MEN WBï¼ˆåŠ è½½Cåˆ°R2ä¸­ï¼‰\rADD R3,R2,R1 IF ID Ã— EX MEN WBï¼ˆR1,R2ç›¸åŠ æ”¾åˆ°R3ï¼‰\rSW A,R3 IF ID x EX MEN WBï¼ˆæŠŠR3 çš„å€¼ä¿å­˜åˆ°å˜é‡Aï¼‰\råœ¨ADDæŒ‡ä»¤æ‰§è¡Œä¸­æœ‰ä¸ªxï¼Œè¡¨ç¤ºä¸­æ–­ã€åœé¡¿ï¼ŒADDä¸ºä»€ä¹ˆè¦åœ¨è¿™é‡Œåœé¡¿ä¸€ä¸‹å‘¢ï¼Ÿå› ä¸ºè¿™æ—¶Cè¿˜æ²¡åŠ è½½åˆ°R2ä¸­ï¼Œåªèƒ½ç­‰å¾…ï¼Œè€Œè¿™ä¸ªç­‰å¾…ä½¿å¾—åè¾¹çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¼šåœé¡¿ä¸€ä¸‹ã€‚\rè¿™ä¸ªåœé¡¿å¯ä»¥é¿å…å—ï¼Ÿ\nå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œé€šè¿‡æŒ‡ä»¤é‡æ’å°±å¯ä»¥å®ç°ï¼Œå†çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä¾‹å­ï¼š\nè¦æ‰§è¡Œ\nA=B+C;\nD=E-F;\né€šè¿‡å°†D=E-Fæ‰§è¡Œçš„æŒ‡ä»¤é¡ºåºæå‰ï¼Œä»è€Œæ¶ˆé™¤å› ç­‰å¾…åŠ è½½å®Œæ¯•çš„æ—¶é—´ã€‚\rLW Rb,B IF ID EX MEN WB\rLW Rc,C IF ID EX MEN WB\rLW Re,E IF ID EX MEN WB\rADD Ra,Rb,Rc IF ID EX MEN WB\rLW Rf,F IF ID EX MEN WB\rSW A,Ra IF ID EX MEN WB\rSUB Rd,Re,Rf IF ID EX MEN WB\rSW D,Rd IF ID EX MEN WB\rä¸å…¶è®©ç¬¬ä¸€ä¸ªè¡¨è¾¾å¼çš„ADDæŒ‡ä»¤é˜»å¡ç­‰å¾…ï¼Œè¿˜ä¸å¦‚è®©ç¬¬äºŒä¸ªè¡¨è¾¾å¼çš„LWæŒ‡ä»¤å…ˆæ‰§è¡Œï¼Œæ³¨æ„ä¸¤ä¸ªè¡¨è¾¾å¼çš„LWæŒ‡ä»¤æ“ä½œçš„æ˜¯ä¸åŒçš„å¯„å­˜å™¨ï¼Œæ‰€ä»¥å¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚\næˆ‘ä»¬å†™ä¸€æ®µä»£ç æ¥è¯•è¯•ï¼š\npackage *****; /** * reorder * @author Mageek Chiu * @date 2018/5/25 0025:12:49 */ public class ReOrder { public int value ; private ReOrder(int value) { this.value = value; } public static void main(String... args){ ReOrder reOrder = new ReOrder(111); ReOrder reOrder1 = new ReOrder(222); ReOrder reOrder2 = new ReOrder(333); System.out.println(add1(reOrder,reOrder1,reOrder2)); } static int add1(ReOrder reOrder,ReOrder reOrder1,ReOrder reOrder2){ int result = 0; result += reOrder.value; result += reOrder1.value; result += reOrder2.value;//***  result += reOrder.value; result += reOrder1.value; result += reOrder2.value; result += reOrder.value; result += reOrder1.value; result += reOrder2.value; return result; } } è¿è¡Œç»“æœä¸­ï¼š\n# {method} {0x000000001c402c80} 'add1' '(*****/ReOrder;*****/ReOrder;*****/ReOrder;)I' in '*****/ReOrder'\r# parm0: rdx:rdx = '*****/ReOrder'\r# parm1: r8:r8 = '*****/ReOrder'\r# parm2: r9:r9 = '*****/ReOrder'\r# [sp+0x20] (sp of caller)\r0x00000000032a86c0: mov dword ptr [rsp+0ffffffffffffa000h],eax\r0x00000000032a86c7: push rbp\r0x00000000032a86c8: sub rsp,10h ;*synchronization entry\r; - *****.ReOrder::add1@-1 (line 24)\r0x00000000032a86cc: mov r11d,dword ptr [rdx+0ch]\r;*getfield value\r; - *****.ReOrder::add1@4 (line 26)\r; implicit exception: dispatches to 0x00000000032a86ff\r0x00000000032a86d0: mov r10d,dword ptr [r8+0ch] ;*getfield value\r; - *****.ReOrder::add1@11 (line 27)\r; implicit exception: dispatches to 0x00000000032a870d\r0x00000000032a86d4: mov r9d,dword ptr [r9+0ch] ;*getfield value\r; - *****.ReOrder::add1@18 (line 28)\r; implicit exception: dispatches to 0x00000000032a8719\r0x00000000032a86d8: mov eax,r11d\r0x00000000032a86db: add eax,r10d\r0x00000000032a86de: add eax,r9d\r0x00000000032a86e1: add eax,r11d\r0x00000000032a86e4: add eax,r10d\r0x00000000032a86e7: add eax,r9d\r0x00000000032a86ea: add eax,r11d\r0x00000000032a86ed: add eax,r10d\r0x00000000032a86f0: add eax,r9d ;*iadd\rä¹Ÿå°±æ˜¯å…ˆç”¨movæŠŠæ–¹æ³•é‡Œé¢æ‰€éœ€è¦çš„ä¸‰ä¸ªvalueåŠ è½½äº†ï¼Œå†ç»Ÿä¸€ç”¨addè¿›è¡ŒåŠ æ³•è¿ç®—ã€‚\nç°åœ¨æˆ‘ä»¬æŠŠ//***å“ªä¸€è¡Œæ³¨é‡Šæ‰ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š\n[Constants]\r# {method} {0x000000001c052c78} 'add1' '(*****/ReOrder;*****/ReOrder;*****/ReOrder;)I' in '*****/ReOrder'\r# parm0: rdx:rdx = '*****/ReOrder'\r# parm1: r8:r8 = '*****/ReOrder'\r# parm2: r9:r9 = '*****/ReOrder'\r# [sp+0x20] (sp of caller)\r0x0000000002f47d40: mov dword ptr [rsp+0ffffffffffffa000h],eax\r0x0000000002f47d47: push rbp\r0x0000000002f47d48: sub rsp,10h ;*synchronization entry\r; - *****.ReOrder::add1@-1 (line 24)\r0x0000000002f47d4c: mov r11d,dword ptr [rdx+0ch]\r;*getfield value\r; - *****r.ReOrder::add1@4 (line 26)\r; implicit exception: dispatches to 0x0000000002f47d7c\r0x0000000002f47d50: mov r10d,dword ptr [r8+0ch] ;*getfield value\r; - *****.ReOrder::add1@11 (line 27)\r; implicit exception: dispatches to 0x0000000002f47d89\r0x0000000002f47d54: mov r9d,dword ptr [r9+0ch] ;*getfield value\r; - *****::add1@32 (line 32)\r; implicit exception: dispatches to 0x0000000002f47d95\r0x0000000002f47d58: mov eax,r11d\r0x0000000002f47d5b: add eax,r10d\r0x0000000002f47d5e: add eax,r11d\r0x0000000002f47d61: add eax,r10d\r0x0000000002f47d64: add eax,r9d\r0x0000000002f47d67: add eax,r11d\r0x0000000002f47d6a: add eax,r10d\r0x0000000002f47d6d: add eax,r9d ;*iadd\rä¾ç„¶æ˜¯å…ˆæŠŠæ‰€æœ‰valueéƒ½ç”¨movæŒ‡ä»¤åŠ è½½åå†è¿›è¡ŒåŠ æ³•è¿ç®—ã€‚ æ€»ç»“èµ·æ¥å°±æ˜¯ä¸ç®¡ä»£ç é‡Œè¿™ä¸ªå€¼ä½¿ç”¨é¡ºåºå¤šé åï¼Œéƒ½å…ˆç”¨movåŠ è½½åå†ä½¿ç”¨addå¯¹è¿™ä¸ªå€¼è¿›è¡Œè¿ç®—ã€‚\næ³¨æ„ï¼Œä¸Šé¢çš„è¿è¡Œå‚æ•°ä¸º-Xcomp -XX:+UnlockDiagnosticVMOptions -XX:CompileCommand=print,*ReOrder.add1 -XX:+PrintCompilationã€‚ Xcomp å«ä¹‰æ˜¯ä½¿ç”¨ç¼–è¯‘æ¨¡å¼è€Œä¸æ˜¯è§£é‡Šæ¨¡å¼ï¼Œ -XX:CompileCommand=print,*ReOrder.add1è¡¨ç¤ºåªæ‰“å°è¿™ä¸ªæ–¹æ³•ï¼Œ-XX:+PrintCompilationè¡¨ç¤ºæ‰“å°æ–¹æ³•åç§°ã€‚ éœ€è¦æ’ä»¶hsdisï¼Œç¼–è¯‘å¥½åæ”¾åœ¨jdkçš„jreçš„binçš„serverä¸­å°±å¥½ï¼Œå…·ä½“ç¯å¢ƒæ­å»ºå¯ä»¥å‚é˜…è¿™é‡Œ\rå‚è€ƒ æ±‡ç¼–è¯­è¨€å…¥é—¨æ•™ç¨‹\rä¸ºä»€ä¹ˆè¦æŒ‡ä»¤é‡æ’åºï¼Ÿ\rç¼–è¯‘å™¨ä¸ºä»€ä¹ˆè¦åšæŒ‡ä»¤é‡æ’å‘¢\rè®¡ç®—æœºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹è¯¦è§£\rJavaå†…å­˜è®¿é—®é‡æ’åºçš„ç ”ç©¶\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92/","series":["Manual"],"tags":["CS"],"title":"æŒ‡ä»¤é‡æ’"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"æ•°æ®åº“å’Œç¼“å­˜åŒå†™ä¸€è‡´æ€§ é¦–å…ˆï¼Œç¼“å­˜ç”±äºå…¶é«˜å¹¶å‘å’Œé«˜æ€§èƒ½çš„ç‰¹æ€§ï¼Œå·²ç»åœ¨é¡¹ç›®ä¸­è¢«å¹¿æ³›ä½¿ç”¨ã€‚åœ¨è¯»å–ç¼“å­˜æ–¹é¢ï¼Œå¤§å®¶æ²¡å•¥ç–‘é—®ï¼Œéƒ½æ˜¯æŒ‰ç…§ä¸‹å›¾çš„æµç¨‹æ¥è¿›è¡Œä¸šåŠ¡æ“ä½œã€‚\nã€\nåŒå†™å¯åˆ†ä¸ºï¼šæ›´æ–°ç¼“å­˜-\u0026gt;æ›´æ–°dbã€æ›´æ–°db-\u0026gt;æ›´æ–°ç¼“å­˜ã€åˆ é™¤ç¼“å­˜-\u0026gt;æ›´æ–°dbã€æ›´æ–°db-\u0026gt;åˆ é™¤ç¼“å­˜ å››ç§ç­–ç•¥ã€‚\nå¹¶å‘äº‹åŠ¡æ—¶ï¼Œå‰ä¸¤ç§ç­–ç•¥ä¸ä»…å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„ï¼Œè€Œä¸”åœ¨å†™å¤šè¯»å°‘çš„åœºæ™¯ä¸‹ä¼šç™½ç™½æ¶ˆè€—ç¼“å­˜çš„æ€§èƒ½ï¼ˆå› ä¸ºæ•°æ®è¿˜æ²¡è¢«è¯»å°±åˆè¢«æ›´æ–°äº†ï¼Œå°¤å…¶æ˜¯åœ¨æ›´æ–°çš„ç¼“å­˜éœ€è¦é€šè¿‡å¤æ‚è®¡ç®—æ‰èƒ½å¾—åˆ°æ—¶ï¼Œè¿™ç§æ¶ˆè€—æ›´åŠ ä¸¥é‡ï¼‰ã€‚åä¸¤ç§ç­–ç•¥æƒ…å†µç›¸ä¼¼ï¼Œåªæ˜¯æ›´æ–°db-\u0026gt;åˆ é™¤ç¼“å­˜ç›¸è¾ƒäºåˆ é™¤ç¼“å­˜-\u0026gt;æ›´æ–°dbå‘ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„æ¦‚ç‡æ›´ä½ï¼ˆå› ä¸ºåªæœ‰åœ¨å†™æ“ä½œå…ˆäºè¯»æ“ä½œå®Œæˆæ‰ä¼šä¸ä¸€è‡´ï¼Œè€Œä¸€èˆ¬æ¥è¯´ä¸€ä¸ªå†™æ“ä½œæ˜¯è¦æ¯”è¯»æ“ä½œæ…¢çš„ï¼‰ï¼Œä¸ºé˜²æ­¢ä¸ä¸€è‡´å‘ç”Ÿï¼Œå®ƒä»¬éƒ½é‡‡ç”¨å¼‚æ­¥å»¶è¿ŸåŒåˆ +åˆ é™¤é‡è¯•æœºåˆ¶çš„ç­–ç•¥ï¼Œä¸‹é¢è¯¦è¿°å¸¸è§åˆ é™¤é‡è¯•æœºåˆ¶ã€‚\né‡è¯•æœºåˆ¶ï¼šæ–¹æ¡ˆä¸€ æµç¨‹å¦‚ä¸‹æ‰€ç¤º ï¼ˆ1ï¼‰æ›´æ–°æ•°æ®åº“æ•°æ®ï¼› ï¼ˆ2ï¼‰ç¼“å­˜å› ä¸ºç§ç§é—®é¢˜åˆ é™¤å¤±è´¥ ï¼ˆ3ï¼‰å°†éœ€è¦åˆ é™¤çš„keyå‘é€è‡³æ¶ˆæ¯é˜Ÿåˆ— ï¼ˆ4ï¼‰è‡ªå·±æ¶ˆè´¹æ¶ˆæ¯ï¼Œè·å¾—éœ€è¦åˆ é™¤çš„key ï¼ˆ5ï¼‰ç»§ç»­é‡è¯•åˆ é™¤æ“ä½œï¼Œç›´åˆ°æˆåŠŸ ç„¶è€Œï¼Œè¯¥æ–¹æ¡ˆæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå¯¹ä¸šåŠ¡çº¿ä»£ç é€ æˆå¤§é‡çš„ä¾µå…¥ã€‚äºæ˜¯æœ‰äº†æ–¹æ¡ˆäºŒï¼Œåœ¨æ–¹æ¡ˆäºŒä¸­ï¼Œå¯åŠ¨ä¸€ä¸ªè®¢é˜…ç¨‹åºå»è®¢é˜…æ•°æ®åº“çš„binlogï¼Œè·å¾—éœ€è¦æ“ä½œçš„æ•°æ®ã€‚åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œå¦èµ·ä¸€æ®µç¨‹åºï¼Œè·å¾—è¿™ä¸ªè®¢é˜…ç¨‹åºä¼ æ¥çš„ä¿¡æ¯ï¼Œè¿›è¡Œåˆ é™¤ç¼“å­˜æ“ä½œã€‚\né‡è¯•æœºåˆ¶ï¼šæ–¹æ¡ˆäºŒ æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ï¼ˆ1ï¼‰æ›´æ–°æ•°æ®åº“æ•°æ® ï¼ˆ2ï¼‰æ•°æ®åº“ä¼šå°†æ“ä½œä¿¡æ¯å†™å…¥binlogæ—¥å¿—å½“ä¸­ ï¼ˆ3ï¼‰è®¢é˜…ç¨‹åºæå–å‡ºæ‰€éœ€è¦çš„æ•°æ®ä»¥åŠkey ï¼ˆ4ï¼‰å¦èµ·ä¸€æ®µéä¸šåŠ¡ä»£ç ï¼Œè·å¾—è¯¥ä¿¡æ¯ ï¼ˆ5ï¼‰å°è¯•åˆ é™¤ç¼“å­˜æ“ä½œï¼Œå‘ç°åˆ é™¤å¤±è´¥ ï¼ˆ6ï¼‰å°†è¿™äº›ä¿¡æ¯å‘é€è‡³æ¶ˆæ¯é˜Ÿåˆ— ï¼ˆ7ï¼‰é‡æ–°ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è·å¾—è¯¥æ•°æ®ï¼Œé‡è¯•æ“ä½œã€‚\nä¸Šè¿°çš„è®¢é˜…binlogç¨‹åºåœ¨mysqlä¸­æœ‰ç°æˆçš„ä¸­é—´ä»¶å«canalï¼Œå¯ä»¥å®Œæˆè®¢é˜…binlogæ—¥å¿—çš„åŠŸèƒ½ã€‚è‡³äºoracleä¸­ï¼Œåšä¸»ç›®å‰ä¸çŸ¥é“æœ‰æ²¡æœ‰ç°æˆä¸­é—´ä»¶å¯ä»¥ä½¿ç”¨ã€‚å¦å¤–ï¼Œé‡è¯•æœºåˆ¶ï¼Œåšä¸»æ˜¯é‡‡ç”¨çš„æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼ã€‚å¦‚æœå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œç›´æ¥åœ¨ç¨‹åºä¸­å¦èµ·ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å»é‡è¯•å³å¯ï¼Œè¿™äº›å¤§å®¶å¯ä»¥çµæ´»è‡ªç”±å‘æŒ¥ï¼Œåªæ˜¯æä¾›ä¸€ä¸ªæ€è·¯ã€‚\nå‚è€ƒé“¾æ¥ï¼š åˆ†å¸ƒå¼ä¹‹æ•°æ®åº“å’Œç¼“å­˜åŒå†™ä¸€è‡´æ€§æ–¹æ¡ˆè§£æ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E5%88%86%E5%B8%83%E5%BC%8F/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7/","series":["Manual"],"tags":["åˆ†å¸ƒå¼","CS"],"title":"æ•°æ®åº“å’Œç¼“å­˜åŒå†™ä¸€è‡´æ€§"},{"categories":["äº‘åŸç”Ÿ"],"content":"æš´éœ²grafanaç­‰å†…éƒ¨ç»„ä»¶æœåŠ¡\nåœ¨å®‰è£…å®Œæˆistioåï¼Œé»˜è®¤çŠ¶æ€ä¸‹ï¼Œé›†ç¾¤å¤–ç”¨æˆ·ä¸èƒ½ç›´æ¥è®¿é—®istioé›†ç¾¤å†…çš„grafanaç­‰ç®¡ç†ã€ç›‘æ§æœåŠ¡ã€‚\næœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å°†é›†ç¾¤å†…æœåŠ¡å¼€æ”¾å‡ºæ¥ã€‚ä¸€ç§æ˜¯ä½¿ç”¨port-forwardæ–¹å¼å°†æœ¬åœ°ç«¯å£æµé‡è½¬å‘åˆ°podç«¯å£ï¼Œå®ç°é›†ç¾¤å†…æœåŠ¡çš„è®¿é—®ï¼›å¦ä¸€ç§æ–¹å¼æ˜¯é‡‡ç”¨istio gatewayæ–¹å¼ï¼Œå°†é›†ç¾¤å†…æœåŠ¡æš´éœ²åˆ°å¤–ç½‘ã€‚\nç¬¬ä¸€ç§æ–¹å¼ï¼ˆä»¥æš´éœ²Prometheusä¸ºä¾‹ï¼Œå®˜æ–¹æ•™ç¨‹\rä¹Ÿæ˜¯è¿™ç§æ–¹å¼ï¼Œè¿™ç§æ–¹å¼æå…¶åäººç±»ï¼Œæ¨èä½¿ç”¨ä¸‹é¢çš„ç¬¬äºŒç§æ–¹å¼ï¼‰ï¼š\nkubectl -n Istio-system port-forward $(kubectl -n Istio-system get pod -l app=prometheus -o jsonpath=\u0026#39;{.items[0].metadata.name}\u0026#39;) 9090:9090 \u0026amp; ç¬¬äºŒç§æ–¹å¼éœ€è¦å°†é›†ç¾¤çš„é»˜è®¤ç½‘å…³æœåŠ¡ingressgatewayçš„ç½‘ç»œæ¨¡å¼è®¾ç½®ä¸ºLB/nodeportæ¨¡å¼ï¼Œä½œä¸ºä»£ç†å®ç°å¯¹å¤–æœåŠ¡ã€‚\n1. è®¾ç½®ingress gatewayçš„å·¥ä½œæ¨¡å¼ å®‰è£…istioçš„æ—¶å€™é»˜è®¤å°±æ˜¯LBçš„\n2. éªŒè¯ingress gatewayçš„ç½‘ç»œæ¨¡å¼ [root@k8s-master ~]# kubectl get svc -n Istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.101.122.19 \u0026lt;none\u0026gt; 3000/TCP 11h Istio-egressgateway ClusterIP 10.106.2.83 \u0026lt;none\u0026gt; 80/TCP,443/TCP,15443/TCP 11h Istio-ingressgateway LoadBalancer 10.110.238.41 \u0026lt;pending\u0026gt; 15020:31598/TCP,80:30299/TCP,443:31413/TCP,15029:30249/TCP,15030:32499/TCP,15031:31399/TCP,15032:32373/TCP,31400:30156/TCP,15443:30319/TCP 11h Istio-pilot ClusterIP 10.103.43.172 \u0026lt;none\u0026gt; 15010/TCP,15011/TCP,15012/TCP,8080/TCP,15014/TCP,443/TCP 11h istiod ClusterIP 10.105.251.21 \u0026lt;none\u0026gt; 15012/TCP,443/TCP 11h jaeger-agent ClusterIP None \u0026lt;none\u0026gt; 5775/UDP,6831/UDP,6832/UDP 11h jaeger-collector ClusterIP 10.99.197.254 \u0026lt;none\u0026gt; 14267/TCP,14268/TCP,14250/TCP 11h jaeger-collector-headless ClusterIP None \u0026lt;none\u0026gt; 14250/TCP 11h jaeger-query ClusterIP 10.110.152.152 \u0026lt;none\u0026gt; 16686/TCP 11h kiali ClusterIP 10.100.252.210 \u0026lt;none\u0026gt; 20001/TCP 11h prometheus ClusterIP 10.108.175.66 \u0026lt;none\u0026gt; 9090/TCP 11h tracing ClusterIP 10.102.204.150 \u0026lt;none\u0026gt; 80/TCP 11h zipkin ClusterIP 10.104.104.190 \u0026lt;none\u0026gt; 9411/TCP 11h 3. æŸ¥çœ‹ä½œä¸ºè¾¹ç•Œä»£ç†çš„ingress-gatewayçš„ç«¯å£æ˜ å°„æƒ…å†µ [root@k8s-master ~]# kubectl describe svc Istio-ingressgateway -n Istio-system Name: Istio-ingressgateway Namespace: Istio-system Labels: app=Istio-ingressgateway Istio=ingressgateway operator.Istio.io/component=IngressGateways operator.Istio.io/managed=Reconcile operator.Istio.io/version=1.5.10 release=Istio Annotations: Selector: app=Istio-ingressgateway,Istio=ingressgateway Type: LoadBalancer IP: 10.110.238.41 Port: status-port 15020/TCP TargetPort: 15020/TCP NodePort: status-port 31598/TCP Endpoints: 10.109.131.26:15020 Port: http2 80/TCP TargetPort: 80/TCP NodePort: http2 30299/TCP Endpoints: 10.109.131.26:80 Port: https 443/TCP TargetPort: 443/TCP NodePort: https 31413/TCP Endpoints: 10.109.131.26:443 Port: kiali 15029/TCP TargetPort: 15029/TCP NodePort: kiali 30249/TCP Endpoints: 10.109.131.26:15029 Port: prometheus 15030/TCP TargetPort: 15030/TCP NodePort: prometheus 32499/TCP Endpoints: 10.109.131.26:15030 Port: grafana 15031/TCP TargetPort: 15031/TCP NodePort: grafana 31399/TCP Endpoints: 10.109.131.26:15031 Port: tracing 15032/TCP TargetPort: 15032/TCP NodePort: tracing 32373/TCP Endpoints: 10.109.131.26:15032 Port: tcp 31400/TCP TargetPort: 31400/TCP NodePort: tcp 30156/TCP Endpoints: 10.109.131.26:31400 Port: tls 15443/TCP TargetPort: 15443/TCP NodePort: tls 30319/TCP Endpoints: 10.109.131.26:15443 Session Affinity: None External Traffic Policy: Cluster Events: \u0026lt;none\u0026gt; ä¸Šå›¾æ‰€ç¤ºï¼Œingressgatewayåˆ›å»ºæ—¶ï¼Œè‡ªåŠ¨é¢„è®¾äº†ä¸€äº›ç«¯å£æ˜ å°„ï¼Œå…¶ä¸­https-grafanaçš„15301ç«¯å£æ˜ å°„åˆ°nodeçš„31399ç«¯å£,æˆ‘ä»¬å°†15031ç«¯å£å…³è”åˆ°grafanaä¸Šï¼Œé›†ç¾¤å¤–å°±ç”¨æˆ·é€šè¿‡è®¿é—®ç½‘å…³æ‰€åœ¨æœºå™¨çš„31399ç«¯å£è®¿é—®åˆ°grafanaæœåŠ¡ã€‚\n4. gatewayæ–¹å¼æš´éœ²é›†ç¾¤å†…æœåŠ¡ éœ€è¦åˆ›å»ºæœåŠ¡çš„gatewayå’Œvirtual serviceèµ„æºå¦‚ä¸‹ï¼š\napiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: grafana-gateway spec: selector: istio: ingressgateway # use istio default controller servers: - port: number: 15031 name: http protocol: HTTP hosts: - \u0026#34;*\u0026#34; --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: grafana-vs spec: hosts: - \u0026#34;*\u0026#34; gateways: - grafana-gateway http: - route: - destination: host: grafana port: number: 3000 æ‰§è¡Œï¼š\nkubectl apply -f grafana-gateway.yaml -n Istio-system ç‰¹åˆ«éœ€è¦æ³¨æ„ï¼šåé¢çš„namespaceæ˜¯istio-systemï¼Œå› ä¸ºgrafanaç­‰å†…éƒ¨ç»„ä»¶éƒ½æ˜¯è¿™ä¸ªnamespaceçš„ã€‚\n5. æµ‹è¯•grafanaçš„è¿é€šæ€§ http://\u0026lt;å…¬ç½‘IP\u0026gt;:31399 å‚è€ƒ istioä¸­çš„grafanaç­‰å†…éƒ¨ç»„ä»¶æœåŠ¡å¼€æ”¾ç»™é›†ç¾¤å¤–ç”¨æˆ·è®¿é—®\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/istio/istio%E5%AE%9E%E6%88%98/%E6%9A%B4%E9%9C%B2grafana%E7%AD%89%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%E6%9C%8D%E5%8A%A1/","series":["istioå®æˆ˜"],"tags":["äº‘åŸç”Ÿ","istio"],"title":"æš´éœ²grafanaç­‰å†…éƒ¨ç»„ä»¶æœåŠ¡"},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":" ä½¿ç”¨è‡ªå®šä¹‰ TCP åè®®è¿›è¡Œä¼ è¾“å°±ä¼šé¿å…ä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼Œæå¤§åœ°å‡è½»äº†ä¼ è¾“æ•°æ®çš„å¼€é”€ã€‚ è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆé€šå¸¸ä¼šé‡‡ç”¨è‡ªå®šä¹‰ TCP åè®®çš„ RPC æ¥è¿›è¡Œè¿›è¡ŒæœåŠ¡è°ƒç”¨çš„çœŸæ­£åŸå› ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œæˆç†Ÿçš„ RPC æ¡†æ¶è¿˜æä¾›å¥½äº†â€œæœåŠ¡è‡ªåŠ¨æ³¨å†Œä¸å‘ç°â€ã€\u0026ldquo;æ™ºèƒ½è´Ÿè½½å‡è¡¡\u0026rdquo;ã€â€œå¯è§†åŒ–çš„æœåŠ¡æ²»ç†å’Œè¿ç»´â€ã€â€œè¿è¡ŒæœŸæµé‡è°ƒåº¦â€ç­‰ç­‰åŠŸèƒ½ï¼Œè¿™äº›ä¹Ÿç®—æ˜¯é€‰æ‹© RPC è¿›è¡ŒæœåŠ¡æ³¨å†Œå’Œå‘ç°çš„ä¸€æ–¹é¢åŸå› å§ï¼  ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E7%9A%84%E8%B0%83%E7%94%A8%E4%B8%BA%E5%95%A5%E4%B8%8D%E7%9B%B4%E6%8E%A5%E7%94%A8-http-%E8%80%8C%E7%94%A8-rpc/","series":["Manual"],"tags":["CS"],"title":"æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ä¸ºå•¥ä¸ç›´æ¥ç”¨ HTTP è€Œç”¨ RPCï¼Ÿ"},{"categories":["äº‘åŸç”Ÿ"],"content":"æœåŠ¡ç½‘æ ¼åŸç†\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/istio/istio%E5%9F%BA%E7%A1%80/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E5%8E%9F%E7%90%86/","series":null,"tags":["äº‘åŸç”Ÿ","istio"],"title":"æœåŠ¡ç½‘æ ¼åŸç†"},{"categories":["äº‘åŸç”Ÿ"],"content":"æœ¬åœ°è¿æ¥k8sé›†ç¾¤ åœ¨æ—¥å¸¸å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šéœ€è¦åœ¨æœ¬åœ°å¼€å‘çš„ç¨‹åºéœ€è¦åœ¨k8sä¸­è°ƒè¯•çš„åœºæ™¯ï¼Œæ¯”å¦‚ï¼Œå†™äº†ä¸€ä¸ªoperatorã€‚\nå¦‚æœæ­¤æ—¶ï¼Œæœ¬åœ°åˆæ²¡æœ‰å¯ä»¥ç›´æ¥å¯è¾¾çš„k8sé›†ç¾¤ï¼Œ\næ¯”å¦‚k8sæ˜¯åœ¨å…¬æœ‰äº‘çš„vpcç¯å¢ƒå†…ï¼Œå¤–é¢æ— æ³•ç›´æ¥è®¿é—®ã€‚æƒ³è¦æœ¬åœ°è¿æ¥è¿œç¨‹k8sé›†ç¾¤ï¼Œå¯ä»¥å‚è€ƒ æœ¬åœ°è¿æ¥è¿œç¨‹çš„å†…ç½‘k8sé›†ç¾¤\rå†æ¯”å¦‚k8sé›†ç¾¤æ˜¯è‡ªå·±é€šè¿‡å¤šå°äº‘æœåŠ¡å™¨è‡ªè¡Œæ­å»ºçš„ï¼ŒmasterèŠ‚ç‚¹æœ‰è‡ªå·±çš„å…¬ç½‘ipã€‚æƒ³è¦æœ¬åœ°è¿æ¥è¿œç¨‹k8sé›†ç¾¤ï¼Œå¯ä»¥å‚è€ƒæœ¬æ–‡ã€‚\n1âƒ£ï¸ é‡æ–°ç”Ÿæˆconfigæ–‡ä»¶ é»˜è®¤ä¸‹ï¼Œ~/.kube/config ç”Ÿæˆé…ç½®æ–‡ä»¶çš„æ—¶å€™åªåŒ…å«äº†k8sé›†ç¾¤ipå’Œè¿™ä¸ªèŠ‚ç‚¹çš„å±€åŸŸç½‘ipï¼Œæœ¬åœ°å¦‚æœæƒ³è¿œç¨‹æ“ä½œk8sçš„è¯ï¼Œå¿…å®šè¦é€šè¿‡å…¬ç½‘ipè¿æ¥åˆ°k8sé›†ç¾¤ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠèŠ‚ç‚¹ç»‘å®šçš„å…¬ç½‘ipä¹Ÿæ”¾åˆ°è¯ä¹¦é‡Œé¢å»ï¼Œå³æˆ‘ä»¬éœ€è¦é‡æ–°ç”Ÿæˆè¯ä¹¦ã€‚å¦‚æœä¸è¿™æ ·åšï¼Œæœ¬åœ°ç›´æ¥è®¿é—®çš„è¯ï¼Œä¼šæŠ¥å¦‚ä¸‹æç¤ºï¼š\ntony@192 ~ % kubectl get pod Unable to connect to the server: x509: certificate is valid for 10.96.0.1, 172.17.0.14, not 106.55.152.92 å…ˆå¤‡ä»½è¯ä¹¦ï¼š\n[root@k8s-master .kube]# mkdir -p /etc/kubernetes/pki.bak [root@k8s-master .kube]# mv /etc/kubernetes/pki/apiserver.* /etc/kubernetes/pki.bak é‡æ–°ç”Ÿæˆè¯ä¹¦ï¼š\n[root@k8s-master .kube]# kubeadm init phase certs all --apiserver-advertise-address=0.0.0.0 --apiserver-cert-extra-sans=10.96.0.1,172.17.0.14,xxx.xxx.xxx.xxx(å…¬ç½‘ip) I0627 15:10:39.069106 7777 version.go:252] remote version is much newer: v1.21.2; falling back to: stable-1.18 W0627 15:10:40.982380 7777 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io] [certs] Using certificateDir folder \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Using existing ca certificate authority [certs] Generating \u0026#34;apiserver\u0026#34; certificate and key [certs] apiserver serving cert is signed for DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 172.17.0.14 10.96.0.1 172.17.0.14 106.55.152.92] [certs] Using existing apiserver-kubelet-client certificate and key on disk [certs] Using existing front-proxy-ca certificate authority [certs] Using existing front-proxy-client certificate and key on disk [certs] Using existing etcd/ca certificate authority [certs] Using existing etcd/server certificate and key on disk [certs] Using existing etcd/peer certificate and key on disk [certs] Using existing etcd/healthcheck-client certificate and key on disk [certs] Using existing apiserver-etcd-client certificate and key on disk [certs] Using the existing \u0026#34;sa\u0026#34; key é‡å¯apiserver:\n[root@k8s-master .kube]# docker rm -f `docker ps -q -f \u0026#39;name=k8s_kube-apiserver*\u0026#39;` cd130929bc7e [root@k8s-master .kube]# systemctl restart kubelet 2âƒ£ï¸ ä¿®æ”¹ip æ‹·è´masterèŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ ~/.kube/config åˆ°æœ¬åœ° ~/.kube/config ï¼Œä¿®æ”¹serverçš„ipåœ°å€ä¸ºmasterèŠ‚ç‚¹çš„å…¬ç½‘ipåœ°å€\n3âƒ£ï¸ æœ¬åœ°éªŒè¯ tony@192 ~ % kubectl get pod NAME READY STATUS RESTARTS AGE ceres-admin-server-deployment-7f9c4c697d-7pphh 2/2 Running 0 92d ceres-admin-web-deployment-7c8fb64f58-ft8xv 2/2 Running 2 192d ceres-app-server-deployment-65b6bb99f9-qlwb2 2/2 Running 0 92d ceres-jobs-server-deployment-bdcd669bb-284k5 2/2 Running 2 217d ceres-merchant-web-deployment-6c6b668b8d-5vtq5 2/2 Running 2 192d ceres-settled-merchant-deployment-5f74c8f46d-f982v 2/2 Running 2 213d details-v1-6c9f8bcbcb-pzkfm 2/2 Running 6 296d nfs-client-provisioner-6965c6967-6jv6c 2/2 Running 8 217d productpage-v1-7f9d9c48c8-kgtlw 2/2 Running 4 296d ratings-v1-65cff55fb8-vmj4z 2/2 Running 6 296d reviews-v1-d5b6b667f-9b7kw 2/2 Running 4 296d reviews-v2-784495d9bc-xvqpw 2/2 Running 6 296d reviews-v3-57fcb844b7-xsj47 2/2 Running 4 296d å‚è€ƒé“¾æ¥ğŸ”— Invalid x509 certificate for kubernetes master\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/%E6%9C%AC%E5%9C%B0%E8%BF%9E%E6%8E%A5k8s%E9%9B%86%E7%BE%A4/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"æœ¬åœ°è¿æ¥k8sé›†ç¾¤"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"æ‰¾å‡ºæ•°ç»„ arr ä¸­é‡å¤å‡ºç°è¿‡çš„å…ƒç´ ï¼ˆä¸ç”¨è€ƒè™‘è¿”å›é¡ºåºï¼‰\nç¤ºä¾‹1\nè¾“å…¥ [1, 2, 4, 4, 3, 3, 1, 5, 3] è¾“å‡º [1, 3, 4] å°†ä¼ å…¥çš„æ•°ç»„arrä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ valueå½“ä½œå¦å¤–ä¸€ä¸ªæ–°æ•°ç»„bçš„keyï¼Œç„¶åéå†arrå»è®¿é—®b[value]ï¼Œè‹¥b[value]ä¸å­˜åœ¨ï¼Œåˆ™å°†b[value]è®¾ç½®ä¸º1ï¼Œè‹¥b[value]å­˜åœ¨ï¼Œåˆ™å°†å…¶åŠ 1ã€‚å¯ä»¥æƒ³è±¡ï¼Œè‹¥arrä¸­æ•°ç»„æ²¡æœ‰é‡å¤çš„å…ƒç´ ï¼Œåˆ™bæ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ å‡ä¸º1ï¼›è‹¥arræ•°ç»„ä¸­å­˜åœ¨é‡å¤çš„å…ƒç´ ï¼Œåˆ™åœ¨ç¬¬äºŒæ¬¡è®¿é—®è¯¥b[value]æ—¶ï¼Œb[value]ä¼šåŠ 1ï¼Œå…¶å€¼å°±ä¸º2äº†ã€‚æœ€åéå†bæ•°ç»„ï¼Œå°†å…¶å€¼å¤§äº1çš„å…ƒç´ çš„keyå­˜å…¥å¦ä¸€ä¸ªæ•°ç»„aä¸­ï¼Œå°±å¾—åˆ°äº†arrä¸­é‡å¤çš„å…ƒç´ ã€‚\nfunction duplicates(arr) { //å£°æ˜ä¸¤ä¸ªæ•°ç»„ï¼Œaæ•°ç»„ç”¨æ¥å­˜æ”¾ç»“æœï¼Œbæ•°ç»„ç”¨æ¥å­˜æ”¾arrä¸­æ¯ä¸ªå…ƒç´ çš„ä¸ªæ•°  var a = [],b = []; //éå†arrï¼Œå¦‚æœä»¥arrä¸­å…ƒç´ ä¸ºä¸‹æ ‡çš„çš„bå…ƒç´ å·²å­˜åœ¨ï¼Œåˆ™è¯¥bå…ƒç´ åŠ 1ï¼Œå¦åˆ™è®¾ç½®ä¸º1  for(var i = 0; i \u0026lt; arr.length; i++){ if(!b[arr[i]]){ b[arr[i]] = 1; continue; } b[arr[i]]++; } //éå†bæ•°ç»„ï¼Œå°†å…¶ä¸­å…ƒç´ å€¼å¤§äº1çš„å…ƒç´ ä¸‹æ ‡å­˜å…¥aæ•°ç»„ä¸­  for(var i = 0; i \u0026lt; b.length; i++){ if(b[i] \u0026gt; 1){ a.push(i); } } return a; } æŸ¥æ‰¾é‡å¤å…ƒç´ \r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E7%89%9B%E5%AE%A2/%E6%9F%A5%E6%89%BE%E9%87%8D%E5%A4%8D%E5%85%83%E7%B4%A0/","series":["Manual"],"tags":["ç‰›å®¢"],"title":"æŸ¥æ‰¾é‡å¤å…ƒç´ "},{"categories":["è®¡ç®—æœºç§‘å­¦"],"content":"1. rediså¯ä»¥å®¹çº³å¤šå°‘ä¸ªé”®å€¼å¯¹ï¼Ÿå•ä¸ªé”®å€¼çš„å¤§å°é™åˆ¶æ˜¯ï¼Ÿ æœ€å¤šå®¹çº³ 2^32 ä¸ªkey\nredisçš„keyå’Œstringç±»å‹valueé™åˆ¶å‡ä¸º512MBã€‚\nstringç±»å‹ï¼šä¸€ä¸ªStringç±»å‹çš„valueæœ€å¤§å¯ä»¥å­˜å‚¨512M\nlistç±»å‹ï¼šlistçš„å…ƒç´ ä¸ªæ•°æœ€å¤šä¸º2^32-1ä¸ªï¼Œä¹Ÿå°±æ˜¯4294967295ä¸ªã€‚\nsetç±»å‹ï¼šå…ƒç´ ä¸ªæ•°æœ€å¤šä¸º2^32-1ä¸ªï¼Œä¹Ÿå°±æ˜¯4294967295ä¸ªã€‚\nhashç±»å‹ï¼šé”®å€¼å¯¹ä¸ªæ•°æœ€å¤šä¸º2^32-1ä¸ªï¼Œä¹Ÿå°±æ˜¯4294967295ä¸ªã€‚\nzsetç±»å‹ï¼šè·Ÿsetç±»å‹ç›¸ä¼¼ã€‚\n2. mysql varcharæœ€å¤§é•¿åº¦ï¼Ÿ 65532 byte = 65535 byte (max row size) - 1 byte (not null flag) - 2 byte (è®°å½•å®é™…é•¿åº¦)\n4.0ç‰ˆæœ¬ä»¥ä¸‹ï¼Œvarchar(20)ï¼ŒæŒ‡çš„æ˜¯20å­—èŠ‚ï¼Œå¦‚æœå­˜æ”¾UTF8æ±‰å­—æ—¶ï¼Œåªèƒ½å­˜6ä¸ªï¼ˆæ¯ä¸ªæ±‰å­—3å­—èŠ‚ï¼‰ 5.0ç‰ˆæœ¬ä»¥ä¸Šï¼Œvarchar(20)ï¼ŒæŒ‡çš„æ˜¯20å­—ç¬¦ï¼Œæ— è®ºå­˜æ”¾çš„æ˜¯æ•°å­—ã€å­—æ¯è¿˜æ˜¯UTF8æ±‰å­—ï¼ˆæ¯ä¸ªæ±‰å­—3å­—èŠ‚ï¼‰ï¼Œéƒ½å¯ä»¥å­˜æ”¾20ä¸ªï¼Œæœ€å¤§å¤§å°æ˜¯65532å­—èŠ‚\nMySQLä¸­varcharæœ€å¤§é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ\r3. mysql sqlå‘½ä»¤æ‰§è¡Œé¡ºåº å®šä½è¡¨` -\u0026gt; `ç¬›å¡å°”ç§¯` -\u0026gt; `è¿‡æ»¤` -\u0026gt; `é€‰æ‹© `-\u0026gt; `å±•ç¤º\r1.FORM: å¯¹FROMçš„å·¦è¾¹çš„è¡¨å’Œå³è¾¹çš„è¡¨è®¡ç®—ç¬›å¡å°”ç§¯ã€‚äº§ç”Ÿè™šè¡¨VT1\n2.ON: å¯¹è™šè¡¨VT1è¿›è¡ŒONç­›é€‰ï¼Œåªæœ‰é‚£äº›ç¬¦åˆçš„è¡Œæ‰ä¼šè¢«è®°å½•åœ¨è™šè¡¨VT2ä¸­ã€‚\n3.JOINï¼š å¦‚æœæŒ‡å®šäº†OUTER JOINï¼ˆæ¯”å¦‚left joinã€ right joinï¼‰ï¼Œé‚£ä¹ˆä¿ç•™è¡¨ä¸­æœªåŒ¹é…çš„è¡Œå°±ä¼šä½œä¸ºå¤–éƒ¨è¡Œæ·»åŠ åˆ°è™šæ‹Ÿè¡¨VT2ä¸­ï¼Œäº§ç”Ÿè™šæ‹Ÿè¡¨VT3, rug fromå­å¥ä¸­åŒ…å«ä¸¤ä¸ªä»¥ä¸Šçš„è¡¨çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå¯¹ä¸Šä¸€ä¸ªjoinè¿æ¥äº§ç”Ÿçš„ç»“æœVT3å’Œä¸‹ä¸€ä¸ªè¡¨é‡å¤æ‰§è¡Œæ­¥éª¤1~3è¿™ä¸‰ä¸ªæ­¥éª¤ï¼Œä¸€ç›´åˆ°å¤„ç†å®Œæ‰€æœ‰çš„è¡¨ä¸ºæ­¢\n4.WHEREï¼š å¯¹è™šæ‹Ÿè¡¨VT3è¿›è¡ŒWHEREæ¡ä»¶è¿‡æ»¤ã€‚åªæœ‰ç¬¦åˆçš„è®°å½•æ‰ä¼šè¢«æ’å…¥åˆ°è™šæ‹Ÿè¡¨VT4ä¸­ã€‚\n5.GROUP BY: æ ¹æ®group byå­å¥ä¸­çš„åˆ—ï¼Œå¯¹VT4ä¸­çš„è®°å½•è¿›è¡Œåˆ†ç»„æ“ä½œï¼Œäº§ç”ŸVT5.\n6.CUBE | ROLLUP: å¯¹è¡¨VT5è¿›è¡Œcubeæˆ–è€…rollupæ“ä½œï¼Œäº§ç”Ÿè¡¨VT6.\n7.HAVINGï¼š å¯¹è™šæ‹Ÿè¡¨VT6åº”ç”¨havingè¿‡æ»¤ï¼Œåªæœ‰ç¬¦åˆçš„è®°å½•æ‰ä¼šè¢« æ’å…¥åˆ°è™šæ‹Ÿè¡¨VT7ä¸­ã€‚\n8.SELECTï¼š æ‰§è¡Œselectæ“ä½œï¼Œé€‰æ‹©æŒ‡å®šçš„åˆ—ï¼Œæ’å…¥åˆ°è™šæ‹Ÿè¡¨VT8ä¸­ã€‚\n9.DISTINCTï¼š å¯¹VT8ä¸­çš„è®°å½•è¿›è¡Œå»é‡ã€‚äº§ç”Ÿè™šæ‹Ÿè¡¨VT9.\n10.ORDER BY: å°†è™šæ‹Ÿè¡¨VT9ä¸­çš„è®°å½•æŒ‰ç…§\u0026lt;order_by_list\u0026gt;è¿›è¡Œæ’åºæ“ä½œï¼Œäº§ç”Ÿè™šæ‹Ÿè¡¨VT10.\n11.LIMITï¼šå–å‡ºæŒ‡å®šè¡Œçš„è®°å½•ï¼Œäº§ç”Ÿè™šæ‹Ÿè¡¨VT11, å¹¶å°†ç»“æœè¿”å›ã€‚\nmysql æ‰§è¡Œé¡ºåº_MySQLå‘½ä»¤æ‰§è¡Œé¡ºåº\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%8B%BE%E9%81%97/%E6%AD%BB%E8%AE%B0%E7%A1%AC%E8%83%8C/","series":["Manual"],"tags":["CS"],"title":"æ­»è®°ç¡¬èƒŒ"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"æ³›å‹çš„å¥½å¤„  æä¾›äº†ä¸€ç§ç±»å‹å®‰å…¨æ£€æµ‹æœºåˆ¶ æå‡ç¨‹åºå¯è¯»æ€§  é€šé…ç¬¦ é€šé…ç¬¦çš„å‡ºç°æ˜¯ä¸ºäº†æŒ‡å®šæ³›å‹ä¸­çš„ç±»å‹èŒƒå›´ã€‚\né€šé…ç¬¦æœ‰ 3 ç§å½¢å¼ã€‚\n \u0026lt;?\u0026gt;è¢«ç§°ä½œæ— é™å®šçš„é€šé…ç¬¦ã€‚ \u0026lt;? extends T\u0026gt;è¢«ç§°ä½œæœ‰ä¸Šé™çš„é€šé…ç¬¦ã€‚ \u0026lt;? super T\u0026gt;è¢«ç§°ä½œæœ‰ä¸‹é™çš„é€šé…ç¬¦ã€‚   ? å…¶å®ä»£è¡¨çš„æ˜¯æœªçŸ¥ç±»å‹ï¼Œæ‰€ä»¥æ¶‰åŠåˆ° ? æ—¶çš„æ“ä½œï¼Œä¸€å®šä¸å…·ä½“ç±»å‹æ— å…³ã€‚\næœ‰äººè¯´ï¼Œ\u0026lt;?\u0026gt;æä¾›äº†åªè¯»çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å®ƒåˆ å‡äº†å¢åŠ å…·ä½“ç±»å‹å…ƒç´ çš„èƒ½åŠ›ï¼Œåªä¿ç•™ä¸å…·ä½“ç±»å‹æ— å…³çš„åŠŸèƒ½ã€‚å®ƒä¸ç®¡è£…è½½åœ¨è¿™ä¸ªå®¹å™¨å†…çš„å…ƒç´ æ˜¯ä»€ä¹ˆç±»å‹ï¼Œå®ƒåªå…³å¿ƒå…ƒç´ çš„æ•°é‡ã€å®¹å™¨æ˜¯å¦ä¸ºç©ºï¼Ÿæˆ‘æƒ³è¿™ç§éœ€æ±‚è¿˜æ˜¯å¾ˆå¸¸è§çš„å§ã€‚\næœ‰åŒå­¦å¯èƒ½ä¼šæƒ³ï¼Œ\u0026lt;?\u0026gt;æ—¢ç„¶ä½œç”¨è¿™ä¹ˆæ¸ºå°ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜è¦å¼•ç”¨å®ƒå‘¢ï¼Ÿ \nä¸ªäººè®¤ä¸ºï¼Œæé«˜äº†ä»£ç çš„å¯è¯»æ€§ï¼Œç¨‹åºå‘˜çœ‹åˆ°è¿™æ®µä»£ç æ—¶ï¼Œå°±èƒ½å¤Ÿè¿…é€Ÿå¯¹æ­¤å»ºç«‹æç®€æ´çš„å°è±¡ï¼Œèƒ½å¤Ÿå¿«é€Ÿæ¨æ–­æºç ä½œè€…çš„æ„å›¾ã€‚\nç±»å‹æ“¦é™¤ åœ¨æ³›å‹ç±»è¢«ç±»å‹æ“¦é™¤çš„æ—¶å€™ï¼Œä¹‹å‰æ³›å‹ç±»ä¸­çš„ç±»å‹å‚æ•°éƒ¨åˆ†å¦‚æœæ²¡æœ‰æŒ‡å®šä¸Šé™ï¼Œå¦‚ \u0026lt;T\u0026gt;åˆ™ä¼šè¢«è½¬è¯‘æˆæ™®é€šçš„ Object ç±»å‹ï¼Œå¦‚æœæŒ‡å®šäº†ä¸Šé™å¦‚ \u0026lt;T extends String\u0026gt;åˆ™ç±»å‹å‚æ•°å°±è¢«æ›¿æ¢æˆç±»å‹ä¸Šé™ã€‚\nç±»å‹æ“¦é™¤å¸¦æ¥çš„å±€é™æ€§ æ­£å¸¸æƒ…å†µä¸‹ï¼Œå› ä¸ºæ³›å‹çš„é™åˆ¶ï¼Œç¼–è¯‘å™¨ä¸è®©æœ€åä¸€è¡Œä»£ç ç¼–è¯‘é€šè¿‡ï¼Œå› ä¸ºç±»ä¼¼ä¸åŒ¹é…ï¼Œä½†æ˜¯ï¼ŒåŸºäºå¯¹ç±»å‹æ“¦é™¤çš„äº†è§£ï¼Œåˆ©ç”¨åå°„ï¼Œæˆ‘ä»¬å¯ä»¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ã€‚\né‚£ä¹ˆï¼Œåˆ©ç”¨åå°„ï¼Œæˆ‘ä»¬ç»•è¿‡ç¼–è¯‘å™¨å»è°ƒç”¨ add æ–¹æ³•ã€‚\npublic class ToolTest { public static void main(String[] args) { List\u0026lt;Integer\u0026gt; ls = new ArrayList\u0026lt;\u0026gt;(); ls.add(23); //\tls.add(\u0026#34;text\u0026#34;);  try { Method method = ls.getClass().getDeclaredMethod(\u0026#34;add\u0026#34;,Object.class); method.invoke(ls,\u0026#34;test\u0026#34;); method.invoke(ls,42.9f); } catch (NoSuchMethodException e) { // TODO Auto-generated catch block  e.printStackTrace(); } catch (SecurityException e) { // TODO Auto-generated catch block  e.printStackTrace(); } catch (IllegalAccessException e) { // TODO Auto-generated catch block  e.printStackTrace(); } catch (IllegalArgumentException e) { // TODO Auto-generated catch block  e.printStackTrace(); } catch (InvocationTargetException e) { // TODO Auto-generated catch block  e.printStackTrace(); } for ( Object o: ls){ System.out.println(o); } } } å‚è€ƒé“¾æ¥ Java æ³›å‹ï¼Œä½ äº†è§£ç±»å‹æ“¦é™¤å—ï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E6%B3%9B%E5%9E%8B/","series":["Manual"],"tags":["Java"],"title":"æ³›å‹"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"ç»“è®º  Javaä¸­å•ç²¾åº¦å’ŒåŒç²¾åº¦é‡‡ç”¨IEEE 754è¡¨ç¤ºï¼Œèƒ½æœ‰æ•ˆè¿ç®—çš„èŒƒå›´å¤§è‡´æ˜¯å°æ•°ç‚¹å7ä½å’Œ15ä½ å¦‚æœJavaä¸­é»˜è®¤çš„floatå’Œdoubleä¸èƒ½æ»¡è¶³ä½ çš„ç²¾åº¦è¦æ±‚ï¼Œå¯ä»¥ç”¨BigDecimalï¼Œç†è®ºä¸Šå®ƒçš„ç²¾åº¦åªå—é™åˆ¶ä¸æœºå™¨å†…å­˜ å¦‚æœBigDecimalä»æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œä¾‹å¦‚æ˜¯æ— é™å¾ªç¯å°æ•°çš„è¿ç®—ï¼Œå¯è€ƒè™‘è®¾è®¡åˆ†æ•°ç³»ç»Ÿä¿è¯è®¡ç®—çš„ç²¾åº¦  1. IEEE 754 ç²¾åº¦ä¸Šé™ ç¼–ç¨‹è¯­è¨€ä¸­çš„æµ®ç‚¹æ•°ä¸€èˆ¬éƒ½æ˜¯ 32 ä½çš„å•ç²¾åº¦æµ®ç‚¹æ•° float å’Œ 64 ä½çš„åŒç²¾åº¦æµ®ç‚¹æ•° doubleï¼Œéƒ¨åˆ†è¯­è¨€ä¼šä½¿ç”¨ float32 æˆ–è€… float64 åŒºåˆ†è¿™ä¸¤ç§ä¸åŒç²¾åº¦çš„æµ®ç‚¹æ•°ã€‚æƒ³è¦ä½¿ç”¨æœ‰é™çš„ä½æ•°è¡¨ç¤ºå…¨éƒ¨çš„å®æ•°æ˜¯ä¸å¯èƒ½çš„ï¼Œä¸ç”¨è¯´æ— é™é•¿åº¦çš„å°æ•°å’Œæ— ç†æ•°ï¼Œå› ä¸ºé•¿åº¦çš„é™åˆ¶ï¼Œæœ‰é™å°æ•°åœ¨æµ®ç‚¹æ•°ä¸­éƒ½æ— æ³•ç²¾ç¡®çš„è¡¨ç¤ºã€‚\n å•ç²¾åº¦æµ®ç‚¹æ•° float æ€»å…±åŒ…å« 32 ä½ï¼Œå…¶ä¸­ 1 ä½è¡¨ç¤ºç¬¦å·ã€8 ä½è¡¨ç¤ºæŒ‡æ•°ï¼Œæœ€å 23 ä½è¡¨ç¤ºå°æ•°ï¼› åŒç²¾åº¦æµ®ç‚¹æ•° double æ€»å…±åŒ…å« 64 ä½ï¼Œå…¶ä¸­ 1 ä½è¡¨ç¤ºç¬¦å·ï¼Œ11 ä½è¡¨ç¤ºæŒ‡æ•°ï¼Œæœ€å 52 ä½è¡¨ç¤ºå°æ•°ï¼›  æˆ‘ä»¬ä»¥å•ç²¾åº¦æµ®ç‚¹æ•° 0.15625 ä¸ºä¾‹:\né€šè¿‡ä¸Šå›¾ä¸­çš„å…¬å¼ (sign * 2^{exp}* (1+fraction))å¯ä»¥å°†æµ®ç‚¹æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºè½¬æ¢æˆåè¿›åˆ¶çš„å°æ•°ã€‚0.15625 è™½ç„¶è¿˜å¯ä»¥ç”¨å•ç²¾åº¦çš„æµ®ç‚¹æ•°ç²¾ç¡®è¡¨ç¤ºï¼Œä½†æ˜¯ 0.1 å’Œ 0.2 åªèƒ½ä½¿ç”¨æµ®ç‚¹æ•°è¡¨ç¤ºè¿‘ä¼¼çš„å€¼ï¼š\nå› ä¸º 0.2 å’Œ 0.1 åªæ˜¯æŒ‡æ•°ç¨æœ‰ä¸åŒï¼Œæ‰€ä»¥ä¸Šå›¾ä¸­åªå±•ç¤ºäº† 0.1 å¯¹åº”çš„å•ç²¾åº¦æµ®ç‚¹æ•°ï¼Œä»ä¸Šå›¾çš„ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ0.1 å’Œ 0.2 åœ¨æµ®ç‚¹æ•°ä¸­åªèƒ½ç”¨è¿‘ä¼¼å€¼æ¥ä»£æ›¿ï¼Œç²¾åº¦ååˆ†æœ‰é™ï¼Œå› ä¸ºå•ç²¾åº¦æµ®ç‚¹æ•°çš„å°æ•°ä½ä¸º 23ï¼ŒåŒç²¾åº¦çš„å°æ•°ä½ä¸º 52ï¼ŒåŒæ—¶éƒ½éšå¼åœ°åŒ…å«é¦–ä½çš„ 1ï¼Œæ‰€ä»¥å®ƒä»¬çš„ç²¾åº¦åœ¨åè¿›åˆ¶ä¸­åˆ†åˆ«æ˜¯(log_{10}(2^{24})\\approx 7.22) å’Œ (log_{10}(2^{53})\\approx 15.95) ä½ã€‚\nå› ä¸º 0.1 å’Œ 0.2 ä½¿ç”¨å•ç²¾åº¦æµ®ç‚¹æ•°è¡¨ç¤ºçš„å®é™…å€¼ä¸º 0.100000001490116119384765625 å’Œ 0.200000002980232238769531257ï¼Œæ‰€ä»¥å®ƒä»¬åœ¨ç›¸åŠ åå°±å¾—åˆ°çš„ç»“æœä¸æˆ‘ä»¬åœ¨ä¸€å¼€å§‹çœ‹åˆ°çš„éå¸¸ç›¸ä¼¼ï¼š\nä¸Šå›¾åªæ˜¯ä½¿ç”¨å•ç²¾åº¦æµ®ç‚¹æ•°è¡¨ç¤ºçš„æ•°å­—ï¼Œå¦‚æœä½¿ç”¨åŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œæœ€ç»ˆç»“æœä¸­çš„ 3 å’Œ 4 ä¹‹é—´ä¼šæœ‰æ›´å¤šçš„ 0ï¼Œä½†æ˜¯å°æ•°å‡ºç°çš„é¡ºåºæ˜¯éå¸¸ç›¸ä¼¼çš„ã€‚æµ®ç‚¹æ•°çš„è¿ç®—æ³•åˆ™ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå¤æ‚ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œæœç´¢ç›¸å…³çš„èµ„æ–™ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¸å±•å¼€ä»‹ç»äº†ã€‚\n2. BigDecimal ä¸ºäº†è§£å†³æµ®ç‚¹æ•°çš„ç²¾åº¦é—®é¢˜ï¼Œä¸€äº›ç¼–ç¨‹è¯­è¨€å¼•å…¥äº†åè¿›åˆ¶çš„å°æ•° Decimalã€‚Decimal åœ¨ä¸åŒç¤¾åŒºä¸­éƒ½ååˆ†å¸¸è§ï¼Œå¦‚æœç¼–ç¨‹è¯­è¨€æ²¡æœ‰åŸç”Ÿæ”¯æŒ Decimalï¼Œæˆ‘ä»¬åœ¨å¼€æºç¤¾åŒºä¹Ÿä¸€å®šèƒ½å¤Ÿæ‰¾åˆ°ä½¿ç”¨ç‰¹å®šè¯­è¨€å®ç°çš„ Decimal åº“ã€‚Java é€šè¿‡ BigDecimal æä¾›äº†æ— é™ç²¾åº¦çš„å°æ•°ï¼Œè¯¥ç±»ä¸­åŒ…å«ä¸‰ä¸ªå…³é”®çš„æˆå‘˜å˜é‡ intValã€scale å’Œ precisionï¼š\npublic class BigDecimal extends Number implements Comparable\u0026lt;BigDecimal\u0026gt; {\rprivate BigInteger intVal;\rprivate int scale;\rprivate int precision = 0;\r...\r}\rå½“æˆ‘ä»¬ä½¿ç”¨ BigDecimal è¡¨ç¤º 1234.56 æ—¶ï¼ŒBigDecimal ä¸­çš„ä¸‰ä¸ªå­—æ®µä¼šåˆ†åˆ«ä»¥ä¸‹çš„å†…å®¹ï¼š\n intVal ä¸­å­˜å‚¨çš„æ˜¯å»æ‰å°æ•°ç‚¹åçš„å…¨éƒ¨æ•°å­—ï¼Œå³ 123456ï¼› scale ä¸­å­˜å‚¨çš„æ˜¯å°æ•°çš„ä½æ•°ï¼Œå³ 2ï¼› prevision ä¸­å­˜å‚¨çš„æ˜¯å…¨éƒ¨çš„æœ‰æ•ˆä½æ•°ï¼Œå°æ•°ç‚¹å‰ 4 ä½ï¼Œå°æ•°ç‚¹å 2 ä½ï¼Œå³ 6ï¼›  BigDecimal è¿™ç§ä½¿ç”¨å¤šä¸ªæ•´æ•°çš„æ–¹æ³•é¿å¼€äº†äºŒè¿›åˆ¶æ— æ³•å‡†ç¡®è¡¨ç¤ºéƒ¨åˆ†åè¿›åˆ¶å°æ•°çš„é—®é¢˜ï¼Œå› ä¸º BigInteger å¯ä»¥ä½¿ç”¨æ•°ç»„è¡¨ç¤ºä»»æ„é•¿åº¦çš„æ•´æ•°ï¼Œæ‰€ä»¥å¦‚æœæœºå™¨çš„å†…å­˜èµ„æºæ˜¯æ— é™çš„ï¼ŒBigDecimal åœ¨ç†è®ºä¸Šä¹Ÿå¯ä»¥è¡¨ç¤ºæ— é™ç²¾åº¦çš„å°æ•°ã€‚\nè™½ç„¶éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€å®ç°äº†ç†è®ºä¸Šæ— é™ç²¾åº¦çš„ BigDecimalï¼Œä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¸­æˆ‘ä»¬å¤§å¤šä¸éœ€è¦æ— é™çš„ç²¾åº¦ä¿è¯ï¼ŒC# ç­‰ç¼–ç¨‹è¯­è¨€é€šè¿‡ 16 å­—èŠ‚çš„ Decimal æä¾›çš„ 28 ~ 29 ä½çš„ç²¾åº¦ï¼Œè€Œåœ¨é‡‘èç³»ç»Ÿä¸­ä½¿ç”¨ 16 å­—èŠ‚çš„ Decimal ä¸€èˆ¬å°±å¯ä»¥ä¿è¯æ•°æ®è®¡ç®—çš„å‡†ç¡®æ€§äº†ã€‚\næœ‰ç†æ•° ä½¿ç”¨ Decimal å’Œ BigDecimal è™½ç„¶å¯ä»¥åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šè§£å†³æµ®ç‚¹æ•°çš„ç²¾åº¦é—®é¢˜ï¼Œä½†æ˜¯å®ƒä»¬åœ¨é‡åˆ°æ— é™å°æ•°æ—¶ä»ç„¶æ— èƒ½ä¸ºåŠ›ï¼Œä½¿ç”¨åè¿›åˆ¶çš„å°æ•°æ°¸è¿œæ— æ³•å‡†ç¡®åœ°è¡¨ç¤º 1/3ï¼Œæ— è®ºä½¿ç”¨å¤šå°‘ä½å°æ•°éƒ½æ— æ³•é¿å…ç²¾åº¦çš„æŸå¤±ï¼š\nå½“æˆ‘ä»¬é‡åˆ°è¿™ç§æƒ…å†µæ—¶ï¼Œä½¿ç”¨æœ‰ç†æ•°ï¼ˆRationalï¼‰æ˜¯è§£å†³ç±»ä¼¼é—®é¢˜çš„æœ€å¥½æ–¹æ³•ï¼Œä½¿ç”¨åˆ†æ•°å¯ä»¥å‡†ç¡®çš„è¡¨ç¤º 1/10ã€1/5 å’Œ 1/3\nè¿™ç§è§£å†³ç²¾åº¦é—®é¢˜çš„æ–¹æ³•æ›´æ¥è¿‘åŸå§‹çš„æ•°å­¦å…¬å¼ï¼Œåˆ†æ•°çš„åˆ†å­å’Œåˆ†æ¯æ˜¯æœ‰ç†æ•°ç»“æ„ä½“ä¸­çš„ä¸¤ä¸ªå˜é‡ï¼Œå¤šä¸ªåˆ†æ•°çš„åŠ å‡ä¹˜é™¤æ“ä½œä¸æ•°å­¦ä¸­å¯¹åˆ†æ•°çš„è®¡ç®—æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸ä¼šé€ æˆç²¾åº¦çš„æŸå¤±ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•äº†è§£ä¸€ä¸‹ Java ä¸­æœ‰ç†æ•°çš„å®ç°7\rï¼š\npublic class Rational implements Comparable\u0026lt;Rational\u0026gt; {\rprivate int num; // the numerator\rprivate int den; // the denominator\rpublic double toDouble() {\rreturn (double) num / den;\r}\r...\r}\rä¸Šè¿°ç±»ä¸­çš„ num å’Œ den åˆ†åˆ«è¡¨ç¤ºåˆ†æ•°çš„åˆ†å­å’Œåˆ†æ¯ï¼Œå®ƒæä¾›çš„ toDouble æ–¹æ³•å¯ä»¥å°†å½“å‰æœ‰ç†æ•°è½¬æ¢æˆæµ®ç‚¹æ•°ï¼Œå› ä¸ºæµ®ç‚¹æ•°åœ¨è½¯ä»¶å·¥ç¨‹ä¸­è™½ç„¶æ›´åŠ å¸¸ç”¨ï¼Œå½“æˆ‘ä»¬éœ€è¦ä¸¥å¯†çš„ç§‘å­¦è®¡ç®—æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æœ‰ç†æ•°å®Œæˆç»å¤§å¤šæ•°çš„è®¡ç®—ï¼Œå¹¶åœ¨æœ€åè½¬æ¢å›æµ®ç‚¹æ•°ä»¥å‡å°‘å¯èƒ½å‡ºç°çš„è¯¯å·®ã€‚\nç„¶è€Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§ä½¿ç”¨æœ‰ç†æ•°è®¡ç®—çš„æ–¹å¼ä¸ä»…åœ¨ä½¿ç”¨ä¸Šç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œå®ƒåœ¨æ€§èƒ½ä¸Šä¹Ÿæ— æ³•ä¸æµ®ç‚¹æ•°è¿›è¡Œæ¯”è¾ƒï¼Œä¸€æ¬¡å¸¸è§çš„åŠ å‡æ³•å°±éœ€è¦ä½¿ç”¨å‡ å€äºæµ®ç‚¹æ•°æ“ä½œçš„æ±‡ç¼–æŒ‡ä»¤ï¼Œæ‰€ä»¥åœ¨éå¿…è¦çš„åœºæ™¯ä¸­ä¸€å®šè¦å°½é‡é¿å…ã€‚\nå‚è€ƒé“¾æ¥ï¼š ä¸ºä»€ä¹ˆ 0.1 + 0.2 = 0.3\rä¸ºä»€ä¹ˆ 0.1 + 0.2 = 0.300000004\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E6%B5%AE%E7%82%B9%E6%95%B0%E8%BF%90%E7%AE%97/","series":["Manual"],"tags":["Java"],"title":"æµ®ç‚¹æ•°è¿ç®—"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å‰è¨€ ä¸Šæ–‡æˆ‘ä»¬èŠäº†åŸºäºSentinelçš„Redisé«˜å¯ç”¨æ¶æ„ï¼Œäº†è§£äº†RedisåŸºäºè¯»å†™åˆ†ç¦»çš„ä¸»ä»æ¶æ„ï¼ŒåŒæ—¶ä¹ŸçŸ¥é“å½“Redisçš„masterå‘ç”Ÿæ•…éšœä¹‹åï¼ŒSentinelé›†ç¾¤æ˜¯å¦‚ä½•æ‰§è¡Œfailoverçš„ï¼Œä»¥åŠå…¶æ‰§è¡Œfailoverçš„åŸç†æ˜¯ä»€ä¹ˆã€‚\nè¿™é‡Œå¤§æ¦‚å†æä¸€ä¸‹ï¼ŒSentinelé›†ç¾¤ä¼šå¯¹Redisçš„ä¸»ä»æ¶æ„ä¸­çš„Rediså®ä¾‹è¿›è¡Œç›‘æ§ï¼Œä¸€æ—¦å‘ç°äº†masterèŠ‚ç‚¹å®•æœºäº†ï¼Œå°±ä¼šé€‰ä¸¾å‡ºä¸€ä¸ªSentinelèŠ‚ç‚¹æ¥æ‰§è¡Œæ•…éšœè½¬ç§»ï¼Œä»åŸæ¥çš„slaveèŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªï¼Œå°†å…¶æå‡ä¸ºmasterèŠ‚ç‚¹ï¼Œç„¶åè®©å…¶ä»–çš„èŠ‚ç‚¹å»å¤åˆ¶æ–°é€‰ä¸¾å‡ºæ¥çš„masterèŠ‚ç‚¹ã€‚\nä½ å¯èƒ½ä¼šè§‰å¾—è¿™æ ·æ²¡æœ‰é—®é¢˜å•Šï¼Œç”šè‡³èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒçš„ä½¿ç”¨éœ€æ±‚äº†ï¼Œé‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜éœ€è¦Redis Clusterå‘¢ï¼Ÿ\n1. ä¸ºä»€ä¹ˆéœ€è¦Redis Cluster çš„ç¡®ï¼Œåœ¨æ•°æ®ä¸Šï¼Œæœ‰replicationå‰¯æœ¬åšä¿è¯ï¼›å¯ç”¨æ€§ä¸Šï¼Œmasterå®•æœºä¼šè‡ªåŠ¨çš„æ‰§è¡Œfailoverã€‚\n é‚£é—®é¢˜åœ¨å“ªå„¿å‘¢ï¼Ÿ\n é¦–å…ˆRedis Sentinelè¯´ç™½äº†ä¹Ÿæ˜¯åŸºäºä¸»ä»å¤åˆ¶ï¼Œåœ¨ä¸»ä»å¤åˆ¶ä¸­slaveçš„æ•°æ®æ˜¯å®Œå…¨æ¥è‡ªäºmasterã€‚\nå‡è®¾masterèŠ‚ç‚¹çš„å†…å­˜åªæœ‰4Gï¼Œé‚£slaveèŠ‚ç‚¹æ‰€èƒ½å­˜å‚¨çš„æ•°æ®ä¸Šé™ä¹Ÿåªèƒ½æ˜¯4Gã€‚è€Œä¸”åœ¨ä¹‹å‰çš„è·Ÿéšæ ç²¾çš„è§†è§’ä¸€èµ·æ¥äº†è§£Redisçš„ä¸»ä»å¤åˆ¶\ræ–‡ç« ä¸­ä¹Ÿè¯´è¿‡ï¼Œä¸»ä»å¤åˆ¶æ¶æ„ä¸­æ˜¯è¯»å†™åˆ†ç¦»çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ slaveèŠ‚ç‚¹æ¥æ‰©å±•ä¸»ä»çš„è¯»å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯å†™èƒ½åŠ›å’Œå­˜å‚¨èƒ½åŠ›æ˜¯æ— æ³•è¿›è¡Œæ‰©å±•çš„ï¼Œå°±åªèƒ½æ˜¯masterèŠ‚ç‚¹èƒ½å¤Ÿæ‰¿è½½çš„ä¸Šé™ã€‚\næ‰€ä»¥ï¼Œå½“ä½ åªéœ€è¦å­˜å‚¨4Gçš„æ•°æ®æ—¶å€™çš„ï¼ŒåŸºäºä¸»ä»å¤åˆ¶å’ŒåŸºäºSentinelçš„é«˜å¯ç”¨æ¶æ„æ˜¯å®Œå…¨å¤Ÿç”¨çš„ã€‚\nä½†æ˜¯å¦‚æœå½“ä½ é¢ä¸´çš„æ˜¯æµ·é‡çš„æ•°æ®çš„æ—¶å€™å‘¢ï¼Ÿ16Gã€64Gã€256Gç”šè‡³1Tå‘¢ï¼Ÿç°åœ¨äº’è”ç½‘çš„ä¸šåŠ¡é‡Œé¢ï¼Œå¦‚æœä½ çš„ä½“é‡è¶³å¤Ÿå¤§ï¼Œæˆ‘è§‰å¾—æ˜¯è‚¯å®šä¼šé¢ä¸´ç¼“å­˜æµ·é‡ç¼“å­˜æ•°æ®çš„åœºæ™¯çš„ã€‚\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å¼•å…¥Redis Clusterã€‚\n2. Redis Clusteræ˜¯ä»€ä¹ˆ çŸ¥é“äº†ä¸ºä»€ä¹ˆéœ€è¦Redis Clusterä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥å¯¹å…¶ä¸€æ¢ç©¶ç«Ÿäº†ã€‚\n é‚£ä»€ä¹ˆæ˜¯Redis Clusterå‘¢ï¼Ÿ\n å¾ˆç®€å•ï¼Œä½ å°±å¯ä»¥ç†è§£ä¸ºnä¸ªä¸»ä»æ¶æ„ç»„åˆåœ¨ä¸€èµ·å¯¹å¤–æœåŠ¡ã€‚Redis Clusterè¦æ±‚è‡³å°‘éœ€è¦3ä¸ªmasteræ‰èƒ½ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼ŒåŒæ—¶æ¯ä¸ªmasterè‡³å°‘éœ€è¦æœ‰ä¸€ä¸ªslaveèŠ‚ç‚¹ã€‚\nè¿™æ ·ä¸€æ¥ï¼Œå¦‚æœä¸€ä¸ªä¸»ä»èƒ½å¤Ÿå­˜å‚¨32Gçš„æ•°æ®ï¼Œå¦‚æœè¿™ä¸ªé›†ç¾¤åŒ…å«äº†ä¸¤ä¸ªä¸»ä»ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤å°±èƒ½å¤Ÿå­˜å‚¨64Gçš„æ•°æ®ã€‚\næˆ‘ä»¬çŸ¥é“ï¼Œä¸»ä»æ¶æ„ä¸­ï¼Œå¯ä»¥é€šè¿‡å¢åŠ slaveèŠ‚ç‚¹çš„æ–¹å¼æ¥æ‰©å±•è¯»è¯·æ±‚çš„å¹¶å‘é‡ï¼Œé‚£Redis Clusterä¸­æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿè™½ç„¶æ¯ä¸ªmasterä¸‹éƒ½æŒ‚è½½äº†ä¸€ä¸ªslaveèŠ‚ç‚¹ï¼Œä½†æ˜¯åœ¨Redis Clusterä¸­çš„è¯»ã€å†™è¯·æ±‚å…¶å®éƒ½æ˜¯åœ¨masterä¸Šå®Œæˆçš„ã€‚\nslaveèŠ‚ç‚¹åªæ˜¯å……å½“äº†ä¸€ä¸ªæ•°æ®å¤‡ä»½çš„è§’è‰²ï¼Œå½“masterå‘ç”Ÿäº†å®•æœºï¼Œå°±ä¼šå°†å¯¹åº”çš„slaveèŠ‚ç‚¹ææ‹”ä¸ºmasterï¼Œæ¥é‡æ–°å¯¹å¤–æä¾›æœåŠ¡ã€‚\n3. èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ çŸ¥é“äº†ä»€ä¹ˆæ˜¯Redis Clusterï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­ä¸‹é¢çš„è®¨è®ºäº†ã€‚\nä¸çŸ¥é“ä½ æ€è€ƒè¿‡ä¸€ä¸ªé—®é¢˜æ²¡ï¼Œè¿™ä¹ˆå¤šçš„masterèŠ‚ç‚¹ã€‚æˆ‘å­˜å‚¨çš„æ—¶å€™ï¼Œåˆ°åº•è¯¥é€‰æ‹©å“ªä¸ªèŠ‚ç‚¹å‘¢ï¼Ÿä¸€èˆ¬è¿™ç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä¼šé€‰æ‹©å“ˆå¸Œç®—æ³•ã€‚å“ˆå¸Œç®—æ³•æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ\né¦–å…ˆå°±æ˜¯å¯¹keyè®¡ç®—å‡ºä¸€ä¸ªhashå€¼ï¼Œç„¶åç”¨å“ˆå¸Œå€¼å¯¹masteræ•°é‡è¿›è¡Œå–æ¨¡ã€‚ç”±æ­¤å°±å¯ä»¥å°†keyè´Ÿè½½å‡è¡¡åˆ°æ¯ä¸€ä¸ªRedisèŠ‚ç‚¹ä¸Šå»ã€‚è¿™å°±æ˜¯ç®€å•çš„å“ˆå¸Œç®—æ³•çš„å®ç°ã€‚\né‚£Redis Clusteræ˜¯é‡‡å–çš„ä¸Šé¢çš„å“ˆå¸Œç®—æ³•å—ï¼Ÿç­”æ¡ˆæ˜¯æ²¡æœ‰ã€‚\nRedis Clusterå…¶å®é‡‡å–çš„æ˜¯ç±»ä¼¼äºä¸€è‡´æ€§å“ˆå¸Œçš„ç®—æ³•æ¥å®ç°èŠ‚ç‚¹é€‰æ‹©çš„ã€‚é‚£ä¸ºä»€ä¹ˆä¸ç”¨å“ˆå¸Œç®—æ³•æ¥è¿›è¡Œå®ä¾‹é€‰æ‹©å‘¢ï¼Ÿä»¥åŠä¸ºä»€ä¹ˆè¯´æ˜¯ç±»ä¼¼çš„å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­è®¨è®ºã€‚\nå› ä¸ºå¦‚æœæ­¤æ—¶æŸä¸€å°masterå‘ç”Ÿäº†å®•æœºï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šå¯¼è‡´Redisä¸­æ‰€æœ‰çš„ç¼“å­˜å¤±æ•ˆã€‚ä¸ºä»€ä¹ˆæ˜¯æ‰€æœ‰çš„ï¼Ÿå‡è®¾ä¹‹å‰æœ‰3ä¸ªmasterï¼Œé‚£ä¹ˆä¹‹å‰çš„ç®—æ³•åº”è¯¥æ˜¯ hash % 3ï¼Œä½†æ˜¯å¦‚æœå…¶ä¸­ä¸€å°masterå®•æœºäº†ï¼Œåˆ™ç®—æ³•å°±ä¼šå˜æˆ hash % 2ï¼Œä¼šå½±å“åˆ°ä¹‹å‰å­˜å‚¨çš„æ‰€æœ‰çš„keyã€‚è€Œè¿™å¯¹ç¼“å­˜åé¢ä¿æŠ¤çš„DBæ¥è¯´ï¼Œæ˜¯è‡´å‘½çš„æ‰“å‡»ã€‚\n4. ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§å“ˆå¸Œ çŸ¥é“äº†é€šè¿‡ä¼ ç»Ÿå“ˆå¸Œç®—æ³•æ¥å®ç°å¯¹èŠ‚ç‚¹çš„è´Ÿè½½å‡è¡¡çš„å¼Šç«¯ï¼Œæˆ‘ä»¬å°±éœ€è¦è¿›ä¸€æ­¥äº†è§£ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§å“ˆå¸Œã€‚\næˆ‘ä»¬ä¸Šé¢æè¿‡å“ˆå¸Œç®—æ³•æ˜¯å¯¹masterå®ä¾‹æ•°é‡æ¥å–æ¨¡ï¼Œè€Œä¸€è‡´æ€§å“ˆå¸Œåˆ™æ˜¯å¯¹2^32å–æ¨¡ï¼Œä¹Ÿå°±æ˜¯å€¼çš„èŒƒå›´åœ¨[0, 2^32 -1]ã€‚ä¸€è‡´æ€§å“ˆå¸Œå°†å…¶èŒƒå›´æŠ½è±¡æˆäº†ä¸€ä¸ªåœ†ç¯ï¼Œä½¿ç”¨CRC16ç®—æ³•è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼ä¼šè½åˆ°åœ†ç¯ä¸Šçš„æŸä¸ªåœ°æ–¹ã€‚\nç„¶åæˆ‘ä»¬çš„Rediså®ä¾‹ä¹Ÿåˆ†å¸ƒåœ¨åœ†ç¯ä¸Šï¼Œæˆ‘ä»¬åœ¨åœ†ç¯ä¸ŠæŒ‰ç…§é¡ºæ—¶é’ˆçš„é¡ºåºæ‰¾åˆ°ç¬¬ä¸€ä¸ªRediså®ä¾‹ï¼Œè¿™æ ·å°±å®Œæˆäº†å¯¹keyçš„èŠ‚ç‚¹åˆ†é…ã€‚æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ã€‚\nå‡è®¾æˆ‘ä»¬æœ‰Aã€Bã€Cä¸‰ä¸ªRediså®ä¾‹æŒ‰ç…§å¦‚å›¾æ‰€ç¤ºçš„ä½ç½®åˆ†å¸ƒåœ¨åœ†ç¯ä¸Šï¼Œæ­¤æ—¶è®¡ç®—å‡ºæ¥çš„hashå€¼ï¼Œå–æ¨¡ä¹‹åä½ç½®è½åœ¨äº†ä½ç½®Dï¼Œé‚£ä¹ˆæˆ‘ä»¬æŒ‰ç…§é¡ºæ—¶é’ˆçš„é¡ºåºï¼Œå°±èƒ½å¤Ÿæ‰¾åˆ°æˆ‘ä»¬è¿™ä¸ªkeyåº”è¯¥åˆ†é…çš„Rediså®ä¾‹Bã€‚åŒç†å¦‚æœæˆ‘ä»¬è®¡ç®—å‡ºæ¥ä½ç½®åœ¨Eï¼Œé‚£ä¹ˆå¯¹åº”é€‰æ‹©çš„Redisçš„å®ä¾‹å°±æ˜¯Aã€‚\nå³ä½¿è¿™ä¸ªæ—¶å€™Rediså®ä¾‹BæŒ‚äº†ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°å®ä¾‹Aå’ŒCçš„ç¼“å­˜ã€‚\nä¾‹å¦‚æ­¤æ—¶èŠ‚ç‚¹BæŒ‚äº†ï¼Œé‚£ä¹‹å‰è®¡ç®—å‡ºæ¥åœ¨ä½ç½®Dçš„keyï¼Œæ­¤æ—¶ä¼šæŒ‰ç…§é¡ºæ—¶é’ˆçš„é¡ºåºï¼Œæ‰¾åˆ°èŠ‚ç‚¹Cã€‚ç›¸å½“äºè‡ªåŠ¨çš„æŠŠåŸæ¥èŠ‚ç‚¹Bçš„æµé‡ç»™è½¬ç§»åˆ°äº†èŠ‚ç‚¹Cä¸Šå»ã€‚è€Œå…¶ä»–åŸæœ¬å°±åœ¨èŠ‚ç‚¹Aå’ŒèŠ‚ç‚¹Cçš„æ•°æ®åˆ™å®Œå…¨ä¸å—å½±å“ã€‚\nè¿™å°±æ˜¯ä¸€è‡´æ€§å“ˆå¸Œï¼Œèƒ½å¤Ÿåœ¨æˆ‘ä»¬åç»­éœ€è¦æ–°å¢èŠ‚ç‚¹æˆ–è€…åˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¸å½±å“å…¶ä»–èŠ‚ç‚¹çš„æ­£å¸¸è¿è¡Œã€‚\n5. è™šæ‹ŸèŠ‚ç‚¹æœºåˆ¶ ä½†æ˜¯ä¸€è‡´æ€§å“ˆå¸Œä¹Ÿå­˜åœ¨è‡ªèº«çš„å°é—®é¢˜ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬çš„RedisèŠ‚ç‚¹åˆ†å¸ƒå¦‚ä¸‹æ—¶ï¼Œå°±æœ‰é—®é¢˜äº†ã€‚\næ­¤æ—¶æ•°æ®è½åœ¨èŠ‚ç‚¹Aä¸Šçš„æ¦‚ç‡æ˜æ˜¾æ˜¯å¤§äºå…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹çš„ï¼Œå…¶æ¬¡è½åœ¨èŠ‚ç‚¹Cä¸Šçš„æ¦‚ç‡æœ€å°ã€‚è¿™æ ·ä¸€æ¥ä¼šå¯¼è‡´æ•´ä¸ªé›†ç¾¤çš„æ•°æ®å­˜å‚¨ä¸å¹³è¡¡ï¼ŒABèŠ‚ç‚¹å‹åŠ›è¾ƒå¤§ï¼Œè€ŒCèŠ‚ç‚¹èµ„æºåˆ©ç”¨ä¸å……åˆ†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹æœºåˆ¶ã€‚\nåœ¨åœ†ç¯ä¸­ï¼Œå¢åŠ äº†å¯¹åº”èŠ‚ç‚¹çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œç„¶åå®Œæˆäº†è™šæ‹ŸèŠ‚ç‚¹åˆ°çœŸå®èŠ‚ç‚¹çš„æ˜ å°„ã€‚å‡è®¾ç°åœ¨è®¡ç®—å¾—å‡ºäº†ä½ç½®Dï¼Œé‚£ä¹ˆæŒ‰ç…§é¡ºæ—¶é’ˆçš„é¡ºåºï¼Œæˆ‘ä»¬æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯C #1ï¼Œæœ€ç»ˆæ•°æ®å®é™…è¿˜æ˜¯ä¼šè½åœ¨èŠ‚ç‚¹Cä¸Šã€‚\né€šè¿‡å¢åŠ è™šæ‹ŸèŠ‚ç‚¹çš„æ–¹å¼ï¼Œä½¿ABCä¸‰ä¸ªèŠ‚ç‚¹åœ¨åœ†ç¯ä¸Šçš„ä½ç½®æ›´åŠ å‡åŒ€ï¼Œå¹³å‡äº†è½åœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„æ¦‚ç‡ã€‚è¿™æ ·ä¸€æ¥å°±è§£å†³äº†ä¸Šæ–‡æåˆ°çš„æ•°æ®å­˜å‚¨å­˜åœ¨ä¸å‡åŒ€çš„é—®é¢˜äº†ï¼Œè¿™å°±æ˜¯ä¸€è‡´æ€§å“ˆå¸Œçš„è™šæ‹ŸèŠ‚ç‚¹æœºåˆ¶ã€‚\n6. Redis Clusteré‡‡ç”¨çš„ä»€ä¹ˆç®—æ³• ä¸Šé¢æåˆ°è¿‡ï¼ŒRedis Clusteré‡‡ç”¨çš„æ˜¯ç±»ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œä¹‹æ‰€ä»¥æ˜¯ç±»ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯å› ä¸ºå®ƒä»¬å®ç°çš„æ–¹å¼è¿˜ç•¥å¾®æœ‰å·®åˆ«ã€‚\nä¾‹å¦‚ä¸€è‡´æ€§å“ˆå¸Œæ˜¯å¯¹2^32å–æ¨¡ï¼Œè€ŒRedis Clusteråˆ™æ˜¯å¯¹2^14ï¼ˆä¹Ÿå°±æ˜¯16384ï¼‰å–æ¨¡ã€‚Redis Clusterå°†è‡ªå·±åˆ†æˆäº†16384ä¸ªSlotï¼ˆæ§½ä½ï¼‰ã€‚é€šè¿‡CRC16ç®—æ³•è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼ä¼šè·Ÿ16384å–æ¨¡ï¼Œå–æ¨¡ä¹‹åå¾—åˆ°çš„å€¼å°±æ˜¯å¯¹åº”çš„æ§½ä½ï¼Œç„¶åæ¯ä¸ªRedisèŠ‚ç‚¹éƒ½ä¼šè´Ÿè´£å¤„ç†ä¸€éƒ¨åˆ†çš„æ§½ä½ï¼Œå°±åƒä¸‹è¡¨è¿™æ ·ã€‚\n   èŠ‚ç‚¹ å¤„ç†æ§½ä½     A 0 - 5000   B 5001 - 10000   C 10001 - 16383    æ¯ä¸ªRediså®ä¾‹ä¼šè‡ªå·±ç»´æŠ¤ä¸€ä»½slot - RedisèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼Œå‡è®¾ä½ åœ¨èŠ‚ç‚¹Aä¸Šè®¾ç½®äº†æŸä¸ªkeyï¼Œä½†æ˜¯è¿™ä¸ªkeyé€šè¿‡CRC16è®¡ç®—å‡ºæ¥çš„æ§½ä½æ˜¯ç”±èŠ‚ç‚¹Bç»´æŠ¤çš„ï¼Œé‚£ä¹ˆå°±ä¼šæç¤ºä½ éœ€è¦å»èŠ‚ç‚¹Bä¸Šè¿›è¡Œæ“ä½œã€‚\n7. Redis Clusterå¦‚ä½•åšåˆ°é«˜å¯ç”¨ ä¸çŸ¥é“ä½ æ€è€ƒè¿‡ä¸€ä¸ªé—®é¢˜æ²¡ï¼Œå¦‚æœRedis Clusterä¸­çš„æŸä¸ªmasterèŠ‚ç‚¹æŒ‚äº†ï¼Œå®ƒæ˜¯å¦‚ä½•ä¿è¯é›†ç¾¤è‡ªèº«çš„é«˜å¯ç”¨çš„ï¼Ÿå¦‚æœè¿™ä¸ªæ—¶å€™æˆ‘ä»¬é›†ç¾¤éœ€è¦æ‰©å®¹èŠ‚ç‚¹ï¼Œå®ƒè¯¥è´Ÿè´£å“ªäº›æ§½ä½å‘¢ï¼Ÿæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªé—®é¢˜çš„æ¥çœ‹ä¸€ä¸‹ã€‚\né›†ç¾¤å¦‚ä½•è¿›è¡Œæ‰©å®¹ æˆ‘ä»¬å¼€ç¯‡èŠè¿‡ï¼ŒRedis Clusterå¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œæ¨ªå‘æ‰©å®¹ï¼Œé‚£å½“æ–°çš„èŠ‚ç‚¹åŠ å…¥è¿›æ¥çš„æ—¶å€™ï¼Œå®ƒæ˜¯å¦‚ä½•è·å–å¯¹åº”çš„slotçš„å‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯é€šè¿‡reshardï¼ˆé‡æ–°åˆ†ç‰‡ï¼‰æ¥å®ç°ã€‚reshardå¯ä»¥å°†å·²ç»åˆ†é…ç»™æŸä¸ªèŠ‚ç‚¹çš„ä»»æ„æ•°é‡çš„slotè¿ç§»ç»™å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåœ¨Rediså†…éƒ¨æ˜¯ç”±redis-tribè´Ÿè´£æ‰§è¡Œçš„ã€‚ä½ å¯ä»¥ç†è§£ä¸ºRediså…¶å®å·²ç»å°è£…å¥½äº†æ‰€æœ‰çš„å‘½ä»¤ï¼Œè€Œredis-tribåˆ™è´Ÿè´£å‘è·å–slotçš„èŠ‚ç‚¹å’Œè¢«è½¬ç§»slotçš„èŠ‚ç‚¹å‘é€å‘½ä»¤æ¥æœ€ç»ˆå®ç°reshardã€‚\nå‡è®¾æˆ‘ä»¬éœ€è¦å‘é›†ç¾¤ä¸­åŠ å…¥ä¸€ä¸ªDèŠ‚ç‚¹ï¼Œè€Œæ­¤æ—¶é›†ç¾¤å†…å·²ç»æœ‰Aã€Bã€Cä¸‰ä¸ªèŠ‚ç‚¹äº†ã€‚\næ­¤æ—¶redis-tribä¼šå‘Aã€Bã€Cä¸‰ä¸ªèŠ‚ç‚¹å‘é€è¿ç§»å‡ºæ§½ä½çš„è¯·æ±‚ï¼ŒåŒæ—¶å‘DèŠ‚ç‚¹å‘é€å‡†å¤‡å¯¼å…¥æ§½ä½çš„è¯·æ±‚ï¼Œåšå¥½å‡†å¤‡ä¹‹åAã€Bã€Cè¿™ä¸‰ä¸ªæºèŠ‚ç‚¹å°±å¼€å§‹æ‰§è¡Œè¿ç§»ï¼Œå°†å¯¹åº”çš„slotæ‰€å¯¹åº”çš„é”®å€¼å¯¹è¿ç§»è‡³ç›®æ ‡èŠ‚ç‚¹Dã€‚æœ€åredis-tribä¼šå‘é›†ç¾¤ä¸­æ‰€æœ‰ä¸»èŠ‚ç‚¹å‘é€æ§½ä½çš„å˜æ›´ä¿¡æ¯ã€‚\né«˜å¯ç”¨åŠæ•…éšœè½¬ç§» Redis Clusterä¸­ä¿è¯é›†ç¾¤é«˜å¯ç”¨çš„æ€è·¯å’Œå®ç°å’ŒRedis Sentinelå¦‚å‡ºä¸€è¾™ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹æˆ‘ä¹‹å‰å†™çš„å…³äºSentinelçš„æ–‡ç« Redis Sentinel-æ·±å…¥æµ…å‡ºåŸç†å’Œå®æˆ˜\rã€‚\nç®€å•æ¥è¯´ï¼Œé’ˆå¯¹AèŠ‚ç‚¹ï¼ŒæŸä¸€ä¸ªèŠ‚ç‚¹è®¤ä¸ºAå®•æœºäº†ï¼Œé‚£ä¹ˆæ­¤æ—¶æ˜¯ä¸»è§‚å®•æœºã€‚è€Œå¦‚æœé›†ç¾¤å†…è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹è®¤ä¸ºAæŒ‚äº†ï¼Œ é‚£ä¹ˆæ­¤æ—¶Aå°±ä¼šè¢«æ ‡è®°ä¸ºå®¢è§‚å®•æœºã€‚\nä¸€æ—¦èŠ‚ç‚¹Aè¢«æ ‡è®°ä¸ºäº†å®¢è§‚å®•æœºï¼Œé›†ç¾¤å°±ä¼šå¼€å§‹æ‰§è¡Œæ•…éšœè½¬ç§»ã€‚å…¶ä½™æ­£å¸¸è¿è¡Œçš„masterèŠ‚ç‚¹ä¼šè¿›è¡ŒæŠ•ç¥¨é€‰ä¸¾ï¼Œä»AèŠ‚ç‚¹çš„slaveèŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªï¼Œå°†å…¶åˆ‡æ¢æˆæ–°çš„masterå¯¹å¤–æä¾›æœåŠ¡ã€‚å½“æŸä¸ªslaveè·å¾—äº†è¶…è¿‡åŠæ•°çš„masterèŠ‚ç‚¹æŠ•ç¥¨ï¼Œå°±æˆåŠŸå½“é€‰ã€‚\nå½“é€‰æˆåŠŸä¹‹åï¼Œæ–°çš„masterä¼šæ‰§è¡Œslaveof no oneæ¥è®©è‡ªå·±åœæ­¢å¤åˆ¶AèŠ‚ç‚¹ï¼Œä½¿è‡ªå·±æˆä¸ºmasterã€‚ç„¶åå°†AèŠ‚ç‚¹æ‰€è´Ÿè´£å¤„ç†çš„slotï¼Œå…¨éƒ¨è½¬ç§»ç»™è‡ªå·±ï¼Œç„¶åå°±ä¼šå‘é›†ç¾¤å‘PONGæ¶ˆæ¯æ¥å¹¿æ’­è‡ªå·±çš„æœ€æ–°çŠ¶æ€ã€‚\næŒ‰ç…§ä¸€è‡´æ€§å“ˆå¸Œçš„æ€æƒ³ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆå°±ä¼šæ²¿ç€é‚£ä¸ªåœ†ç¯ï¼ŒæŒ‰ç…§é¡ºæ—¶é’ˆçš„é¡ºåºæ‰¾åˆ°é‡åˆ°çš„ç¬¬ä¸€ä¸ªRediså®ä¾‹ã€‚\nè€Œå¯¹äºRedis Clusterï¼ŒæŸä¸ªkeyå®ƒå…¶å®å¹¶ä¸å…³å¿ƒå®ƒæœ€ç»ˆè¦å»åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œä»–åªå…³å¿ƒä»–æœ€ç»ˆè½åˆ°å“ªä¸ªslotä¸Šï¼Œæ— è®ºä½ èŠ‚ç‚¹æ€ä¹ˆå»è¿ç§»ï¼Œæœ€ç»ˆè¿˜æ˜¯åªéœ€è¦æ‰¾åˆ°å¯¹åº”çš„slotï¼Œç„¶åå†æ‰¾åˆ°slotå…³è”çš„èŠ‚ç‚¹ï¼Œæœ€ç»ˆå°±èƒ½å¤Ÿæ‰¾åˆ°æœ€ç»ˆçš„Rediså®ä¾‹äº†ã€‚\né‚£è¿™ä¸ªPONGæ¶ˆæ¯åˆæ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿåˆ«æ€¥ï¼Œä¸‹é¢å°±ä¼šèŠåˆ°ã€‚\n8. ç®€å•äº†è§£gossipåè®® è¿™å°±æ˜¯Redis Clusterå„ä¸ªèŠ‚ç‚¹ä¹‹é—´äº¤æ¢æ•°æ®ã€é€šä¿¡æ‰€é‡‡ç”¨çš„ä¸€ç§åè®®ï¼Œå«åšgossipã€‚\ngossip: æµè¨€ã€å…«å¦ã€å°é“æ¶ˆæ¯\rgossipæ˜¯åœ¨1989å¹´çš„è®ºæ–‡ä¸Šæå‡ºçš„ï¼Œæˆ‘çœ‹äº†ä¸€å †èµ„æ–™éƒ½è¯´çš„æ˜¯1987å¹´å‘è¡¨çš„ï¼Œä½†æ˜¯æ–‡ç« é‡Œçš„æ—¶é—´æ˜ç¡®æ˜¯1989å¹´1æœˆä»½å‘è¡¨ã€‚\næ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹çœ‹Epidemic Algorithms for Replicated . Database Maintenance\rï¼Œåœ¨å½“æ—¶æå‡ºgossipä¸»è¦æ˜¯ä¸ºäº†è§£å†³åœ¨åˆ†å¸ƒå¼æ•°æ®åº“ä¸­ï¼Œå„ä¸ªå‰¯æœ¬èŠ‚ç‚¹çš„æ•°æ®åŒæ­¥é—®é¢˜ã€‚ä½†éšç€æŠ€æœ¯çš„å‘å±•ï¼Œgossipåç»­ä¹Ÿè¢«å¹¿æ³›è¿ç”¨äºä¿¡æ¯æ‰©æ•£ã€æ•…éšœæ¢æµ‹ç­‰ç­‰ã€‚\nRedis Clusterå°±æ˜¯åˆ©ç”¨äº†gossipæ¥å®ç°è‡ªèº«çš„ä¿¡æ¯æ‰©æ•£çš„ã€‚é‚£ä½¿ç”¨gossipå…·ä½“æ˜¯å¦‚ä½•é€šä¿¡çš„å‘¢ï¼Ÿ\nå¾ˆç®€å•ï¼Œå°±åƒå›¾é‡Œè¿™æ ·ã€‚æ¯ä¸ªRedisèŠ‚ç‚¹æ¯ç§’é’Ÿéƒ½ä¼šå‘å…¶ä»–çš„èŠ‚ç‚¹å‘é€PINGï¼Œç„¶åè¢«PINGçš„èŠ‚ç‚¹ä¼šå›ä¸€ä¸ªPONGã€‚\n9. gossipåè®®æ¶ˆæ¯ç±»å‹ Redis Clusterä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„æ¶ˆæ¯ç±»å‹æœ‰5ç§ï¼Œåˆ†åˆ«æ˜¯MEETã€PINGã€PONGã€FAILå’ŒPUBLISHã€‚è¿™äº›æ¶ˆæ¯åˆ†åˆ«ä¼ é€’äº†ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿæˆ‘ç®€å•æ€»ç»“äº†ä¸€ä¸‹ã€‚\n   æ¶ˆæ¯ç±»å‹ æ¶ˆæ¯å†…å®¹     MEET ç»™æŸä¸ªèŠ‚ç‚¹å‘é€MEETæ¶ˆæ¯ï¼Œè¯·æ±‚æ¥æ”¶æ¶ˆæ¯çš„èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­   PING æ¯éš”ä¸€ç§’é’Ÿï¼Œé€‰æ‹©5ä¸ªæœ€ä¹…æ²¡æœ‰é€šä¿¡çš„èŠ‚ç‚¹ï¼Œå‘é€PINGæ¶ˆæ¯ï¼Œæ£€æµ‹å¯¹åº”çš„èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿ï¼›åŒæ—¶è¿˜æœ‰ä¸€ç§ç­–ç•¥æ˜¯ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹çš„é€šä¿¡å»¶è¿Ÿå¤§äºäº†cluster-node-timeçš„å€¼çš„ä¸€åŠï¼Œå°±ä¼šç«‹å³ç»™è¯¥èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯ï¼Œé¿å…æ•°æ®äº¤æ¢å»¶è¿Ÿè¿‡ä¹…   PONG å½“èŠ‚ç‚¹æ¥æ”¶åˆ°MEETæˆ–è€…PINGæ¶ˆæ¯ä¹‹åï¼Œä¼šå›ä¸€ä¸ªPONGæ¶ˆæ¯ç»™å‘é€æ–¹ï¼Œä»£è¡¨è‡ªå·±æ”¶åˆ°äº†MEETæˆ–è€…PINGæ¶ˆæ¯ã€‚åŒæ—¶ï¼ŒèŠ‚ç‚¹ä¹Ÿå¯ä»¥ä¸»åŠ¨çš„é€šè¿‡PONGæ¶ˆæ¯å‘é›†ç¾¤ä¸­å¹¿æ’­è‡ªå·±çš„ä¿¡æ¯ï¼Œè®©å…¶ä»–èŠ‚ç‚¹è·å–åˆ°è‡ªå·±æœ€æ–°çš„å±æ€§ï¼Œå°±åƒå®Œæˆäº†æ•…éšœè½¬ç§»ä¹‹åæ–°çš„masterå‘é›†ç¾¤å‘é€PONGæ¶ˆæ¯ä¸€æ ·   FAIL ç”¨äºå¹¿æ’­è‡ªå·±çš„å¯¹æŸä¸ªèŠ‚ç‚¹çš„å®•æœºåˆ¤æ–­ï¼Œå‡è®¾å½“å‰èŠ‚ç‚¹å¯¹AèŠ‚ç‚¹åˆ¤æ–­ä¸ºå®•æœºï¼Œå°±ä¼šç«‹å³å‘Redis Clusterå¹¿æ’­è‡ªå·±å¯¹äºAèŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œæ‰€æœ‰æ”¶åˆ°æ¶ˆæ¯çš„èŠ‚ç‚¹å°±ä¼šå¯¹AèŠ‚ç‚¹åšæ ‡è®°   PUBLISH ç”¨äºå‘æŒ‡å®šçš„Channelå‘é€æ¶ˆæ¯ï¼ŒæŸä¸ªèŠ‚ç‚¹æ”¶åˆ°PUBLISHæ¶ˆæ¯ä¹‹åä¼šç›´æ¥åœ¨é›†ç¾¤å†…å¹¿æ’­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå®¢æˆ·ç«¯æ— è®ºè¿æ¥åˆ°ä»»ä½•èŠ‚ç‚¹éƒ½èƒ½å¤Ÿè®¢é˜…è¿™ä¸ªChannel    10. ä½¿ç”¨gossipçš„ä¼˜åŠ£ æ—¢ç„¶Redis Clusteré€‰æ‹©äº†gossipï¼Œé‚£è‚¯å®šå­˜åœ¨ä¸€äº›gossipçš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ç®€å•æ¢³ç†ä¸€ä¸‹ã€‚\n   ä¼˜ç‚¹ æè¿°     æ‰©å±•æ€§ ç½‘ç»œå¯ä»¥å…è®¸èŠ‚ç‚¹çš„ä»»æ„å¢åŠ å’Œå‡å°‘ï¼Œæ–°å¢åŠ çš„èŠ‚ç‚¹çš„çŠ¶æ€æœ€ç»ˆä¼šä¸å…¶ä»–èŠ‚ç‚¹ä¸€è‡´ã€‚   å®¹é”™æ€§ ç”±äºæ¯ä¸ªèŠ‚ç‚¹éƒ½æŒæœ‰ä¸€ä»½å®Œæ•´å…ƒæ•°æ®ï¼Œæ‰€ä»¥ä»»ä½•èŠ‚ç‚¹å®•æœºéƒ½ä¸ä¼šå½±å“gossipçš„è¿è¡Œ   å¥å£®æ€§ ä¸å®¹é”™æ€§ç±»ä¼¼ï¼Œç”±äºæ‰€æœ‰èŠ‚ç‚¹éƒ½æŒæœ‰æ•°æ®ï¼Œåœ°ä½å¹³å°ï¼Œæ˜¯ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„è®¾è®¡ï¼Œä»»ä½•èŠ‚ç‚¹éƒ½ä¸ä¼šå½±å“åˆ°æœåŠ¡çš„è¿è¡Œ   æœ€ç»ˆä¸€è‡´æ€§ å½“æœ‰æ–°çš„ä¿¡æ¯éœ€è¦ä¼ é€’æ—¶ï¼Œæ¶ˆæ¯å¯ä»¥å¿«é€Ÿçš„å‘é€åˆ°æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œè®©æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æ‹¥æœ‰æœ€æ–°çš„æ•°æ®    gossipå¯ä»¥åœ¨O(logN) è½®å°±å¯ä»¥å°†ä¿¡æ¯ä¼ æ’­åˆ°æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œä¸ºä»€ä¹ˆæ˜¯O(logN)å‘¢ï¼Ÿå› ä¸ºæ¯æ¬¡pingï¼Œå½“å‰èŠ‚ç‚¹ä¼šå¸¦ä¸Šè‡ªå·±çš„ä¿¡æ¯å¤–åŠ æ•´ä¸ªClusterçš„1/10æ•°é‡çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¸€èµ·å‘é€å‡ºå»ã€‚ä½ å¯ä»¥ç®€å•çš„æŠŠè¿™ä¸ªæ¨¡å‹æŠ½è±¡ä¸ºï¼š\n ä½ è½¬å‘äº†ä¸€ä¸ªç‰¹åˆ«æœ‰æ„æ€çš„æ–‡ç« åˆ°æœ‹å‹åœˆï¼Œç„¶åä½ çš„æœ‹å‹ä»¬éƒ½è§‰å¾—è¿˜ä¸é”™ï¼Œäºæ˜¯å°±ä¸€ä¼ åã€åä¼ ç™¾è¿™æ ·çš„æ•£æ’­å‡ºå»äº†ï¼Œè¿™å°±æ˜¯æœ‹å‹åœˆçš„è£‚å˜ä¼ æ’­ã€‚\n å½“ç„¶ï¼Œgossipä»ç„¶å­˜åœ¨ä¸€äº›ç¼ºç‚¹ã€‚ä¾‹å¦‚æ¶ˆæ¯å¯èƒ½æœ€ç»ˆä¼šç»è¿‡å¾ˆå¤šè½®æ‰èƒ½åˆ°è¾¾ç›®æ ‡èŠ‚ç‚¹ï¼Œè€Œè¿™å¯èƒ½ä¼šå¸¦æ¥è¾ƒå¤§çš„å»¶è¿Ÿã€‚åŒæ—¶ç”±äºèŠ‚ç‚¹ä¼šéšæœºé€‰å‡º5ä¸ªæœ€ä¹…æ²¡æœ‰é€šä¿¡çš„èŠ‚ç‚¹ï¼Œè¿™å¯èƒ½ä¼šé€ æˆæŸä¸€ä¸ªèŠ‚ç‚¹åŒæ—¶æ”¶åˆ°nä¸ªé‡å¤çš„æ¶ˆæ¯ã€‚\n ç¼ºç‚¹\n æ¶ˆæ¯å»¶è¿Ÿ èŠ‚ç‚¹éšæœºå‘å°‘æ•°å‡ ä¸ªèŠ‚ç‚¹å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯æœ€ç»ˆæ˜¯é€šè¿‡å¤šä¸ªè½®æ¬¡çš„æ•£æ’­è€Œåˆ°è¾¾å…¨ç½‘ï¼Œä¸å¯é¿å…çš„é€ æˆæ¶ˆæ¯å»¶è¿Ÿ æ¶ˆæ¯å†—ä½™ èŠ‚ç‚¹å®šæœŸéšæœºé€‰æ‹©å‘¨å›´èŠ‚ç‚¹å‘é€æ¶ˆæ¯ï¼Œè€Œæ”¶åˆ°æ¶ˆæ¯çš„èŠ‚ç‚¹ä¹Ÿä¼šé‡å¤è¯¥æ­¥éª¤ï¼›ä¸å¯é¿å…çš„å¼•èµ·åŒä¸€èŠ‚ç‚¹æ¶ˆæ¯å¤šæ¬¡æ¥æ”¶ï¼Œå¢åŠ æ¶ˆæ¯å¤„ç†å‹åŠ›ï¼Œä¸€èˆ¬é€šè¿‡æ–‡ä»¶æ ¡éªŒå’Œã€ç¼“å­˜èŠ‚ç‚¹åˆ—è¡¨ç­‰æ–¹å¼æ¥è¿›è¡Œä¼˜åŒ–å‡å°‘æ•°æ®å¯¹æ¯”å¸¦æ¥çš„æ€§èƒ½æŸè€—  åŸºäºä»¥ä¸Šä¼˜ç¼ºç‚¹åˆ†æï¼ŒGossipåè®®æ»¡è¶³CAPåˆ†å¸ƒå¼ç†è®ºä¸­åŸºäºAPåœºæ™¯çš„æ•°æ®æœ€ç»ˆä¸€è‡´æ€§å¤„ç†ï¼Œå¸¸è§åº”ç”¨æœ‰ï¼šP2Pç½‘ç»œé€šä¿¡ã€Apache Cassandraã€Redis Clusterã€Consulç­‰ï¼Œè¿˜æœ‰Apache Gossipæ¡†æ¶çš„å¼€æºå®ç°ä¾›Gossipåè®®çš„å­¦ä¹ ã€‚\n 11. æ€»ç»“ æ€»çš„æ¥è¯´ï¼ŒRedis Clusterç›¸å½“äºæ˜¯æŠŠRedisçš„ä¸»ä»æ¶æ„å’ŒSentinelé›†æˆåˆ°äº†ä¸€èµ·ï¼Œä»Redis Clusterçš„é«˜å¯ç”¨æœºåˆ¶ã€åˆ¤æ–­æ•…éšœè½¬ç§»ä»¥åŠæ‰§è¡Œæ•…éšœè½¬ç§»çš„è¿‡ç¨‹ï¼Œéƒ½å’Œä¸»ä»ã€Sentinelç›¸å…³ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘åœ¨ä¹‹å‰çš„æ–‡ç« é‡Œè¯´ï¼Œä¸»ä»æ˜¯Redisé«˜å¯ç”¨æ¶æ„çš„åŸºçŸ³ã€‚\nå‚è€ƒ æ·±åº¦å›¾è§£Redis ClusteråŸç†\r[åˆ†å¸ƒå¼ç³»åˆ—]Gossipåè®®\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/redis/%E6%B7%B1%E5%BA%A6%E5%9B%BE%E8%A7%A3redis-cluster%E5%8E%9F%E7%90%86/","series":["Manual"],"tags":["Redis"],"title":"æ·±åº¦å›¾è§£Redis ClusteråŸç†"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"  æ’é™¤åº”ç”¨ä¹‹å¤–çš„å½±å“å› ç´ ï¼š top(cpu)ã€free(å†…å­˜)ã€df(ç£ç›˜)ã€dstat(ç½‘ç»œæµé‡)ã€pstackã€vmstatã€st1race(åº•å±‚ç³»ç»Ÿè°ƒç”¨)\n  top å®šä½CPU æœ€é«˜çš„è¿›ç¨‹\n  top -Hp pid å®šä½ä½¿ç”¨ CPU æœ€é«˜çš„çº¿ç¨‹ï¼ˆæˆ–è€… ps -mp pid -o THREAD,tid,timeï¼‰\n  printf '0x%x' tid çº¿ç¨‹ id è½¬åŒ– 16 è¿›åˆ¶\n  jstack pid | grep tid æ‰¾åˆ°çº¿ç¨‹å †æ ˆ\n5.1 gcçº¿ç¨‹ï¼ˆå¦‚ä¸‹æ˜¯æŸ¥çœ‹gcæƒ…å†µçš„å‡ ç§æ–¹å¼ï¼‰\n    æŸ¥çœ‹gc æ—¥å¿—\n  jstat -gcutil è¿›ç¨‹å· ç»Ÿè®¡é—´éš”æ¯«ç§’ ç»Ÿè®¡æ¬¡æ•°ï¼ˆç¼ºçœä»£è¡¨ä¸€è‡´ç»Ÿè®¡\n  å¦‚æœæ‰€åœ¨å…¬å¸æœ‰å¯¹åº”ç”¨è¿›è¡Œç›‘æ§çš„ç»„ä»¶å½“ç„¶æ›´æ–¹ä¾¿ï¼ˆæ¯”å¦‚Prometheus + Grafanaï¼‰\n5.2 ä¸šåŠ¡çº¿ç¨‹\n  å…³æ³¨çº¿ç¨‹å †æ ˆçš„lockå­—æ®µ\n  jstack -l pid | grep BLOCKED æŸ¥çœ‹é˜»å¡æ€çº¿ç¨‹å †æ ˆ\n  ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/","series":["Manual"],"tags":["Java"],"title":"ç”Ÿäº§é—®é¢˜å®šä½"},{"categories":["æ¶æ„æ¼”è¿›"],"content":"ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–ä¹‹å¹¶å‘ç¼–ç¨‹\ræå‡ç³»ç»Ÿçš„QPSå’Œååé‡\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/","series":["Manual"],"tags":["SA"],"title":"ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. ä½¿ç”¨synchronized é¥±æ±‰ï¼šåŒé‡æ£€æŸ¥é”å®šã€é¥¿æ±‰ã€é™æ€å†…éƒ¨ç±»ã€æšä¸¾ éƒ½å±äºåˆ©ç”¨synchronizedåŒæ­¥åŸç†å®ç°\n1.1 é¥±æ±‰ï¼šåŒé‡æ£€æŸ¥é”å®šï¼ˆdouble-checked lockingï¼‰ public class SingleTon { // é™æ€å®ä¾‹å˜é‡åŠ ä¸Švolatile  private static volatile SingleTon instance; // ç§æœ‰åŒ–æ„é€ å‡½æ•°  private SingleTon() {} // åŒé‡æ£€æŸ¥é”  public static SingleTon getInstance() { if (instance == null) { synchronized(SingleTon.class){ if(instance == null){ instance = new SingleTon(); } } } return instance; } 1.2 é¥¿æ±‰ public class Singleton { private static Singleton instance = new Singleton(); private Singleton() { } public static Singleton getInstance() { return instance; } } 1.3 é™æ€å†…éƒ¨ç±» public class Singleton { private static class SingletonHolder { private static final Singleton INSTANCE = new Singleton(); } private Singleton() { } public static final Singleton getInstance() { return SingletonHolder.INSTANCE; } } ä»¥ä¸Šçš„é™æ€å†…éƒ¨ç±»ã€é¥¿æ±‰ç­‰æ¨¡å¼å‡æ˜¯é€šè¿‡å®šä¹‰é™æ€çš„æˆå‘˜å˜é‡ï¼Œä»¥ä¿è¯å•ä¾‹å¯¹è±¡å¯ä»¥åœ¨ç±»åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­è¢«å®ä¾‹åŒ–ã€‚\nè¿™å…¶å®æ˜¯åˆ©ç”¨äº†ClassLoaderçš„çº¿ç¨‹å®‰å…¨æœºåˆ¶ã€‚ClassLoaderçš„loadClassæ–¹æ³•åœ¨åŠ è½½ç±»çš„æ—¶å€™ä½¿ç”¨äº†synchronizedå…³é”®å­—ã€‚\næ‰€ä»¥ï¼Œ é™¤éè¢«é‡å†™ï¼Œè¿™ä¸ªæ–¹æ³•é»˜è®¤åœ¨æ•´ä¸ªè£…è½½è¿‡ç¨‹ä¸­éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ‰€ä»¥åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­å¯¹è±¡çš„åˆ›å»ºä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚\n1.4 æšä¸¾ public enum EnumFactory{ singletonFactory; private MySingleton instance; private EnumFactory(){//æšä¸¾ç±»çš„æ„é€ æ–¹æ³•åœ¨ç±»åŠ è½½æ˜¯è¢«å®ä¾‹åŒ–  instance = new MySingleton(); } public MySingleton getInstance(){ return instance; } } class MySingleton{//éœ€è¦è·å®ç°å•ä¾‹çš„ç±»ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥Connection  public MySingleton(){} æšä¸¾å…¶å®åº•å±‚æ˜¯ä¾èµ–Enumç±»å®ç°çš„ï¼Œè¿™ä¸ªç±»çš„æˆå‘˜å˜é‡éƒ½æ˜¯staticç±»å‹çš„ï¼Œå¹¶ä¸”åœ¨é™æ€ä»£ç å—ä¸­å®ä¾‹åŒ–çš„ï¼Œå’Œé¥¿æ±‰æœ‰ç‚¹åƒï¼Œ æ‰€ä»¥ä»–å¤©ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚\n2. åˆ©ç”¨CASåŸç† public class Singleton { private static final AtomicReference\u0026lt;Singleton\u0026gt; INSTANCE = new AtomicReference\u0026lt;Singleton\u0026gt;(); private Singleton() { } public static Singleton getInstance() { for (; ; ) { Singleton singleton = INSTANCE.get(); if (null != singleton) { return singleton; } singleton = new Singleton(); if (INSTANCE.compareAndSet(null, singleton)) { return singleton; } } } } 3. ä½¿ç”¨ThreadLocal ä¸å‰é¢çš„æ–¹å¼ä¸åŒçš„æ˜¯ï¼ŒThreadLocal ä¿è¯çš„æ˜¯å•ä¸ªçº¿ç¨‹å†…éƒ¨è®¿é—®çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œä¸åŒçº¿ç¨‹è®¿é—®çš„ä¸æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œå³å±€éƒ¨å•ä¾‹ï¼Œå¹¶éå…¨å±€å•ä¾‹ã€‚\npublic class Singleton { private static final ThreadLocal\u0026lt;Singleton\u0026gt; singleton = new ThreadLocal\u0026lt;Singleton\u0026gt;() { @Override protected Singleton initialValue() { return new Singleton(); } }; public static Singleton getInstance() { return singleton.get(); } private Singleton() { } } åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ç ´åå•ä¾‹é—®é¢˜ åºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œåºåˆ—åŒ–å‰åå¾—åˆ°å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚è§£å†³åŠæ³•å°±æ˜¯åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ä½¿ç”¨readResolve()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ååºåˆ—åŒ–æ—¶ä¼šè¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•ä¸æ˜¯æ¥å£å®šä¹‰çš„æ–¹æ³•ï¼Œæœ‰ç‚¹å„¿çº¦å®šä¿—æˆçš„æ„Ÿè§‰ï¼Œå•ä¾‹å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š\nimport java.io.ObjectStreamException; import java.io.Serializable; public class MySingleton implements Serializable { private static final long serialVersionUID = 1L; //å†…éƒ¨ç±»  private static class MySingletonHandler{ private static MySingleton instance = new MySingleton(); } private MySingleton(){} public static MySingleton getInstance() { return MySingletonHandler.instance; } //è¯¥æ–¹æ³•åœ¨ååºåˆ—åŒ–æ—¶ä¼šè¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•ä¸æ˜¯æ¥å£å®šä¹‰çš„æ–¹æ³•ï¼Œæœ‰ç‚¹å„¿çº¦å®šä¿—æˆçš„æ„Ÿè§‰  protected Object readResolve() throws ObjectStreamException { System.out.println(\u0026#34;è°ƒç”¨äº†readResolveæ–¹æ³•ï¼\u0026#34;); return MySingletonHandler.instance; } å‚è€ƒé“¾æ¥ï¼š é«˜å¹¶å‘ä¸‹çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼ï¼ˆæœ€å…¨æœ€ç»å…¸ï¼‰\rå•ä¾‹æ¨¡å¼â€”â€”çº¿ç¨‹å®‰å…¨çš„ä¸¤ç§å®ç°\ré¢è¯•å®˜çœŸæ˜¯æç¬‘!è®©å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹,åˆä¸è®©ä½¿ç”¨synchronized!\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%E5%8D%95%E4%BE%8B%E7%9A%84%E5%87%A0%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95/","series":["Manual"],"tags":["Java"],"title":"çº¿ç¨‹å®‰å…¨çš„å•ä¾‹çš„å‡ ç§å®ç°æ–¹æ³•"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"Linuxçº¿ç¨‹çš„çŠ¶æ€ä¸è°ƒåº¦ Javaçº¿ç¨‹çš„6ç§çŠ¶æ€åŠåˆ‡æ¢ å‚è€ƒ Linuxçº¿ç¨‹çš„çŠ¶æ€ä¸è°ƒåº¦\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81/","series":["Manual"],"tags":["Java"],"title":"çº¿ç¨‹çŠ¶æ€"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. ç¼“å­˜é›ªå´© 1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ ç®€ä»‹ï¼šç¼“å­˜åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆï¼Œæ‰€ä»¥ï¼Œåé¢çš„è¯·æ±‚éƒ½ä¼šè½åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“çŸ­æ—¶é—´å†…æ‰¿å—å¤§é‡è¯·æ±‚è€Œå´©æ‰ã€‚\n1.2 æœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿ  äº‹å‰ï¼šå°½é‡ä¿è¯æ•´ä¸ª redis é›†ç¾¤çš„é«˜å¯ç”¨æ€§ï¼Œå‘ç°æœºå™¨å®•æœºå°½å¿«è¡¥ä¸Šã€‚é€‰æ‹©åˆé€‚çš„å†…å­˜æ·˜æ±°ç­–ç•¥ã€‚ äº‹ä¸­ï¼šæœ¬åœ°ehcacheç¼“å­˜ + hystrixé™æµ\u0026amp;é™çº§ï¼Œé¿å…MySQLå´©æ‰ äº‹åï¼šåˆ©ç”¨ redis æŒä¹…åŒ–æœºåˆ¶ä¿å­˜çš„æ•°æ®å°½å¿«æ¢å¤ç¼“å­˜  2. ç¼“å­˜ç©¿é€ 2.1 ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿ ç¼“å­˜ç©¿é€è¯´ç®€å•ç‚¹å°±æ˜¯å¤§é‡è¯·æ±‚çš„ key æ ¹æœ¬ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œå¯¼è‡´è¯·æ±‚ç›´æ¥åˆ°äº†æ•°æ®åº“ä¸Šï¼Œæ ¹æœ¬æ²¡æœ‰ç»è¿‡ç¼“å­˜è¿™ä¸€å±‚ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæŸä¸ªé»‘å®¢æ•…æ„åˆ¶é€ æˆ‘ä»¬ç¼“å­˜ä¸­ä¸å­˜åœ¨çš„ key å‘èµ·å¤§é‡è¯·æ±‚ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚è½åˆ°æ•°æ®åº“ã€‚\n2.1 æœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿ æœ€åŸºæœ¬çš„å°±æ˜¯é¦–å…ˆåšå¥½å‚æ•°æ ¡éªŒï¼Œä¸€äº›ä¸åˆæ³•çš„å‚æ•°è¯·æ±‚ç›´æ¥æŠ›å‡ºå¼‚å¸¸ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ¯”å¦‚æŸ¥è¯¢çš„æ•°æ®åº“ id ä¸èƒ½å°äº 0ã€ä¼ å…¥çš„é‚®ç®±æ ¼å¼ä¸å¯¹çš„æ—¶å€™ç›´æ¥è¿”å›é”™è¯¯æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ç­‰ç­‰ã€‚\n ç¼“å­˜æ— æ•ˆ keyï¼ˆè§£å†³è¯·æ±‚çš„ key å˜åŒ–ä¸é¢‘ç¹çš„æƒ…å†µï¼‰ : å¦‚æœç¼“å­˜å’Œæ•°æ®åº“éƒ½æŸ¥ä¸åˆ°æŸä¸ª key çš„æ•°æ®å°±å†™ä¸€ä¸ªåˆ° redis ä¸­å»å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼šSET key value EX 10086ã€‚è¿™ç§æ–¹å¼å¯ä»¥è§£å†³è¯·æ±‚çš„ key å˜åŒ–ä¸é¢‘ç¹çš„æƒ…å†µï¼Œå¦‚æœé»‘å®¢æ¶æ„æ”»å‡»ï¼Œæ¯æ¬¡æ„å»ºçš„ä¸åŒçš„è¯·æ±‚keyï¼Œä¼šå¯¼è‡´ redis ä¸­ç¼“å­˜å¤§é‡æ— æ•ˆçš„ key ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ç§æ–¹æ¡ˆå¹¶ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³æ­¤é—®é¢˜ã€‚å¦‚æœéè¦ç”¨è¿™ç§æ–¹å¼æ¥è§£å†³ç©¿é€é—®é¢˜çš„è¯ï¼Œå°½é‡å°†æ— æ•ˆçš„ key çš„è¿‡æœŸæ—¶é—´è®¾ç½®çŸ­ä¸€ç‚¹æ¯”å¦‚ 1 åˆ†é’Ÿã€‚ å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆè§£å†³è¯·æ±‚çš„ key å˜åŒ–é¢‘ç¹ä¸”keyéæ³•ï¼‰ï¼šå¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªéå¸¸ç¥å¥‡çš„æ•°æ®ç»“æ„ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°åˆ¤æ–­ä¸€ä¸ªç»™å®šæ•°æ®æ˜¯å¦å­˜åœ¨ä¸æµ·é‡æ•°æ®ä¸­ã€‚æˆ‘ä»¬éœ€è¦çš„å°±æ˜¯åˆ¤æ–­ key æ˜¯å¦åˆæ³•ï¼Œæœ‰æ²¡æœ‰æ„Ÿè§‰å¸ƒéš†è¿‡æ»¤å™¨å°±æ˜¯æˆ‘ä»¬æƒ³è¦æ‰¾çš„é‚£ä¸ªâ€œäººâ€ã€‚å…·ä½“æ˜¯è¿™æ ·åšçš„ï¼šæŠŠæ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è¯·æ±‚çš„å€¼éƒ½å­˜æ”¾åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå½“ç”¨æˆ·è¯·æ±‚è¿‡æ¥ï¼Œæˆ‘ä¼šå…ˆåˆ¤æ–­ç”¨æˆ·å‘æ¥çš„è¯·æ±‚çš„å€¼æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚ä¸å­˜åœ¨çš„è¯ï¼Œç›´æ¥è¿”å›è¯·æ±‚å‚æ•°é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼Œå­˜åœ¨çš„è¯æ‰ä¼šèµ°ä¸‹é¢çš„æµç¨‹ã€‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯ä¸‹é¢è¿™å¼ å›¾(è¿™å¼ å›¾ç‰‡ä¸æ˜¯æˆ‘ç”»çš„ï¼Œä¸ºäº†çœäº‹ç›´æ¥åœ¨ç½‘ä¸Šæ‰¾çš„)ï¼š  ä½†æ˜¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¸ƒéš†è¿‡æ»¤å™¨å¯èƒ½ä¼šå­˜åœ¨è¯¯åˆ¤çš„æƒ…å†µã€‚æ€»ç»“æ¥è¯´å°±æ˜¯ï¼š å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ å­˜åœ¨ï¼Œå°æ¦‚ç‡ä¼šè¯¯åˆ¤ã€‚å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ ä¸åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ ä¸€å®šä¸åœ¨ã€‚\n ç¼“å­˜é¢„çƒ­ï¼ˆè§£å†³è¯·æ±‚çš„ key å˜åŒ–é¢‘ç¹ä¸”keyåˆæ³•ï¼‰ï¼šæå‰å°†éœ€è¦åšç¼“å­˜çš„æ•°æ®æ”¾å…¥redisï¼Œå³ç¼“å­˜é¢„çƒ­ã€‚  3. æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°å¡«è°· å¦‚æœåˆšä¸Šçº¿æŸä¸ªåŠŸèƒ½ï¼Œå¤§é‡ç”¨æˆ·åŒæ—¶ç‚¹è¿™ä¸ªåŠŸèƒ½ï¼Œå¹¶å‘é‡å¤§çš„è¯ï¼Œè¯·æ±‚èµ°åˆ°åå°ï¼Œé‚£ä¹ˆå†™åº“çš„æ“ä½œå°±éå¸¸å¤šï¼Œæ•°æ®åº“è¿æ¥æ•°çªç„¶æ¿€å¢ï¼Œæ•°æ®åº“ä¼šé¡¶ä¸ä½å§ã€‚\næ‰€ä»¥ä¸ºé¿å…æµé‡é›†ä¸­è½åˆ°æ•°æ®åº“ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—MQã€‚å°†æ’å…¥æ“ä½œçš„è¯·æ±‚å‘å¾€æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½¿æ’å…¥æ“ä½œä»¥ä¸€å®šçš„é€Ÿç‡åˆ°æ•°æ®åº“æ‰§è¡Œï¼Œä½¿å¾—å¯¹æ•°æ®åº“çš„è¯·æ±‚æ•°å°½é‡å¹³æ»‘ï¼Œæ¶ˆæ¯å‘ç»™æ¶ˆæ¯é˜Ÿåˆ—ç«‹å³è¿”å›ç»™å‰ç«¯æˆåŠŸï¼Œä¸ç”¨ç­‰å¾…æ’åº“å®Œæˆï¼Œç”¨MQå®ç°äº†å¼‚æ­¥è§£è€¦ï¼Œå‰Šå³°å¡«è°·ã€‚\nå‚è€ƒï¼š ç¼“å­˜é›ªå´©å’Œç¼“å­˜ç©¿é€é—®é¢˜è§£å†³æ–¹æ¡ˆ\rä»ä¸€ä¸ªå°éœ€æ±‚æ„Ÿå—Redisçš„ç‹¬ç‰¹é­…åŠ›\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/redis/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E5%92%8C%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F/","series":["Manual"],"tags":["Redis"],"title":"ç¼“å­˜é›ªå´©å’Œç¼“å­˜ç©¿é€"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. ä»€ä¹ˆæ˜¯javaè„šæ‰‹æ¶ å…¶å®å°±æ˜¯javaå·¥ç¨‹æ¨¡æ¿ï¼Œä½ å¯ä»¥æŠŠä¸€äº›é€šç”¨çš„ç»„ä»¶æŠ½è±¡æˆä¸€ä¸ªæ¨¡æ¿ï¼Œä¸‹æ¬¡å¼€å‘çš„æ—¶å€™åŸºäºè¿™ä¸ªæ¨¡æ¿å¼€å‘ï¼Œé¿å…é‡å¤é€ è½®å­ã€‚åƒapacheé»˜è®¤å°±æä¾›äº†å¾ˆå¤šæ¨¡æ¿ï¼ˆarchetypeï¼‰\n2. åˆ›å»ºarchetype å‡å¦‚ä½ å·²ç»æœ‰äº†ä¸€ä¸ªmavené¡¹ç›®ï¼Œæƒ³ç»™è¯¥é¡¹ç›®åˆ›å»ºä¸€ä¸ªarchetypeæ¨¡æ¿ã€‚ä½ éœ€è¦cd åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ(pom.xmlåŒçº§ç›®å½•)ã€‚\nmvn archetype:create-from-project æ‰§è¡Œå®Œåï¼Œç”Ÿæˆçš„targetç±»ä¼¼è¿™æ ·ï¼š\n3. ç”Ÿæˆarchetypeæ¨¡æ¿ å…ˆcd target/generated-sources/archetype/ ç„¶åæ‰§è¡Œï¼š\nmvn install æ‰§è¡ŒæˆåŠŸåï¼Œæ‰§è¡Œcrawlå‘½ä»¤ï¼š\nmvn archetype:crawl åœ¨æœ¬åœ°ä»“åº“çš„æ ¹ç›®å½•ç”Ÿæˆarchetype-catalog.xmléª¨æ¶é…ç½®æ–‡ä»¶:\næ¥çœ‹ä¸€çœ‹å®ƒé‡Œé¢çš„å†…å®¹:\n4. ä½¿ç”¨archetypeæ¨¡æ¿ æ‰§è¡Œmvn archetype:generate -DarchetypeCatalog=localä»æœ¬åœ°archetypeæ¨¡æ¿ä¸­åˆ›å»ºé¡¹ç›®ã€‚\nmvn archetype:generate -DarchetypeCatalog=local ç„¶åä¼šè®©ä½ é€‰æ‹©æ¨¡æ¿åºå·å’ŒgroupId artifactId versionå’Œpackageä¿¡æ¯ï¼š\nè‡³æ­¤ï¼Œé¡¹ç›®åˆ›å»ºæˆåŠŸ!\nå½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨IDEAæ¥å¸®æˆ‘ä»¬ç”¨å›¾å½¢ç•Œé¢ä½¿ç”¨archetypeæ¨¡æ¿åˆ›å»ºé¡¹ç›®ï¼š\nè¿™é‡Œçš„ä¿¡æ¯æ ¹æ®archetype-catalog.xmlä¸­çš„å¡«å†™ï¼Œå¦‚æœæ˜¯æœ¬åœ°å¯¼å…¥Repositoryå¯ä»¥ä¸å¡«æˆ–è€…å¡«\u0026rsquo;local'ã€‚æ—¢ç„¶æåˆ°æœ¬åœ°ï¼Œé‚£ä¹ˆè‡ªç„¶å¯ä»¥æƒ³åˆ°ï¼Œå¯ä»¥å°†è„šæ‰‹æ¶å‘å¸ƒåˆ°nexusç§æœã€‚å‘å¸ƒåˆ°ç§æœå¯ä»¥å‚çœ‹è¿™é‡Œï¼šhttps://www.cnblogs.com/woshimrf/p/maven-artifact-demo.html\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E8%84%9A%E6%89%8B%E6%9E%B6/","series":["Manual"],"tags":["Java"],"title":"è„šæ‰‹æ¶"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"å½“è¯·æ±‚å½¢å¦‚ï¼š/opendoc/jquery-1.10.2.min.js çš„é™æ€èµ„æºæ—¶ï¼Œå¦‚æœæ°å¥½å­˜åœ¨åŒ¹é…è¿™ä¸ªè¯·æ±‚çš„Controlleræ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé™æ€èµ„æºè¯·æ±‚ä¼šè¢« RequestMappingHandlerMapping åˆ†é…ç»™è¿™ä¸ªControllerå¤„ç†ï¼Œä»è€Œå¯èƒ½æ‰¾ä¸åˆ°é™æ€èµ„æºï¼Œä¾‹å¦‚å­˜åœ¨ä¸‹é¢è¿™æ ·çš„Controllerï¼š\n@RequestMapping(value = \u0026#34;/{name}/{version}\u0026#34;, method = {RequestMethod.POST, RequestMethod.GET}) public void rest3(@PathVariable(\u0026#34;name\u0026#34;) String name, @PathVariable(\u0026#34;version\u0026#34;) String version, HttpServletRequest request, HttpServletResponse response) { this.doRest(name, version, request, response); } ä¸ºäº†èƒ½æ­£ç¡®åŒ¹é…çš„é™æ€èµ„æºï¼Œæˆ‘ä»¬å¯ä»¥è°ƒæ•´Spring HandlerMappingçš„é¡ºåºï¼Œè®©SimpleUrlHandlerMappingå…ˆäºRequestMappingHandlerMappingå»åŒ¹é…è¯·æ±‚ï¼ŒSimpleUrlHandlerMappingä¼šè¿”å›ä¸€ä¸ªç”¨äºåŠ è½½é™æ€èµ„æºçš„ResourceHttpRequestHandler\né»˜è®¤æƒ…å†µä¸‹RequestMappingHandlerMapping å…ˆäºSimpleUrlHandlerMappingåŒ¹é…è¯·æ±‚ï¼ŒDispatchServletä¸­åˆå§‹åŒ–HandlerMappingçš„é¡ºåºæºç å¦‚ä¸‹æ‰€ç¤ºï¼š\n/** * Initialize the HandlerMappings used by this class. * \u0026lt;p\u0026gt;If no HandlerMapping beans are defined in the BeanFactory for this namespace, * we default to BeanNameUrlHandlerMapping. */ private void initHandlerMappings(ApplicationContext context) { this.handlerMappings = null; if (this.detectAllHandlerMappings) { // Find all HandlerMappings in the ApplicationContext, including ancestor contexts. \tMap\u0026lt;String, HandlerMapping\u0026gt; matchingBeans = BeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerMapping.class, true, false); if (!matchingBeans.isEmpty()) { this.handlerMappings = new ArrayList\u0026lt;\u0026gt;(matchingBeans.values()); // We keep HandlerMappings in sorted order. \tAnnotationAwareOrderComparator.sort(this.handlerMappings); } } else { try { HandlerMapping hm = context.getBean(HANDLER_MAPPING_BEAN_NAME, HandlerMapping.class); this.handlerMappings = Collections.singletonList(hm); } catch (NoSuchBeanDefinitionException ex) { // Ignore, we\u0026#39;ll add a default HandlerMapping later. \t} } // Ensure we have at least one HandlerMapping, by registering \t// a default HandlerMapping if no other mappings are found. \tif (this.handlerMappings == null) { this.handlerMappings = getDefaultStrategies(context, HandlerMapping.class); if (logger.isTraceEnabled()) { logger.trace(\u0026#34;No HandlerMappings declared for servlet \u0026#39;\u0026#34; + getServletName() + \u0026#34;\u0026#39;: using default strategies from DispatcherServlet.properties\u0026#34;); } } } é»˜è®¤æƒ…å†µä¸‹RequestMappingHandlerMapping å…ˆäºSimpleUrlHandlerMappingåŒ¹é…è¯·æ±‚ï¼š\nè°ƒæ•´HandlerMappingé¡ºåºï¼š\n@Configuration public class WebConfiguration extends WebMvcConfigurationSupport { @Override public void addResourceHandlers(ResourceHandlerRegistry registry){ registry.addResourceHandler(\u0026#34;/opendoc/**\u0026#34;).addResourceLocations(\u0026#34;/opendoc/\u0026#34;); registry.setOrder(0); } @Override @Bean public RequestMappingHandlerMapping requestMappingHandlerMapping(ContentNegotiationManager contentNegotiationManager, FormattingConversionService conversionService, ResourceUrlProvider resourceUrlProvider) { RequestMappingHandlerMapping handler = super.requestMappingHandlerMapping(contentNegotiationManager, conversionService, resourceUrlProvider); handler.setOrder(1); return handler; } } orderå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚\nè°ƒæ•´ä¹‹åçš„HandlerMappingé¡ºåºï¼š\næ­¤æ—¶ï¼ŒSimpleUrlHandlerMappingä¼šè¿”å›ä¸€ä¸ªç”¨äºåŠ è½½é™æ€èµ„æºçš„ResourceHttpRequestHandler\nå‚è€ƒé“¾æ¥ğŸ”—ï¼š Spring - Set HandlerMapping Priority\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/spring/%E8%B0%83%E6%95%B4spring-handlermapping%E7%9A%84%E9%A1%BA%E5%BA%8F/","series":["Manual"],"tags":["Spring"],"title":"è°ƒæ•´Spring HandlerMappingçš„é¡ºåº"},{"categories":["äº‘åŸç”Ÿ"],"content":"éƒ¨ç½²sentinel-dashboard\n1. æ„å»ºé•œåƒ FROMopenjdk:8-jdk-alpineVOLUME/tmpADD sentinel-dashboard-1.8.0.jar sentinel-dashboard.jarCMD java ${JAVA_OPTS} -jar sentinel-dashboard.jarEXPOSE87182. åˆ›å»ºheadless service apiVersion: v1 kind: Service metadata: name: sentinel-headless labels: app: sentinel annotations: service.alpha.kubernetes.io/tolerate-unready-endpoints: \u0026#34;true\u0026#34; spec: ports: - port: 8718 name: server targetPort: 8718 clusterIP: None selector: app: sentinel 3. åˆ›å»ºStatefulSet apiVersion: apps/v1 kind: StatefulSet metadata: name: sentinel spec: serviceName: sentinel replicas: 1 template: metadata: labels: app: sentinel annotations: pod.alpha.kubernetes.io/initialized: \u0026#34;true\u0026#34; spec: containers: - name: sentinel imagePullPolicy: IfNotPresent image: ccr.ccs.tencentyun.com/xuzhijun/sentinel-dashboard:latest resources: requests: memory: \u0026#34;512Mi\u0026#34; cpu: \u0026#34;200m\u0026#34; ports: - containerPort: 8719 name: client env: - name: TZ value: Asia/Shanghai - name: JAVA_OPTS value: \u0026#34;-Dserver.port=8718 -Dcsp.sentinel.dashboard.server=localhost:8718 -Dproject.name=sentinel-dashboard -Djava.security.egd=file:/dev/./urandom -Dcsp.sentinel.api.port=8719\u0026#34; imagePullSecrets: - name: registry-secret-tencent selector: matchLabels: app: sentinel 4. é€šè¿‡Ingressæš´éœ²æœåŠ¡ apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: ingress-yshopcloud annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; # å¼€å¯use-regexï¼Œå¯ç”¨pathçš„æ­£åˆ™åŒ¹é… nginx.ingress.kubernetes.io/use-regex: \u0026#34;true\u0026#34; spec: rules: # å®šä¹‰åŸŸå - host: sentinel.6and.ltd http: paths: # ä¸åŒpathè½¬å‘åˆ°ä¸åŒç«¯å£ - path: / backend: serviceName: sentinel-headless servicePort: 8718 ","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/k8s/2.%E5%AE%9E%E6%88%98/%E9%83%A8%E7%BD%B2sentinel-dashboard/","series":["k8så®æˆ˜"],"tags":["äº‘åŸç”Ÿ","k8s"],"title":"éƒ¨ç½²sentinel-dashboard"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"æ—¶å¸¸æˆ‘ä»¬æƒ³é€šè¿‡pathæ¥åŒºåˆ†é¡¹ç›®ï¼Œä¾‹å¦‚é€šè¿‡ http://xxxx/admin è®¿é—®æˆ‘ä»¬çš„åå°ï¼Œå¦‚æœvueæ˜¯çš„modeæ˜¯historyï¼Œè¯·æ³¨æ„å¦‚ä¸‹é…ç½®ï¼š\n ä¿®æ”¹vue-config.jsæ–‡ä»¶é…ç½®  module.exports = {publicPath: \u0026#34;\u0026#34;}; ä¿®æ”¹è·¯ç”±route/index  const router = new Router({ base: \u0026#39;/admin/\u0026#39;, //è·¯ç”±æ¨¡å¼ä¸ºhistoryæ¨¡å¼æ—¶ï¼Œbaseå¿…é¡»è¦åŠ ä¸Š;è·¯ç”±æ¨¡å¼ä¸ºhashæ¨¡å¼æ—¶ï¼Œbaseå¯åŠ å¯ä¸åŠ   mode: \u0026#39;history\u0026#39;, routes: [] } æ­¤æ—¶ï¼Œè¯·æ±‚æ˜¯å½¢å¦‚ http://xxxx/admin/xxx.cssï¼Œä»è€Œé¿å…å‡ºç°å½¢å¦‚http://xxxx/xxx.cssæ‰¾ä¸åˆ°èµ„æºçš„æƒ…å†µã€‚\n","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/nginx/%E9%83%A8%E7%BD%B2vue%E9%A1%B9%E7%9B%AE/","series":["Manual"],"tags":["nginx"],"title":"éƒ¨ç½²vueé¡¹ç›®"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"é˜¿é‡Œé¢è¯•ï¼Œé—®äº†æˆ‘ä¹è§‚é”ã€æ‚²è§‚é”ã€AQSã€syncå’ŒLockï¼Œè¿™ä¸ªå›ç­”è®©æˆ‘æ‹¿äº†offer\ré˜¿é‡Œé¢è¯•å®˜ï¼šè¯´ä¸€ä¸‹å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ«ï¼Ÿ\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E9%94%81/","series":["Manual"],"tags":["Java"],"title":"é”"},{"categories":["å…¶ä»–"],"content":"1ï¼‰use mysql 2ï¼‰å°†hostè®¾ç½®ä¸º%è¡¨ç¤ºä»»ä½•ipéƒ½èƒ½è¿æ¥mysql update user set host=\u0026#39;%\u0026#39; where user=\u0026#39;root\u0026#39; and host=\u0026#39;localhost\u0026#39;; 3) æ‰§è¡Œå®Œä»¥ä¸Šè¯­å¥,æ¥ç€æ‰§è¡Œä»¥ä¸‹è¯­å¥ ,åˆ·æ–°æƒé™è¡¨,ä½¿é…ç½®ç”Ÿæ•ˆ flush privileges; å‚è€ƒé“¾æ¥ï¼š é˜¿é‡Œäº‘ä¸‹é…ç½®MySQLè¿œç¨‹è¿æ¥çš„æ­¥éª¤è¯¦è§£\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E5%85%B6%E4%BB%96/%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%8B%E9%85%8D%E7%BD%AEmysql%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5/","series":["Manual"],"tags":["Other"],"title":"é˜¿é‡Œäº‘ä¸‹é…ç½®MySQLè¿œç¨‹è¿æ¥"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"1. ç®€ä»‹ é›¶æ‹·è´çš„â€œé›¶â€æ˜¯æŒ‡ç”¨æˆ·æ€å’Œå†…æ ¸æ€é—´copyæ•°æ®çš„æ¬¡æ•°ä¸ºé›¶ã€‚\nä¼ ç»Ÿçš„æ•°æ®copyï¼ˆæ–‡ä»¶åˆ°æ–‡ä»¶ã€clientåˆ°serverç­‰ï¼‰æ¶‰åŠåˆ°å››æ¬¡ç”¨æˆ·æ€å†…æ ¸æ€åˆ‡æ¢ã€å››æ¬¡copyã€‚å››æ¬¡copyä¸­ï¼Œä¸¤æ¬¡åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€é—´copyéœ€è¦CPUå‚ä¸ã€ä¸¤æ¬¡åœ¨å†…æ ¸æ€ä¸IOè®¾å¤‡é—´copyä¸ºDMAæ–¹å¼ä¸éœ€è¦CPUå‚ä¸ã€‚é›¶æ‹·è´é¿å…äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€é—´çš„copyã€å‡å°‘äº†Javaé›¶æ‹·è´æœºåˆ¶è§£ææ ¸æ€é—´çš„åˆ‡æ¢ã€‚\n DMA(Direct Memory Accessï¼Œç›´æ¥å†…å­˜å­˜å–) æ˜¯æ‰€æœ‰ç°ä»£ç”µè„‘çš„é‡è¦ç‰¹è‰²ï¼Œå®ƒå…è®¸ä¸åŒé€Ÿåº¦çš„ç¡¬ä»¶è£…ç½®æ¥æ²Ÿé€šï¼Œè€Œä¸éœ€è¦ä¾èµ–äºCPU çš„å¤§é‡ä¸­æ–­è´Ÿè½½ã€‚ DMAæ§åˆ¶å™¨ï¼Œæ¥ç®¡äº†æ•°æ®è¯»å†™è¯·æ±‚ï¼Œå‡å°‘CPUçš„è´Ÿæ‹…ã€‚è¿™æ ·ä¸€æ¥ï¼ŒCPUèƒ½é«˜æ•ˆå·¥ä½œäº†ã€‚ ç°ä»£ç¡¬ç›˜åŸºæœ¬éƒ½æ”¯æŒDMAã€‚\n ä½¿ç”¨Zero Copyå‰åå¯¹æ¯”ï¼š\nä½¿ç”¨å‰ï¼š\nä½¿ç”¨åï¼š\nLinuxæ”¯æŒçš„(å¸¸è§)é›¶æ‹·è´ mmapå†…å­˜æ˜ å°„` `sendfile` `Sendfile With DMA Scatter/Gather Copy` `splice\ræ— è®ºæ˜¯ä¼ ç»ŸIOæ–¹å¼ï¼Œè¿˜æ˜¯å¼•å…¥é›¶æ‹·è´ä¹‹åï¼Œ2æ¬¡DMA copy æ˜¯éƒ½å°‘ä¸äº†çš„ã€‚å› ä¸ºä¸¤æ¬¡DMAéƒ½æ˜¯ä¾èµ–ç¡¬ä»¶å®Œæˆçš„ã€‚\nå®é™…ä¸Šï¼Œé›¶æ‹·è´æ—¶æœ‰å¹¿ä¹‰å’Œç‹­ä¹‰ä¹‹åˆ†çš„ã€‚ å¹¿ä¹‰é›¶æ‹·è´ï¼š èƒ½å‡å°‘æ‹·è´æ¬¡æ•°ï¼Œå‡å°‘ä¸å¿…è¦çš„æ•°æ®æ‹·è´ï¼Œå°±ç®—ä½œâ€œé›¶æ‹·è´â€ã€‚ è¿™æ˜¯ç›®å‰ï¼Œå¯¹é›¶æ‹·è´æœ€ä¸ºå¹¿æ³›çš„å®šä¹‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œè¿™æ˜¯å¹¿ä¹‰ä¸Šçš„é›¶æ‹·è´ï¼Œå¹¶ä¸æ˜¯æ“ä½œç³»ç»Ÿ æ„ä¹‰ä¸Šçš„é›¶æ‹·è´ã€‚\nJavaé›¶æ‹·è´æœºåˆ¶è§£æ Linuxæä¾›çš„é¢†æ‹·è´æŠ€æœ¯ Javaå¹¶ä¸æ˜¯å…¨æ”¯æŒï¼Œæ”¯æŒ2ç§(å†…å­˜æ˜ å°„mmapã€sendfile)ï¼›\nNIOæä¾›çš„å†…å­˜æ˜ å°„ï¼šMappedByteBuffer\nNIOæä¾›çš„sendfileï¼šFileChannel.transferTo() FileChannel.transferFrom()\nå‚è€ƒé“¾æ¥ï¼š Javaä¸­çš„é›¶æ‹·è´\rJavaé›¶æ‹·è´\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/java/%E9%9B%B6%E6%8B%B7%E8%B4%9D/","series":["Manual"],"tags":["Java"],"title":"é›¶æ‹·è´"},{"categories":["ç¼–ç¨‹æ€æƒ³"],"content":"é«˜æ€§èƒ½æ— é”é˜Ÿåˆ—Disruptor 1. JDKä¸­çš„é˜Ÿåˆ— åœ¨jdkä¸­çš„é˜Ÿåˆ—éƒ½å®ç°äº†java.util.Queueæ¥å£ï¼Œåœ¨é˜Ÿåˆ—ä¸­åˆåˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒArrayDequeï¼ŒLinkedListç­‰ç­‰ï¼Œè¿˜æœ‰ä¸€ç±»éƒ½åœ¨java.util.concurrentåŒ…ä¸‹å±äºçº¿ç¨‹å®‰å…¨ï¼Œè€Œåœ¨æˆ‘ä»¬çœŸå®çš„ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬çš„æœºå™¨éƒ½æ˜¯å±äºå¤šçº¿ç¨‹ï¼Œå½“å¤šçº¿ç¨‹å¯¹åŒä¸€ä¸ªé˜Ÿåˆ—è¿›è¡Œæ’é˜Ÿæ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœä½¿ç”¨çº¿ç¨‹ä¸å®‰å…¨ä¼šå‡ºç°ï¼Œè¦†ç›–æ•°æ®ï¼Œæ•°æ®ä¸¢å¤±ç­‰æ— æ³•é¢„æµ‹çš„äº‹æƒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™ä¸ªæ—¶å€™åªèƒ½é€‰æ‹©çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ã€‚åœ¨jdkä¸­æä¾›çš„çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ä¸‹é¢ç®€å•åˆ—ä¸¾éƒ¨åˆ†é˜Ÿåˆ—:\n   é˜Ÿåˆ—åå­— æ˜¯å¦åŠ é” æ•°æ®ç»“æ„ å…³é”®æŠ€æœ¯ç‚¹ æ˜¯å¦æœ‰é” æ˜¯å¦æœ‰ç•Œ     ArrayBlockingQueue æ˜¯ æ•°ç»„array ReentrantLock æœ‰é” æœ‰ç•Œ   LinkedBlockingQueue æ˜¯ é“¾è¡¨ ReentrantLock æœ‰é” æœ‰ç•Œ   LinkedTransferQueue å¦ é“¾è¡¨ CAS æ— é” æ— ç•Œ   ConcurrentLinkedQueue å¦ é“¾è¡¨ CAS æ— é” æ— ç•Œ    æˆ‘ä»¬å¯ä»¥çœ‹è§ï¼Œæˆ‘ä»¬æ— é”çš„é˜Ÿåˆ—æ˜¯æ— ç•Œçš„ï¼Œæœ‰é”çš„é˜Ÿåˆ—æ˜¯æœ‰ç•Œçš„ï¼Œè¿™é‡Œå°±ä¼šæ¶‰åŠåˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨çœŸæ­£çš„çº¿ä¸Šç¯å¢ƒä¸­ï¼Œæ— ç•Œçš„é˜Ÿåˆ—ï¼Œå¯¹æˆ‘ä»¬ç³»ç»Ÿçš„å½±å“æ¯”è¾ƒå¤§ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´æˆ‘ä»¬å†…å­˜ç›´æ¥æº¢å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆå¾—æ’é™¤æ— ç•Œé˜Ÿåˆ—ï¼Œå½“ç„¶å¹¶ä¸æ˜¯æ— ç•Œé˜Ÿåˆ—å°±æ²¡ç”¨äº†ï¼Œåªæ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹å¾—æ’é™¤ã€‚å…¶æ¬¡è¿˜å‰©ä¸‹ArrayBlockingQueueï¼ŒLinkedBlockingQueueä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä»–ä»¬ä¸¤ä¸ªéƒ½æ˜¯ç”¨ReentrantLockæ§åˆ¶çš„çº¿ç¨‹å®‰å…¨ï¼Œä»–ä»¬ä¸¤ä¸ªçš„åŒºåˆ«ä¸€ä¸ªæ˜¯æ•°ç»„ï¼Œä¸€ä¸ªæ˜¯é“¾è¡¨ï¼Œåœ¨é˜Ÿåˆ—ä¸­ï¼Œä¸€èˆ¬è·å–è¿™ä¸ªé˜Ÿåˆ—å…ƒç´ ä¹‹åç´§æ¥ç€ä¼šè·å–ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…ä¸€æ¬¡è·å–å¤šä¸ªé˜Ÿåˆ—å…ƒç´ éƒ½æœ‰å¯èƒ½ï¼Œè€Œæ•°ç»„åœ¨å†…å­˜ä¸­åœ°å€æ˜¯è¿ç»­çš„ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­ä¼šæœ‰ç¼“å­˜çš„ä¼˜åŒ–(ä¸‹é¢ä¹Ÿä¼šä»‹ç»ç¼“å­˜è¡Œ)ï¼Œæ‰€ä»¥è®¿é—®çš„é€Ÿåº¦ä¼šç•¥èƒœä¸€ç­¹ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå°½é‡å»é€‰æ‹©ArrayBlockingQueueã€‚è€Œäº‹å®è¯æ˜åœ¨å¾ˆå¤šç¬¬ä¸‰æ–¹çš„æ¡†æ¶ä¸­ï¼Œæ¯”å¦‚æ—©æœŸçš„log4jå¼‚æ­¥ï¼Œéƒ½æ˜¯é€‰æ‹©çš„ArrayBlockingQueueã€‚\nå½“ç„¶ArrayBlockingQueueï¼Œä¹Ÿæœ‰è‡ªå·±çš„å¼Šç«¯ï¼Œå°±æ˜¯æ€§èƒ½æ¯”è¾ƒä½ï¼Œä¸ºä»€ä¹ˆjdkä¼šå¢åŠ ä¸€äº›æ— é”çš„é˜Ÿåˆ—ï¼Œå…¶å®å°±æ˜¯ä¸ºäº†å¢åŠ æ€§èƒ½ï¼Œå¾ˆè‹¦æ¼ï¼Œåˆéœ€è¦æ— é”ï¼Œåˆéœ€è¦æœ‰ç•Œï¼Œè¿™ä¸ªæ—¶å€™ææ€•ä¼šå¿ä¸ä½è¯´ä¸€å¥ä½ å’‹ä¸ä¸Šå¤©å‘¢ï¼Ÿä½†æ˜¯è¿˜çœŸæœ‰äººä¸Šå¤©äº†ã€‚\n2.Disruptor Disruptorå°±æ˜¯ä¸Šé¢è¯´çš„é‚£ä¸ªå¤©ï¼ŒDisruptoræ˜¯è‹±å›½å¤–æ±‡äº¤æ˜“å…¬å¸LMAXå¼€å‘çš„ä¸€ä¸ªé«˜æ€§èƒ½é˜Ÿåˆ—ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªå¼€æºçš„å¹¶å‘æ¡†æ¶ï¼Œå¹¶è·å¾—2011Dukeâ€™sç¨‹åºæ¡†æ¶åˆ›æ–°å¥–ã€‚èƒ½å¤Ÿåœ¨æ— é”çš„æƒ…å†µä¸‹å®ç°ç½‘ç»œçš„Queueå¹¶å‘æ“ä½œï¼ŒåŸºäºDisruptorå¼€å‘çš„ç³»ç»Ÿå•çº¿ç¨‹èƒ½æ”¯æ’‘æ¯ç§’600ä¸‡è®¢å•ã€‚ç›®å‰ï¼ŒåŒ…æ‹¬Apache Stormã€Camelã€Log4j2ç­‰ç­‰çŸ¥åçš„æ¡†æ¶éƒ½åœ¨å†…éƒ¨é›†æˆäº†Disruptorç”¨æ¥æ›¿ä»£jdkçš„é˜Ÿåˆ—ï¼Œä»¥æ­¤æ¥è·å¾—é«˜æ€§èƒ½ã€‚\n3.1ä¸ºä»€ä¹ˆè¿™ä¹ˆç‰›é€¼ï¼Ÿ ä¸Šé¢å·²ç»æŠŠDisruptorå¹å‡ºäº†èŠ±äº†ï¼Œä½ è‚¯å®šä¼šäº§ç”Ÿç–‘é—®ï¼Œä»–çœŸçš„èƒ½æœ‰è¿™ä¹ˆç‰›é€¼å—ï¼Œæˆ‘çš„å›ç­”æ˜¯å½“ç„¶çš„ï¼Œåœ¨Disruptorä¸­æœ‰ä¸‰å¤§æ€å™¨:\n  CAS\n  æ¶ˆé™¤ä¼ªå…±äº«\n  RingBuffer\næœ‰äº†è¿™ä¸‰å¤§æ€å™¨ï¼ŒDisruptoræ‰å˜å¾—å¦‚æ­¤ç‰›é€¼ã€‚\n  3.1.1 é”å’ŒCAS CASå®ç°æ— é”é˜Ÿåˆ—å¯ä»¥å‚è€ƒğŸ‘‰æ— é”é˜Ÿåˆ—çš„å®ç°\ræˆ‘ä»¬ArrayBlockingQueueä¸ºä»€ä¹ˆä¼šè¢«æŠ›å¼ƒçš„ä¸€ç‚¹ï¼Œå°±æ˜¯å› ä¸ºç”¨äº†é‡é‡çº§locké”ï¼Œåœ¨æˆ‘ä»¬åŠ é”è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šæŠŠé”æŒ‚èµ·ï¼Œè§£é”åï¼Œåˆä¼šæŠŠçº¿ç¨‹æ¢å¤,è¿™ä¸€è¿‡ç¨‹ä¼šæœ‰ä¸€å®šçš„å¼€é”€ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸€æ—¦æ²¡æœ‰è·å–é”ï¼Œè¿™ä¸ªçº¿ç¨‹å°±åªèƒ½ä¸€ç›´ç­‰å¾…ï¼Œè¿™ä¸ªçº¿ç¨‹ä»€ä¹ˆäº‹ä¹Ÿä¸èƒ½åšã€‚\nCASï¼ˆcompare and swapï¼‰ï¼Œé¡¾åæ€ä¹‰å…ˆæ¯”è¾ƒåœ¨äº¤æ¢ï¼Œä¸€èˆ¬æ˜¯æ¯”è¾ƒæ˜¯å¦æ˜¯è€çš„å€¼ï¼Œå¦‚æœæ˜¯çš„è¿›è¡Œäº¤æ¢è®¾ç½®ï¼Œå¤§å®¶ç†Ÿæ‚‰ä¹è§‚é”çš„äººéƒ½çŸ¥é“CASå¯ä»¥ç”¨æ¥å®ç°ä¹è§‚é”ï¼ŒCASä¸­æ²¡æœ‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå‡å°‘äº†ä¸å¿…è¦çš„å¼€é”€ã€‚ è¿™é‡Œä½¿ç”¨JMHï¼Œç”¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œæ¯æ¬¡1ä¸€æ¬¡è°ƒç”¨ï¼Œåœ¨æˆ‘æœ¬æœºä¸Šè¿›è¡Œæµ‹è¯•ï¼Œä»£ç å¦‚ä¸‹:\n@BenchmarkMode({Mode.SampleTime}) @OutputTimeUnit(TimeUnit.MILLISECONDS) @Warmup(iterations=3, time = 5, timeUnit = TimeUnit.MILLISECONDS) @Measurement(iterations=1,batchSize = 100000000) @Threads(2) @Fork(1) @State(Scope.Benchmark) public class Myclass { Lock lock = new ReentrantLock(); long i = 0; AtomicLong atomicLong = new AtomicLong(0); @Benchmark public void measureLock() { lock.lock(); i++; lock.unlock(); } @Benchmark public void measureCAS() { atomicLong.incrementAndGet(); } @Benchmark public void measureNoLock() { i++; } } æµ‹è¯•å‡ºæ¥ç»“æœå¦‚ä¸‹:\n   æµ‹è¯•é¡¹ç›® æµ‹è¯•ç»“æœ     Lock 26000ms   CAS 4840ms   æ— é” 197ms    å¯ä»¥çœ‹è§Lockæ˜¯äº”ä½æ•°ï¼ŒCASæ˜¯å››ä½æ•°ï¼Œæ— é”æ›´å°æ˜¯ä¸‰ä½æ•°ã€‚ ç”±æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“Lock\u0026gt;CAS\u0026gt;æ— é”ã€‚\nè€Œæˆ‘ä»¬çš„Disruptorä¸­ä½¿ç”¨çš„å°±æ˜¯CASï¼Œä»–åˆ©ç”¨CASè¿›è¡Œé˜Ÿåˆ—ä¸­çš„ä¸€äº›ä¸‹æ ‡è®¾ç½®ï¼Œå‡å°‘äº†é”çš„å†²çªï¼Œæé«˜äº†æ€§èƒ½ã€‚\nå¦å¤–å¯¹äºjdkä¸­å…¶ä»–çš„æ— é”é˜Ÿåˆ—ä¹Ÿæ˜¯ä½¿ç”¨CASï¼ŒåŸå­ç±»ä¹Ÿæ˜¯ä½¿ç”¨CASã€‚\n3.1.2 ä¼ªå…±äº« è°ˆåˆ°äº†ä¼ªå…±äº«å°±ä¸å¾—ä¸è¯´è®¡ç®—æœºCPUç¼“å­˜,ç¼“å­˜å¤§å°æ˜¯CPUçš„é‡è¦æŒ‡æ ‡ä¹‹ä¸€ï¼Œè€Œä¸”ç¼“å­˜çš„ç»“æ„å’Œå¤§å°å¯¹CPUé€Ÿåº¦çš„å½±å“éå¸¸å¤§ï¼ŒCPUå†…ç¼“å­˜çš„è¿è¡Œé¢‘ç‡æé«˜ï¼Œä¸€èˆ¬æ˜¯å’Œå¤„ç†å™¨åŒé¢‘è¿ä½œï¼Œå·¥ä½œæ•ˆç‡è¿œè¿œå¤§äºç³»ç»Ÿå†…å­˜å’Œç¡¬ç›˜ã€‚å®é™…å·¥ä½œæ—¶ï¼ŒCPUå¾€å¾€éœ€è¦é‡å¤è¯»å–åŒæ ·çš„æ•°æ®å—ï¼Œè€Œç¼“å­˜å®¹é‡çš„å¢å¤§ï¼Œå¯ä»¥å¤§å¹…åº¦æå‡CPUå†…éƒ¨è¯»å–æ•°æ®çš„å‘½ä¸­ç‡ï¼Œè€Œä¸ç”¨å†åˆ°å†…å­˜æˆ–è€…ç¡¬ç›˜ä¸Šå¯»æ‰¾ï¼Œä»¥æ­¤æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ä½†æ˜¯ä»CPUèŠ¯ç‰‡é¢ç§¯å’Œæˆæœ¬çš„å› ç´ æ¥è€ƒè™‘ï¼Œç¼“å­˜éƒ½å¾ˆå°ã€‚\nCPUç¼“å­˜å¯ä»¥åˆ†ä¸ºä¸€çº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜ï¼Œå¦‚ä»Šä¸»æµCPUè¿˜æœ‰ä¸‰çº§ç¼“å­˜ï¼Œç”šè‡³æœ‰äº›CPUè¿˜æœ‰å››çº§ç¼“å­˜ã€‚æ¯ä¸€çº§ç¼“å­˜ä¸­æ‰€å‚¨å­˜çš„å…¨éƒ¨æ•°æ®éƒ½æ˜¯ä¸‹ä¸€çº§ç¼“å­˜çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä¸‰ç§ç¼“å­˜çš„æŠ€æœ¯éš¾åº¦å’Œåˆ¶é€ æˆæœ¬æ˜¯ç›¸å¯¹é€’å‡çš„ï¼Œæ‰€ä»¥å…¶å®¹é‡ä¹Ÿæ˜¯ç›¸å¯¹é€’å¢çš„ã€‚\nä¸ºä»€ä¹ˆCPUä¼šæœ‰L1ã€L2ã€L3è¿™æ ·çš„ç¼“å­˜è®¾è®¡ï¼Ÿä¸»è¦æ˜¯å› ä¸ºç°åœ¨çš„å¤„ç†å™¨å¤ªå¿«äº†ï¼Œè€Œä»å†…å­˜ä¸­è¯»å–æ•°æ®å®åœ¨å¤ªæ…¢ï¼ˆä¸€ä¸ªæ˜¯å› ä¸ºå†…å­˜æœ¬èº«é€Ÿåº¦ä¸å¤Ÿï¼Œå¦ä¸€ä¸ªæ˜¯å› ä¸ºå®ƒç¦»CPUå¤ªè¿œäº†ï¼Œæ€»çš„æ¥è¯´éœ€è¦è®©CPUç­‰å¾…å‡ åç”šè‡³å‡ ç™¾ä¸ªæ—¶é’Ÿå‘¨æœŸï¼‰ï¼Œè¿™ä¸ªæ—¶å€™ä¸ºäº†ä¿è¯CPUçš„é€Ÿåº¦ï¼Œå°±éœ€è¦å»¶è¿Ÿæ›´å°é€Ÿåº¦æ›´å¿«çš„å†…å­˜æä¾›å¸®åŠ©ï¼Œè€Œè¿™å°±æ˜¯ç¼“å­˜ã€‚å¯¹è¿™ä¸ªæ„Ÿå…´è¶£å¯ä»¥æŠŠç”µè„‘CPUæ‹†ä¸‹æ¥ï¼Œè‡ªå·±æŠŠç©ä¸€ä¸‹ã€‚\næ¯ä¸€æ¬¡ä½ å¬è§intelå‘å¸ƒæ–°çš„cpuä»€ä¹ˆ,æ¯”å¦‚i7-7700k,8700kï¼Œéƒ½ä¼šå¯¹cpuç¼“å­˜å¤§å°è¿›è¡Œä¼˜åŒ–ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œä¸‹æ¥æœç´¢ï¼Œè¿™äº›çš„å‘å¸ƒä¼šæˆ–è€…å‘å¸ƒæ–‡ç« ã€‚\nMartinå’ŒMikeçš„ QCon presentationæ¼”è®²ä¸­ç»™å‡ºäº†ä¸€äº›æ¯ä¸ªç¼“å­˜æ—¶é—´ï¼š\n   ä»CPUåˆ° å¤§çº¦éœ€è¦çš„CPUå‘¨æœŸ å¤§çº¦éœ€è¦çš„æ—¶é—´     ä¸»å­˜  çº¦60-80çº³ç§’   QPI æ€»çº¿ä¼ è¾“(between sockets, not drawn)  çº¦20ns   L3 cache çº¦40-45 cycles çº¦15ns   L2 cache çº¦10 cycles çº¦3ns   L1 cache çº¦3-4 cycles çº¦1ns   å¯„å­˜å™¨  1 cycle    ç¼“å­˜è¡Œ å…³äºcache-lineæ›´ç»†è‡´çš„ä»‹ç»è¯·ç§»æ­¥ ğŸ‘‰ğŸ‘‰ JAVA æ‹¾é— â€” CPU Cache ä¸ç¼“å­˜è¡Œ\råœ¨cpuçš„å¤šçº§ç¼“å­˜ä¸­ï¼Œå¹¶ä¸æ˜¯ä»¥ç‹¬ç«‹çš„é¡¹æ¥ä¿å­˜çš„ï¼Œè€Œæ˜¯ç±»ä¼¼ä¸€ç§pageCaheçš„ä¸€ç§ç­–ç•¥ï¼Œä»¥ç¼“å­˜è¡Œæ¥ä¿å­˜ï¼Œè€Œç¼“å­˜è¡Œçš„å¤§å°é€šå¸¸æ˜¯64å­—èŠ‚ï¼Œåœ¨Javaä¸­Longæ˜¯8ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¯ä»¥å­˜å‚¨8ä¸ªLong,ä¸¾ä¸ªä¾‹å­ï¼Œä½ è®¿é—®ä¸€ä¸ªlongçš„å˜é‡çš„æ—¶å€™ï¼Œä»–ä¼šæŠŠå¸®åŠ©å†åŠ è½½7ä¸ªï¼Œæˆ‘ä»¬ä¸Šé¢è¯´ä¸ºä»€ä¹ˆé€‰æ‹©æ•°ç»„ä¸é€‰æ‹©é“¾è¡¨ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªåŸå› ï¼Œåœ¨æ•°ç»„ä¸­å¯ä»¥ä¾é ç¼“å†²è¡Œå¾—åˆ°å¾ˆå¿«çš„è®¿é—®ã€‚\nç¼“å­˜è¡Œæ˜¯ä¸‡èƒ½çš„å—ï¼ŸNOï¼Œå› ä¸ºä»–ä¾ç„¶å¸¦æ¥äº†ä¸€ä¸ªç¼ºç‚¹ï¼Œæˆ‘åœ¨è¿™é‡Œä¸¾ä¸ªä¾‹å­è¯´æ˜è¿™ä¸ªç¼ºç‚¹ï¼Œå¯ä»¥æƒ³è±¡æœ‰ä¸ªæ•°ç»„é˜Ÿåˆ—ï¼ŒArrayQueueï¼Œä»–çš„æ•°æ®ç»“æ„å¦‚ä¸‹:\nclass ArrayQueue{ long maxSize; long currentIndex; } å¯¹äºmaxSizeæ˜¯æˆ‘ä»¬ä¸€å¼€å§‹å°±å®šä¹‰å¥½çš„ï¼Œæ•°ç»„çš„å¤§å°ï¼Œå¯¹äºcurrentIndexï¼Œæ˜¯æ ‡å¿—æˆ‘ä»¬å½“å‰é˜Ÿåˆ—çš„ä½ç½®ï¼Œè¿™ä¸ªå˜åŒ–æ¯”è¾ƒå¿«ï¼Œå‡è®¾ä½ è®¿é—®maxSizeçš„æ—¶å€™ï¼ŒæŠŠcurrentIndexä¹ŸåŠ è½½è¿›æ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹æ›´æ–°currentIndex,å°±ä¼šæŠŠcpuä¸­çš„ç¼“å­˜è¡Œç½®ä½æ— æ•ˆï¼Œè¯·æ³¨æ„è¿™æ˜¯CPUè§„å®šçš„ï¼Œä»–å¹¶ä¸æ˜¯åªå§currentIndexç½®ä½æ— æ•ˆï¼Œå¦‚æœæ­¤æ—¶åˆç»§ç»­è®¿é—®maxSizeä»–ä¾ç„¶å¾—ç»§ç»­ä»å†…å­˜ä¸­è¯»å–ï¼Œä½†æ˜¯MaxSizeå´æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹å®šä¹‰å¥½çš„ï¼Œæˆ‘ä»¬åº”è¯¥è®¿é—®ç¼“å­˜å³å¯ï¼Œä½†æ˜¯å´è¢«æˆ‘ä»¬ç»å¸¸æ”¹å˜çš„currentIndexæ‰€å½±å“ã€‚\nPaddingçš„é­”æ³• ä¸ºäº†è§£å†³ä¸Šé¢ç¼“å­˜è¡Œå‡ºç°çš„é—®é¢˜ï¼Œåœ¨Disruptorä¸­é‡‡ç”¨äº†Paddingçš„æ–¹å¼ï¼Œ\nclass LhsPadding { protected long p1, p2, p3, p4, p5, p6, p7; } class Value extends LhsPadding { protected volatile long value; } class RhsPadding extends Value { protected long p9, p10, p11, p12, p13, p14, p15; } å…¶ä¸­çš„Valueå°±è¢«å…¶ä»–ä¸€äº›æ— ç”¨çš„longå˜é‡ç»™å¡«å……äº†ã€‚è¿™æ ·ä½ ä¿®æ”¹Valueçš„æ—¶å€™ï¼Œå°±ä¸ä¼šå½±å“åˆ°å…¶ä»–å˜é‡çš„ç¼“å­˜è¡Œã€‚\næœ€åé¡ºä¾¿ä¸€æï¼Œåœ¨jdk8ä¸­æä¾›äº†@Contendedçš„æ³¨è§£ï¼Œå½“ç„¶ä¸€èˆ¬æ¥è¯´åªå…è®¸Jdkä¸­å†…éƒ¨ï¼Œå¦‚æœä½ è‡ªå·±ä½¿ç”¨é‚£å°±å¾—é…ç½®Jvmå‚æ•° -RestricContentended = faseï¼Œå°†é™åˆ¶è¿™ä¸ªæ³¨è§£ç½®ä½å–æ¶ˆã€‚å¾ˆå¤šæ–‡ç« åˆ†æäº†ConcurrentHashMapï¼Œä½†æ˜¯éƒ½æŠŠè¿™ä¸ªæ³¨è§£ç»™å¿½ç•¥æ‰äº†ï¼Œåœ¨ConcurrentHashMapä¸­å°±ä½¿ç”¨äº†è¿™ä¸ªæ³¨è§£ï¼Œåœ¨ConcurrentHashMapæ¯ä¸ªæ¡¶éƒ½æ˜¯å•ç‹¬çš„ç”¨è®¡æ•°å™¨å»åšè®¡ç®—ï¼Œè€Œè¿™ä¸ªè®¡æ•°å™¨ç”±äºæ—¶åˆ»éƒ½åœ¨å˜åŒ–ï¼Œæ‰€ä»¥è¢«ç”¨è¿™ä¸ªæ³¨è§£è¿›è¡Œå¡«å……ç¼“å­˜è¡Œä¼˜åŒ–ï¼Œä»¥æ­¤æ¥å¢åŠ æ€§èƒ½ã€‚\n3.1.3 RingBuffer åœ¨Disruptorä¸­é‡‡ç”¨äº†æ•°ç»„çš„æ–¹å¼ä¿å­˜äº†æˆ‘ä»¬çš„æ•°æ®ï¼Œä¸Šé¢æˆ‘ä»¬ä¹Ÿä»‹ç»äº†é‡‡ç”¨æ•°ç»„ä¿å­˜æˆ‘ä»¬è®¿é—®æ—¶å¾ˆå¥½çš„åˆ©ç”¨ç¼“å­˜ï¼Œä½†æ˜¯åœ¨Disruptorä¸­è¿›ä¸€æ­¥é€‰æ‹©é‡‡ç”¨äº†ç¯å½¢æ•°ç»„è¿›è¡Œä¿å­˜æ•°æ®ï¼Œä¹Ÿå°±æ˜¯RingBufferã€‚åœ¨è¿™é‡Œå…ˆè¯´æ˜ä¸€ä¸‹ç¯å½¢æ•°ç»„å¹¶ä¸æ˜¯çœŸæ­£çš„ç¯å½¢æ•°ç»„ï¼Œåœ¨RingBufferä¸­æ˜¯é‡‡ç”¨å–ä½™çš„æ–¹å¼è¿›è¡Œè®¿é—®çš„ï¼Œæ¯”å¦‚æ•°ç»„å¤§å°ä¸º 10ï¼Œ0è®¿é—®çš„æ˜¯æ•°ç»„ä¸‹æ ‡ä¸º0è¿™ä¸ªä½ç½®ï¼Œå…¶å®10ï¼Œ20ç­‰è®¿é—®çš„ä¹Ÿæ˜¯æ•°ç»„çš„ä¸‹æ ‡ä¸º0çš„è¿™ä¸ªä½ç½®ã€‚\nå½“ç„¶å…¶ä¸ä»…è§£å†³äº†æ•°ç»„å¿«é€Ÿè®¿é—®çš„é—®é¢˜ï¼Œä¹Ÿè§£å†³äº†ä¸éœ€è¦å†æ¬¡åˆ†é…å†…å­˜çš„é—®é¢˜ï¼Œå‡å°‘äº†åƒåœ¾å›æ”¶ï¼Œå› ä¸ºæˆ‘ä»¬0ï¼Œ10ï¼Œ20ç­‰éƒ½æ˜¯æ‰§è¡Œçš„åŒä¸€ç‰‡å†…å­˜åŒºåŸŸï¼Œè¿™æ ·å°±ä¸éœ€è¦å†æ¬¡åˆ†é…å†…å­˜ï¼Œé¢‘ç¹çš„è¢«JVMåƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚\nè‡ªæ­¤ä¸‰å¤§æ€å™¨å·²ç»è¯´å®Œäº†ï¼Œæœ‰äº†è¿™ä¸‰å¤§æ€å™¨ä¸ºDisruptorå¦‚æ­¤é«˜æ€§èƒ½å«å®šäº†åŸºç¡€ã€‚æ¥ä¸‹æ¥è¿˜ä¼šåœ¨è®²è§£å¦‚ä½•ä½¿ç”¨Disruptorå’ŒDisruptorçš„å…·ä½“çš„å·¥ä½œåŸç†ã€‚\n3.2 Disruptoræ€ä¹ˆä½¿ç”¨ ä¸‹é¢ä¸¾äº†ä¸€ä¸ªç®€å•çš„ä¾‹å­:\npublic static void main(String[] args) throws Exception { // é˜Ÿåˆ—ä¸­çš„å…ƒç´   class Element { @Contended private String value; public String getValue() { return value; } public void setValue(String value) { this.value = value; } } // ç”Ÿäº§è€…çš„çº¿ç¨‹å·¥å‚  ThreadFactory threadFactory = new ThreadFactory() { int i = 0; @Override public Thread newThread(Runnable r) { return new Thread(r, \u0026#34;simpleThread\u0026#34; + String.valueOf(i++)); } }; // RingBufferç”Ÿäº§å·¥å‚,åˆå§‹åŒ–RingBufferçš„æ—¶å€™ä½¿ç”¨  EventFactory\u0026lt;Element\u0026gt; factory = new EventFactory\u0026lt;Element\u0026gt;() { @Override public Element newInstance() { return new Element(); } }; // å¤„ç†Eventçš„handler  EventHandler\u0026lt;Element\u0026gt; handler = new EventHandler\u0026lt;Element\u0026gt;() { @Override public void onEvent(Element element, long sequence, boolean endOfBatch) throws InterruptedException { System.out.println(\u0026#34;Element: \u0026#34; + Thread.currentThread().getName() + \u0026#34;: \u0026#34; + element.getValue() + \u0026#34;: \u0026#34; + sequence); // Thread.sleep(10000000);  } }; // é˜»å¡ç­–ç•¥  BlockingWaitStrategy strategy = new BlockingWaitStrategy(); // æŒ‡å®šRingBufferçš„å¤§å°  int bufferSize = 8; // åˆ›å»ºdisruptorï¼Œé‡‡ç”¨å•ç”Ÿäº§è€…æ¨¡å¼  Disruptor\u0026lt;Element\u0026gt; disruptor = new Disruptor(factory, bufferSize, threadFactory, ProducerType.SINGLE, strategy); // è®¾ç½®EventHandler  disruptor.handleEventsWith(handler); // å¯åŠ¨disruptorçš„çº¿ç¨‹  disruptor.start(); for (int i = 0; i \u0026lt; 10; i++) { disruptor.publishEvent((element, sequence) -\u0026gt; { System.out.println(\u0026#34;ä¹‹å‰çš„æ•°æ®\u0026#34; + element.getValue() + \u0026#34;å½“å‰çš„sequence\u0026#34; + sequence); element.setValue(\u0026#34;æˆ‘æ˜¯ç¬¬\u0026#34; + sequence + \u0026#34;ä¸ª\u0026#34;); }); } } åœ¨Disruptorä¸­æœ‰å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„:\nThreadFactoryï¼šè¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹å·¥å‚ï¼Œç”¨äºæˆ‘ä»¬Disruptorä¸­ç”Ÿäº§è€…æ¶ˆè´¹çš„æ—¶å€™éœ€è¦çš„çº¿ç¨‹ã€‚\nEventFactoryï¼šäº‹ä»¶å·¥å‚ï¼Œç”¨äºäº§ç”Ÿæˆ‘ä»¬é˜Ÿåˆ—å…ƒç´ çš„å·¥å‚ï¼Œåœ¨Disruptorä¸­ï¼Œä»–ä¼šåœ¨åˆå§‹åŒ–çš„æ—¶å€™ç›´æ¥å¡«å……æ»¡RingBufferï¼Œä¸€æ¬¡åˆ°ä½ã€‚\nEventHandlerï¼šç”¨äºå¤„ç†Eventçš„handlerï¼Œè¿™é‡Œä¸€ä¸ªEventHandlerå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¤šä¸ªEventHandlerä»–ä»¬éƒ½æ˜¯ç‹¬ç«‹æ¶ˆè´¹çš„é˜Ÿåˆ—ã€‚\nWorkHandlerï¼šä¹Ÿæ˜¯ç”¨äºå¤„ç†Eventçš„handlerï¼Œå’Œä¸Šé¢åŒºåˆ«åœ¨äºï¼Œå¤šä¸ªæ¶ˆè´¹è€…éƒ½æ˜¯å…±äº«åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚\nWaitStrategyï¼šç­‰å¾…ç­–ç•¥ï¼Œåœ¨Disruptorä¸­æœ‰å¤šç§ç­–ç•¥ï¼Œæ¥å†³å®šæ¶ˆè´¹è€…è·æ¶ˆè´¹æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®é‡‡å–çš„ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿä¸‹é¢ç®€å•åˆ—ä¸¾ä¸€ä¸‹Disruptorä¸­çš„éƒ¨åˆ†ç­–ç•¥\n BlockingWaitStrategyï¼šé€šè¿‡çº¿ç¨‹é˜»å¡çš„æ–¹å¼ï¼Œç­‰å¾…ç”Ÿäº§è€…å”¤é†’ï¼Œè¢«å”¤é†’åï¼Œå†å¾ªç¯æ£€æŸ¥ä¾èµ–çš„sequenceæ˜¯å¦å·²ç»æ¶ˆè´¹ã€‚ BusySpinWaitStrategyï¼šçº¿ç¨‹ä¸€ç›´è‡ªæ—‹ç­‰å¾…ï¼Œå¯èƒ½æ¯”è¾ƒè€—cpu LiteBlockingWaitStrategyï¼šçº¿ç¨‹é˜»å¡ç­‰å¾…ç”Ÿäº§è€…å”¤é†’ï¼Œä¸BlockingWaitStrategyç›¸æ¯”ï¼ŒåŒºåˆ«åœ¨signalNeeded.getAndSet,å¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªè®¿é—®waitfor,ä¸€ä¸ªè®¿é—®signalAllæ—¶ï¼Œå¯ä»¥å‡å°‘lockåŠ é”æ¬¡æ•°. LiteTimeoutBlockingWaitStrategyï¼šä¸LiteBlockingWaitStrategyç›¸æ¯”ï¼Œè®¾ç½®äº†é˜»å¡æ—¶é—´ï¼Œè¶…è¿‡æ—¶é—´åæŠ›å¼‚å¸¸ã€‚ YieldingWaitStrategyï¼šå°è¯•100æ¬¡ï¼Œç„¶åThread.yield()è®©å‡ºcpu  EventTranslatorï¼šå®ç°è¿™ä¸ªæ¥å£å¯ä»¥å°†æˆ‘ä»¬çš„å…¶ä»–æ•°æ®ç»“æ„è½¬æ¢ä¸ºåœ¨Disruptorä¸­æµé€šçš„Eventã€‚\nå‚è€ƒ æ— é”é˜Ÿåˆ—çš„å®ç°\rä½ åº”è¯¥çŸ¥é“çš„é«˜æ€§èƒ½æ— é”é˜Ÿåˆ—Disruptor\r","date":"2021-08-27","permalink":"https://xuzhijvn.github.io/zh-cn/posts/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E6%8B%BE%E9%81%97/%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97disruptor/","series":["Manual"],"tags":["Other"],"title":"é«˜æ€§èƒ½æ— é”é˜Ÿåˆ—Disruptor"},{"categories":null,"content":"æˆ‘æ˜¯ Razon Yangï¼Œä¸€åå…¨æ ˆå·¥ç¨‹å¸ˆã€‚\nè´¡çŒ® \r\r\r\r\r\r\r\ré¡¹ç›® \r\r\r\r\r\r\r\r\r","date":"2016-02-19","permalink":"https://xuzhijvn.github.io/zh-cn/about/","series":null,"tags":null,"title":"å…³äº"}]